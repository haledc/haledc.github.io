<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hale&#39;s Notes</title>
  
  <subtitle>è®°äº‹æœ¬</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://haledeng.com/"/>
  <updated>2020-05-07T11:41:04.250Z</updated>
  <id>https://haledeng.com/</id>
  
  <author>
    <name>Hale</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Vuex3æºç å­¦ä¹ ç¬”è®°ä¹‹Vuexçš„Mapè¯­æ³•ç³–</title>
    <link href="https://haledeng.com/blog/20191025-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84Map%E8%AF%AD%E6%B3%95%E7%B3%96/"/>
    <id>https://haledeng.com/blog/20191025-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84Map%E8%AF%AD%E6%B3%95%E7%B3%96/</id>
    <published>2019-10-25T12:00:00.000Z</published>
    <updated>2020-05-07T11:41:04.250Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ Vuex å®‰è£…åœ¨ Vue çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠç”¨æˆ·å®šä¹‰çš„<code>store</code>å®ä¾‹èµ‹å€¼ç»™ Vue å®ä¾‹å¯¹è±¡çš„<code>$store</code>ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Vue ç»„ä»¶ä¸­çš„ä»»æ„åœ°æ–¹ä½¿ç”¨<code>this.$store</code>è°ƒç”¨<code>store</code>çš„å€¼ã€‚ä½†æ˜¯è¿™æ ·ä½¿ç”¨å¯è¯»æ€§å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œè¿™æ ·ä¸å¥½æŸ¥æ‰¾åœ¨ç»„ä»¶çš„å“ªäº›åœ°æ–¹ï¼Œè°ƒç”¨äº†å“ªäº›<code>store</code>ä¸Šçš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>ä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨<code>MapXxx</code>è¯­æ³•ç³–æ¥å¼•å…¥<code>store</code>çš„å±æ€§ï¼Œè¿™æ ·å¾ˆå¥½çš„æŸ¥æ‰¾åœ¨å“ªé‡Œä½¿ç”¨äº†<code>store</code>çš„å“ªäº›æ•°æ®ï¼Œå¯è¯»æ€§ä¹Ÿä¼šæ›´å¼ºï¼Œä¹Ÿæ›´æ–¹ä¾¿ç®¡ç†ã€‚</p><a id="more"></a><h2 id="mapState"><a href="#mapState" class="headerlink" title="mapState"></a><code>mapState</code></h2><p>å…ˆçœ‹ä¸‹<code>mapState</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>helpers.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapState = normalizeNamespace(<span class="function">(<span class="params">namespace, states</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  normalizeMap(states).forEach(<span class="function">(<span class="params">&#123; key, val &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨åˆ†æ<code>mapState</code>ä»£ç æ—¶ï¼Œéœ€è¦å…ˆææ¸…é™¤<code>normalizeNamespace</code>å’Œ<code>normalizeMap</code>è¿™ä¸ªä¸¤ä¸ªå‡½æ•°çš„ä½œç”¨ï¼Œä¸ç„¶ä¼šä¸€è„¸æ‡µé€¼ã€‚</p><h3 id="normalizeNamespaceè§„èŒƒåŒ–å‚æ•°"><a href="#normalizeNamespaceè§„èŒƒåŒ–å‚æ•°" class="headerlink" title="normalizeNamespaceè§„èŒƒåŒ–å‚æ•°"></a><code>normalizeNamespace</code>è§„èŒƒåŒ–å‚æ•°</h3><p>å…ˆçœ‹<code>normalizeNamespace</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è§„èŒƒç”¨æˆ·ä¼ å…¥çš„å‚æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeNamespace</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">namespace, map</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ! å‘½åç©ºé—´ä¸ä¸ºå­—ç¬¦ä¸²ã€‚</span></span><br><span class="line">    <span class="comment">// ! æ¯”å¦‚ï¼Œä¼ å…¥ root çš„å€¼æ—¶ï¼Œæ²¡æœ‰æ¨¡å—åï¼Œæ˜¯ç›´æ¥ä¼  &#123; a: mutationName &#125; æˆ–è€… [ mutationName ]</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> namespace !== <span class="string">'string'</span>) &#123;</span><br><span class="line">      map = namespace <span class="comment">// ! æŠŠå‘½åç©ºé—´è®¾ç½®ä¸º map</span></span><br><span class="line">      namespace = <span class="string">''</span> <span class="comment">// ! å‘½åç©ºé—´ä¸ºç©º</span></span><br><span class="line">      <span class="comment">// ! å‘½åç©ºé—´æ²¡æœ‰ä»¥ / ç»“å°¾æ—¶ï¼Œæ‹¼æ¥ / =&gt; moduleName = moduleName/</span></span><br><span class="line">      <span class="comment">// ! æ¨¡å—åå’Œ type ä¹‹é—´éœ€è¦ä½¿ç”¨ / éš”å¼€</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (namespace.charAt(namespace.length - <span class="number">1</span>) !== <span class="string">'/'</span>) &#123;</span><br><span class="line">      namespace += <span class="string">'/'</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fn(namespace, map)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°è¿”å›çš„ä¹Ÿæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸”è¿™ä¸ªå‡½æ•°å’Œæˆ‘ä»¬ä¼ å…¥çš„<code>fn</code>å‚æ•°å…·æœ‰ç›¸åŒçš„å‚æ•°<code>namespace</code>å’Œ<code>map</code>ï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½çš„çº¦æŸ<code>fn</code>çš„å‚æ•°ã€‚</p><p>é¦–å…ˆåˆ¤æ–­ç¬¬ä¸€ä¸ªå‚æ•°<code>namespace</code>æ˜¯ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœä¸æ˜¯å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆä¼ å…¥çš„å€¼å°±æ˜¯ä¸€ä¸ªå¯¹è±¡æˆ–è€…æ•°ç»„ã€‚è¿™æ—¶å‚æ•°<code>namespace</code>å°±ä¸å†æ˜¯å‘½åç©ºé—´äº†ï¼Œè€Œæ˜¯æŠŠå®ƒå½“æˆç¬¬äºŒä¸ªå‚æ•°<code>map</code>ï¼Œè€Œç¬¬ä¸€ä¸ªå‚æ•°<code>namespace</code>çš„å€¼å°±æ˜¯ç©ºå­—ç¬¦ä¸²ã€‚</p><p>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°<code>namespace</code>çš„å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å‘½åç©ºé—´çš„æ¨¡å—åï¼Œè¿™æ—¶å€™åˆ¤æ–­æ¨¡å—åæ˜¯ä¸æ˜¯ä»¥<code>/</code>ç¬¦å·ç»“å°¾ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œéœ€è¦åœ¨æ¨¡å—ååé¢æ·»åŠ <code>/</code>ç¬¦å·ï¼Œè¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†åœ¨åé¢æ›´å¥½çš„æ‹¼æ¥<code>type</code>å€¼ã€‚</p><p>æœ€åå†æ¬¡è°ƒç”¨<code>fn</code>å‡½æ•°ï¼Œè°ƒç”¨æ—¶æŠŠå¤„ç†å¥½çš„ä¸¤ä¸ªå‚æ•°<code>namespace</code>å’Œ<code>map</code>ä¼ å…¥è¿›å»ã€‚</p><p>ä½¿ç”¨<code>normalizeNamespace</code>å‡½æ•°å¯ä»¥å¾ˆå¥½çš„è§„èŒƒ<code>namespace</code>å’Œ<code>map</code>çš„å€¼ã€‚</p><h3 id="normalizeMapè§„èŒƒåŒ–map"><a href="#normalizeMapè§„èŒƒåŒ–map" class="headerlink" title="normalizeMapè§„èŒƒåŒ–map"></a><code>normalizeMap</code>è§„èŒƒåŒ–<code>map</code></h3><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>normalizeMap</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Normalize the map</span></span><br><span class="line"><span class="comment"> * normalizeMap([1, 2, 3]) =&gt; [ &#123; key: 1, val: 1 &#125;, &#123; key: 2, val: 2 &#125;, &#123; key: 3, val: 3 &#125; ]</span></span><br><span class="line"><span class="comment"> * normalizeMap(&#123;a: 1, b: 2, c: 3&#125;) =&gt; [ &#123; key: 'a', val: 1 &#125;, &#123; key: 'b', val: 2 &#125;, &#123; key: 'c', val: 3 &#125; ]</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;Array|Object&#125;</span> <span class="variable">map</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Object&#125;</span></span></span></span><br><span class="line"><span class="comment"> * ! è§„èŒƒåŒ– Map ğŸ‘†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeMap</span>(<span class="params">map</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Array</span>.isArray(map)</span><br><span class="line">    ? map.map(<span class="function"><span class="params">key</span> =&gt;</span> (&#123; key, <span class="attr">val</span>: key &#125;)) <span class="comment">// ! ä¸ä¿®æ”¹ key çš„åå­—</span></span><br><span class="line">    : <span class="built_in">Object</span>.keys(map).map(<span class="function"><span class="params">key</span> =&gt;</span> (&#123; key, <span class="attr">val</span>: map[key] &#125;)) <span class="comment">// ! æ˜ å°„ï¼Œä¿®æ”¹ keyçš„åå­—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è§„èŒƒä¼ å…¥<code>map</code>å‚æ•°çš„ï¼Œå®˜æ–¹æ³¨é‡Šå·²ç»è§£é‡Šçš„éå¸¸æ¸…é™¤äº†ã€‚å®ƒä¼šæŠŠæ•°ç»„ç±»å‹æˆ–è€…å¯¹è±¡ç±»å‹çš„<code>map</code>è½¬ç»Ÿä¸€æ¢æˆä¸€ä¸ª<code>{key, value}</code>ç»“æ„çš„å¯¹è±¡ç»„æˆçš„æ•°ç»„ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨<code>mapState</code>æ—¶ï¼Œä¸€èˆ¬æ˜¯è¿™æ ·ä½¿ç”¨çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">  ...mapState([<span class="string">'value1'</span>, <span class="string">'value2'</span>]),</span><br><span class="line">  ...mapState(&#123;<span class="attr">val3</span>: <span class="string">'value3'</span>, <span class="attr">val4</span>: <span class="string">'val4'</span>&#125;),</span><br><span class="line">  ...mapState(<span class="string">'moduleA'</span>, [<span class="string">'value1'</span>, <span class="string">'value2'</span>]),</span><br><span class="line">  ...mapState(<span class="string">'moduleB'</span>, &#123;<span class="attr">val3</span>: <span class="string">'value3'</span>, <span class="attr">val4</span>: <span class="string">'value4'</span>&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§„èŒƒ<code>map</code>åå°±å˜æˆä¸‹é¢è¿™æ ·å­äº†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">computed: &#123;</span><br><span class="line">  ...mapState([&#123; <span class="attr">key</span>:<span class="string">'value1'</span>ï¼Œval:<span class="string">'value1'</span>&#125;, &#123; <span class="attr">key</span>:<span class="string">'value2'</span>ï¼Œval:<span class="string">'value2'</span> &#125;]),</span><br><span class="line">  ...mapState([&#123; <span class="attr">key</span>: val3: val: <span class="string">'value3'</span> &#125;, &#123; <span class="attr">key</span>: val4: val: <span class="string">'val4'</span> &#125;]),</span><br><span class="line">  ...mapState(<span class="string">'moduleA/'</span>, [&#123; <span class="attr">key</span>:<span class="string">'value1'</span>ï¼Œval:<span class="string">'value1'</span>&#125;, &#123; <span class="attr">key</span>:<span class="string">'value2'</span>ï¼Œval:<span class="string">'value2'</span> &#125;]),</span><br><span class="line">  ...mapState(<span class="string">'moduleB/'</span>, [&#123; <span class="attr">key</span>: val3: val: <span class="string">'value3'</span> &#125;, &#123; <span class="attr">key</span>: val4: val: <span class="string">'val4'</span> &#125;])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å†çœ‹<code>mapState</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapState = normalizeNamespace(<span class="function">(<span class="params">namespace, states</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  <span class="comment">// ! statesï¼š [1, 2, 3] =&gt; [&#123; key: 1, val: 1 &#125;, &#123; key: 2, val: 2 &#125;, &#123; key: 3, val: 3 &#125;]</span></span><br><span class="line">  <span class="comment">// ! statesï¼š &#123;a:1, b:2, c:3&#125; =&gt; [&#123; key: a, val: 1 &#125;, &#123; key: b, val: 2 &#125;, &#123; key: c, val: 3 &#125;]</span></span><br><span class="line">  normalizeMap(states).forEach(<span class="function">(<span class="params">&#123; key, val &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    res[key] = <span class="function"><span class="keyword">function</span> <span class="title">mappedState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// ! è·å– root ä¸Šçš„å€¼</span></span><br><span class="line">      <span class="keyword">let</span> state = <span class="keyword">this</span>.$store.state</span><br><span class="line">      <span class="keyword">let</span> getters = <span class="keyword">this</span>.$store.getters</span><br><span class="line">      <span class="comment">// ! å¦‚æœè®¾ç½®äº†å‘½åç©ºé—´ï¼Œå³ mapXXX(namespace, ['name1', 'name2'])</span></span><br><span class="line">      <span class="comment">// ! è·å–å‘½åç©ºé—´æ¨¡å—çš„å€¼ï¼Œå³ store.state.namespace.name1</span></span><br><span class="line">      <span class="keyword">if</span> (namespace) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">module</span> = getModuleByNamespace(<span class="keyword">this</span>.$store, <span class="string">'mapState'</span>, namespace) <span class="comment">// ! é€šè¿‡å‘½åç©ºé—´è·å–å¯¹åº”æ¨¡å—</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">module</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        state = <span class="built_in">module</span>.context.state <span class="comment">// ! åœ¨æ¨¡å—ä¸­è·å–å€¼</span></span><br><span class="line">        getters = <span class="built_in">module</span>.context.getters</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">'function'</span> <span class="comment">// ! åˆ¤æ–­æ˜¯å¦æ˜¯å‡½æ•°</span></span><br><span class="line">        ? val.call(<span class="keyword">this</span>, state, getters) <span class="comment">// ! val(state, getters)</span></span><br><span class="line">        : state[val] <span class="comment">// ! è¿”å› state ä¸­å¯¹åº”çš„å€¼å³å¯</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mark vuex getter for devtools</span></span><br><span class="line">    res[key].vuex = <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜äº†å˜é‡<code>res</code>ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯ç©ºå¯¹è±¡ï¼Œæœ€åä¼šè¿”å›è¿™ä¸ªå€¼ã€‚</p><p>ç„¶åéå†<code>states</code>ï¼Œå°±æ˜¯ä¸Šé¢è§„èŒƒåçš„<code>map</code>çš„å€¼ã€‚ç„¶ååœ¨<code>res</code>å¯¹è±¡ä¸­ç”Ÿæˆä¸€å¯¹å¯¹<code>{key: mappedState}</code>é”®å€¼å¯¹ç»“æ„çš„æ•°æ®ã€‚</p><p>ä¸‹é¢ä¸»è¦çœ‹ä¸‹<code>mappedState</code>å‡½æ•°çš„ä»£ç ã€‚</p><p>é¦–å…ˆå£°æ˜å˜é‡<code>state</code>å­˜å‚¨ root ä¸Šçš„ <code>state</code>ï¼Œå£°æ˜å˜é‡<code>getters</code>å­˜å‚¨ root ä¸Šçš„ <code>gettters</code>ï¼Œå¦‚æœæœ‰å‘½åç©ºé—´çš„æ¨¡å—åï¼Œä¼šè·é€šè¿‡å‘½åç©ºé—´çš„æ¨¡å—åè·å–åˆ°è¿™ä¸ªæ¨¡å—ï¼Œç„¶åå˜é‡<code>state</code>å’Œ<code>getters</code>ä¼šå˜æˆæ¨¡å—ä¸Šä¸‹æ–‡ä¸­çš„<code>state</code>å’Œ<code>getters</code>ã€‚</p><p>å†åˆ¤æ–­<code>val</code> çš„å€¼æ˜¯å¦æ˜¯å‡½æ•°ï¼Œæœ‰æ—¶å€™ä¼šé€šè¿‡è°ƒç”¨å‡½æ•°ç”Ÿæˆæ•°æ®ã€‚å¦‚æœæ˜¯å‡½æ•°çš„è¯ï¼Œä¼šä½¿ç”¨<code>call</code>æ–¹æ³•æ¥è°ƒç”¨ï¼Œ<code>this</code>æŒ‡å‘ç»„ä»¶è‡ªèº«ï¼Œç„¶åæŠŠ<code>state</code>å’Œ<code>getters</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå¦‚æœä¸æ˜¯å‡½æ•°ï¼Œä¸€èˆ¬å°±æ˜¯å­—ç¬¦ä¸²ï¼Œä¼šè¿”å›<code>state</code>ä¸­å¯¹åº”<code>val</code>çš„å€¼ã€‚</p><p>æˆ‘ä»¬ä¸€èˆ¬ä½¿ç”¨æ—¶ä¼ å…¥å­—ç¬¦ä¸²ç±»å‹çš„å€¼å¤šä¸€ç‚¹ï¼Œçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mapState(<span class="string">'moduleA'</span>, [<span class="string">'value'</span>])</span><br></pre></td></tr></table></figure><p>è¿™æ—¶ä¼šè¿”å›<code>state[val]</code>ï¼Œç„¶åé‡æ–°æŸ¥çœ‹åœ¨æ¨¡å—ä¸Šä¸‹æ–‡ä¸­æ˜¯æ€ä¹ˆä¿®æ”¹<code>state</code>çš„å€¼çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; getNestedState(store.state, path) // ! é€šè¿‡è·¯å¾„è·å–åµŒå¥—çš„ state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ä¼šä½¿ç”¨<code>getNestedState</code>æ–¹æ³•ï¼Œé€šè¿‡è·¯å¾„<code>path</code>è·å–å¯¹åº”çš„<code>state</code>çš„å€¼ã€‚è€Œè¿™é‡Œæœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œé‚£ä¹ˆ<code>path</code>çš„å€¼å°±æ˜¯<code>[&#39;moduleA&#39;ï¼Œ&#39;value&#39;]</code>ï¼Œè¿™æ ·å°±å¯ä»¥è·å–åˆ°æ¨¡å—ä¸­<code>value</code>çš„å€¼ã€‚</p><h2 id="mapMutations"><a href="#mapMutations" class="headerlink" title="mapMutations"></a><code>mapMutations</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>mapMutations</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapMutations = normalizeNamespace(<span class="function">(<span class="params">namespace, mutations</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  normalizeMap(mutations).forEach(<span class="function">(<span class="params">&#123; key, val &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    res[key] = <span class="function"><span class="keyword">function</span> <span class="title">mappedMutation</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// Get the commit method from store</span></span><br><span class="line">      <span class="keyword">let</span> commit = <span class="keyword">this</span>.$store.commit <span class="comment">// ! æ ¹çš„ commit</span></span><br><span class="line">      <span class="keyword">if</span> (namespace) &#123;</span><br><span class="line">        <span class="comment">// ! è·å–æ¨¡å—</span></span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">module</span> = getModuleByNamespace(</span><br><span class="line">          <span class="keyword">this</span>.$store,</span><br><span class="line">          <span class="string">'mapMutations'</span>,</span><br><span class="line">          namespace</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">module</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        commit = <span class="built_in">module</span>.context.commit <span class="comment">// ! æ¨¡å—çš„ commit</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">'function'</span></span><br><span class="line">        ? <span class="comment">// ! è°ƒç”¨è¿™ä¸ªå‡½æ•° val(commit, args)ï¼Œå‡½æ•°ä¼ å…¥ commitï¼Œåœ¨å‡½æ•°ä½“ä¸­å¯ä»¥ä½¿ç”¨ commit æ¥æäº¤å…¶å®ƒ mutation</span></span><br><span class="line">          val.apply(<span class="keyword">this</span>, [commit].concat(args))</span><br><span class="line">        : commit.apply(<span class="keyword">this</span>.$store, [val].concat(args)) <span class="comment">// ! string å½¢å¼ --&gt; this.$store.commit(val, ...args)</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é€»è¾‘å’Œ<code>mapState</code>å¤§åŒå°å¼‚ï¼Œæœ‰å‘½åç©ºé—´æ¨¡å—çš„æ—¶å€™ï¼Œè·å–åˆ°çš„æ˜¯æ¨¡å—ä¸Šä¸‹æ–‡ä¸­çš„<code>commit</code>æ–¹æ³•ã€‚</p><p>ç„¶ååˆ¤æ–­<code>val</code>æ˜¯å¦ä¸ºå‡½æ•°ï¼Œå¦‚ä½•æ˜¯çš„è¯ï¼Œä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”ä¼ å…¥<code>commit</code>å’Œå‚æ•°<code>args</code>ã€‚è¿™é‡Œä¸ºä»€ä¹ˆè¦ä¼ å…¥<code>commit</code>ï¼Œå› ä¸ºåœ¨å‡½æ•°ä½“ä¸­å¯ä»¥ä½¿ç”¨<code>commit</code>æ¥æäº¤å…¶å®ƒçš„<code>mutation</code>å‡½æ•°ã€‚å¦‚æœ<code>val</code>ä¸æ˜¯å‡½æ•°ï¼Œé‚£åº”è¯¥æ˜¯å­—ç¬¦ä¸²ï¼Œè¿™æ—¶ä¼šè°ƒç”¨<code>commit</code>å‡½æ•°ï¼Œ<code>this</code>æŒ‡å‘çš„<code>this.$store</code>ï¼Œç„¶åä¼ å…¥<code>val</code>å’Œå‚æ•°<code>args</code>ï¼Œè¿™å°±ç›¸å½“äºæ˜¯ä¸‹é¢è¿™æ ·è°ƒç”¨çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$store.commit(val, ...args)</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°<code>mapMutations</code>å¹¶ä¸æ˜¯ç®€å•çš„æ˜ å°„<code>mutation</code>çš„å‡½æ•°åï¼Œè€Œæ˜¯æ˜ å°„ä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨<code>commit</code>æ¥æäº¤<code>mutaion</code>å‡½æ•°ï¼Œç”¨æˆ·åœ¨ç»„ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°±ç›¸å½“äºæäº¤<code>mutation</code>å‡½æ•°ï¼Œè€Œä¸éœ€è¦åœ¨ç»„ä»¶ä¸­å†æ¬¡æ˜¾ç¤ºä½¿ç”¨<code>commit</code>æ¥æäº¤ï¼Œè¿™æ ·è®¾è®¡æ˜¯éå¸¸äººæ€§åŒ–çš„ã€‚</p><h2 id="mapGetters"><a href="#mapGetters" class="headerlink" title="mapGetters"></a><code>mapGetters</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>mapGetters</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapGetters = normalizeNamespace(<span class="function">(<span class="params">namespace, getters</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  normalizeMap(getters).forEach(<span class="function">(<span class="params">&#123; key, val &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// The namespace has been mutated by normalizeNamespace</span></span><br><span class="line">    val = namespace + val <span class="comment">// ! moduleName/getterName</span></span><br><span class="line">    res[key] = <span class="function"><span class="keyword">function</span> <span class="title">mappedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        namespace &amp;&amp;</span><br><span class="line">        !getModuleByNamespace(<span class="keyword">this</span>.$store, <span class="string">'mapGetters'</span>, namespace)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        !(val <span class="keyword">in</span> <span class="keyword">this</span>.$store.getters)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`[vuex] unknown getter: <span class="subst">$&#123;val&#125;</span>`</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.$store.getters[val] <span class="comment">// ! æ ¹æ®æ‹¼æ¥åçš„ val ä»å®ä¾‹å±æ€§ getters è·å–å¯¹åº”çš„å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mark vuex getter for devtools</span></span><br><span class="line">    res[key].vuex = <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>mapGetters</code>çš„å®ç°å’Œ<code>mapState</code>æœ‰ä¸€äº›ä¸åŒï¼Œä¸»è¦æ˜¯<code>Store</code>ä¸­<code>getters</code>å±æ€§å’Œ<code>state</code>å±æ€§çš„ç»“æ„ä¸ä¸€æ ·ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// state</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">0</span> <span class="comment">// root state</span></span><br><span class="line">  moduleA: &#123;</span><br><span class="line">    count: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  moduleB: &#123;</span><br><span class="line">    count: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getters</span></span><br><span class="line">getters: &#123;</span><br><span class="line">  getterFn()&#123;&#125;, <span class="comment">// root getters</span></span><br><span class="line">  <span class="string">'modulesA/getterFn'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesA/getterFn2'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesB/getterFn'</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getters</code>é‡‡ç”¨å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œä½¿å¾—<code>val</code>çš„å€¼ä¸º<code>moduleName/getterName</code>ï¼Œç„¶ååœ¨<code>store.getters</code>ä¸­ç›´æ¥é€šè¿‡ key è·å–å€¼ã€‚</p><h2 id="mapActions"><a href="#mapActions" class="headerlink" title="mapActions"></a><code>mapActions</code></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> mapActions = normalizeNamespace(<span class="function">(<span class="params">namespace, actions</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  normalizeMap(actions).forEach(<span class="function">(<span class="params">&#123; key, val &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    res[key] = <span class="function"><span class="keyword">function</span> <span class="title">mappedAction</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">      <span class="comment">// get dispatch function from store</span></span><br><span class="line">      <span class="keyword">let</span> dispatch = <span class="keyword">this</span>.$store.dispatch</span><br><span class="line">      <span class="keyword">if</span> (namespace) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="built_in">module</span> = getModuleByNamespace(</span><br><span class="line">          <span class="keyword">this</span>.$store,</span><br><span class="line">          <span class="string">'mapActions'</span>,</span><br><span class="line">          namespace</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">module</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        dispatch = <span class="built_in">module</span>.context.dispatch</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> val === <span class="string">'function'</span></span><br><span class="line">        ? val.apply(<span class="keyword">this</span>, [dispatch].concat(args))</span><br><span class="line">        : dispatch.apply(<span class="keyword">this</span>.$store, [val].concat(args))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>mapActions</code>çš„é€»è¾‘å’Œ<code>mapMutations</code>å®Œå…¨ä¸€æ ·ï¼Œè¿™æ ·å°±ä¸å¤šèµ˜è¿°äº†ã€‚</p><h2 id="createNamespacedHelpers"><a href="#createNamespacedHelpers" class="headerlink" title="createNamespacedHelpers"></a><code>createNamespacedHelpers</code></h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Rebinding namespace param for mapXXX function in special scoped, and return them by simple object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param <span class="type">&#123;String&#125;</span> <span class="variable">namespace</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return <span class="type">&#123;Object&#125;</span></span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> createNamespacedHelpers = <span class="function"><span class="params">namespace</span> =&gt;</span> (&#123;</span><br><span class="line">  mapState: mapState.bind(<span class="literal">null</span>, namespace),</span><br><span class="line">  mapGetters: mapGetters.bind(<span class="literal">null</span>, namespace),</span><br><span class="line">  mapMutations: mapMutations.bind(<span class="literal">null</span>, namespace),</span><br><span class="line">  mapActions: mapActions.bind(<span class="literal">null</span>, namespace)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Vuex è¿˜æš´éœ²å‡ºä¸€ä¸ª<code>createNamespacedHelpers</code>å‡½æ•°ï¼Œç”¨æ¥ç»‘å®šå‘½åç©ºé—´æ¨¡å—<code>namespace</code>çš„å€¼ï¼Œè¿™æ ·åé¢ä½¿ç”¨æ—¶æ‰€æœ‰çš„<code>map</code>éƒ½æ˜¯è¿™ä¸ªæ¨¡å—ä¸‹é¢çš„å€¼ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/v2/vuex/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">Vuex æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vuex/tree/learn-vuex" target="_blank" rel="noopener">Vuex æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ Vuex å®‰è£…åœ¨ Vue çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæŠŠç”¨æˆ·å®šä¹‰çš„&lt;code&gt;store&lt;/code&gt;å®ä¾‹èµ‹å€¼ç»™ Vue å®ä¾‹å¯¹è±¡çš„&lt;code&gt;$store&lt;/code&gt;ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ Vue ç»„ä»¶ä¸­çš„ä»»æ„åœ°æ–¹ä½¿ç”¨&lt;code&gt;this.$store&lt;/code&gt;è°ƒç”¨&lt;code&gt;store&lt;/code&gt;çš„å€¼ã€‚ä½†æ˜¯è¿™æ ·ä½¿ç”¨å¯è¯»æ€§å¹¶ä¸æ˜¯å¾ˆå¥½ï¼Œè¿™æ ·ä¸å¥½æŸ¥æ‰¾åœ¨ç»„ä»¶çš„å“ªäº›åœ°æ–¹ï¼Œè°ƒç”¨äº†å“ªäº›&lt;code&gt;store&lt;/code&gt;ä¸Šçš„å±æ€§å’Œæ–¹æ³•ã€‚&lt;/p&gt;
&lt;p&gt;ä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šä½¿ç”¨&lt;code&gt;MapXxx&lt;/code&gt;è¯­æ³•ç³–æ¥å¼•å…¥&lt;code&gt;store&lt;/code&gt;çš„å±æ€§ï¼Œè¿™æ ·å¾ˆå¥½çš„æŸ¥æ‰¾åœ¨å“ªé‡Œä½¿ç”¨äº†&lt;code&gt;store&lt;/code&gt;çš„å“ªäº›æ•°æ®ï¼Œå¯è¯»æ€§ä¹Ÿä¼šæ›´å¼ºï¼Œä¹Ÿæ›´æ–¹ä¾¿ç®¡ç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vuex" scheme="https://haledeng.com/categories/Vuex/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Vuex" scheme="https://haledeng.com/tags/Vuex/"/>
    
  </entry>
  
  <entry>
    <title>Vuex3æºç å­¦ä¹ ç¬”è®°ä¹‹Vuexçš„æ•°æ®æ“ä½œ</title>
    <link href="https://haledeng.com/blog/20191018-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/"/>
    <id>https://haledeng.com/blog/20191018-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C/</id>
    <published>2019-10-18T12:00:00.000Z</published>
    <updated>2020-05-07T08:46:22.672Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ•°æ®å­˜å‚¨å’Œè¯»å–"><a href="#æ•°æ®å­˜å‚¨å’Œè¯»å–" class="headerlink" title="æ•°æ®å­˜å‚¨å’Œè¯»å–"></a>æ•°æ®å­˜å‚¨å’Œè¯»å–</h2><h3 id="state"><a href="#state" class="headerlink" title="state"></a>state</h3><p><code>state</code>æ˜¯åœ¨æ¨¡å—å®‰è£…<code>installModule</code>å‡½æ•°ä¸­è®¾ç½®çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set state</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">  <span class="keyword">const</span> parentState = getNestedState(rootState, path.slice(<span class="number">0</span>, <span class="number">-1</span>)) <span class="comment">// ! è·å–çˆ¶çº§çš„ state</span></span><br><span class="line">  <span class="keyword">const</span> moduleName = path[path.length - <span class="number">1</span>] <span class="comment">// ! è·å–æ¨¡å—å</span></span><br><span class="line">  store._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    Vue.set(parentState, moduleName, <span class="built_in">module</span>.state) <span class="comment">// ! è®¾ç½®å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå¹¶ä¸”ä¸ºå“åº”æ€§æ•°æ®</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>getNestedState</code>æ–¹æ³•è·å–çˆ¶çº§æ¨¡å—ï¼Œç„¶åæŠŠæ‰€æœ‰æ¨¡å—ä¸‹é¢çš„<code>state</code>æ•°æ®éƒ½æ‹·è´åˆ° root çš„<code>state</code>ä¸­ã€‚</p><a id="more"></a><p>è¿™æ ·ç”¨æˆ·å¯ä»¥ç›´æ¥é€šè¿‡<code>store.state</code>è·å–<code>store</code>çš„æ‰€æœ‰æ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥å»ä¿®æ”¹æ•°è¿™äº›æ®ã€‚å¦‚æœä¿®æ”¹çš„è¯ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å– stateï¼Œè®¿é—®çš„æ˜¯ Vue çš„ data é‡Œé¢çš„å±æ€§ï¼Œè§¦å‘å“åº”å¼ @API</span></span><br><span class="line"><span class="keyword">get</span> state() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._vm._data.$$state</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! è®¾ç½® stateï¼Œå¼€å‘ç¯å¢ƒä¼šæŠ¥é”™ï¼Œä¸èƒ½ç›´æ¥è®¾ç½®ï¼Œå¿…é¡»ä½¿ç”¨ replaceState æ›¿æ¢</span></span><br><span class="line"><span class="keyword">set</span> state(v) &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assert(<span class="literal">false</span>, <span class="string">`use store.replaceState() to explicit replace store state.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæŠŠ<code>state</code>çš„æ•°æ®æ”¾å…¥åˆ° Vue çš„<code>data</code>å±æ€§ä¸‹é¢çš„<code>$$state</code>ä¸­ï¼Œ<code>state</code>æ•°æ®å˜æˆå“åº”å¼çš„æ•°æ®ã€‚</p><p>å¦å¤–ï¼Œå…¶å®å¯ä»¥é€šè¿‡ API<code>replaceState</code>æ¥ä¿®æ”¹æ•°æ®ï¼Œå³ä½¿ç”¨<code>store.replaceState(state)</code>æ–¹æ³•æ›¿æ¢<code>state</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ›¿æ¢ state çš„æ•°æ®ï¼Œè¿™é‡Œä¹Ÿéœ€è¦æ˜¾ç¤ºæäº¤ commit è¿›è¡Œæ•°æ®ä¿®æ”¹</span></span><br><span class="line">replaceState(state) &#123;</span><br><span class="line">  <span class="keyword">this</span>._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>._vm._data.$$state = state</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getters"><a href="#getters" class="headerlink" title="getters"></a>getters</h3><p><code>store.getters</code>å±æ€§æ˜¯åœ¨åˆå§‹åŒ–<code>_vm</code>çš„å‡½æ•°<code>resetStoreVM</code>ä¸­æ‰å¼€å§‹è®¾ç½®çš„ï¼Œå¹¶ä¸”é€šè¿‡<code>computed</code>å¯¹è±¡ï¼ŒæŠŠå®ƒçš„å€¼å˜æˆäº† Vue å®ä¾‹çš„è®¡ç®—å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">store.getters = &#123;&#125; <span class="comment">// ! åˆ›å»º getters å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> wrappedGetters = store._wrappedGetters <span class="comment">// ! è·å– wrappedGetters å¯¹è±¡</span></span><br><span class="line"><span class="keyword">const</span> computed = &#123;&#125; <span class="comment">// ! è®¾ç½®è®¡ç®—å±æ€§å¯¹è±¡</span></span><br><span class="line"><span class="comment">// ! éå† wrappedGetters</span></span><br><span class="line">forEachValue(wrappedGetters, (fn, key) =&gt; &#123;</span><br><span class="line">  <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">  <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">  <span class="comment">// using partial to return function with only arguments preserved in closure enviroment</span></span><br><span class="line">  <span class="comment">// ! æŠŠ wrappedGetter å‡½æ•°çš„è¿”å›å€¼èµ‹å€¼åˆ° VM çš„ computed ä¸­</span></span><br><span class="line">  computed[key] = partial(fn, store) <span class="comment">// ! fn(store) -&gt; wrappedGetter(store)</span></span><br><span class="line">  <span class="comment">// ! å®šä¹‰ store.getters çš„å±æ€§</span></span><br><span class="line">  <span class="comment">// ! store.getters.xxx -&gt; store._vm[xxx] -&gt; store._vm.computed[xxx]</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(store.getters, key, &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; store._vm[key],</span><br><span class="line">    enumerable: true // for local getters</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  // ...</span><br><span class="line"></span><br><span class="line">  store._vm = new Vue(&#123;</span><br><span class="line">    data: &#123;</span><br><span class="line">      $$state: state <span class="comment">// !  store.state -&gt; store._vm.data.$$state</span></span><br><span class="line">    &#125;,</span><br><span class="line">    computed <span class="comment">// ! store._vm.computed[xxx] -&gt; store._vm[xxx]</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>store.getters</code>è®¾ç½®ä¸º Vue å®ä¾‹ä¸­çš„è®¡ç®—å±æ€§ï¼Œä½†æ˜¯å®ƒæ¯”è®¡ç®—å±æ€§æ›´åŠ ä¸¥æ ¼ã€‚å› ä¸º<code>getters</code> åªèƒ½è¯»å–ï¼Œè€Œä¸èƒ½æ“ä½œï¼Œè€Œ Vue çš„è®¡ç®—å±æ€§æ˜¯å¯ä»¥è®¾ç½®<code>setter</code>çš„ã€‚</p><p><code>getters</code>å˜æˆäº†è®¡ç®—å±æ€§ï¼Œä¹Ÿç»§æ‰¿äº†è®¡ç®—å±æ€§çš„ç‰¹æ€§ï¼Œå®ƒä¾èµ–äº<code>state</code>æ•°æ®ï¼Œåªæœ‰åœ¨<code>state</code>æ•°æ®å˜åŒ–æ—¶ï¼Œå®ƒçš„å€¼æ‰ä¼šæ”¹å˜ã€‚</p><h2 id="æ•°æ®çš„æ“ä½œ"><a href="#æ•°æ®çš„æ“ä½œ" class="headerlink" title="æ•°æ®çš„æ“ä½œ"></a>æ•°æ®çš„æ“ä½œ</h2><p>åœ¨ Vuex ä¸­ä¿®æ”¹<code>state</code>æ—¶ï¼Œå¿…é¡»ä»¥æ˜¾ç¤ºçš„æäº¤<code>commit</code>çš„å½¢å¼æ¥æ“ä½œï¼Œä¸èƒ½ç›´æ¥å»ä¿®æ”¹ï¼Œå¦‚æœç›´æ¥å»ä¿®æ”¹ï¼Œè®¾ç½®äº†<code>strict = true</code>ååœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><h3 id="commit"><a href="#commit" class="headerlink" title="commit"></a>commit</h3><p>ä¸‹é¢çœ‹ä¸‹<code>Store</code>ä¸­<code>commit</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! commit æ–¹æ³• @API</span></span><br><span class="line">commit(_type, _payload, _options) &#123;</span><br><span class="line">  <span class="comment">// check object-style commit</span></span><br><span class="line">  <span class="keyword">const</span> &#123; type, payload, options &#125; = unifyObjectStyle(</span><br><span class="line">    _type,</span><br><span class="line">    _payload,</span><br><span class="line">    _options</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> mutation = &#123; type, payload &#125;</span><br><span class="line">  <span class="keyword">const</span> entry = <span class="keyword">this</span>._mutations[type] <span class="comment">// ! è·å– type çš„ mutation å‡½æ•°æ•°ç»„</span></span><br><span class="line">  <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`[vuex] unknown mutation type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! ä½¿ç”¨ commit æ‰§è¡Œ mutation æ—¶åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸ä¼šæŠ¥é”™</span></span><br><span class="line">  <span class="keyword">this</span>._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    entry.forEach(<span class="function"><span class="keyword">function</span> <span class="title">commitIterator</span>(<span class="params">handler</span>) </span>&#123;</span><br><span class="line">      handler(payload) <span class="comment">// ! æ‰§è¡Œ commit çš„æ‰€æœ‰å‡½æ•°</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._subscribers.forEach(<span class="function"><span class="params">sub</span> =&gt;</span> sub(mutation, <span class="keyword">this</span>.state)) <span class="comment">// ! æ‰§è¡Œ mutation åï¼Œæ‰§è¡Œæ‰€æœ‰è®¢é˜…å‡½æ•°</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; options &amp;&amp; options.silent) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(</span><br><span class="line">      <span class="string">`[vuex] mutation type: <span class="subst">$&#123;type&#125;</span>. Silent option has been removed. `</span> +</span><br><span class="line">      <span class="string">'Use the filter functionality in the vue-devtools'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šä½¿ç”¨<code>unifyObjectStyle</code>å‡½æ•°è§„èŒƒåŒ–å‚æ•°ï¼Œç„¶åè·å–è§„èŒƒåŒ–çš„<code>type</code>å’Œ<code>payload</code>ç»„æˆä¸€ä¸ª<code>mutation</code>å¯¹è±¡ï¼Œå†é€šè¿‡<code>type</code>è·å–å¯¹åº”çš„å‡½æ•°ç»„ï¼Œç„¶åé€šè¿‡<code>_withCommit</code>æ‰§è¡Œå‡½æ•°ç»„çš„æ‰€æœ‰å‡½æ•°ï¼Œæ³¨æ„æ‰§è¡Œæ—¶éœ€è¦æŠŠ<code>payload</code>ä¼ å…¥ã€‚</p><p>æ‰§è¡Œå®Œ<code>type</code>çš„å‡½æ•°åï¼Œå†æ‰§è¡Œæ‰€æœ‰çš„<code>mutation</code>è®¢é˜…å‡½æ•°ã€‚</p><p>å…ˆçœ‹ä¸‹<code>unifyObjectStyle</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è§„èŒƒåŒ– commit å’Œ dispatch å‡½æ•°çš„å‚æ•°</span></span><br><span class="line"><span class="comment">// ! e.g. commit(type: string, payload?: any, options?: Object)</span></span><br><span class="line"><span class="comment">// !      commit(&#123; type: string, payload?: any &#125;, options? Object)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unifyObjectStyle</span>(<span class="params">type, payload, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isObject(type) &amp;&amp; type.type) &#123;</span><br><span class="line">    options = payload</span><br><span class="line">    payload = type</span><br><span class="line">    type = type.type</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assert(</span><br><span class="line">      <span class="keyword">typeof</span> type === <span class="string">'string'</span>, <span class="comment">// ! type å¿…é¡»æ˜¯ string ç±»å‹</span></span><br><span class="line">      <span class="string">`expects string as the type, but found <span class="subst">$&#123;<span class="keyword">typeof</span> type&#125;</span>.`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123; type, payload, options &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸º<code>commit</code>çš„æ—¶å€™æœ‰ä¸¤ç§æäº¤æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æ¥æäº¤ä¸€ä¸ªç”±<code>type</code>å’Œ<code>payload</code>çš„é”®å€¼å¯¹ç»„æˆçš„<code>mutaion</code>å¯¹è±¡ï¼Œå¦å¤–ä¸€ç§æ˜¯æŠŠå®ƒä»¬åˆ†å¼€æ¥ä¼ å…¥ï¼Œ<code>unifyObjectStyle</code>å‡½æ•°å¯ä»¥ç¡®ä¿èƒ½è·å–åˆ°<code>type</code>å’Œ<code>payload</code>çš„å‡†ç¡®å€¼ã€‚</p><p>å†çœ‹<code>_withCommit</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åŒ…è£… mutation å‡½æ•°ï¼Œè®¾ç½® _committing çŠ¶æ€</span></span><br><span class="line"><span class="comment">// ! æ­£å¸¸é€šè¿‡ commit ä¿®æ”¹æ•°æ®å‰ _committing ä¸º trueï¼Œé˜²æ­¢ç”¨æˆ·éšæ„æ›´æ”¹ vuex çš„æ•°æ®</span></span><br><span class="line">_withCommit(fn) &#123;</span><br><span class="line">  <span class="keyword">const</span> committing = <span class="keyword">this</span>._committing <span class="comment">// ! ç¼“å­˜åŸæ¥çš„çŠ¶æ€</span></span><br><span class="line">  <span class="keyword">this</span>._committing = <span class="literal">true</span> <span class="comment">// ! æ‰§è¡Œå‰è®¾ç½®ä¸º trueï¼Œæ­¤æ—¶é€šè¿‡ commit ä¿®æ”¹å€¼åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ä¸ä¼šæŠ¥é”™</span></span><br><span class="line">  fn() <span class="comment">// ! æ‰§è¡Œå‡½æ•°</span></span><br><span class="line">  <span class="keyword">this</span>._committing = committing <span class="comment">// ! æ¢å¤åŸæ¥çš„çŠ¶æ€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠ<code>mutation</code>å‡½æ•°è¿›è¡Œäº†ä¸€å±‚åŒ…è£…ï¼Œåœ¨æ‰§è¡Œå‡½æ•°å‰ä¼šæŠŠ<code>_committing</code>è®¾ç½®ä¸º<code>true</code>ï¼Œè¿™æ ·åé¢é€šè¿‡<code>store._vm</code>å®ä¾‹ä¸­çš„ä¾¦å¬å™¨<code>$watch</code>æ£€æµ‹<code>state</code>å˜åŒ–æ—¶ï¼Œä¼šéªŒè¯å®ƒçš„å€¼ã€‚å½“å®ƒçš„å€¼ä¸º<code>true</code>æ—¶ï¼Œè¯´æ˜ä¿®æ”¹<code>state</code>çš„å€¼æ˜¯é€šè¿‡æäº¤<code>commit</code>ä¿®æ”¹çš„ï¼Œè¿™æ—¶è®¾ç½®<code>strict=true</code>åå°±ä¸ä¼šæŠ¥é”™äº†ã€‚</p><h3 id="diaptch"><a href="#diaptch" class="headerlink" title="diaptch"></a>diaptch</h3><p>ä¸‹é¢çœ‹ä¸‹<code>Store</code>ä¸­<code>diaptch</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! dispatch æ–¹æ³• @API</span></span><br><span class="line">  dispatch(_type, _payload) &#123;</span><br><span class="line">    <span class="comment">// check object-style dispatch</span></span><br><span class="line">    <span class="keyword">const</span> &#123; type, payload &#125; = unifyObjectStyle(_type, _payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> action = &#123; type, payload &#125;</span><br><span class="line">    <span class="keyword">const</span> entry = <span class="keyword">this</span>._actions[type]</span><br><span class="line">    <span class="keyword">if</span> (!entry) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">`[vuex] unknown action type: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! action æ‰§è¡Œå‰ï¼Œå…ˆæ‰§è¡Œ action çš„æ‰€æœ‰è®¢é˜…å™¨çš„ before å‡½æ•°</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>._actionSubscribers</span><br><span class="line">        .filter(<span class="function"><span class="params">sub</span> =&gt;</span> sub.before)</span><br><span class="line">        .forEach(<span class="function"><span class="params">sub</span> =&gt;</span> sub.before(action, <span class="keyword">this</span>.state))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">`[vuex] error in before action subscribers: `</span>)</span><br><span class="line">        <span class="built_in">console</span>.error(e)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result =</span><br><span class="line">      entry.length &gt; <span class="number">1</span></span><br><span class="line">        ? <span class="built_in">Promise</span>.all(entry.map(<span class="function"><span class="params">handler</span> =&gt;</span> handler(payload))) <span class="comment">// ! å¹¶è¡Œæ‰§è¡Œ action çš„æ‰€æœ‰å¼‚æ­¥æ“ä½œ</span></span><br><span class="line">        : entry[<span class="number">0</span>](payload) <span class="comment">// ! åªæœ‰ä¸€ä¸ª action åˆ™åŒæ­¥æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! action æ‰§è¡Œåï¼Œæ‰§è¡Œ action çš„æ‰€æœ‰è®¢é˜…å™¨çš„ after å‡½æ•°</span></span><br><span class="line">    <span class="keyword">return</span> result.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>._actionSubscribers</span><br><span class="line">          .filter(<span class="function"><span class="params">sub</span> =&gt;</span> sub.after)</span><br><span class="line">          .forEach(<span class="function"><span class="params">sub</span> =&gt;</span> sub.after(action, <span class="keyword">this</span>.state))</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">          <span class="built_in">console</span>.warn(<span class="string">`[vuex] error in after action subscribers: `</span>)</span><br><span class="line">          <span class="built_in">console</span>.error(e)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„é€»è¾‘å’Œ<code>commit</code>ç›¸ä¼¼ï¼Œéƒ½æ˜¯å…ˆè§„èŒƒåŒ–å‚æ•°ï¼Œç„¶åå†æ‰§è¡Œå‡½æ•°ï¼Œä¹Ÿä¼šæ‰§è¡Œè®¢é˜…å™¨ã€‚</p><p>ä½†æ˜¯è¿™é‡Œæœ‰<strong>ä¸¤ç‚¹ä¸åŒ</strong>ï¼Œå…¶ä¸­ä¸€ç‚¹æ˜¯æ‰§è¡Œ<code>action</code>å‡½æ•°çš„æ–¹å¼ã€‚æˆ‘ä»¬çŸ¥é“é€šè¿‡è°ƒç”¨<code>commit</code>æ–¹æ³•æ‰§è¡Œ<code>mutation</code>å‡½æ•°æ—¶ï¼Œæ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚ä½†æ˜¯é€šè¿‡<code>dispatch</code>æ‰§è¡Œ<code>action</code>å‡½æ•°æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªå‡½æ•°ï¼Œä¼šè¿›è¡Œå¼‚æ­¥æ‰§è¡Œï¼Œåªæœ‰ä¸€ä¸ªå‡½æ•°æ—¶æ‰ä¼šä½¿ç”¨åŒæ­¥æ‰§è¡Œã€‚</p><p>å¦ä¸€ç‚¹æ˜¯<code>actions</code>çš„è®¢é˜…å™¨ä¹Ÿå’Œ<code>mutaion</code>çš„è®¢é˜…å™¨ä¸ä¸€æ ·ï¼Œå®ƒå¯ä»¥è®¾ç½®ä¸¤ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯<code>before</code>ï¼Œåœ¨<code>action</code>å‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œçš„ï¼›å¦å¤–ä¸€ä¸ª<code>after</code>ï¼Œåœ¨<code>action</code>å‡½æ•°æ‰§è¡Œåæ‰§è¡Œçš„ã€‚</p><p>å¦å¤–ï¼Œ<code>action</code>å‡½æ•°æ˜¯ä¸èƒ½ç›´æ¥ä¿®æ”¹æ•°æ®çš„ï¼Œå®ƒè¿˜æ˜¯éœ€è¦é€šè¿‡æ˜¾ç¤ºçš„æäº¤<code>commit</code>æ¥æ‰§è¡Œ<code>mutation</code>å‡½æ•°ï¼Œé€šè¿‡<code>mutation</code>å‡½æ•°æ¥ä¿®æ”¹æ•°æ®ã€‚</p><h3 id="åŠ¨æ€æ³¨å†Œæ¨¡å—"><a href="#åŠ¨æ€æ³¨å†Œæ¨¡å—" class="headerlink" title="åŠ¨æ€æ³¨å†Œæ¨¡å—"></a>åŠ¨æ€æ³¨å†Œæ¨¡å—</h3><p><code>Vuex</code>ä¸­æ¨¡å—çš„æ³¨å†Œæ˜¯åœ¨åˆå§‹åŒ–<code>Store</code>å®ä¾‹çš„æ—¶å€™å®Œæˆçš„ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦åœ¨å®ä¾‹åˆ›å»ºä¹‹åå†åˆ›å»ºä¸€ä¸ªæ¨¡å—ï¼Œå°±å¯ä»¥ä½¿ç”¨<code>registerModule</code>æ–¹æ³•ï¼ŒåŠ¨æ€æ³¨å†Œä¸€ä¸ªæ¨¡å—ã€‚</p><p>çœ‹ä¸‹åŠ¨æ€æ³¨å†Œæ¨¡å—å‡½æ•°<code>registerModule</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åŠ¨æ€æ³¨å†Œæ¨¡å—ï¼Œåœ¨æ¨¡å—åˆå§‹åŒ–åæ‰‹åŠ¨æ³¨å†Œæ¨¡å— @API</span></span><br><span class="line">registerModule(path, rawModule, options = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) path = [path] <span class="comment">// ! å­—ç¬¦ä¸²åŒ…è£…æˆæ•°ç»„</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assert(<span class="built_in">Array</span>.isArray(path), <span class="string">`module path must be a string or an Array.`</span>)</span><br><span class="line">    assert(</span><br><span class="line">      path.length &gt; <span class="number">0</span>,</span><br><span class="line">      <span class="string">'cannot register the root module by using registerModule.'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._modules.register(path, rawModule) <span class="comment">// ! æ³¨å†Œæ¨¡å—</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! å®‰è£…æ¨¡å—</span></span><br><span class="line">  installModule(</span><br><span class="line">    <span class="keyword">this</span>,</span><br><span class="line">    <span class="keyword">this</span>.state,</span><br><span class="line">    path,</span><br><span class="line">    <span class="keyword">this</span>._modules.get(path),</span><br><span class="line">    options.preserveState</span><br><span class="line">  )</span><br><span class="line">  <span class="comment">// reset store to update getters...</span></span><br><span class="line">  <span class="comment">// ! åˆå§‹åŒ– store._vm</span></span><br><span class="line">  resetStoreVM(<span class="keyword">this</span>, <span class="keyword">this</span>.state)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¤„ç†ä¸‹<code>path</code>å‚æ•°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹éƒ½æ˜¯è¾“å…¥å­—ç¬¦ä¸²ç±»å‹çš„æ¨¡å—åï¼Œè¿™é‡Œéœ€è¦æŠŠå®ƒè½¬æ¢æˆæ•°ç»„ç±»å‹çš„<code>path</code>ã€‚</p><p>åŠ¨æ€æ³¨å†Œæ¨¡å—å’Œåˆå§‹åŒ–æ—¶æ³¨å†Œæ¨¡å—é€»è¾‘<strong>å”¯ä¸€ä¸åŒ</strong>çš„æ˜¯ï¼Œå®ƒä¸éœ€è¦é‡æ–°å»åˆ›å»ºæ ¹æ¨¡å—ã€‚</p><p>åœ¨åˆå§‹åŒ–<code>Store</code>å®ä¾‹çš„æ—¶å€™ï¼Œæ˜¯éœ€è¦å…ˆæ”¶é›†æ‰€æœ‰çš„æ¨¡å—ï¼Œåˆ›å»ºä¸€ä¸ª<code>ModuleCollection</code>å®ä¾‹å¯¹è±¡çš„ï¼ŒæŠŠè¿™ä¸ªå¯¹è±¡èµ‹å€¼ç»™<code>Store</code>ç±»çš„ <code>_modules</code>å±æ€§ï¼Œå®é™…ä¸Šå°±æ˜¯åˆ›å»ºäº†ä¸€ä¸ª<code>{root: Module instance}</code>ç»“æ„çš„æ ¹æ¨¡å—å¯¹è±¡ã€‚</p><p>å› ä¸ºæ ¹æ¨¡å—æ˜¯æ‰€æœ‰æ¨¡å—çš„çˆ¶æ¨¡å—ï¼ŒåŠ¨æ€æ³¨å†Œä¸€ä¸ªå­æ¨¡å—æ—¶ï¼Œå°±ä¸éœ€è¦å†åˆ›å»ºé‡æ–°æ ¹æ¨¡å—ã€‚è€Œæ˜¯åªæ³¨å†Œè¿™ä¸ªå­—æ¨¡å—ï¼ŒæŠŠå­æ¨¡å—æ·»åŠ åˆ°æ ¹æ¨¡å—ä¸‹é¢ã€‚ç„¶åéœ€è¦å®‰è£…è¿™ä¸ªå­æ¨¡å—ï¼ŒæŠŠæ¨¡å—çš„åŸå§‹æ•°æ®éƒ½æ·»åŠ åˆ°<code>store</code>çš„å®ä¾‹å±æ€§ä¸­ï¼Œæœ€ååˆå§‹åŒ–<code>store._vm</code>ï¼Œæ›´æ–°<code>getters</code>å±æ€§ã€‚ä¸Šé¢çš„æŒ‰ç…§æ¨¡å—å’Œåˆå§‹åŒ–<code>store._vm</code>çš„æ–¹æ³•å·²ç»åˆå§‹åŒ–<code>Store</code>å®ä¾‹å¯¹è±¡ä¸­è®²è§£è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p><p><code>store</code>å®ä¾‹ä¸­æ—¢ç„¶æœ‰åŠ¨æ€æ³¨å†Œæ¨¡å—çš„æ–¹æ³•ï¼Œé‚£ä¹ˆä¹Ÿä¼šæœ‰åŠ¨æ€å¸è½½æ¨¡å—çš„æ–¹æ³•ã€‚</p><h3 id="åŠ¨æ€å¸è½½æ¨¡å—"><a href="#åŠ¨æ€å¸è½½æ¨¡å—" class="headerlink" title="åŠ¨æ€å¸è½½æ¨¡å—"></a>åŠ¨æ€å¸è½½æ¨¡å—</h3><p>æŸ¥çœ‹<code>unregisterModule</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åŠ¨æ€å¸è½½æ¨¡å— @API</span></span><br><span class="line">unregisterModule(path) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) path = [path]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assert(<span class="built_in">Array</span>.isArray(path), <span class="string">`module path must be a string or an Array.`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._modules.unregister(path) <span class="comment">// ! æ³¨é”€æ¨¡å—</span></span><br><span class="line">  <span class="keyword">this</span>._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parentState = getNestedState(<span class="keyword">this</span>.state, path.slice(<span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">    Vue.delete(parentState, path[path.length - <span class="number">1</span>]) <span class="comment">// ! åˆ é™¤ state åœ¨è¯¥è·¯å¾„ä¸‹çš„å¼•ç”¨</span></span><br><span class="line">  &#125;)</span><br><span class="line">  resetStore(<span class="keyword">this</span>) <span class="comment">// ! é‡ç½® store</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯å¤„ç†ä¸‹<code>path</code>å‚æ•°ï¼Œç„¶åä½¿ç”¨<code>ModuleCollection</code>ç±»çš„ <code>unregister</code>æ–¹æ³•ï¼ŒæŠŠè¯¥æ¨¡å—ä»æ ¹æ¨¡å—ä¸­åˆ é™¤æ‰ï¼Œç„¶åæŠŠå®ƒçš„<code>state</code>æ•°æ®ä¹Ÿä»æ ¹çš„<code>state</code>ä¸­åˆ é™¤ï¼Œè¿™é‡Œåˆ é™¤<code>state</code>ä½¿ç”¨äº†<code>_withCommit</code>çš„æ–¹æ³•ï¼Œåœ¨<code>strict=true</code>æ—¶ä¸ä¼šæŠ¥é”™ï¼Œæœ€åé‡ç½®ä¸‹<code>store</code>ã€‚</p><p>å…ˆçœ‹ä¸‹åˆ é™¤æ¨¡å—çš„æ–¹æ³•<code>unregister</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ¨¡å—æ³¨é”€çš„æ–¹æ³•</span></span><br><span class="line">unregister(path) &#123;</span><br><span class="line">  <span class="keyword">const</span> parent = <span class="keyword">this</span>.get(path.slice(<span class="number">0</span>, <span class="number">-1</span>))</span><br><span class="line">  <span class="keyword">const</span> key = path[path.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> (!parent.getChild(key).runtime) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  parent.removeChild(key) <span class="comment">// ! ç§»é™¤å­æ¨¡å—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæ‰¾åˆ°éœ€è¦å¸è½½çš„æ¨¡å—åï¼Œç„¶åä½¿ç”¨äº†<code>Module</code>çš„<code>removeChild</code>æ–¹æ³•ï¼Œç§»é™¤è¿™ä¸ªæ¨¡å—ã€‚</p><p>å†çœ‹ä¸‹<code>resetStore</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! é‡ç½® storeï¼šå…ˆæ¸…ç©ºï¼Œå†é‡æ–°å®‰è£…æ¨¡å—å’Œåˆå§‹åŒ– VM</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetStore</span>(<span class="params">store, hot</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! é‡æ–°è®¾ç½®å€¼ä¸ºç©ºå¯¹è±¡</span></span><br><span class="line">  store._actions = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  store._mutations = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  store._wrappedGetters = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  store._modulesNamespaceMap = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">const</span> state = store.state</span><br><span class="line">  <span class="comment">// init all modules</span></span><br><span class="line">  installModule(store, state, [], store._modules.root, <span class="literal">true</span>)</span><br><span class="line">  <span class="comment">// reset vm</span></span><br><span class="line">  resetStoreVM(store, state, hot)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆé‡ç½®äº†ä¸€äº›åœ¨æ¨¡å—å®‰è£…æ—¶è®¾ç½®çš„å±æ€§ï¼ŒæŠŠå®ƒä»¬çš„å€¼æ¸…ç©ºæˆä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç„¶åé‡æ–°è·å– root çš„ <code>state</code>çš„å€¼ï¼Œå†é‡æ–°å®‰è£…å…¶ä»–æœªåˆ é™¤çš„æ¨¡å—å’Œåˆå§‹åŒ–<code>store._vm</code>å±æ€§ã€‚</p><p>è¿™æ ·ï¼ŒVuex çš„æ•°æ®æ“ä½œå°±åŸºæœ¬è®²è§£å®Œæˆäº†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/v2/vuex/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">Vuex æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vuex/tree/learn-vuex" target="_blank" rel="noopener">Vuex æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;æ•°æ®å­˜å‚¨å’Œè¯»å–&quot;&gt;&lt;a href=&quot;#æ•°æ®å­˜å‚¨å’Œè¯»å–&quot; class=&quot;headerlink&quot; title=&quot;æ•°æ®å­˜å‚¨å’Œè¯»å–&quot;&gt;&lt;/a&gt;æ•°æ®å­˜å‚¨å’Œè¯»å–&lt;/h2&gt;&lt;h3 id=&quot;state&quot;&gt;&lt;a href=&quot;#state&quot; class=&quot;headerlink&quot; title=&quot;state&quot;&gt;&lt;/a&gt;state&lt;/h3&gt;&lt;p&gt;&lt;code&gt;state&lt;/code&gt;æ˜¯åœ¨æ¨¡å—å®‰è£…&lt;code&gt;installModule&lt;/code&gt;å‡½æ•°ä¸­è®¾ç½®çš„ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// set state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!isRoot &amp;amp;&amp;amp; !hot) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; parentState = getNestedState(rootState, path.slice(&lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;, &lt;span class=&quot;number&quot;&gt;-1&lt;/span&gt;)) &lt;span class=&quot;comment&quot;&gt;// ! è·å–çˆ¶çº§çš„ state&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; moduleName = path[path.length - &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;] &lt;span class=&quot;comment&quot;&gt;// ! è·å–æ¨¡å—å&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  store._withCommit(&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; =&amp;gt;&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Vue.set(parentState, moduleName, &lt;span class=&quot;built_in&quot;&gt;module&lt;/span&gt;.state) &lt;span class=&quot;comment&quot;&gt;// ! è®¾ç½®å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå¹¶ä¸”ä¸ºå“åº”æ€§æ•°æ®&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é€šè¿‡&lt;code&gt;getNestedState&lt;/code&gt;æ–¹æ³•è·å–çˆ¶çº§æ¨¡å—ï¼Œç„¶åæŠŠæ‰€æœ‰æ¨¡å—ä¸‹é¢çš„&lt;code&gt;state&lt;/code&gt;æ•°æ®éƒ½æ‹·è´åˆ° root çš„&lt;code&gt;state&lt;/code&gt;ä¸­ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vuex" scheme="https://haledeng.com/categories/Vuex/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Vuex" scheme="https://haledeng.com/tags/Vuex/"/>
    
  </entry>
  
  <entry>
    <title>Vuex3æºç å­¦ä¹ ç¬”è®°ä¹‹Vuexçš„åˆå§‹åŒ–</title>
    <link href="https://haledeng.com/blog/20191011-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/"/>
    <id>https://haledeng.com/blog/20191011-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96/</id>
    <published>2019-10-11T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:43.431Z</updated>
    
    <content type="html"><![CDATA[<p><code>Store.js</code>æ–‡ä»¶ä¸­çš„ä»£ç ä¸­ï¼Œä¼šå¯¼å‡ºä¸€ä¸ª<code>Store</code>ç±»ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Vuex çš„æ—¶å€™éƒ½æ˜¯ä»å…ˆåˆ›å»ºä¸€ä¸ª<code>Store</code>å®ä¾‹å¯¹è±¡å¼€å§‹çš„ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>Store</code>å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><h2 id="Store-çš„åˆå§‹åŒ–"><a href="#Store-çš„åˆå§‹åŒ–" class="headerlink" title="Store çš„åˆå§‹åŒ–"></a>Store çš„åˆå§‹åŒ–</h2><p>å…ˆçœ‹ä¸‹<code>Store</code>ç±»çš„åˆå§‹åŒ–å‡½æ•°<code>constructor</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(options = &#123;&#125;) &#123;</span><br><span class="line">  <span class="comment">// Auto install if it is not done yet and `window` has `Vue`.</span></span><br><span class="line">  <span class="comment">// To allow users to avoid auto-installation in some cases,</span></span><br><span class="line">  <span class="comment">// this code should be placed here. See #731</span></span><br><span class="line">  <span class="comment">// ! ä½¿ç”¨ Vuex ä¸ºå¼•å…¥å¤–é“¾æ—¶ï¼Œä¼šè‡ªåŠ¨å®‰è£…æ’ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (!Vue &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="built_in">window</span>.Vue) &#123;</span><br><span class="line">    install(<span class="built_in">window</span>.Vue)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬ä½¿ç”¨å¤–é“¾æ¥å¼•å…¥ Vuex æ—¶ï¼Œä¼šè‡ªåŠ¨å®‰è£… Vuexï¼Œä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨<code>use</code>æ–¹æ³•æ¥å®‰è£…ã€‚</p><a id="more"></a><p>åœ¨æˆ‘ä»¬ä½¿ç”¨<code>script</code>æ ‡ç­¾ä½¿ç”¨ Vuex çš„æ—¶å€™ï¼Œæ­¤æ—¶ Vue åº“çš„ä»£ç å¿…é¡»å…ˆå¼•å…¥ï¼Œç„¶åå†å¼•å…¥ Vuex åº“çš„ä»£ç ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ Vuexã€‚åœ¨ç”¨å¤–é“¾å¼•å…¥ Vue å’Œ Vue çš„ä»£ç æ—¶ï¼Œ Vue çš„æ„é€ å‡½æ•°ä¼šè¢«èµ‹å€¼ç»™<code>window.Vue</code>ä¸”æµè§ˆå™¨å¯¹è±¡<code>window</code>ä¹Ÿæ˜¯æœ‰å®šä¹‰çš„ï¼Œ<code>store.js</code>æ–‡ä»¶ä¸­çš„å…¨å±€å˜é‡<code>Vue</code>ä¹Ÿè¿˜æ²¡æœ‰èµ‹å€¼ï¼Œæ­¤æ—¶æ‰ä¼šå®‰è£… Vuexã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vue/2.6.10/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vuex/3.1.1/vuex.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span></span><br><span class="line">      state: &#123;</span><br><span class="line">        count: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      mutations: &#123;</span><br><span class="line">        addOne(state) &#123;</span><br><span class="line">          state.count += 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">      template: `<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-on:click</span>=<span class="string">"$store.commit('addOne')"</span>&gt;</span>count: </span><span class="template-variable">&#123;&#123;$store.state.count&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">      store</span><br><span class="line"><span class="actionscript">    &#125;).$mount(<span class="string">'#app'</span>)</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œæ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œä¸‰ä¸ªæ–­è¨€</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  assert(Vue, <span class="string">`must call Vue.use(Vuex) before creating a store instance.`</span>)</span><br><span class="line">  assert(</span><br><span class="line">    <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>,</span><br><span class="line">    <span class="string">`vuex requires a Promise polyfill in this browser.`</span></span><br><span class="line">  )</span><br><span class="line">  assert(<span class="keyword">this</span> <span class="keyword">instanceof</span> Store, <span class="string">`store must be called with the new operator.`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹æ–­è¨€å‡½æ•°<code>assert</code>çš„ä»£ç ï¼Œåœ¨<code>util.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ–­è¨€ï¼šå½“æ¡ä»¶æ²¡è¾¾æˆçš„æ—¶å€™ï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">assert</span>(<span class="params">condition, msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!condition) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`[vuex] <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œæ²¡æœ‰æ»¡è¶³æ–­è¨€æ¡ä»¶çš„è¯ï¼Œå°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p><p>ä¸‹é¢åˆ†æä¸‹ä¸‰ä¸ªæ–­è¨€</p><ul><li>Vue å¿…é¡»æœ‰å€¼ï¼ˆå­˜åœ¨ï¼‰ï¼Œå› ä¸º Vuex åªæœ‰ä¾èµ– Vue æ‰èƒ½ä½¿ç”¨ã€‚</li><li>å¿…é¡»æ˜¯æ”¯æŒ Promise çš„ç¯å¢ƒï¼Œå› ä¸º Vuex ä¸­çš„ actions ä½¿ç”¨äº† Promise è¯­æ³•æ¥å¤„ç†å¼‚æ­¥ã€‚</li><li>ä¼ å…¥åˆ° Vue çš„é€‰é¡¹ä¸­çš„<code>store</code>å®ä¾‹å¯¹è±¡å¿…é¡»æ˜¯é€šè¿‡æ“ä½œç¬¦ new å‡ºæ¥çš„<code>Store</code>å®ä¾‹ã€‚</li></ul><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–é€‰é¡¹ä¸­çš„æ’ä»¶ï¼ˆé»˜è®¤æ˜¯ç©ºæ•°ç»„ï¼‰å’Œä¸¥æ ¼æ¨¡å¼å®šä¹‰ï¼ˆé»˜è®¤æ˜¯ falseï¼‰</span></span><br><span class="line"><span class="keyword">const</span> &#123; plugins = [], strict = <span class="literal">false</span> &#125; = options</span><br><span class="line"></span><br><span class="line"><span class="comment">// store internal state</span></span><br><span class="line"><span class="keyword">this</span>._committing = <span class="literal">false</span> <span class="comment">// ! åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ commit ä¿®æ”¹æ•°æ®</span></span><br><span class="line"><span class="keyword">this</span>._actions = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ actions</span></span><br><span class="line"><span class="keyword">this</span>._actionSubscribers = [] <span class="comment">// ! å­˜å‚¨ action çš„æ‰€æœ‰è®¢é˜…å‡½æ•°</span></span><br><span class="line"><span class="keyword">this</span>._mutations = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ mutations</span></span><br><span class="line"><span class="keyword">this</span>._wrappedGetters = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ wrapper getters</span></span><br><span class="line"><span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(options) <span class="comment">// ! â‘  æ¨¡å—æ”¶é›† =&gt; &#123; root: rootModule &#125;</span></span><br><span class="line"><span class="keyword">this</span>._modulesNamespaceMap = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! æ¨¡å—å‘½åæ˜ å°„è¡¨ &#123; 'moduleName/': module&#125;</span></span><br><span class="line"><span class="keyword">this</span>._subscribers = [] <span class="comment">// ! å­˜å‚¨ mutation çš„æ‰€æœ‰è®¢é˜…å‡½æ•°</span></span><br><span class="line"><span class="keyword">this</span>._watcherVM = <span class="keyword">new</span> Vue() <span class="comment">// ! åˆ›å»ºä¸€ä¸ª Vue å®ä¾‹ï¼Œç”¨æ¥ä½¿ç”¨å®ä¾‹å±æ€§ $watch å®ç° watch API</span></span><br><span class="line"><span class="keyword">this</span>._makeLocalGettersCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! æ¨¡å—çš„ getters</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>ä»<code>options</code>è·å–æ’ä»¶å’Œ<code>strict</code>æ¨¡å¼ã€‚</p><p>ç„¶åå®šä¹‰äº†ä¸€å †çš„å±æ€§ï¼Œå±æ€§è§£æè¯·çœ‹ä¸Šé¢çš„æ³¨é‡Šã€‚</p><p>è¿™é‡Œä¸»è¦çœ‹ä¸‹<code>this._modules</code>å±æ€§ï¼Œå®ƒæ˜¯<code>ModuleCollection</code>ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œé€šè¿‡åˆ›å»ºè¿™ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè¿›è¡Œæ¨¡å—çš„æ”¶é›†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(options) <span class="comment">// ! â‘  æ¨¡å—æ”¶é›† =&gt; &#123; root: rootModule &#125;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬ä¸€ä¸ªé‡ç‚¹é˜¶æ®µï¼šæ¨¡å—æ”¶é›†ã€‚</p><h2 id="æ¨¡å—æ”¶é›†"><a href="#æ¨¡å—æ”¶é›†" class="headerlink" title="æ¨¡å—æ”¶é›†"></a>æ¨¡å—æ”¶é›†</h2><h3 id="ModuleCollectionæ¨¡å—æ”¶é›†ç±»"><a href="#ModuleCollectionæ¨¡å—æ”¶é›†ç±»" class="headerlink" title="ModuleCollectionæ¨¡å—æ”¶é›†ç±»"></a><code>ModuleCollection</code>æ¨¡å—æ”¶é›†ç±»</h3><p>æŸ¥çœ‹<code>ModuleCollection</code>ç±»çš„ä»£ç ï¼Œåœ¨<code>module/module-collection.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ¨¡å—æ”¶é›†ç±»ï¼Œè®¾ç½® root æ¨¡å—</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuleCollection</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(rawRootModule) &#123;</span><br><span class="line">    <span class="comment">// register root module (Vuex.Store options)</span></span><br><span class="line">    <span class="keyword">this</span>.register([], rawRootModule, <span class="literal">false</span>) <span class="comment">// ! åˆå§‹åŒ–æ—¶æ³¨å†Œæ¨¡å—</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯æ”¶é›†æ¨¡å—ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>{ root: Module instance}</code>å®ä¾‹å¯¹è±¡ã€‚</p><p>çœ‹ç±»çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–æ—¶åªè°ƒç”¨<code>register</code>æ–¹æ³•æ¥æ³¨å†Œæ¨¡å—ã€‚</p><p>æŸ¥çœ‹<code>register</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">register(path, rawModule, runtime = <span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// ! å¼€å‘æ¨¡å¼ä¸‹æ–­è¨€åŸå§‹æ•°æ®ï¼Œåˆ¤æ–­è¾“å…¥çš„æ•°æ®ç±»å‹å’Œæ ¼å¼æ˜¯å¦æœ‰é”™</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assertRawModule(path, rawModule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newModule = <span class="keyword">new</span> Module(rawModule, runtime) <span class="comment">// ! åˆ›å»ºä¸€ä¸ªæ¨¡å—</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! path ä¸ºç©ºæ—¶</span></span><br><span class="line">  <span class="keyword">if</span> (path.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.root = newModule <span class="comment">// ! åˆ›å»ºçš„æ¨¡å—ä¸ºæ ¹æ¨¡å—ï¼Œæ³¨æ„ï¼šthis.root æ˜¯è¿™é‡Œç±»å”¯ä¸€çš„å±æ€§å€¼</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parent = <span class="keyword">this</span>.get(path.slice(<span class="number">0</span>, <span class="number">-1</span>)) <span class="comment">// ! æ ¹æ®è·¯å¾„è·å–åˆ°çˆ¶æ¨¡å—ï¼ˆåœ¨æ•°ç»„é‡Œé¢å®ƒå‰é¢çš„å…ƒç´ ï¼‰</span></span><br><span class="line">    parent.addChild(path[path.length - <span class="number">1</span>], newModule) <span class="comment">// ! æ·»åŠ å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register nested modules</span></span><br><span class="line">  <span class="comment">// ! ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å—ï¼Œæ³¨å†ŒåµŒå¥—æ¨¡å—</span></span><br><span class="line">  <span class="keyword">if</span> (rawModule.modules) &#123;</span><br><span class="line">    forEachValue(rawModule.modules, (rawChildModule, key) =&gt; &#123;</span><br><span class="line">      <span class="comment">// ! æŠŠ key æ”¾å…¥åˆ° path ä¸­ï¼Œkey === moduleName</span></span><br><span class="line">      <span class="keyword">this</span>.register(path.concat(key), rawChildModule, runtime)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šä½¿ç”¨æ–­è¨€å‡½æ•°æ ¡éªŒç”¨æˆ·è¾“å…¥çš„åŸå§‹é€‰é¡¹æ•°æ®çš„ç±»å‹æˆ–è€…æ ¼å¼æ˜¯å¦æœ‰é”™ã€‚</p><p>ç„¶åå£°æ˜å¸¸é‡<code>newModule</code>ï¼Œå­˜å‚¨é€šè¿‡æ“ä½œç¬¦ new åˆ›å»ºä¸€ä¸ª<code>Module</code>å®ä¾‹å¯¹è±¡çš„ã€‚å…ˆä¸ç®¡ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡æ˜¯æ€ä¹ˆæ ·å­çš„ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><p>å¦‚æœ<code>path</code>æ•°ç»„çš„é•¿åº¦ä¸º 0 æ—¶ï¼Œç”Ÿæˆçš„æ¨¡å—è¢«èµ‹å€¼ç»™<code>this.root</code>ï¼Œå³ç”Ÿæˆæ ¹æ¨¡å—ã€‚æ³¨æ„ï¼š<code>root</code>å±æ€§æ˜¯ç±»<code>ModuleCollection</code> å®ä¾‹å¯¹è±¡çš„å”¯ä¸€ä¸€ä¸ªçš„å±æ€§å€¼ã€‚æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ¨¡å—æ—¶ï¼Œ<code>path</code>æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œæ‰€æœ‰å…ˆä¸çœ‹ else ä»£ç å—çš„ä»£ç ï¼Œåé¢å†è§£æã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬çš„åŸå§‹æ•°æ®ä¸­è®¾ç½®äº†æ¨¡å—ï¼Œä¼šéå†è¿™äº›æ¨¡å—ï¼Œç„¶åè¿˜æ˜¯é€šè¿‡<code>register</code>æ–¹æ³•æ³¨å†Œè¿™äº›æ¨¡å—ã€‚è¿™é‡Œæ³¨å†Œæ—¶ï¼Œ<code>path</code>å°±ä¸æ˜¯ä¸€ä¸ªç©ºæ•°ç»„äº†ï¼Œè€Œæ˜¯åˆå¹¶äº†<code>key</code>ï¼Œä¹Ÿå°±æ˜¯æ¨¡å—åã€‚è¿™æ—¶ï¼Œä¼šè¿›å…¥ä¸Šé¢çš„ else ä»£ç å—çš„é€»è¾‘ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡<code>get</code>æ–¹æ³•æ ¹æ®ä¼ å…¥<code>path</code>æ•°ç»„ä¸­çš„<code>key</code>ä¹‹å‰çš„å…ƒç´ è·å–çˆ¶çº§æ¨¡å—ï¼Œç„¶åä½¿ç”¨<code>addChild</code>æ–¹æ³•æ·»åŠ æ¨¡å—ï¼Œæ·»åŠ çš„æ¨¡å—åå°±æ˜¯ä¹‹å‰ä¼ å…¥åˆ°<code>path</code>æ•°ç»„çš„<code>key</code>ï¼Œè¿™æ ·å°±å»ºç«‹å¥½äº†çˆ¶å­å…³ç³»ã€‚</p><p>è¿™é‡Œå¯èƒ½æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œè¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹æ•°æ®</span></span><br><span class="line">modules: &#123;</span><br><span class="line">  moduleA: &#123;<span class="comment">/* */</span>&#125;,</span><br><span class="line">  moduleB: &#123;<span class="comment">/* */</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆæ­¥æ”¶é›†æ¨¡å—åçš„ _modules å±æ€§</span></span><br><span class="line">_modules: &#123;</span><br><span class="line">  root: &#123;</span><br><span class="line">    _children: &#123;</span><br><span class="line">      moduleA: &#123;<span class="comment">/* Module instance */</span>&#125;,</span><br><span class="line">      moduleB: &#123;<span class="comment">/* Module instance */</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆè·å–çˆ¶çº§æ¨¡å—çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>(path) &#123;</span><br><span class="line">  <span class="keyword">return</span> path.reduce(<span class="function">(<span class="params"><span class="built_in">module</span>, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.getChild(key)</span><br><span class="line">  &#125;, <span class="keyword">this</span>.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæ¨¡å—å¯¹åº”çš„<code>path</code>æ•°ç»„ä¸­åªæœ‰æ¨¡å—åä¸€ä¸ªå…ƒç´ ï¼Œå–å®ƒä¹‹å‰çš„å…ƒç´ æ„æˆä¸€ä¸ªæ–°çš„<code>path</code>ï¼Œæ­¤æ—¶<code>path</code>å…¶å®æ˜¯ä¸€ä¸ªç©ºæ•°ç»„<code>[]</code>ï¼Œè¿™æ—¶è·å–åˆ°çš„çˆ¶çº§æ¨¡å—å°±æ˜¯æ ¹æ¨¡å—ã€‚æ‰€ä»¥ä¼šæŠŠ<code>moduleA</code>å’Œ<code>moduleB</code>è¿™ä¸¤ä¸ªæ¨¡å—æ·»åŠ åˆ°æ ¹æ¨¡å—çš„<code>_children</code>å±æ€§ä¸­ã€‚</p><h3 id="Moduleæ¨¡å—ç±»"><a href="#Moduleæ¨¡å—ç±»" class="headerlink" title="Moduleæ¨¡å—ç±»"></a><code>Module</code>æ¨¡å—ç±»</h3><p>æ¨¡å—çš„å®ä¾‹å¯¹è±¡æ˜¯é€šè¿‡<code>Module</code>ç”Ÿæˆçš„ï¼Œå®ƒé‡Œé¢å®šä¹‰äº†ä¸€äº›æ“ä½œæ¨¡å—çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>æŸ¥çœ‹<code>Module</code>ç±»çš„ä»£ç ï¼Œåœ¨<code>module/module.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(rawModule, runtime) &#123;</span><br><span class="line">    <span class="keyword">this</span>.runtime = runtime <span class="comment">// ! å­˜å‚¨ runtime çš„å€¼</span></span><br><span class="line">    <span class="comment">// Store some children item</span></span><br><span class="line">    <span class="keyword">this</span>._children = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨å­æ¨¡å—</span></span><br><span class="line">    <span class="comment">// Store the origin module object which passed by programmer</span></span><br><span class="line">    <span class="keyword">this</span>._rawModule = rawModule <span class="comment">// ! å­˜å‚¨åŸå§‹æ¨¡å—æ•°æ®</span></span><br><span class="line">    <span class="keyword">const</span> rawState = rawModule.state <span class="comment">// ! è·å–æ ¹çš„ state åŸå§‹æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the origin module's state</span></span><br><span class="line">    <span class="keyword">this</span>.state = (<span class="keyword">typeof</span> rawState === <span class="string">'function'</span> ? rawState() : rawState) || &#123;&#125; <span class="comment">// ! å­˜å‚¨ state</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œå®šä¹‰äº†ä¸€äº›å±æ€§ï¼ŒæŸ¥çœ‹ä¸Šé¢ä»£ç çš„æ³¨é‡Šã€‚æ¯”å¦‚æˆ‘ä»¬åˆšæ‰ç”¨åˆ°çš„<code>_children</code>å±æ€§å°±æ˜¯ç”¨æ¥å­˜å‚¨å­æ¨¡å—çš„ã€‚</p><p>å¦å¤–è¿˜å®šä¹‰äº†ä¸€äº›æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬åˆšæ‰ç”¨åˆ°çš„æ·»åŠ å­æ¨¡å—çš„æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¢åŠ å­æ¨¡å—</span></span><br><span class="line">addChild(key, <span class="built_in">module</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>._children[key] = <span class="built_in">module</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æŠŠå­æ¨¡å—æ·»åŠ åˆ°<code>_children</code>å±æ€§ä¸­ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæ¨¡å—çš„æ”¶é›†å·¥ä½œå°±å®Œæˆäº†ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ¨¡å—æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªæ ¹æ¨¡å—ã€‚è¿™ä¸ªæ ¹æ¨¡å—å¯¹åº”çš„<code>key</code>ï¼Œå°±æ˜¯<code>root</code>ï¼Œå³å¯¹è±¡<code>{ root: root Module}</code>ï¼Œç„¶åæŠŠè¿™ä¸ªå¯¹è±¡æ·»åŠ åˆ°<code>store</code>å®ä¾‹çš„<code>_modules</code>å±æ€§ä¸­ã€‚</p><p>ä¸‹é¢ç»§ç»­çœ‹<code>Store</code>ç±»çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bind commit and dispatch to self</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">this</span></span><br><span class="line"><span class="keyword">const</span> &#123; dispatch, commit &#125; = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! ç»‘å®š thisï¼ŒæŒ‡å‘ store å®ä¾‹æœ¬èº«</span></span><br><span class="line"><span class="keyword">this</span>.dispatch = <span class="function"><span class="keyword">function</span> <span class="title">boundDispatch</span>(<span class="params">type, payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch.call(store, type, payload)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.commit = <span class="function"><span class="keyword">function</span> <span class="title">boundCommit</span>(<span class="params">type, payload, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> commit.call(store, type, payload, options)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»‘å®š<code>commit</code>å’Œ<code>dispatch</code>æ–¹æ³•çš„<code>this</code>æŒ‡å‘ï¼Œå®ƒä»¬çš„<code>this</code>éƒ½æŒ‡å‘<code>store</code>å®ä¾‹æœ¬èº«ã€‚</p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç»‘å®šå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æŠŠ<code>store</code>å®ä¾‹å¯¹è±¡èµ‹å€¼ç»™ Vue çš„<code>$store</code>å±æ€§ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ä¾‹ç»„ä»¶ä¸­å°±å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨<code>commit</code>å’Œ<code>dispatch</code>æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$store.commti(<span class="string">'xxx'</span>)</span><br><span class="line"><span class="keyword">this</span>.$store.dispatch(<span class="string">'xxx'</span>)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œå¦‚æœä¸ç»‘å®š<code>this</code>ï¼Œ<code>commit</code>å’Œ<code>diaptch</code>æ–¹æ³•ä¸­çš„<code>this</code>æŒ‡å‘çš„å°±æ˜¯è°ƒç”¨çš„å®ƒä»¬çš„ Vue å®ä¾‹ç»„ä»¶ï¼Œè€Œä¸æ˜¯<code>Store</code>å®ä¾‹å¯¹è±¡ã€‚ä½†æ˜¯ Vue å®ä¾‹ç»„ä»¶ä¸­å¹¶æ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„ï¼Œè¿™æ ·å°±ä¼šå‡ºé”™ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// strict mode</span></span><br><span class="line"><span class="comment">// ! åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä»»ä½• mutation å¤„ç†å‡½æ•°ä»¥å¤–ä¿®æ”¹ Vuex state éƒ½ä¼šæŠ›å‡ºé”™è¯¯ã€‚</span></span><br><span class="line"><span class="keyword">this</span>.strict = strict</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="keyword">this</span>._modules.root.state <span class="comment">// ! è·å–æ ¹çš„ state</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®ä¸¥æ ¼æ¨¡å¼å’Œè·å–æ ¹çš„ state æ•°æ®ã€‚ä¸¥æ ¼æ¨¡å¼ä¸€èˆ¬åªåœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ï¼Œè€Œä¸èƒ½å†ç”Ÿæˆç¯å¢ƒä¸­å¯ç”¨ï¼Œç†ç”±åœ¨åé¢ä¼šè®²ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init root module.</span></span><br><span class="line"><span class="comment">// this also recursively registers all sub-modules</span></span><br><span class="line"><span class="comment">// and collects all module getters inside this._wrappedGetters</span></span><br><span class="line">installModule(<span class="keyword">this</span>, state, [], <span class="keyword">this</span>._modules.root) <span class="comment">// ! â‘¡ å®‰è£… root æ¨¡å— ï¼Œæ¨¡å—åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>installModule</code>å‡½æ•°å®‰è£…æ¨¡å—ã€‚è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬äºŒä¸ªé‡ç‚¹é˜¶æ®µï¼šæ¨¡å—å®‰è£…ã€‚</p><h2 id="æ¨¡å—å®‰è£…"><a href="#æ¨¡å—å®‰è£…" class="headerlink" title="æ¨¡å—å®‰è£…"></a>æ¨¡å—å®‰è£…</h2><p>å®‰è£…æ¨¡å—ï¼Œè¯´ç™½äº†å°±æ˜¯åˆå§‹åŒ–<code>store</code>å®ä¾‹çš„ä¸€äº›å±æ€§ï¼Œåœ¨å‰é¢æ¨¡å—æ”¶é›†æ—¶åªæ˜¯åˆæ­¥å¤„ç†äº†åŸå§‹æ•°æ®ï¼Œè¿™é‡Œä¼šæ›´è¿›ä¸€æ­¥å¤„ç†åŸå§‹æ•°æ®ï¼ŒæŠŠå¤„ç†åçš„æ•°æ®æ”¾åˆ°ä¸€å¼€å§‹å®šä¹‰çš„å±æ€§ä¸­ï¼Œæ¯”å¦‚<code>_actions</code> ã€<code>_mutations</code>ç­‰å±æ€§ä¸­ã€‚</p><p>æŸ¥çœ‹<code>installModule</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">installModule</span>(<span class="params">store, rootState, path, module, hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isRoot = !path.length <span class="comment">// ! åˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ¨¡å—</span></span><br><span class="line">  <span class="keyword">const</span> namespace = store._modules.getNamespace(path) <span class="comment">// ! è·å–å‘½åç©ºé—´æ¨¡å—çš„åç§° 'moduleName/'</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‡½æ•°ä½“å‰é¢çš„ä»£ç ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ¨¡å—ï¼Œå½“<code>path</code>æ˜¯ä¸€ä¸ªç©ºæ•°ç»„æ—¶ï¼Œä¼ å…¥çš„æ¨¡å—<code>module</code>å°±æ˜¯æ ¹æ¨¡å—ã€‚</p><p>ç„¶åè·å–æœ‰å‘½åç©ºé—´æ¨¡å—çš„åç§°ï¼Œæ˜¯é€šè¿‡<code>ModuleCollection</code>å®ä¾‹å¯¹è±¡çš„<code>getNamespace</code>æ–¹æ³•è·å–çš„ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–å‘½åç©ºé—´æ¨¡å—çš„åç§°</span></span><br><span class="line">getNamespace(path) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="built_in">module</span> = <span class="keyword">this</span>.root <span class="comment">// ! è·å–æ ¹æ¨¡å—</span></span><br><span class="line">  <span class="keyword">return</span> path.reduce(<span class="function">(<span class="params">namespace, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">module</span> = <span class="built_in">module</span>.getChild(key) <span class="comment">// ! è·å–å­æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! å­æ¨¡å— key è®¾ç½®äº†å‘½åç©ºé—´ï¼Œè·å– keyï¼Œå¹¶ä¸”æ‹¼æ¥ '/'</span></span><br><span class="line">    <span class="comment">// ! ç¬¬ä¸€è½®å¾ªç¯ï¼špath = [ moduleName ]ï¼Œnamespace = ''ï¼Œkey = moduleName =&gt;  'moduleName/'</span></span><br><span class="line">    <span class="keyword">return</span> namespace + (<span class="built_in">module</span>.namespaced ? key + <span class="string">'/'</span> : <span class="string">''</span>)</span><br><span class="line">  &#125;, <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>path</code>è·å–æœ‰å‘½åç©ºé—´çš„æ¨¡å—çš„åç§°ã€‚å› ä¸º<code>Module</code>çš„å®ä¾‹å¯¹è±¡ä¸­æ˜¯é€šè¿‡<code>_children</code>å±æ€§å­˜å‚¨å­æ¨¡å—çš„ï¼Œå®ƒçš„å­˜å‚¨æ–¹å¼æ˜¯é”®å€¼å¯¹ç»“æ„ï¼Œå…¶ä¸­çš„é”®åå°±æ˜¯æ¨¡å—åï¼Œç„¶åæ¨¡å—ååœ¨æ¨¡å—æ”¶é›†æ—¶ï¼Œå·²ç»é€šè¿‡è°ƒç”¨æ³¨å†Œæ–¹æ³•<code>register</code>æŠŠå®ƒæ”¾å…¥åˆ°<code>path</code>æ•°ç»„ä¸­ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸æ–­çš„éå†ï¼Œä½¿ç”¨<code>getChild</code>æ–¹æ³•è·å–å­æ¨¡å—ï¼Œç„¶ååœ¨æœ€åè¿”å›å®ƒçš„æ¨¡å—åã€‚å¦å¤–è¿˜éœ€è¦åœ¨æ¨¡å—ååé¢æ‹¼æ¥<code>/</code>ç¬¦å·ï¼Œæ˜¯ä¸ºäº†åœ¨åé¢æ›´å¥½çš„æ‹¼æ¥æ¨¡å—å†…çš„ç±»å‹åã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register in namespace map</span></span><br><span class="line"><span class="comment">// ! å¦‚æœè®¾ç½®äº†å‘½åç©ºé—´ï¼Œå³ namespaced = true</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.namespaced) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    store._modulesNamespaceMap[namespace] &amp;&amp;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      <span class="string">`[vuex] duplicate namespace <span class="subst">$&#123;namespace&#125;</span> for the namespaced module <span class="subst">$&#123;path.join(</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="string">'/'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  store._modulesNamespaceMap[namespace] = <span class="built_in">module</span> <span class="comment">// ! èµ‹å€¼åˆ°å‘½åæ˜ å°„è¡¨ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†æ¨¡å—åå’Œæ¨¡å—ï¼Œå°±æŠŠå®ƒä»¬èµ‹å€¼åˆ°<code>_modulesNamespaceMap</code>å±æ€§ä¸­ï¼Œæ–¹é¢åé¢ä½¿ç”¨ã€‚åœ¨æ³¨å†Œä¹‹å‰è¿˜éœ€è¦åˆ¤æ–­<code>_modulesNamespaceMap</code>æ˜ å°„è¡¨ä¸­æ˜¯å¦å·²ç»å­˜å‚¨è¿™ä¸ªæ¨¡å—ï¼Œå¦‚æœå­˜åœ¨ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºä½ æ¨¡å—é‡å¤ï¼Œè¿™æ—¶å€™éœ€è¦æ£€æµ‹ä¸‹æ˜¯å¦ç¼–å†™äº†ç›¸åŒçš„æ¨¡å—ã€‚</p><p>æˆåŠŸèµ‹å€¼åï¼Œ<code>_modulesNamespaceMap</code>æ˜ å°„è¡¨å±æ€§çš„ç¤ºä¾‹ä»£ç å°±ä¼šåƒä¸‹é¢è¿™æ ·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  moduleA/: &#123;<span class="comment">/* Module instance */</span>&#125;,</span><br><span class="line">  moduleB/: &#123;<span class="comment">/* Module instance */</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set state</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">  <span class="keyword">const</span> parentState = getNestedState(rootState, path.slice(<span class="number">0</span>, <span class="number">-1</span>)) <span class="comment">// ! è·å–çˆ¶çº§çš„ state</span></span><br><span class="line">  <span class="keyword">const</span> moduleName = path[path.length - <span class="number">1</span>] <span class="comment">// ! è·å–æ¨¡å—å</span></span><br><span class="line">  store._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    Vue.set(parentState, moduleName, <span class="built_in">module</span>.state) <span class="comment">// ! è®¾ç½®å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå¹¶ä¸”ä¸ºå“åº”æ€§æ•°æ®</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯è®¾ç½®<code>state</code>æ•°æ®ï¼ŒæŠŠæ‰€æœ‰æ¨¡å—ä¸‹é¢çš„<code>state</code>æ•°æ®ç»Ÿä¸€æ”¾å…¥åˆ° root çš„<code>state</code>å±æ€§ä¸­ã€‚</p><p>è¿™é‡Œé€šè¿‡<code>getNestedState</code>å‡½æ•°æ¥è·å–æ¨¡å—ä¸‹é¢çš„<code>state</code>ï¼Œé€šè¿‡<code>path</code>æ•°ç»„æ¥æŸ¥æ‰¾</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNestedState</span>(<span class="params">state, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.length ? path.reduce(<span class="function">(<span class="params">state, key</span>) =&gt;</span> state[key], state) : state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æ ¹çš„<code>state</code>æ•°æ®å’Œæ¨¡å—çš„<code>state</code>çš„ç»“æ„ä¹‹å‰æ˜¯è¿™æ ·çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleA</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleB</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠæ‰€æœ‰æ¨¡å—çš„<code>state</code>æ•°æ®æ”¾åˆ° root çš„<code>state</code>ä¸­å°±å˜æˆä¸‹é¢è¿™æ ·å­ã€‚åé¢è¿˜ä¼šæŠŠ<code>state</code>æ•°æ®æ”¾å…¥åˆ° Vue ç»„ä»¶çš„<code>data</code>å±æ€§ä¸‹é¢ï¼Œå˜æˆå“åº”å¼æ•°æ®ï¼Œè¿™é‡Œå…ˆä¹°ä¸ªå…³å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root state</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">0</span></span><br><span class="line">  moduleA: &#123;</span><br><span class="line">    count: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  moduleB: &#123;</span><br><span class="line">    count: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ„é€ äº†ä¸€ä¸ªæœ¬åœ°ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆæ¨¡å—å†…éƒ¨ï¼‰</span></span><br><span class="line"><span class="comment">// ! local ä¸­çš„ commit dispatch state getter çš„æ•ˆæœä¼šä¸ä¸€æ ·</span></span><br><span class="line"><span class="keyword">const</span> local = (<span class="built_in">module</span>.context = makeLocalContext(store, namespace, path))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>makeLocalContext</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ¨¡å—ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆ<code>module.context</code>å±æ€§ï¼‰ï¼Œé‡å†™<code>local</code>ä¸‹é¢çš„ä¸€äº›å±æ€§ã€‚</p><h3 id="makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡"><a href="#makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡" class="headerlink" title="makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡"></a><code>makeLocalContext</code>åˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡</h3><p>æŸ¥çœ‹<code>makeLocalContext</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeLocalContext</span>(<span class="params">store, namespace, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> noNamespace = namespace === <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! åˆ›å»º local å±æ€§</span></span><br><span class="line">  <span class="comment">// ! é‡å†™æœ‰å‘½åç©ºé—´çš„æ¨¡å—é‡Œé¢çš„ dispatch commit æ–¹æ³•å’Œ getters state å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> local = &#123;</span><br><span class="line">    dispatch: noNamespace</span><br><span class="line">      ? store.dispatch <span class="comment">// ! æ²¡æœ‰å‘½åç©ºé—´ï¼Œç›´æ¥ä½¿ç”¨æ ¹çš„ dispatch --&gt; dispatch(actionName, payload)</span></span><br><span class="line">      : <span class="comment">// ... çœç•¥é‡å†™çš„æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    commit: noNamespace</span><br><span class="line">      ? store.commit</span><br><span class="line">      : <span class="comment">// ... çœç•¥é‡å†™çš„æ–¹æ³•</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getters and state object must be gotten lazily</span></span><br><span class="line">  <span class="comment">// because they will be changed by vm update</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">    getters: &#123;</span><br><span class="line">      <span class="keyword">get</span>: noNamespace</span><br><span class="line">        ? () =&gt; store.getters</span><br><span class="line">        : () =&gt; makeLocalGetters(store, namespace) // ! ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç†æ¨¡å—é‡Œé¢çš„ getters</span><br><span class="line">    &#125;,</span><br><span class="line">    state: &#123;</span><br><span class="line">      <span class="keyword">get</span>: () =&gt; getNestedState(store.state, path) // ! é€šè¿‡è·¯å¾„è·å–åµŒå¥—çš„ state</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return local</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå£°æ˜å¸¸é‡<code>noNamespace</code>è¡¨ç¤ºæ˜¯å¦å­˜åœ¨å‘½åç©ºé—´çš„æ¨¡å—ï¼Œå®ƒçš„å€¼æ˜¯<code>true</code>æ—¶è¡¨ç¤ºæ²¡æœ‰ï¼Œå³<code>namespace</code>ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p><p>ç„¶åå®šä¹‰äº†ä¸€ä¸ª<code>local</code>å¸¸é‡ï¼Œé‡Œé¢é‡å†™äº†åœ¨æœ‰å‘½åç©ºé—´ä¸­çš„æ¨¡å—é‡Œé¢çš„<code>dispatch</code>ã€<code>commit</code>ã€<code>getters</code>ã€<code>state</code>çš„é€»è¾‘ï¼Œæœ€åè¿”å›<code>local</code>è¿™ä¸ªå¸¸é‡ã€‚</p><p>å…ˆçœ‹ä¸‹é‡å†™çš„<code>dispatch</code>å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">dispatch: noNamespace</span><br><span class="line">  ? store.dispatch <span class="comment">// ! æ²¡æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œç›´æ¥ä½¿ç”¨æ ¹çš„ dispatch --&gt; dispatch(actionName, payload)</span></span><br><span class="line">: <span class="comment">// ! æœ‰å‘½åç©ºé—´ï¼Œæäº¤çš„ç±»å‹ type ä¸ä¸€æ ·</span></span><br><span class="line">  (_type, _payload, _options) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> args = unifyObjectStyle(_type, _payload, _options)</span><br><span class="line">    <span class="keyword">const</span> &#123; payload, options &#125; = args</span><br><span class="line">    <span class="keyword">let</span> &#123; type &#125; = args</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! options: &#123; root: true &#125; -&gt; ä¹Ÿä¸ä¼šæ‹¼æ¥å‘½åç©ºé—´</span></span><br><span class="line">    <span class="keyword">if</span> (!options || !options.root) &#123;</span><br><span class="line">      type = namespace + type <span class="comment">// ! æ‹¼æ¥ type =&gt; 'moduleName/actionName'</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        !store._actions[type]</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(</span><br><span class="line">          <span class="string">`[vuex] unknown local action type: <span class="subst">$&#123;args.type&#125;</span>, global type: <span class="subst">$&#123;type&#125;</span>`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ! ä¼ å…¥æ–°çš„ type ä¸ºå‚æ•° --&gt; dispatch(moduleName/actionName, payload)</span></span><br><span class="line">   <span class="keyword">return</span> store.dispatch(type, payload)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯åˆ¤æ–­<code>noNamespace</code>çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´çš„æ¨¡å—ï¼Œå°±ç›´æ¥è°ƒç”¨<code>store.diaptch</code>ï¼Œå®ƒçš„å‚æ•°ä¸­çš„<code>type</code>ä¸å˜ï¼Œå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch(actionName, payload) <span class="comment">// ! è¿™é‡Œçš„ actionName æ˜¯ root ä¸‹é¢çš„</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å‘½åç©ºé—´çš„æ¨¡å—æˆ–è€…æ²¡æœ‰è®¾ç½®ç¬¬ä¸‰ä¸ªé€‰é¡¹å‚æ•°<code>{root: true}</code>ï¼Œä¼šæ‹¼æ¥<code>type</code>ï¼Œä½¿å¾—<code>type</code>å˜æˆ<code>moduleName/actionName</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¨¡å—ä¸­æäº¤<code>action</code>æ—¶ï¼Œæäº¤çš„<code>actionName</code>ä¼šå˜æˆ<code>moduleName/actionName</code>ï¼Œè¿™æ ·å°±å’Œ root ä¸­çš„<code>actionName</code>å¾ˆå¥½çš„åŒºåˆ†å¼€æ¥ï¼Œè°ƒç”¨çš„æ—¶å€™å°±æ˜¯è°ƒç”¨<code>moduleName/actionName</code>å‡½æ•°ï¼Œè€Œä¸æ˜¯<code>actionName</code>å‡½æ•°ã€‚</p><p>é‡å†™çš„<code>commit</code>æ–¹æ³•å’Œ<code>dispatch</code>é€»è¾‘ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹é‡å†™<code>getters</code>å’Œ<code>state</code>ä»£ç ï¼Œå®ƒä»¬æœ‰ç‚¹ä¸ä¸€æ ·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">  getters: &#123;</span><br><span class="line">    <span class="keyword">get</span>: noNamespace</span><br><span class="line">      ? () =&gt; store.getters</span><br><span class="line">      : () =&gt; makeLocalGetters(store, namespace) // ! ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç†æ¨¡å—é‡Œé¢çš„ getters</span><br><span class="line">  &#125;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; getNestedState(store.state, path) // ! é€šè¿‡è·¯å¾„è·å–åµŒå¥—çš„ state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹<code>getters</code>ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯<code>store.getters</code>ï¼Œå¦åˆ™å‡½æ•°è¿”å›å€¼æ˜¯<code>_makeLocalGettersCache</code>å±æ€§ä¸­å¯¹åº”çš„å€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡æ˜¯é€šè¿‡<code>makeLocalGetters</code>å‡½æ•°ç”Ÿæˆçš„ã€‚</p><p>çœ‹ä¸‹<code>makeLocalGetters</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeLocalGetters</span>(<span class="params">store, namespace</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! æ·»åŠ æ¨¡å—çš„ getters åˆ° _makeLocalGettersCache ä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (!store._makeLocalGettersCache[namespace]) &#123;</span><br><span class="line">    <span class="keyword">const</span> gettersProxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> splitPos = namespace.length <span class="comment">// ! åˆ†å‰²ç‚¹ï¼šnamespace çš„é•¿åº¦</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(store.getters).forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// skip if the target getter is not match this namespace</span></span><br><span class="line">      <span class="keyword">if</span> (type.slice(<span class="number">0</span>, splitPos) !== namespace) <span class="keyword">return</span> <span class="comment">// ! å‘½åç©ºé—´å’Œ type çš„æ¨¡å—åä¸ä¸€è‡´æ—¶ç›´æ¥è¿”å›ï¼Œå³æ²¡æœ‰åŒ¹é…æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// extract local getter type</span></span><br><span class="line">      <span class="keyword">const</span> localType = type.slice(splitPos) <span class="comment">// ! æˆªå– type åç§°ï¼šmoduleName/getterName --&gt; getterName</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Add a port to the getters proxy.</span></span><br><span class="line">      <span class="comment">// Define as getter property because</span></span><br><span class="line">      <span class="comment">// we do not want to evaluate the getters in this time.</span></span><br><span class="line">      <span class="comment">// ! ä»£ç† gettersProxyï¼ŒgettersProxy.localType === store.getters[type]</span></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(gettersProxy, localType, &#123;</span><br><span class="line">        <span class="keyword">get</span>: () =&gt; store.getters[type],</span><br><span class="line">        enumerable: true</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    store._makeLocalGettersCache[namespace] = gettersProxy</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return store._makeLocalGettersCache[namespace]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦åˆ¤æ–­<code>_makeLocalGettersCache</code>å±æ€§ä¸­æ˜¯å¦æœ‰æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦æŠŠæ¨¡å—çš„<code>getters</code>æ·»åŠ è¿›å»ã€‚</p><p>å£°æ˜å¸¸é‡<code>gettersProxy</code>ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç”¨æ¥ä»£ç†æ¨¡å—çš„<code>getters</code>ï¼Œæœ€åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</p><p>å£°æ˜å¸¸é‡<code>splitPos</code>å­˜å‚¨<code>namespace</code>çš„é•¿åº¦å€¼ã€‚</p><p>ç„¶åéå†<code>store.getters</code>çš„<code>keys</code>ï¼Œå½“å‘½åç©ºé—´çš„å€¼å’Œ<code>type</code>çš„æ¨¡å—åä¸ä¸€æ ·æ—¶ç›´æ¥è¿”å›ï¼Œå³æ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”çš„æ¨¡å—ã€‚</p><p>å¦‚æœåŒ¹é…æˆåŠŸï¼Œå£°æ˜å¸¸é‡<code>localType</code>æˆªå– type çš„åç§°ï¼Œå³åŸæ¥æ˜¯<code>moduleName/getterName</code>çš„åç§°ç°åœ¨å˜æˆ<code>getterName</code>ã€‚ç„¶åä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰<code>gettersProxy</code>å¯¹è±¡çš„<code>localType</code>å±æ€§ï¼Œä½†æ˜¯å®ƒçš„<code>getter</code>è¿”å›çš„ç¡®å®<code>store.getters</code>ä¸­çš„<code>type</code>çš„å€¼ã€‚</p><p>è¿™é‡Œè¯·æ³¨æ„ä¸‹ï¼Œåœ¨<code>store.getters</code>ä¸­çš„<code>type</code>é”®åæ˜¯å¸¦æ¨¡å—åå‰ç¼€çš„ï¼Œè€Œ<code>localType</code>é”®åæ˜¯ä¸å¸¦æ¨¡å—åå‰ç¼€çš„ã€‚</p><p>è¿™é‡Œä¹Ÿæœ‰ç‚¹ç»•ï¼Œå…¶å®å°±æ˜¯åœ¨æ¨¡å—é‡Œé¢è®¿é—®<code>getter</code>å±æ€§æ˜¯ä¸éœ€è¦å¸¦æ¨¡å—åå‰ç¼€çš„ï¼Œç›´æ¥è®¿é—®ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¾“å‡ºå®ƒçš„å€¼æ—¶ä»<code>store.getters</code>å±æ€§ä¸­è·å–çš„ï¼Œè¿™é‡Œå±æ€§æ˜¯å¸¦æœ‰æ¨¡å—åå‰ç¼€çš„ï¼Œä¸ç„¶è¾“å‡ºçš„å°±ä¸æ˜¯æ¨¡å—çš„<code>getter</code>ï¼Œè€Œæ˜¯ root çš„<code>getter</code>ã€‚æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“<code>store.getters</code>å±æ€§çš„ç»“æ„ï¼Œåé¢çŸ¥é“åå°±ä¼šæ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p><p>æœ€åçœ‹ä¸‹<code>state</code>ï¼Œå®ƒæ˜¯ç›´æ¥é€šè¿‡<code>getNestedState</code>æ¥è·å–<code>state</code>çš„å€¼ï¼Œä¸ç®¡æ˜¯ root çš„<code>state</code>å€¼è¿˜æ˜¯åœ¨æ¨¡å—çš„<code>state</code>å€¼ã€‚å› ä¸ºåœ¨å®šä¹‰æ¨¡å—ä¸Šä¸‹æ–‡ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ‰€æœ‰æ¨¡å—çš„<code>state</code>å·²ç»è¢«æ”¾åœ¨ root çš„<code>state</code>ä¸­ï¼Œæ‰€ä»¥é€šè¿‡<code>getNestedState</code>å‡½æ•°å¯ä»¥å¾ˆå¥½è·å–å®ƒä»¬çš„å€¼ã€‚</p><p>åˆ›å»ºå¥½ä¸Šä¸‹æ–‡å¯¹è±¡<code>local</code>ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>installModule</code>å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å’Œæ³¨å†Œæ¨¡å—ï¼Œä¸‹åŒ</span></span><br><span class="line"><span class="built_in">module</span>.forEachMutation(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/mutationName'</span></span><br><span class="line">  registerMutation(store, namespacedType, mutation, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.forEachAction(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> type = action.root ? key : namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/actionName'</span></span><br><span class="line">  <span class="keyword">const</span> handler = action.handler || action <span class="comment">// ! è·å– action å‡½æ•°</span></span><br><span class="line">  registerAction(store, type, handler, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.forEachGetter(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/getterName'</span></span><br><span class="line">  registerGetter(store, namespacedType, getter, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! é€’å½’æ³¨å†Œå­æ¨¡å—</span></span><br><span class="line"><span class="built_in">module</span>.forEachChild(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot) <span class="comment">// ! path è¿æ¥ key(æ¨¡å—å)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>éå†æ¨¡å—ä¸­çš„å­˜å‚¨çš„åŸå§‹æ•°æ®ï¼Œç„¶åæ³¨å†Œè¿™äº›åŸå§‹æ•°æ®ã€‚è¿™é‡Œåˆ†åˆ«æ³¨å†Œäº†<code>mutation</code>ã€<code>action</code>ã€<code>getter</code>å’Œå­æ¨¡å—ã€‚</p><p>åœ¨<code>Module</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“åŸå§‹çš„æ•°æ®<code>rawModule</code>æ˜¯å­˜å‚¨åœ¨<code>_rawModule</code>å±æ€§ä¸­çš„ã€‚</p><p>å…ˆçœ‹ä¸‹å¦‚ä½•éå†<code>mutaions</code>çš„å€¼ï¼ŒæŸ¥çœ‹<code>forEachMutation</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>module/module.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å¹¶å¤„ç† mutations</span></span><br><span class="line">forEachMutation(fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._rawModule.mutations) &#123;</span><br><span class="line">    forEachValue(<span class="keyword">this</span>._rawModule.mutations, fn)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨çœ‹ä¸‹å·¥å…·å‡½æ•°<code>forEachValue</code>çš„ä»£ç ï¼Œåœ¨<code>util.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * forEach for object</span></span><br><span class="line"><span class="comment"> * ! ä½¿ç”¨å‡½æ•°å¤„ç†å¯¹è±¡çš„æ‰€æœ‰ value å’Œ key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">forEachValue</span>(<span class="params">obj, fn</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> fn(obj[key], key))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éå†ä¼ å…¥çš„å¯¹è±¡<code>obj</code>çš„<code>keys</code>ï¼Œç„¶ååœ¨è°ƒç”¨ä¼ å…¥çš„å‡½æ•°<code>fn</code>å¤„ç†å¯¹è±¡çš„<code>value</code>å’Œ<code>key</code>ã€‚</p><p><code>forEachMutation</code>å‡½æ•°å°±æ˜¯éå†ä¼ å…¥çš„<code>mutions</code>å¯¹è±¡ï¼Œç„¶åå¤„ç†å¯¹è±¡é‡Œé¢çš„<code>value</code>å’Œ<code>key</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.forEachMutation(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/mutationName'</span></span><br><span class="line">  registerMutation(store, namespacedType, mutation, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä½“ä¸­å…ˆå£°æ˜å¸¸é‡<code>namespacedType</code>å­˜å‚¨æ‹¼æ¥<code>namespace</code>å’Œ<code>key</code>åçš„å€¼ï¼Œç„¶åè°ƒç”¨å‡½æ•°<code>registerMutation</code>æ³¨å†Œ<code>mutation</code>ã€‚</p><p>çœ‹ä¸‹<code>registerMutation</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒæ˜¯å¦‚ä½•æ³¨å†Œ<code>mutation</code>çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerMutation</span>(<span class="params">store, type, handler, local</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! &#123; 'moduleName/mutationName': entry &#125;</span></span><br><span class="line">  <span class="keyword">const</span> entry = store._mutations[type] || (store._mutations[type] = [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! _mutations = &#123; 'moduleName/mutationName': [wrappedMutationHandler] &#125;</span></span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedMutationHandler</span>(<span class="params">payload</span>) </span>&#123;</span><br><span class="line">    handler.call(store, local.state, payload) <span class="comment">// ! mutationFn(local.state, payload) -&gt; ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å—çš„ state</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æŠŠåŸå§‹çš„<code>mutaions</code>æ”¾å…¥åˆ°<code>store</code>å®ä¾‹å±æ€§çš„<code>_mutations</code>ä¸­ã€‚æ³¨æ„è¿™é‡Œå°±ç”¨åˆ°äº†æ¨¡å—ä¸Šä¸‹æ–‡<code>local</code>ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ä¼ å…¥çš„æ˜¯<code>local.state</code>ï¼Œå³æ¨¡å—çš„<code>state</code>ï¼Œè¿™é‡Œçš„<code>state</code>å°±æ˜¯é€šè¿‡<code>getNestedState</code>å‡½æ•°è·å–çš„ï¼Œä¸ç®¡æ˜¯ root çš„<code>state</code>ï¼Œè¿˜æ˜¯æ¨¡å—çš„<code>state</code>ï¼Œéƒ½èƒ½æ­£ç¡®è·å–åˆ°å€¼ã€‚</p><p>å…¶å®åœ¨åˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡çš„å‡½æ•°ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ä¹Ÿä¼šå…¼å®¹æ²¡æœ‰å‘½åç©ºé—´æ¨¡å—çš„å¤„ç†ã€‚æ‰€ä»¥çœ‹åˆ°ä½¿ç”¨äº†<code>local</code>çš„å±æ€§æ—¶ï¼Œä¸è¦æ…Œï¼Œä»–å·²ç»åšäº†å…¼å®¹å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´çš„æ¨¡å—çš„è¯ï¼Œä¼šæŒ‰ç…§ root çš„å€¼å»å¤„ç†ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>actions</code>çš„éå†å’Œæ³¨å†Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ mutationsï¼ŒæŠŠ mutation æ”¾å…¥åˆ° _mutations ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="built_in">module</span>.forEachAction(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> type = action.root ? key : namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/actionName'</span></span><br><span class="line">  <span class="keyword">const</span> handler = action.handler || action <span class="comment">// ! è·å– action å‡½æ•°</span></span><br><span class="line">  registerAction(store, type, handler, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å’Œ<code>mutaion</code>çš„é€»è¾‘å·®ä¸å¤šï¼Œä¸è¿‡ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡º<code>action</code>æ›´åŠ çµæ´»ï¼Œå³å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¼šæŠŠå‡½æ•°æ”¾åœ¨å¯¹è±¡çš„<code>handler</code>å±æ€§ä¸­ã€‚</p><p>çœ‹ä¸‹<code>registerAction</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ actionsï¼ŒæŠŠ action æ”¾å…¥åˆ° _actions ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerAction</span>(<span class="params">store, type, handler, local</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> entry = store._actions[type] || (store._actions[type] = [])</span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedActionHandler</span>(<span class="params">payload, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res = handler.call(</span><br><span class="line">      store,</span><br><span class="line">      <span class="comment">// ! ç¬¬ä¸€ä¸ªå‚æ•°æœ‰å¾ˆå¤šé€‰é¡¹ï¼Œæ³¨æ„åŒºåˆ†æ˜¯æ¨¡å— local çš„å±æ€§è¿˜æ˜¯æ ¹ store çš„å±æ€§</span></span><br><span class="line">      &#123;</span><br><span class="line">        dispatch: local.dispatch,</span><br><span class="line">        commit: local.commit,</span><br><span class="line">        getters: local.getters,</span><br><span class="line">        state: local.state,</span><br><span class="line">        rootGetters: store.getters,</span><br><span class="line">        rootState: store.state</span><br><span class="line">      &#125;,</span><br><span class="line">      payload,</span><br><span class="line">      cb</span><br><span class="line">    ) <span class="comment">// ! actionFn(&#123; commit... rootState &#125;, payload, cb)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! åˆ¤æ–­è¿”å›å€¼æ˜¯å¦æ˜¯ Promiseï¼Œä¸æ˜¯å°±è°ƒç”¨ Promise.resolve() è½¬æ¢æˆ Promise</span></span><br><span class="line">    <span class="keyword">if</span> (!isPromise(res)) &#123;</span><br><span class="line">      res = <span class="built_in">Promise</span>.resolve(res)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (store._devtoolHook) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        store._devtoolHook.emit(<span class="string">'vuex:error'</span>, err)</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘ä¹Ÿå’Œ<code>mutaion</code>çš„ç»„æˆå·®ä¸å¤šï¼Œåªæ˜¯<code>action</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰éå¸¸å¤šçš„é€‰é¡¹ã€‚æœ‰å››ä¸ªæ¨¡å—çš„å±æ€§å’Œä¸¤ä¸ª root çš„å±æ€§ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“<code>action</code>å‡½æ•°æ˜¯å¯ä»¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šåˆ¤æ–­å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œä¼šä½¿ç”¨<code>Promise.resolve()</code>æ–¹æ³•æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ª Promise å¯¹è±¡ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>getters</code>çš„éå†å’Œæ³¨å†Œï¼Œé€»è¾‘å’Œå‰é¢çš„ä¸€æ ·ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.forEachGetter(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type --&gt; 'moduleName/getterName'</span></span><br><span class="line">  registerGetter(store, namespacedType, getter, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹<code>registerGetter</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ gettersï¼ŒæŠŠ getter æ”¾å…¥åˆ° _wrappedGetters ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerGetter</span>(<span class="params">store, type, rawGetter, local</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! å·²ç»åœ¨é‡Œé¢äº†ï¼Œå°±ä¸è¦æ³¨å†Œäº†</span></span><br><span class="line">  <span class="keyword">if</span> (store._wrappedGetters[type]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`[vuex] duplicate getter key: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! ä½¿ç”¨åŸå§‹å‡½æ•°</span></span><br><span class="line">  store._wrappedGetters[type] = <span class="function"><span class="keyword">function</span> <span class="title">wrappedGetter</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rawGetter(</span><br><span class="line">      <span class="comment">// ! ä¼ å…¥å¤šä¸ªå‚æ•°</span></span><br><span class="line">      local.state, <span class="comment">// local state</span></span><br><span class="line">      local.getters, <span class="comment">// local getters</span></span><br><span class="line">      store.state, <span class="comment">// root state</span></span><br><span class="line">      store.getters <span class="comment">// root getters</span></span><br><span class="line">    ) <span class="comment">// ! getterFn(state, getter, rootState, rootGetter)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­ä¸‹<code>_wrappedGetters</code>æ˜¯å¦å·²ç»å­˜åœ¨<code>getterName</code>ï¼Œå¦‚æœå­˜åœ¨ï¼Œå³å®ƒä»¬çš„<code>key</code>å€¼ç›¸åŒï¼Œè¿™æ—¶åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚è¿™è¯´æ˜å¯èƒ½åˆ›å»ºäº†ä¸¤ä¸ªä¸€æ ·çš„æ¨¡å—ï¼Œéœ€è¦åˆ é™¤å…¶ä¸­çš„ä¸€ä¸ªæ¨¡å—ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„æ˜¯<code>_wrappedGetters</code>å±æ€§ï¼Œè€Œä¸æ˜¯<code>getters</code>å±æ€§ï¼Œ<code>_wrappedGetters</code>é‡Œé¢çš„å‡½æ•°åŒ…è£…äº†åŸå§‹çš„<code>rawGetter</code>ï¼Œç„¶åæŠŠåŒ…è£…åçš„<code>wrappedGetter</code>å‡½æ•°ç»„æˆçš„å¯¹è±¡èµ‹å€¼ç»™<code>_wrappedGetters</code>å±æ€§ã€‚</p><p>çœ‹ä¸‹<code>installModule</code>å‡½æ•°çš„æœ€åä»£ç ï¼Œé€’å½’æ³¨å†Œå­æ¨¡å—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! é€’å½’æ³¨å†Œå­æ¨¡å—</span></span><br><span class="line"><span class="built_in">module</span>.forEachChild(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot) <span class="comment">// ! path è¿æ¥ key(æ¨¡å—å)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹æ¨¡å—çš„<code>forEachChild</code>æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å¹¶å¤„ç†å­æ¨¡å—</span></span><br><span class="line">forEachChild(fn) &#123;</span><br><span class="line">  forEachValue(<span class="keyword">this</span>._children, fn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéå†çš„æ˜¯æ¨¡å—çš„å­æ¨¡å—<code>this._children</code>çš„å€¼ã€‚ç„¶åé€’å½’è°ƒç”¨<code>installModule</code>è¿›è¡Œæ³¨å†Œï¼Œæ³¨æ„<code>path</code>çš„å˜åŒ–ï¼Œè¿™é‡Œä¸åœ¨æ˜¯ç©ºæ•°ç»„ï¼Œè€Œæ˜¯åˆå¹¶äº†<code>key</code>å€¼ï¼ˆå³å­æ¨¡å—çš„åç§°ï¼‰ã€‚</p><p>æ¨¡å—å®‰è£…å®Œæˆåï¼Œç»§ç»­çœ‹<code>Store</code>çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initialize the store vm, which is responsible for the reactivity</span></span><br><span class="line"><span class="comment">// (also registers _wrappedGetters as computed properties)</span></span><br><span class="line">resetStoreVM(<span class="keyword">this</span>, state) <span class="comment">// ! â‘¢ åˆå§‹åŒ– store._vm</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>resetStoreVM</code>å‡½æ•°åˆå§‹åŒ–<code>store._vm</code>å±æ€§ã€‚è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬ä¸‰ä¸ªé‡ç‚¹é˜¶æ®µï¼šåˆå§‹åŒ–<code>store._vm</code>ã€‚</p><h2 id="åˆå§‹åŒ–store-vm"><a href="#åˆå§‹åŒ–store-vm" class="headerlink" title="åˆå§‹åŒ–store._vm"></a>åˆå§‹åŒ–<code>store._vm</code></h2><p>è¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯<code>store</code>å®ä¾‹è‡ªèº«å’Œ root çš„<code>state</code>çš„å€¼ã€‚ä¸‹é¢çœ‹ä¸‹<code>resetStoreVM</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetStoreVM</span>(<span class="params">store, state, hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> oldVm = store._vm <span class="comment">// ! ç¼“å­˜æ—§çš„ VMï¼Œç”¨äºçƒ­é‡è½½</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind store public getters</span></span><br><span class="line">  store.getters = &#123;&#125; <span class="comment">// ! åˆ›å»º getters å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> wrappedGetters = store._wrappedGetters <span class="comment">// ! è·å– wrappedGetters å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> computed = &#123;&#125; <span class="comment">// ! è®¾ç½®è®¡ç®—å±æ€§å¯¹è±¡</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç¼“å­˜æ—§çš„<code>store._vm</code>ç”¨äºçƒ­é‡è½½æ—¶é”€æ¯ï¼Œç„¶åå®šä¹‰<code>store.getters</code>çš„åˆå§‹å€¼ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œæ³¨æ„è¿™é‡Œæ‰æ­£å¼å¼€å§‹å®šäº<code>getters</code>å±æ€§ï¼Œå†å£°æ˜å¸¸é‡<code>wrappedGetters</code>å­˜å‚¨<code>store._wrappedGetters</code>ï¼Œå£°æ˜<code>computed</code>å¯¹è±¡ï¼Œåˆå§‹å€¼æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå† wrappedGetters</span></span><br><span class="line">forEachValue(wrappedGetters, (fn, key) =&gt; &#123;</span><br><span class="line">  <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">  <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">  <span class="comment">// using partial to return function with only arguments preserved in closure enviroment</span></span><br><span class="line">  <span class="comment">// ! æŠŠ wrappedGetter å‡½æ•°çš„è¿”å›å€¼èµ‹å€¼åˆ° VM çš„ computed ä¸­</span></span><br><span class="line">  computed[key] = partial(fn, store) <span class="comment">// ! fn(store) -&gt; wrappedGetter(store)</span></span><br><span class="line">  <span class="comment">// ! å®šä¹‰ store.getters çš„å±æ€§</span></span><br><span class="line">  <span class="comment">// ! store.getters.xxx -&gt; store._vm[xxx] -&gt; store._vm.computed[xxx]</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(store.getters, key, &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; store._vm[key],</span><br><span class="line">    enumerable: true // for local getters</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéå†<code>wrappedGetters</code>ï¼Œç„¶åæŠŠå®ƒé‡Œé¢çš„æ•°æ®èµ‹å€¼ç»™ä¸Šé¢å£°æ˜çš„<code>computed</code>å¯¹è±¡ã€‚æ³¨æ„è¿™é‡Œæ˜¯è°ƒç”¨äº†<code>fn</code>å‡½æ•°ï¼Œå»æ‰å‡½æ•°åŒ…è£…ï¼Œç”ŸæˆçœŸæ­£çš„<code>getter</code>ã€‚</p><p><code>store.getters</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getters: &#123;</span><br><span class="line">  getterFn()&#123;&#125;, <span class="comment">// root getters</span></span><br><span class="line">  <span class="string">'modulesA/getterFn'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesA/getterFn2'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesB/getterFn'</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰<code>key</code>çš„å±æ€§ä¸­çš„<code>getter</code>çš„è¿”å›å€¼ä¸º<code>store._vm[key]</code>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨ Vue çš„å®ä¾‹å¯¹è±¡ä¸­è®¡ç®—å±æ€§<code>computed</code>çš„å€¼ä¼šå‡ºç°åœ¨ä»£ç†çš„å®ä¾‹å¯¹è±¡ä¸­ã€‚åé¢ä¼šæŠŠ<code>computed</code>å¯¹è±¡ä½œä¸ºè®¡ç®—å±æ€§æ³¨å…¥åˆ° Vue çš„å®ä¾‹ä¸­ï¼Œå› ä¸ºè®¡ç®—å±æ€§éƒ½ä¼šè¢«ä»£ç†åˆ° Vue çš„å®ä¾‹ä¸­ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>store._vm[key]</code>è·å–åˆ°è®¡ç®—å±æ€§ã€‚å½“è®¿é—®<code>store.getters</code>çš„æ—¶å€™ï¼Œå°±æ˜¯è®¿é—®<code>store._vm[key]</code>ï¼Œä¹Ÿå°±æ˜¯è®¿é—®è®¡ç®—å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> silent = Vue.config.silent <span class="comment">// ! ç¼“å­˜åŸæ¥çš„ silent</span></span><br><span class="line">Vue.config.silent = <span class="literal">true</span> <span class="comment">// ! è®¾ä¸º trueï¼Œå°†ä¸ä¼šæŠ¥ä»»ä½•è­¦å‘Š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! åˆ›å»º store._vm å®ä¾‹</span></span><br><span class="line"><span class="comment">// ! ç»‘å®š state å’Œ getter ä¸º Vue å®ä¾‹çš„ data å’Œ computed å±æ€§ï¼Œå˜æˆå“åº”å¼æ•°æ®</span></span><br><span class="line">store._vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    $$state: state <span class="comment">// !  store.state -&gt; store._vm.data.$$state</span></span><br><span class="line">  &#125;,</span><br><span class="line">  computed <span class="comment">// ! store._vm.computed[xxx] -&gt; store._vm[xxx]</span></span><br><span class="line">&#125;)</span><br><span class="line">Vue.config.silent = silent <span class="comment">// ! æ¢å¤åŸæ¥çš„ silent</span></span><br></pre></td></tr></table></figure><p>å…ˆå¤„ç† silent çš„è®¾ç½®ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ–°çš„ Vue å®ä¾‹å¯¹è±¡ï¼Œèµ‹å€¼ç»™<code>store._vm</code>ï¼Œåœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­æŠŠæ ¹æ•°æ®<code>state</code>èµ‹å€¼ä¸ºåˆ° Vue å®ä¾‹çš„<code>data</code>å±æ€§çš„<code>$$state</code>ï¼Œç„¶åæŠŠä¸Šé¢å®šä¹‰çš„<code>computed</code>å¯¹è±¡ä¹Ÿä¼ å…¥è¿›å»ã€‚è¿™æ ·<code>store</code>çš„<code>state</code>å’Œ<code>getters</code>å±æ€§éƒ½å˜æˆäº†å“åº”å¼æ•°æ®ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒVuex çŠ¶æ€ç®¡ç†å™¨çš„æ•°æ®ä¸åŒæ„ä¸€èˆ¬çš„æ¨¡å—æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå®ƒæ˜¯å“åº”å¼çš„ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹äº† Vuex çš„æ•°æ®æ—¶ï¼Œä¾èµ– Vuex çš„æ•°æ®çš„ç»„ä»¶çš„è§†å›¾ä¼šè‡ªåŠ¨æ›´æ–°ã€‚è¿™é‡Œçš„æºç å°±æ˜¯ Vuex çš„æ•°æ®å˜æˆå“åº”å¼æ•°æ®çš„åŸå› ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// enable strict mode for new vm</span></span><br><span class="line"><span class="comment">// ! åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œç¡®ä¿åªèƒ½é€šè¿‡ commit æ¥æ˜¾ç¤ºçš„ä¿®æ”¹ state çš„å€¼</span></span><br><span class="line"><span class="keyword">if</span> (store.strict) &#123;</span><br><span class="line">  enableStrictMode(store)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬ä¿®æ”¹ Vuex çš„æ•°æ®å¿…é¡»æ˜¾ç¤ºçš„æäº¤<code>commit</code>æ¥è¿›è¡Œä¿®æ”¹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><p>çœ‹ä¸‹<code>enableStrictMode</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ‰§è¡Œä¸¥æ ¼æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enableStrictMode</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! åœ¨å¼€å‘ç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ commit ä¿®æ”¹äº† state çš„å€¼ï¼Œä¼šæŠ¥é”™</span></span><br><span class="line">  store._vm.$watch(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._data.$$state <span class="comment">// ! ä¸¥æ ¼æ¨¡å¼ä¸‹ç›‘å¬ store.state å€¼çš„å˜åŒ–</span></span><br><span class="line">    &#125;,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        assert(</span><br><span class="line">          store._committing,</span><br><span class="line">          <span class="string">`do not mutate vuex store state outside mutation handlers.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">deep</span>: <span class="literal">true</span>, <span class="attr">sync</span>: <span class="literal">true</span> &#125; <span class="comment">// ! æ·±åº¦ç›‘å¬å’ŒåŒæ­¥æ‰§è¡Œï¼Œæœ‰æ€§èƒ½æ¶ˆè€—ï¼Œåªèƒ½åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ strict</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡ Vue å®ä¾‹çš„ä¾¦å¬å™¨<code>$watch</code>å»ç›‘å¬<code>state</code>çš„å˜åŒ–ï¼Œåœ¨å˜åŒ–çš„æ—¶å€™ï¼Œå¦‚æœ<code>store._committing</code>ä¸º<code>false</code>ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­æŠ¥é”™ã€‚åŒæ—¶è¿˜è®¾ç½®äº†æ·±åº¦ç›‘å¬å’ŒåŒæ­¥æ‰§è¡Œï¼Œè¿™æ ·ä¼šæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥<code>strick</code>åªèƒ½åœ¨å¼€å‘ç¯å¢ƒä¸­å¼€å¯ï¼Œåƒä¸‡ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ—¶å¼€å¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! çƒ­é‡è½½å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> (oldVm) &#123;</span><br><span class="line">  <span class="keyword">if</span> (hot) &#123;</span><br><span class="line">    <span class="comment">// dispatch changes in all subscribed watchers</span></span><br><span class="line">    <span class="comment">// to force getter re-evaluation for hot reloading.</span></span><br><span class="line">    store._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      oldVm._data.$$state = <span class="literal">null</span> <span class="comment">// ! æ•°æ®é‡ç½®ä¸º null</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  Vue.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> oldVm.$destroy()) <span class="comment">// ! é”€æ¯æ—§çš„ VM</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ Vuex çƒ­é‡è½½çš„è®¾ç½®ï¼Œçƒ­é‡è½½åéœ€è¦é‡ç½®æ—§çš„ VM çš„æ•°æ®å’Œé”€æ¯æ—§çš„ VM å®ä¾‹ã€‚</p><p>åˆå§‹åŒ–<code>store._vm</code>å®Œæˆåï¼Œç»§ç»­çœ‹<code>Store</code>ç±»çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„æœ€åä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply plugins</span></span><br><span class="line">plugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> plugin(<span class="keyword">this</span>)) <span class="comment">// ! è°ƒç”¨æ‰€æœ‰æ’ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! å¤„ç† devtool æ’ä»¶</span></span><br><span class="line"><span class="keyword">const</span> useDevtools =</span><br><span class="line">  options.devtools !== <span class="literal">undefined</span> ? options.devtools : Vue.config.devtools</span><br><span class="line"><span class="keyword">if</span> (useDevtools) &#123;</span><br><span class="line">  devtoolPlugin(<span class="keyword">this</span>) <span class="comment">// ! å®‰è£… devtool æ’ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ‰€æœ‰çš„æ’ä»¶ï¼Œæœ€åè®¾ç½®å®˜æ–¹çš„ devtool æ’ä»¶ã€‚</p><p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œ<code>Store</code>çš„å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–å°±å®Œæˆäº†ï¼Œå…¶å®è¿™ä¹Ÿå°±æ˜¯ Vuex çš„åˆå§‹åŒ–ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨<code>script</code>æ ‡ç­¾ä½¿ç”¨ Vuex çš„æ—¶å€™ï¼Œæ­¤æ—¶ Vue åº“çš„ä»£ç å¿…é¡»å…ˆå¼•å…¥ï¼Œç„¶åå†å¼•å…¥ Vuex åº“çš„ä»£ç ï¼Œè¿™æ ·æ‰èƒ½ä½¿ç”¨ Vuexã€‚åœ¨ç”¨å¤–é“¾å¼•å…¥ Vue å’Œ Vue çš„ä»£ç æ—¶ï¼Œ Vue çš„æ„é€ å‡½æ•°ä¼šè¢«èµ‹å€¼ç»™<code>window.Vue</code>ä¸”æµè§ˆå™¨å¯¹è±¡<code>window</code>ä¹Ÿæ˜¯æœ‰å®šä¹‰çš„ï¼Œ<code>store.js</code>æ–‡ä»¶ä¸­çš„å…¨å±€å˜é‡<code>Vue</code>ä¹Ÿè¿˜æ²¡æœ‰èµ‹å€¼ï¼Œæ­¤æ—¶æ‰ä¼šå®‰è£… Vuexã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vue/2.6.10/vue.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/vuex/3.1.1/vuex.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span></span><br><span class="line">      state: &#123;</span><br><span class="line">        count: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      mutations: &#123;</span><br><span class="line">        addOne(state) &#123;</span><br><span class="line">          state.count += 1</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line"><span class="actionscript">    <span class="keyword">new</span> Vue(&#123;</span></span><br><span class="line"><span class="handlebars"><span class="xml">      template: `<span class="tag">&lt;<span class="name">div</span> <span class="attr">v-on:click</span>=<span class="string">"$store.commit('addOne')"</span>&gt;</span>count: </span><span class="template-variable">&#123;&#123;$store.state.count&#125;&#125;</span><span class="xml"><span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line">      store</span><br><span class="line"><span class="actionscript">    &#125;).$mount(<span class="string">'#app'</span>)</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œæ˜¯åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ‰§è¡Œä¸‰ä¸ªæ–­è¨€</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  assert(Vue, <span class="string">`must call Vue.use(Vuex) before creating a store instance.`</span>)</span><br><span class="line">  assert(</span><br><span class="line">    <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>,</span><br><span class="line">    <span class="string">`vuex requires a Promise polyfill in this browser.`</span></span><br><span class="line">  )</span><br><span class="line">  assert(<span class="keyword">this</span> <span class="keyword">instanceof</span> Store, <span class="string">`store must be called with the new operator.`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹æ–­è¨€å‡½æ•°<code>assert</code>çš„ä»£ç ï¼Œåœ¨<code>util.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ–­è¨€ï¼šå½“æ¡ä»¶æ²¡è¾¾æˆçš„æ—¶å€™ï¼ŒæŠ›å‡ºé”™è¯¯</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">assert</span>(<span class="params">condition, msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!condition) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`[vuex] <span class="subst">$&#123;msg&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å¾ˆç®€å•ï¼Œæ²¡æœ‰æ»¡è¶³æ–­è¨€æ¡ä»¶çš„è¯ï¼Œå°±ä¼šæŠ›å‡ºé”™è¯¯ã€‚</p><p>ä¸‹é¢åˆ†æä¸‹ä¸‰ä¸ªæ–­è¨€</p><ul><li>Vue å¿…é¡»æœ‰å€¼ï¼ˆå­˜åœ¨ï¼‰ï¼Œå› ä¸º Vuex åªæœ‰ä¾èµ– Vue æ‰èƒ½ä½¿ç”¨ã€‚</li><li>å¿…é¡»æ˜¯æ”¯æŒ Promise çš„ç¯å¢ƒï¼Œå› ä¸º Vuex ä¸­çš„ actions ä½¿ç”¨äº† Promise è¯­æ³•æ¥å¤„ç†å¼‚æ­¥ã€‚</li><li>ä¼ å…¥åˆ° Vue çš„é€‰é¡¹ä¸­çš„<code>store</code>å®ä¾‹å¯¹è±¡å¿…é¡»æ˜¯é€šè¿‡æ“ä½œç¬¦ new å‡ºæ¥çš„<code>Store</code>å®ä¾‹ã€‚</li></ul><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–é€‰é¡¹ä¸­çš„æ’ä»¶ï¼ˆé»˜è®¤æ˜¯ç©ºæ•°ç»„ï¼‰å’Œä¸¥æ ¼æ¨¡å¼å®šä¹‰ï¼ˆé»˜è®¤æ˜¯ falseï¼‰</span></span><br><span class="line"><span class="keyword">const</span> &#123; plugins = [], strict = <span class="literal">false</span> &#125; = options</span><br><span class="line"></span><br><span class="line"><span class="comment">// store internal state</span></span><br><span class="line"><span class="keyword">this</span>._committing = <span class="literal">false</span> <span class="comment">// ! åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ commit ä¿®æ”¹æ•°æ®</span></span><br><span class="line"><span class="keyword">this</span>._actions = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ actions</span></span><br><span class="line"><span class="keyword">this</span>._actionSubscribers = [] <span class="comment">// ! å­˜å‚¨ action çš„æ‰€æœ‰è®¢é˜…å‡½æ•°</span></span><br><span class="line"><span class="keyword">this</span>._mutations = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ mutations</span></span><br><span class="line"><span class="keyword">this</span>._wrappedGetters = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨ wrapper getters</span></span><br><span class="line"><span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(options) <span class="comment">// ! â‘  æ¨¡å—æ”¶é›† =&gt; &#123; root: rootModule &#125;</span></span><br><span class="line"><span class="keyword">this</span>._modulesNamespaceMap = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! æ¨¡å—å‘½åæ˜ å°„è¡¨ &#123; 'moduleName/': module&#125;</span></span><br><span class="line"><span class="keyword">this</span>._subscribers = [] <span class="comment">// ! å­˜å‚¨ mutation çš„æ‰€æœ‰è®¢é˜…å‡½æ•°</span></span><br><span class="line"><span class="keyword">this</span>._watcherVM = <span class="keyword">new</span> Vue() <span class="comment">// ! åˆ›å»ºä¸€ä¸ª Vue å®ä¾‹ï¼Œç”¨æ¥ä½¿ç”¨å®ä¾‹å±æ€§ $watch å®ç° watch API</span></span><br><span class="line"><span class="keyword">this</span>._makeLocalGettersCache = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! æ¨¡å—çš„ getters</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>ä»<code>options</code>è·å–æ’ä»¶å’Œ<code>strict</code>æ¨¡å¼ã€‚</p><p>ç„¶åå®šä¹‰äº†ä¸€å †çš„å±æ€§ï¼Œå±æ€§è§£æè¯·çœ‹ä¸Šé¢çš„æ³¨é‡Šã€‚</p><p>è¿™é‡Œä¸»è¦çœ‹ä¸‹<code>this._modules</code>å±æ€§ï¼Œå®ƒæ˜¯<code>ModuleCollection</code>ç±»çš„å®ä¾‹å¯¹è±¡ï¼Œé€šè¿‡åˆ›å»ºè¿™ä¸ªå®ä¾‹å¯¹è±¡ï¼Œè¿›è¡Œæ¨¡å—çš„æ”¶é›†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>._modules = <span class="keyword">new</span> ModuleCollection(options) <span class="comment">// ! â‘  æ¨¡å—æ”¶é›† =&gt; &#123; root: rootModule &#125;</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬ä¸€ä¸ªé‡ç‚¹é˜¶æ®µï¼šæ¨¡å—æ”¶é›†ã€‚</p><h2 id="æ¨¡å—æ”¶é›†-1"><a href="#æ¨¡å—æ”¶é›†-1" class="headerlink" title="æ¨¡å—æ”¶é›†"></a>æ¨¡å—æ”¶é›†</h2><h3 id="ModuleCollectionæ¨¡å—æ”¶é›†ç±»-1"><a href="#ModuleCollectionæ¨¡å—æ”¶é›†ç±»-1" class="headerlink" title="ModuleCollectionæ¨¡å—æ”¶é›†ç±»"></a><code>ModuleCollection</code>æ¨¡å—æ”¶é›†ç±»</h3><p>æŸ¥çœ‹<code>ModuleCollection</code>ç±»çš„ä»£ç ï¼Œåœ¨<code>module/module-collection.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ¨¡å—æ”¶é›†ç±»ï¼Œè®¾ç½® root æ¨¡å—</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ModuleCollection</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(rawRootModule) &#123;</span><br><span class="line">    <span class="comment">// register root module (Vuex.Store options)</span></span><br><span class="line">    <span class="keyword">this</span>.register([], rawRootModule, <span class="literal">false</span>) <span class="comment">// ! åˆå§‹åŒ–æ—¶æ³¨å†Œæ¨¡å—</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨æ˜¯æ”¶é›†æ¨¡å—ï¼Œå®ƒä¼šåˆ›å»ºä¸€ä¸ª<code>{ root: Module instance}</code>å®ä¾‹å¯¹è±¡ã€‚</p><p>çœ‹ç±»çš„æ„é€ å‡½æ•°ï¼Œåœ¨åˆå§‹åŒ–æ—¶åªè°ƒç”¨<code>register</code>æ–¹æ³•æ¥æ³¨å†Œæ¨¡å—ã€‚</p><p>æŸ¥çœ‹<code>register</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">register(path, rawModule, runtime = <span class="literal">true</span>) &#123;</span><br><span class="line">  <span class="comment">// ! å¼€å‘æ¨¡å¼ä¸‹æ–­è¨€åŸå§‹æ•°æ®ï¼Œåˆ¤æ–­è¾“å…¥çš„æ•°æ®ç±»å‹å’Œæ ¼å¼æ˜¯å¦æœ‰é”™</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assertRawModule(path, rawModule)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> newModule = <span class="keyword">new</span> Module(rawModule, runtime) <span class="comment">// ! åˆ›å»ºä¸€ä¸ªæ¨¡å—</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! path ä¸ºç©ºæ—¶</span></span><br><span class="line">  <span class="keyword">if</span> (path.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.root = newModule <span class="comment">// ! åˆ›å»ºçš„æ¨¡å—ä¸ºæ ¹æ¨¡å—ï¼Œæ³¨æ„ï¼šthis.root æ˜¯è¿™é‡Œç±»å”¯ä¸€çš„å±æ€§å€¼</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> parent = <span class="keyword">this</span>.get(path.slice(<span class="number">0</span>, <span class="number">-1</span>)) <span class="comment">// ! æ ¹æ®è·¯å¾„è·å–åˆ°çˆ¶æ¨¡å—ï¼ˆåœ¨æ•°ç»„é‡Œé¢å®ƒå‰é¢çš„å…ƒç´ ï¼‰</span></span><br><span class="line">    parent.addChild(path[path.length - <span class="number">1</span>], newModule) <span class="comment">// ! æ·»åŠ å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// register nested modules</span></span><br><span class="line">  <span class="comment">// ! ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å—ï¼Œæ³¨å†ŒåµŒå¥—æ¨¡å—</span></span><br><span class="line">  <span class="keyword">if</span> (rawModule.modules) &#123;</span><br><span class="line">    forEachValue(rawModule.modules, (rawChildModule, key) =&gt; &#123;</span><br><span class="line">      <span class="comment">// ! æŠŠ key æ”¾å…¥åˆ° path ä¸­ï¼Œkey === moduleName</span></span><br><span class="line">      <span class="keyword">this</span>.register(path.concat(key), rawChildModule, runtime)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šä½¿ç”¨æ–­è¨€å‡½æ•°æ ¡éªŒç”¨æˆ·è¾“å…¥çš„åŸå§‹é€‰é¡¹æ•°æ®çš„ç±»å‹æˆ–è€…æ ¼å¼æ˜¯å¦æœ‰é”™ã€‚</p><p>ç„¶åå£°æ˜å¸¸é‡<code>newModule</code>ï¼Œå­˜å‚¨é€šè¿‡æ“ä½œç¬¦ new åˆ›å»ºä¸€ä¸ª<code>Module</code>å®ä¾‹å¯¹è±¡çš„ã€‚å…ˆä¸ç®¡ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡æ˜¯æ€ä¹ˆæ ·å­çš„ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><p>å¦‚æœ<code>path</code>æ•°ç»„çš„é•¿åº¦ä¸º 0 æ—¶ï¼Œç”Ÿæˆçš„æ¨¡å—è¢«èµ‹å€¼ç»™<code>this.root</code>ï¼Œå³ç”Ÿæˆæ ¹æ¨¡å—ã€‚æ³¨æ„ï¼š<code>root</code>å±æ€§æ˜¯ç±»<code>ModuleCollection</code> å®ä¾‹å¯¹è±¡çš„å”¯ä¸€ä¸€ä¸ªçš„å±æ€§å€¼ã€‚æˆ‘ä»¬åœ¨åˆå§‹åŒ–æ¨¡å—æ—¶ï¼Œ<code>path</code>æ˜¯ä¸€ä¸ªç©ºæ•°ç»„ï¼Œæ‰€æœ‰å…ˆä¸çœ‹ else ä»£ç å—çš„ä»£ç ï¼Œåé¢å†è§£æã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå¦‚æœæˆ‘ä»¬çš„åŸå§‹æ•°æ®ä¸­è®¾ç½®äº†æ¨¡å—ï¼Œä¼šéå†è¿™äº›æ¨¡å—ï¼Œç„¶åè¿˜æ˜¯é€šè¿‡<code>register</code>æ–¹æ³•æ³¨å†Œè¿™äº›æ¨¡å—ã€‚è¿™é‡Œæ³¨å†Œæ—¶ï¼Œ<code>path</code>å°±ä¸æ˜¯ä¸€ä¸ªç©ºæ•°ç»„äº†ï¼Œè€Œæ˜¯åˆå¹¶äº†<code>key</code>ï¼Œä¹Ÿå°±æ˜¯æ¨¡å—åã€‚è¿™æ—¶ï¼Œä¼šè¿›å…¥ä¸Šé¢çš„ else ä»£ç å—çš„é€»è¾‘ï¼Œé¦–å…ˆéœ€è¦é€šè¿‡<code>get</code>æ–¹æ³•æ ¹æ®ä¼ å…¥<code>path</code>æ•°ç»„ä¸­çš„<code>key</code>ä¹‹å‰çš„å…ƒç´ è·å–çˆ¶çº§æ¨¡å—ï¼Œç„¶åä½¿ç”¨<code>addChild</code>æ–¹æ³•æ·»åŠ æ¨¡å—ï¼Œæ·»åŠ çš„æ¨¡å—åå°±æ˜¯ä¹‹å‰ä¼ å…¥åˆ°<code>path</code>æ•°ç»„çš„<code>key</code>ï¼Œè¿™æ ·å°±å»ºç«‹å¥½äº†çˆ¶å­å…³ç³»ã€‚</p><p>è¿™é‡Œå¯èƒ½æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œè¯·çœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŸå§‹æ•°æ®</span></span><br><span class="line">modules: &#123;</span><br><span class="line">  moduleA: &#123;<span class="comment">/* */</span>&#125;,</span><br><span class="line">  moduleB: &#123;<span class="comment">/* */</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆæ­¥æ”¶é›†æ¨¡å—åçš„ _modules å±æ€§</span></span><br><span class="line">_modules: &#123;</span><br><span class="line">  root: &#123;</span><br><span class="line">    _children: &#123;</span><br><span class="line">      moduleA: &#123;<span class="comment">/* Module instance */</span>&#125;,</span><br><span class="line">      moduleB: &#123;<span class="comment">/* Module instance */</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹å®ƒæ˜¯æ€ä¹ˆè·å–çˆ¶çº§æ¨¡å—çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>(path) &#123;</span><br><span class="line">  <span class="keyword">return</span> path.reduce(<span class="function">(<span class="params"><span class="built_in">module</span>, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.getChild(key)</span><br><span class="line">  &#125;, <span class="keyword">this</span>.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæ¨¡å—å¯¹åº”çš„<code>path</code>æ•°ç»„ä¸­åªæœ‰æ¨¡å—åä¸€ä¸ªå…ƒç´ ï¼Œå–å®ƒä¹‹å‰çš„å…ƒç´ æ„æˆä¸€ä¸ªæ–°çš„<code>path</code>ï¼Œæ­¤æ—¶<code>path</code>å…¶å®æ˜¯ä¸€ä¸ªç©ºæ•°ç»„<code>[]</code>ï¼Œè¿™æ—¶è·å–åˆ°çš„çˆ¶çº§æ¨¡å—å°±æ˜¯æ ¹æ¨¡å—ã€‚æ‰€ä»¥ä¼šæŠŠ<code>moduleA</code>å’Œ<code>moduleB</code>è¿™ä¸¤ä¸ªæ¨¡å—æ·»åŠ åˆ°æ ¹æ¨¡å—çš„<code>_children</code>å±æ€§ä¸­ã€‚</p><h3 id="Moduleæ¨¡å—ç±»-1"><a href="#Moduleæ¨¡å—ç±»-1" class="headerlink" title="Moduleæ¨¡å—ç±»"></a><code>Module</code>æ¨¡å—ç±»</h3><p>æ¨¡å—çš„å®ä¾‹å¯¹è±¡æ˜¯é€šè¿‡<code>Module</code>ç”Ÿæˆçš„ï¼Œå®ƒé‡Œé¢å®šä¹‰äº†ä¸€äº›æ“ä½œæ¨¡å—çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><p>æŸ¥çœ‹<code>Module</code>ç±»çš„ä»£ç ï¼Œåœ¨<code>module/module.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Module</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(rawModule, runtime) &#123;</span><br><span class="line">    <span class="keyword">this</span>.runtime = runtime <span class="comment">// ! å­˜å‚¨ runtime çš„å€¼</span></span><br><span class="line">    <span class="comment">// Store some children item</span></span><br><span class="line">    <span class="keyword">this</span>._children = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="comment">// ! å­˜å‚¨å­æ¨¡å—</span></span><br><span class="line">    <span class="comment">// Store the origin module object which passed by programmer</span></span><br><span class="line">    <span class="keyword">this</span>._rawModule = rawModule <span class="comment">// ! å­˜å‚¨åŸå§‹æ¨¡å—æ•°æ®</span></span><br><span class="line">    <span class="keyword">const</span> rawState = rawModule.state <span class="comment">// ! è·å–æ ¹çš„ state åŸå§‹æ•°æ®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store the origin module's state</span></span><br><span class="line">    <span class="keyword">this</span>.state = (<span class="keyword">typeof</span> rawState === <span class="string">'function'</span> ? rawState() : rawState) || &#123;&#125; <span class="comment">// ! å­˜å‚¨ state</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œå®šä¹‰äº†ä¸€äº›å±æ€§ï¼ŒæŸ¥çœ‹ä¸Šé¢ä»£ç çš„æ³¨é‡Šã€‚æ¯”å¦‚æˆ‘ä»¬åˆšæ‰ç”¨åˆ°çš„<code>_children</code>å±æ€§å°±æ˜¯ç”¨æ¥å­˜å‚¨å­æ¨¡å—çš„ã€‚</p><p>å¦å¤–è¿˜å®šä¹‰äº†ä¸€äº›æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬åˆšæ‰ç”¨åˆ°çš„æ·»åŠ å­æ¨¡å—çš„æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¢åŠ å­æ¨¡å—</span></span><br><span class="line">addChild(key, <span class="built_in">module</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>._children[key] = <span class="built_in">module</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°±æ˜¯æŠŠå­æ¨¡å—æ·»åŠ åˆ°<code>_children</code>å±æ€§ä¸­ï¼Œä»¥é”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨ã€‚</p><p>åˆ°è¿™é‡Œï¼Œæ¨¡å—çš„æ”¶é›†å·¥ä½œå°±å®Œæˆäº†ï¼Œå…¶å®å°±æ˜¯é€šè¿‡ç”¨æˆ·è¾“å…¥çš„åŸå§‹æ¨¡å—æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªæ ¹æ¨¡å—ã€‚è¿™ä¸ªæ ¹æ¨¡å—å¯¹åº”çš„<code>key</code>ï¼Œå°±æ˜¯<code>root</code>ï¼Œå³å¯¹è±¡<code>{ root: root Module}</code>ï¼Œç„¶åæŠŠè¿™ä¸ªå¯¹è±¡æ·»åŠ åˆ°<code>store</code>å®ä¾‹çš„<code>_modules</code>å±æ€§ä¸­ã€‚</p><p>ä¸‹é¢ç»§ç»­çœ‹<code>Store</code>ç±»çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bind commit and dispatch to self</span></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">this</span></span><br><span class="line"><span class="keyword">const</span> &#123; dispatch, commit &#125; = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! ç»‘å®š thisï¼ŒæŒ‡å‘ store å®ä¾‹æœ¬èº«</span></span><br><span class="line"><span class="keyword">this</span>.dispatch = <span class="function"><span class="keyword">function</span> <span class="title">boundDispatch</span>(<span class="params">type, payload</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> dispatch.call(store, type, payload)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.commit = <span class="function"><span class="keyword">function</span> <span class="title">boundCommit</span>(<span class="params">type, payload, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> commit.call(store, type, payload, options)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»‘å®š<code>commit</code>å’Œ<code>dispatch</code>æ–¹æ³•çš„<code>this</code>æŒ‡å‘ï¼Œå®ƒä»¬çš„<code>this</code>éƒ½æŒ‡å‘<code>store</code>å®ä¾‹æœ¬èº«ã€‚</p><p>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆç»‘å®šå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬æŠŠ<code>store</code>å®ä¾‹å¯¹è±¡èµ‹å€¼ç»™ Vue çš„<code>$store</code>å±æ€§ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ä¾‹ç»„ä»¶ä¸­å°±å¯ä»¥åƒä¸‹é¢è¿™æ ·è°ƒç”¨<code>commit</code>å’Œ<code>dispatch</code>æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.$store.commti(<span class="string">'xxx'</span>)</span><br><span class="line"><span class="keyword">this</span>.$store.dispatch(<span class="string">'xxx'</span>)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œå¦‚æœä¸ç»‘å®š<code>this</code>ï¼Œ<code>commit</code>å’Œ<code>diaptch</code>æ–¹æ³•ä¸­çš„<code>this</code>æŒ‡å‘çš„å°±æ˜¯è°ƒç”¨çš„å®ƒä»¬çš„ Vue å®ä¾‹ç»„ä»¶ï¼Œè€Œä¸æ˜¯<code>Store</code>å®ä¾‹å¯¹è±¡ã€‚ä½†æ˜¯ Vue å®ä¾‹ç»„ä»¶ä¸­å¹¶æ²¡æœ‰è¿™ä¸¤ä¸ªæ–¹æ³•çš„ï¼Œè¿™æ ·å°±ä¼šå‡ºé”™ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// strict mode</span></span><br><span class="line"><span class="comment">// ! åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä»»ä½• mutation å¤„ç†å‡½æ•°ä»¥å¤–ä¿®æ”¹ Vuex state éƒ½ä¼šæŠ›å‡ºé”™è¯¯ã€‚</span></span><br><span class="line"><span class="keyword">this</span>.strict = strict</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = <span class="keyword">this</span>._modules.root.state <span class="comment">// ! è·å–æ ¹çš„ state</span></span><br></pre></td></tr></table></figure><p>è®¾ç½®ä¸¥æ ¼æ¨¡å¼å’Œè·å–æ ¹çš„ state æ•°æ®ã€‚ä¸¥æ ¼æ¨¡å¼ä¸€èˆ¬åªåœ¨å¼€å‘ç¯å¢ƒä¸­å¯ç”¨ï¼Œè€Œä¸èƒ½å†ç”Ÿæˆç¯å¢ƒä¸­å¯ç”¨ï¼Œç†ç”±åœ¨åé¢ä¼šè®²ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init root module.</span></span><br><span class="line"><span class="comment">// this also recursively registers all sub-modules</span></span><br><span class="line"><span class="comment">// and collects all module getters inside this._wrappedGetters</span></span><br><span class="line">installModule(<span class="keyword">this</span>, state, [], <span class="keyword">this</span>._modules.root) <span class="comment">// ! â‘¡ å®‰è£… root æ¨¡å— ï¼Œæ¨¡å—åˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>installModule</code>å‡½æ•°å®‰è£…æ¨¡å—ã€‚è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬äºŒä¸ªé‡ç‚¹é˜¶æ®µï¼šæ¨¡å—å®‰è£…ã€‚</p><h2 id="æ¨¡å—å®‰è£…-1"><a href="#æ¨¡å—å®‰è£…-1" class="headerlink" title="æ¨¡å—å®‰è£…"></a>æ¨¡å—å®‰è£…</h2><p>å®‰è£…æ¨¡å—ï¼Œè¯´ç™½äº†å°±æ˜¯åˆå§‹åŒ–<code>store</code>å®ä¾‹çš„ä¸€äº›å±æ€§ï¼Œåœ¨å‰é¢æ¨¡å—æ”¶é›†æ—¶åªæ˜¯åˆæ­¥å¤„ç†äº†åŸå§‹æ•°æ®ï¼Œè¿™é‡Œä¼šæ›´è¿›ä¸€æ­¥å¤„ç†åŸå§‹æ•°æ®ï¼ŒæŠŠå¤„ç†åçš„æ•°æ®æ”¾åˆ°ä¸€å¼€å§‹å®šä¹‰çš„å±æ€§ä¸­ï¼Œæ¯”å¦‚<code>_actions</code> ã€<code>_mutations</code>ç­‰å±æ€§ä¸­ã€‚</p><p>æŸ¥çœ‹<code>installModule</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">installModule</span>(<span class="params">store, rootState, path, module, hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isRoot = !path.length <span class="comment">// ! åˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ¨¡å—</span></span><br><span class="line">  <span class="keyword">const</span> namespace = store._modules.getNamespace(path) <span class="comment">// ! è·å–å‘½åç©ºé—´æ¨¡å—çš„åç§° 'moduleName/'</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‡½æ•°ä½“å‰é¢çš„ä»£ç ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯æ ¹æ¨¡å—ï¼Œå½“<code>path</code>æ˜¯ä¸€ä¸ªç©ºæ•°ç»„æ—¶ï¼Œä¼ å…¥çš„æ¨¡å—<code>module</code>å°±æ˜¯æ ¹æ¨¡å—ã€‚</p><p>ç„¶åè·å–æœ‰å‘½åç©ºé—´æ¨¡å—çš„åç§°ï¼Œæ˜¯é€šè¿‡<code>ModuleCollection</code>å®ä¾‹å¯¹è±¡çš„<code>getNamespace</code>æ–¹æ³•è·å–çš„ï¼Œçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–å‘½åç©ºé—´æ¨¡å—çš„åç§°</span></span><br><span class="line">getNamespace(path) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="built_in">module</span> = <span class="keyword">this</span>.root <span class="comment">// ! è·å–æ ¹æ¨¡å—</span></span><br><span class="line">  <span class="keyword">return</span> path.reduce(<span class="function">(<span class="params">namespace, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">module</span> = <span class="built_in">module</span>.getChild(key) <span class="comment">// ! è·å–å­æ¨¡å—</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! å­æ¨¡å— key è®¾ç½®äº†å‘½åç©ºé—´ï¼Œè·å– keyï¼Œå¹¶ä¸”æ‹¼æ¥ '/'</span></span><br><span class="line">    <span class="comment">// ! ç¬¬ä¸€è½®å¾ªç¯ï¼špath = [ moduleName ]ï¼Œnamespace = ''ï¼Œkey = moduleName =&gt;  'moduleName/'</span></span><br><span class="line">    <span class="keyword">return</span> namespace + (<span class="built_in">module</span>.namespaced ? key + <span class="string">'/'</span> : <span class="string">''</span>)</span><br><span class="line">  &#125;, <span class="string">''</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡<code>path</code>è·å–æœ‰å‘½åç©ºé—´çš„æ¨¡å—çš„åç§°ã€‚å› ä¸º<code>Module</code>çš„å®ä¾‹å¯¹è±¡ä¸­æ˜¯é€šè¿‡<code>_children</code>å±æ€§å­˜å‚¨å­æ¨¡å—çš„ï¼Œå®ƒçš„å­˜å‚¨æ–¹å¼æ˜¯é”®å€¼å¯¹ç»“æ„ï¼Œå…¶ä¸­çš„é”®åå°±æ˜¯æ¨¡å—åï¼Œç„¶åæ¨¡å—ååœ¨æ¨¡å—æ”¶é›†æ—¶ï¼Œå·²ç»é€šè¿‡è°ƒç”¨æ³¨å†Œæ–¹æ³•<code>register</code>æŠŠå®ƒæ”¾å…¥åˆ°<code>path</code>æ•°ç»„ä¸­ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ä¸æ–­çš„éå†ï¼Œä½¿ç”¨<code>getChild</code>æ–¹æ³•è·å–å­æ¨¡å—ï¼Œç„¶ååœ¨æœ€åè¿”å›å®ƒçš„æ¨¡å—åã€‚å¦å¤–è¿˜éœ€è¦åœ¨æ¨¡å—ååé¢æ‹¼æ¥<code>/</code>ç¬¦å·ï¼Œæ˜¯ä¸ºäº†åœ¨åé¢æ›´å¥½çš„æ‹¼æ¥æ¨¡å—å†…çš„ç±»å‹åã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// register in namespace map</span></span><br><span class="line"><span class="comment">// ! å¦‚æœè®¾ç½®äº†å‘½åç©ºé—´ï¼Œå³ namespaced = true</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">module</span>.namespaced) &#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    store._modulesNamespaceMap[namespace] &amp;&amp;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(</span><br><span class="line">      <span class="string">`[vuex] duplicate namespace <span class="subst">$&#123;namespace&#125;</span> for the namespaced module <span class="subst">$&#123;path.join(</span></span></span><br><span class="line"><span class="string"><span class="subst">        <span class="string">'/'</span></span></span></span><br><span class="line"><span class="string"><span class="subst">      )&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  store._modulesNamespaceMap[namespace] = <span class="built_in">module</span> <span class="comment">// ! èµ‹å€¼åˆ°å‘½åæ˜ å°„è¡¨ä¸­</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†æ¨¡å—åå’Œæ¨¡å—ï¼Œå°±æŠŠå®ƒä»¬èµ‹å€¼åˆ°<code>_modulesNamespaceMap</code>å±æ€§ä¸­ï¼Œæ–¹é¢åé¢ä½¿ç”¨ã€‚åœ¨æ³¨å†Œä¹‹å‰è¿˜éœ€è¦åˆ¤æ–­<code>_modulesNamespaceMap</code>æ˜ å°„è¡¨ä¸­æ˜¯å¦å·²ç»å­˜å‚¨è¿™ä¸ªæ¨¡å—ï¼Œå¦‚æœå­˜åœ¨ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºä½ æ¨¡å—é‡å¤ï¼Œè¿™æ—¶å€™éœ€è¦æ£€æµ‹ä¸‹æ˜¯å¦ç¼–å†™äº†ç›¸åŒçš„æ¨¡å—ã€‚</p><p>æˆåŠŸèµ‹å€¼åï¼Œ<code>_modulesNamespaceMap</code>æ˜ å°„è¡¨å±æ€§çš„ç¤ºä¾‹ä»£ç å°±ä¼šåƒä¸‹é¢è¿™æ ·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  moduleA/: &#123;<span class="comment">/* Module instance */</span>&#125;,</span><br><span class="line">  moduleB/: &#123;<span class="comment">/* Module instance */</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set state</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot &amp;&amp; !hot) &#123;</span><br><span class="line">  <span class="keyword">const</span> parentState = getNestedState(rootState, path.slice(<span class="number">0</span>, <span class="number">-1</span>)) <span class="comment">// ! è·å–çˆ¶çº§çš„ state</span></span><br><span class="line">  <span class="keyword">const</span> moduleName = path[path.length - <span class="number">1</span>] <span class="comment">// ! è·å–æ¨¡å—å</span></span><br><span class="line">  store._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    Vue.set(parentState, moduleName, <span class="built_in">module</span>.state) <span class="comment">// ! è®¾ç½®å­æ¨¡å—ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ï¼Œå¹¶ä¸”ä¸ºå“åº”æ€§æ•°æ®</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯è®¾ç½®<code>state</code>æ•°æ®ï¼ŒæŠŠæ‰€æœ‰æ¨¡å—ä¸‹é¢çš„<code>state</code>æ•°æ®ç»Ÿä¸€æ”¾å…¥åˆ° root çš„<code>state</code>å±æ€§ä¸­ã€‚</p><p>è¿™é‡Œé€šè¿‡<code>getNestedState</code>å‡½æ•°æ¥è·å–æ¨¡å—ä¸‹é¢çš„<code>state</code>ï¼Œé€šè¿‡<code>path</code>æ•°ç»„æ¥æŸ¥æ‰¾</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNestedState</span>(<span class="params">state, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> path.length ? path.reduce(<span class="function">(<span class="params">state, key</span>) =&gt;</span> state[key], state) : state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æ ¹çš„<code>state</code>æ•°æ®å’Œæ¨¡å—çš„<code>state</code>çš„ç»“æ„ä¹‹å‰æ˜¯è¿™æ ·çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleA</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleB</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠæ‰€æœ‰æ¨¡å—çš„<code>state</code>æ•°æ®æ”¾åˆ° root çš„<code>state</code>ä¸­å°±å˜æˆä¸‹é¢è¿™æ ·å­ã€‚åé¢è¿˜ä¼šæŠŠ<code>state</code>æ•°æ®æ”¾å…¥åˆ° Vue ç»„ä»¶çš„<code>data</code>å±æ€§ä¸‹é¢ï¼Œå˜æˆå“åº”å¼æ•°æ®ï¼Œè¿™é‡Œå…ˆä¹°ä¸ªå…³å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root state</span></span><br><span class="line">state: &#123;</span><br><span class="line">  count: <span class="number">0</span></span><br><span class="line">  moduleA: &#123;</span><br><span class="line">    count: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  moduleB: &#123;</span><br><span class="line">    count: <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ„é€ äº†ä¸€ä¸ªæœ¬åœ°ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆæ¨¡å—å†…éƒ¨ï¼‰</span></span><br><span class="line"><span class="comment">// ! local ä¸­çš„ commit dispatch state getter çš„æ•ˆæœä¼šä¸ä¸€æ ·</span></span><br><span class="line"><span class="keyword">const</span> local = (<span class="built_in">module</span>.context = makeLocalContext(store, namespace, path))</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨<code>makeLocalContext</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ¨¡å—ä¸Šä¸‹æ–‡ç¯å¢ƒï¼ˆ<code>module.context</code>å±æ€§ï¼‰ï¼Œé‡å†™<code>local</code>ä¸‹é¢çš„ä¸€äº›å±æ€§ã€‚</p><h3 id="makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡-1"><a href="#makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡-1" class="headerlink" title="makeLocalContextåˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡"></a><code>makeLocalContext</code>åˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡</h3><p>æŸ¥çœ‹<code>makeLocalContext</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeLocalContext</span>(<span class="params">store, namespace, path</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> noNamespace = namespace === <span class="string">''</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! åˆ›å»º local å±æ€§</span></span><br><span class="line">  <span class="comment">// ! é‡å†™æœ‰å‘½åç©ºé—´çš„æ¨¡å—é‡Œé¢çš„ dispatch commit æ–¹æ³•å’Œ getters state å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> local = &#123;</span><br><span class="line">    dispatch: noNamespace</span><br><span class="line">      ? store.dispatch <span class="comment">// ! æ²¡æœ‰å‘½åç©ºé—´ï¼Œç›´æ¥ä½¿ç”¨æ ¹çš„ dispatch --&gt; dispatch(actionName, payload)</span></span><br><span class="line">      : <span class="comment">// ... çœç•¥é‡å†™çš„æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">    commit: noNamespace</span><br><span class="line">      ? store.commit</span><br><span class="line">      : <span class="comment">// ... çœç•¥é‡å†™çš„æ–¹æ³•</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// getters and state object must be gotten lazily</span></span><br><span class="line">  <span class="comment">// because they will be changed by vm update</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">    getters: &#123;</span><br><span class="line">      <span class="keyword">get</span>: noNamespace</span><br><span class="line">        ? () =&gt; store.getters</span><br><span class="line">        : () =&gt; makeLocalGetters(store, namespace) // ! ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç†æ¨¡å—é‡Œé¢çš„ getters</span><br><span class="line">    &#125;,</span><br><span class="line">    state: &#123;</span><br><span class="line">      <span class="keyword">get</span>: () =&gt; getNestedState(store.state, path) // ! é€šè¿‡è·¯å¾„è·å–åµŒå¥—çš„ state</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  return local</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå£°æ˜å¸¸é‡<code>noNamespace</code>è¡¨ç¤ºæ˜¯å¦å­˜åœ¨å‘½åç©ºé—´çš„æ¨¡å—ï¼Œå®ƒçš„å€¼æ˜¯<code>true</code>æ—¶è¡¨ç¤ºæ²¡æœ‰ï¼Œå³<code>namespace</code>ä¸ºç©ºå­—ç¬¦ä¸²ã€‚</p><p>ç„¶åå®šä¹‰äº†ä¸€ä¸ª<code>local</code>å¸¸é‡ï¼Œé‡Œé¢é‡å†™äº†åœ¨æœ‰å‘½åç©ºé—´ä¸­çš„æ¨¡å—é‡Œé¢çš„<code>dispatch</code>ã€<code>commit</code>ã€<code>getters</code>ã€<code>state</code>çš„é€»è¾‘ï¼Œæœ€åè¿”å›<code>local</code>è¿™ä¸ªå¸¸é‡ã€‚</p><p>å…ˆçœ‹ä¸‹é‡å†™çš„<code>dispatch</code>å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">dispatch: noNamespace</span><br><span class="line">  ? store.dispatch <span class="comment">// ! æ²¡æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œç›´æ¥ä½¿ç”¨æ ¹çš„ dispatch --&gt; dispatch(actionName, payload)</span></span><br><span class="line">: <span class="comment">// ! æœ‰å‘½åç©ºé—´ï¼Œæäº¤çš„ç±»å‹ type ä¸ä¸€æ ·</span></span><br><span class="line">  (_type, _payload, _options) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> args = unifyObjectStyle(_type, _payload, _options)</span><br><span class="line">    <span class="keyword">const</span> &#123; payload, options &#125; = args</span><br><span class="line">    <span class="keyword">let</span> &#123; type &#125; = args</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! options: &#123; root: true &#125; -&gt; ä¹Ÿä¸ä¼šæ‹¼æ¥å‘½åç©ºé—´</span></span><br><span class="line">    <span class="keyword">if</span> (!options || !options.root) &#123;</span><br><span class="line">      type = namespace + type <span class="comment">// ! æ‹¼æ¥ type =&gt; 'moduleName/actionName'</span></span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        !store._actions[type]</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(</span><br><span class="line">          <span class="string">`[vuex] unknown local action type: <span class="subst">$&#123;args.type&#125;</span>, global type: <span class="subst">$&#123;type&#125;</span>`</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// ! ä¼ å…¥æ–°çš„ type ä¸ºå‚æ•° --&gt; dispatch(moduleName/actionName, payload)</span></span><br><span class="line">   <span class="keyword">return</span> store.dispatch(type, payload)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯åˆ¤æ–­<code>noNamespace</code>çš„å€¼ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´çš„æ¨¡å—ï¼Œå°±ç›´æ¥è°ƒç”¨<code>store.diaptch</code>ï¼Œå®ƒçš„å‚æ•°ä¸­çš„<code>type</code>ä¸å˜ï¼Œå°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch(actionName, payload) <span class="comment">// ! è¿™é‡Œçš„ actionName æ˜¯ root ä¸‹é¢çš„</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰å‘½åç©ºé—´çš„æ¨¡å—æˆ–è€…æ²¡æœ‰è®¾ç½®ç¬¬ä¸‰ä¸ªé€‰é¡¹å‚æ•°<code>{root: true}</code>ï¼Œä¼šæ‹¼æ¥<code>type</code>ï¼Œä½¿å¾—<code>type</code>å˜æˆ<code>moduleName/actionName</code>ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ¨¡å—ä¸­æäº¤<code>action</code>æ—¶ï¼Œæäº¤çš„<code>actionName</code>ä¼šå˜æˆ<code>moduleName/actionName</code>ï¼Œè¿™æ ·å°±å’Œ root ä¸­çš„<code>actionName</code>å¾ˆå¥½çš„åŒºåˆ†å¼€æ¥ï¼Œè°ƒç”¨çš„æ—¶å€™å°±æ˜¯è°ƒç”¨<code>moduleName/actionName</code>å‡½æ•°ï¼Œè€Œä¸æ˜¯<code>actionName</code>å‡½æ•°ã€‚</p><p>é‡å†™çš„<code>commit</code>æ–¹æ³•å’Œ<code>dispatch</code>é€»è¾‘ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹é‡å†™<code>getters</code>å’Œ<code>state</code>ä»£ç ï¼Œå®ƒä»¬æœ‰ç‚¹ä¸ä¸€æ ·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperties(local, &#123;</span><br><span class="line">  getters: &#123;</span><br><span class="line">    <span class="keyword">get</span>: noNamespace</span><br><span class="line">      ? () =&gt; store.getters</span><br><span class="line">      : () =&gt; makeLocalGetters(store, namespace) // ! ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡æ¥ä»£ç†æ¨¡å—é‡Œé¢çš„ getters</span><br><span class="line">  &#125;,</span><br><span class="line">  state: &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; getNestedState(store.state, path) // ! é€šè¿‡è·¯å¾„è·å–åµŒå¥—çš„ state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹<code>getters</code>ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯<code>store.getters</code>ï¼Œå¦åˆ™å‡½æ•°è¿”å›å€¼æ˜¯<code>_makeLocalGettersCache</code>å±æ€§ä¸­å¯¹åº”çš„å€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªä»£ç†å¯¹è±¡æ˜¯é€šè¿‡<code>makeLocalGetters</code>å‡½æ•°ç”Ÿæˆçš„ã€‚</p><p>çœ‹ä¸‹<code>makeLocalGetters</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeLocalGetters</span>(<span class="params">store, namespace</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! æ·»åŠ æ¨¡å—çš„ getters åˆ° _makeLocalGettersCache ä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (!store._makeLocalGettersCache[namespace]) &#123;</span><br><span class="line">    <span class="keyword">const</span> gettersProxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">const</span> splitPos = namespace.length <span class="comment">// ! åˆ†å‰²ç‚¹ï¼šnamespace çš„é•¿åº¦</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(store.getters).forEach(<span class="function"><span class="params">type</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// skip if the target getter is not match this namespace</span></span><br><span class="line">      <span class="keyword">if</span> (type.slice(<span class="number">0</span>, splitPos) !== namespace) <span class="keyword">return</span> <span class="comment">// ! å‘½åç©ºé—´å’Œ type çš„æ¨¡å—åä¸ä¸€è‡´æ—¶ç›´æ¥è¿”å›ï¼Œå³æ²¡æœ‰åŒ¹é…æˆåŠŸ</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// extract local getter type</span></span><br><span class="line">      <span class="keyword">const</span> localType = type.slice(splitPos) <span class="comment">// ! æˆªå– type åç§°ï¼šmoduleName/getterName --&gt; getterName</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Add a port to the getters proxy.</span></span><br><span class="line">      <span class="comment">// Define as getter property because</span></span><br><span class="line">      <span class="comment">// we do not want to evaluate the getters in this time.</span></span><br><span class="line">      <span class="comment">// ! ä»£ç† gettersProxyï¼ŒgettersProxy.localType === store.getters[type]</span></span><br><span class="line">      <span class="built_in">Object</span>.defineProperty(gettersProxy, localType, &#123;</span><br><span class="line">        <span class="keyword">get</span>: () =&gt; store.getters[type],</span><br><span class="line">        enumerable: true</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    store._makeLocalGettersCache[namespace] = gettersProxy</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return store._makeLocalGettersCache[namespace]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆéœ€è¦åˆ¤æ–­<code>_makeLocalGettersCache</code>å±æ€§ä¸­æ˜¯å¦æœ‰æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰éœ€è¦æŠŠæ¨¡å—çš„<code>getters</code>æ·»åŠ è¿›å»ã€‚</p><p>å£°æ˜å¸¸é‡<code>gettersProxy</code>ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç”¨æ¥ä»£ç†æ¨¡å—çš„<code>getters</code>ï¼Œæœ€åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</p><p>å£°æ˜å¸¸é‡<code>splitPos</code>å­˜å‚¨<code>namespace</code>çš„é•¿åº¦å€¼ã€‚</p><p>ç„¶åéå†<code>store.getters</code>çš„<code>keys</code>ï¼Œå½“å‘½åç©ºé—´çš„å€¼å’Œ<code>type</code>çš„æ¨¡å—åä¸ä¸€æ ·æ—¶ç›´æ¥è¿”å›ï¼Œå³æ²¡æœ‰åŒ¹é…åˆ°ç›¸åº”çš„æ¨¡å—ã€‚</p><p>å¦‚æœåŒ¹é…æˆåŠŸï¼Œå£°æ˜å¸¸é‡<code>localType</code>æˆªå– type çš„åç§°ï¼Œå³åŸæ¥æ˜¯<code>moduleName/getterName</code>çš„åç§°ç°åœ¨å˜æˆ<code>getterName</code>ã€‚ç„¶åä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰<code>gettersProxy</code>å¯¹è±¡çš„<code>localType</code>å±æ€§ï¼Œä½†æ˜¯å®ƒçš„<code>getter</code>è¿”å›çš„ç¡®å®<code>store.getters</code>ä¸­çš„<code>type</code>çš„å€¼ã€‚</p><p>è¿™é‡Œè¯·æ³¨æ„ä¸‹ï¼Œåœ¨<code>store.getters</code>ä¸­çš„<code>type</code>é”®åæ˜¯å¸¦æ¨¡å—åå‰ç¼€çš„ï¼Œè€Œ<code>localType</code>é”®åæ˜¯ä¸å¸¦æ¨¡å—åå‰ç¼€çš„ã€‚</p><p>è¿™é‡Œä¹Ÿæœ‰ç‚¹ç»•ï¼Œå…¶å®å°±æ˜¯åœ¨æ¨¡å—é‡Œé¢è®¿é—®<code>getter</code>å±æ€§æ˜¯ä¸éœ€è¦å¸¦æ¨¡å—åå‰ç¼€çš„ï¼Œç›´æ¥è®¿é—®ã€‚ä½†æ˜¯æˆ‘ä»¬åœ¨è¾“å‡ºå®ƒçš„å€¼æ—¶ä»<code>store.getters</code>å±æ€§ä¸­è·å–çš„ï¼Œè¿™é‡Œå±æ€§æ˜¯å¸¦æœ‰æ¨¡å—åå‰ç¼€çš„ï¼Œä¸ç„¶è¾“å‡ºçš„å°±ä¸æ˜¯æ¨¡å—çš„<code>getter</code>ï¼Œè€Œæ˜¯ root çš„<code>getter</code>ã€‚æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“<code>store.getters</code>å±æ€§çš„ç»“æ„ï¼Œåé¢çŸ¥é“åå°±ä¼šæ¯”è¾ƒæ¸…æ¥šäº†ã€‚</p><p>æœ€åçœ‹ä¸‹<code>state</code>ï¼Œå®ƒæ˜¯ç›´æ¥é€šè¿‡<code>getNestedState</code>æ¥è·å–<code>state</code>çš„å€¼ï¼Œä¸ç®¡æ˜¯ root çš„<code>state</code>å€¼è¿˜æ˜¯åœ¨æ¨¡å—çš„<code>state</code>å€¼ã€‚å› ä¸ºåœ¨å®šä¹‰æ¨¡å—ä¸Šä¸‹æ–‡ä¹‹å‰ï¼Œæˆ‘ä»¬å·²ç»æŠŠæ‰€æœ‰æ¨¡å—çš„<code>state</code>å·²ç»è¢«æ”¾åœ¨ root çš„<code>state</code>ä¸­ï¼Œæ‰€ä»¥é€šè¿‡<code>getNestedState</code>å‡½æ•°å¯ä»¥å¾ˆå¥½è·å–å®ƒä»¬çš„å€¼ã€‚</p><p>åˆ›å»ºå¥½ä¸Šä¸‹æ–‡å¯¹è±¡<code>local</code>ä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>installModule</code>å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å’Œæ³¨å†Œæ¨¡å—ï¼Œä¸‹åŒ</span></span><br><span class="line"><span class="built_in">module</span>.forEachMutation(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/mutationName'</span></span><br><span class="line">  registerMutation(store, namespacedType, mutation, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.forEachAction(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> type = action.root ? key : namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/actionName'</span></span><br><span class="line">  <span class="keyword">const</span> handler = action.handler || action <span class="comment">// ! è·å– action å‡½æ•°</span></span><br><span class="line">  registerAction(store, type, handler, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.forEachGetter(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/getterName'</span></span><br><span class="line">  registerGetter(store, namespacedType, getter, local)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! é€’å½’æ³¨å†Œå­æ¨¡å—</span></span><br><span class="line"><span class="built_in">module</span>.forEachChild(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot) <span class="comment">// ! path è¿æ¥ key(æ¨¡å—å)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>éå†æ¨¡å—ä¸­çš„å­˜å‚¨çš„åŸå§‹æ•°æ®ï¼Œç„¶åæ³¨å†Œè¿™äº›åŸå§‹æ•°æ®ã€‚è¿™é‡Œåˆ†åˆ«æ³¨å†Œäº†<code>mutation</code>ã€<code>action</code>ã€<code>getter</code>å’Œå­æ¨¡å—ã€‚</p><p>åœ¨<code>Module</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“åŸå§‹çš„æ•°æ®<code>rawModule</code>æ˜¯å­˜å‚¨åœ¨<code>_rawModule</code>å±æ€§ä¸­çš„ã€‚</p><p>å…ˆçœ‹ä¸‹å¦‚ä½•éå†<code>mutaions</code>çš„å€¼ï¼ŒæŸ¥çœ‹<code>forEachMutation</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>module/module.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å¹¶å¤„ç† mutations</span></span><br><span class="line">forEachMutation(fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._rawModule.mutations) &#123;</span><br><span class="line">    forEachValue(<span class="keyword">this</span>._rawModule.mutations, fn)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨çœ‹ä¸‹å·¥å…·å‡½æ•°<code>forEachValue</code>çš„ä»£ç ï¼Œåœ¨<code>util.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * forEach for object</span></span><br><span class="line"><span class="comment"> * ! ä½¿ç”¨å‡½æ•°å¤„ç†å¯¹è±¡çš„æ‰€æœ‰ value å’Œ key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">forEachValue</span>(<span class="params">obj, fn</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> fn(obj[key], key))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éå†ä¼ å…¥çš„å¯¹è±¡<code>obj</code>çš„<code>keys</code>ï¼Œç„¶ååœ¨è°ƒç”¨ä¼ å…¥çš„å‡½æ•°<code>fn</code>å¤„ç†å¯¹è±¡çš„<code>value</code>å’Œ<code>key</code>ã€‚</p><p><code>forEachMutation</code>å‡½æ•°å°±æ˜¯éå†ä¼ å…¥çš„<code>mutions</code>å¯¹è±¡ï¼Œç„¶åå¤„ç†å¯¹è±¡é‡Œé¢çš„<code>value</code>å’Œ<code>key</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.forEachMutation(<span class="function">(<span class="params">mutation, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/mutationName'</span></span><br><span class="line">  registerMutation(store, namespacedType, mutation, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä½“ä¸­å…ˆå£°æ˜å¸¸é‡<code>namespacedType</code>å­˜å‚¨æ‹¼æ¥<code>namespace</code>å’Œ<code>key</code>åçš„å€¼ï¼Œç„¶åè°ƒç”¨å‡½æ•°<code>registerMutation</code>æ³¨å†Œ<code>mutation</code>ã€‚</p><p>çœ‹ä¸‹<code>registerMutation</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒæ˜¯å¦‚ä½•æ³¨å†Œ<code>mutation</code>çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerMutation</span>(<span class="params">store, type, handler, local</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! &#123; 'moduleName/mutationName': entry &#125;</span></span><br><span class="line">  <span class="keyword">const</span> entry = store._mutations[type] || (store._mutations[type] = [])</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! _mutations = &#123; 'moduleName/mutationName': [wrappedMutationHandler] &#125;</span></span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedMutationHandler</span>(<span class="params">payload</span>) </span>&#123;</span><br><span class="line">    handler.call(store, local.state, payload) <span class="comment">// ! mutationFn(local.state, payload) -&gt; ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¨¡å—çš„ state</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å°±æ˜¯æŠŠåŸå§‹çš„<code>mutaions</code>æ”¾å…¥åˆ°<code>store</code>å®ä¾‹å±æ€§çš„<code>_mutations</code>ä¸­ã€‚æ³¨æ„è¿™é‡Œå°±ç”¨åˆ°äº†æ¨¡å—ä¸Šä¸‹æ–‡<code>local</code>ï¼Œåœ¨ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ä¼ å…¥çš„æ˜¯<code>local.state</code>ï¼Œå³æ¨¡å—çš„<code>state</code>ï¼Œè¿™é‡Œçš„<code>state</code>å°±æ˜¯é€šè¿‡<code>getNestedState</code>å‡½æ•°è·å–çš„ï¼Œä¸ç®¡æ˜¯ root çš„<code>state</code>ï¼Œè¿˜æ˜¯æ¨¡å—çš„<code>state</code>ï¼Œéƒ½èƒ½æ­£ç¡®è·å–åˆ°å€¼ã€‚</p><p>å…¶å®åœ¨åˆ›å»ºæ¨¡å—ä¸Šä¸‹æ–‡çš„å‡½æ•°ä¸­ï¼Œä¼šå…ˆåˆ¤æ–­æ˜¯å¦æœ‰å‘½åç©ºé—´æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ä¹Ÿä¼šå…¼å®¹æ²¡æœ‰å‘½åç©ºé—´æ¨¡å—çš„å¤„ç†ã€‚æ‰€ä»¥çœ‹åˆ°ä½¿ç”¨äº†<code>local</code>çš„å±æ€§æ—¶ï¼Œä¸è¦æ…Œï¼Œä»–å·²ç»åšäº†å…¼å®¹å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰å‘½åç©ºé—´çš„æ¨¡å—çš„è¯ï¼Œä¼šæŒ‰ç…§ root çš„å€¼å»å¤„ç†ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>actions</code>çš„éå†å’Œæ³¨å†Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ mutationsï¼ŒæŠŠ mutation æ”¾å…¥åˆ° _mutations ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="built_in">module</span>.forEachAction(<span class="function">(<span class="params">action, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> type = action.root ? key : namespace + key <span class="comment">// ! æ‹¼æ¥ type -&gt; 'moduleName/actionName'</span></span><br><span class="line">  <span class="keyword">const</span> handler = action.handler || action <span class="comment">// ! è·å– action å‡½æ•°</span></span><br><span class="line">  registerAction(store, type, handler, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å’Œ<code>mutaion</code>çš„é€»è¾‘å·®ä¸å¤šï¼Œä¸è¿‡ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡º<code>action</code>æ›´åŠ çµæ´»ï¼Œå³å¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚æœå®ƒæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¼šæŠŠå‡½æ•°æ”¾åœ¨å¯¹è±¡çš„<code>handler</code>å±æ€§ä¸­ã€‚</p><p>çœ‹ä¸‹<code>registerAction</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ actionsï¼ŒæŠŠ action æ”¾å…¥åˆ° _actions ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerAction</span>(<span class="params">store, type, handler, local</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> entry = store._actions[type] || (store._actions[type] = [])</span><br><span class="line">  entry.push(<span class="function"><span class="keyword">function</span> <span class="title">wrappedActionHandler</span>(<span class="params">payload, cb</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> res = handler.call(</span><br><span class="line">      store,</span><br><span class="line">      <span class="comment">// ! ç¬¬ä¸€ä¸ªå‚æ•°æœ‰å¾ˆå¤šé€‰é¡¹ï¼Œæ³¨æ„åŒºåˆ†æ˜¯æ¨¡å— local çš„å±æ€§è¿˜æ˜¯æ ¹ store çš„å±æ€§</span></span><br><span class="line">      &#123;</span><br><span class="line">        dispatch: local.dispatch,</span><br><span class="line">        commit: local.commit,</span><br><span class="line">        getters: local.getters,</span><br><span class="line">        state: local.state,</span><br><span class="line">        rootGetters: store.getters,</span><br><span class="line">        rootState: store.state</span><br><span class="line">      &#125;,</span><br><span class="line">      payload,</span><br><span class="line">      cb</span><br><span class="line">    ) <span class="comment">// ! actionFn(&#123; commit... rootState &#125;, payload, cb)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! åˆ¤æ–­è¿”å›å€¼æ˜¯å¦æ˜¯ Promiseï¼Œä¸æ˜¯å°±è°ƒç”¨ Promise.resolve() è½¬æ¢æˆ Promise</span></span><br><span class="line">    <span class="keyword">if</span> (!isPromise(res)) &#123;</span><br><span class="line">      res = <span class="built_in">Promise</span>.resolve(res)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (store._devtoolHook) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        store._devtoolHook.emit(<span class="string">'vuex:error'</span>, err)</span><br><span class="line">        <span class="keyword">throw</span> err</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘ä¹Ÿå’Œ<code>mutaion</code>çš„ç»„æˆå·®ä¸å¤šï¼Œåªæ˜¯<code>action</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æœ‰éå¸¸å¤šçš„é€‰é¡¹ã€‚æœ‰å››ä¸ªæ¨¡å—çš„å±æ€§å’Œä¸¤ä¸ª root çš„å±æ€§ã€‚</p><p>å¦å¤–ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“<code>action</code>å‡½æ•°æ˜¯å¯ä»¥è¿›è¡Œå¼‚æ­¥æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™é‡Œä¼šåˆ¤æ–­å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ª Promise å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œä¼šä½¿ç”¨<code>Promise.resolve()</code>æ–¹æ³•æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ª Promise å¯¹è±¡ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>getters</code>çš„éå†å’Œæ³¨å†Œï¼Œé€»è¾‘å’Œå‰é¢çš„ä¸€æ ·ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°äº†ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.forEachGetter(<span class="function">(<span class="params">getter, key</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> namespacedType = namespace + key <span class="comment">// ! æ‹¼æ¥ type --&gt; 'moduleName/getterName'</span></span><br><span class="line">  registerGetter(store, namespacedType, getter, local)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹<code>registerGetter</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ³¨å†Œ gettersï¼ŒæŠŠ getter æ”¾å…¥åˆ° _wrappedGetters ä¸­ï¼Œå¹¶é‡å†™é‡Œé¢çš„å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerGetter</span>(<span class="params">store, type, rawGetter, local</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! å·²ç»åœ¨é‡Œé¢äº†ï¼Œå°±ä¸è¦æ³¨å†Œäº†</span></span><br><span class="line">  <span class="keyword">if</span> (store._wrappedGetters[type]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(<span class="string">`[vuex] duplicate getter key: <span class="subst">$&#123;type&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! ä½¿ç”¨åŸå§‹å‡½æ•°</span></span><br><span class="line">  store._wrappedGetters[type] = <span class="function"><span class="keyword">function</span> <span class="title">wrappedGetter</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rawGetter(</span><br><span class="line">      <span class="comment">// ! ä¼ å…¥å¤šä¸ªå‚æ•°</span></span><br><span class="line">      local.state, <span class="comment">// local state</span></span><br><span class="line">      local.getters, <span class="comment">// local getters</span></span><br><span class="line">      store.state, <span class="comment">// root state</span></span><br><span class="line">      store.getters <span class="comment">// root getters</span></span><br><span class="line">    ) <span class="comment">// ! getterFn(state, getter, rootState, rootGetter)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­ä¸‹<code>_wrappedGetters</code>æ˜¯å¦å·²ç»å­˜åœ¨<code>getterName</code>ï¼Œå¦‚æœå­˜åœ¨ï¼Œå³å®ƒä»¬çš„<code>key</code>å€¼ç›¸åŒï¼Œè¿™æ—¶åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚è¿™è¯´æ˜å¯èƒ½åˆ›å»ºäº†ä¸¤ä¸ªä¸€æ ·çš„æ¨¡å—ï¼Œéœ€è¦åˆ é™¤å…¶ä¸­çš„ä¸€ä¸ªæ¨¡å—ã€‚</p><p>æ³¨æ„è¿™é‡Œçš„æ˜¯<code>_wrappedGetters</code>å±æ€§ï¼Œè€Œä¸æ˜¯<code>getters</code>å±æ€§ï¼Œ<code>_wrappedGetters</code>é‡Œé¢çš„å‡½æ•°åŒ…è£…äº†åŸå§‹çš„<code>rawGetter</code>ï¼Œç„¶åæŠŠåŒ…è£…åçš„<code>wrappedGetter</code>å‡½æ•°ç»„æˆçš„å¯¹è±¡èµ‹å€¼ç»™<code>_wrappedGetters</code>å±æ€§ã€‚</p><p>çœ‹ä¸‹<code>installModule</code>å‡½æ•°çš„æœ€åä»£ç ï¼Œé€’å½’æ³¨å†Œå­æ¨¡å—</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! é€’å½’æ³¨å†Œå­æ¨¡å—</span></span><br><span class="line"><span class="built_in">module</span>.forEachChild(<span class="function">(<span class="params">child, key</span>) =&gt;</span> &#123;</span><br><span class="line">  installModule(store, rootState, path.concat(key), child, hot) <span class="comment">// ! path è¿æ¥ key(æ¨¡å—å)</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹æ¨¡å—çš„<code>forEachChild</code>æ–¹æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†å¹¶å¤„ç†å­æ¨¡å—</span></span><br><span class="line">forEachChild(fn) &#123;</span><br><span class="line">  forEachValue(<span class="keyword">this</span>._children, fn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéå†çš„æ˜¯æ¨¡å—çš„å­æ¨¡å—<code>this._children</code>çš„å€¼ã€‚ç„¶åé€’å½’è°ƒç”¨<code>installModule</code>è¿›è¡Œæ³¨å†Œï¼Œæ³¨æ„<code>path</code>çš„å˜åŒ–ï¼Œè¿™é‡Œä¸åœ¨æ˜¯ç©ºæ•°ç»„ï¼Œè€Œæ˜¯åˆå¹¶äº†<code>key</code>å€¼ï¼ˆå³å­æ¨¡å—çš„åç§°ï¼‰ã€‚</p><p>æ¨¡å—å®‰è£…å®Œæˆåï¼Œç»§ç»­çœ‹<code>Store</code>çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// initialize the store vm, which is responsible for the reactivity</span></span><br><span class="line"><span class="comment">// (also registers _wrappedGetters as computed properties)</span></span><br><span class="line">resetStoreVM(<span class="keyword">this</span>, state) <span class="comment">// ! â‘¢ åˆå§‹åŒ– store._vm</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>resetStoreVM</code>å‡½æ•°åˆå§‹åŒ–<code>store._vm</code>å±æ€§ã€‚è¿™é‡Œæ˜¯<code>Store</code>å®ä¾‹åˆå§‹åŒ–çš„ç¬¬ä¸‰ä¸ªé‡ç‚¹é˜¶æ®µï¼šåˆå§‹åŒ–<code>store._vm</code>ã€‚</p><h2 id="åˆå§‹åŒ–store-vm-1"><a href="#åˆå§‹åŒ–store-vm-1" class="headerlink" title="åˆå§‹åŒ–store._vm"></a>åˆå§‹åŒ–<code>store._vm</code></h2><p>è¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯<code>store</code>å®ä¾‹è‡ªèº«å’Œ root çš„<code>state</code>çš„å€¼ã€‚ä¸‹é¢çœ‹ä¸‹<code>resetStoreVM</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetStoreVM</span>(<span class="params">store, state, hot</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> oldVm = store._vm <span class="comment">// ! ç¼“å­˜æ—§çš„ VMï¼Œç”¨äºçƒ­é‡è½½</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// bind store public getters</span></span><br><span class="line">  store.getters = &#123;&#125; <span class="comment">// ! åˆ›å»º getters å±æ€§</span></span><br><span class="line">  <span class="keyword">const</span> wrappedGetters = store._wrappedGetters <span class="comment">// ! è·å– wrappedGetters å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> computed = &#123;&#125; <span class="comment">// ! è®¾ç½®è®¡ç®—å±æ€§å¯¹è±¡</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç¼“å­˜æ—§çš„<code>store._vm</code>ç”¨äºçƒ­é‡è½½æ—¶é”€æ¯ï¼Œç„¶åå®šä¹‰<code>store.getters</code>çš„åˆå§‹å€¼ä¸ºä¸€ä¸ªç©ºå¯¹è±¡ï¼Œæ³¨æ„è¿™é‡Œæ‰æ­£å¼å¼€å§‹å®šäº<code>getters</code>å±æ€§ï¼Œå†å£°æ˜å¸¸é‡<code>wrappedGetters</code>å­˜å‚¨<code>store._wrappedGetters</code>ï¼Œå£°æ˜<code>computed</code>å¯¹è±¡ï¼Œåˆå§‹å€¼æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå† wrappedGetters</span></span><br><span class="line">forEachValue(wrappedGetters, (fn, key) =&gt; &#123;</span><br><span class="line">  <span class="comment">// use computed to leverage its lazy-caching mechanism</span></span><br><span class="line">  <span class="comment">// direct inline function use will lead to closure preserving oldVm.</span></span><br><span class="line">  <span class="comment">// using partial to return function with only arguments preserved in closure enviroment</span></span><br><span class="line">  <span class="comment">// ! æŠŠ wrappedGetter å‡½æ•°çš„è¿”å›å€¼èµ‹å€¼åˆ° VM çš„ computed ä¸­</span></span><br><span class="line">  computed[key] = partial(fn, store) <span class="comment">// ! fn(store) -&gt; wrappedGetter(store)</span></span><br><span class="line">  <span class="comment">// ! å®šä¹‰ store.getters çš„å±æ€§</span></span><br><span class="line">  <span class="comment">// ! store.getters.xxx -&gt; store._vm[xxx] -&gt; store._vm.computed[xxx]</span></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(store.getters, key, &#123;</span><br><span class="line">    <span class="keyword">get</span>: () =&gt; store._vm[key],</span><br><span class="line">    enumerable: true // for local getters</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéå†<code>wrappedGetters</code>ï¼Œç„¶åæŠŠå®ƒé‡Œé¢çš„æ•°æ®èµ‹å€¼ç»™ä¸Šé¢å£°æ˜çš„<code>computed</code>å¯¹è±¡ã€‚æ³¨æ„è¿™é‡Œæ˜¯è°ƒç”¨äº†<code>fn</code>å‡½æ•°ï¼Œå»æ‰å‡½æ•°åŒ…è£…ï¼Œç”ŸæˆçœŸæ­£çš„<code>getter</code>ã€‚</p><p><code>store.getters</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getters: &#123;</span><br><span class="line">  getterFn()&#123;&#125;, <span class="comment">// root getters</span></span><br><span class="line">  <span class="string">'modulesA/getterFn'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesA/getterFn2'</span>() &#123;&#125;,</span><br><span class="line">  <span class="string">'modulesB/getterFn'</span>() &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰<code>key</code>çš„å±æ€§ä¸­çš„<code>getter</code>çš„è¿”å›å€¼ä¸º<code>store._vm[key]</code>ã€‚</p><p>æˆ‘ä»¬çŸ¥é“åœ¨ Vue çš„å®ä¾‹å¯¹è±¡ä¸­è®¡ç®—å±æ€§<code>computed</code>çš„å€¼ä¼šå‡ºç°åœ¨ä»£ç†çš„å®ä¾‹å¯¹è±¡ä¸­ã€‚åé¢ä¼šæŠŠ<code>computed</code>å¯¹è±¡ä½œä¸ºè®¡ç®—å±æ€§æ³¨å…¥åˆ° Vue çš„å®ä¾‹ä¸­ï¼Œå› ä¸ºè®¡ç®—å±æ€§éƒ½ä¼šè¢«ä»£ç†åˆ° Vue çš„å®ä¾‹ä¸­ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡<code>store._vm[key]</code>è·å–åˆ°è®¡ç®—å±æ€§ã€‚å½“è®¿é—®<code>store.getters</code>çš„æ—¶å€™ï¼Œå°±æ˜¯è®¿é—®<code>store._vm[key]</code>ï¼Œä¹Ÿå°±æ˜¯è®¿é—®è®¡ç®—å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> silent = Vue.config.silent <span class="comment">// ! ç¼“å­˜åŸæ¥çš„ silent</span></span><br><span class="line">Vue.config.silent = <span class="literal">true</span> <span class="comment">// ! è®¾ä¸º trueï¼Œå°†ä¸ä¼šæŠ¥ä»»ä½•è­¦å‘Š</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! åˆ›å»º store._vm å®ä¾‹</span></span><br><span class="line"><span class="comment">// ! ç»‘å®š state å’Œ getter ä¸º Vue å®ä¾‹çš„ data å’Œ computed å±æ€§ï¼Œå˜æˆå“åº”å¼æ•°æ®</span></span><br><span class="line">store._vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    $$state: state <span class="comment">// !  store.state -&gt; store._vm.data.$$state</span></span><br><span class="line">  &#125;,</span><br><span class="line">  computed <span class="comment">// ! store._vm.computed[xxx] -&gt; store._vm[xxx]</span></span><br><span class="line">&#125;)</span><br><span class="line">Vue.config.silent = silent <span class="comment">// ! æ¢å¤åŸæ¥çš„ silent</span></span><br></pre></td></tr></table></figure><p>å…ˆå¤„ç† silent çš„è®¾ç½®ï¼Œç„¶åç”Ÿæˆä¸€ä¸ªæ–°çš„ Vue å®ä¾‹å¯¹è±¡ï¼Œèµ‹å€¼ç»™<code>store._vm</code>ï¼Œåœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­æŠŠæ ¹æ•°æ®<code>state</code>èµ‹å€¼ä¸ºåˆ° Vue å®ä¾‹çš„<code>data</code>å±æ€§çš„<code>$$state</code>ï¼Œç„¶åæŠŠä¸Šé¢å®šä¹‰çš„<code>computed</code>å¯¹è±¡ä¹Ÿä¼ å…¥è¿›å»ã€‚è¿™æ ·<code>store</code>çš„<code>state</code>å’Œ<code>getters</code>å±æ€§éƒ½å˜æˆäº†å“åº”å¼æ•°æ®ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒVuex çŠ¶æ€ç®¡ç†å™¨çš„æ•°æ®ä¸åŒæ„ä¸€èˆ¬çš„æ¨¡å—æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œå®ƒæ˜¯å“åº”å¼çš„ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹äº† Vuex çš„æ•°æ®æ—¶ï¼Œä¾èµ– Vuex çš„æ•°æ®çš„ç»„ä»¶çš„è§†å›¾ä¼šè‡ªåŠ¨æ›´æ–°ã€‚è¿™é‡Œçš„æºç å°±æ˜¯ Vuex çš„æ•°æ®å˜æˆå“åº”å¼æ•°æ®çš„åŸå› ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// enable strict mode for new vm</span></span><br><span class="line"><span class="comment">// ! åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œç¡®ä¿åªèƒ½é€šè¿‡ commit æ¥æ˜¾ç¤ºçš„ä¿®æ”¹ state çš„å€¼</span></span><br><span class="line"><span class="keyword">if</span> (store.strict) &#123;</span><br><span class="line">  enableStrictMode(store)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬ä¿®æ”¹ Vuex çš„æ•°æ®å¿…é¡»æ˜¾ç¤ºçš„æäº¤<code>commit</code>æ¥è¿›è¡Œä¿®æ”¹ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚</p><p>çœ‹ä¸‹<code>enableStrictMode</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ‰§è¡Œä¸¥æ ¼æ¨¡å¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">enableStrictMode</span>(<span class="params">store</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! åœ¨å¼€å‘ç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨ commit ä¿®æ”¹äº† state çš„å€¼ï¼Œä¼šæŠ¥é”™</span></span><br><span class="line">  store._vm.$watch(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._data.$$state <span class="comment">// ! ä¸¥æ ¼æ¨¡å¼ä¸‹ç›‘å¬ store.state å€¼çš„å˜åŒ–</span></span><br><span class="line">    &#125;,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        assert(</span><br><span class="line">          store._committing,</span><br><span class="line">          <span class="string">`do not mutate vuex store state outside mutation handlers.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="attr">deep</span>: <span class="literal">true</span>, <span class="attr">sync</span>: <span class="literal">true</span> &#125; <span class="comment">// ! æ·±åº¦ç›‘å¬å’ŒåŒæ­¥æ‰§è¡Œï¼Œæœ‰æ€§èƒ½æ¶ˆè€—ï¼Œåªèƒ½åœ¨å¼€å‘ç¯å¢ƒä½¿ç”¨ strict</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé€šè¿‡ Vue å®ä¾‹çš„ä¾¦å¬å™¨<code>$watch</code>å»ç›‘å¬<code>state</code>çš„å˜åŒ–ï¼Œåœ¨å˜åŒ–çš„æ—¶å€™ï¼Œå¦‚æœ<code>store._committing</code>ä¸º<code>false</code>ä¼šåœ¨å¼€å‘ç¯å¢ƒä¸­æŠ¥é”™ã€‚åŒæ—¶è¿˜è®¾ç½®äº†æ·±åº¦ç›‘å¬å’ŒåŒæ­¥æ‰§è¡Œï¼Œè¿™æ ·ä¼šæœ‰å¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ï¼Œæ‰€ä»¥<code>strick</code>åªèƒ½åœ¨å¼€å‘ç¯å¢ƒä¸­å¼€å¯ï¼Œåƒä¸‡ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒæ—¶å¼€å¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! çƒ­é‡è½½å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> (oldVm) &#123;</span><br><span class="line">  <span class="keyword">if</span> (hot) &#123;</span><br><span class="line">    <span class="comment">// dispatch changes in all subscribed watchers</span></span><br><span class="line">    <span class="comment">// to force getter re-evaluation for hot reloading.</span></span><br><span class="line">    store._withCommit(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      oldVm._data.$$state = <span class="literal">null</span> <span class="comment">// ! æ•°æ®é‡ç½®ä¸º null</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  Vue.nextTick(<span class="function"><span class="params">()</span> =&gt;</span> oldVm.$destroy()) <span class="comment">// ! é”€æ¯æ—§çš„ VM</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ Vuex çƒ­é‡è½½çš„è®¾ç½®ï¼Œçƒ­é‡è½½åéœ€è¦é‡ç½®æ—§çš„ VM çš„æ•°æ®å’Œé”€æ¯æ—§çš„ VM å®ä¾‹ã€‚</p><p>åˆå§‹åŒ–<code>store._vm</code>å®Œæˆåï¼Œç»§ç»­çœ‹<code>Store</code>ç±»çš„æ„é€ å‡½æ•°å‰©ä¸‹çš„æœ€åä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// apply plugins</span></span><br><span class="line">plugins.forEach(<span class="function"><span class="params">plugin</span> =&gt;</span> plugin(<span class="keyword">this</span>)) <span class="comment">// ! è°ƒç”¨æ‰€æœ‰æ’ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! å¤„ç† devtool æ’ä»¶</span></span><br><span class="line"><span class="keyword">const</span> useDevtools =</span><br><span class="line">  options.devtools !== <span class="literal">undefined</span> ? options.devtools : Vue.config.devtools</span><br><span class="line"><span class="keyword">if</span> (useDevtools) &#123;</span><br><span class="line">  devtoolPlugin(<span class="keyword">this</span>) <span class="comment">// ! å®‰è£… devtool æ’ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ‰€æœ‰çš„æ’ä»¶ï¼Œæœ€åè®¾ç½®å®˜æ–¹çš„ devtool æ’ä»¶ã€‚</p><p>åˆ°äº†è¿™ä¸€æ­¥ï¼Œ<code>Store</code>çš„å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–å°±å®Œæˆäº†ï¼Œå…¶å®è¿™ä¹Ÿå°±æ˜¯ Vuex çš„åˆå§‹åŒ–ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/v2/vuex/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">Vuex æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vuex/tree/learn-vuex" target="_blank" rel="noopener">Vuex æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;code&gt;Store.js&lt;/code&gt;æ–‡ä»¶ä¸­çš„ä»£ç ä¸­ï¼Œä¼šå¯¼å‡ºä¸€ä¸ª&lt;code&gt;Store&lt;/code&gt;ç±»ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨ Vuex çš„æ—¶å€™éƒ½æ˜¯ä»å…ˆåˆ›å»ºä¸€ä¸ª&lt;code&gt;Store&lt;/code&gt;å®ä¾‹å¯¹è±¡å¼€å§‹çš„ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢çœ‹ä¸‹&lt;code&gt;Store&lt;/code&gt;å®ä¾‹å¯¹è±¡çš„åˆå§‹åŒ–è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;Store-çš„åˆå§‹åŒ–&quot;&gt;&lt;a href=&quot;#Store-çš„åˆå§‹åŒ–&quot; class=&quot;headerlink&quot; title=&quot;Store çš„åˆå§‹åŒ–&quot;&gt;&lt;/a&gt;Store çš„åˆå§‹åŒ–&lt;/h2&gt;&lt;p&gt;å…ˆçœ‹ä¸‹&lt;code&gt;Store&lt;/code&gt;ç±»çš„åˆå§‹åŒ–å‡½æ•°&lt;code&gt;constructor&lt;/code&gt;çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;constructor&lt;/span&gt;(options = &amp;#123;&amp;#125;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// Auto install if it is not done yet and `window` has `Vue`.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// To allow users to avoid auto-installation in some cases,&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// this code should be placed here. See #731&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ! ä½¿ç”¨ Vuex ä¸ºå¼•å…¥å¤–é“¾æ—¶ï¼Œä¼šè‡ªåŠ¨å®‰è£…æ’ä»¶&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (!Vue &amp;amp;&amp;amp; &lt;span class=&quot;keyword&quot;&gt;typeof&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;window&lt;/span&gt; !== &lt;span class=&quot;string&quot;&gt;&#39;undefined&#39;&lt;/span&gt; &amp;amp;&amp;amp; &lt;span class=&quot;built_in&quot;&gt;window&lt;/span&gt;.Vue) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    install(&lt;span class=&quot;built_in&quot;&gt;window&lt;/span&gt;.Vue)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;åœ¨æˆ‘ä»¬ä½¿ç”¨å¤–é“¾æ¥å¼•å…¥ Vuex æ—¶ï¼Œä¼šè‡ªåŠ¨å®‰è£… Vuexï¼Œä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨&lt;code&gt;use&lt;/code&gt;æ–¹æ³•æ¥å®‰è£…ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vuex" scheme="https://haledeng.com/categories/Vuex/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Vuex" scheme="https://haledeng.com/tags/Vuex/"/>
    
  </entry>
  
  <entry>
    <title>Vuex3æºç å­¦ä¹ ç¬”è®°ä¹‹Vuexçš„å®‰è£…</title>
    <link href="https://haledeng.com/blog/20191005-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E5%AE%89%E8%A3%85/"/>
    <id>https://haledeng.com/blog/20191005-Vuex3%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BVuex%E7%9A%84%E5%AE%89%E8%A3%85/</id>
    <published>2019-10-05T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:37.164Z</updated>
    
    <content type="html"><![CDATA[<p>Vuex æ˜¯ä¸€ä¸ªä¸“ä¸º Vue.js åº”ç”¨ç¨‹åºå¼€å‘çš„<strong>çŠ¶æ€ç®¡ç†æ¨¡å¼</strong>ã€‚å®ƒé‡‡ç”¨é›†ä¸­å¼å­˜å‚¨ç®¡ç†åº”ç”¨çš„æ‰€æœ‰ç»„ä»¶çš„çŠ¶æ€ï¼Œå¹¶ä»¥ç›¸åº”çš„è§„åˆ™ä¿è¯çŠ¶æ€ä»¥ä¸€ç§å¯é¢„æµ‹çš„æ–¹å¼å‘ç”Ÿå˜åŒ–ã€‚</p><h2 id="æºç ç»“æ„"><a href="#æºç ç»“æ„" class="headerlink" title="æºç ç»“æ„"></a>æºç ç»“æ„</h2><p>å…ˆæŸ¥çœ‹ä¸‹ src ä¸‹é¢çš„æ–‡ä»¶ç›®å½•ç»“æ„</p><a id="more"></a><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">â”œâ”€â”€ module</span><br><span class="line">  â”œâ”€â”€ module-collection.js  <span class="comment"># æ¨¡å—æ”¶é›†ç±» ModuleCollection</span></span><br><span class="line">  â”œâ”€â”€ module.js             <span class="comment"># æ¨¡å—ç±» Module</span></span><br><span class="line">â”œâ”€â”€ plugins</span><br><span class="line">  â”œâ”€â”€ devtool.js            <span class="comment"># devtool æ’ä»¶</span></span><br><span class="line">  â”œâ”€â”€ logger.js             <span class="comment"># logger æ’ä»¶</span></span><br><span class="line">â”œâ”€â”€ helpers.js                <span class="comment"># è¾…åŠ©å‡½æ•°ï¼Œå®šä¹‰ mapXXX è¯­æ³•ç³–</span></span><br><span class="line">â”œâ”€â”€ index.esm.js              <span class="comment"># æ¨¡å— esm å…¥å£</span></span><br><span class="line">â”œâ”€â”€ index.js                  <span class="comment"># å…¥å£</span></span><br><span class="line">â”œâ”€â”€ mixin.js                  <span class="comment"># æ··å…¥åˆ° Vue çš„å‡½æ•° applyMixin</span></span><br><span class="line">â”œâ”€â”€ store.js                  <span class="comment"># ä»“åº“ç±» Store</span></span><br><span class="line">â”œâ”€â”€ util.js                   <span class="comment"># å·¥å…·å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹å…¥å£æ–‡ä»¶<code>index.js</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Store, install &#125; <span class="keyword">from</span> <span class="string">'./store'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  mapState,</span><br><span class="line">  mapMutations,</span><br><span class="line">  mapGetters,</span><br><span class="line">  mapActions,</span><br><span class="line">  createNamespacedHelpers</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./helpers'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  Store,</span><br><span class="line">  install,</span><br><span class="line">  version: <span class="string">'__VERSION__'</span>,</span><br><span class="line">  mapState,</span><br><span class="line">  mapMutations,</span><br><span class="line">  mapGetters,</span><br><span class="line">  mapActions,</span><br><span class="line">  createNamespacedHelpers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»<code>store.js</code>æ–‡ä»¶ä¸­å¯¼å…¥ä»“åº“ç±»<code>Store</code>å’Œå®‰è£…æ–¹æ³•<code>install</code>ï¼Œä»<code>helpers.js</code>æ–‡ä»¶ä¸­å¯¼å…¥æˆ‘ä»¬å¸¸ç”¨çš„è¯­æ³•ç³–<code>mapXXX</code>å’Œä¸€ä¸ªç»‘å®šå‘½åç©ºé—´çš„è¾…åŠ©å‡½æ•°<code>createNamespacedHelpers</code>ï¼Œç„¶åå†æŠŠè¿™äº›å±æ€§æ–¹æ³•å¯¼å‡ºå»ä¾›ç”¨æˆ·ä½¿ç”¨ã€‚</p><h2 id="æ’ä»¶å®‰è£…"><a href="#æ’ä»¶å®‰è£…" class="headerlink" title="æ’ä»¶å®‰è£…"></a>æ’ä»¶å®‰è£…</h2><p>å…ˆçœ‹ä¸‹ Vuex çš„æ€ä¹ˆå®‰è£…åœ¨ Vue ä¸Šçš„ï¼Œæˆ‘ä»¬å¹³æ—¶æ˜¯è¿™æ ·ä½¿ç”¨ Vuex çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line">Vue.use(Vuex)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ˜¯é€šè¿‡ Vue çš„<code>use</code>æ–¹æ³•æ¥å®‰è£… Vuex çš„ï¼Œè¿™å’Œå®‰è£… Vue çš„æ’ä»¶æ˜¯ä¸€æ ·çš„æ–¹æ³•ã€‚çœ‹è¿‡ Vue çš„æºç çš„åŒå­¦éƒ½çŸ¥é“ï¼Œä½¿ç”¨<code>use</code>æ–¹æ³•å®‰è£…æ’ä»¶æ—¶ï¼Œä¼šåœ¨æ–¹æ³•é‡Œé¢è°ƒç”¨æ’ä»¶è‡ªå¸¦çš„<code>install</code>æ–¹æ³•æŠŠæ’ä»¶å®‰è£…åˆ° Vue ä¸­ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸‹ Vuex çš„<code>install</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>store.js</code>æ–‡ä»¶çš„æœ€åé¢</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Vue <span class="comment">// bind on install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! Vuex å®‰è£…æ–¹æ³•</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">install</span>(<span class="params">_Vue</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! æ’ä»¶åªå®‰è£…ä¸€æ¬¡ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (Vue &amp;&amp; _Vue === Vue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(</span><br><span class="line">        <span class="string">'[vuex] already installed. Vue.use(Vuex) should be called only once.'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  Vue = _Vue <span class="comment">// ! ä¼ å…¥çš„ _Vue èµ‹å€¼ç»™å…¨å±€å˜é‡ Vueï¼Œä¹Ÿç”¨æ¥æ£€æµ‹æ˜¯å¦é‡å¤å®‰è£…</span></span><br><span class="line">  applyMixin(Vue) <span class="comment">// ! æŠŠ vuexInit æ–¹æ³•æ··å…¥åˆ° Vue çš„ beforeCreated é’©å­å‡½æ•°ä¸­</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬å®‰è£… Vue çš„æ’ä»¶éƒ½éœ€è¦æŠŠ Vue ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œå› ä¸ºæ’ä»¶æ˜¯å®‰è£…åœ¨ Vue ä¸Šçš„ï¼ŒVuex ä¹Ÿä¸ä¾‹å¤–ã€‚é¦–å…ˆå£°æ˜äº†å…¨å±€å˜é‡<code>Vue</code>å­˜å‚¨ Vue è¿™ä¸ªåº“ï¼Œåœ¨å®‰è£…çš„æ—¶å€™ä¼šæŠŠä¼ å…¥çš„<code>_Vue</code>å­˜å‚¨åˆ°<code>Vue</code>å˜é‡ä¸­ï¼Œè¿™æ ·ä¸‹æ¬¡æŸ¥è¯¢ä¸€ä¸‹å…¨å±€å˜é‡å­˜å‚¨çš„åº“æ˜¯å¦å’Œä¼ å…¥çš„åº“ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œè¯´æ˜å·²ç»å®‰è£…è¿‡è¿™ä¸ªæ’ä»¶äº†ï¼Œç›´æ¥è¿”å›ã€‚ä¹Ÿå°±æ˜¯è¯´ Vuex åªèƒ½å®‰è£…ä¸€æ¬¡ï¼Œä¸èƒ½é‡å¤å®‰è£…ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼çš„è®¾è®¡æ–¹æ¡ˆã€‚ç„¶ååœ¨æœ€åè°ƒç”¨<code>applyMixin</code>å‡½æ•°ï¼ŒåŒæ—¶æŠŠå˜é‡<code>Vue</code>ä¼ å…¥ã€‚</p><p>è¿™é‡Œä¸»è¦æ˜¯é€šè¿‡<code>applyMixin</code>å‡½æ•°æ¥å®‰è£… Vuexã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>applyMixin</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>mixin.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span>(<span class="params">Vue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> version = <span class="built_in">Number</span>(Vue.version.split(<span class="string">'.'</span>)[<span class="number">0</span>]) <span class="comment">// ! è·å–ä¸»ç‰ˆæœ¬å·</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (version &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">    Vue.mixin(&#123; <span class="attr">beforeCreate</span>: vuexInit &#125;) <span class="comment">// ! ä½¿ç”¨ Vue çš„ mixin æ–¹æ³•æŠŠ vuexInit æ··å…¥åˆ° beforeCreate é’©å­ä¸­</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// override init and inject vuex init procedure</span></span><br><span class="line">    <span class="comment">// for 1.x backwards compatibility.</span></span><br><span class="line">    <span class="comment">// ! å…¼å®¹ v1.0 ç‰ˆæœ¬</span></span><br><span class="line">    <span class="keyword">const</span> _init = Vue.prototype._init</span><br><span class="line">    Vue.prototype._init = <span class="function"><span class="keyword">function</span>(<span class="params">options = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">      options.init = options.init ? [vuexInit].concat(options.init) : vuexInit</span><br><span class="line">      _init.call(<span class="keyword">this</span>, options)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‰é¢çš„ä»£ç ï¼Œå£°æ˜å˜é‡<code>version</code>å­˜å‚¨è·å–çš„ Vue çš„ä¸»ç‰ˆæœ¬å·ã€‚å³ç‰ˆæœ¬å·ä¸­ç¬¬ä¸€ä¸ªç‚¹å‰é¢çš„æ•°å­—ï¼Œæ¯”å¦‚ç‰ˆæœ¬æ˜¯ 2.6.10ï¼Œè·å–çš„å€¼å°±æ˜¯ 2ã€‚ç„¶åæ ¹æ®ä¸»ç‰ˆæœ¬å·ä½¿ç”¨ä¸åŒçš„å®‰è£…æ–¹æ³•ï¼Œè¿™é‡Œå…¼å®¹äº† Vue 1.0 çš„å®‰è£…æ–¹æ³•ï¼Œå…ˆä¸ç®¡å®ƒã€‚</p><p>çœ‹ä¸‹ 2.0 ä»¥ä¸Šç‰ˆæœ¬çš„å®‰è£…æ–¹æ³•ï¼Œè°ƒç”¨ Vue çš„<code>mixin</code>æ–¹æ³•ï¼Œåœ¨<code>beforeCreate</code>ç”Ÿå‘½å‘¨æœŸä¸­æ··å…¥ä¸€ä¸ª<code>vuexInit</code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨ Vue åˆå§‹åŒ–å®ä¾‹çš„æ—¶å€™ï¼Œä¹Ÿä¼šåˆå§‹åŒ– Vuexã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>vuexInit</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒåœ¨<code>applyMixin</code>å‡½æ•°çš„å°¾éƒ¨ï¼Œäº†è§£ Vuex æ˜¯å¦‚ä½•åˆå§‹åŒ–çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! Vuex åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">vuexInit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = <span class="keyword">this</span>.$options <span class="comment">// ! è·å– Vue å®ä¾‹çš„é€‰é¡¹</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// store injection</span></span><br><span class="line">  <span class="keyword">if</span> (options.store) &#123;</span><br><span class="line">    <span class="comment">// ! æŠŠç”¨æˆ·å®šä¹‰çš„ store å®ä¾‹èµ‹å€¼ç»™ Vue å®ä¾‹çš„ $store å±æ€§ï¼Œæ–¹ä¾¿ç»„ä»¶æ“ä½œ store</span></span><br><span class="line">    <span class="keyword">this</span>.$store =</span><br><span class="line">      <span class="keyword">typeof</span> options.store === <span class="string">'function'</span> ? options.store() : options.store</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.parent &amp;&amp; options.parent.$store) &#123;</span><br><span class="line">    <span class="keyword">this</span>.$store = options.parent.$store <span class="comment">// ! ä»çˆ¶ç»„ä»¶ä¸­è·å– storeï¼Œå› ä¸ºå…¨å±€çš„ store éƒ½æ˜¯åŒä¸€ä¸ª</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å¸¸é‡<code>options</code>å­˜å‚¨ Vue å®ä¾‹åˆå§‹åŒ–çš„é€‰é¡¹ï¼Œç„¶ååˆ¤æ–­é€‰é¡¹ä¸­æ˜¯å¦æœ‰<code>store</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§å°±æ˜¯ä½¿ç”¨ Vuex æ—¶åˆ›å»ºçš„ Store å®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå®ä¾‹å¯¹è±¡ä¼šä¼ å…¥åˆ° Vue çš„é€‰é¡¹ä¸­ã€‚å¦‚ä¸‹é¢ä»£ç æ‰€ç¤º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> Vuex <span class="keyword">from</span> <span class="string">'vuex'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App.vue'</span></span><br><span class="line">Vue.use(Vuex)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">  state: &#123;&#125;,</span><br><span class="line">  getters: &#123;&#125;,</span><br><span class="line">  mutations: &#123;&#125;,</span><br><span class="line">  actions: &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  store, <span class="comment">// æ”¾å…¥åˆ° Vue çš„ options ä¸­</span></span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­<code>options.store</code>çš„ç±»å‹ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œéœ€è¦è°ƒç”¨å®ƒç”Ÿæˆä¸€ä¸ª<code>Store</code>å®ä¾‹å¯¹è±¡ï¼Œå¦‚æœæ˜¯å¯¹è±¡åˆ™ç›´æ¥èµ‹å€¼ã€‚</p><p>ä»€ä¹ˆæ—¶å€™ä¼šä½¿ç”¨å‡½æ•°ç±»å‹å‘¢ï¼Ÿåœ¨æˆ‘ä»¬æ„å»º Vue çš„æœåŠ¡ç«¯æ¸²æŸ“æ—¶ä¼šä½¿ç”¨ï¼Œé€šè¿‡å‡½æ•°ç”Ÿæˆä¸€ä¸ª<code>Store</code>å®ä¾‹å¯¹è±¡ï¼Œè¿™æ ·æ¯æ¬¡éƒ½ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  <span class="keyword">new</span> Vuex.Store(&#123;</span><br><span class="line">    state: &#123;&#125;,</span><br><span class="line">    getters: &#123;&#125;,</span><br><span class="line">    mutations: &#123;&#125;,</span><br><span class="line">    actions: &#123;&#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>ç„¶åå¦‚æœæ²¡æœ‰<code>options.store</code>ï¼Œåˆ™ä¼šä»å®ƒçš„çˆ¶çº§ç»„ä»¶ä¸­å»å¯»æ‰¾ï¼Œåˆ¤æ–­çˆ¶çº§ä¸­æ˜¯å¦å·²ç»å­˜åœ¨<code>$store</code>å±æ€§ï¼Œå¦‚æœå­˜åœ¨ï¼ŒæŠŠå®ƒèµ‹å€¼åˆ°è‡ªèº«çš„<code>$store</code>å±æ€§ä¸­ï¼Œå› ä¸º Vuex çš„è®¾è®¡æ¨¡å¼æ˜¯ä¸€ä¸ªå•ä¾‹æ¨¡å¼ï¼Œå…¨å±€çš„<code>store</code>éƒ½æ˜¯åŒä¸€ä¸ªçš„ï¼Œä¹Ÿæ˜¯å”¯ä¸€çš„ä¸€ä¸ªï¼Œå…¨éƒ¨ç»„ä»¶éƒ½å…±äº«è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥ä»çˆ¶çº§ä¸­è·å–ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>è¿™æ ·ï¼ŒVuex çš„å®‰è£…è¿‡ç¨‹å°±å®Œæˆäº†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/v2/vuex/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://vuex.vuejs.org/zh/" target="_blank" rel="noopener">Vuex æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vuex/tree/learn-vuex" target="_blank" rel="noopener">Vuex æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Vuex æ˜¯ä¸€ä¸ªä¸“ä¸º Vue.js åº”ç”¨ç¨‹åºå¼€å‘çš„&lt;strong&gt;çŠ¶æ€ç®¡ç†æ¨¡å¼&lt;/strong&gt;ã€‚å®ƒé‡‡ç”¨é›†ä¸­å¼å­˜å‚¨ç®¡ç†åº”ç”¨çš„æ‰€æœ‰ç»„ä»¶çš„çŠ¶æ€ï¼Œå¹¶ä»¥ç›¸åº”çš„è§„åˆ™ä¿è¯çŠ¶æ€ä»¥ä¸€ç§å¯é¢„æµ‹çš„æ–¹å¼å‘ç”Ÿå˜åŒ–ã€‚&lt;/p&gt;
&lt;h2 id=&quot;æºç ç»“æ„&quot;&gt;&lt;a href=&quot;#æºç ç»“æ„&quot; class=&quot;headerlink&quot; title=&quot;æºç ç»“æ„&quot;&gt;&lt;/a&gt;æºç ç»“æ„&lt;/h2&gt;&lt;p&gt;å…ˆæŸ¥çœ‹ä¸‹ src ä¸‹é¢çš„æ–‡ä»¶ç›®å½•ç»“æ„&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vuex" scheme="https://haledeng.com/categories/Vuex/"/>
    
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
      <category term="Vuex" scheme="https://haledeng.com/tags/Vuex/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹åˆå§‹åŒ–ç»ˆå±€</title>
    <link href="https://haledeng.com/blog/20190930-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%88%E5%B1%80/"/>
    <id>https://haledeng.com/blog/20190930-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E7%BB%88%E5%B1%80/</id>
    <published>2019-09-30T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:31.026Z</updated>
    
    <content type="html"><![CDATA[<p>å†æ¬¡å›åˆ°<code>initState</code>å‡½æ•°ä¸­ï¼Œå…¶ä¸­<code>data</code>ã€<code>watch</code>ã€<code>computed</code>å’Œ<code>props</code>é€‰é¡¹çš„åˆå§‹åŒ–éƒ½å·²è®²è§£ï¼Œä¸‹é¢è¿˜å‰©ä¸‹<code>methods</code>é€‰é¡¹çš„åˆå§‹åŒ–æœªè®²è§£ã€‚çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨<code>initMethods</code>å‡½æ•°åˆå§‹åŒ–<code>methods</code>é€‰é¡¹ï¼Œè¿˜éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡<code>vm</code>å’Œåˆå¹¶é€‰é¡¹åçš„<code>methods</code>å±æ€§ã€‚</p><h2 id="initMethods"><a href="#initMethods" class="headerlink" title="initMethods"></a><code>initMethods</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>initMethods</code> å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> props = vm.$options.props</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>props</code>å­˜å‚¨åˆå¹¶é€‰é¡¹åçš„<code>props</code>é€‰é¡¹ï¼Œè¿™ä¸ªå¸¸é‡åœ¨åé¢ä¼šç”¨åˆ°ã€‚</p><p>ç„¶åæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ª<code>for</code>å¾ªç¯è¯­å¥ï¼Œéå†<code>methods</code>é€‰é¡¹ï¼Œä¸‹é¢çœ‹ä¸‹<code>for</code>å¾ªç¯è¯­å¥é‡Œé¢çš„å†…å®¹ã€‚</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  <span class="comment">// ! æ–¹æ³•å¿…é¡»æ˜¯å‡½æ•°ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> methods[key] !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has type "<span class="subst">$&#123;<span class="keyword">typeof</span> methods[</span></span></span><br><span class="line"><span class="string"><span class="subst">        key</span></span></span><br><span class="line"><span class="string"><span class="subst">      ]&#125;</span>" in the component definition. `</span> +</span><br><span class="line">        <span class="string">`Did you reference the function correctly?`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœ<code>methods</code>é€‰é¡¹é‡Œé¢çš„<code>value</code>å€¼ä¸æ˜¯å‡½æ•°ç±»å‹ä¼šæŠ¥é”™ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ–¹æ³•åä¸èƒ½å’Œ props é‡Œé¢çš„å±æ€§åç›¸åŒï¼Œå¦åˆ™æŠ¥é”™ï¼Œè¿™æ ·ä¼šäº§ç”Ÿå†²çªï¼Œè¦†ç›–æ‰ props çš„å±æ€§</span></span><br><span class="line"><span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">  warn(<span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has already been defined as a prop.`</span>, vm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æ–¹æ³•å’Œå®ä¾‹å¯¹è±¡å±æ€§åŒå ä¸” æ˜¯ Vue çš„ä¿ç•™å­—æ—¶ï¼ˆä»¥_æˆ–è€…$å¼€å¤´çš„ï¼Œå¦‚ _data $parent ç­‰ï¼‰ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="comment">// ! ä¼šäº§ç”Ÿå†²çªï¼Œè¦†ç›–æ‰å®ä¾‹å±æ€§</span></span><br><span class="line"><span class="keyword">if</span> (key <span class="keyword">in</span> vm &amp;&amp; isReserved(key)) &#123;</span><br><span class="line">  warn(</span><br><span class="line">    <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" conflicts with an existing Vue instance method. `</span> +</span><br><span class="line">      <span class="string">`Avoid defining component methods that start with _ or $.`</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œ<code>methods</code>é€‰é¡¹ä¸­çš„æ–¹æ³•åä¸èƒ½å’Œ<code>props</code>é€‰é¡¹ä¸­çš„<code>key</code>ç›¸åŒï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œå› ä¸ºè¿™æ ·ä¼šäº§ç”Ÿå†²çªï¼Œæ–¹æ³•ä¼šè¦†ç›–æ‰<code>props</code>ä¸­çš„æ•°æ®ã€‚</p><p>å¦å¤–ï¼Œ<code>methods</code>é€‰é¡¹ä¸­çš„æ–¹æ³•å’Œå®ä¾‹å¯¹è±¡<code>vm</code>ä¸­çš„å±æ€§åŒåï¼Œå¹¶ä¸”æ–¹æ³•åå’Œ Vue çš„ä¿ç•™å±æ€§é‡åæ—¶ï¼Œä¼šæŠ¥é”™ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ä»£ç†æ–¹æ³•åˆ°å®ä¾‹ï¼Œå¹¶ä¸”æŒ‡å‘å®ä¾‹</span></span><br><span class="line">vm[key] = <span class="keyword">typeof</span> methods[key] !== <span class="string">'function'</span> ? noop : bind(methods[key], vm)</span><br></pre></td></tr></table></figure><p>æŠŠ<code>methods</code>ä¸­çš„æ–¹æ³•ä»£ç†åˆ°å®ä¾‹å¯¹è±¡<code>vm</code>ä¸­ã€‚è¿™é‡Œå¹¶æ²¡æœ‰ç”¨<code>object.definedProperty</code>æ–¹æ³•ä»£ç†å±æ€§ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨äº†<code>bind</code>çš„å‡½æ•°ï¼ŒæŠŠæ–¹æ³•çš„<code>this</code>æŒ‡å‘å®ä¾‹å¯¹è±¡ã€‚è¿™ä¸ª<code>bind</code>å‡½æ•°æ˜¯å¯¹åŸç”Ÿçš„<code>Function.prototype.bind</code>æ–¹æ³•çš„åšäº†å…¼å®¹æ€§å¤„ç†çš„å‡½æ•°ã€‚</p><p>åˆ°è¿™é‡Œï¼Œ<code>methods</code>é€‰é¡¹çš„åˆå§‹åŒ–å°±è®²è§£å®Œæˆï¼Œ<code>initState</code>å‡½æ•°çš„åˆå§‹åŒ–å…¨éƒ¨è®²è§£å®Œæˆã€‚</p><h2 id="provide"><a href="#provide" class="headerlink" title="provide"></a><code>provide</code></h2><p>å†æ¬¡å›åˆ°<code>Vue.prototype._init</code>å‡½æ•°ä¸­ï¼ŒæŸ¥çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">initLifecycle(vm) <span class="comment">// ! åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³é…ç½® å­˜å‚¨æœ¬èº«å®ä¾‹åˆ°çˆ¶èŠ‚ç‚¹ æ–°å¢å±æ€§ $parent $root $children $refs ç­‰</span></span><br><span class="line">initEvents(vm) <span class="comment">// ! åˆå§‹åŒ–äº‹ä»¶ç›¸å…³é…ç½® æ›´æ–° listeners</span></span><br><span class="line">initRender(vm) <span class="comment">// ! åˆå§‹åŒ–æ¸²æŸ“, åˆ›å»º VNode å¦æ–°å¢å±æ€§ $attrs å’Œ $listeners</span></span><br><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>) <span class="comment">// ! æ‰§è¡Œ beforeCreate é’©å­å‡½æ•°</span></span><br><span class="line">initInjections(vm) <span class="comment">// ! åˆå§‹åŒ– Injections resolve injections before data/props</span></span><br><span class="line">initState(vm) <span class="comment">// ! åˆå§‹åŒ–çŠ¶æ€ï¼Œå“åº”å¼ç›¸å…³ æŒ‰é¡ºåº props =&gt; methods =&gt; data =&gt; computed  =&gt; watch</span></span><br><span class="line">initProvide(vm) <span class="comment">// ! åˆå§‹åŒ– Provide resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>) <span class="comment">// ! æ‰§è¡Œ created é’©å­å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢åˆå§‹åŒ–çš„å‡½æ•°ä¸­ï¼Œåªå‰©ä¸‹<code>initInjections</code>å‡½æ•°å’Œ<code>initProvide</code>å‡½æ•°æ²¡æœ‰è®²è§£ï¼Œæ³¨æ„åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œ<code>initInjections</code>å‡½æ•°è¦æ¯”<code>initProvide</code>å‡½æ•°æ›´æ—©æ‰§è¡Œã€‚</p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç­‰æˆ‘ä»¬è®²è§£åˆ°<code>initInjections</code>å‡½æ•°æ—¶å°±çŸ¥é“äº†ã€‚</p><p>ä¸‹é¢å…ˆçœ‹ä¸‹<code>provide</code>é€‰é¡¹çš„åˆå§‹åŒ–ï¼ŒæŸ¥çœ‹<code>initProvide</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/instance/inject.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initProvide</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> provide = vm.$options.provide</span><br><span class="line">  <span class="keyword">if</span> (provide) &#123;</span><br><span class="line">    vm._provided = <span class="keyword">typeof</span> provide === <span class="string">'function'</span> ? provide.call(vm) : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°éå¸¸ç®€å•ï¼Œåªæœ‰å‡ è¡Œä»£ç ã€‚å£°æ˜å¸¸é‡<code>provide</code>å­˜å‚¨åˆå¹¶é€‰é¡¹å<code>provide</code>é€‰é¡¹ï¼Œå…ˆåˆ¤æ–­<code>provide</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå®šä¹‰å®ä¾‹å¯¹è±¡çš„<code>vm._provided</code>å±æ€§å­˜å‚¨<code>provide</code>ï¼Œåœ¨å­˜å‚¨å‰åˆ¤æ–­<code>provide</code>æ˜¯ä¸æ˜¯å‡½æ•°ç±»å‹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¿˜éœ€è¦æ‰§è¡Œå‡½æ•°è·å–å€¼ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>initProvide</code>å‡½æ•°çš„ä½œç”¨å°±æ˜¯åˆ›å»ºå®ä¾‹çš„<code>_provided</code>å±æ€§ï¼Œç„¶åå­˜å‚¨åˆå¹¶åçš„<code>provide</code>é€‰é¡¹ã€‚</p><h2 id="inject"><a href="#inject" class="headerlink" title="inject"></a><code>inject</code></h2><h3 id="initInjections"><a href="#initInjections" class="headerlink" title="initInjections"></a><code>initInjections</code></h3><p>ä¸‹é¢çœ‹<code>inject</code>çš„é€‰é¡¹çš„åˆå§‹åŒ–ï¼ŒæŸ¥çœ‹<code>initInjections</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/instance/inject.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initInjections</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = resolveInject(vm.$options.inject, vm) <span class="comment">// ! è®²è§£ injectï¼Œè·å–çˆ¶ç»„ä»¶ provide çš„å€¼</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>result</code>å­˜å‚¨<code>resolveInject</code>å‡½æ•°çš„è¿”å›å€¼ã€‚<code>resolveInject</code>å‡½æ•°è°ƒç”¨æ—¶éœ€è¦ä¼ å…¥åˆå¹¶åçš„<code>inject</code>é€‰é¡¹å’Œå®ä¾‹å¯¹è±¡<code>vm</code>ã€‚</p><p>è¿™ä¸ªå‡½æ•°çš„ä½œç”¨åº”è¯¥æ˜¯è®²è§£<code>inject</code>é€‰é¡¹ã€‚ç”¨è¿‡<code>inject</code>é€‰é¡¹çš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œ<code>inject</code>é€‰é¡¹ä¸­æ³¨å…¥çš„å±æ€§æ˜¯å®ƒæ‰€åœ¨å®ä¾‹ç»„ä»¶çš„çˆ¶ç»„ä»¶æˆ–è€…æ›´ä¸Šä¸€çº§çš„ç»„ä»¶çš„<code>provide</code>é€‰é¡¹æä¾›çš„å€¼ã€‚è¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯è·å–å®ƒæ‰€åœ¨ç»„ä»¶çš„çˆ¶ç»„ä»¶ä¸­çš„<code>_provide</code>å±æ€§çš„å€¼ï¼Œå®ä¾‹ç»„ä»¶çš„<code>_provide</code>å±æ€§æ˜¯å­˜å‚¨åˆå§‹åŒ–åçš„<code>provide</code>é€‰é¡¹ã€‚</p><h3 id="resolveInject"><a href="#resolveInject" class="headerlink" title="resolveInject"></a><code>resolveInject</code></h3><p>æŸ¥çœ‹<code>resolveInject</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveInject</span>(<span class="params">inject: any, vm: Component</span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inject) &#123;</span><br><span class="line">    <span class="comment">// inject is :any because flow is not smart enough to figure out cached</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> keys = hasSymbol ? <span class="built_in">Reflect</span>.ownKeys(inject) : <span class="built_in">Object</span>.keys(inject)</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­é€šè¿‡å‚æ•°ä¼ å…¥çš„<code>inject</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œæ‰èƒ½ç»§ç»­ä¸‹é¢çš„é€»è¾‘ã€‚</p><p>å£°æ˜å˜é‡<code>result</code>ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå®ƒä¹Ÿæ˜¯è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼Œå®ƒçš„ä½œç”¨æ˜¯å­˜å‚¨ä»çˆ¶ç»„ä»¶çš„<code>_provide</code>å±æ€§ä¸­è·å–çš„å€¼ã€‚</p><p>å£°æ˜å˜é‡<code>keys</code>å­˜å‚¨<code>inject</code>çš„<code>keys</code>ï¼Œå…ˆåˆ¤æ–­å½“å‰å®¿ä¸»ç¯å¢ƒæ˜¯å¦æ”¯æŒ<code>Symbol</code>ï¼Œå¦‚æœæ”¯æŒçš„è¯ï¼Œä½¿ç”¨<code>Reflect.ownKeys</code>æ–¹æ³•è·å–<code>keys</code>çš„å€¼ï¼›å¦‚æœä¸æ”¯æŒï¼Œä½¿ç”¨<code>Object.keys</code>æ–¹æ³•è·å–<code>keys</code>çš„å€¼ã€‚</p><p>å†çœ‹ä¸‹ä¸­é—´çœç•¥çš„ä»£ç ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ª<code>for</code>å¾ªç¯è¯­å¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = keys[i]</span><br><span class="line">  <span class="comment">// #6574 in case the inject object is observed...</span></span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">'__ob__'</span>) <span class="keyword">continue</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‰é¢çš„ä»£ç ï¼Œå£°æ˜å¸¸é‡<code>key</code>ç¼“å­˜å¾ªç¯ä¸­çš„<code>key</code>å€¼ã€‚</p><p>é¦–å…ˆåˆ¤æ–­<code>key</code>æ˜¯ä¸æ˜¯<code>__ob__</code>å±æ€§ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè·³è¿‡è¿™æ¬¡å¾ªç¯ï¼Œè¿™è¡Œä»£ç æ˜¯ä¸ºäº†è§£å†³ Vue çš„<a href="https://github.com/vuejs/vue/issues/6574" target="_blank" rel="noopener">6574 issue</a>çš„ï¼Œæˆ‘çŒœæµ‹ä¸»è¦åŸå› æ˜¯å› ä¸º<code>__ob__</code>å±æ€§æ˜¯é€šè¿‡<code>Object.defineProperty</code>æ–¹æ³•å®šä¹‰çš„ï¼Œè€Œè¿™ä¸ªå±æ€§æ˜¯ä¸èƒ½é€šè¿‡<code>Object.keys</code>æ–¹æ³•è·å–åˆ°çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿æŒåœ¨ä¸æ”¯æŒ<code>Symbol</code>ç¯å¢ƒä¸‹æ—¶<code>keys</code>çš„ä¸€è‡´æ€§ï¼Œæ‰ä¼šè·³è¿‡è¿™ä¸ªå¾ªç¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> provideKey = inject[key].from <span class="comment">// ! ä» from ä¸­è·å–å¯¹äº provide çš„ key</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>provideKey</code>å­˜å‚¨<code>inject[key]</code>çš„<code>from</code>å±æ€§ï¼Œè¿™ä¸ª<code>from</code>å±æ€§å°±æ˜¯çˆ¶ç»„ä»¶çš„<code>_provide</code>å±æ€§å¯¹åº”çš„<code>key</code>ï¼Œä»è§„èŒƒåŒ–<code>inject</code>é€‰é¡¹çš„ä»£ç ä¸­æˆ‘ä»¬çŸ¥é“ï¼Œ<code>inject</code>ä¸­çš„<code>from</code>å±æ€§å­˜å‚¨å®ƒçš„æ¥æºå±æ€§çš„<code>key</code>å€¼ï¼Œå¦å¤–ï¼Œ<code>inject</code>é€‰é¡¹ä¸­çš„<code>key</code>å€¼å’Œè¿™ä¸ª<code>from</code>å€¼ä¸ä¸€å®šç›¸åŒã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">provide: &#123;</span><br><span class="line">  name: <span class="string">'Hale'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è§„èŒƒåŒ–å‰</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  n: <span class="string">'name'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåŒ–å</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  n: &#123;</span><br><span class="line">    <span class="keyword">from</span>: <span class="string">'name'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–å€¼</span></span><br><span class="line">n: <span class="string">'Hale'</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> source = vm</span><br><span class="line"><span class="keyword">while</span> (source) &#123;</span><br><span class="line">  <span class="comment">// ! æŸ¥æ‰¾å¹¶è·å–çˆ¶ç»„ä»¶çš„ provide çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (source._provided &amp;&amp; hasOwn(source._provided, provideKey)) &#123;</span><br><span class="line">    result[key] = source._provided[provideKey] <span class="comment">// ! æ³¨æ„ï¼šå› ä¸ºç»„ä»¶æ˜¯å…ˆåˆå§‹åŒ– inject, æ‰€ä»¥ä¸ä¼šæ‰¾åˆ°æœ¬èº«çš„ provide</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  &#125;</span><br><span class="line">  source = source.$parent <span class="comment">// ! å¾ªç¯å¾€ä¸Šæ‰¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>source</code>ç¼“å­˜å®ä¾‹å¯¹è±¡<code>vm</code>ã€‚ç„¶åå°±æ˜¯ä¸€ä¸ª<code>while</code>å¾ªç¯è¯­å¥ï¼Œå®ƒæ¯æ¬¡å¾ªç¯æ‰§è¡Œçš„ä»£ç æ˜¯<code>source = source.$parent</code>ï¼Œå°±æ˜¯é€šè¿‡<code>$parent</code>å±æ€§ä¸€ç›´åœ¨ç»„ä»¶æ ‘ä¸­å¾€ä¸Šå»å¯»æ‰¾<code>source</code>ã€‚</p><p>å¾ªç¯çš„ç»“æŸæ¡ä»¶æ˜¯æ‰¾åˆ°ç»„ä»¶<code>source</code>ä¸­æœ‰<code>_provide</code>å±æ€§ä¸”å±æ€§é‡Œé¢æœ‰å’Œ<code>provideKey</code>ç›¸åŒåå­—çš„<code>key</code>ï¼Œè¿™è¯´æ˜æ‰¾åˆ°äº†çˆ¶ç»„ä»¶æä¾›çš„<code>key</code>å€¼ï¼Œè¿™ä¸ªå€¼å°±æ˜¯<code>source._provided[provideKey]</code>ï¼Œç„¶åæŠŠå€¼å­˜å‚¨åˆ°å˜é‡<code>result</code>ä¸­ã€‚</p><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå°±æ˜¯é€šè¿‡è¿™æ ·çš„æ–¹æ³•å»æŸ¥æ‰¾å€¼ï¼Œä¼šä¸ä¼šæ‰¾åˆ°å®ä¾‹æœ¬èº«å®šä¹‰çš„<code>provide</code>é€‰é¡¹ä¸­çš„å€¼å‘¢ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯ä¸ä¼šçš„ã€‚å› ä¸ºåˆå§‹åŒ–å®ä¾‹å¯¹è±¡æ—¶ï¼Œåˆå§‹åŒ–<code>inject</code>é€‰é¡¹æ¯”åˆå§‹åŒ–<code>provide</code>çš„æ—¶é—´æ›´æ—©ï¼Œæ‰€ä»¥åœ¨é‚£ä¸ªæ—¶å€™ï¼Œå®ä¾‹ç»„ä»¶è¿˜æ²¡æœ‰åˆ›å»º<code>_provide</code>å±æ€§ï¼Œåªèƒ½å»çˆ¶ç»„ä»¶ä¸­å»å¯»æ‰¾ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¦‚æœå¾ªç¯ä¹‹åè¿˜æ˜¯æ‰¾ä¸åˆ°å€¼</span></span><br><span class="line"><span class="keyword">if</span> (!source) &#123;</span><br><span class="line">  <span class="comment">// ! å¦‚æœå®šä¹‰äº†é»˜è®¤å€¼åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼Œå‡½æ•°ç±»å‹çš„é»˜è®¤å­—éœ€è¦æ±‚å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'default'</span> <span class="keyword">in</span> inject[key]) &#123;</span><br><span class="line">    <span class="keyword">const</span> provideDefault = inject[key].default</span><br><span class="line">    result[key] =</span><br><span class="line">      <span class="keyword">typeof</span> provideDefault === <span class="string">'function'</span></span><br><span class="line">        ? provideDefault.call(vm)</span><br><span class="line">        : provideDefault</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! æ‰¾ä¸åˆ°åˆæ²¡æœ‰é»˜è®¤å€¼ï¼Œéç”Ÿäº§ç¯å¢ƒä¸‹æŠ¥é”™</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(<span class="string">`Injection "<span class="subst">$&#123;key&#125;</span>" not found`</span>, vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>source</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜å¾ªç¯ç»“æŸåè¿˜æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„çˆ¶ç»„ä»¶ã€‚</p><p>è¿™æ—¶å€™å…ˆåˆ¤æ–­<code>inject</code>é€‰é¡¹çš„å±æ€§é‡Œé¢æ˜¯å¦è®¾ç½®äº†<code>default</code>å±æ€§ï¼Œä¹Ÿå°±æ˜¯é»˜è®¤å€¼ã€‚å¦‚æœè®¾ç½®äº†é»˜è®¤å€¼ï¼Œå£°æ˜å¸¸é‡<code>provideDefault</code>å­˜å‚¨è¿™ä¸ªé»˜è®¤å€¼ï¼Œå³<code>inject[key].default</code>ã€‚</p><p>ç„¶åå†åˆ¤æ–­è¿™ä¸ªé»˜è®¤å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œå°±æ‰§è¡Œå‡½æ•°æ±‚å€¼ï¼Œå¹¶æŠŠæ±‚å€¼çš„ç»“æœèµ‹å€¼åˆ°<code>result</code>å¯¹è±¡ä¸­ï¼Œå®ƒçš„<code>key</code>è¿˜æ˜¯ä»¥å‰çš„<code>key</code>ï¼Œ<code>vlaue</code>å°±æ˜¯å‡½æ•°çš„æ±‚å€¼ç»“æœã€‚å¦‚æœä¸æ˜¯å‡½æ•°ç±»å‹ï¼Œç›´æ¥èµ‹å€¼ã€‚</p><p>å¦‚æœæ‰¾ä¸åˆ°æ»¡è¶³æ¡ä»¶çš„çˆ¶ç»„ä»¶ï¼Œåˆæ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°<code>inject</code>ä¸­<code>key</code>çš„å€¼ã€‚</p><p><code>resolveInject</code>å‡½æ•°è®²è§£å®Œæ¯•ï¼Œå†æ¬¡å›åˆ°<code>initInjections</code>å‡½æ•°ä¸­ï¼ŒæŸ¥çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–åˆ° provide çš„å€¼å</span></span><br><span class="line"><span class="keyword">if</span> (result) &#123;</span><br><span class="line">  toggleObserving(<span class="literal">false</span>) <span class="comment">// ! ä¸ç›‘å¬ inject é€‰é¡¹çš„å±æ€§ä¸æ˜¯å“åº”å¼çš„</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  toggleObserving(<span class="literal">true</span>) <span class="comment">// ! æ¢å¤ç›‘å¬</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦è·å–åˆ°<code>provide</code>é€‰é¡¹çš„å€¼ï¼Œè·å–åˆ°ä¹‹åæ‰èƒ½è¿›è¡Œä¸‹é¢çš„é€»è¾‘ã€‚</p><p>æ‰§è¡Œ<code>toggleObserving(false)</code>ä»£ç æŠŠ<code>shouleObserve</code>çš„å€¼è®¾ç½®ä¸º<code>false</code>ï¼Œåœ¨å‰é¢æˆ‘ä»¬çŸ¥é“æŠŠ<code>shouleObserve</code>è®¾ç½®ä¸º<code>false</code>æ—¶ï¼Œå°±ä¸ä¼šå»åˆ›å»ºç›‘å¬å™¨å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šæŠŠ<code>inject</code>ä¸­çš„æ•°æ®å˜æˆå“åº”å¼æ•°æ®ï¼Œå› ä¸º<code>inject</code>é€‰é¡¹çš„æ•°æ®ä¸éœ€è¦æ˜¯å“åº”å¼æ•°æ®ã€‚</p><p>è¿™é‡Œä¸­é—´çœç•¥äº†ä¸€äº›ä»£ç ã€‚</p><p>åœ¨æœ€ååˆæ‰§è¡Œ<code>toggleObserving(true)</code>ä»£ç æŠŠ<code>shouleObserve</code>çš„å€¼é‡æ–°è®¾ç½®ä¸º<code>true</code>ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“åˆ°å…¶ä»–é€‰é¡¹çš„æ•°æ®å˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹ä¸­é—´çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.keys(result).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">// ! å®ä¾‹ä»£ç† keyï¼Œå¦å¤–ä¸èƒ½ä¿®æ”¹ inject çš„æ•°æ®ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line">    defineReactive(vm, key, result[key], () =&gt; &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Avoid mutating an injected value directly since the changes will be `</span> +</span><br><span class="line">          <span class="string">`overwritten whenever the provided component re-renders. `</span> +</span><br><span class="line">          <span class="string">`injection being mutated: "<span class="subst">$&#123;key&#125;</span>"`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    defineReactive(vm, key, result[key]) <span class="comment">// ! å®ä¾‹ä»£ç† key</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>Object.keys</code>è·å–<code>result</code>çš„<code>keys</code>çš„å€¼ï¼Œç„¶åä½¿ç”¨<code>forEach</code>éå†<code>keys</code>ï¼Œå†è°ƒç”¨<code>defineReactive</code>å‡½æ•°ä½¿å¾—å®ä¾‹å¯¹è±¡<code>vm</code>ä»£ç†<code>inject</code>ä¸Šçš„<code>key</code>å€¼ã€‚</p><p><strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œé€šè¿‡<code>defineReactive</code>å®šä¹‰çš„æ•°æ®å¹¶ä¸ä¼šå˜æˆå“åº”å¼æ•°æ®ã€‚å› ä¸ºå‰é¢å·²ç»æŠŠ<code>shouleObserve</code>å˜é‡è®¾ç½®ä¸º<code>false</code>äº†ã€‚ä½†æ˜¯å¦‚æœçˆ¶ç»„ä»¶çš„<code>provide</code>é€‰é¡¹æä¾›çš„å€¼æ˜¯ä¸€ä¸ªå“åº”å¼æ•°æ®ï¼Œé‚£ä¹ˆæ³¨å…¥çš„å€¼ä¹Ÿæ˜¯å“åº”å¼æ•°æ®ã€‚</p><p>å¦å¤–ï¼Œä¸èƒ½ä¿®æ”¹<code>inject</code>é€‰é¡¹ä¸­çš„å€¼ï¼Œå› ä¸ºå®ƒçš„å€¼æ¥æºäºçˆ¶ç»„ä»¶ï¼Œæœ‰ç‚¹ç±»ä¼¼äº<code>props</code>å±æ€§ã€‚å¦‚æœä¿®æ”¹äº†<code>inject</code>çš„å€¼åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p><strong>åˆ°è¿™é‡Œï¼ŒVue çš„åˆå§‹åŒ–å°±æš‚æ—¶å‘Šä¸€ä¸ªæ®µè½äº†</strong>ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å†æ¬¡å›åˆ°&lt;code&gt;initState&lt;/code&gt;å‡½æ•°ä¸­ï¼Œå…¶ä¸­&lt;code&gt;data&lt;/code&gt;ã€&lt;code&gt;watch&lt;/code&gt;ã€&lt;code&gt;computed&lt;/code&gt;å’Œ&lt;code&gt;props&lt;/code&gt;é€‰é¡¹çš„åˆå§‹åŒ–éƒ½å·²è®²è§£ï¼Œä¸‹é¢è¿˜å‰©ä¸‹&lt;code&gt;methods&lt;/code&gt;é€‰é¡¹çš„åˆå§‹åŒ–æœªè®²è§£ã€‚çœ‹ä¸‹é¢çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opts.methods) initMethods(vm, opts.methods)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é€šè¿‡è°ƒç”¨&lt;code&gt;initMethods&lt;/code&gt;å‡½æ•°åˆå§‹åŒ–&lt;code&gt;methods&lt;/code&gt;é€‰é¡¹ï¼Œè¿˜éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡&lt;code&gt;vm&lt;/code&gt;å’Œåˆå¹¶é€‰é¡¹åçš„&lt;code&gt;methods&lt;/code&gt;å±æ€§ã€‚&lt;/p&gt;
&lt;h2 id=&quot;initMethods&quot;&gt;&lt;a href=&quot;#initMethods&quot; class=&quot;headerlink&quot; title=&quot;initMethods&quot;&gt;&lt;/a&gt;&lt;code&gt;initMethods&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;ä¸‹é¢çœ‹ä¸‹&lt;code&gt;initMethods&lt;/code&gt; å‡½æ•°çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; props = vm.$options.props&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; key &lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; methods) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;//...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å£°æ˜å¸¸é‡&lt;code&gt;props&lt;/code&gt;å­˜å‚¨åˆå¹¶é€‰é¡¹åçš„&lt;code&gt;props&lt;/code&gt;é€‰é¡¹ï¼Œè¿™ä¸ªå¸¸é‡åœ¨åé¢ä¼šç”¨åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæ¥ä¸‹æ¥å°±æ˜¯ä¸€ä¸ª&lt;code&gt;for&lt;/code&gt;å¾ªç¯è¯­å¥ï¼Œéå†&lt;code&gt;methods&lt;/code&gt;é€‰é¡¹ï¼Œä¸‹é¢çœ‹ä¸‹&lt;code&gt;for&lt;/code&gt;å¾ªç¯è¯­å¥é‡Œé¢çš„å†…å®¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹Props</title>
    <link href="https://haledeng.com/blog/20190928-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BProps/"/>
    <id>https://haledeng.com/blog/20190928-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BProps/</id>
    <published>2019-09-28T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:26.102Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢ç« èŠ‚é€šè¿‡åˆå§‹åŒ–<code>data</code>é€‰é¡¹çš„<code>initData</code>å‡½æ•°è®²è§£äº† Vue çš„å“åº”å¼ç³»ç»Ÿã€‚</p><p>ä¸‹é¢ç»§ç»­è®²è§£<code>props</code>é€‰é¡¹çš„åˆå§‹åŒ–ã€‚</p><h2 id="propsçš„åˆå§‹åŒ–"><a href="#propsçš„åˆå§‹åŒ–" class="headerlink" title="propsçš„åˆå§‹åŒ–"></a><code>props</code>çš„åˆå§‹åŒ–</h2><p>å›åˆ°<code>initState</code>å‡½æ•°ï¼ŒæŸ¥çœ‹åˆå§‹åŒ–<code>props</code>é€‰é¡¹çš„ä»£ç ï¼Œåœ¨<code>core/instance/state.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨<code>initProps</code>å‡½æ•°åˆå§‹åŒ–<code>props</code>é€‰é¡¹ï¼Œè¿˜éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡<code>vm</code>å’Œåˆå¹¶é€‰é¡¹åçš„<code>props</code>å±æ€§ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>initProps</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initProps</span>(<span class="params">vm: Component, propsOptions: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.$options.propsData || &#123;&#125; <span class="comment">// ! è·å– props æ•°æ®æ¥æº</span></span><br><span class="line">  <span class="keyword">const</span> props = (vm._props = &#123;&#125;)</span><br><span class="line">  <span class="comment">// cache prop keys so that future props updates can iterate using Array</span></span><br><span class="line">  <span class="comment">// instead of dynamic object key enumeration.</span></span><br><span class="line">  <span class="keyword">const</span> keys = (vm.$options._propKeys = [])</span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.$parent</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>propsData</code>å­˜å‚¨<code>vm.$options.propsData</code>å±æ€§ï¼Œè¿™æ˜¯å¤–ç•Œä¼ è¿›æ¥çš„<code>props</code>æ•°æ®ã€‚</p><a id="more"></a><p>å£°æ˜å¸¸é‡<code>props</code>å­˜å‚¨å®ä¾‹å¯¹è±¡çš„<code>vm._props</code>å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºå¯¹è±¡ï¼Œè¿™ä¸ªå±æ€§ç”¨æ¥å­˜å‚¨åˆå§‹åŒ–å<code>props</code>çš„å€¼ã€‚</p><p>å£°æ˜å¸¸é‡<code>keys</code>å­˜å‚¨<code>vm.$options._propsKeys</code>å±æ€§ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„ï¼Œè¿™æ˜¯<code>props</code>çš„<code>key</code>ç»„æˆçš„æ•°ç»„ã€‚</p><p>å£°æ˜å¸¸é‡<code>isRoot</code>å­˜å‚¨è¡¨è¾¾å¼<code>!vm.$parent</code>çš„å€¼ï¼Œå¦‚æœå€¼ä¸º<code>true</code>ï¼Œè¡¨ç¤ºè¯¥ç»„ä»¶æ˜¯æ ¹ç»„ä»¶ï¼Œå› ä¸ºæ ¹ç»„ä»¶æ²¡æœ‰<code>$parent</code>å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œåªåˆ—å‡ºå‰é¢å’Œåé¢çš„ä»£ç ï¼Œä¸­é—´çš„ä»£ç æš‚æ—¶çœç•¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ä¸æ˜¯æ ¹ç»„ä»¶æ—¶ï¼Œä¸è¿›è¡Œç›‘å¬ï¼Œå› ä¸ºå¯èƒ½ä¼ è¿‡æ¥çš„å¼•ç”¨ç±»å‹çš„å€¼å·²ç»æ˜¯å“åº”å¼æ•°æ®</span></span><br><span class="line"><span class="keyword">if</span> (!isRoot) &#123;</span><br><span class="line">  toggleObserving(<span class="literal">false</span>) <span class="comment">// ! å…³é—­ç›‘å¬å¼€å…³ shouldObserve = false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">toggleObserving(<span class="literal">true</span>) <span class="comment">// ! å¼€å¯ç›‘å¬å¼€å…³ shouldObserve = true</span></span><br></pre></td></tr></table></figure><p><code>toggleObserving</code>å‡½æ•°å‰é¢å·²ç»è®²è§£è¿‡äº†ï¼Œæ˜¯æ§åˆ¶å˜é‡<code>shouldObserve</code>çš„å€¼çš„å‡½æ•°ï¼Œè€Œå˜é‡<code>shouldObserve</code>åˆæ˜¯åˆ›å»ºç›‘å¬å™¨å¯¹è±¡çš„å…³é”®å‚æ•°ï¼Œæ˜¯<code>observe</code>å‡½æ•°ä¸­åˆ›å»ºç›‘å¬å™¨å¯¹è±¡çš„äº”ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€ã€‚</p><p>è¿™é‡Œå…ˆè®¾ç½®<code>shouldObserve</code>ä¸º<code>false</code>ï¼Œæœ€åæŠŠå®ƒçš„å€¼é‡ç½®ä¸º<code>true</code>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹ä¸­é—´çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">  keys.push(key)</span><br><span class="line">  <span class="keyword">const</span> value = validateProp(key, propsOptions, propsData, vm) <span class="comment">// ! æ ¡éªŒ props</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸­é—´ä»£ç æ˜¯ä¸€ä¸ª<code>for</code>å¾ªç¯è¯­å¥ï¼Œéå†çš„æ˜¯é€šè¿‡å‚æ•°ä¼ è¿›æ¥çš„åˆå¹¶é€‰é¡¹åçš„<code>props</code>é€‰é¡¹ã€‚åœ¨éå†çš„è¿‡ç¨‹ä¸­æŠŠ<code>key</code>å€¼éƒ½æ”¾å…¥ä¸Šé¢å®šä¹‰çš„<code>keys</code>æ•°ç»„ä¸­ã€‚</p><p>å£°æ˜å˜é‡<code>value</code>å­˜å‚¨<code>validateProp</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œ<code>validateProp</code>å‡½æ•°æ˜¯æ£€éªŒ<code>props</code>ä¼ å…¥å€¼çš„å‡½æ•°ï¼Œè¿”å›å€¼æ˜¯éªŒè¯åçš„<code>prop</code>çš„å€¼ï¼Œåé¢å†è¯¦ç»†è®²è§£ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hyphenatedKey = hyphenate(key)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! prop çš„åå­—æ˜¯ä¿ç•™çš„å±æ€§ï¼Œå‘å‡ºè­¦å‘Š</span></span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    isReservedAttribute(hyphenatedKey) ||</span><br><span class="line">    config.isReservedAttr(hyphenatedKey)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`"<span class="subst">$&#123;hyphenatedKey&#125;</span>" is a reserved attribute and cannot be used as component prop.`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå£°æ˜å¸¸é‡<code>hyphenatedKey</code>å­˜å‚¨é€šè¿‡<code>hyphenate</code>å‡½æ•°æŠŠ<code>key</code>å€¼è½¬æ¢æˆè¿å­—ç¬¦å’Œå°å†™å­—æ¯çš„å½¢å¼çš„å€¼ï¼Œç„¶åå†åˆ¤æ–­è¿™ä¸ªå€¼æ˜¯å¦æ˜¯å†…ç½®çš„å±æ€§åï¼Œå¦‚æœæ˜¯çš„è¯ä¼šå‘å‡ºè­¦å‘Šã€‚</p><p>çœ‹ä¸‹<code>hyphenate</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°æŠŠé©¼å³°å½¢å¼çš„å˜é‡è½¬æ¢æˆè¿å­—ç¬¦å½¢å¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hyphenateRE = <span class="regexp">/\B([A-Z])/g</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> hyphenate = cached((str: string): <span class="function"><span class="params">string</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> str.replace(hyphenateRE, <span class="string">'-$1'</span>).toLowerCase()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> key = <span class="string">'propName'</span></span><br><span class="line">hyphenate(key) <span class="comment">// 'prop-name'</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å®šä¹‰ props çš„å±æ€§ï¼Œä¸æ˜¯å“åº”å¼</span></span><br><span class="line">defineReactive(props, key, value, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!isRoot &amp;&amp; !isUpdatingChildComponent) &#123;</span><br><span class="line">    <span class="comment">// ! ç»„ä»¶ç›´æ¥ä¿®æ”¹ props å±æ€§ï¼Œå‘å‡ºè­¦å‘Š</span></span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Avoid mutating a prop directly since the value will be `</span> +</span><br><span class="line">        <span class="string">`overwritten whenever the parent component re-renders. `</span> +</span><br><span class="line">        <span class="string">`Instead, use a data or computed property based on the prop's `</span> +</span><br><span class="line">        <span class="string">`value. Prop being mutated: "<span class="subst">$&#123;key&#125;</span>"`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨<code>defineReactive</code>å‡½æ•°æŠŠ<code>props</code>å¯¹è±¡ä¸‹é¢çš„<code>key</code>å€¼å®šä¹‰æˆ<code>value</code>å€¼ï¼Œ<code>props</code>ä¹Ÿå°±æ˜¯å®ä¾‹å¯¹è±¡çš„<code>_props</code>å±æ€§ï¼Œå®ƒä»¬éƒ½æ˜¯æ¥è‡ªåŒä¸€ä¸ªå¼•ç”¨ã€‚</p><p>å¦å¤–ï¼Œè¿˜ä¼ å…¥ç¬¬å››ä¸ªå‚æ•°<code>customSetter</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨æ˜¯ï¼Œåœ¨ä¸æ˜¯æ ¹ç»„ä»¶æˆ–è€…ä¸æ˜¯æ›´æ–°å­ç»„ä»¶çš„æ—¶å€™ï¼Œå¦‚æœä¿®æ”¹äº†<code>props</code>çš„å±æ€§ä¼šå‘å‡ºè­¦å‘Šã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ! å®šä¹‰ props çš„å±æ€§</span></span><br><span class="line">  <span class="comment">// ! å› ä¸º shouldObserve = false, ä¸ä¼šå˜æˆå“åº”å¼</span></span><br><span class="line">  defineReactive(props, key, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å›åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œè¿˜æ˜¯ä½¿ç”¨<code>defineReactive</code>å‡½æ•°æŠŠ<code>props</code>å¯¹è±¡ä¸‹é¢çš„<code>key</code>å€¼å®šä¹‰æˆ<code>value</code>å€¼ã€‚</p><p>å› ä¸ºåœ¨<code>for</code>å¾ªç¯ä¹‹å‰å› ä¸ºæŠŠ<code>shouldObserve</code>çš„å€¼è®¾ç½®ä¸º<code>false</code>ï¼Œæ‰€ä»¥<code>defineReactive</code>å‡½æ•°æ˜¯ä¸ä¼šæŠŠ<code>props</code>çš„æ•°æ®å˜æˆå“åº”æ€§æ•°æ®çš„ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå› ä¸ºä¼ è¿‡æ¥çš„<code>props</code>å€¼ä¸€èˆ¬éƒ½æ˜¯å“åº”å¼æ•°æ®ï¼Œè¿™é‡Œå°±ä¸éœ€è¦å®šä¹‰äº†ã€‚</p><p>å†çœ‹ä¸‹<code>for</code>å¾ªç¯ä¸­çš„å‰©ä¸‹çš„æœ€åä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">  proxy(vm, <span class="string">`_props`</span>, key) <span class="comment">// ! ä»£ç† props ä¸Šçš„å±æ€§ vm.xxx = vm._props.xxx</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>proxy</code>å‡½æ•°æŠŠ<code>props</code>çš„æ•°æ®ä»£ç†åˆ°å®ä¾‹å¯¹è±¡ä¸­ï¼Œè¿™å’Œ<code>initData</code>å‡½æ•°ä¸­çš„é€»è¾‘ä¸€æ ·ã€‚</p><p>åˆ°è¿™é‡Œï¼Œ<code>props</code>é€‰é¡¹çš„åˆå§‹åŒ–å°±å·²ç»å®Œæˆã€‚ä¸‹é¢çœ‹ä¸‹<code>props</code>çš„å±æ€§æ˜¯æ€ä¹ˆéªŒè¯çš„ã€‚</p><h2 id="Props-çš„æ ¡éªŒ"><a href="#Props-çš„æ ¡éªŒ" class="headerlink" title="Props çš„æ ¡éªŒ"></a><code>Props</code> çš„æ ¡éªŒ</h2><p>åœ¨åˆå§‹åŒ–<code>props</code>é€‰é¡¹æ—¶ï¼Œä½¿ç”¨<code>for</code>å¾ªç¯è¯­å¥éå†<code>props</code>é€‰é¡¹ï¼Œåœ¨æ¯æ¬¡å¾ªç¯æ—¶éƒ½ä¼šè°ƒç”¨<code>validateProp</code>å‡½æ•°éªŒè¯å¤–ç•Œä¼ è¿‡æ¥çš„å€¼æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">  keys.push(key)</span><br><span class="line">  <span class="keyword">const</span> value = validateProp(key, propsOptions, propsData, vm) <span class="comment">// ! æ ¡éªŒ props</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹<code>validateProp</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/util/props.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">validateProp</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  propOptions: Object, <span class="regexp">//</span> ! åˆå¹¶åçš„ props é€‰é¡¹</span></span></span><br><span class="line"><span class="function"><span class="params">  propsData: Object, <span class="regexp">//</span> ! æ•°æ®æ¥æºå¯¹è±¡</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹å‡½æ•°çš„å››ä¸ªå‚æ•°</p><ol><li><code>key</code>ï¼šéå†åˆå¹¶é€‰é¡¹åçš„<code>props</code>é€‰é¡¹çš„<code>key</code>ã€‚</li><li><code>propOptions</code>ï¼šåˆå¹¶é€‰é¡¹åçš„<code>props</code>é€‰é¡¹ã€‚</li><li><code>propsData</code>ï¼šå¤–ç•Œä¼ è¿›æ¥çš„<code>props</code>æ•°æ®ã€‚</li><li><code>vm</code>ï¼šå®ä¾‹å¯¹è±¡ï¼Œè¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚</li></ol><p>ç„¶åçœ‹ä¸‹å‡½æ•°çš„ä»£ç ï¼Œå…ˆçœ‹å‰é¢éƒ¨åˆ†çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> prop = propOptions[key] <span class="comment">// ! è·å–å®šä¹‰çš„ prop çš„å±æ€§åŒ…æ‹¬ type é»˜è®¤å€¼ç­‰</span></span><br><span class="line"><span class="keyword">const</span> absent = !hasOwn(propsData, key) <span class="comment">// ! å¤–ç•Œæ²¡æœ‰ä¼ å€¼è¿›æ¥</span></span><br><span class="line"><span class="keyword">let</span> value = propsData[key] <span class="comment">// ! è·å–ä¼ è¿›æ¥çš„å€¼</span></span><br><span class="line"><span class="comment">// boolean casting</span></span><br><span class="line"><span class="keyword">const</span> booleanIndex = getTypeIndex(<span class="built_in">Boolean</span>, prop.type) <span class="comment">// ! è·å– Boolean ç±»å‹çš„ç´¢å¼•</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>prop</code>å­˜å‚¨ç”¨æˆ·å®šä¹‰çš„<code>pros</code>å±æ€§ï¼Œé‡Œé¢åŒ…æ‹¬ç±»å‹<code>type</code>ã€é»˜è®¤å€¼<code>default</code>ã€æ˜¯å¦ä¼ å€¼<code>required</code>ç­‰ã€‚å£°æ˜å¸¸é‡<code>absent</code>å­˜å‚¨è¡¨è¾¾å¼<code>!hasOwn(propsData, key)</code>çš„å€¼ï¼Œå½“è¡¨è¾¾å¼è¾“å‡ºçš„å€¼æ˜¯<code>ture</code>æ—¶ï¼Œè¡¨ç¤ºå¤–ç•Œæ²¡æœ‰ä¼ å€¼è¿›æ¥ã€‚å£°æ˜å˜é‡<code>value</code>å­˜å‚¨å¤–ç•Œä¼ å…¥çš„å€¼ã€‚å£°æ˜å¸¸é‡<code>booleanIndex</code>å­˜å‚¨é€šè¿‡è°ƒç”¨<code>getTypeIndex</code>å‡½æ•°è·å–åˆ°çš„ç±»å‹çš„ç´¢å¼•ã€‚</p><h3 id="getTypeIndex"><a href="#getTypeIndex" class="headerlink" title="getTypeIndex"></a><code>getTypeIndex</code></h3><p>ä¸‹é¢çœ‹ä¸‹<code>getTypeIndex</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°è·å–ç±»å‹åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–åŒ¹é…çš„ç±»å‹ç´¢å¼•ã€‚å¦‚æœå€¼å¤§äº -1 æ—¶ï¼Œè¯´æ˜åŒ¹é…åˆ°äº†å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTypeIndex</span>(<span class="params">type, expectedTypes</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ! æœŸæœ›çš„ç±»å‹ä¸æ˜¯æ•°ç»„æ—¶ï¼Œç›´æ¥æ¯”è¾ƒï¼Œæ˜¯ç›¸åŒç±»å‹è¿”å› 0ï¼Œä¸æ˜¯è¿”å› 1</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(expectedTypes)) &#123;</span><br><span class="line">    <span class="keyword">return</span> isSameType(expectedTypes, type) ? <span class="number">0</span> : <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! æœŸæœ›çš„ç±»å‹æ˜¯æ•°ç»„æ—¶ï¼Œéœ€è¦éå†ï¼Œç„¶åä¸€ä¸€æ¯”è¾ƒï¼Œè¿”å›åŒ¹é…çš„ç±»å‹åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œå¦‚æœéƒ½æ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å› -1</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = expectedTypes.length; i &lt; len; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSameType(expectedTypes[i], type)) &#123;</span><br><span class="line">      <span class="keyword">return</span> i</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å‚æ•°æ˜¯ç±»å‹<code>type</code>å’Œç”¨æˆ·å®šä¹‰ï¼ˆæœŸæœ›ï¼‰çš„ç±»å‹<code>expectedTypes</code>ã€‚</p><p>é¦–å…ˆåˆ¤æ–­æœŸæœ›çš„ç±»å‹æ˜¯ä¸æ˜¯æ•°ç»„ï¼Œå¦‚æœä¸æ˜¯æ•°ç»„ï¼Œé€šè¿‡<code>isSameType</code>å‡½æ•°è¿›è¡Œæ¯”è¾ƒï¼Œç¡®è®¤å®ƒä»¬çš„ç±»å‹æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒï¼Œè¿”å›å€¼æ˜¯<code>0</code>ã€‚å¦‚æœä¸ç›¸åŒï¼Œè¿”å›å€¼æ˜¯<code>-1</code>ã€‚å¦‚æœæœŸæœ›çš„ç±»å‹æ˜¯æ•°ç»„ï¼Œéœ€è¦éå†æ•°ç»„ï¼Œç„¶åæŠŠæ•°ç»„ä¸­çš„æ¯ä¸ªæœŸæœ›ç±»å‹å’Œä¼ å…¥çš„ç±»å‹è¿›è¡Œæ¯”è¾ƒï¼Œåé¢è¯¦ç»†è®²è§£ã€‚</p><p><code>props</code>å®šä¹‰çš„ç±»å‹çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">Number</span></span><br><span class="line">  &#125;,</span><br><span class="line">  msg: &#123;</span><br><span class="line">    type: [<span class="built_in">String</span>, <span class="built_in">Number</span>, <span class="built_in">Boolean</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹<code>isSameType</code>å‡½æ•°æ˜¯æ€ä¹ˆæ¯”è¾ƒçš„ï¼ŒæŸ¥çœ‹å®ƒçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆ¤æ–­ç±»å‹æ˜¯å¦ç›¸åŒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isSameType</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> getType(a) === getType(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– type çš„å­—ç¬¦ä¸²ç±»å‹çš„å€¼ï¼Œæ¯”å¦‚ String =&gt; 'String'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getType</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> match = fn &amp;&amp; fn.toString().match(<span class="regexp">/^\s*function (\w+)/</span>)</span><br><span class="line">  <span class="keyword">return</span> match ? match[<span class="number">1</span>] : <span class="string">''</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isSameType</code>å‡½æ•°é€šè¿‡è°ƒç”¨<code>getType</code>å‡½æ•°è·å–<code>type</code>å­—ç¬¦ä¸²ç±»å‹çš„å€¼ï¼Œç„¶ååˆ¤æ–­å®ƒä»¬æ˜¯å¦å…¨ç­‰ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹<code>getType</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒçš„ä½œç”¨æ˜¯è·å–ç±»å‹çš„å€¼ï¼ŒJavaScript çš„ç±»å‹ï¼ˆå¤§å†™çš„ï¼‰çš„å€¼éƒ½æ˜¯ç±»ï¼Œä¹Ÿå°±æ˜¯æ„é€ å‡½æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å€¼ã€‚è¿™é‡ŒåŒ¹é…å‡ºå‡½æ•°å­—ç¬¦ä¸²åŒ–åçš„åç§°ï¼Œå¦‚æœåŒ¹é…åˆ°çš„è¯ï¼Œè¿”å›è¿™ä¸ªå‡½æ•°åï¼›å¦‚æœåŒ¹é…ä¸åˆ°è¿”å›ç©ºå­—ç¬¦ä¸²ã€‚æ¯”å¦‚<code>String</code>ç±»å‹ä¼šè¿”å›<code>String</code>å­—ç¬¦ä¸²ç±»å‹çš„å€¼ã€‚</p><p>è¿™é‡Œä¸ºä»€ä¹ˆè¦<code>type</code>æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„åç§°å‘¢ï¼Ÿå› ä¸ºåœ¨ä¸€äº›æµè§ˆå™¨ä¸­ï¼Œä¸åŒ<code>iframes</code>ä¹‹é—´çš„ç›¸åŒç±»å‹çš„æ„é€ å‡½æ•°åç§°æ˜¯ä¸åŒçš„ã€‚</p><p>ç»§ç»­å›åˆ°<code>getTypeIndex</code>å‡½æ•°ï¼Œçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æœŸæœ›çš„ç±»å‹æ˜¯æ•°ç»„æ—¶ï¼Œéœ€è¦éå†ï¼Œç„¶åä¸€ä¸€æ¯”è¾ƒï¼Œè¿”å›åŒ¹é…çš„ç±»å‹åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment">// ! å¦‚æœéƒ½æ²¡æœ‰åŒ¹é…åˆ°ï¼Œè¿”å› -1</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, len = expectedTypes.length; i &lt; len; i++) &#123;</span><br><span class="line">  <span class="keyword">if</span> (isSameType(expectedTypes[i], type)) &#123;</span><br><span class="line">    <span class="keyword">return</span> i</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæœŸæœ›çš„ç±»å‹å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ç±»å‹ï¼Œéœ€è¦éå†æ•°ç»„ï¼Œè·å–åˆ°æ•°ç»„çš„æ¯ä¸ªç±»å‹ï¼Œç„¶åè¿™äº›ç±»å‹å’Œä¼ å…¥çš„ç±»å‹çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‘ç°å®ƒä»¬å…¨ç­‰ï¼Œå°±è¿”å›æœŸæœ›çš„ç±»å‹åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ã€‚å¦‚æœéå†ä¹‹åæ²¡æœ‰å‘ç°å€¼å…¨ç­‰çš„ï¼Œè¿”å›å€¼æ˜¯<code>-1</code>ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>getTypeIndex</code>å‡½æ•°å°±æ˜¯è¾“å…¥ä¸€ä¸ªç±»å‹ï¼Œç„¶åæ‹¿è¿™ä¸ªç±»å‹çš„å€¼å’ŒæœŸæœ›çš„ç±»å‹çš„å€¼ï¼ˆç”¨æˆ·å®šä¹‰çš„ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œçœ‹è¿™ä¸ªç±»å‹æ˜¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç±»å‹ï¼ˆå®ƒä»¬çš„å€¼å…¨ç­‰ï¼‰ï¼Œæˆ–è€…è¿™ä¸ªç±»å‹æ˜¯ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ç±»å‹ä¹‹ä¸€ï¼ˆåŒ…å«åœ¨æœŸæœ›çš„ç±»å‹ä¸­ï¼‰ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œè¿”å›ä¸€ä¸ªå¤§äº<code>-1</code>çš„å€¼ã€‚</p><p>äº†è§£äº†<code>getTypeIndex</code>å‡½æ•°çš„ä½œç”¨åï¼Œç»§ç»­çœ‹<code>validateProp</code>å‡½æ•°ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ä¼˜å…ˆéªŒè¯ Boolean ç±»å‹çš„å€¼</span></span><br><span class="line"><span class="keyword">if</span> (booleanIndex &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">  <span class="comment">// ! å¤–ç•Œæ²¡æœ‰ä¼ å€¼ï¼Œä¸”æ²¡æœ‰é»˜è®¤å€¼ï¼Œ</span></span><br><span class="line">  <span class="keyword">if</span> (absent &amp;&amp; !hasOwn(prop, <span class="string">'default'</span>)) &#123;</span><br><span class="line">    value = <span class="literal">false</span> <span class="comment">// ! å€¼ä¸º false</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (value === <span class="string">''</span> || value === hyphenate(key)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼˜å…ˆéªŒè¯ <code>Boolean</code>ç±»å‹çš„å€¼ï¼Œå³ä¼˜å…ˆå¤„ç†æ˜¯å¸ƒå°”å€¼æ•°æ®çš„ç±»å‹ï¼Œä¹Ÿå°±æ˜¯<code>booleanIndex</code>å¤§äº<code>-1</code>æ—¶ã€‚</p><p>é¦–å…ˆåˆ¤æ–­å¤–ç•Œæœ‰æ²¡æœ‰ä¼ å…¥å€¼ä¸”å®ƒæœ‰æ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œå¦‚æœå¤–ç•Œæ²¡æœ‰ä¼ å…¥å€¼ï¼Œç„¶åå®ƒåˆæ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ª<code>prop</code>æ•°æ®<code>value</code>è®¾ä¸º<code>false</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">propsData: &#123;</span><br><span class="line">  <span class="comment">// ... å¤–ç•Œæ²¡æœ‰ä¼ å€¼</span></span><br><span class="line">&#125;</span><br><span class="line">props: &#123;</span><br><span class="line">  propName: &#123;</span><br><span class="line">    type: <span class="built_in">Boolean</span> <span class="comment">// åªè®¾ç½®äº† Booleanï¼Œæ²¡æœ‰è®¾ç½®é»˜è®¤å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// result</span></span><br><span class="line">propName: <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¤–ç•Œä¼ å…¥ç©ºå­—ç¬¦ä¸² æˆ–è€… åå­—ç”±é©¼å³°è½¬è¿å­—ç¬¦åä¸å€¼ä¸ºç›¸åŒå­—ç¬¦ä¸² (someProp="some-prop)</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (value === <span class="string">''</span> || value === hyphenate(key)) &#123;</span><br><span class="line">  <span class="comment">// only cast empty string / same name to boolean if</span></span><br><span class="line">  <span class="comment">// boolean has higher priority</span></span><br><span class="line">  <span class="keyword">const</span> stringIndex = getTypeIndex(<span class="built_in">String</span>, prop.type) <span class="comment">// ! è·å– String ç±»å‹çš„ç´¢å¼•</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! æ²¡æœ‰å®šä¹‰ String ç±»å‹</span></span><br><span class="line">  <span class="comment">// ! æˆ–è€… Boolean ç±»å‹çš„ç´¢å¼•æ’åœ¨ String ç±»å‹çš„ç´¢å¼•å‰ (ç±»å‹æ˜¯æ•°ç»„æ—¶ [Boolean String]))</span></span><br><span class="line">  <span class="keyword">if</span> (stringIndex &lt; <span class="number">0</span> || booleanIndex &lt; stringIndex) &#123;</span><br><span class="line">    value = <span class="literal">true</span> <span class="comment">// ! å€¼ä¸º true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¤–ç•Œä¼ å…¥çš„å€¼æ˜¯ä¸€ä¸ªç©ºçš„å­—ç¬¦ä¸²æˆ–è€…ä¼ å…¥çš„å€¼å’Œ<code>key</code>è½¬æ¢æˆè¿å­—ç¬¦çš„å½¢å¼åçš„å€¼ç›¸åŒæ—¶ï¼Œå…ˆçœ‹ä¸‹è¿™ä¸ª<code>prop</code>æ˜¯å¦è®¾ç½®äº†ç±»å‹æ˜¯<code>String</code>ï¼Œå°è¯•è·å–<code>stringIndex</code>åœ¨æœŸæœ›çš„æ•°ç»„ç±»å‹ä¸­çš„ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰è·å–åˆ°<code>stringIndex</code>ï¼ˆè¯´æ˜æ²¡æœ‰è®¾ç½®ï¼‰ï¼Œæˆ–è€…è·å–åˆ°äº†ä½†æ˜¯<code>booleanIndex</code>ç´¢å¼•åœ¨<code>stringIndex</code>ç´¢å¼•çš„å‰é¢æ—¶ï¼ŒæŠŠè¿™ä¸ª<code>prop</code>çš„å€¼<code>value</code>è®¾ç½®ä¸º<code>true</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">propsData: &#123;</span><br><span class="line">  <span class="comment">// propName: '' // ä¼ å€¼ä¸€ ä¼ è¿›æ¥çš„å€¼æ˜¯ç©ºå­—ç¬¦ä¸²</span></span><br><span class="line">  propName: <span class="string">'prop-name'</span> <span class="comment">// ä¼ å€¼äºŒ ä¼ è¿›æ¥çš„å€¼æ˜¯ 'prop-name'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">props: &#123;</span><br><span class="line">  propName: &#123;</span><br><span class="line">    <span class="comment">// type: Boolean // ç±»å‹ä¸€ æ²¡æœ‰è®¾ç½® String ç±»å‹</span></span><br><span class="line">    type: [<span class="built_in">Boolean</span>, <span class="built_in">String</span>] <span class="comment">// ç±»å‹äºŒ æ²¡æœ‰è®¾ç½® String ç±»å‹ï¼Œä½†æ˜¯ Boolean æ’åœ¨ String å‰é¢</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// result</span></span><br><span class="line">propName: <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// check default value</span></span><br><span class="line"><span class="comment">// ! å¤„ç† prop æœªä¼ å€¼çš„æƒ…å†µ</span></span><br><span class="line"><span class="keyword">if</span> (value === <span class="literal">undefined</span>) &#123;</span><br><span class="line">  value = getPropDefaultValue(vm, prop, key) <span class="comment">// ! è·å–é»˜è®¤å€¼(éå“åº”å¼)</span></span><br><span class="line">  <span class="comment">// since the default value is a fresh copy,</span></span><br><span class="line">  <span class="comment">// make sure to observe it.</span></span><br><span class="line">  <span class="keyword">const</span> prevShouldObserve = shouldObserve <span class="comment">// ! ç¼“å­˜åŸæ¥çš„å€¼</span></span><br><span class="line">  toggleObserving(<span class="literal">true</span>) <span class="comment">// ! ä¸ç®¡åŸæ¥ shouldObserve æ˜¯å¦ true, è¿™é‡Œéƒ½å…ˆè®¾ç½®ä¸º true</span></span><br><span class="line">  observe(shouldObserve) <span class="comment">// ! æŠŠé»˜è®¤å€¼è®¾ä¸ºå“åº”å¼</span></span><br><span class="line">  toggleObserving(prevShouldObserve) <span class="comment">// ! è¿˜åŸæˆåŸå…ˆçš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>value</code>æœªå®šä¹‰ï¼Œä¹Ÿå°±æ˜¯å¤–ç•Œæ²¡æœ‰ä¼ å€¼ï¼Œè°ƒç”¨<code>getPropDefaultValue</code>å‡½æ•°è·å–è®¾ç½®çš„é»˜è®¤å€¼å¹¶èµ‹å€¼ç»™<code>value</code>ã€‚</p><p>å…ˆä¸ç®¡<code>getPropDefaultValue</code>å‡½æ•°çš„é€»è¾‘ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><p>å£°æ˜å¸¸é‡<code>prevShouldObserve</code>ç¼“å­˜<code>shouldObserve</code>åŸå…ˆçš„å€¼ï¼Œç„¶åè°ƒç”¨<code>toggleObserving</code>å‡½æ•°æŠŠ<code>shouldObserve</code>çš„å€¼è®¾ç½®ä¸º<code>true</code>ã€‚ç„¶åè°ƒç”¨<code>observe</code>å‡½æ•°ç›‘å¬<code>value</code>ï¼ŒæŠŠå®ƒå˜æˆå“åº”å¼æ•°æ®ï¼Œæœ€åæŠŠ<code>shouldObserve</code>è¿˜åŸæˆåŸæ¥çš„å€¼ã€‚</p><p>è¿™é‡Œçš„é€»è¾‘å°±æ˜¯åœ¨å¤–ç•Œæ²¡æœ‰ä¼ å…¥å€¼ï¼Œä½†æ˜¯æœ‰è®¾ç½®é»˜è®¤å€¼æ—¶ï¼ŒæŠŠ<code>prop</code>çš„å€¼è®¾ç½®ä¸ºé»˜è®¤å€¼ã€‚</p><h3 id="getPropDefaultValue"><a href="#getPropDefaultValue" class="headerlink" title="getPropDefaultValue"></a><code>getPropDefaultValue</code></h3><p>ä¸‹é¢çœ‹ä¸‹<code>getPropDefaultValue</code>å‡½æ•°æ˜¯æ€ä¹ˆè·å–é»˜è®¤å€¼çš„ï¼ŒæŸ¥çœ‹å®ƒçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPropDefaultValue</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: ?Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  prop: PropOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// no default, return undefined</span></span><br><span class="line">  <span class="keyword">if</span> (!hasOwn(prop, <span class="string">'default'</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸‹<code>getPropDefaultValue</code>å‡½æ•°çš„ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯å®ä¾‹å¯¹è±¡<code>vm</code>ï¼Œå®šä¹‰çš„å±æ€§<code>prop</code>ï¼Œä»¥åŠåˆå¹¶é€‰é¡¹å<code>props</code>çš„<code>key</code>ã€‚</p><p>ä¸‹é¢çœ‹å‡½æ•°ä½“ä»£ç ï¼Œé¦–å…ˆåˆ¤æ–­å®šä¹‰çš„å±æ€§é‡Œé¢æœ‰æ²¡æœ‰è®¾ç½®é»˜è®¤å±æ€§<code>default</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå‡½æ•°è¿”å›<code>undefined</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å¤–ç•Œæ²¡æœ‰ä¼ å…¥å€¼åˆæ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œè¿™æ—¶<code>validateProp</code>å‡½æ•°ä¸‹é¢çš„ä»£ç æ˜¯æ— æ•ˆçš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">observe(value) <span class="comment">// observe(undefined) æ˜¯æ— æ•ˆçš„</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹<code>getPropDefaultValue</code>å‡½æ•°ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æœ‰è®¾ç½®é»˜è®¤å€¼çš„æ—¶å€™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> def = prop.default <span class="comment">// ! è·å–é»˜è®¤å€¼</span></span><br><span class="line"><span class="comment">// warn against non-factory defaults for Object &amp; Array</span></span><br><span class="line"><span class="comment">// ! å¯¹è±¡å’Œæ•°ç»„ç±»å‹çš„é»˜è®¤å€¼å¿…é¡»ä½¿ç”¨å‡½æ•°è¿”å›å€¼ï¼Œå¦åˆ™ä¼šæŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; isObject(def)) &#123;</span><br><span class="line">  warn(</span><br><span class="line">    <span class="string">'Invalid default value for prop "'</span> +</span><br><span class="line">      key +</span><br><span class="line">      <span class="string">'": '</span> +</span><br><span class="line">      <span class="string">'Props with type Object/Array must use a factory function '</span> +</span><br><span class="line">      <span class="string">'to return the default value.'</span>,</span><br><span class="line">    vm</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>def</code>å­˜å‚¨<code>prop.default</code>çš„å€¼ï¼Œå³é»˜è®¤å€¼ã€‚</p><p>ç„¶ååœ¨éç”Ÿäº§ç¯å¢ƒä¸‹åˆ¤æ–­<code>def</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªé<code>null</code>é<code>undefined</code>çš„æ™®é€šå¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯æŠ¥é”™ï¼Œæç¤ºå¯¹è±¡å’Œæ•°ç»„ç±»å‹çš„<code>prop</code>çš„é»˜è®¤å€¼å¿…é¡»ä½¿ç”¨å‡½æ•°çš„è¿”å›å€¼ã€‚å› ä¸º<code>prop</code>çš„é»˜è®¤å€¼åªèƒ½æ˜¯åŸå§‹ç±»å‹æˆ–è€…å‡½æ•°ç±»å‹ã€‚</p><p>å®ä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">props: &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'Hale'</span></span><br><span class="line">  &#125;,</span><br><span class="line">  info: &#123;</span><br><span class="line">    type: <span class="built_in">Object</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  vm &amp;&amp;</span><br><span class="line">  vm.$options.propsData &amp;&amp;</span><br><span class="line">  vm.$options.propsData[key] === <span class="literal">undefined</span> &amp;&amp; <span class="comment">// ! æ­¤æ—¶ï¼Œå¤–ç•Œè¿˜æ²¡ä¼ å€¼</span></span><br><span class="line">  vm._props[key] !== <span class="literal">undefined</span> <span class="comment">// ! å·²ç»å®šä¹‰é undefined çš„é»˜è®¤å€¼</span></span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">return</span> vm._props[key] <span class="comment">// ! è¿”å›ä¸Šæ¬¡çš„é»˜è®¤å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šä¸€æ¬¡æ•°ç»„æ›´æ–°æˆ–è€…åˆ›å»ºæ—¶å¤–ç•Œæ²¡æœ‰ç»™è¯¥ç»„ä»¶ä¼ å€¼ä¸”ç»„ä»¶å­˜åœ¨é<code>undefined</code>çš„é»˜è®¤å€¼æ—¶ï¼Œè¿”å›ä¹‹å‰çš„å€¼ï¼ˆé»˜è®¤å€¼ï¼‰ï¼Œè€Œä¸ç”¨é‡æ–°å†å»è·å–ã€‚</p><p>è¿™æ ·å¯ä»¥é¿å…è§¦å‘æ— æ„ä¹‰çš„å“åº”ï¼Œå› ä¸ºé»˜è®¤å€¼å¦‚æœæ˜¯ä¸€ä¸ªé€šè¿‡å‡½æ•°åˆ›å»ºçš„å¯¹è±¡ï¼Œé‚£ä¹ˆæ¯æ¬¡éƒ½ä¼šé‡æ–°è·å–æ–°ç”Ÿæˆçš„å¯¹è±¡ï¼Œè™½ç„¶å¯¹è±¡çš„å¼•ç”¨å’Œä»¥å‰çš„ä¸ä¸€æ ·ï¼Œä½†æ˜¯å®ƒä»¬çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·å¯¼è‡´é¡µé¢ä¹Ÿæ²¡æœ‰å˜åŒ–ã€‚æ‰€ä»¥æ¯æ¬¡éƒ½å»è·å–æ–°çš„å¼•ç”¨ç±»å‹çš„é»˜è®¤å€¼å°±æ²¡æœ‰ä»»ä½•æ„ä¹‰ï¼Œè€Œä¸”è¿˜ä¼šæŸè€—æ€§èƒ½ã€‚</p><p>ç»§ç»­çœ‹<code>getPropDefaultValue</code>å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! é»˜è®¤å€¼æ˜¯å‡½æ•°ç±»å‹ï¼Œä½†æ˜¯è¦æ±‚çš„ç±»å‹ä¸ä¸º Functionï¼ˆç±»å‹æ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡ï¼‰ æ—¶éœ€è¦æ±‚å€¼</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">typeof</span> def === <span class="string">'function'</span> &amp;&amp; getType(prop.type) !== <span class="string">'Function'</span></span><br><span class="line">  ? def.call(vm)</span><br><span class="line">  : def</span><br></pre></td></tr></table></figure><p>å¦‚æœé»˜è®¤å€¼æ˜¯å‡½æ•°ç±»å‹ï¼Œä½†æ˜¯å®ƒæœŸæœ›çš„ç±»å‹ä¸æ˜¯<code>Function</code>ç±»å‹ï¼Œè¯´æ˜è¿™æ˜¯æ•°ç»„æˆ–è€…å¯¹è±¡çš„é»˜è®¤å€¼ï¼Œéœ€è¦å¯¹é»˜è®¤çš„å‡½æ•°è¿›è¡Œæ±‚å€¼è·å–è¿”å›çš„å€¼ã€‚</p><p>å¦‚æœé»˜è®¤å€¼æ˜¯å‡½æ•°ç±»å‹ï¼Œè€Œå®ƒè¦æ±‚çš„ç±»å‹ä¹Ÿæ˜¯<code>Funtion</code>ç±»å‹ï¼Œè¯´æ˜è¿™ä¸ª<code>prop</code>çš„ç±»å‹å°±æ˜¯å‡½æ•°å‡½æ•°ï¼Œä¸éœ€è¦å¯¹é»˜è®¤å€¼å‡½æ•°è¿›è¡Œæ±‚å€¼ã€‚</p><p>å›åˆ°<code>validateProp</code>å‡½æ•°ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éªŒè¯ç±»å‹ï¼Œåªæœ‰åœ¨éç”Ÿäº§ç¯å¢ƒè¿›è¡Œï¼Œä¸”è·³è¿‡ WEEX ç¯å¢ƒçš„æŸç§åˆ¤æ–­</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">  <span class="comment">// skip validation for weex recycle-list child component props</span></span><br><span class="line">  !(__WEEX__ &amp;&amp; isObject(value) &amp;&amp; <span class="string">'@binding'</span> <span class="keyword">in</span> value)</span><br><span class="line">) &#123;</span><br><span class="line">  assertProp(prop, key, value, vm, absent)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> value</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¸”åœ¨<code>WEEX</code>çš„æŸç§ç¯å¢ƒä¸­ï¼Œä½¿ç”¨<code>assertProp</code>å‡½æ•°éªŒè¯<code>prop</code>çš„ç±»å‹ã€‚</p><p>è¿™é‡Œæ‰æ˜¯çœŸæ­£å¼€å§‹æ ¡éªŒ<code>prop</code>çš„ç±»å‹ã€‚å‰é¢çš„ä»£ç éƒ½ä¸ç®—éªŒè¯ç±»å‹ï¼Œåªæ˜¯åœ¨<code>prop</code>æ˜¯å¸ƒå°”ç±»å‹æ—¶ï¼Œè®¾ç½®åˆç†çš„å¸ƒå°”å€¼ä»¥åŠè·å–<code>prop</code>çš„é»˜è®¤å€¼ã€‚</p><h3 id="assertProp"><a href="#assertProp" class="headerlink" title="assertProp"></a><code>assertProp</code></h3><p>ä¸‹é¢çœ‹ä¸‹<code>assertProp</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assertProp</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  prop: PropOptions,</span></span></span><br><span class="line"><span class="function"><span class="params">  name: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  value: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: ?Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  absent: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸‹å‡½æ•°çš„äº”ä¸ªå‚æ•°ã€‚</p><ol><li><code>prop</code>ï¼šå®šä¹‰<code>prop</code>çš„å±æ€§ã€‚</li><li><code>name</code>ï¼šéå†åˆå¹¶é€‰é¡¹åçš„<code>props</code>é€‰é¡¹çš„<code>key</code>ï¼Œå°±æ˜¯<code>prop</code>çš„åç§°ã€‚</li><li><code>value</code>ï¼šå¤–ç•Œä¼ å…¥çš„å€¼ï¼Œä¹Ÿå°±æ˜¯<code>prop</code>çš„å€¼ã€‚</li><li><code>vm</code>ï¼šå®ä¾‹å¯¹è±¡ã€‚</li><li><code>absent</code>ï¼šå¤–ç•Œæ˜¯å¦ä¼ å…¥å€¼ï¼Œä¸º<code>true</code>è¡¨ç¤ºæ²¡æœ‰ä¼ å…¥å€¼ã€‚</li></ol><p>ä¸‹é¢çœ‹ä¸‹å‡½æ•°ä½“çš„ä»£ç ï¼Œ<strong>æ³¨æ„</strong><code>assertProp</code>å‡½æ•°æ˜¯éªŒè¯<code>prop</code>ç±»å‹çš„å‡½æ•°ï¼Œåªæœ‰åœ¨éç”Ÿäº§ç¯å¢ƒä¸­æ‰ä¼šæ‰§è¡Œï¼ŒéªŒè¯ç±»å‹å¦‚æœä¸é€šè¿‡ä¼šæŠ¥é”™ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æœ‰ required æ—¶å¿…é¡»ä¼ æ•°æ®ï¼Œå¦åˆ™æŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> (prop.required &amp;&amp; absent) &#123;</span><br><span class="line">  warn(<span class="string">'Missing required prop: "'</span> + name + <span class="string">'"'</span>, vm)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå®šä¹‰çš„å±æ€§ä¸­è®¾ç½®äº†<code>required</code>ä¸º<code>true</code>ï¼Œä½†æ˜¯å¤–ç•Œæ²¡æœ‰ä¼ å…¥å€¼ï¼Œä¼šæŠ¥é”™ï¼Œæç¤ºæ²¡æœ‰è¦æ±‚çš„<code>prop</code>å€¼ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå¿…éœ€ä¼ æ•°æ®ä¸”å€¼ä¸º null æˆ–è€… undefined æ—¶ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (value == <span class="literal">null</span> &amp;&amp; !prop.required) &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå®šä¹‰çš„å±æ€§ä¸­æ²¡æœ‰è®¾ç½®<code>require</code>çš„å€¼ï¼ˆè¿™æ—¶<code>required</code>çš„å€¼æ˜¯<code>undefined</code>ï¼‰ï¼Œè€Œä¸”å¤–ç•Œä¼ å…¥çš„å€¼æ˜¯<code>null</code>æˆ–è€…<code>undefined</code>æ—¶ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦éªŒè¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆ¤æ–­ç±»å‹æ˜¯å¦ä¸æœŸæœ›ç›¸ç¬¦</span></span><br><span class="line"><span class="keyword">let</span> type = prop.type <span class="comment">// ! è·å–ç±»å‹</span></span><br><span class="line"><span class="keyword">let</span> valid = !type || type === <span class="literal">true</span> <span class="comment">// ! æ²¡æœ‰è®¾ç½®ç±»å‹æˆ–è€…ç±»å‹çš„å€¼ä¸º true æ—¶ï¼Œä¸éœ€è¦æ ¡éªŒï¼Œç›´æ¥åˆ¤å®šä¸º true</span></span><br><span class="line"><span class="keyword">const</span> expectedTypes = [] <span class="comment">// ! æœŸæœ›ç±»å‹çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">if</span> (type) &#123;</span><br><span class="line">  <span class="comment">// ! æ•°ç»„ç±»å‹</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(type)) &#123;</span><br><span class="line">    type = [type]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ! éå†æ•°ç»„çš„æ‰€æœ‰ç±»å‹ï¼Œå¹¶éªŒè¯æ¯ä¸€ç§ç±»å‹, å½“å‡ºç°ä¸€ç§ç±»å‹éªŒè¯å¤±è´¥å å³ !valid æ—¶ï¼Œå¾ªç¯ç»“æŸ</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; type.length &amp;&amp; !valid; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> assertedType = assertType(value, type[i]) <span class="comment">// ! ç±»å‹éªŒè¯çš„è¿”å›å€¼</span></span><br><span class="line">    expectedTypes.push(assertedType.expectedType || <span class="string">''</span>) <span class="comment">// ! æŠŠè¿”å›æ”¾å…¥åˆ°æ•°ç»„ä¸­ï¼Œåé¢ç»Ÿä¸€å¤„ç†</span></span><br><span class="line">    valid = assertedType.valid <span class="comment">// ! æœ¬æ¬¡å¾ªç¯éªŒè¯çš„ç»“æœ</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆ¤æ–­å¤–ç•Œä¼ å…¥çš„å€¼çš„ç±»å‹æ˜¯å¦å’Œç”¨æˆ·å®šä¹‰ï¼ˆæœŸæœ›ï¼‰çš„ç±»å‹ç›¸åŒã€‚</p><p>å®šä¹‰å˜é‡<code>type</code>å­˜å‚¨ç”¨æˆ·å®šä¹‰çš„ç±»å‹ã€‚å®šä¹‰å˜é‡<code>valid</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå½“ç”¨æˆ·æ²¡æœ‰å®šä¹‰ç±»å‹æˆ–è€…å®šä¹‰çš„ç±»å‹çš„å€¼æ˜¯<code>true</code>æ—¶ï¼Œéå†<code>valid</code>çš„å€¼ä¸º<code>ture</code>ï¼Œè¿™åŒæ—¶ä¹Ÿæ˜¯å®ƒçš„åˆå§‹å€¼ã€‚å®šä¹‰å¸¸é‡<code>expectedTypes</code>å­˜å‚¨ç±»å‹éªŒè¯çš„ç»“æœç»„æˆé›†åˆï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„ã€‚</p><p>å…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨å®šä¹‰çš„ç±»å‹ï¼Œå¦‚æœå­˜åœ¨ï¼Œç»§ç»­ä¸‹é¢çš„é€»è¾‘ã€‚åˆ¤æ–­å®šä¹‰çš„ç±»å‹æ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœä¸æ˜¯æ•°ç»„ï¼ŒæŠŠå®ƒåŒ…è£…æˆä¸€ä¸ªæ•°ç»„ã€‚å¦‚æœå·²ç»æ˜¯ä¸€ä¸ªæ•°ç»„äº†ï¼Œéå†è¿™ä¸ªæ•°ç»„ï¼ŒéªŒè¯æ•°ç»„ä¸­çš„æ¯ä¸€ç§ç±»å‹ï¼Œå¦‚æœå‡ºç°éªŒè¯ä»»æ„ä¸€ç§ç±»å‹å¤±è´¥çš„æƒ…å†µï¼Œå¾ªç¯ç»“æŸã€‚</p><p>å£°æ˜å¸¸é‡<code>assertedType</code>å­˜å‚¨é€šè¿‡è°ƒç”¨<code>assertType</code>å‡½æ•°éªŒè¯<code>prop</code>ç±»å‹çš„è¿”å›å€¼ã€‚è¿™é‡Œå…ˆä¸ç®¡<code>assertType</code>å‡½æ•°æ˜¯æ€ä¹ˆéªŒè¯ç±»å‹çš„ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„é€»è¾‘ã€‚æŠŠéªŒè¯åçš„è¿”å›å€¼<code>assertedType</code>çš„<code>expectedType</code>å±æ€§æ”¾å…¥åˆ°<code>expectedTypes</code>æ•°ç»„ä¸­ï¼Œå¦‚æœ<code>expectedTypes</code>å±æ€§æ²¡æœ‰å€¼ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²ã€‚</p><p>æœ€åè®¾ç½®å˜é‡<code>valid</code>çš„å€¼ï¼Œå®ƒçš„å€¼æ˜¯æ¯æ¬¡å¾ªç¯æ—¶ï¼ŒéªŒè¯çš„è¿”å›å€¼<code>assertedType</code>çš„<code>valid</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§è¡¨ç¤ºæœ¬æ¬¡å¾ªç¯æ—¶éªŒè¯æ˜¯å¦æˆåŠŸï¼Œå¦‚æœéªŒè¯æˆåŠŸåˆ™ç»§ç»­å¾ªç¯ï¼Œè¿›è¡Œä¸‹ä¸€è½®éªŒè¯ï¼›å¦‚æœéªŒè¯å¤±è´¥ï¼Œå³<code>valid</code>çš„å€¼ä¸º<code>false</code>æ—¶ï¼Œç»“æŸå¾ªç¯ã€‚</p><p>åˆ°äº†è¿™é‡Œå¤§æ¦‚å¯ä»¥çŒœå‡ºéªŒè¯å‡½æ•°çš„è¿”å›å€¼<code>assertedType</code>æ˜¯ä»€ä¹ˆæ ·å­äº†ï¼Œå®ƒåº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè‡³å°‘æœ‰ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯<code>expectedType</code>å’Œ<code>valid</code>ã€‚<code>expectedType</code>çš„å€¼åº”è¯¥å°±æ˜¯æœŸæœ›çš„ç±»å‹ï¼Œæ¯”å¦‚<code>String</code>ã€<code>Boolean</code>ç­‰ï¼Œå®ƒæ˜¯å€¼æ˜¯å‡½æ•°ç±»å‹ï¼›è€Œ<code>valid</code>çš„å€¼åº”è¯¥æ˜¯ä¸ªå¸ƒå°”å€¼ã€‚</p><h3 id="assertType"><a href="#assertType" class="headerlink" title="assertType"></a><code>assertType</code></h3><p>ä¸‹é¢å°±çœ‹ä¸‹<code>assertType</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯å…·ä½“éªŒè¯ç±»å‹çš„æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assertType</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  value: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  type: Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): </span>&#123;</span><br><span class="line">  valid: boolean,</span><br><span class="line">  expectedType: string</span><br><span class="line">&#125; &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ä¸‹å®ƒçš„ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>prop</code>ä¼ å…¥çš„å€¼<code>value</code>ï¼Œå’Œæˆ‘ä»¬å®šä¹‰çš„ç±»å‹<code>type</code>ï¼Œ<code>type</code>æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> valid</span><br><span class="line"><span class="keyword">const</span> expectedType = getType(type) <span class="comment">// ! è·å–æœŸå¾…çš„ç±»å‹</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>valid</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œä¹Ÿæ˜¯å‡½æ•°çš„ä¸€ä¸ªè¿”å›å€¼ï¼Œè¡¨ç¤ºæœ¬æ¬¡éªŒè¯ç±»å‹æ˜¯å¦é€šè¿‡ã€‚</p><p>å£°æ˜å¸¸é‡<code>expectedType</code>å­˜å‚¨å­—ç¬¦ä¸²ç±»å‹çš„<code>type</code>ã€‚å› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„å‚æ•°<code>type</code>çš„å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ç±»å‹çš„å€¼ï¼Œéœ€è¦æŠŠå®ƒçš„å€¼è½¬æ¢æˆå‡½æ•°åï¼Œä¹Ÿå°±æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œç†ç”±åœ¨å‰é¢å·²ç»è®²è¿‡äº†ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> type1 = <span class="built_in">String</span> <span class="comment">// String æ˜¯å‡½æ•°ç±»å‹</span></span><br><span class="line">getType(type1) <span class="comment">// 'String' æ˜¯å­—ç¬¦ä¸²ç±»å‹</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> type2 = <span class="built_in">Boolean</span> <span class="comment">// Boolean æ˜¯å‡½æ•°ç±»å‹</span></span><br><span class="line">getType(type2) <span class="comment">// 'Boolean' æ˜¯å­—ç¬¦ä¸²ç±»å‹</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¯é€šè¿‡ typeof æ¥éªŒè¯çš„æ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">if</span> (simpleCheckRE.test(expectedType)) &#123;</span><br><span class="line">  <span class="keyword">const</span> t = <span class="keyword">typeof</span> value <span class="comment">// ! t çš„å€¼æ˜¯å­—ç¬¦ä¸²å°å†™</span></span><br><span class="line">  valid = t === expectedType.toLowerCase() <span class="comment">// ! éªŒè¯ç±»å‹</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­æ­£åˆ™è¡¨è¾¾å¼<code>simpleCheckRE</code>æ˜¯å¦å’ŒæœŸæœ›çš„ç±»å‹<code>expectedType</code>åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œç»§ç»­ä¸‹é¢çš„é€»è¾‘ã€‚</p><p>å…ˆçœ‹ä¸‹æ­£åˆ™è¡¨è¾¾å¼<code>simpleCheckRE</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¯é€šè¿‡ typeof æ¥éªŒè¯çš„æ•°æ®ç±»å‹æ­£åˆ™</span></span><br><span class="line"><span class="keyword">const</span> simpleCheckRE = <span class="regexp">/^(String|Number|Boolean|Function|Symbol)$/</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™äº›éƒ½æ˜¯å¯ä»¥é€šè¿‡<code>typeof</code>æ¥åˆ¤æ–­çš„ç±»å‹ï¼Œæ¯”å¦‚<code>String</code>ã€<code>Number</code>ã€<code>Boolean</code>ã€<code>Function</code>ã€<code>Symbol</code>ã€‚</p><p>å£°æ˜å˜é‡<code>t</code>å­˜å‚¨é€šè¿‡<code>typeof</code>è·å–çš„å¤–ç•Œä¼ å…¥çš„æ•°æ®<code>value</code>çš„ç±»å‹ã€‚ç„¶åæ¯”è¾ƒ<code>t</code>å’ŒæœŸæœ›çš„ç±»å‹<code>expectedType</code>æ˜¯å¦ç›¸åŒã€‚å› ä¸ºè¿™é‡Œçš„<code>expectedType</code>æ˜¯é¦–å­—æ¯å¤§å†™çš„ï¼Œåœ¨æ¯”è¾ƒå‰éœ€è¦æŠŠå®ƒè½¬æ¢æˆå°å†™çš„ï¼Œç„¶åæŠŠæ¯”è¾ƒç»“æœèµ‹å€¼ç»™å˜é‡<code>valid</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="string">'value'</span> <span class="comment">// 'string'</span></span><br><span class="line">expectedType = <span class="string">'String'</span></span><br><span class="line">expectedType.toLowerCase() <span class="comment">// 'string'</span></span><br><span class="line">valid = <span class="string">'value'</span> ==== type.toLowerCase()</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// for primitive wrapper objects</span></span><br><span class="line"><span class="comment">// ! åŒ…è£…ç±»å‹çš„éªŒè¯ï¼ŒéªŒè¯åŸå‹ï¼Œæ¯”å¦‚ const str = new String('123')ï¼Œstr æ˜¯ String çš„å®ä¾‹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">if</span> (!valid &amp;&amp; t === <span class="string">'object'</span>) &#123;</span><br><span class="line">  valid = value <span class="keyword">instanceof</span> type</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸Šé¢çš„æ¯”è¾ƒç»“æœæ˜¯<code>false</code>ï¼Œå³ä¸ç›¸åŒï¼Œå†åˆ¤æ–­<code>t</code>çš„å€¼æ˜¯ä¸æ˜¯<code>object</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜ä¼ å…¥çš„å€¼<code>value</code>æ˜¯ä¸€ä¸ªåŒ…è£…ç±»å‹çš„å€¼ï¼Œéœ€è¦åˆ¤æ–­è¿™ä¸ªå€¼çš„åŸå‹ï¼Œè°ƒç”¨<code>instanceof</code>åˆ¤æ–­<code>value</code>çš„åŸå‹æ˜¯ä¸æ˜¯<code>type</code>ï¼Œæœ€åæŠŠæ¯”è¾ƒç»“æœèµ‹å€¼ç»™<code>valid</code>å˜é‡ã€‚</p><p>ä»€ä¹ˆæ˜¯åŒ…è£…ç±»å‹ï¼Ÿçœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> a = <span class="string">'1'</span> <span class="comment">// åŸå§‹ç±»å‹</span></span><br><span class="line"><span class="keyword">const</span> b = <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'1'</span>) <span class="comment">// åŒ…è£…ç±»å‹</span></span><br><span class="line"><span class="keyword">typeof</span> a <span class="comment">// 'string'</span></span><br><span class="line"><span class="keyword">typeof</span> b <span class="comment">// 'object'</span></span><br><span class="line">b <span class="keyword">instanceof</span> <span class="built_in">String</span> <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (expectedType === <span class="string">'Object'</span>) &#123;</span><br><span class="line">  valid = isPlainObject(value)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! æ•°ç»„éªŒè¯</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (expectedType === <span class="string">'Array'</span>) &#123;</span><br><span class="line">  valid = <span class="built_in">Array</span>.isArray(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æœŸæœ›çš„ç±»å‹æ˜¯å¯¹è±¡<code>Object</code>æ—¶ï¼Œä½¿ç”¨<code>isPlainObject</code>æ–¹æ³•éªŒè¯ä¼ å…¥çš„å€¼<code>value</code>çš„ç±»å‹ï¼Œå¹¶æŠŠéªŒè¯ç»“æœèµ‹å€¼ç»™å˜é‡<code>valid</code>ã€‚</p><p>å½“æœŸæœ›çš„ç±»å‹æ˜¯æ•°ç»„<code>Array</code>æ—¶ï¼Œä½¿ç”¨<code>Array.isArray</code>æ–¹æ³•éªŒè¯ä¼ å…¥çš„å€¼<code>value</code>çš„ç±»å‹ï¼Œå¹¶æŠŠéªŒè¯ç»“æœèµ‹å€¼ç»™å˜é‡<code>valid</code>ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å…¶ä»–éªŒè¯ =&gt; è‡ªå®šä¹‰ç±»å‹ (åŸå‹éªŒè¯)</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  valid = value <span class="keyword">instanceof</span> type</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœŸæœ›ç±»å‹å³ä¸æ˜¯å¯ä»¥é€šè¿‡<code>typeof</code>åˆ¤æ–­çš„ç±»å‹ï¼Œä¹Ÿä¸æ˜¯æ•°ç»„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å¯èƒ½æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»å‹ï¼Œä½¿ç”¨<code>instanceof</code>åˆ¤æ–­ä¼ å…¥çš„å€¼<code>vlaue</code>çš„åŸå‹æ˜¯ä¸æ˜¯è‡ªå®šä¹‰çš„ç±»å‹<code>type</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰ç±»å‹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Person</span>(<span class="params">name, age</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.nane = name</span><br><span class="line">  <span class="keyword">this</span>.age = age</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> Person(<span class="string">'Hale'</span>, <span class="number">18</span>)</span><br><span class="line">p <span class="keyword">instanceof</span> Person <span class="comment">// true</span></span><br></pre></td></tr></table></figure><p>æœ€åå‡½æ•°è¿”å›çš„ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒ…å«ä¸¤ä¸ªå±æ€§ã€‚</p><ul><li><code>valid</code>ï¼šéªŒè¯çš„ç»“æœï¼Œæ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ã€‚</li><li><code>expectedType</code>ï¼šå®šä¹‰ï¼ˆæœŸæœ›ï¼‰çš„ç±»å‹ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è¿”å›éªŒè¯ç»“æœå’ŒæœŸæœ›çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  valid,</span><br><span class="line">  expectedType</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®²è§£<code>assertType</code>å‡½æ•°çš„ä»£ç åï¼Œæˆ‘ä»¬çŸ¥é“äº†ç±»å‹æ˜¯æ€ä¹ˆéªŒè¯çš„ã€‚</p><p>å†æ¬¡å›åˆ°<code>assertProp</code>å‡½æ•°ä¸­ï¼Œçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å½“éªŒè¯å¤±è´¥æ—¶æŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> (!valid) &#123;</span><br><span class="line">  warn(getInvalidTypeMessage(name, value, expectedTypes), vm)</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç±»å‹éªŒè¯å¤±è´¥åï¼Œä¹Ÿå°±æ˜¯<code>valid</code>çš„å€¼æ˜¯<code>false</code>æ—¶ï¼Œä¼šæŠ¥é”™ã€‚</p><p>ç»§ç»­çœ‹<code>assertProp</code>å‡½æ•°å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è‡ªå®šä¹‰éªŒè¯</span></span><br><span class="line"><span class="keyword">const</span> validator = prop.validator <span class="comment">// ! è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„éªŒè¯å™¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æŠŠ value ä½œä¸ºå‚æ•°ä¼ å…¥å¹¶æ‰§è¡Œè‡ªå®šä¹‰éªŒè¯å™¨ï¼Œ</span></span><br><span class="line"><span class="comment">// ! å½“å®ƒè¿”å›å€¼ä¸º false æ—¶ï¼ŒéªŒè¯å¤±è´¥ï¼ŒæŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> (validator) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!validator(value)) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Invalid prop: custom validator check failed for prop "'</span> + name + <span class="string">'".'</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤äº†æé«˜éªŒè¯<code>JavaScript</code>çš„å†…ç½®ç±»å‹å’Œè‡ªå®šä¹‰ç±»å‹ï¼Œ<code>props</code>è¿˜æä¾›äº†è‡ªå®šä¹‰éªŒè¯ã€‚å®ƒä¸æ˜¯éªŒè¯å€¼çš„ç±»å‹ï¼Œè€Œæ˜¯éªŒè¯ä»£ç é€»è¾‘ï¼Œå³ç”¨æˆ·è‡ªå®šä¹‰çš„é€»è¾‘ã€‚</p><p>è‡ªå®šä¹‰éªŒè¯è®©ç”¨æˆ·å£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åæŠŠå¤–ç•Œä¼ å…¥çš„å€¼ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°å‡½æ•°ä¸­è¿›è¡ŒéªŒè¯ã€‚</p><p>å£°æ˜å¸¸é‡<code>validator</code>å­˜å‚¨è·å–åˆ°çš„ç”¨æˆ·è‡ªå®šä¹‰çš„éªŒè¯å™¨ï¼Œå…ˆåˆ¤æ–­è‡ªå®šä¹‰éªŒè¯å™¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼ŒæŠŠå¤–ç•Œä¼ å…¥çš„å€¼<code>value</code>ä½œä¸ºå‚æ•°ä¼ å…¥åˆ°éªŒè¯å™¨å‡½æ•°ä¸­æ‰§è¡Œï¼Œå¦‚æœéªŒè¯å™¨å‡½æ•°è¿”å›å€¼æ˜¯<code>true</code>ï¼Œè¯´æ˜éªŒè¯æˆåŠŸï¼Œä¸ç”¨è¿›è¡Œå…¶ä»–æ“ä½œï¼›å¦‚æœè¿”å›å€¼æ˜¯<code>false</code>ï¼Œè¯´æ˜éªŒè¯å¤±è´¥ï¼Œç„¶åæŠ¥é”™ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">propsData: &#123;</span><br><span class="line">  list: [<span class="string">'apple'</span>, <span class="string">'banana'</span>, <span class="string">'orange'</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">props: &#123;</span><br><span class="line">  list: &#123;</span><br><span class="line">    validator: <span class="function"><span class="keyword">function</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> value.includes(<span class="string">'apple'</span>) <span class="comment">// true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œï¼Œ<code>props</code>é€‰é¡¹çš„éªŒè¯çš„ä»£ç å°±å…¨éƒ¨è®²è§£å®Œæˆï¼Œ<code>props</code>é€‰é¡¹çš„åˆå§‹åŒ–ä¹Ÿè®²è§£å®Œæˆã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰é¢ç« èŠ‚é€šè¿‡åˆå§‹åŒ–&lt;code&gt;data&lt;/code&gt;é€‰é¡¹çš„&lt;code&gt;initData&lt;/code&gt;å‡½æ•°è®²è§£äº† Vue çš„å“åº”å¼ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢ç»§ç»­è®²è§£&lt;code&gt;props&lt;/code&gt;é€‰é¡¹çš„åˆå§‹åŒ–ã€‚&lt;/p&gt;
&lt;h2 id=&quot;propsçš„åˆå§‹åŒ–&quot;&gt;&lt;a href=&quot;#propsçš„åˆå§‹åŒ–&quot; class=&quot;headerlink&quot; title=&quot;propsçš„åˆå§‹åŒ–&quot;&gt;&lt;/a&gt;&lt;code&gt;props&lt;/code&gt;çš„åˆå§‹åŒ–&lt;/h2&gt;&lt;p&gt;å›åˆ°&lt;code&gt;initState&lt;/code&gt;å‡½æ•°ï¼ŒæŸ¥çœ‹åˆå§‹åŒ–&lt;code&gt;props&lt;/code&gt;é€‰é¡¹çš„ä»£ç ï¼Œåœ¨&lt;code&gt;core/instance/state.js&lt;/code&gt;æ–‡ä»¶ä¸­&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opts.props) initProps(vm, opts.props)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é€šè¿‡è°ƒç”¨&lt;code&gt;initProps&lt;/code&gt;å‡½æ•°åˆå§‹åŒ–&lt;code&gt;props&lt;/code&gt;é€‰é¡¹ï¼Œè¿˜éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡&lt;code&gt;vm&lt;/code&gt;å’Œåˆå¹¶é€‰é¡¹åçš„&lt;code&gt;props&lt;/code&gt;å±æ€§ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢çœ‹ä¸‹&lt;code&gt;initProps&lt;/code&gt;å‡½æ•°çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;initProps&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;vm: Component, propsOptions: Object&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; propsData = vm.$options.propsData || &amp;#123;&amp;#125; &lt;span class=&quot;comment&quot;&gt;// ! è·å– props æ•°æ®æ¥æº&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; props = (vm._props = &amp;#123;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// cache prop keys so that future props updates can iterate using Array&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// instead of dynamic object key enumeration.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; keys = (vm.$options._propKeys = [])&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; isRoot = !vm.$parent&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å£°æ˜å¸¸é‡&lt;code&gt;propsData&lt;/code&gt;å­˜å‚¨&lt;code&gt;vm.$options.propsData&lt;/code&gt;å±æ€§ï¼Œè¿™æ˜¯å¤–ç•Œä¼ è¿›æ¥çš„&lt;code&gt;props&lt;/code&gt;æ•°æ®ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹è®¡ç®—å±æ€§</title>
    <link href="https://haledeng.com/blog/20190926-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7/"/>
    <id>https://haledeng.com/blog/20190926-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7/</id>
    <published>2019-09-26T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:21.325Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸‹é¢çœ‹ä¸‹ Vue çš„è®¡ç®—å±æ€§çš„å®ç°ï¼Œè®¡ç®—å±æ€§æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–çš„æ–¹å¼å’Œæ™®é€šçš„å“åº”å¼æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>å›åˆ°<code>initState</code>å‡½æ•°ä¸­ï¼Œåœ¨<code>core/instance/state.js</code>æ–‡ä»¶ä¸­ï¼Œçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</span><br></pre></td></tr></table></figure><p>å¦‚æœè®¾ç½®äº†<code>computed</code>é€‰é¡¹ï¼Œå°±è°ƒç”¨<code>initComputed</code>åˆå§‹åŒ–é€‰é¡¹ã€‚</p><h2 id="initComputed"><a href="#initComputed" class="headerlink" title="initComputed"></a><code>initComputed</code></h2><p>çœ‹ä¸‹<code>initComputed</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆå§‹åŒ–è®¡ç®—å±æ€§é€‰é¡¹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initComputed</span>(<span class="params">vm: Component, computed: Object</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="keyword">const</span> watchers = (vm._computedWatchers = <span class="built_in">Object</span>.create(<span class="literal">null</span>)) <span class="comment">// ! ç»´æŠ¤ä¸€ä¸ªå¸¸é‡å­˜å‚¨è®¡ç®—å±æ€§</span></span><br><span class="line">  <span class="comment">// computed properties are just getters during SSR</span></span><br><span class="line">  <span class="keyword">const</span> isSSR = isServerRendering()</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜ä¸€ä¸ªå¸¸é‡<code>watchers</code>å­˜å‚¨<code>vm._computedWatchers</code>å±æ€§ï¼Œé»˜è®¤å€¼æ˜¯ç©ºå¯¹è±¡ï¼Œ<code>vm._computedWatchers</code>å±æ€§å­˜å‚¨å®ä¾‹å¯¹è±¡çš„è®¡ç®—å±æ€§è§‚å¯Ÿè€…ã€‚</p><a id="more"></a><p>å£°æ˜å¸¸é‡<code>isSSR</code>å­˜å‚¨<code>isServerRendering</code>å‡½æ•°çš„æ‰§è¡Œç»“æœï¼Œå³åˆ¤æ–­å½“å‰çš„ç¯å¢ƒæ˜¯ä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! éå†è®¡ç®—å±æ€§</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">  <span class="keyword">const</span> userDef = computed[key] <span class="comment">// ! è·å–æ¯ä¸ªè®¡ç®—å±æ€§çš„å‡½æ•°æˆ–è€…å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">const</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">'function'</span> ? userDef : userDef.get <span class="comment">// ! è·å– getter</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! è®¡ç®—å±æ€§æ²¡æœ‰ getter å‘å‡ºè­¦å‘Š</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">    warn(<span class="string">`Getter is missing for computed property "<span class="subst">$&#123;key&#125;</span>".`</span>, vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†è®¡ç®—å±æ€§é€‰é¡¹<code>computed</code>ï¼Œå£°æ˜å¸¸é‡<code>userDef</code>å­˜å‚¨æ¯ä¸€ä¸ªè®¡ç®—å±æ€§ã€‚</p><p>å£°æ˜å¸¸é‡<code>getter</code>å­˜å‚¨è®¡ç®—å±æ€§çš„<code>getter</code>ï¼Œé¦–å…ˆåˆ¤æ–­<code>userDef</code>æ˜¯ä¸æ˜¯å‡½æ•°ç±»å‹ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥èµ‹å€¼ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼ŒæŠŠå®ƒçš„<code>get</code>å±æ€§èµ‹å€¼ç»™<code>getter</code>ã€‚</p><p>å¦‚æœè·å–åˆ°çš„<code>getter</code>ä¸å­˜åœ¨ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œè­¦å‘Šè®¡ç®—å±æ€§ç¼ºå°‘<code>getter</code>å€¼ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isSSR) &#123;</span><br><span class="line">  <span class="comment">// create internal watcher for the computed property.</span></span><br><span class="line">  <span class="comment">// ! åˆ›å»ºè®¡ç®—å±æ€§çš„è§‚å¯Ÿè€…</span></span><br><span class="line">  watchers[key] = <span class="keyword">new</span> Watcher(</span><br><span class="line">    vm,</span><br><span class="line">    getter || noop,</span><br><span class="line">    noop,</span><br><span class="line">    computedWatcherOptions <span class="comment">// ! è®¡ç®—å±æ€§é€‰é¡¹ &#123; lazy: true &#125;</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æ˜¯æœåŠ¡ç«¯æ¸²æŸ“ï¼Œåˆ›å»ºè®¡ç®—å±æ€§çš„è§‚å¯Ÿè€…ï¼Œå¹¶æŠŠå®ƒå­˜å‚¨åˆ°<code>watchers</code>ä¸­ï¼Œè§‚å¯Ÿè€…å¯¹åº”çš„åç§°å°±æ˜¯<code>key</code>ã€‚</p><p>å…¶ä¸­ä¼ å…¥ä¸Šé¢è·å–çš„<code>getter</code>ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°<code>expOrFn</code>ä¼ å…¥ï¼Œå¦‚æœæ²¡æœ‰<code>getter</code>å°±ä¼ å…¥ä¸€ä¸ªç©ºå‡½æ•°ã€‚</p><p>ç¬¬å››ä¸ªå‚æ•°<code>options</code>ä¼ å…¥çš„æ˜¯å¸¸é‡<code>computedWatcherOptions</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>{ lazy: true }</code>ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">  defineComputed(vm, key, userDef) <span class="comment">// ! å®ç°è®¡ç®—å±æ€§</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! å¦‚æœè®¡ç®—å±æ€§åç§°åœ¨ data å’Œ props è¢«ä½¿ç”¨äº†ï¼Œå‘å‡ºè­¦å‘Š</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (key <span class="keyword">in</span> vm.$data) &#123;</span><br><span class="line">    warn(<span class="string">`The computed property "<span class="subst">$&#123;key&#125;</span>" is already defined in data.`</span>, vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.$options.props &amp;&amp; key <span class="keyword">in</span> vm.$options.props) &#123;</span><br><span class="line">    warn(<span class="string">`The computed property "<span class="subst">$&#123;key&#125;</span>" is already defined as a prop.`</span>, vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­è®¡ç®—å±æ€§çš„<code>key</code>æ˜¯å¦å­˜åœ¨ç»„ä»¶å®ä¾‹ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œä½¿ç”¨<code>defineComputed</code>å‡½æ•°æŠŠè®¡ç®—å±æ€§ä»£ç†åˆ°å®ä¾‹ä¸­ï¼Œå¹¶ä¸”æŠŠå®ƒå˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>å¦å¤–ï¼Œåˆ¤æ–­è®¡ç®—å±æ€§çš„<code>key</code>æ˜¯å¦å­˜åœ¨äº<code>data</code>æˆ–è€…<code>props</code>é€‰é¡¹ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºè®¡ç®—å±æ€§çš„<code>key</code>å€¼å·²ç»è¢«å ç”¨äº†ã€‚</p><h2 id="defineComputed"><a href="#defineComputed" class="headerlink" title="defineComputed"></a><code>defineComputed</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>defineComputed</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å®ç°è®¡ç®—å±æ€§</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineComputed</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  userDef: Object | Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldCache = !isServerRendering() <span class="comment">// ! æ˜¯å¦ä¸ºæœåŠ¡ç«¯æ¸²æŸ“ï¼ŒæœåŠ¡ç«¯æ¸²æŸ“ä¸éœ€è¦ç¼“å­˜</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>shouldCache</code>ï¼Œå®ƒè¡¨ç¤ºæ˜¯å¦æ˜¯éœ€è¦ç¼“å­˜ï¼Œå®ƒçš„å€¼å’ŒæœåŠ¡ç«¯æ¸²æŸ“äº’æ–¥ï¼Œå› ä¸ºæœåŠ¡ç«¯æ¸²æŸ“ä¸éœ€è¦ç¼“å­˜ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è®¡ç®—å±æ€§æ˜¯å‡½æ•°æ—¶</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">'function'</span>) &#123;</span><br><span class="line">  sharedPropertyDefinition.get = shouldCache</span><br><span class="line">    ? createComputedGetter(key) <span class="comment">// ! åˆ›å»ºè®¡ç®—å±æ€§çš„ getter</span></span><br><span class="line">    : createGetterInvoker(userDef)</span><br><span class="line">  sharedPropertyDefinition.set = noop <span class="comment">// ! setter ä¸ºç©ºå‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è·å–çš„è®¡ç®—å±æ€§<code>userDef</code>æ˜¯å‡½æ•°æ—¶ï¼Œè°ƒç”¨<code>createComputedGetter</code>å‡½æ•°åˆ›å»ºè®¡ç®—å±æ€§çš„<code>gettter</code>ï¼Œå¦åˆ™è°ƒç”¨<code>createGetterInvoker</code>å‡½æ•°åˆ›å»ºè®¡ç®—å±æ€§çš„<code>gettter</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ›å»ºçš„<code>getter</code>æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ€åæŠŠ<code>getter</code>èµ‹å€¼ç»™<code>sharedPropertyDefinition</code>çš„<code>get</code>å±æ€§ã€‚</p><p>å› ä¸ºç”¨æˆ·å®šä¹‰çš„è®¡ç®—å±æ€§æ˜¯å‡½æ•°æ—¶æ˜¯æ²¡æœ‰<code>setter</code>çš„ï¼Œæ‰€ä»¥<code>sharedPropertyDefinition</code>å¯¹è±¡çš„<code>set</code>ä¸ºç©ºå‡½æ•°ã€‚</p><p>çœ‹ä¸‹<code>sharedPropertyDefinition</code>å¯¹è±¡çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  <span class="keyword">get</span>: noop,</span><br><span class="line">  <span class="keyword">set</span>: noop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥è®¾ç½®<code>Object.defineProperty</code>ä¸­çš„å±æ€§æè¿°ç¬¦ï¼Œ<code>get</code>å’Œ<code>set</code>åˆå§‹å€¼æ˜¯ç©ºå‡½æ•°ï¼Œéœ€è¦åé¢è¿›è¡Œé‡å†™ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>createComputedGetter</code>å‡½æ•°å’Œ<code>createGetterInvoker</code>å‡½æ•°æ˜¯æ€ä¹ˆåˆ›å»º<code>getter</code>å‡½æ•°çš„ã€‚</p><h3 id="createComputedGetter"><a href="#createComputedGetter" class="headerlink" title="createComputedGetter"></a><code>createComputedGetter</code></h3><p>å…ˆçœ‹<code>createComputedGetter</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯<code>key</code>ï¼Œå®ƒæ˜¯å­—ç¬¦ä¸²ç±»å‹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆ›å»ºè®¡ç®—å±æ€§ getter çš„å‡½æ•°ï¼Œéœ€è¦æ ¹æ® dirty æ›´æ–°å€¼å’Œæ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="comment">// ! è¿”å›ä¸€ä¸ªæ–°çš„ computedGetter å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key] <span class="comment">// ! è·å–è®¡ç®—å±æ€§è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="comment">// ! å¦‚æœ dirty ä¸º true æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…å¯ä»¥æ‰§è¡Œæ›´æ–°</span></span><br><span class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">        watcher.evaluate() <span class="comment">// ! è°ƒç”¨ evaluate æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸º<code>getter</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿè¿”å›ä¸€ä¸ªå‡½æ•°ã€‚</p><p>å…ˆå°è¯•é€šè¿‡<code>key</code>å€¼åœ¨<code>vm._computedWatchers</code>ä¸­è·å–åˆ°æˆ‘ä»¬å®šä¹‰çš„è®¡ç®—å±æ€§è§‚å¯Ÿè€…ï¼Œå¦‚æœèƒ½è·å–åˆ°ï¼Œåˆ¤æ–­è§‚å¯Ÿè€…å¯¹è±¡çš„<code>dirty</code>å±æ€§æ˜¯ä¸æ˜¯<code>true</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè¯´æ˜è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…å¯ä»¥æ‰§è¡Œæ›´æ–°ï¼Œç„¶åè°ƒç”¨è§‚å¯Ÿè€…çš„<code>evaluate</code>æ–¹æ³•æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ã€‚</p><p>çœ‹ä¸‹<code>evaluate</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>core/observer/watcher.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evaluate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.value = <span class="keyword">this</span>.get() <span class="comment">// ! è·å–è®¡ç®—å±æ€§çš„æ–°å€¼ï¼Œå¹¶è§¦å‘å®ƒæ‰€ä¾èµ–çš„å“åº”å¼å¯¹è±¡æ”¶é›†è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…</span></span><br><span class="line">  <span class="keyword">this</span>.dirty = <span class="literal">false</span> <span class="comment">// ! æ›´æ–°è®¡ç®—å±æ€§çš„å€¼åé‡æ–°è®¾ç½®ä¸º falseï¼Œè¿™æ—¶å†æ¬¡è®¿é—®è®¡ç®—å±æ€§æ—¶ï¼Œå®ƒå°±ä¸ä¼šå†æ±‚å€¼äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨<code>get</code>æ–¹æ³•è·å–æ–°å€¼ï¼Œå› ä¸º<code>get</code>æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>this.getter</code>çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºè§‚å¯Ÿè€…æ—¶ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œè¿™æ ·å°±ä¼šé‡æ–°æ±‚å€¼ï¼Œåœ¨æ±‚å€¼çš„è¿‡ç¨‹ä¸­ä¼šè®¿é—®åˆ°è®¡ç®—å±æ€§ä¾èµ–çš„é‚£ä¸ªå“åº”å¼æ•°æ®ï¼Œå¹¶è§¦å‘è¿™ä¸ªæ•°æ®æ”¶é›†å½“å‰çš„è®¡ç®—å±æ€§è§‚å¯Ÿè€…ä½œä¸ºä¾èµ–ã€‚</p><p>æœ€åé‡æ–°å°†<code>dirty</code>è®¾ç½®ä¸º<code>false</code>ï¼Œè¿™æ—¶å€™ï¼Œå¦‚æœå†æ¬¡è®¿é—®è®¡ç®—å±æ€§ï¼Œå°±ä¸ä¼šå†è°ƒç”¨<code>evaluate</code>æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ã€‚å› ä¸ºè®¡ç®—å±æ€§ä¾èµ–çš„å“åº”å¼æ•°æ®æ²¡æœ‰æ›´æ–°å€¼ï¼Œé‡æ–°æ±‚å€¼ä¹Ÿè¿˜æ˜¯å’Œä»¥å‰çš„å€¼ä¸€æ ·ï¼Œæµªè´¹æ€§èƒ½ã€‚åªæœ‰åœ¨è®¡ç®—å±æ€§è§‚å¯Ÿè€…æ‰€ä¾èµ–çš„å“åº”æ€§æ•°æ®æ›´æ–°æ—¶ï¼Œæ‰ä¼šè§¦å‘è®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„<code>update</code>æ–¹æ³•ï¼ŒæŠŠ<code>dirty</code>é‡æ–°è®¾ç½®ä¸º<code>true</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">update() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.lazy) &#123;</span><br><span class="line">    <span class="keyword">this</span>.dirty = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹<code>createComputedGetter</code>å‡½æ•°ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">  watcher.depend() <span class="comment">// ! è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> watcher.value</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>Dep.target</code>æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼ï¼Œè®¡ç®—å±æ€§è§‚å¯Ÿè€…æ”¶é›†ä¾èµ–ï¼Œè¿™é‡Œæ‰æ˜¯è®¡ç®—å±æ€§æœ¬èº«æ”¶é›†ä¾èµ–ï¼Œæ˜¯é€šè¿‡å®ƒçš„è§‚å¯Ÿè€…æ¥æ”¶é›†ä¾èµ–çš„ã€‚æœ€åè¿”å›è§‚å¯Ÿè€…å¯¹è±¡çš„<code>value</code>å€¼ï¼Œå³ä¸Šé¢<code>evaluate</code>è·å–çš„å€¼ã€‚</p><h3 id="createGetterInvoker"><a href="#createGetterInvoker" class="headerlink" title="createGetterInvoker"></a><code>createGetterInvoker</code></h3><p>ä¸‹é¢çœ‹ä¸‹<code>createGetterInvoker</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒæ˜¯åˆ›å»ºæœåŠ¡å™¨æ¸²æŸ“æ—¶çš„<code>getter</code>ã€‚</p><p>å®ƒçš„å‚æ•°æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå¦‚æœ<code>userDef</code>æ˜¯å‡½æ•°ï¼Œç›´æ¥ä¼ å…¥å®ƒã€‚å¦‚æœ<code>userDef</code>æ˜¯å¯¹è±¡ï¼Œä¼ å…¥çš„æ˜¯<code>userDef.get</code>å±æ€§ï¼Œä¹Ÿå°±æ˜¯<code>getter</code>å‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆ›å»ºè®¡ç®—å±æ€§è°ƒç”¨é’©å­å‡½æ•°ï¼Œè‡ªå·±è°ƒç”¨å‡½æ•°ï¼Œç”¨äºæœåŠ¡ç«¯æ¸²æŸ“ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createGetterInvoker</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> fn.call(<span class="keyword">this</span>, <span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ¸²æŸ“ä¸­åˆ›å»ºçš„<code>getter</code>ï¼Œä¹Ÿæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°ã€‚ä½†æ˜¯è¿™é‡Œä¸ç”¨æ”¶é›†ä¾èµ–å’Œå¤„ç†<code>dirty</code>å±æ€§ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨ä¼ å…¥çš„<code>getter</code>å‡½æ•°ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>defineComputed</code>æ˜¯å¦‚ä½•å¤„ç†è®¡ç®—å±æ€§æ˜¯å¯¹è±¡ç±»å‹çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è®¡ç®—å±æ€§æ˜¯å¯¹è±¡æ—¶</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  sharedPropertyDefinition.get = userDef.get</span><br><span class="line">    ? shouldCache &amp;&amp; userDef.cache !== <span class="literal">false</span></span><br><span class="line">      ? createComputedGetter(key)</span><br><span class="line">      : createGetterInvoker(userDef.get)</span><br><span class="line">  : noop</span><br><span class="line">  sharedPropertyDefinition.set = userDef.set || noop <span class="comment">// ! setter ä¸º set å‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­<code>userDef</code>æ˜¯å¦å­˜åœ¨<code>get</code>å±æ€§ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œ<code>sharedPropertyDefinition.get</code>ä¸ºç©ºå‡½æ•°ã€‚å¦‚æœå­˜åœ¨ï¼Œå†åˆ¤æ–­<code>shouldCache</code>æ˜¯å¦ä¸ºçœŸä¸”ç”¨æˆ·æ²¡æœ‰å®šä¹‰è¿‡<code>cache</code>å±æ€§ä¸ºå‡æ—¶ï¼Œè°ƒç”¨<code>createComputedGetter</code>å‡½æ•°åˆ›å»º<code>getter</code>ï¼Œå¦åˆ™è°ƒç”¨<code>createGetterInvoker</code>å‡½æ•°åˆ›å»º<code>getter</code>ï¼Œè¿™é‡Œä¼ å…¥çš„å‚æ•°æ˜¯<code>userDef.get</code>ã€‚</p><p>è¿™ä¸¤ä¸ªå‡½æ•°åœ¨å‰é¢å·²ç»è®²è§£è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸åœ¨èµ˜è¿°äº†ã€‚</p><p>å› ä¸º<code>userDef</code>æ˜¯å¯¹è±¡ï¼Œé‡Œé¢ä¸€èˆ¬æ˜¯æœ‰<code>set</code>å±æ€§çš„ï¼Œå¦‚æœæœ‰<code>set</code>å±æ€§ï¼Œç›´æ¥èµ‹å€¼ç»™<code>sharedPropertyDefinition.set</code>çš„å±æ€§ï¼Œå¦åˆ™èµ‹å€¼ä¸ºç©ºå‡½æ•°ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">  sharedPropertyDefinition.set === noop</span><br><span class="line">) &#123;</span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Computed property "<span class="subst">$&#123;key&#125;</span>" was assigned to but it has no setter.`</span>,</span><br><span class="line">      <span class="keyword">this</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition) <span class="comment">// ! æŠŠè®¡ç®—å±æ€§ä»£ç†åˆ°å®ä¾‹å¯¹è±¡ä¸­</span></span><br></pre></td></tr></table></figure><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœ<code>sharedPropertyDefinition.set</code>çš„å€¼ç»è¿‡ä¸Šé¢çš„é€»è¾‘ä¹‹åè¿˜æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·æ²¡æœ‰è®¾ç½®<code>setter</code>ã€‚è¿™æ—¶ä¼šæŠŠ<code>sharedPropertyDefinition.set</code>èµ‹å€¼æˆä¸€ä¸ªè­¦å‘Šå‡½æ•°ï¼Œå½“ä½ ä¿®æ”¹è®¡ç®—å±æ€§çš„å€¼æ—¶ï¼Œä¼šæé†’ä½ è¿™ä¸ªè®¡ç®—å±æ€§æ²¡æœ‰è®¾ç½®<code>setter</code>ï¼Œä¸èƒ½ä¿®æ”¹å®ƒçš„å€¼ã€‚</p><p>æœ€åä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰<code>target</code>çš„<code>key</code>ï¼Œè€Œå®ƒçš„å±æ€§æè¿°ç¬¦å°±æ˜¯ä¸Šé¢ä»£ç ä¸­çš„å®šä¹‰çš„<code>sharedPropertyDefinition</code>å¯¹è±¡ï¼Œè¿™é‡Œçš„<code>target</code>å°±æ˜¯ Vue çš„å®ä¾‹å¯¹è±¡ï¼ŒæŠŠè®¡ç®—å±æ€§ä»£ç†åˆ°å®ä¾‹å¯¹è±¡ä¸­ã€‚</p><p>ä½¿ç”¨è®¡ç®—å±æ€§ç¤ºä¾‹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—å±æ€§æ˜¯å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å¿…é¡»æœ‰è¿”å›å€¼ï¼Œæ˜¯ä¸€ä¸ª getter</span></span><br><span class="line">computed: &#123;</span><br><span class="line">  fullName: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¡ç®—å±æ€§æ˜¯å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡é‡Œé¢ä¸€èˆ¬æ˜¯ getter å’Œ setter</span></span><br><span class="line">computed: &#123;</span><br><span class="line">  fullName: &#123;</span><br><span class="line">    <span class="comment">// getter</span></span><br><span class="line">    <span class="keyword">get</span>: function () &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.firstName + <span class="string">' '</span> + <span class="keyword">this</span>.lastName</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// setter</span></span><br><span class="line">    <span class="keyword">set</span>: function (newValue) &#123;</span><br><span class="line">      <span class="keyword">var</span> names = newValue.split(<span class="string">' '</span>)</span><br><span class="line">      <span class="keyword">this</span>.firstName = names[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">this</span>.lastName = names[names.length - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¡ç®—å±æ€§å’Œæ™®é€šå±æ€§çš„å·®å¼‚"><a href="#è®¡ç®—å±æ€§å’Œæ™®é€šå±æ€§çš„å·®å¼‚" class="headerlink" title="è®¡ç®—å±æ€§å’Œæ™®é€šå±æ€§çš„å·®å¼‚"></a>è®¡ç®—å±æ€§å’Œæ™®é€šå±æ€§çš„å·®å¼‚</h2><p>è¿™é‡Œæ¯”è¾ƒä¸€ä¸‹<strong>è®¡ç®—å±æ€§å’Œæ™®é€šå±æ€§çš„å·®å¼‚</strong></p><h3 id="æ™®é€šå±æ€§æ”¶é›†ä¾èµ–"><a href="#æ™®é€šå±æ€§æ”¶é›†ä¾èµ–" class="headerlink" title="æ™®é€šå±æ€§æ”¶é›†ä¾èµ–"></a>æ™®é€šå±æ€§æ”¶é›†ä¾èµ–</h3><p>æ™®é€šå±æ€§æ˜¯åœ¨åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹å¯¹è±¡æ—¶æ”¶é›†ä¾èµ–çš„ã€‚åœ¨åˆ›å»ºè§‚å¯Ÿè€…çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œè§‚å¯Ÿè€…çš„æ„é€ å‡½æ•°æ–¹æ³•ï¼Œæ„é€ å‡½æ•°æ–¹æ³•çš„æœ€åä¼šè°ƒç”¨<code>get</code>æ–¹æ³•è·å–è§‚å¯Ÿç›®æ ‡çš„å€¼ï¼Œè·å–å€¼çš„åŒæ—¶ä¼šè§¦å‘è§‚å¯Ÿç›®æ ‡çš„<code>getter</code>ï¼Œ<code>getter</code>å°±ä¼šæŠŠè§‚å¯Ÿè€…æ”¶é›†åˆ°<code>dep</code>ä¸­ã€‚</p><h3 id="è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–"><a href="#è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–" class="headerlink" title="è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–"></a>è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–</h3><p>è®¡ç®—å±æ€§ä¸æ˜¯åœ¨åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹çš„è¿‡ç¨‹ä¸­æ”¶é›†ä¾èµ–ã€‚</p><p>åœ¨åˆ›å»ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…æ—¶ï¼Œä¼šä¼ å…¥ä¸€ä¸ªé€‰é¡¹<code>options</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>{ lazy: true }</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">watchers[key] = <span class="keyword">new</span> Watcher(</span><br><span class="line">  vm,</span><br><span class="line">  getter || noop,</span><br><span class="line">  noop,</span><br><span class="line">  computedWatcherOptions <span class="comment">// ! è®¡ç®—å±æ€§é€‰é¡¹ &#123; lazy: true &#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨è§‚å¯Ÿè€…çš„æ„é€ å‡½æ•°çš„æœ€åä¸€è¡Œä»£ç ä¸­ï¼Œä¼šåˆ¤æ–­<code>this.lazy</code>çš„å€¼æ˜¯å¦ä¸º<code>true</code>ï¼Œå¦‚æœä¸º<code>true</code>ï¼Œä¸ä¼šè°ƒç”¨<code>get</code>å‡½æ•°è·å–å€¼å’Œæ”¶é›†ä¾èµ–ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ª<code>undefined</code>å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.lazy = !!options.lazy</span><br><span class="line"><span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy ? <span class="literal">undefined</span> : <span class="keyword">this</span>.get()</span><br></pre></td></tr></table></figure><p>é‚£è®¡ç®—å±æ€§ä»€ä¹ˆæ—¶å€™æ”¶é›†ä¾èµ–å‘¢ï¼Ÿå…¶å®æ˜¯åœ¨è®¿é—®è®¡ç®—å±æ€§çš„æ—¶å€™æ”¶é›†ä¾èµ–çš„ã€‚</p><p>çœ‹ä¸‹å®ƒåœ¨éæœåŠ¡ç«¯æ¸²æŸ“æ—¶æ˜¯æ€ä¹ˆåˆ›å»º<code>getter</code>çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key] <span class="comment">// ! è·å–è®¡ç®—å±æ€§è§‚å¯Ÿè€…</span></span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="comment">// ! å¦‚æœ dirty ä¸º true æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—å±æ€§çš„ä¾èµ–å·²ç»æ›´æ–°ï¼Œç°åœ¨å¯ä»¥æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">        watcher.evaluate() <span class="comment">// ! è°ƒç”¨ evaluate æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        watcher.depend() <span class="comment">// ! è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.value <span class="comment">// ! è¿”å›è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–åˆ°è®¡ç®—å±æ€§çš„è§‚å¯Ÿè€…ï¼Œç„¶ååˆ¤æ–­è§‚å¯Ÿè€…çš„<code>dirty</code>å±æ€§çš„å€¼æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœä¸ºçœŸï¼Œè¯´æ˜è®¡ç®—å±æ€§çš„æ‰€ä¾èµ–çš„å“åº”å¼æ•°æ®å·²ç»æ›´æ–°ï¼Œç„¶åè°ƒç”¨è§‚å¯Ÿè€…çš„<code>evaluate</code>æ–¹æ³•æ›´æ–°è§‚å¯Ÿè€…çš„å€¼ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ã€‚ç„¶ååˆ¤æ–­<code>Dep.target</code>æ˜¯å¦æœ‰å€¼ï¼Œå¦‚æœæœ‰å€¼çš„è¯ï¼Œè°ƒç”¨è§‚å¯Ÿè€…çš„<code>depend</code>æ”¶é›†ä¾èµ–ã€‚</p><h3 id="è®¡ç®—å±æ€§çš„å€¼çš„æ›´æ–°"><a href="#è®¡ç®—å±æ€§çš„å€¼çš„æ›´æ–°" class="headerlink" title="è®¡ç®—å±æ€§çš„å€¼çš„æ›´æ–°"></a>è®¡ç®—å±æ€§çš„å€¼çš„æ›´æ–°</h3><p>æˆ‘ä»¬çœ‹ä¸‹<code>evaluate</code>æ˜¯å¦‚ä½•æ›´æ–°è®¡ç®—å±æ€§çš„å€¼çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evaluate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.value = <span class="keyword">this</span>.get() <span class="comment">// ! è·å–è®¡ç®—å±æ€§çš„æ–°å€¼ï¼Œå¹¶è§¦å‘å®ƒæ‰€ä¾èµ–çš„å“åº”å¼å¯¹è±¡æ”¶é›†è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…</span></span><br><span class="line">  <span class="keyword">this</span>.dirty = <span class="literal">false</span> <span class="comment">// ! æ›´æ–°è®¡ç®—å±æ€§çš„å€¼åé‡æ–°è®¾ç½®ä¸º falseï¼Œè¿™æ—¶å†æ¬¡è®¿é—®è®¡ç®—å±æ€§æ—¶ï¼Œå®ƒå°±ä¸ä¼šå†æ±‚å€¼äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯è°ƒç”¨è§‚å¯Ÿè€…çš„<code>get</code>æ–¹æ³•æ¥æ›´æ–°å€¼ï¼Œæ›´æ–°åé‡æ–°æŠŠ<code>this.dirty</code>è®¾ç½®ä¸º<code>false</code>ã€‚ä¹‹åï¼Œå†è®¿é—®è®¡ç®—å±æ€§åï¼Œå°±ä¸ä¼šæ‰§è¡Œ<code>evaluate</code>æ±‚å€¼äº†ï¼Œå› ä¸ºå®ƒçš„å€¼è¿˜æ˜¯ä¸€æ ·çš„ã€‚</p><p>åªæœ‰åœ¨å®ƒæ‰€ä¾èµ–çš„å“åº”å¼å¯¹è±¡å‘ç°å˜åŒ–æ—¶ï¼Œè§¦å‘è®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„<code>update</code>å‡½æ•°ï¼ŒæŠŠ<code>dirty</code>è®¾ç½®ä¸º<code>true</code>ã€‚è¿™æ—¶å€™å†è®¿é—®è®¡ç®—å±æ€§ï¼Œå®ƒå°±ä¼šè°ƒç”¨<code>evaluate</code>æ–¹æ³•é‡æ–°æ±‚å€¼ã€‚</p><p><strong>å°ç»“</strong>ï¼šè®¡ç®—å±æ€§ä¸ä½†æ˜¯æ”¶é›†ä¾èµ–æ˜¯åœ¨è®¿é—®å±æ€§çš„æ—¶å€™ï¼Œæ›´æ–°å€¼ä¹Ÿæ˜¯åœ¨è®¿é—®å±æ€§çš„æ—¶å€™ã€‚</p><h2 id="è®¡ç®—å±æ€§çš„æ›´æ–°æµç¨‹"><a href="#è®¡ç®—å±æ€§çš„æ›´æ–°æµç¨‹" class="headerlink" title="è®¡ç®—å±æ€§çš„æ›´æ–°æµç¨‹"></a>è®¡ç®—å±æ€§çš„æ›´æ–°æµç¨‹</h2><p>åœ¨åˆå§‹åŒ–<code>computed</code>é€‰é¡¹çš„æ—¶å€™ï¼Œåˆ›å»ºè®¡ç®—å±æ€§çš„è§‚å¯Ÿè€…ï¼Œå¹¶ä¼ å…¥é€‰é¡¹<code>options</code>ï¼Œå®ƒçš„å€¼ä¸º<code>{ lazy: true }</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">watchers[key] = <span class="keyword">new</span> Watcher(</span><br><span class="line">  vm,</span><br><span class="line">  getter || noop,</span><br><span class="line">  noop,</span><br><span class="line">  computedWatcherOptions <span class="comment">// ! è®¡ç®—å±æ€§é€‰é¡¹ &#123; lazy: true &#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œè§‚å¯Ÿè€…çš„æ„é€ å‡½æ•°çš„ä»£ç ï¼Œåœ¨ä»£ç æœ€åä¸€è¡Œæ˜¯ä¸‹é¢è¿™æ ·çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy ? <span class="literal">undefined</span> : <span class="keyword">this</span>.get()</span><br></pre></td></tr></table></figure><p>æ‰€ä»¥è®¡ç®—å±æ€§åˆ›å»ºä¹‹åæ²¡æœ‰æ±‚å€¼ï¼Œå®ƒçš„å€¼æ˜¯<code>undefiend</code>ã€‚</p><p>åªæœ‰åœ¨æˆ‘ä»¬è®¿é—®è®¡ç®—å±æ€§çš„æ—¶å€™ï¼Œè§¦å‘å®ƒçš„<code>getter</code>ï¼Œå®ƒæ‰ä¼šæ±‚å€¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key] <span class="comment">// ! è·å–è§‚å¯Ÿè€…</span></span><br><span class="line">  <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">    <span class="comment">// ! å¦‚æœ dirty ä¸º true æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…å¯ä»¥æ›´æ–°</span></span><br><span class="line">    <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">      watcher.evaluate() <span class="comment">// ! è°ƒç”¨ evaluate æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      watcher.depend() <span class="comment">// ! è®¡ç®—å±æ€§æ”¶é›†ä¾èµ–</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> watcher.value <span class="comment">// ! è¿”å›è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ±‚å€¼ä¹Ÿæœ‰æ¡ä»¶çš„ï¼Œè¿™ä¹Ÿæ˜¯è®¡ç®—å±æ€§æ€§èƒ½å¥½çš„åœ°æ–¹ã€‚</p><p>ä»€ä¹ˆæ¡ä»¶ï¼Ÿå°±æ˜¯è®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„<code>ditry</code>å±æ€§å¿…é¡»ä¸º<code>true</code>ã€‚</p><p>åœ¨æˆ‘ä»¬åˆ›å»ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„æ—¶å€™ï¼Œ<code>dirty</code>å±æ€§çš„å€¼å’Œä¼ è¿›æ¥çš„<code>lazy</code>å€¼ç›¸åŒçš„ï¼Œå®ƒçš„å€¼ä¸º<code>true</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.lazy = !!options.lazy</span><br><span class="line"><span class="keyword">this</span>.dirty = <span class="keyword">this</span>.lazy <span class="comment">// for lazy watchers</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥åˆå§‹åŒ–<code>computed</code>é€‰é¡¹åï¼Œé‡Œé¢çš„è®¡ç®—å±æ€§éƒ½æœ‰ä¸€æ¬¡æ±‚å€¼æœºä¼šï¼Œçœ‹ä¸‹<code>evaluate</code>å‡½æ•°ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">evaluate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.value = <span class="keyword">this</span>.get() <span class="comment">// ! è·å–è®¡ç®—å±æ€§çš„æ–°å€¼ï¼Œå¹¶è§¦å‘å®ƒæ‰€ä¾èµ–çš„å“åº”å¼å¯¹è±¡æ”¶é›†è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…</span></span><br><span class="line">  <span class="keyword">this</span>.dirty = <span class="literal">false</span> <span class="comment">// ! æ›´æ–°è®¡ç®—å±æ€§çš„å€¼åé‡æ–°è®¾ç½®ä¸º falseï¼Œè¿™æ—¶å†æ¬¡è®¿é—®è®¡ç®—å±æ€§æ—¶ï¼Œå®ƒå°±ä¸ä¼šå†æ±‚å€¼äº†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨<code>get</code>æ–¹æ³•æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ï¼ŒåŒæ—¶ä¼šè§¦å‘å®ƒæ‰€ä¾èµ–çš„å“åº”å¼å¯¹è±¡æ”¶é›†è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…ã€‚æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ä¹‹åï¼Œä¼šé‡æ–°æŠŠ<code>dirty</code>å±æ€§è®¾ç½®ä¸º<code>false</code>ã€‚ä¹‹åï¼Œæˆ‘ä»¬å†æ¬¡è®¿é—®è®¡ç®—å±æ€§æ—¶ï¼Œå› ä¸º<code>dirty</code>çš„å€¼ä¸º<code>false</code>å°±ä¸ä¼šé€šè¿‡è§‚å¯Ÿè€…å‡½æ•°çš„<code>evaluate</code>æ–¹æ³•é‡å†™æ±‚å€¼ã€‚</p><p>å› ä¸ºè®¡ç®—å±æ€§çš„æ›´æ–°å€¼æ˜¯åœ¨è®¿é—®å®ƒçš„æ—¶å€™ï¼Œä¸å¯èƒ½æ¯æ¬¡è®¿é—®éƒ½å»æ±‚å€¼ï¼Œè¿™ä¼šéå¸¸å½±å“æ€§èƒ½ã€‚æ‰€ä»¥æ¯æ¬¡è®¿é—®çš„æ—¶å€™ï¼Œå¦‚æœå®ƒæ‰€ä¾èµ–çš„å“åº”æ€§æ•°æ®æ²¡æœ‰æ›´æ–°ï¼Œè®¡ç®—å±æ€§å°±ä¸€ç›´æ˜¯é‚£ä¸ªå€¼ã€‚</p><p>é‚£ä»€ä¹ˆæ—¶å€™è®¡ç®—å±æ€§çš„å€¼ä¼šæ›´æ–°å‘¢ï¼Ÿåªåœ¨å®ƒæ‰€ä¾èµ–çš„å“åº”æ€§å¯¹è±¡å‘ç°å˜åŒ–åæ‰ä¼šæ›´æ–°ã€‚è¿™åˆæ˜¯ä»€ä¹ˆåŸç†å‘¢ï¼Ÿ</p><p>å› ä¸ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…å·²ç»æ˜¯è®¡ç®—å±æ€§æ‰€ä¾èµ–çš„å“åº”å¼æ•°æ®çš„ä¾èµ–ï¼Œå½“è¿™ä¸ªæ•°æ®å‘ç”Ÿæ›´æ–°æ—¶ï¼Œä¼šè§¦å‘<code>setter</code>ï¼Œæ‰§è¡Œæ‰€æœ‰çš„ä¾èµ–æ›´æ–°ï¼Œè¿™åŒ…æ‹¬äº†è¿™ä¸ªè®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„æ›´æ–°ï¼Œè§‚å¯Ÿè€…æ›´æ–°æ˜¯ä¼šè°ƒç”¨<code>update</code>æ–¹æ³•çš„ï¼Œè€Œ<code>update</code>æ–¹æ³•å‰é¢çš„ä»£ç ä¼šæŠŠ<code>dirty</code>å±æ€§é‡æ–°è®¾ç½®ä¸º<code>true</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">update() &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="comment">// ! å¦‚æœå¯åŠ¨æ‡’æƒ°æ¨¡å¼  =&gt; æ›´æ–° dirty ä¸º trueï¼Œè¯´æ˜å¯ä»¥æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.lazy) &#123;</span><br><span class="line">    <span class="keyword">this</span>.dirty = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„<code>lazy</code>å±æ€§æ˜¯<code>true</code>ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®<code>dirty</code>ä¸º<code>true</code>ã€‚</p><p>ç„¶åï¼Œä½ å†è®¿é—®è®¡ç®—å±æ€§æ—¶ï¼Œè§¦å‘å®ƒçš„<code>getter</code>ï¼Œæ­¤æ—¶<code>dirty</code>çš„å€¼ä¸º<code>true</code>ï¼Œå°±ä¼šè°ƒç”¨<code>evaluate</code>å‡½æ•°æ›´æ–°è®¡ç®—å±æ€§çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key]</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="comment">// ! å¦‚æœ dirty ä¸º true æ—¶ï¼Œè¡¨ç¤ºè®¡ç®—å±æ€§è§‚å¯Ÿè€…å¯ä»¥æ›´æ–°</span></span><br><span class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">        watcher.evaluate() <span class="comment">// ! è°ƒç”¨ evaluate æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">      <span class="keyword">return</span> watcher.value <span class="comment">// ! è¿”å›è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">evaluate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.value = <span class="keyword">this</span>.get()</span><br><span class="line">  <span class="keyword">this</span>.dirty = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸‹é¢çœ‹ä¸‹ Vue çš„è®¡ç®—å±æ€§çš„å®ç°ï¼Œè®¡ç®—å±æ€§æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–çš„æ–¹å¼å’Œæ™®é€šçš„å“åº”å¼æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚&lt;/p&gt;
&lt;p&gt;å›åˆ°&lt;code&gt;initState&lt;/code&gt;å‡½æ•°ä¸­ï¼Œåœ¨&lt;code&gt;core/instance/state.js&lt;/code&gt;æ–‡ä»¶ä¸­ï¼Œçœ‹ä¸‹é¢çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opts.computed) initComputed(vm, opts.computed)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¦‚æœè®¾ç½®äº†&lt;code&gt;computed&lt;/code&gt;é€‰é¡¹ï¼Œå°±è°ƒç”¨&lt;code&gt;initComputed&lt;/code&gt;åˆå§‹åŒ–é€‰é¡¹ã€‚&lt;/p&gt;
&lt;h2 id=&quot;initComputed&quot;&gt;&lt;a href=&quot;#initComputed&quot; class=&quot;headerlink&quot; title=&quot;initComputed&quot;&gt;&lt;/a&gt;&lt;code&gt;initComputed&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;çœ‹ä¸‹&lt;code&gt;initComputed&lt;/code&gt;å‡½æ•°çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ! åˆå§‹åŒ–è®¡ç®—å±æ€§é€‰é¡¹&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;initComputed&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;vm: Component, computed: Object&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// $flow-disable-line&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; watchers = (vm._computedWatchers = &lt;span class=&quot;built_in&quot;&gt;Object&lt;/span&gt;.create(&lt;span class=&quot;literal&quot;&gt;null&lt;/span&gt;)) &lt;span class=&quot;comment&quot;&gt;// ! ç»´æŠ¤ä¸€ä¸ªå¸¸é‡å­˜å‚¨è®¡ç®—å±æ€§&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// computed properties are just getters during SSR&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; isSSR = isServerRendering()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é¦–å…ˆå£°æ˜ä¸€ä¸ªå¸¸é‡&lt;code&gt;watchers&lt;/code&gt;å­˜å‚¨&lt;code&gt;vm._computedWatchers&lt;/code&gt;å±æ€§ï¼Œé»˜è®¤å€¼æ˜¯ç©ºå¯¹è±¡ï¼Œ&lt;code&gt;vm._computedWatchers&lt;/code&gt;å±æ€§å­˜å‚¨å®ä¾‹å¯¹è±¡çš„è®¡ç®—å±æ€§è§‚å¯Ÿè€…ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹ä¾¦å¬å™¨</title>
    <link href="https://haledeng.com/blog/20190925-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%BE%A6%E5%90%AC%E5%99%A8/"/>
    <id>https://haledeng.com/blog/20190925-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%BE%A6%E5%90%AC%E5%99%A8/</id>
    <published>2019-09-25T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:16.767Z</updated>
    
    <content type="html"><![CDATA[<p>Vue ç»™æˆ‘ä»¬æä¾›äº†ä¾¦å¬å™¨æ–¹æ³•<code>vm.$watch</code>å’Œé€‰é¡¹<code>watch</code>ï¼Œç”¨æ¥è§‚å¯Ÿ Vue å®ä¾‹å˜åŒ–ï¼Œç„¶åæ‰§è¡Œä¸€äº›æ“ä½œã€‚</p><p>ä¸‹é¢çœ‹ä¸‹å®ƒä»¬æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå…¶å®å®ƒä»¬éƒ½æ˜¯åŸºäºè§‚å¯Ÿè€…<code>watcher</code>çš„å°è£…ã€‚</p><h2 id="vm-watch"><a href="#vm-watch" class="headerlink" title="vm.$watch"></a><code>vm.$watch</code></h2><p>å…ˆçœ‹<code>Vue.prototype.$watch</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>core/instance/state.js</code>æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.$watch = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  expOrFn: string | Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  cb: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆçœ‹ä¸‹<code>$watch</code>æ–¹æ³•çš„å‚æ•°ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯<code>expOrFn</code>ã€<code>cb</code>å’Œ<code>options</code>ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸‰ä¸ªå‚æ•°å¯¹åº”ç€<code>Watcher</code>æ„é€ å‡½æ•°çš„ç¬¬äºŒä¸ªåˆ°ç¬¬å››ä¸ªå‚æ•°ã€‚</p><a id="more"></a><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! cb æ˜¯å¯¹è±¡ï¼Œè°ƒç”¨ createWatcher æ–¹æ³•</span></span><br><span class="line"><span class="keyword">if</span> (isPlainObject(cb)) &#123;</span><br><span class="line">  <span class="keyword">return</span> createWatcher(vm, expOrFn, cb, options)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>vm</code>å­˜å‚¨å½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå³<code>this</code>ã€‚ç„¶ååˆ¤æ–­<code>cb</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œè°ƒç”¨<code>createWatcher</code>å‡½æ•°ï¼Œä¼ å…¥<code>vm</code>ä»¥åŠ<code>$watch</code>åŸæ¥çš„ä¸‰ä¸ªå‚æ•°ã€‚</p><h3 id="createWatcher"><a href="#createWatcher" class="headerlink" title="createWatcher"></a><code>createWatcher</code></h3><p>å…ˆçœ‹ä¸‹<code>createWatcher</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆ›å»º watcher çš„å·¥å‚å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWatcher</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  expOrFn: string | Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! ä¼ å…¥çš„ handler æ˜¯å¯¹è±¡æ—¶</span></span><br><span class="line">  <span class="keyword">if</span> (isPlainObject(handler)) &#123;</span><br><span class="line">    options = handler</span><br><span class="line">    handler = handler.handler <span class="comment">// ! è·å–å¯¹è±¡é‡Œçš„ handler æ–¹æ³•ä½œä¸º cb</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ! ä¼ å…¥çš„ handler æ˜¯å­—ç¬¦ä¸²æ—¶  =&gt; watch: &#123; name: 'cbName' &#125;</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">'string'</span>) &#123;</span><br><span class="line">    handler = vm[handler] <span class="comment">// ! è·å–ç›¸åŒåå­—çš„å‡½æ•°ä½œä¸º cb</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm.$watch(expOrFn, handler, options) <span class="comment">// ! æœ€åè°ƒç”¨å®ä¾‹çš„ $watch æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦å¤„ç†åœ¨<code>$watch</code>æ–¹æ³•ä¸­ä¼ å…¥çš„<code>cb</code>å‚æ•°ä¸æ˜¯å‡½æ•°çš„æƒ…å†µï¼Œå®ƒçš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>handler</code>å¯¹åº”<code>$watch</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>cb</code>ã€‚</p><p>è¿™é‡Œå†æ¬¡åˆ¤æ–­<code>handler</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°<code>options</code>ç¼“å­˜ç¬¬ä¸‰ä¸ªå‚æ•°<code>handler</code>çš„å€¼ï¼Œè€Œç¬¬ä¸‰ä¸ªå‚æ•°<code>handler</code>çš„å€¼ä¸ºå®ƒçš„<code>handler</code>å±æ€§ï¼Œå³å›è°ƒå‡½æ•°ã€‚</p><p>ç„¶ååˆ¤æ–­<code>handler</code>æ˜¯ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œ<code>handler</code>çš„å€¼ä¸ºå®ä¾‹å¯¹è±¡çš„<code>handler</code>å±æ€§ï¼Œå³å»å®ä¾‹å¯¹è±¡è·å–åä¸º<code>handler</code>çš„æ–¹æ³•ä½œä¸ºå›è°ƒå‡½æ•°ã€‚</p><p>æœ€åå†æ¬¡è°ƒç”¨<code>vm.$watch</code>æ–¹æ³•ï¼Œå¹¶æŠŠ<code>handler</code>ä½œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°å³å›è°ƒå‡½æ•°<code>cb</code>ä¼ å…¥ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>createWatcher</code>å‡½æ•°å°±æ˜¯é€šè¿‡ä¸æ˜¯å‡½æ•°ç±»å‹çš„<code>cb</code>å¾—åˆ°å‡½æ•°ç±»å‹çš„<code>handler</code>ï¼Œç„¶åå†æ¬¡è°ƒç”¨<code>vm.$watch</code>æ–¹æ³•ã€‚ç»è¿‡è¿™ä¸ªæ–¹æ³•å¤„ç†åï¼Œ<code>vm.$watch</code>æ–¹æ³•çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>cb</code>å°±ä¸€å®šæ˜¯å‡½æ•°ã€‚</p><p>ç„¶ååˆå›åˆ°<code>wm.$watch</code>æ–¹æ³•ä¸­ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">options = options || &#123;&#125;</span><br><span class="line">options.user = <span class="literal">true</span> <span class="comment">// ! è®¾ç½® user ä¸º trueï¼Œè¯´æ˜æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="keyword">const</span> watcher = <span class="keyword">new</span> Watcher(vm, expOrFn, cb, options) <span class="comment">// ! åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹ï¼Œå¹¶ä¼ å…¥è®¾ç½®çš„å‚æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! å¦‚æœè®¾ç½®äº† immediate</span></span><br><span class="line"><span class="keyword">if</span> (options.immediate) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    cb.call(vm, watcher.value) <span class="comment">// ! å…ˆç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    handleError(</span><br><span class="line">      error,</span><br><span class="line">      vm,</span><br><span class="line">      <span class="string">`callback for immediate watcher "<span class="subst">$&#123;watcher.expression&#125;</span>"`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unwatchFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  watcher.teardown() <span class="comment">// ! ç§»é™¤ watcher</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‡æ–°å®šä¹‰<code>options</code>ä¸ºä¼ å…¥çš„<code>options</code>å‚æ•°æˆ–è€…æ˜¯ä¸€ä¸ªç©ºå¯¹è±¡ï¼ˆæ²¡ä¼ å…¥å‚æ•°ï¼‰ã€‚</p><p>è®¾ç½®<code>options.user</code>å±æ€§ä¸º<code>true</code>ï¼Œè¯´æ˜ä¸‹é¢åˆ›å»ºçš„è§‚å¯Ÿè€…å¯¹è±¡æ˜¯ç”¨æˆ·å®šä¹‰çš„è§‚å¯Ÿè€…ï¼Œç„¶åé€šè¿‡<code>new</code>åˆ›å»ºä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹å¯¹è±¡ï¼ŒæŠŠå½“å‰çš„ç»„ä»¶å®ä¾‹<code>vm</code>å’Œ<code>$mount</code>æ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°ä¾æ¬¡ä¼ å…¥ã€‚</p><p>åˆ¤æ–­<code>options</code>é€‰é¡¹ä¸­<code>immediate</code>å±æ€§ä¸­æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡å›è°ƒå‡½æ•°<code>cb</code>ï¼Œä½¿ç”¨<code>call</code>æ‰§è¡Œï¼Œå‡½æ•°æŒ‡å‘å½“å‰çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¼ å…¥å‚æ•°<code>watcher.value</code>ï¼Œå³è§‚å¯Ÿè€…çš„æ–°å€¼ã€‚</p><p><code>$watch</code>æ–¹æ³•æœ€åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥å–æ¶ˆè§‚å¯Ÿï¼Œåˆ é™¤è§‚å¯Ÿè€…çš„ã€‚å‡½æ•°è°ƒç”¨è§‚å¯Ÿè€…çš„<code>teardown</code>æ–¹æ³•ã€‚</p><p>çœ‹ä¸‹<code>teardown</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>core/observer/watcher.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">teardown() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.active) &#123;</span><br><span class="line">    <span class="comment">// remove self from vm's watcher list</span></span><br><span class="line">    <span class="comment">// this is a somewhat expensive operation so we skip it</span></span><br><span class="line">    <span class="comment">// if the vm is being destroyed.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.vm._isBeingDestroyed) &#123;</span><br><span class="line">      remove(<span class="keyword">this</span>.vm._watchers, <span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="keyword">this</span>.deps.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="keyword">this</span>.deps[i].removeSub(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.active = <span class="literal">false</span> <span class="comment">// ! è®¾ç½®è§‚å¯Ÿè€…å®ä¾‹æ˜¯éæ¿€æ´»çŠ¶æ€</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>active</code>æ˜¯å¦ä¸ºçœŸï¼Œå³åˆ¤æ–­è§‚å¯Ÿè€…æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå†åˆ¤æ–­è§‚å¯Ÿè€…æ‰€å±å®ä¾‹å¯¹è±¡æ˜¯å¦å·²è¢«é”€æ¯ï¼Œå¦‚æœæ²¡æœ‰é”€æ¯çš„è¯ï¼ŒæŠŠè¿™ä¸ªè§‚å¯Ÿè€…ä»å®ä¾‹å¯¹è±¡ä¸­çš„<code>_watchers</code>å±æ€§ä¸­åˆ é™¤ï¼Œå³é”€æ¯å®ƒã€‚</p><p>ç„¶åé€šè¿‡é€’å‡è§‚å¯Ÿè€…<code>deps</code>çš„é•¿åº¦çš„æ–¹å¼éå†<code>deps</code>ï¼Œåœ¨<code>deps</code>é‡Œé¢å­˜åœ¨è§‚å¯Ÿè€…çš„<code>dep</code>é‡Œåˆ é™¤è§‚å¯Ÿè€…ï¼Œæœ€åæŠŠè§‚å¯Ÿè€…çš„<code>actice</code>å±æ€§è®¾ä¸º<code>false</code>ï¼Œè¡¨ç¤ºè§‚å¯Ÿè€…æ˜¯éæ¿€æ´»çŠ¶æ€ï¼Œè¿™æ ·è§‚å¯Ÿè€…çš„å›è°ƒå‡½æ•°å°±ä¸ä¼šæ‰§è¡Œäº†ã€‚</p><p>ç¤ºä¾‹å¯¹è±¡çš„<code>$watch</code>æ–¹æ³•ç¤ºä¾‹ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cb æ˜¯å‡½æ•°æ—¶</span></span><br><span class="line">vm.$watch(</span><br><span class="line">  <span class="string">'name'</span>,</span><br><span class="line">  () =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'change'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">immediate</span>: <span class="literal">true</span> &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// cb æ˜¯å¯¹è±¡æ—¶</span></span><br><span class="line">vm.$watch(<span class="string">'name'</span>, &#123;</span><br><span class="line">  handler: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'change'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  immediate: <span class="literal">true</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="watch"><a href="#watch" class="headerlink" title="watch"></a><code>watch</code></h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>vm.$watch</code>è§‚å¯Ÿ Vue å®ä¾‹å˜åŒ–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>watch</code>é€‰é¡¹åšç›¸åŒçš„äº‹æƒ…ã€‚<code>watch</code>é€‰é¡¹æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„é”®æ˜¯éœ€è¦è§‚å¯Ÿçš„æ•°æ®ï¼Œå€¼æ˜¯å¯¹åº”çš„å›è°ƒå‡½æ•°æˆ–è€…å¤„ç†å™¨å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å·²ç»å£°æ˜çš„æ–¹æ³•çš„åç§°ã€‚</p><p>åœ¨ Vue çš„å®ä¾‹å¯¹è±¡åˆå§‹åŒ–æ—¶ï¼Œé€šè¿‡éå†<code>watch</code>é€‰é¡¹ä¸­ï¼Œç„¶ååˆ›å»ºè§‚å¯Ÿè€…ã€‚</p><p>æŸ¥çœ‹<code>initWatch</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/instance/state.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åˆå§‹åŒ– watch é€‰é¡¹</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWatch</span>(<span class="params">vm: Component, watch: Object</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! éå† watch</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = watch[key] <span class="comment">// ! è·å– handler</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! å¦‚æœ handler æ˜¯æ•°ç»„ï¼ˆå¤šä¸ªè§‚å¯Ÿè€…ï¼‰ï¼Œéå†æ•°ç»„ååˆ†åˆ«åˆ›å»º Watcher å®ä¾‹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.length; i++) &#123;</span><br><span class="line">        createWatcher(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      createWatcher(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éå†<code>watch</code>é€‰é¡¹ï¼Œé€šè¿‡<code>key</code>è·å–åˆ°å®ƒçš„å€¼<code>handler</code>ã€‚</p><p>ç„¶ååˆ¤æ–­<code>handler</code>æ˜¯ä¸æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„çš„è¯ï¼Œå†éå†ä¸€æ¬¡ï¼Œåœ¨æ¯æ¬¡å¾ªç¯çš„è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨<code>createWatcher</code>å‡½æ•°åˆ›å»ºè§‚å¯Ÿè€…ï¼›å¦‚æœä¸æ˜¯æ•°ç»„çš„è¯ï¼Œç›´æ¥è°ƒç”¨<code>createWatcher</code>å‡½æ•°åˆ›å»ºè§‚å¯Ÿè€…ã€‚</p><p>é€šè¿‡<code>createWatcher</code>å‡½æ•°å¤„ç†å„ç§ç±»å‹çš„<code>handler</code>ï¼ŒåŒ…æ‹¬å‡½æ•°ã€å¯¹è±¡ã€å­—ç¬¦ä¸²ï¼Œæœ€ååˆ›å»ºè§‚å¯Ÿè€…ã€‚</p><p>ç»„ä»¶ä¸­<code>watch</code>é€‰é¡¹çš„ç¤ºä¾‹ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨å®˜æ–¹æ–‡æ¡£çš„ä¾‹å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  data: &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span>,</span><br><span class="line">    c: <span class="number">3</span>,</span><br><span class="line">    d: <span class="number">4</span>,</span><br><span class="line">    e: &#123;</span><br><span class="line">      f: &#123;</span><br><span class="line">        g: <span class="number">5</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    a: <span class="function"><span class="keyword">function</span>(<span class="params">val, oldVal</span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'new: %s, old: %s'</span>, val, oldVal)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">    b: <span class="string">'someMethod'</span>,</span><br><span class="line">    <span class="comment">// è¯¥å›è°ƒä¼šåœ¨ä»»ä½•è¢«ä¾¦å¬çš„å¯¹è±¡çš„ property æ”¹å˜æ—¶è¢«è°ƒç”¨ï¼Œä¸è®ºå…¶è¢«åµŒå¥—å¤šæ·±</span></span><br><span class="line">    c: &#123;</span><br><span class="line">      handler: <span class="function"><span class="keyword">function</span>(<span class="params">val, oldVal</span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">      &#125;,</span><br><span class="line">      deep: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// è¯¥å›è°ƒå°†ä¼šåœ¨ä¾¦å¬å¼€å§‹ä¹‹åè¢«ç«‹å³è°ƒç”¨</span></span><br><span class="line">    d: &#123;</span><br><span class="line">      handler: <span class="string">'someMethod'</span>,</span><br><span class="line">      immediate: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// å¤šä¸ª watcher</span></span><br><span class="line">    e: [</span><br><span class="line">      <span class="string">'handle1'</span>,</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">handle2</span>(<span class="params">val, oldVal</span>) </span>&#123;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        handler: <span class="function"><span class="keyword">function</span> <span class="title">handle3</span>(<span class="params">val, oldVal</span>) </span>&#123;</span><br><span class="line">          <span class="comment">/* ... */</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// watch vm.e.f's value: &#123;g: 5&#125;</span></span><br><span class="line">    <span class="string">'e.f'</span>: <span class="function"><span class="keyword">function</span>(<span class="params">val, oldVal</span>) </span>&#123;</span><br><span class="line">      <span class="comment">/* ... */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">vm.a = <span class="number">2</span> <span class="comment">// =&gt; new: 2, old: 1</span></span><br></pre></td></tr></table></figure><h2 id="æ·±åº¦ç›‘å¬"><a href="#æ·±åº¦ç›‘å¬" class="headerlink" title="æ·±åº¦ç›‘å¬"></a>æ·±åº¦ç›‘å¬</h2><p>åœ¨è§‚å¯Ÿè€…çš„<code>get</code>æ–¹æ³•ä¸­ï¼Œå¦‚æœ<code>this.deep</code>çš„å€¼ä¸º<code>true</code>ä¼šè¿›è¡Œæ·±åº¦ç›‘å¬ï¼Œæ·±åº¦ç›‘å¬çš„ç›®æ ‡æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>() &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// ! å¦‚æœæ˜¯æ·±åº¦è§‚å¯Ÿ =&gt; ç”¨äº watch é€‰é¡¹</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</span><br><span class="line">      traverse(value) <span class="comment">// ! é€’å½’å»è®¿é—® valueï¼Œè§¦å‘å®ƒæ‰€æœ‰å­é¡¹çš„ getter</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>traverse</code>å‡½æ•°å»é€’å½’è®¿é—®<code>value</code>çš„å€¼ï¼Œè§¦å‘å®ƒæ‰€æœ‰å­é¡¹çš„<code>getter</code>ã€‚</p><p>çœ‹ä¸‹<code>traverse</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> seenObjects = <span class="keyword">new</span> <span class="built_in">Set</span>() <span class="comment">// ! å­˜å‚¨ id å€¼çš„é›†åˆ</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">traverse</span>(<span class="params">val: any</span>) </span>&#123;</span><br><span class="line">  _traverse(val, seenObjects)</span><br><span class="line">  seenObjects.clear()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>_traverse</code>æ–¹æ³•ï¼ŒæŠŠ<code>val</code>å’Œ<code>seenObjects</code>é›†åˆä¼ å…¥ï¼Œæœ€åè°ƒç”¨<code>seenObjects</code>å¯¹è±¡çš„<code>clear</code>æ–¹æ³•æ¸…ç©º<code>seenObjects</code>é›†åˆçš„å…ƒç´ ã€‚</p><p>å†çœ‹ä¸‹<code>_traverse</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_traverse</span>(<span class="params">val: any, seen: SimpleSet</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i, keys</span><br><span class="line">  <span class="keyword">const</span> isA = <span class="built_in">Array</span>.isArray(val)</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    (!isA &amp;&amp; !isObject(val)) ||</span><br><span class="line">    <span class="built_in">Object</span>.isFrozen(val) ||</span><br><span class="line">    val <span class="keyword">instanceof</span> VNode</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå£°æ˜å˜é‡<code>i</code>å’Œ<code>keys</code>ï¼›å†å£°æ˜å¸¸é‡<code>isA</code>ï¼Œ<code>isA</code>æ˜¯ç”¨æ¥åˆ¤æ–­ä¼ å…¥çš„å‚æ•°<code>val</code>æ˜¯å¦æ˜¯æ•°ç»„ã€‚</p><p>åˆ¤æ–­<code>val</code>çš„å€¼çš„ç±»å‹ï¼Œå¦‚æœ<code>val</code>æ˜¯éæ•°ç»„éå¯¹è±¡ç±»å‹ï¼Œæˆ–è€…æ˜¯ä¸å¯æ‰©å±•çš„ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª<code>VNode</code>ï¼Œç›´æ¥è¿”å›ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (val.__ob__) &#123;</span><br><span class="line">  <span class="keyword">const</span> depId = val.__ob__.dep.id</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! å·²ç»éå†çš„å¯¹è±¡ï¼Œä¸ä¼šå†éå†ï¼Œé¿å…å¾ªç¯å¼•ç”¨</span></span><br><span class="line">  <span class="keyword">if</span> (seen.has(depId)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  seen.add(depId)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>val</code>æ˜¯å¦å­˜åœ¨<code>__ob__</code>å±æ€§ï¼Œå³å®ƒæ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå£°æ˜å¸¸é‡<code>depId</code>å­˜å‚¨ä»<code>val.__ob__</code>å±æ€§è·å–åˆ°çš„<code>dep</code>çš„<code>id</code>ï¼Œè¿™ä¸ª<code>id</code>æ˜¯<code>dep</code>çš„å”¯ä¸€æ ‡è¯†ã€‚</p><p>åˆ¤æ–­é›†åˆ<code>seen</code>ä¸­æ˜¯å¦å­˜åœ¨<code>depId</code>ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›ï¼Œè¿™è¯´æ˜<code>dep</code>å·²ç»æ”¶é›†è¿‡ä¾èµ–ï¼Œä¸éœ€è¦å†é‡å¤æ”¶é›†ã€‚</p><p>å¦‚æœ<code>seen</code>ä¸­ä¸å­˜åœ¨<code>depId</code>ï¼ŒæŠŠ<code>depId</code>æ·»åŠ åˆ°é›†åˆ<code>seen</code>ä¸­ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ•°ç»„</span></span><br><span class="line"><span class="keyword">if</span> (isA) &#123;</span><br><span class="line">  i = val.length</span><br><span class="line">  <span class="keyword">while</span> (i--) _traverse(val[i], seen)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! å¯¹è±¡</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  keys = <span class="built_in">Object</span>.keys(val)</span><br><span class="line">  i = keys.length</span><br><span class="line">  <span class="keyword">while</span> (i--) _traverse(val[keys[i]], seen)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·±åº¦è§‚æµ‹çš„å¯¹è±¡åªèƒ½æ˜¯å¯¹è±¡æˆ–è€…æ•°ç»„ï¼Œä¸ç®¡æ˜¯å“ªç§ç±»å‹éƒ½æ˜¯éå†å®ƒï¼Œç„¶åè®¿é—®å®ƒçš„æ¯ä¸€ä¸ªå­é¡¹ï¼Œè§¦å‘å­é¡¹çš„<code>getter</code>ï¼Œæ”¶é›†ä¾èµ–ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Vue ç»™æˆ‘ä»¬æä¾›äº†ä¾¦å¬å™¨æ–¹æ³•&lt;code&gt;vm.$watch&lt;/code&gt;å’Œé€‰é¡¹&lt;code&gt;watch&lt;/code&gt;ï¼Œç”¨æ¥è§‚å¯Ÿ Vue å®ä¾‹å˜åŒ–ï¼Œç„¶åæ‰§è¡Œä¸€äº›æ“ä½œã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢çœ‹ä¸‹å®ƒä»¬æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå…¶å®å®ƒä»¬éƒ½æ˜¯åŸºäºè§‚å¯Ÿè€…&lt;code&gt;watcher&lt;/code&gt;çš„å°è£…ã€‚&lt;/p&gt;
&lt;h2 id=&quot;vm-watch&quot;&gt;&lt;a href=&quot;#vm-watch&quot; class=&quot;headerlink&quot; title=&quot;vm.$watch&quot;&gt;&lt;/a&gt;&lt;code&gt;vm.$watch&lt;/code&gt;&lt;/h2&gt;&lt;p&gt;å…ˆçœ‹&lt;code&gt;Vue.prototype.$watch&lt;/code&gt;æ–¹æ³•çš„ä»£ç ï¼Œåœ¨&lt;code&gt;core/instance/state.js&lt;/code&gt;æ–‡ä»¶ä¸­ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Vue.prototype.$watch = &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  expOrFn: string | Function,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  cb: any,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  options?: Object&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;): &lt;span class=&quot;title&quot;&gt;Function&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;é¦–å…ˆçœ‹ä¸‹&lt;code&gt;$watch&lt;/code&gt;æ–¹æ³•çš„å‚æ•°ï¼Œæœ‰ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯&lt;code&gt;expOrFn&lt;/code&gt;ã€&lt;code&gt;cb&lt;/code&gt;å’Œ&lt;code&gt;options&lt;/code&gt;ï¼Œæˆ‘ä»¬å‘ç°è¿™ä¸‰ä¸ªå‚æ•°å¯¹åº”ç€&lt;code&gt;Watcher&lt;/code&gt;æ„é€ å‡½æ•°çš„ç¬¬äºŒä¸ªåˆ°ç¬¬å››ä¸ªå‚æ•°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹è§‚å¯Ÿè€…çš„æ‰§è¡Œ</title>
    <link href="https://haledeng.com/blog/20190923-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85%E7%9A%84%E6%89%A7%E8%A1%8C/"/>
    <id>https://haledeng.com/blog/20190923-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85%E7%9A%84%E6%89%A7%E8%A1%8C/</id>
    <published>2019-09-23T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:11.476Z</updated>
    
    <content type="html"><![CDATA[<h2 id="åŒæ­¥æ‰§è¡Œ"><a href="#åŒæ­¥æ‰§è¡Œ" class="headerlink" title="åŒæ­¥æ‰§è¡Œ"></a>åŒæ­¥æ‰§è¡Œ</h2><h3 id="å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ"><a href="#å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ" class="headerlink" title="å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ"></a>å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ</h3><p>å…ˆçœ‹ä¸‹åŒæ­¥æ‰§è¡Œçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åŒæ­¥æ‰§è¡Œï¼Œä¸éœ€è¦è°ƒç”¨ nextTick æ‰§è¡Œè§‚å¯Ÿè€… =&gt; ç”¨äº watch è‡ªå®šä¹‰çš„è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sync) &#123;</span><br><span class="line">  <span class="keyword">this</span>.run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœè®¾ç½®äº†è§‚å¯Ÿè€…çš„<code>sync</code>å±æ€§ä¸º<code>true</code>çš„è¯ï¼Œä¼šæ‰§è¡Œäº†è§‚å¯Ÿè€…çš„<code>run</code>æ–¹æ³•ï¼Œæ‰§è¡ŒåŒæ­¥æ›´æ–°ã€‚</p><a id="more"></a><p>æ€ä¹ˆè®¾ç½®<code>sync</code>å±æ€§å‘¢ï¼Ÿçœ‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  watch: &#123;</span><br><span class="line">    someWatch: &#123;</span><br><span class="line">      handler() &#123;</span><br><span class="line">        <span class="comment">/* ... */</span></span><br><span class="line">      &#125;,</span><br><span class="line">      sync: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬è®¾ç½®<code>watch</code>é€‰é¡¹æ—¶ï¼Œè®¾ç½®ä¸€ä¸ªå¯¹è±¡è€Œä¸æ˜¯å‡½æ•°ï¼Œç„¶åè®¾ç½®<code>sync</code>çš„å€¼ã€‚</p><p>çœ‹ä¸‹<code>run</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">run() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.active) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = <span class="keyword">this</span>.get() <span class="comment">// ! è·å–å€¼ =&gt; æ‰§è¡Œ getterï¼Œå¦‚æœæ‰§è¡Œçš„æ˜¯ updateComponentï¼Œè¿”å› undefined</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      value !== <span class="keyword">this</span>.value ||</span><br><span class="line">      <span class="comment">// Deep watchers and watchers on Object/Arrays should fire even</span></span><br><span class="line">      <span class="comment">// when the value is the same, because the value may</span></span><br><span class="line">      <span class="comment">// have mutated.</span></span><br><span class="line">      isObject(value) ||</span><br><span class="line">      <span class="keyword">this</span>.deep</span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="comment">// set new value</span></span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value <span class="comment">// ! ç¼“å­˜æ—§å€¼</span></span><br><span class="line">      <span class="keyword">this</span>.value = value <span class="comment">// ! æ—§å€¼æ›´æ–°ä¸ºæ–°å€¼</span></span><br><span class="line">      <span class="comment">// ! å¤„ç†ç”¨æˆ·å®šä¹‰çš„è§‚å¯Ÿè€…ï¼Œæ¯”å¦‚ watch $watch</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.user) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue) <span class="comment">// ! ä¼ å…¥æ–°æ—§å€¼ï¼Œæ‰§è¡Œå›è°ƒå‡½æ•°æ›´æ–°è§†å›¾</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          handleError(e, <span class="keyword">this</span>.vm, <span class="string">`callback for watcher "<span class="subst">$&#123;<span class="keyword">this</span>.expression&#125;</span>"`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>this.active</code>æ˜¯å¦ä¸º<code>true</code>ï¼Œå¦‚æœä¸º<code>true</code>ï¼Œè¯´æ˜å½“å‰è§‚å¯Ÿè€…æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œå¯ä»¥æ‰§è¡Œæ›´æ–°ã€‚åœ¨æˆ‘ä»¬åˆ é™¤è§‚å¯Ÿè€…çš„æ—¶å€™ï¼Œè¿™ä¸ªå€¼ä¼šä¸º<code>false</code>ï¼Œè¡¨ç¤ºè§‚å¯Ÿè€…æ˜¯éæ¿€æ´»çŠ¶æ€ï¼Œä¸ä¼šæ‰§è¡Œæ›´æ–°ã€‚</p><p>é¦–å…ˆï¼Œå£°æ˜å˜é‡<code>value</code>å­˜å‚¨è°ƒç”¨<code>this.get</code>æ–¹æ³•è·å–åˆ°æ–°å€¼ï¼Œå†åˆ¤æ–­æ–°å€¼å’Œæ—§å€¼æ˜¯å¦ä¸ç›¸åŒï¼Œæ–°å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ªé<code>null</code>çš„å¯¹è±¡ï¼Œä»¥åŠ<code>this.deep</code>çš„å€¼æ˜¯å¦ä¸º<code>true</code>ã€‚å¦‚æœæ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶å°±ä¼šè¿›è¡Œä¸‹é¢çš„é€»è¾‘ã€‚</p><p>å£°æ˜å¸¸é‡<code>oldValue</code>å­˜å‚¨æ—§å€¼ï¼Œç„¶åæŠŠ<code>this.value</code>æ›´æ–°ä¸ºæ–°å€¼<code>value</code>ã€‚ç„¶ååˆ¤æ–­<code>this.user</code>çš„å€¼æ˜¯å¦ä¸º<code>ture</code>ï¼Œå¦‚æœä¸º<code>true</code>è¯´æ˜è¿™ä¸ªè§‚å¯Ÿè€…æ˜¯ç”¨æˆ·å®šä¹‰çš„ã€‚å†è°ƒç”¨<code>this.cb</code>å‡½æ•°å»æ›´æ–°è§†å›¾ï¼Œè°ƒç”¨æ—¶ä½¿ç”¨<code>call</code>æ–¹æ³•ï¼Œå‡½æ•°æŒ‡å‘è§‚å¯Ÿè€…æ‰€å±çš„å®ä¾‹å¯¹è±¡ï¼Œå¹¶ä¼ å…¥æ–°å€¼å’Œæ—§å€¼ã€‚</p><p>å› ä¸ºç”±ç”¨æˆ·å®šä¹‰çš„è§‚å¯Ÿè€…ï¼Œå¯èƒ½ä¼šå‡ºé”™ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨<code>try...catch</code>è¯­å¥æ¥æ‰§è¡Œå›è°ƒå‡½æ•°<code>cb</code>ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½æ•è·å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚åœ¨<code>catch</code>ä»£ç å—ä¸­ä½¿ç”¨äº†<code>this.expression</code>æ­£æ˜¯å‰é¢å®šä¹‰çš„<code>expOrFn</code>å‡½æ•°çš„å­—ç¬¦ä¸²è½¬æ¢å€¼ï¼Œä¸ºäº†æ›´å¥½çš„æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ã€‚</p><p>å¦‚æœ<code>this.user</code>ä¸º<code>false</code>ï¼Œè¯´æ˜æ˜¯è¿™ä¸ªè§‚å¯Ÿè€…æ˜¯ Vue å†…éƒ¨å®šä¹‰çš„ï¼Œä¸è¿‡è¿˜æ˜¯ä½¿ç”¨å’Œç”¨æˆ·å®šä¹‰çš„è§‚å¯Ÿä¸€æ ·çš„æ–¹æ³•è°ƒç”¨å®ƒï¼Œåªæ˜¯å°‘äº†æ•è·é”™è¯¯çš„ä»£ç ã€‚</p><p><strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œè¯´çš„è§‚å¯Ÿè€…æ‰§è¡Œï¼ŒæŒ‡çš„æ˜¯è§‚å¯Ÿè€…çš„<strong>å›è°ƒå‡½æ•°</strong>çš„è°ƒç”¨ã€‚è§‚å¯Ÿè€…æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œå®ƒæ˜¯ä¸èƒ½æ‰§è¡Œè°ƒç”¨çš„ã€‚</p><h3 id="å…¨å±€è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ"><a href="#å…¨å±€è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ" class="headerlink" title="å…¨å±€è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ"></a>å…¨å±€è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ</h3><p>ä¸Šé¢è®²è§£äº†å•ä¸ªè§‚å¯Ÿè€…ï¼ˆçš„å›è°ƒå‡½æ•°ï¼‰åŒæ­¥æ‰§è¡Œè¿‡ç¨‹ï¼Œå…¶å® Vue è¿˜æä¾›äº†ä¸€ä¸ªå…¨å±€é…ç½®å±æ€§<code>Vue.config.async</code>ï¼Œé»˜è®¤æ˜¯<code>true</code>ï¼Œå³é»˜è®¤ Vue çš„æ‰€æœ‰è§‚å¯Ÿè€…çš„å›è°ƒå‡½æ•°éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚</p><p>è®¾ç½®è¿™ä¸ªå±æ€§çš„ä»£ç åœ¨<code>core/config.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Perform updates asynchronously. Intended to be used by Vue Test Utils</span></span><br><span class="line"><span class="comment">   * This will significantly reduce performance if set to false.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨é¡¹ç›®çš„å…¥å£æ–‡ä»¶æŠŠ<code>Vue.config.async</code>çš„å€¼è®¾ç½®ä¸º<code>false</code>ï¼Œé‚£ä¹ˆ Vue çš„æ‰€æœ‰çš„è§‚å¯Ÿè€…éƒ½æ˜¯åŒæ­¥æ‰§è¡Œã€‚</p><p>Vue çš„è§‚å¯Ÿè€…é»˜è®¤æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå¼‚æ­¥æ‰§è¡Œçš„ä»£ç åœ¨<code>core/observer/scheduler.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueWatcher</span>(<span class="params">watcher: Watcher</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// ! åŒæ­¥æ‰§è¡Œï¼Œä¸»è¦ç”¨äºéç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !config.async) &#123;</span><br><span class="line">      flushSchedulerQueue() <span class="comment">// ! ç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    nextTick(flushSchedulerQueue) <span class="comment">// ! ä½¿ç”¨ nextTick æ‰§è¡Œé˜Ÿåˆ—çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠè§‚å¯Ÿè€…æ”¾å…¥çš„ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åå¼‚æ­¥æ‰§è¡Œé˜Ÿåˆ—ã€‚</p><p>å¦‚æœè®¾ç½®äº†æ‰€æœ‰è§‚å¯Ÿè€…éƒ½æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆåŒæ­¥æ‰§è¡Œçš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æŒ‰ç…§<code>id</code>çš„é¡ºåºæ‰§è¡Œçš„ã€‚</p><p>çœ‹ä¸‹é˜Ÿåˆ—ä¸­è§‚å¯Ÿè€…æ˜¯æ€ä¹ˆæ‰§è¡Œçš„ï¼ŒæŸ¥çœ‹<code>flushSchedulerQueue</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSchedulerQueue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  queue.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id) <span class="comment">// é˜Ÿåˆ—ä¸­å…ƒç´ å‡åºæ’åº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå†çœ‹ä¸‹è®¢é˜…å™¨<code>dep</code>æ˜¯æ€ä¹ˆè§¦å‘ä¾èµ–ï¼Œå³æ€ä¹ˆé€šçŸ¥è§‚å¯Ÿè€…çš„ã€‚</p><p>æŸ¥çœ‹<code>notify</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>core/observer/dep.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">notify() &#123;</span><br><span class="line">    <span class="comment">// stabilize the subscriber list first</span></span><br><span class="line">    <span class="keyword">const</span> subs = <span class="keyword">this</span>.subs.slice()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! åŒæ­¥æ‰§è¡Œè§‚å¯Ÿè€…ï¼Œä¸æ˜¯å¼‚æ­¥é˜Ÿåˆ—å…¨éƒ¨å…¥é˜Ÿåä¸€èµ·æ‰§è¡Œ</span></span><br><span class="line">    <span class="comment">// ! éœ€è¦æŒ‰ç…§é¡ºåºæ¥æ‰§è¡Œï¼Œä¸»è¦ç”¨äºéç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !config.async) &#123;</span><br><span class="line">      <span class="comment">// subs aren't sorted in scheduler if not running async</span></span><br><span class="line">      <span class="comment">// we need to sort them now to make sure they fire in correct</span></span><br><span class="line">      <span class="comment">// order</span></span><br><span class="line">      subs.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id) <span class="comment">// ! id å‡åºæ’åº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].update()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>å‘ç°è¿™é‡Œä¹Ÿæ˜¯æŒ‰ç…§<code>id</code>çš„æ’åºæ¥é€šçŸ¥è§‚å¯Ÿè€…çš„ã€‚æ’åºä¸»è¦æ˜¯ä¸ºäº†ä¿è¯è§‚å¯Ÿè€…æŒ‰ç…§å®ƒåˆ›å»ºæ—¶çš„é¡ºåºæ‰§è¡Œï¼Œé¿å…é”™è¯¯ã€‚</p><h2 id="å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°"><a href="#å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°" class="headerlink" title="å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°"></a>å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°</h2><p>å¦‚æœæ²¡æœ‰è®¾ç½®è§‚å¯Ÿè€…çš„æ‰§è¡Œæ¨¡å¼ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹å¼‚æ­¥æ‰§è¡Œçš„ä»£ç ï¼Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦è°ƒç”¨ nextTick æ‰§è¡Œè§‚å¯Ÿè€… =&gt; ç”¨äºæ‰§è¡Œè‡ªåŠ¨æ”¶é›†çš„ä¾èµ–</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  queueWatcher(<span class="keyword">this</span>) <span class="comment">// ! ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>queueWatcher</code>å‡½æ•°ï¼Œå¹¶æŠŠå½“å‰çš„è§‚å¯Ÿè€…ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>queueWatcher</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/observer/scheduler.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> has: &#123; [key: number]: ?<span class="literal">true</span> &#125; = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> waiting = <span class="literal">false</span> <span class="comment">// ! ç­‰å¾…æ ‡è¯†</span></span><br><span class="line"><span class="keyword">let</span> flushing = <span class="literal">false</span> <span class="comment">// ! é˜Ÿåˆ—æ˜¯å¦æ­£åœ¨æ‰§è¡Œæ›´æ–°</span></span><br><span class="line"><span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;Watcher&gt; = []</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">queueWatcher</span>(<span class="params">watcher: Watcher</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.id</span><br><span class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;</span><br><span class="line">    has[id] = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> (!flushing) &#123;</span><br><span class="line">      queue.push(watcher) <span class="comment">// ! é˜Ÿå°¾å…¥é˜Ÿ</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// if already flushing, splice the watcher based on its id</span></span><br><span class="line">      <span class="comment">// if already past its id, it will be run next immediately.</span></span><br><span class="line">      <span class="keyword">let</span> i = queue.length - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].id &gt; watcher.id) &#123;</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">      queue.splice(i + <span class="number">1</span>, <span class="number">0</span>, watcher) <span class="comment">// ! ä»åé¢å¼€å§‹æŸ¥æ‰¾ï¼Œæ’å…¥åˆ°ç¬¬ä¸€ä¸ªæ¯”å®ƒ id å°çš„å…ƒç´ åé¢</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰å¸¸é‡<code>id</code>å­˜å‚¨è§‚å¯Ÿè€…çš„<code>id</code>ï¼Œç„¶ååˆ¤æ–­<code>has</code>å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨<code>key</code>å€¼å’Œè¿™ä¸ª<code>id</code>ç›¸åŒï¼Œ<code>has</code>æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡ã€‚å¦‚æœä¸å­˜åœ¨ï¼ŒæŠŠ<code>id</code>ä½œä¸º<code>key</code>å­˜å…¥åˆ°<code>has</code>å¯¹è±¡ä¸­ï¼Œ<code>id</code>å¯¹åº”çš„å€¼æ˜¯<code>true</code>ã€‚</p><p>å†åˆ¤æ–­<code>flushing</code>çš„å€¼æ˜¯å¦ä¸º<code>false</code>ï¼Œå¦‚æœä¸º<code>false</code>ï¼Œè¯´æ˜é˜Ÿåˆ—ä¸­çš„è§‚å¯Ÿè€…æ²¡æœ‰åœ¨æ‰§è¡Œï¼Œè¿™æ—¶å€™æŠŠè§‚å¯Ÿè€…æ”¾å…¥é˜Ÿåˆ—å°¾éƒ¨ã€‚å¦‚æœ<code>flushing</code>çš„å€¼ä¸º<code>true</code>ï¼Œè¯´æ˜é˜Ÿåˆ—ä¸­æœ‰è§‚å¯Ÿè€…æ­£åœ¨æ‰§è¡Œï¼Œè¿™æ—¶å€™å°±ä¸èƒ½æ”¾åœ¨é˜Ÿåˆ—å°¾éƒ¨ï¼Œè€Œæ˜¯ä»é˜Ÿåˆ—çš„åé¢å¼€å§‹æŸ¥æ‰¾è§‚å¯Ÿè€…ï¼Œç„¶åæŠŠå½“å‰è§‚å¯Ÿè€…æ’å…¥åˆ°ç¬¬ä¸€ä¸ªæ¯”å®ƒ id å°çš„å…ƒç´ åé¢ï¼Œä¹Ÿå°±æ˜¯æŒ‰ç…§<code>id</code>çš„é¡ºåºæŠŠå½“å‰è§‚å¯Ÿè€…æ’å…¥åˆ°é˜Ÿåˆ—çš„åˆé€‚çš„ä½ç½®ä¸­ã€‚</p><p><strong>ä»€ä¹ˆæ—¶å€™è§‚å¯Ÿè€…åœ¨é˜Ÿåˆ—æ‰§è¡Œæ—¶è¿˜è¦å…¥é˜Ÿå‘¢</strong>ï¼Ÿç­”æ¡ˆæ˜¯è®¡ç®—å±æ€§è§‚å¯Ÿè€…ï¼Œå› ä¸ºè®¡ç®—å±æ€§æ›´æ–°å€¼çš„æ—¶æœºå’Œæ™®é€šçš„å“åº”æ€§æ•°æ®æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// queue the flush</span></span><br><span class="line"><span class="comment">// ! waiting æ ‡è¯†ï¼Œä¿è¯åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">  waiting = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! åŒæ­¥æ‰§è¡Œï¼Œä¸»è¦ç”¨äºéç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•ä»£ç </span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !config.async) &#123;</span><br><span class="line">    flushSchedulerQueue() <span class="comment">// ! ç›´æ¥æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  nextTick(flushSchedulerQueue) <span class="comment">// ! ä½¿ç”¨ nextTick æ‰§è¡Œé˜Ÿåˆ—çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­çš„<code>waiting</code>æ˜¯ä¸€ä¸ªå¼€å…³ï¼Œè¡¨ç¤ºæ˜¯å¦éœ€è¦ç­‰å¾…ï¼Œå®ƒçš„é»˜è®¤å€¼<code>false</code>ï¼Œè¡¨ç¤ºä¸éœ€è¦ç­‰å¾…ã€‚</p><p>å½“<code>waiting</code>ä¸º<code>false</code>æ—¶ï¼Œå…ˆè®¾ç½®å®ƒä¸º<code>true</code>ï¼Œè¿™æ ·åœ¨æ‰§è¡Œ<code>if</code>ä»£ç çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡½æ•°é‡Œé¢å†å»è°ƒç”¨<code>queueWatcher</code>å‡½æ•°å°±ä¸ä¼šå†å»æ‰§è¡Œè¿™ä¸ªå‡½æ•°çš„<code>if</code>ä»£ç ã€‚å› ä¸ºæ— è®ºé€’å½’æ‰§è¡Œå¤šå°‘æ¬¡<code>queueWatcher</code>å‡½æ•°ï¼Œå‡½æ•°é‡Œé¢çš„<code>if</code>ä»£ç åªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚</p><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœè®¾ç½®äº†å…¨å±€åŒæ­¥æ‰§è¡Œï¼Œç›´æ¥è°ƒç”¨<code>flushSchedulerQueue</code>å‡½æ•°åŒæ­¥æ‰§è¡Œé˜Ÿåˆ—çš„è§‚å¯Ÿè€…ã€‚</p><p>æ³¨æ„ï¼Œåˆ°è¿™é‡Œè¿˜æ˜¯åŒæ­¥æ‰§è¡Œã€‚å…ˆä¸ç®¡<code>flushSchedulerQueue</code>æ˜¯å¦‚ä½•æ‰§è¡Œé˜Ÿåˆ—è§‚å¯Ÿè€…çš„ã€‚</p><p>å¦åˆ™ä½¿ç”¨<code>nextTick</code>å‡½æ•°å¼‚æ­¥æ‰§è¡Œ<code>flushSchedulerQueue</code>å‡½æ•°ï¼Œåªæœ‰åˆ°äº†è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„å¼‚æ­¥æ‰§è¡Œã€‚</p><h2 id="nextTick"><a href="#nextTick" class="headerlink" title="nextTick"></a><code>nextTick</code></h2><p>åœ¨ Vue çš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæä¾›<code>Vue.nextTick</code>æˆ–è€…<code>vm.$nextTick</code>è¿™ä¸¤ä¸ª API ä¾›æˆ‘ä»¬å¼‚æ­¥æ‰§è¡Œå‡½æ•°ã€‚</p><p>å®ƒä»¬éƒ½æ¥è‡ªåŒä¸€ä¸ª<code>nextTick</code>å‡½æ•°ï¼Œä½œç”¨æ˜¯ï¼šåœ¨ä¸‹æ¬¡ DOM æ›´æ–°å¾ªç¯ç»“æŸä¹‹åæ‰§è¡Œå»¶è¿Ÿå›è°ƒã€‚åœ¨ä¿®æ”¹æ•°æ®ä¹‹åç«‹å³ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œè·å–æ›´æ–°åçš„ DOMã€‚</p><p><code>nextTick</code>å‡½æ•°æŠŠåŒæ­¥æ‰§è¡Œçš„å‡½æ•°å˜æˆå¼‚æ­¥æ‰§è¡Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nextTick(fn)</span><br></pre></td></tr></table></figure><p>å®ƒçš„åŸç†å’Œå®šæ—¶å™¨<code>setTimeout</code>æ˜¯ä¸€æ ·çš„ã€‚å®ƒåœ¨é‡Œé¢ä¹Ÿå°è£…äº†<code>setTimeout</code>å‡½æ•°ã€‚</p><p>åœ¨ Vue 2.6 ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œ<code>nextTick</code>è¿˜ä¼šæ˜æ˜¾çš„åŒºåˆ†å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡ä¸­æ˜¯æ€ä¹ˆå¤„ç†å¼‚æ­¥ã€‚ä½†æ˜¯ä» 2.6 ç‰ˆæœ¬å¼€å§‹å°±åªæ˜¯æ ¹æ®å¼‚æ­¥æ¥å£æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼ŒæŒ‰ç…§é¡ºåºæ¥å°è¯•æ‰§è¡Œå¼‚æ­¥å‡½æ•°ã€‚</p><p>æŸ¥çœ‹ä¸‹é¢çš„ä»£ç ï¼Œåœ¨<code>core/util/next-tick.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å›è°ƒå‡½æ•°ï¼Œæ˜é¢ä¸Šä¸åˆ† microtasks å’Œ (macro)tasks äº†ï¼ŒæŒ‰ç…§ä¸‹é¢çš„ä¼˜å…ˆçº§æ¥å®ç°</span></span><br><span class="line"><span class="comment">// ! ä¼˜å…ˆçº§ï¼ˆæ€§èƒ½é«˜ä½ï¼‰ Promise =&gt; MutationObserver =&gt; setImmediate =&gt; setTimeout</span></span><br><span class="line"><span class="keyword">let</span> timerFunc</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! Promise</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span> &amp;&amp; isNative(<span class="built_in">Promise</span>)) &#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="built_in">Promise</span>.resolve()</span><br><span class="line">  timerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    p.then(flushCallbacks)</span><br><span class="line">    <span class="keyword">if</span> (isIOS) setTimeout(noop)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">  !isIE &amp;&amp;</span><br><span class="line">  <span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span> &amp;&amp;</span><br><span class="line">  (isNative(MutationObserver) ||</span><br><span class="line">    <span class="comment">// PhantomJS and iOS 7.x</span></span><br><span class="line">    MutationObserver.toString() === <span class="string">'[object MutationObserverConstructor]'</span>)</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">let</span> counter = <span class="number">1</span></span><br><span class="line">  <span class="keyword">const</span> observer = <span class="keyword">new</span> MutationObserver(flushCallbacks)</span><br><span class="line">  <span class="keyword">const</span> textNode = <span class="built_in">document</span>.createTextNode(<span class="built_in">String</span>(counter))</span><br><span class="line">  observer.observe(textNode, &#123;</span><br><span class="line">    characterData: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">  timerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    counter = (counter + <span class="number">1</span>) % <span class="number">2</span></span><br><span class="line">    textNode.data = <span class="built_in">String</span>(counter)</span><br><span class="line">  &#125;</span><br><span class="line">  isUsingMicroTask = <span class="literal">true</span></span><br><span class="line">  <span class="comment">// ! setImmediate</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> setImmediate !== <span class="string">'undefined'</span> &amp;&amp; isNative(setImmediate)) &#123;</span><br><span class="line">  timerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setImmediate(flushCallbacks)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// Fallback to setTimeout.</span></span><br><span class="line">  timerFunc = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setTimeout(flushCallbacks, <span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å˜é‡<code>timerFunc</code>ï¼Œç”¨æ¥å­˜å‚¨å¼‚æ­¥æ‰§è¡Œå‡½æ•°çš„åŒ…è£…å‡½æ•°ï¼ŒåŒ…è£…å¼‚æ­¥æ‰§è¡Œçš„<code>flushCallbacks</code>å‡½æ•°ã€‚</p><p>æŒ‰ç…§å¼‚æ­¥å‡½æ•°çš„æ‰§è¡Œçš„ä¼˜å…ˆçº§ï¼Œå…ˆå°è¯•ä½¿ç”¨<code>Promsie.resolve</code>ã€‚å¦‚æœä¸æ”¯æŒï¼Œå†å°è¯•ä½¿ç”¨<code>MutationObserver</code>ã€‚å¦‚æœè¿˜æ˜¯ä¸æ”¯æŒï¼Œç»§ç»­å°è¯•ä½¿ç”¨<code>setImmediate</code>ã€‚æœ€åä½¿ç”¨<code>setTimeout</code>ï¼Œè¿™ä¸ªå¼‚æ­¥æ¥å£åŸºæœ¬æ‰€æœ‰çš„æµè§ˆå™¨éƒ½ä¼šæ”¯æŒã€‚é€šè¿‡è¿™äº›å¼‚æ­¥æ¥å£ï¼Œä½¿<code>flushCallbacks</code>å‡½æ•°å¼‚æ­¥æ‰§è¡Œã€‚</p><p>å…¶ä¸­<code>Primise.resolve</code>æ¥å£çš„æ€§èƒ½æ˜¯æœ€å¥½çš„ï¼Œä½¿ç”¨å®ƒåŒ…è£…çš„å¼‚æ­¥å‡½æ•°åœ¨æ‰§è¡Œæ—¶ä¼šæ”¾åœ¨æµè§ˆå™¨çš„å¾®ä»»åŠ¡åˆ—è¡¨ä¸­ï¼Œè¿™ä¸ªåˆ—è¡¨ä¸­çš„å¼‚æ­¥å‡½æ•°ç­‰å¾…æ—¶é—´æœ€çŸ­ï¼Œæ‰§è¡Œæœ€å¿«ã€‚è€Œ<code>setTimeout</code>æ¥å£çš„æ€§èƒ½æ˜¯æœ€å·®çš„ã€‚</p><p>çœ‹ä¸‹<code>flushCallbacks</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> callbacks = [] <span class="comment">// ! å›è°ƒå‡½æ•°ç»„æˆçš„æ•°ç»„</span></span><br><span class="line"><span class="keyword">let</span> pending = <span class="literal">false</span> <span class="comment">// ! é˜Ÿåˆ—æ˜¯å¦ç­‰å¾…æ‰§è¡Œï¼Œfalse è¡¨ç¤ºé˜Ÿåˆ—ä¸ºç©ºï¼Œä¸ç”¨ç­‰å¾…</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æ‰§è¡Œ callbacks çš„æ‰€æœ‰çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallbacks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pending = <span class="literal">false</span> <span class="comment">// ! é‡ç½® pending</span></span><br><span class="line">  <span class="keyword">const</span> copies = callbacks.slice(<span class="number">0</span>) <span class="comment">// ! æ‹·è´å‰¯æœ¬</span></span><br><span class="line">  callbacks.length = <span class="number">0</span> <span class="comment">// ! æ¸…ç©º callbacks</span></span><br><span class="line">  <span class="comment">// ! æ‰§è¡Œæ‹·è´å‰¯æœ¬çš„æ‰€æœ‰å›è°ƒå‡½æ•°</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; copies.length; i++) &#123;</span><br><span class="line">    copies[i]()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>flushCallbacks</code>çš„ä½œç”¨å°±æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œ<code>callbacks</code>æ•°ç»„ä¸­çš„æ‰€æœ‰çš„å›è°ƒå‡½æ•°ï¼ˆè§‚å¯Ÿè€…ï¼‰ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹å¯¼å‡ºçš„<code>nextTick</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">nextTick</span>(<span class="params">cb?: Function, ctx?: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> _resolve</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! æŠŠ cb åŒ…è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œå¹¶æ”¾å…¥ callbacks æ•°ç»„ä¸­</span></span><br><span class="line">  callbacks.push(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (cb) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        cb.call(ctx)</span><br><span class="line">      &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        handleError(e, ctx, <span class="string">'nextTick'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_resolve) &#123;</span><br><span class="line">      _resolve(ctx)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! åˆ¤æ–­æ•°ç»„æ˜¯å¦ç­‰å¾…æ‰§è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> (!pending) &#123;</span><br><span class="line">    pending = <span class="literal">true</span></span><br><span class="line">    timerFunc() <span class="comment">// ! æ‰§è¡Œå¼‚æ­¥å‡½æ•°</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// $flow-disable-line</span></span><br><span class="line">  <span class="comment">// ! nextTick æ²¡æœ‰ä¼ å…¥å›è°ƒå‡½æ•°æ—¶ï¼Œæä¾›ä¸€ä¸ª Promise åŒ–çš„è°ƒç”¨</span></span><br><span class="line">  <span class="keyword">if</span> (!cb &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Promise</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">      _resolve = resolve</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å›è°ƒå‡½æ•°<code>cb</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯å‡½æ•°è°ƒç”¨æ—¶çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</p><p>å£°æ˜å˜é‡<code>_resolve</code>ï¼Œåœ¨ç”¨æˆ·ä½¿ç”¨<code>nextTick</code>æ—¶å¦‚æœæ²¡æœ‰ä¼ å…¥å›è°ƒå‡½æ•°<code>cb</code>ï¼Œåœ¨å¯ä»¥ä½¿ç”¨<code>Promise</code>æ—¶çš„ç¯å¢ƒæ—¶ï¼Œä¼šæŠŠå˜é‡<code>_resolve</code>èµ‹å€¼ä¸º<code>Promise</code>çš„<code>resolve</code>å‡½æ•°ã€‚</p><p>å¦‚æœæœ‰å›è°ƒå‡½æ•°<code>cb</code>ï¼Œä½¿ç”¨<code>try...catch</code>è¯­å¥åŒ…è£…å¹¶æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œè¿™æ ·ä¸ä½†å¾ˆå¥½æ•è·é”™è¯¯ï¼Œè€Œä¸”åœ¨<code>cb</code>æ²¡æœ‰å€¼æ—¶è¿˜è°ƒç”¨<code>_resolve</code>å‡½æ•°ã€‚å¦å¤–ï¼ŒæŠŠè¿™ä¸ªåŒ…è£…çš„å‡½æ•°æ”¾å…¥åˆ°æ•°ç»„<code>callbacks</code>ä¸­ã€‚</p><p>åˆ¤æ–­é˜Ÿåˆ—<code>callbacks</code>æ˜¯å¦ç­‰å¾…æ‰§è¡Œï¼Œå¦‚æœ<code>pending</code>ä¸º<code>false</code>æ—¶ï¼Œè¯´æ˜æ•°ç»„ä¸­æ²¡æœ‰å›è°ƒå‡½æ•°åœ¨ç­‰å¾…æ‰§è¡Œï¼Œå…ˆè®¾ç½®<code>pending</code>ä¸º``true<code>ï¼Œè¡¨ç¤ºæ•°ç»„ä¸­å·²ç»æœ‰å›è°ƒå‡½æ•°ï¼Œä¸ç”¨ç­‰å¾…äº†ï¼Œå¯ä»¥æ‰§è¡Œï¼Œç„¶åè°ƒç”¨</code>timerFunc<code>å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å¼‚æ­¥æ‰§è¡Œ</code>flushCallbacks`ä¸­çš„å›è°ƒå‡½æ•°ã€‚</p><p>ç„¶åæˆ‘ä»¬ä¼šå‘ç°åœ¨æ‰§è¡Œ<code>flushCallbacks</code>å‡½æ•°æ—¶ï¼Œä¸€å¼€å§‹æ˜¯æŠŠ<code>pending</code>é‡ç½®ä¸º<code>false</code>ï¼Œå› ä¸ºå‡½æ•°æ¥ä¸‹æ¥å°±ä¼šæ‰§è¡Œå®Œæ‰€æœ‰çš„å›è°ƒå‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushCallbacks</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pending = <span class="literal">false</span> <span class="comment">// ! é‡ç½® pending</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ Vue çš„æ‰€æœ‰è§‚å¯Ÿè€…éƒ½æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œåªæœ‰åœ¨æµ‹è¯•ç¯å¢ƒæˆ–è€…å…¶ä»–çš„ç‰¹æ®Šåœºæ™¯æ‰è®©è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œã€‚å¦å¤–åŒæ­¥æ‰§è¡Œæ—¶ï¼Œåœ¨é˜Ÿåˆ—ä¸­éƒ½ä¼šæ ¹æ®è§‚å¯Ÿè€…çš„<code>id</code>è¿›è¡Œæ’åºï¼Œç„¶åæŒ‰ç…§é¡ºåºæ‰§è¡Œè§‚å¯Ÿè€…çš„å›è°ƒå‡½æ•°ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;åŒæ­¥æ‰§è¡Œ&quot;&gt;&lt;a href=&quot;#åŒæ­¥æ‰§è¡Œ&quot; class=&quot;headerlink&quot; title=&quot;åŒæ­¥æ‰§è¡Œ&quot;&gt;&lt;/a&gt;åŒæ­¥æ‰§è¡Œ&lt;/h2&gt;&lt;h3 id=&quot;å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ&quot;&gt;&lt;a href=&quot;#å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ&quot; class=&quot;headerlink&quot; title=&quot;å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ&quot;&gt;&lt;/a&gt;å•ä¸ªè§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œ&lt;/h3&gt;&lt;p&gt;å…ˆçœ‹ä¸‹åŒæ­¥æ‰§è¡Œçš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ! åŒæ­¥æ‰§è¡Œï¼Œä¸éœ€è¦è°ƒç”¨ nextTick æ‰§è¡Œè§‚å¯Ÿè€… =&amp;gt; ç”¨äº watch è‡ªå®šä¹‰çš„è§‚å¯Ÿè€…&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.sync) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.run()&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å¦‚æœè®¾ç½®äº†è§‚å¯Ÿè€…çš„&lt;code&gt;sync&lt;/code&gt;å±æ€§ä¸º&lt;code&gt;true&lt;/code&gt;çš„è¯ï¼Œä¼šæ‰§è¡Œäº†è§‚å¯Ÿè€…çš„&lt;code&gt;run&lt;/code&gt;æ–¹æ³•ï¼Œæ‰§è¡ŒåŒæ­¥æ›´æ–°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹è§‚å¯Ÿè€…</title>
    <link href="https://haledeng.com/blog/20190921-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85/"/>
    <id>https://haledeng.com/blog/20190921-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E8%A7%82%E5%AF%9F%E8%80%85/</id>
    <published>2019-09-21T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:07.048Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Watcher-è§‚å¯Ÿè€…"><a href="#Watcher-è§‚å¯Ÿè€…" class="headerlink" title="Watcher è§‚å¯Ÿè€…"></a><code>Watcher</code> è§‚å¯Ÿè€…</h2><p>ä¸‹é¢çœ‹ä¸‹è§‚å¯Ÿè€…<code>Watcher</code>çš„ä»£ç ï¼Œè¿™ä¸ªç±»æ¯”è¾ƒå¤æ‚ï¼Œé‡Œé¢åˆ›å»ºäº†å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ã€‚</p><a id="more"></a><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: ?Object,</span><br><span class="line">    isRenderWatcher?: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">get</span>() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addDep(dep: Dep) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cleanupDeps() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getAndInvoke(cb: <span class="built_in">Function</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  evaluate() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  depend() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  teardown() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹ç±»çš„æ„é€ å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: ?Object,</span><br><span class="line">    isRenderWatcher?: boolean</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°æœ‰äº”ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š</p><ol><li>Vue çš„å®ä¾‹å¯¹è±¡<code>vm</code>ã€‚</li><li>è¦ç›‘å¬çš„ç›®æ ‡<code>expOrFn</code>ï¼Œå³å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿”å›ç›®æ ‡çš„å‡½æ•°ã€‚</li><li>ç›‘å¬ç›®æ ‡å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•°<code>cb</code>ã€‚</li><li>ä¼ é€’ç»™å½“å‰è§‚å¯Ÿè€…å¯¹è±¡çš„é€‰é¡¹<code>options</code>ã€‚</li><li>æ˜¯ä¸æ˜¯æ¸²æŸ“å‡½æ•°è§‚å¯Ÿè€…<code>isRenderWatcher</code>ã€‚</li></ol><p>ç°åœ¨é‡æ–°å›å¤´æŸ¥çœ‹<code>mountComponent</code>å‡½æ•°ä¸­ç”Ÿæˆ<code>Watcher</code>å®ä¾‹å¯¹è±¡çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ç”Ÿæˆè§‚å¯Ÿè€…å®ä¾‹</span></span><br><span class="line"><span class="keyword">new</span> Watcher(</span><br><span class="line">  vm,</span><br><span class="line">  updateComponent, <span class="comment">// ! æ›´æ–°ç»„ä»¶çš„å‡½æ•°ï¼Œæ‰§è¡Œæ—¶ =&gt; æ‰§è¡Œ vm.$options.render =&gt; getter =&gt; æ”¶é›†ä¾èµ–</span></span><br><span class="line">  noop,</span><br><span class="line">  &#123;</span><br><span class="line">    before() &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</span><br><span class="line">        callHook(vm, <span class="string">'beforeUpdate'</span>) <span class="comment">// ! ä¼ å…¥ beforeUpdate ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œåœ¨æ›´æ–°å‰ç»„ä»¶å‰è°ƒç”¨</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªå‚æ•°<code>vm</code>æ˜¯å½“å‰éœ€è¦æŒ‚è½½çš„å®ä¾‹å¯¹è±¡ã€‚ç¬¬äºŒä¸ªå‚æ•°<code>updateComponent</code>æ˜¯ç›‘å¬çš„ç›®æ ‡ï¼Œå®ƒæ˜¯ä¸€ä¸ªç”ŸæˆçœŸå®å…ƒç´ çš„å‡½æ•°ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°<code>noop</code>æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼›ç¬¬å››ä¸ªå‚æ•°<code>options</code>æ˜¯é€‰é¡¹å¯¹è±¡ï¼Œè¿™é‡Œä¼ å…¥äº†ä¸€ä¸ª<code>before</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨äº†<code>beforeUpdate</code>ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ã€‚ç¬¬äº”ä¸ªå‚æ•°<code>isRenderWatcher</code>æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼<code>true</code>ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæ¸²æŸ“å‡½æ•°çš„è§‚å¯Ÿè€…ã€‚</p><p>å…¶ä¸­ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>expOrFn</code>ä¼šæŠŠå®ƒå˜æˆä¸€ä¸ª<code>getter</code>ã€‚è€Œç¬¬ä¸‰ä¸ªå‚æ•°<code>cb</code>æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ï¼Œä»€ä¹ˆä¹Ÿæ²¡åšã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªæ¸²æŸ“å‡½æ•°çš„è§‚å¯Ÿè€…ï¼Œå®ƒåªæ‰§è¡Œ<code>getter</code>æ”¶é›†ä¾èµ–ï¼Œä¸ç”¨å»è§¦å‘ä¾èµ–ã€‚</p><p>ä¸‹é¢ç»§ç»­çœ‹æ„é€ å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.vm = vm</span><br><span class="line"><span class="keyword">if</span> (isRenderWatcher) &#123;</span><br><span class="line">  vm._watcher = <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line">vm._watchers.push(<span class="keyword">this</span>) <span class="comment">// ! æŠŠè‡ªå·±æ·»åŠ è¿›å»</span></span><br></pre></td></tr></table></figure><p>æŠŠéœ€è¦æŒ‚è½½çš„å®ä¾‹å¯¹è±¡<code>vm</code>å­˜å‚¨åˆ°è§‚å¯Ÿè€…çš„<code>vm</code>å±æ€§ä¸­ï¼Œè¿™æ ·æ¯ä¸ªè§‚å¯Ÿè€…çš„<code>vm</code>éƒ½å­˜å‚¨ç€å®ƒæ‰€å±çš„å®ä¾‹å¯¹è±¡ï¼Œè¿™è¡¨æ˜äº†è¿™ä¸ªè§‚å¯Ÿè€…çš„å½’å±ã€‚</p><p>åˆ¤æ–­ä¼ å…¥çš„ç¬¬äº”ä¸ªå‚æ•°<code>isRenderWatcher</code>æ˜¯å¦ä¸º<code>true</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±æŠŠå½“å‰è§‚å¯Ÿè€…å­˜å‚¨åˆ°å®ä¾‹å¯¹è±¡çš„<code>_watcher</code>å±æ€§ä¸­ã€‚</p><p>æŠŠè§‚å¯Ÿè€…æ”¾å…¥åˆ°å®ä¾‹å¯¹è±¡çš„<code>_watchers</code>å±æ€§ä¸­ï¼Œè¿™ä¸ªå±æ€§å­˜å‚¨æ‰€æœ‰çš„è§‚å¯Ÿè€…å®ä¾‹ï¼Œä¸ç®¡æ˜¯æ¸²æŸ“å‡½æ•°è§‚å¯Ÿè€…è¿˜æ˜¯å…¶ä»–çš„è§‚å¯Ÿè€…ã€‚</p><p>æ³¨æ„å®ä¾‹å¯¹è±¡ä¸­çš„<code>_watcher</code>å±æ€§åœ¨åˆå§‹åŒ–æ—¶é€šè¿‡<code>initLifecycle</code>å‡½æ•°å®šä¹‰è¿‡ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯<code>null</code>ã€‚è€Œ<code>_watchers</code>å±æ€§æ˜¯é€šè¿‡<code>initState</code>å‡½æ•°å®šä¹‰è¿‡ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯ç©ºæ•°ç»„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// options</span></span><br><span class="line"><span class="keyword">if</span> (options) &#123;</span><br><span class="line">  <span class="keyword">this</span>.deep = !!options.deep <span class="comment">// ! æ˜¯å¦æ·±åº¦ç›‘å¬</span></span><br><span class="line">  <span class="keyword">this</span>.user = !!options.user <span class="comment">// ! æ˜¯å¦æ˜¯å¼€å‘è€…å®šä¹‰çš„ï¼Œä¸»è¦æŒ‡ watch $watch ä¸­è‡ªå®šä¹‰çš„å‡½æ•°</span></span><br><span class="line">  <span class="keyword">this</span>.lazy = !!options.lazy <span class="comment">// ! æ˜¯å¦å¼€å¯æ‡’æƒ°æ¨¡å¼ï¼Œä¸“ä¸ºè®¡ç®—å±æ€§è®¾ç½®</span></span><br><span class="line">  <span class="keyword">this</span>.sync = !!options.sync <span class="comment">// ! æ˜¯å¦åŒæ­¥æ±‚å€¼</span></span><br><span class="line">  <span class="keyword">this</span>.before = options.before <span class="comment">// ! æ›´æ–°ä¹‹å‰è°ƒç”¨çš„é’©å­å‡½æ•°ï¼Œæ¯”å¦‚è°ƒç”¨ beforeUpdate é’©å­å‡½æ•°</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.deep = <span class="keyword">this</span>.user = <span class="keyword">this</span>.lazy = <span class="keyword">this</span>.sync = <span class="literal">false</span> <span class="comment">// ! é»˜è®¤å€¼ä¸º false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¼ å…¥çš„ç¬¬å››ä¸ªå‚æ•°<code>options</code>é€‰é¡¹æ¥åˆå§‹åŒ–è§‚å¯Ÿè€…çš„ä¸€äº›å±æ€§ï¼Œå…¶ä¸­<code>deep</code>ã€<code>user</code>ã€<code>lazy</code>å’Œ<code>sync</code>å±æ€§çš„å€¼æ˜¯å¸ƒå°”ç±»å‹ï¼Œå¦‚æœæ²¡æœ‰ä¼ å…¥å€¼ï¼Œå®ƒä»¬çš„å€¼é»˜è®¤ä¸º<code>undefined</code>ï¼Œç„¶åé€šè¿‡åŒé‡å–åå˜æˆå¸ƒå°”å€¼<code>false</code>ã€‚</p><p>ä¸‹é¢æ¥åˆ†æè¿™äº›å±æ€§ï¼š</p><ul><li><code>deep</code>ï¼šç”¨æ¥å‘Šè¯‰è§‚å¯Ÿè€…å½“å‰çš„ç›‘å¬å¯¹è±¡æ˜¯å¦æ‰§è¡Œæ·±åº¦ç›‘å¬ã€‚</li><li><code>user</code>ï¼šç”¨æ¥å‘Šè¯‰è§‚å¯Ÿè€…å½“å‰çš„å¯¹è±¡æ˜¯ç”¨æˆ·å®šä¹‰çš„è¿˜æ˜¯å†…éƒ¨å®šä¹‰çš„ã€‚é™¤äº†å†…éƒ¨å®šä¹‰çš„è§‚å¯Ÿè€…ï¼Œæ¯”å¦‚æ¸²æŸ“å‡½æ•°è§‚å¯Ÿè€…ã€è®¡ç®—å±æ€§è§‚å¯Ÿè€…ï¼Œå…¶ä»–çš„è§‚å¯Ÿè€…ä¸€èˆ¬éƒ½æ˜¯ç”¨æˆ·å®šä¹‰çš„ã€‚</li><li><code>lazy</code>ï¼šç”¨æ¥å‘Šè¯‰è§‚å¯Ÿè€…å½“å‰çš„ç›‘å¬å¯¹è±¡æ˜¯ä¸æ˜¯è®¡ç®—å±æ€§ã€‚</li><li><code>sync</code>ï¼šç”¨æ¥å‘Šè¯‰è§‚å¯Ÿè€…å½“å‰çš„ç›‘å¬çš„å¯¹è±¡å˜åŒ–æ—¶æ˜¯å¦è¿›è¡ŒåŒæ­¥æ±‚å€¼ã€‚</li><li><code>before</code>ï¼šè¿™æ˜¯åœ¨ç›‘å¬çš„å¯¹è±¡å˜åŒ–ä¹‹å‰è°ƒç”¨çš„ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œå³<code>beforeUpdare</code>é’©å­å‡½æ•°ã€‚</li></ul><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.cb = cb</span><br><span class="line"><span class="keyword">this</span>.id = ++uid <span class="comment">// uid for batching</span></span><br><span class="line"><span class="keyword">this</span>.active = <span class="literal">true</span> <span class="comment">// ! è§‚å¯Ÿè€…é»˜è®¤æ˜¯æ¿€æ´»çŠ¶æ€</span></span><br><span class="line"><span class="keyword">this</span>.dirty = <span class="keyword">this</span>.lazy <span class="comment">// for lazy watchers</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>this.cb</code>å±æ€§ï¼Œå®ƒçš„å€¼æ˜¯ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>cb</code>ï¼Œå³å›è°ƒå‡½æ•°ã€‚</p><p>å®šä¹‰<code>this.id</code>å±æ€§ï¼Œå®ƒæ˜¯è§‚å¯Ÿè€…çš„å”¯ä¸€æ ‡è¯†ï¼Œåˆå§‹å€¼ä¸º<code>0</code>ï¼Œç„¶ååé¢åˆ›å»ºçš„è§‚å¯Ÿè€…çš„ id æ˜¯é€’å¢çš„ã€‚</p><p>å®šä¹‰<code>this.active</code>å±æ€§ï¼Œå®ƒè¡¨ç¤ºè§‚å¯Ÿè€…æ˜¯å¦æ˜¯æ¿€æ´»çŠ¶æ€ï¼Œé»˜è®¤å€¼æ˜¯<code>true</code>ã€‚</p><p>å®šä¹‰<code>this.dirty</code>å±æ€§ï¼Œå®ƒçš„å€¼å’Œ<code>this.lazy</code>ç›¸åŒï¼Œä¹Ÿæ˜¯ç”¨äºè®¡ç®—å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.deps = [] <span class="comment">// ! ä¸Šä¸€æ¬¡æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">this</span>.newDeps = [] <span class="comment">// ! å½“å‰æ·»åŠ çš„ Dep å®ä¾‹æ•°ç»„</span></span><br><span class="line"><span class="keyword">this</span>.depIds = <span class="keyword">new</span> <span class="built_in">Set</span>() <span class="comment">// ! ä¸Šä¸€æ¬¡æ·»åŠ åˆ° Dep å®ä¾‹çš„ id çš„é›†åˆï¼Œä¸èƒ½é‡å¤</span></span><br><span class="line"><span class="keyword">this</span>.newDepIds = <span class="keyword">new</span> <span class="built_in">Set</span>() <span class="comment">// ! å½“å‰æ·»åŠ åˆ° Dep å®ä¾‹çš„ id çš„é›†åˆï¼Œä¸èƒ½é‡å¤</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å®šä¹‰çš„å››ä¸ªè®¢é˜…å™¨ç›¸å…³çš„å±æ€§æ˜¯ç”¨æ¥é¿å…é‡å¤æ”¶é›†ä¾èµ–å’Œç§»é™¤æ— ç”¨ä¾èµ–çš„ã€‚è¿™äº›å±æ€§åˆ†æˆä¸¤ç»„ï¼Œå…¶ä¸­<code>deps</code>å’Œ<code>depIds</code>æ˜¯ä¸€ç»„ï¼Œç”¨äºä¸Šä¸€æ¬¡æ”¶é›†çš„ä¾èµ–ã€‚<code>newDeps</code>å’Œ<code>newDepIds</code>æ˜¯ä¸€ç»„ï¼Œç”¨äºå½“å‰æ”¶é›†çš„ä¾èµ–ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.expression =</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> ? expOrFn.toString() : <span class="string">''</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>this.expression</code>å±æ€§ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œå®ƒçš„å€¼æ˜¯ç¬¬äºŒä¸ªå‚æ•°çš„å­—ç¬¦ä¸²è½¬æ¢å€¼ï¼Œè€Œåœ¨ç”Ÿæˆç¯å¢ƒæ—¶ï¼Œå®ƒçš„å€¼æ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜è¿™ä¸ªå±æ€§æ˜¯åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parse expression for getter</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">'function'</span>) &#123;</span><br><span class="line">  <span class="keyword">this</span>.getter = expOrFn</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.getter = parsePath(expOrFn) <span class="comment">// ! å­—ç¬¦ä¸²è½¬å‡½æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.getter) &#123;</span><br><span class="line">    <span class="keyword">this</span>.getter = noop</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Failed watching path: "<span class="subst">$&#123;expOrFn&#125;</span>" `</span> +</span><br><span class="line">          <span class="string">'Watcher only accepts simple dot-delimited paths. '</span> +</span><br><span class="line">          <span class="string">'For full control, use a function instead.'</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°<code>expOrFn</code>çš„ç±»å‹ï¼Œå¦‚æœå®ƒæ˜¯å‡½æ•°ç±»å‹ï¼ŒæŠŠå®ƒèµ‹å€¼ç»™è§‚å¯Ÿè€…çš„<code>getter</code>å±æ€§ã€‚å¦‚æœä¸æ˜¯å‡½æ•°ç±»å‹ï¼Œåº”è¯¥æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œè°ƒç”¨<code>parsePath</code>å‡½æ•°æŠŠå®ƒè½¬æ¢æˆä¸€ä¸ªå‡½æ•°å¹¶èµ‹å€¼ç»™<code>getter</code>ã€‚å¦‚æœè½¬æ¢æˆå‡½æ•°å¤±è´¥ï¼Œè§‚å¯Ÿè€…çš„<code>getter</code>å±æ€§èµ‹å€¼ä¸ºä¸€ä¸ªç©ºå‡½æ•°ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­æŠ¥é”™ï¼Œæç¤º<code>Watcher</code>åªæ¥å—ç®€å•çš„ç‚¹åˆ†å‰²è·¯å¾„ï¼Œå¦‚æœæƒ³è¦å®Œæ•´ç›‘å¬ï¼Œéœ€è¦ä½¿ç”¨å‡½æ•°ã€‚</p><p>çœ‹ä¸‹<code>parsePath</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> unicodeRegExp = <span class="regexp">/a-zA-Z\u00B7\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u037D\u037F-\u1FFF\u200C-\u200D\u203F-\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD/</span></span><br><span class="line"><span class="keyword">const</span> bailRE = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`[^<span class="subst">$&#123;unicodeRegExp.source&#125;</span>.$_\\d]`</span>)</span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">parsePath</span>(<span class="params">path: string</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (bailRE.test(path)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°ä¹‹å‰å£°æ˜ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼<code>bailRE</code>ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„å«ä¹‰æ˜¯ï¼š</p><ul><li>ä¸èƒ½æ˜¯<code>unicodeRegExp.source</code>ã€‚</li><li>ä¸èƒ½æ˜¯<code>.</code>ç¬¦æˆ–è€…<code>$</code>ç¬¦æˆ–è€…<code>_</code>ç¬¦ã€‚</li><li>ä¸èƒ½æ˜¯<code>\d</code>ï¼Œå³ä¸èƒ½æ˜¯æ•°å­—ã€‚</li></ul><p>çœ‹è¿™ä¸ªå‡½æ•°å‰é¢çš„<code>if</code>è¯­å¥ï¼Œå¦‚æœä¼ å…¥çš„å‚æ•°<code>path</code>åŒ¹é…åˆ°äº†ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°±ç›´æ¥è¿”å›ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœéœ€è¦ç»§ç»­åé¢çš„é€»è¾‘ï¼Œå°±å¿…é¡»ä¸èƒ½æ»¡è¶³ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä¹Ÿå°±æ˜¯å’Œä¸Šé¢çš„æ¡ä»¶ç›¸åã€‚å³ä¼ å…¥çš„<code>path</code>å¿…é¡»è¦æ˜¯<code>unicodeRegExp.source</code>ï¼Œæˆ–è€…æ˜¯æ•°å­—ï¼Œæˆ–è€…æœ‰<code>.</code>ç¬¦ï¼Œæˆ–è€…æœ‰<code>$</code>ç¬¦ï¼Œæˆ–è€…æœ‰<code>_</code>ç¬¦ï¼Œåªè¦æ»¡è¶³å…¶ä¸­çš„ä¸€é¡¹æ¡ä»¶å³å¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> segments = path.split(<span class="string">'.'</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; segments.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span></span><br><span class="line">    obj = obj[segments[i]]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> obj</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>.</code>ç¬¦æ¥åˆ†å‰²<code>path</code>ï¼ŒæŠŠåˆ†å‰²åçš„æ•°ç»„å­˜å‚¨åœ¨å˜é‡<code>segments</code>ä¸­ã€‚</p><p>ç„¶åè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œè¿”å›çš„å‡½æ•°é‡Œé¢éå†<code>segments</code>ï¼Œå¹¶ä¸”è®¿é—®ä¼ å…¥çš„å®ä¾‹å¯¹è±¡<code>obj</code>ä¸­å­˜åœ¨äº<code>segments</code>ä¸­çš„<code>path</code>å¯¹åº”çš„å€¼ï¼Œè¿™ç›¸å½“äºä¸€ä¸ªè§¦å‘äº†è®¿é—®çš„å€¼çš„<code>getter</code>å‡½æ•°ã€‚</p><p>ç»§ç»­çœ‹æ„é€ å‡½æ•°æœ€åçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å®ä¾‹åŒ–æœ€åï¼Œè°ƒç”¨ get è·å–å€¼ï¼Œå¹¶æ”¶é›†ä¾èµ–</span></span><br><span class="line"><span class="comment">// ! æ³¨æ„è®¡ç®—å±æ€§é‡‡ç”¨ä¸åŒçš„å¤„ç†æ–¹æ³•</span></span><br><span class="line"><span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy ? <span class="literal">undefined</span> : <span class="keyword">this</span>.get()</span><br></pre></td></tr></table></figure><p>å®šä¹‰<code>this.value</code>å±æ€§ï¼Œå³è·å–çš„å€¼ã€‚éè®¡ç®—å±æ€§è§‚å¯Ÿè€…ä¼šè°ƒç”¨<code>this.get</code>æ–¹æ³•è·å–å€¼ã€‚è€Œè®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„å€¼ä¸º<code>undefined</code>ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰æ”¶é›†ä¾èµ–ï¼Œå› ä¸ºè®¡ç®—å±æ€§è·å–å€¼çš„æ—¶æœºä¸ä¸€æ ·ï¼Œåé¢ä¼šè®²è§£ã€‚</p><h2 id="æ”¶é›†ä¾èµ–"><a href="#æ”¶é›†ä¾èµ–" class="headerlink" title="æ”¶é›†ä¾èµ–"></a>æ”¶é›†ä¾èµ–</h2><p>ä¸‹é¢çœ‹ä¸‹<code>Watcher</code>ä¸‹é¢çš„<code>get</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯è·å–è§‚å¯Ÿå¯¹è±¡çš„å€¼å’Œæ”¶é›†ä¾èµ–ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>() &#123;</span><br><span class="line">  pushTarget(<span class="keyword">this</span>) <span class="comment">// ! Dep.target èµ‹å€¼ä¸ºè§‚å¯Ÿè€…å®ä¾‹ ï¼Œå¹¶æ”¾å…¥ç»´æŠ¤çš„ targetStack ä¸­</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  popTarget()</span><br><span class="line">  <span class="keyword">this</span>.cleanupDeps()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°çš„å‰é¢å…ˆè°ƒç”¨äº†<code>pushTarget</code>å‡½æ•°æŠŠè§‚å¯Ÿè€…æ”¾å…¥åˆ°æ”¶é›†ä¾èµ–çš„æ ˆä¸­ï¼Œç„¶ååé¢åˆè°ƒç”¨äº†<code>popTarget</code>å‡½æ•°æŠŠå¥¹ä»æ”¶é›†çš„æ ˆä¸­åˆ é™¤ã€‚</p><p>å…ˆçœ‹ä¸‹è¿™ä¸ªä¸¤ä¸ªå‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/observer/dep.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line">Dep.target = <span class="literal">null</span> <span class="comment">// ! åˆå§‹åŒ–ä¸º null</span></span><br><span class="line"><span class="keyword">const</span> targetStack = []</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æŠŠ target æ”¾å…¥æ ˆä¸­ï¼Œå¹¶èµ‹å€¼ Dep.target</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushTarget</span>(<span class="params">target: ?Watcher</span>) </span>&#123;</span><br><span class="line">  targetStack.push(target)</span><br><span class="line">  Dep.target = target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æŠŠ target ç§»å‡ºæ ˆä¸­ï¼ŒDep.target å˜æˆæ ˆçš„æœ€åä¸€ä¸ªå…ƒç´  æˆ–è€… undefined</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">popTarget</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  targetStack.pop()</span><br><span class="line">  Dep.target = targetStack[targetStack.length - <span class="number">1</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>pushTarget</code>å‡½æ•°ä¼šæŠŠä¼ å…¥çš„è§‚å¯Ÿè€…èµ‹å€¼ç»™äº†è®¢é˜…å™¨çš„<code>Dep.target</code>å±æ€§ä¸­ï¼Œå¹¶ä¸”å­˜å…¥ä¸€ä¸ª<code>targetStack</code>æ•°ç»„ç±»å‹çš„æ ˆä¸­ã€‚</p><p><code>popTarget</code>å‡½æ•°ä¼šæŠŠå‰é¢åŠ å…¥æ ˆçš„è§‚å¯Ÿè€…å¯¹è±¡ç§»å‡ºæ ˆï¼Œå¹¶æŠŠ<code>Dep.target</code>çš„å€¼å˜æˆç°åœ¨æ ˆä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</p><p>å†çœ‹<code>get</code>ä¸­çš„å…¶ä»–ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> value</span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">this</span>.vm</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ! æ‰§è¡Œ getter è·å–å€¼</span></span><br><span class="line">  <span class="comment">// ! ç›¸å½“äºæ‰§è¡Œ updateComponent å‡½æ•° =&gt; å³æ‰§è¡Œ vm._update(vm._render(), hydrating)</span></span><br><span class="line">  <span class="comment">// ! è€Œæ‰§è¡Œ vm._render =&gt; å¯¹ vm ä¸Šçš„æ•°æ®è®¿é—® =&gt; è§¦å‘ getter =&gt; æ”¶é›†ä¾èµ–</span></span><br><span class="line">  value = <span class="keyword">this</span>.getter.call(vm, vm)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.user) &#123;</span><br><span class="line">    handleError(e, vm, <span class="string">`getter for watcher "<span class="subst">$&#123;<span class="keyword">this</span>.expression&#125;</span>"`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> e</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="comment">// "touch" every property so they are all tracked as</span></span><br><span class="line">  <span class="comment">// dependencies for deep watching</span></span><br><span class="line">  <span class="comment">// ! å¦‚æœæ˜¯æ·±åº¦è§‚å¯Ÿ =&gt; ç”¨äº watch é€‰é¡¹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</span><br><span class="line">    traverse(value) <span class="comment">// ! é€’å½’å»è®¿é—® valueï¼Œè§¦å‘å®ƒæ‰€æœ‰å­é¡¹çš„ getter</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ! æŠŠ Dep.target æ¢å¤æˆä¸Šä¸€ä¸ªçŠ¶æ€</span></span><br><span class="line">  <span class="comment">// ! å½“å‰ vm çš„æ•°æ®ä¾èµ–æ”¶é›†å·²ç»å®Œæˆï¼Œé‚£ä¹ˆå¯¹åº”çš„æ¸²æŸ“ Dep.target ä¹Ÿéœ€è¦æ”¹å˜</span></span><br><span class="line">  popTarget()</span><br><span class="line">  <span class="keyword">this</span>.cleanupDeps() <span class="comment">// ! æ¯æ¬¡æ±‚å€¼åæ¸…ç©ºå½“å‰çš„ä¾èµ–ï¼Œé¿å…é‡å¤æ”¶é›†</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> value <span class="comment">// ! æ¸²æŸ“å‡½æ•°è§‚å¯Ÿè€…çš„è¿”å›å€¼æ°¸è¿œéƒ½æ˜¯ undefined</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>value</code>ï¼Œè¿™ä¸ªéå†ç”¨æ¥å­˜å‚¨è°ƒç”¨<code>getter</code>å‡½æ•°è·å–åˆ°çš„å€¼ï¼Œä¹Ÿæ˜¯æœ€åçš„è¿”å›å€¼ï¼Œå£°æ˜å¸¸é‡<code>vm</code>å­˜å‚¨<code>this.vm</code>ï¼Œä¹Ÿå°±æ˜¯è§‚å¯Ÿè€…æ‰€å±çš„å®ä¾‹å¯¹è±¡ã€‚</p><p>è°ƒç”¨<code>try...catch...finally</code>è¯­å¥æ‰§è¡Œ<code>getter</code>å‡½æ•°ï¼Œæ˜¯ä¸ºäº†æ›´å¥½çš„æ•è·é”™è¯¯ã€‚</p><p>å…ˆçœ‹<code>try</code>ä»£ç å—çš„ä»£ç ï¼Œæ‰§è¡Œ<code>this.getter</code>å‡½æ•°ï¼Œå¹¶æŠŠå‡½æ•°è¿”å›çš„å€¼èµ‹å€¼ç»™äº†å˜é‡<code>value</code>ã€‚å†è·å–å€¼çš„è¿‡ç¨‹ä¸­ï¼Œä¼šè§¦å‘å€¼çš„<code>getter</code>å±æ€§ï¼Œ<code>getter</code>æ˜¯åœ¨<code>defineReactive</code>å‡½æ•°ä¸­é€šè¿‡<code>Object.defineProperty</code>å®šä¹‰çš„<code>get</code>å±æ€§ï¼Œç„¶å<code>getter</code>ä¼šæ”¶é›†ä¾èµ–ã€‚</p><p>è¿™é‡Œåˆ†æä¸‹<strong>ä¾èµ–æ”¶é›†çš„è¿‡ç¨‹</strong>ï¼š</p><p>é¦–å…ˆï¼Œé€šè¿‡ <code>new Watcher</code>ç”Ÿæˆä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹å¯¹è±¡ï¼Œéœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡ã€è§‚å¯Ÿçš„ç›®æ ‡<code>expOrFn</code>ä»¥åŠå›è°ƒå‡½æ•°<code>cb</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Watcher(&#123; vm, expOrFn, cb &#125;)</span><br></pre></td></tr></table></figure><p>åœ¨ç”Ÿæˆè§‚å¯Ÿè€…å®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œç±»<code>Watcher</code>çš„æ„é€ å‡½æ•°çš„ä»£ç ï¼Œæ„é€ å‡½æ•°çš„æœ€åä»£ç ä¼šè°ƒç”¨<code>Watcher</code>çš„<code>get</code>æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(/* ... */) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">this</span>.value = <span class="keyword">this</span>.get() <span class="comment">// è·å–å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>get</code>æ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>getter</code>æ–¹æ³•ï¼Œè€Œè¿™ä¸ª<code>getter</code>æ–¹æ³•ä¸€èˆ¬å°±æ˜¯ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°<code>expOrFn</code>ï¼Œå³è§‚å¯Ÿç›®æ ‡çš„è¡¨è¾¾å¼ã€‚åœ¨æ‰§è¡Œ<code>getter</code>æ–¹æ³•ä¹‹å‰ï¼Œä¼šè°ƒç”¨<code>pushTarget</code>å‡½æ•°æŠŠ<code>Dep.target</code>èµ‹å€¼ä¸ºè¿™ä¸ªè§‚å¯Ÿè€…ï¼Œå¹¶é”®å…¥åˆ°æ”¶é›†ä¾èµ–çš„æ ˆä¸­ï¼Œç„¶åå°±æ˜¯æ‰§è¡Œ<code>getter</code>æ–¹æ³•ï¼Œè¿™æ—¶ä¼šè®¿é—®åˆ°<code>expOrFn</code>æ‰§è¡Œåçš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.getter = expOrFn</span><br><span class="line">pushTarget(<span class="keyword">this</span>) <span class="comment">// èµ‹å€¼ä¸º Dep.target å…¥æ ˆ</span></span><br><span class="line">value = <span class="keyword">this</span>.getter.call(vm, vm) <span class="comment">// è®¿é—®å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pushTarget</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushTarget</span>(<span class="params">target: ?Watcher</span>) </span>&#123;</span><br><span class="line">  targetStack.push(target)</span><br><span class="line">  Dep.target = target</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®åˆ°<code>expOrFn</code>æ‰§è¡Œåçš„å€¼æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªå€¼çš„<code>getter</code>å‡½æ•°ï¼Œ<code>getter</code>å‡½æ•°ä¼šå…ˆåˆ¤æ–­<code>Dep.target</code>æ˜¯å¦æœ‰å€¼ã€‚å› ä¸ºå‰é¢å·²ç»èµ‹å€¼ï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œ<code>Dep</code>å®ä¾‹å¯¹è±¡çš„<code>depend</code>æ–¹æ³•ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">get</span>: function reactiveGetter() &#123;</span><br><span class="line">  <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">  <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">    dep.depend() <span class="comment">// ! æ·»åŠ è¿›è®¢é˜…å™¨ï¼Œä¾èµ–æ”¶é›†</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>Dep</code>å®ä¾‹å¯¹è±¡çš„<code>depend</code>æ–¹æ³•ä¸­ï¼Œåˆä¼šè°ƒç”¨<code>Dep.target</code>å±æ€§çš„<code>addDep</code>æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨è§‚å¯Ÿè€…çš„<code>addDep</code>æ–¹æ³•ï¼ŒæŠŠ<code>Dep</code>å®ä¾‹å¯¹è±¡è‡ªèº«åŠ å…¥åˆ°è§‚å¯Ÿè€…çš„<code>dep</code>ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dep</span></span><br><span class="line">depend() &#123;</span><br><span class="line">  <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">    Dep.target.addDep(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è§‚å¯Ÿè€…çš„<code>addDep</code>æ–¹æ³•ï¼Œå…ˆåˆ¤æ–­<code>newDepIds</code>ä¸­æ˜¯å¦å­˜åœ¨è¿™ä¸ª<code>dep</code>ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä¼šæŠŠ<code>dep</code>æ·»åŠ åˆ°è§‚å¯Ÿè€…çš„<code>newDeps</code>é›†åˆä¸­å»ï¼Œè¿™æ ·å¯ä»¥é¿å…é‡å¤æ”¶é›†ä¾èµ–ã€‚</p><p>ç„¶ååˆ¤æ–­é›†åˆ<code>depIds</code>ä¸­æ˜¯å¦æœ‰è¿™ä¸ª<code>dep</code>çš„<code>id</code>ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œè¯´æ˜è§‚å¯Ÿè€…è¿˜æ²¡æœ‰åŠ å…¥åˆ°<code>dep</code>ä¸­ï¼Œè°ƒç”¨<code>dep</code>çš„<code>addSub</code>æ–¹æ³•æŠŠè§‚å¯Ÿè€…åŠ å…¥åˆ°<code>dep</code>ä¸­ï¼Œåˆ°è¿™ä¸€æ­¥ï¼Œä¾èµ–æ”¶é›†å°±å·²ç»å®Œæˆã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Watcher</span></span><br><span class="line">addDep(dep: Dep) &#123;</span><br><span class="line">  <span class="keyword">const</span> id = dep.id</span><br><span class="line">  <span class="comment">// ! éœ€è¦å…ˆåˆ¤å®š new ä¸­æ˜¯å¦å·²ç»æ”¶é›†ï¼Œå¦‚æœæ²¡æœ‰æ”¶é›†æ‰æ”¶é›†ï¼Œé¿å…é‡å¤æ”¶é›†ä¾èµ–</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(id)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.newDepIds.add(id)</span><br><span class="line">    <span class="keyword">this</span>.newDeps.push(dep) <span class="comment">// æ”¾å…¥åˆ°å½“å‰çš„ Dep æ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.depIds.has(id)) &#123;</span><br><span class="line">      dep.addSub(<span class="keyword">this</span>) <span class="comment">// è§‚å¯Ÿè€…å¯¹è±¡æ”¾å…¥åˆ° subs ä¸­</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dep</span></span><br><span class="line">addSub(sub: Watcher) &#123;</span><br><span class="line">  <span class="keyword">this</span>.subs.push(sub)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸‹<code>catch</code>ä»£ç å—çš„ä»£ç ï¼Œè¿™é‡Œä¸»è¦æ˜¯æ•è·å¯èƒ½å‡ºç°çš„é”™è¯¯ã€‚</p><p>æœ€åçœ‹ä¸‹<code>finally</code>ä»£ç å—çš„ä»£ç ï¼Œå¦‚æœè®¾ç½®äº†<code>this.deep</code>ä¸º<code>true</code>ï¼Œè¯´æ˜è®¾ç½®äº†æ·±åº¦ç›‘å¬ã€‚è¿™æ—¶éœ€è¦è°ƒç”¨<code>traverse</code>å‡½æ•°é€’å½’å»è®¿é—® <code>value</code>ï¼Œè§¦å‘å®ƒæ‰€æœ‰å­é¡¹çš„<code>getter</code>ï¼Œæ”¶é›†è§‚å¯Ÿç›®æ ‡çš„æ‰€æœ‰ä¾èµ–ã€‚</p><p>ä¾èµ–æ”¶é›†å®Œæ¯•ï¼Œè¿˜éœ€è¦è°ƒç”¨<code>this.cleanupDeps</code>æ¸…ç©ºå½“å‰çš„ä¾èµ–ï¼Œé¿å…é‡å¤æ”¶é›†ä¾èµ–ã€‚è¿™é‡Œæ¸…ç©ºçš„æ˜¯<code>newDeps</code>å’Œ<code>newDepIds</code>ä¸­çš„æ•°æ®ï¼Œå®ƒä»¬è¡¨ç¤ºå½“å‰æ”¶é›†åˆ°çš„<code>Dep</code>å®ä¾‹å¯¹è±¡çš„é›†åˆã€‚</p><p>æœ€åè¿”å›è·å–åˆ°çš„å€¼<code>value</code>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹è§‚å¯Ÿè€…çš„<code>cleanupDeps</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ¸…ç©ºå½“å‰æ”¶é›†åˆ°çš„<code>Dep</code>å®ä¾‹å¯¹è±¡çš„é›†åˆï¼Œç”¨æ¥é˜²æ­¢é‡å¤æ”¶é›†ä¾èµ–ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cleanupDeps() &#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="keyword">this</span>.deps.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = <span class="keyword">this</span>.deps[i]</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(dep.id)) &#123;</span><br><span class="line">      dep.removeSub(<span class="keyword">this</span>) <span class="comment">// ! åˆ é™¤æ—§çš„è§‚å¯Ÿè€…</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> tmp = <span class="keyword">this</span>.depIds</span><br><span class="line">  <span class="keyword">this</span>.depIds = <span class="keyword">this</span>.newDepIds <span class="comment">// ! äº¤æ¢ ids</span></span><br><span class="line">  <span class="keyword">this</span>.newDepIds = tmp</span><br><span class="line">  <span class="keyword">this</span>.newDepIds.clear() <span class="comment">// ! æ¸…ç©º newDepIds</span></span><br><span class="line">  tmp = <span class="keyword">this</span>.deps</span><br><span class="line">  <span class="keyword">this</span>.deps = <span class="keyword">this</span>.newDeps <span class="comment">// ! äº¤æ¢ deps</span></span><br><span class="line">  <span class="keyword">this</span>.newDeps = tmp</span><br><span class="line">  <span class="keyword">this</span>.newDeps.length = <span class="number">0</span> <span class="comment">// ! æ¸…ç©º newDeps</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æ˜¯å¯¹<code>deps</code>è¿›è¡Œéå†ï¼Œå³å¯¹ä¸Šä¸€æ¬¡æ±‚å€¼æ‰€æ”¶é›†åˆ°çš„<code>dep</code>è¿›è¡Œéå†ï¼Œåœ¨å¾ªç¯çš„è¿‡ç¨‹ä¸­ï¼Œæ£€æŸ¥ä¸Šä¸€æ¬¡æ±‚å€¼æ‰€æ”¶é›†åˆ°çš„ <code>dep</code>æ˜¯å¦å­˜åœ¨äºå½“å‰æ”¶é›†åˆ°çš„ <code>deps</code> ä¸­ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œè¯´æ˜è¯¥ <code>dep</code> å·²ç»å’Œè§‚å¯Ÿè€…ä¸å­˜åœ¨ä¾èµ–å…³ç³»ï¼Œè¿™æ—¶è°ƒç”¨ <code>dep.removeSub</code> æ–¹æ³•å°†è§‚å¯Ÿè€…ä» <code>dep</code>éƒ½<code>subs</code>ä¸­ç§»é™¤ã€‚</p><p><code>dep</code>çš„<code>removeSub</code>æ–¹æ³•çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">removeSub(sub: Watcher) &#123;</span><br><span class="line">  remove(<span class="keyword">this</span>.subs, sub)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ¯æ¬¡æ”¶é›†ä¾èµ–åï¼Œä¼šæ¸…ç©ºå½“å‰æ”¶é›†åˆ°çš„<code>dep</code> å¯¹è±¡ï¼Œå³æ¸…ç©º<code>newDepIds</code>å’Œ<code>newDeps</code>ä¸­çš„å€¼ï¼Œåœ¨æ¸…ç©ºä¹‹å‰å…ˆæŠŠå®ƒä»¬çš„å€¼èµ‹å€¼ç»™<code>depIds</code>å’Œ<code>deps</code>ã€‚</p><p>è¿™æ ·ï¼Œ<code>newDepIds</code> å’Œ <code>newDeps</code> æ‰€å­˜å‚¨çš„å€¼æ€»æ˜¯å½“å‰æ”¶é›†åˆ°çš„ <code>dep</code>ï¼Œè€Œ<code>depIds</code>å’Œ<code>deps</code>å­˜å‚¨çš„å€¼æ€»æ˜¯ä¸Šä¸€æ¬¡æ”¶é›†åˆ°çš„ <code>dep</code> ã€‚</p><h2 id="è§¦å‘ä¾èµ–"><a href="#è§¦å‘ä¾èµ–" class="headerlink" title="è§¦å‘ä¾èµ–"></a>è§¦å‘ä¾èµ–</h2><p>åœ¨æˆ‘ä»¬ä¿®æ”¹å“åº”å¼æ•°æ®æ—¶ï¼Œä¼šæ‰§è¡Œå®ƒçš„<code>setter</code>ï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>defineReactive</code>å‡½æ•°çš„å®šä¹‰çš„<code>setter</code>æ˜¯å¦‚ä½•è§¦å‘ä¾èµ–çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>: function reactiveSetter(newVal) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  dep.notify() <span class="comment">// ! é€šçŸ¥è§‚å¯Ÿè€…, è§¦å‘ä¾èµ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>setter</code>ä¸­æœ€åä¼šè°ƒç”¨<code>dep</code>çš„<code>notify</code>æ–¹æ³•é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ˆä¾èµ–ï¼‰ã€‚</p><p>çœ‹ä¸‹<code>notify</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>Dep</code>ç±»ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">notify() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">    subs[i].update()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†æ‰€æœ‰è§‚å¯Ÿè€…çš„<code>update</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥æ›´æ–°å€¼ï¼Œæ›´æ–°è§†å›¾çš„ã€‚</p><p>çœ‹ä¸‹<code>update</code>æ–¹æ³•çš„ä»£ç ï¼Œåœ¨<code>Watcher</code>ç±»ä¸­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">update() &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore else */</span></span><br><span class="line">  <span class="comment">// ! å¦‚æœå¯åŠ¨æ‡’æƒ°æ¨¡å¼  =&gt; æ›´æ–° dirty ä¸º trueï¼Œè¯´æ˜å¯ä»¥æ›´æ–°è®¡ç®—å±æ€§çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.lazy) &#123;</span><br><span class="line">    <span class="keyword">this</span>.dirty = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! åŒæ­¥æ‰§è¡Œï¼Œä¸éœ€è¦è°ƒç”¨ nextTick æ‰§è¡Œè§‚å¯Ÿè€… =&gt; ç”¨äº watch è‡ªå®šä¹‰çš„è§‚å¯Ÿè€…</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sync) &#123;</span><br><span class="line">    <span class="keyword">this</span>.run()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ! å¼‚æ­¥æ‰§è¡Œï¼Œéœ€è¦è°ƒç”¨ nextTick æ‰§è¡Œè§‚å¯Ÿè€… =&gt; ç”¨äºæ‰§è¡Œè‡ªåŠ¨æ”¶é›†çš„ä¾èµ–</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    queueWatcher(<span class="keyword">this</span>) <span class="comment">// ! ä½¿ç”¨å¼‚æ­¥é˜Ÿåˆ—æ›´æ–°</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆ¤æ–­<code>this.lazy</code>å±æ€§æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœä¸ºçœŸï¼Œè®¾ç½®<code>this.dirty</code>å±æ€§ä¸º<code>true</code>ã€‚è¿™æ ·ä½¿è§‚å¯Ÿè€…å¼€å¯æ‡’æƒ°æ¨¡å¼ï¼Œä¹Ÿè¯´æ˜è¿™ä¸ªè§‚å¯Ÿè€…æ˜¯è®¡ç®—å±æ€§è§‚å¯Ÿè€…ã€‚</p><p>æŠŠ<code>this.dirty</code>è®¾ç½®ä¸º<code>true</code>ï¼Œè¡¨ç¤ºå®ƒçš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œè§‚å¯Ÿè€…å¯ä»¥æ›´æ–°å®ƒçš„å€¼ã€‚è¿™ä¸ªå±æ€§ç”¨æ¥è®¾ç½®è®¡ç®—å±æ€§è§‚å¯Ÿè€…æ˜¯å¦å¯ä»¥æ‰§è¡Œæ›´æ–°ã€‚è®¡ç®—å±æ€§è§‚å¯Ÿè€…çš„æ›´æ–°ä»¥åŠå¦‚ä½•æ”¶é›†ä¾èµ–åœ¨åé¢è®²è§£è®¡ç®—å±æ€§æ—¶å†è®²è§£ã€‚</p><p>ä¸‹é¢å°±æ˜¯è§‚å¯Ÿè€…åŒæ­¥æ‰§è¡Œå’Œå¼‚æ­¥æ‰§è¡Œçš„ä»£ç ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Watcher-è§‚å¯Ÿè€…&quot;&gt;&lt;a href=&quot;#Watcher-è§‚å¯Ÿè€…&quot; class=&quot;headerlink&quot; title=&quot;Watcher è§‚å¯Ÿè€…&quot;&gt;&lt;/a&gt;&lt;code&gt;Watcher&lt;/code&gt; è§‚å¯Ÿè€…&lt;/h2&gt;&lt;p&gt;ä¸‹é¢çœ‹ä¸‹è§‚å¯Ÿè€…&lt;code&gt;Watcher&lt;/code&gt;çš„ä»£ç ï¼Œè¿™ä¸ªç±»æ¯”è¾ƒå¤æ‚ï¼Œé‡Œé¢åˆ›å»ºäº†å¾ˆå¤šå±æ€§å’Œæ–¹æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹ç»„ä»¶çš„æŒ‚è½½</title>
    <link href="https://haledeng.com/blog/20190919-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BB%84%E4%BB%B6%E7%9A%84%E6%8C%82%E8%BD%BD/"/>
    <id>https://haledeng.com/blog/20190919-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BB%84%E4%BB%B6%E7%9A%84%E6%8C%82%E8%BD%BD/</id>
    <published>2019-09-19T12:00:00.000Z</published>
    <updated>2020-05-07T08:58:02.138Z</updated>
    
    <content type="html"><![CDATA[<p>å‰é¢ç« èŠ‚ä¸»è¦é€šè¿‡<code>initData</code>å‡½æ•°åœ¨åˆå§‹åŒ–<code>data</code>é€‰é¡¹çš„è¿‡ç¨‹æ¥è®²è§£ Vue çš„å“åº”å¼ç³»ç»Ÿã€‚</p><p>ä¸»è¦è®²äº†å“åº”å¼ç³»ç»Ÿä¸­çš„å·¥å‚å‡½æ•°<code>observe</code>å’Œç›‘å¬å™¨<code>Observer</code>ä»¥åŠå¦‚ä½•å®šä¹‰å“åº”å¼å±æ€§çš„<code>defineReactive</code>å‡½æ•°ã€‚å› ä¸ºå“åº”å¼çš„åŸç†æ˜¯ä½¿ç”¨<code>Object.defineProperty</code>æ¥å®šä¹‰å¯¹è±¡æ•°æ®çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹æ•°ç»„ç±»å‹çš„æ•°æ®è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œé‡å†™æ•°ç»„çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•ï¼Œä½¿å¾—æ•°ç»„ä¸­çš„å…ƒç´ ä¹Ÿå’Œå¯¹è±¡é‡Œé¢çš„æ•°æ®ä¸€æ ·ï¼Œå¯ä»¥æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–ã€‚</p><a id="more"></a><p>ç°åœ¨æ¥çœ‹çœ‹ Vue çš„è§‚å¯Ÿè€…ä»¥åŠå“åº”å¼æ•°æ®æ˜¯å¦‚ä½•æ”¶é›†å’Œè§¦å‘ä¾èµ–çš„ã€‚</p><p>åœ¨å®Œæˆæ‰€æœ‰é€‰é¡¹çš„åˆå§‹åŒ–ä¹‹åï¼Œè¿™æ—¶å€™å°±éœ€è¦æŒ‚è½½ç»„ä»¶äº†ã€‚æŸ¥çœ‹<code>Vue.prototype._init</code>å‡½æ•°æœ€åå‡ è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¦‚æœè®¾ç½®äº† elï¼Œå°±æŠŠå®ä¾‹å¯¹è±¡æŒ‚è½½åœ¨è¯¥å…ƒç´ ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> (vm.$options.el) &#123;</span><br><span class="line">  vm.$mount(vm.$options.el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="mount"><a href="#mount" class="headerlink" title="$mount"></a><code>$mount</code></h2><p>ç°åœ¨æˆ‘ä»¬å»æŸ¥çœ‹ Vue å®ä¾‹å¯¹è±¡çš„ <code>$mount</code>æ–¹æ³•çš„ä»£ç ï¼Œå› ä¸ºæŒ‚è½½ç»„ä»¶çš„<code>$mount</code>å’Œå¹³å°æ¶‰åŠç›¸å…³ï¼Œè¿™é‡Œåªè®²è§£ Web å¹³å°çš„ä»£ç ã€‚å¦å¤–ï¼Œ<code>$mount</code>æ–¹æ³•è¿˜å’Œç‰ˆæœ¬ç›¸å…³ï¼ŒRuntime ç‰ˆæœ¬ä¸­çš„<code>$mount</code>æ–¹æ³•ä¸æ¶‰åŠç¼–è¯‘å™¨ä»£ç ï¼Œåªæœ‰å®Œæˆç‰ˆæœ¬ä¸­çš„<code>$mount</code>æ–¹æ³•æ‰æ¶‰åŠåˆ°ç¼–è¯‘å™¨ä»£ç ã€‚</p><p>å…ˆæŸ¥çœ‹ Runtime ç‰ˆæœ¬ä¸­çš„<code>$mount</code>å‡½æ•°ï¼Œåœ¨<code>platforms/web/runtime/index.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å®‰è£… web å¹³å°çš„æŒ‚è½½æ–¹æ³• $mount ï¼ˆè¿™é‡Œæ˜¯ runtime ç‰ˆæœ¬ï¼‰</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating) <span class="comment">// ! æŒ‚è½½ç»„ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆé‡å†™è®¾ç½®<code>el</code>çš„å€¼ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦ä¼ å…¥<code>el</code>å‚æ•°ï¼Œå¦‚æœä¼ å…¥çš„è¯ï¼Œå†åˆ¤æ–­å½“å‰çš„å®¿ä¸»ç¯å¢ƒæ˜¯å¦æ˜¯æµè§ˆå™¨ç¯å¢ƒã€‚å¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œä½¿ç”¨<code>query</code>å‡½æ•°å¹¶ä¼ å…¥<code>el</code>ï¼Œå¦åˆ™<code>el</code>ä¸º<code>undefiend</code>ã€‚</p><p>çœ‹ä¸‹<code>query</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params">el: string | Element</span>): <span class="title">Element</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> el === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> selected = <span class="built_in">document</span>.querySelector(el)</span><br><span class="line">    <span class="keyword">if</span> (!selected) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        warn(<span class="string">'Cannot find element: '</span> + el)</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> selected</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> el</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>el</code>çš„ç±»å‹å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯<code>Element</code>ï¼Œå¦‚æœ<code>el</code>æ˜¯å­—ç¬¦ä¸²çš„è¯ï¼Œè¯´æ˜<code>el</code>åº”è¯¥æ˜¯ä¸€ä¸ª<code>CSS</code>é€‰æ‹©å™¨ï¼Œè°ƒç”¨åŸç”Ÿçš„<code>document.querySelector</code>æ–¹æ³•è·å– DOMï¼Œå¦‚æœæ‰¾ä¸åˆ° DOM ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>å¦‚æœ<code>el</code>æ˜¯ä¸€ä¸ª<code>Element</code>ï¼Œåˆ™ç›´æ¥è¿”å›å®ƒã€‚æœ€åè¾“å‡ºåˆ°çš„<code>el</code>ä¸€å®šæ˜¯<code>Element</code>ç±»å‹ã€‚</p><p><code>$mount</code>å‡½æ•°æœ€åå†è°ƒç”¨<code>mountComponent</code>å‡½æ•°ï¼Œå¹¶ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ Vue çš„å®ä¾‹å¯¹è±¡<code>this</code>ã€è·å–åˆ°çš„å…ƒç´ <code>el</code>ä»¥åŠå¸ƒå°”å€¼<code>hydrating</code>ã€‚</p><p>å…ˆä¸å»ç®¡<code>mountComponent</code>å‡½æ•°ï¼Œç°åœ¨æŸ¥çœ‹å®Œæ•´ç‰ˆæœ¬çš„<code>$mount</code>æ–¹æ³•ï¼Œåœ¨<code>platforms/web/entry-runtime-with-compiler.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = Vue.prototype.$mount <span class="comment">// ! ç¼“å­˜ runtime ç‰ˆæœ¬çš„ $mount æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! é‡å†™ $mount æ–¹æ³• with compiler</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; query(el)</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> mount.call(<span class="keyword">this</span>, el, hydrating) <span class="comment">// ! è°ƒç”¨ runtime mount æ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶ä¸­å…ˆå£°æ˜å¸¸é‡<code>mount</code>ç¼“å­˜ Runtime ç‰ˆæœ¬çš„<code>$mount</code>ï¼Œç„¶åé‡å†™äº†<code>Vue.prototype.$mount</code>æ–¹æ³•ï¼Œçœ‹ä¸‹é‡å†™æ–¹æ³•çš„ç¬¬ä¸€è¡Œä»£ç ï¼Œè¿˜æ˜¯é€šè¿‡<code>query</code>è·å– <code>DOM</code> ã€‚å†çœ‹æœ€åä¸€è¡Œçš„ä»£ç ï¼Œè°ƒç”¨ Runtime ç‰ˆæœ¬çš„<code>$mount</code>ï¼Œå¹¶ä¼ å…¥ç›¸åŒçš„å‚æ•°ã€‚</p><p>ç°åœ¨çœ‹ä¸‹é‡å†™æ–¹æ³•ä¸­é—´çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ä¸èƒ½æŒ‚è½½åœ¨ body å’Œ html æ ‡ç­¾ä¸Š</span></span><br><span class="line"><span class="keyword">if</span> (el === <span class="built_in">document</span>.body || el === <span class="built_in">document</span>.documentElement) &#123;</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Do not mount Vue to &lt;html&gt; or &lt;body&gt; - mount to normal elements instead.`</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­è·å–çš„å…ƒç´ æ˜¯ä¸æ˜¯<code>document.body</code>æˆ–è€…<code>document.documentElement</code>ï¼Œå¦‚æœæ˜¯çš„è¯åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚å› ä¸º Vue çš„å®ä¾‹å¯¹è±¡æŒ‚è½½åœ¨å…ƒç´ ä¸Šæ˜¯ä¼šæ›¿æ¢æ‰è¿™ä¸ªå…ƒç´ çš„ï¼Œè¿™æ ·çš„è¯å°±ä¼šæŠŠ<code>body</code>å’Œ<code>html</code>æ ‡ç­¾å…ƒç´ æ›¿æ¢æ‰ï¼Œè€Œè¿™ä¸¤ä¸ªå…ƒç´ æ˜¯ä¸åº”è¯¥è¢«æ›¿æ¢æ‰çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = <span class="keyword">this</span>.$options</span><br><span class="line"><span class="comment">// resolve template/el and convert to render function</span></span><br><span class="line"><span class="comment">// ! å¦‚æœæ²¡æœ‰æ¸²æŸ“å‡½æ•°ï¼Œä½¿ç”¨ template æˆ–è€… el æ„å»ºæ¸²æŸ“å‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> (!options.render) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>option</code>å­˜å‚¨åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ï¼Œç„¶ååˆ¤æ–­æ¸²æŸ“å‡½æ•°<code>options.render</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨<code>template</code>æˆ–è€…<code>el</code>é€‰é¡¹æ„å»ºæ¸²æŸ“å‡½æ•°ã€‚</p><p>è¿™é‡Œå…ˆæå‰è¯´ä¸‹åé¢ä»£ç çš„ä¸»è¦é€»è¾‘ï¼Œå…ˆåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>template</code>é€‰é¡¹ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™ä½¿ç”¨<code>template</code>é€‰é¡¹çš„å€¼è·å–<code>template</code>ï¼›å¦‚æœä¸å­˜åœ¨ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨<code>el</code>é€‰é¡¹ï¼Œå¦‚æœå­˜åœ¨<code>el</code>é€‰é¡¹åˆ™ä½¿ç”¨<code>el</code>é€‰é¡¹è·å–<code>template</code>çš„å€¼ã€‚æ€»ä¹‹ä¸€å®šè¦è·å–åˆ°<code>template</code>ï¼Œè€Œä¸”å®ƒéƒ½å€¼å¿…é¡»æ˜¯<code>Element</code>ç±»å‹ï¼Œè¿™æ ·æ‰èƒ½æŒ‚è½½ç»„ä»¶ã€‚</p><p>ç°åœ¨çœ‹ä¸‹å¦‚ä½•ä½¿ç”¨<code>template</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> template = options.template</span><br><span class="line"><span class="comment">// ! è·å– template çš„å€¼</span></span><br><span class="line"><span class="comment">// ! ä¼˜å…ˆä» template é€‰é¡¹ä¸­è·å–</span></span><br><span class="line"><span class="keyword">if</span> (template) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> template === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="comment">// ! id é€‰æ‹©å™¨</span></span><br><span class="line">    <span class="keyword">if</span> (template.charAt(<span class="number">0</span>) === <span class="string">'#'</span>) &#123;</span><br><span class="line">      template = idToTemplate(template)</span><br><span class="line">      <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !template) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Template element not found or is empty: <span class="subst">$&#123;options.template&#125;</span>`</span>,</span><br><span class="line">          <span class="keyword">this</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å˜é‡<code>options</code>å­˜å‚¨<code>options.template</code>çš„å€¼ã€‚</p><p>ç„¶ååˆ¤æ–­<code>template</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå†åˆ¤æ–­å®ƒæ˜¯ä¸æ˜¯ä»¥<code>#</code>å¼€å¤´ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±å¯ä»¥ç¡®å®š<code>template</code>åº”è¯¥æ˜¯ä¸€ä¸ª<code>CSS</code>çš„<code>id</code>é€‰æ‹©å™¨ï¼Œè°ƒç”¨<code>idToTemplate</code>å‡½æ•°é€šè¿‡è¿™ä¸ªé€‰æ‹©å™¨è·å–å…ƒç´ ã€‚</p><p>çœ‹ä¸‹<code>idToTemplate</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! é€šè¿‡ id è·å–å…ƒç´ çš„ innerHTML</span></span><br><span class="line"><span class="keyword">const</span> idToTemplate = cached(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> el = query(id)</span><br><span class="line">  <span class="keyword">return</span> el &amp;&amp; el.innerHTML</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é€šè¿‡<code>id</code>é€‰æ‹©å™¨æ¥è·å–å…ƒç´ ï¼Œå¹¶è¿”å›å…ƒç´ çš„<code>innerHTML</code>ã€‚</p><p>å¦‚æœè·å–ä¸åˆ°å…ƒç´ çš„<code>innerHTML</code>ä½œä¸º<code>template</code>çš„å€¼ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºæ‰¾ä¸åˆ°æ¨¡æ¿å…ƒç´ æˆ–è€…æ¨¡æ¿å…ƒç´ æ˜¯ç©ºçš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å…ƒç´ ç±»å‹</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (template.nodeType) &#123;</span><br><span class="line">  template = template.innerHTML</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>template</code>æœ‰<code>nodeType</code>å±æ€§ï¼Œè¯´æ˜å®ƒæ˜¯ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥è·å–å®ƒçš„<code>innerHtml</code>çš„å€¼ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å…¶ä»–æ— æ•ˆçš„ template æŠ¥é”™</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(<span class="string">'invalid template option:'</span> + template, <span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­åˆ†æ<code>template</code>çš„å…¶ä»–æƒ…å†µï¼Œå³æ— æ•ˆçš„<code>template</code>ã€‚æ­¤æ—¶å¦‚æœåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤º<code>template</code>é€‰é¡¹æ˜¯æ— æ•ˆçš„ã€‚</p><p>ä¸‹é¢çœ‹ä½¿ç”¨<code>el</code>çš„æƒ…å†µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (template) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">// ! å…¶æ¬¡ä» el é€‰é¡¹è·å–</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (el) &#123;</span><br><span class="line">  template = getOuterHTML(el)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>templatetemplate</code>æ— æ³•è·å–æœ‰æ•ˆçš„å…ƒç´ æ—¶ï¼Œå¦‚æœæœ‰<code>el</code>é€‰é¡¹ï¼Œé€šè¿‡è°ƒç”¨<code>getOuterHTML</code>å‡½æ•°è·å–å…ƒç´ ã€‚</p><p><strong>æ³¨æ„è¿™é‡Œçš„<code>el</code>æ˜¯<code>Element</code>ç±»å‹</strong>ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹çš„å‘¢ï¼Ÿå¦‚æœåœ¨ Runtime ç‰ˆæœ¬æ—¶ï¼Œ<code>el</code>å¯ä»¥æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå³å®ƒæ˜¯ä¸€ä¸ª<code>CSS</code>é€‰æ‹©å™¨ï¼Œç„¶åé€šè¿‡é€‰æ‹©å™¨å¯ä»¥è·å–å…ƒç´ ã€‚</p><p>ä½†æ˜¯åœ¨å®Œæ•´ç‰ˆæœ¬ä¸­ï¼Œè¿™é‡Œéœ€è¦ä¸€ä¸ª<code>Element</code>ç±»å‹çš„<code>template</code>ï¼Œåœ¨å‰é¢çš„é€»è¾‘ä¸­æ²¡æœ‰é€šè¿‡<code>template</code>é€‰é¡¹è·å–åˆ°<code>template</code>çš„å€¼ï¼Œæ‰€ä»¥è¿™é‡Œå¿…é¡»æ˜¯ä¸€ä¸ª<code>Element</code>ç±»å‹çš„å€¼ã€‚</p><p>çœ‹ä¸‹<code>getOuterHTML</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getOuterHTML</span>(<span class="params">el: Element</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (el.outerHTML) &#123;</span><br><span class="line">    <span class="keyword">return</span> el.outerHTML</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> container = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>)</span><br><span class="line">    container.appendChild(el.cloneNode(<span class="literal">true</span>))</span><br><span class="line">    <span class="keyword">return</span> container.innerHTML</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>el</code>å…ƒç´ æ˜¯å¦æœ‰<code>outerHTML</code>ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œç›´æ¥è¿”å›å®ƒçš„<code>outerHTML</code>ã€‚å¦‚æœæ²¡æœ‰çš„è¯ï¼Œåˆ›å»ºä¸€ä¸ª<code>div</code>å®¹å™¨ï¼Œç„¶åæŠŠ<code>el</code>å…ƒç´ çš„å…‹éš†å€¼æ”¾å…¥å®¹å™¨ä¸­ï¼Œæœ€åè¿”å›å®¹å™¨çš„<code>innerHTML</code>ï¼Œä¹Ÿå°±æ˜¯è¿”å›<code>el</code>å…ƒç´ ã€‚</p><p>ä¸ºä»€ä¹ˆä¸ç›´æ¥åˆ›å»ºä¸€ä¸ªå…ƒç´ å†è¿”å›å®ƒå‘¢ï¼Ÿå› ä¸ºæœ‰çš„å…ƒç´ å¯èƒ½æ²¡æœ‰<code>innerHTML</code>æˆ–è€…<code>outerHTML</code>å±æ€§ï¼Œæ¯”å¦‚<code>SVG</code>æ ‡ç­¾å…ƒç´ åœ¨ <code>IE 9-11</code>æ—¶å°±æ²¡æœ‰<code>innerHTML</code>å’Œ<code>outerHTML</code>å±æ€§ã€‚æ­¤æ—¶ï¼Œå¦‚æœ<code>el</code>é€‰é¡¹æ˜¯<code>SVG</code>æ ‡ç­¾å…ƒç´ å°±ä¼šå‡ºé”™ã€‚å¦‚æœå…ˆåˆ›å»ºä¸€ä¸ª<code>div</code>å®¹å™¨å…ƒç´ ï¼Œç„¶åæŠŠä¸€ä¸ªå…‹éš†å…ƒç´ æ”¾è¿›å»ï¼Œå†è¿”å›å®¹å™¨å…ƒç´ çš„<code>innerHTML</code>å°±ä¸ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºè¿™ä¸ªå®¹å™¨å…ƒç´ çš„<code>innerHTML</code>æ˜¯ä¸€å®šå­˜åœ¨çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (template) &#123;</span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// ! æµ‹è¯•ç¼–è¯‘æ€§èƒ½ä¹‹å¼€å§‹</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    mark(<span class="string">'compile'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">  <span class="comment">// ! æµ‹è¯•ç¼–è¯‘æ€§èƒ½ä¹‹ç»“æŸ</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">    mark(<span class="string">'compile end'</span>)</span><br><span class="line">    measure(<span class="string">`vue <span class="subst">$&#123;<span class="keyword">this</span>._name&#125;</span> compile`</span>, <span class="string">'compile'</span>, <span class="string">'compile end'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è·å–åˆ°<code>template</code>å…ƒç´ åï¼Œæ‰§è¡Œä¸‹é¢çš„ç¼–è¯‘æ“ä½œã€‚</p><p>è¿™é‡Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•<code>compile</code>çš„æ€§èƒ½ã€‚</p><p>å†çœ‹ä¸‹æ€§èƒ½æµ‹è¯•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ç”Ÿæˆæ¸²æŸ“å‡½æ•°</span></span><br><span class="line"><span class="keyword">const</span> &#123; render, staticRenderFns &#125; = compileToFunctions(</span><br><span class="line">  template,</span><br><span class="line">  &#123;</span><br><span class="line">    outputSourceRange: process.env.NODE_ENV !== <span class="string">'production'</span>,</span><br><span class="line">    shouldDecodeNewlines,</span><br><span class="line">    shouldDecodeNewlinesForHref,</span><br><span class="line">    delimiters: options.delimiters, <span class="comment">// ! åˆ†éš”ç¬¦é…ç½®ï¼Œæ˜¯ä¸ªæ•°ç»„ï¼Œé»˜è®¤æ˜¯ ["&#123;&#123;", "&#125;&#125;"]</span></span><br><span class="line">    comments: options.comments <span class="comment">// ! è¯„è®ºé…ç½®</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">this</span></span><br><span class="line">)</span><br><span class="line">options.render = render</span><br><span class="line">options.staticRenderFns = staticRenderFns</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨<code>compileToFunctions</code>å‡½æ•°ç”Ÿæˆäº†æ¸²æŸ“å‡½æ•°<code>render</code>å’Œé™æ€æ¸²æŸ“å‡½æ•°<code>staticRenderFns</code>ã€‚ç„¶åæŠŠå®ƒä»¬å­˜å‚¨åœ¨<code>options</code>ä¸­ï¼Œå³å­˜å‚¨åœ¨<code>vm.$options</code>ä¸­ã€‚</p><p><strong>å°ç»“</strong>ï¼Œå®Œæ•´ç‰ˆæœ¬çš„<code>$mount</code>æ–¹æ³•ç»§æ‰¿äº† Runtime ç‰ˆæœ¬çš„æ–¹æ³•ï¼Œç„¶åæŠŠæ¨¡æ¿å­—ç¬¦ä¸²ç¼–è¯‘æˆæ¸²æŸ“å‡½æ•°ï¼Œå¹¶æŠŠæ¸²æŸ“æ–¹æ³•å­˜å‚¨åœ¨<code>vm.$options</code>ä¸­ã€‚</p><h2 id="mountComponent"><a href="#mountComponent" class="headerlink" title="mountComponent"></a><code>mountComponent</code></h2><p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹<code>mountComponentmountComponent</code>å‡½æ•°ï¼Œ<code>$mount</code>æ–¹æ³•æœ€ç»ˆéƒ½ä¼šè°ƒç”¨çš„è¿™ä¸ªå‡½æ•°ï¼Œå®ƒæ‰æ˜¯çœŸæ­£æŒ‚è½½ç»„ä»¶çš„æ–¹æ³•ï¼Œè¿™ä¸ªå‡½æ•°åœ¨<code>core/instance/lifecycle.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æŒ‚è½½ç»„ä»¶çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mountComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  el: ?Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  vm.$el = el <span class="comment">// ! æ›´æ–° $el å±æ€§</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¼ è¿›æ¥çš„å‚æ•°<code>el</code>æ›´æ–°<code>vm.$el</code>çš„å€¼ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œ<code>vm.$el</code>çš„å€¼ä¹Ÿä¸æ˜¯æœ€åçœŸæ­£æŒ‚è½½çš„å…ƒç´ ï¼Œåé¢å†è®²è§£ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!vm.$options.render) &#123;</span><br><span class="line">  vm.$options.render = createEmptyVNode <span class="comment">// ! render ä¼šç”Ÿæˆä¸€ä¸ªç©ºçš„ VNode</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore if */</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (vm.$options.template &amp;&amp; vm.$options.template.charAt(<span class="number">0</span>) !== <span class="string">'#'</span>) ||</span><br><span class="line">      vm.$options.el ||</span><br><span class="line">      el</span><br><span class="line">    ) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'You are using the runtime-only build of Vue where the template '</span> +</span><br><span class="line">          <span class="string">'compiler is not available. Either pre-compile the templates into '</span> +</span><br><span class="line">          <span class="string">'render functions, or use the compiler-included build.'</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'Failed to mount component: template or render function not defined.'</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ Vue çš„å®ä¾‹å¯¹è±¡ä¸­æ˜¯å¦å­˜åœ¨æ¸²æŸ“å‡½æ•°<code>render</code>ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œæ¸²æŸ“å‡½æ•°ä¼šè¢«èµ‹å€¼ä¸ºä¸€ä¸ªç”Ÿæˆä¸€ä¸ªç©ºçš„<code>VNode</code>ï¼ˆè™šæ‹ŸèŠ‚ç‚¹ï¼‰çš„å‡½æ•°ï¼Œç„¶ååœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåˆ¤æ–­<code>template</code>æ˜¯å¦ä»¥<code>#</code>å¼€å¤´æˆ–è€…å­˜åœ¨<code>el</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šè­¦å‘Šåœ¨ Runtime ç¯å¢ƒä¸­æ— æ³•ç¼–è¯‘å…ƒç´ ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼Œä¼šè­¦å‘Š<code>template</code>æˆ–è€…æ¸²æŸ“å‡½æ•°æœªå®šä¹‰ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callHook(vm, <span class="string">'beforeMount'</span>) <span class="comment">// ! æŒ‚è½½ç»„ä»¶ä¹‹å‰ï¼Œè°ƒç”¨ beforeMount é’©å­å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>åœ¨æŒ‚è½½ç»„ä»¶ä¹‹å‰ï¼Œæ‰§è¡Œ<code>beforeMount</code>ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ›´æ–°ç»„ä»¶çš„å‡½æ•°</span></span><br><span class="line"><span class="keyword">let</span> updateComponent</span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">  updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> name = vm._name</span><br><span class="line">    <span class="keyword">const</span> id = vm._uid</span><br><span class="line">    <span class="keyword">const</span> startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line">    <span class="keyword">const</span> endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;id&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    mark(startTag) <span class="comment">// ! å¼€å§‹ç»Ÿè®¡ _render å‡½æ•°æ€§èƒ½</span></span><br><span class="line">    <span class="keyword">const</span> vnode = vm._render() <span class="comment">// ! ç”Ÿæˆ VNode</span></span><br><span class="line">    mark(endTag)</span><br><span class="line">    measure(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> render`</span>, startTag, endTag)</span><br><span class="line"></span><br><span class="line">    mark(startTag) <span class="comment">// ! å¼€å§‹ç»Ÿè®¡ _update å‡½æ•°æ€§èƒ½</span></span><br><span class="line">    vm._update(vnode, hydrating) <span class="comment">// ! å°† VNode æ¸²æŸ“åˆ°çœŸå® `DOM` ä¸­</span></span><br><span class="line">    mark(endTag)</span><br><span class="line">    measure(<span class="string">`vue <span class="subst">$&#123;name&#125;</span> patch`</span>, startTag, endTag)</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå£°æ˜ä¸€ä¸ªå…¬å…±çš„å˜é‡<code>updateComponent</code>ç”¨æ¥å­˜å‚¨å‡½æ•°ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒå’Œéç”Ÿäº§ç¯å¢ƒä¸­è¿™ä¸ªå‡½æ•°æœ‰ä¸€ç‚¹ä¸ä¸€æ ·ï¼Œå› ä¸ºåœ¨éç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦æµ‹é‡å‡½æ•°é‡Œé¢çš„<code>vm._render</code>æ–¹æ³•å’Œ<code>vm._update</code>æ–¹æ³•çš„æ€§èƒ½ã€‚</p><p>è¿™ä¸¤ä¸ªæ–¹æ³•çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼š</p><ul><li><code>vm._render</code>ï¼šè°ƒç”¨ <code>vm.$options.render</code> å‡½æ•°å¹¶è¿”å›ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹(<code>vnode</code>)ã€‚</li><li><code>vm._update</code>ï¼šæŠŠ <code>vm._render</code> å‡½æ•°ç”Ÿæˆçš„è™šæ‹ŸèŠ‚ç‚¹æ¸²æŸ“æˆçœŸæ­£çš„å…ƒç´ ã€‚</li></ul><p>å…ˆçœ‹ä¸‹ç”Ÿäº§ç¯å¢ƒçš„ä¸­<code>updateComponent</code>å‡½æ•°çš„ä»£ç ï¼Œåªæœ‰ä¸€è¡Œä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">updateComponent = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  vm._update(vm._render(), hydrating) <span class="comment">// ! æŠŠ _render ç”Ÿæˆçš„ VNode æ¸²æŸ“æˆçœŸå®çš„ `DOM`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€»è¾‘å¾ˆç®€å•ï¼Œè°ƒç”¨<code>vm._update</code>æ–¹æ³•æŠŠ<code>vm._render</code>æ–¹æ³•ç”Ÿæˆçš„<code>VNode</code>æ¸²æŸ“æˆçœŸå®çš„å…ƒç´ ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ç”Ÿæˆè§‚å¯Ÿè€…å®ä¾‹</span></span><br><span class="line"><span class="keyword">new</span> Watcher(</span><br><span class="line">  vm,</span><br><span class="line">  updateComponent, <span class="comment">// ! æ›´æ–°ç»„ä»¶çš„å‡½æ•°ï¼Œæ‰§è¡Œæ—¶ -&gt; æ‰§è¡Œ vm.$options.render -&gt; getter -&gt; æ”¶é›†ä¾èµ–</span></span><br><span class="line">  noop,</span><br><span class="line">  &#123;</span><br><span class="line">    before() &#123;</span><br><span class="line">      <span class="keyword">if</span> (vm._isMounted &amp;&amp; !vm._isDestroyed) &#123;</span><br><span class="line">        callHook(vm, <span class="string">'beforeUpdate'</span>) <span class="comment">// ! ä¼ å…¥ beforeUpdate ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œåœ¨æ›´æ–°å‰ç»„ä»¶å‰è°ƒç”¨</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="literal">true</span> <span class="comment">/* isRenderWatcher */</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>new</code>æ“ä½œç¬¦ç”Ÿæˆä¸€ä¸ªè§‚å¯Ÿè€…<code>Watcher</code>å®ä¾‹å¯¹è±¡ã€‚</p><p>åˆ°è¿™é‡Œï¼Œå“åº”å¼ç³»ç»Ÿçš„è§‚å¯Ÿè€…ä¹Ÿç»ˆäºéœ²å‡ºæ°´é¢äº†ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰é¢ç« èŠ‚ä¸»è¦é€šè¿‡&lt;code&gt;initData&lt;/code&gt;å‡½æ•°åœ¨åˆå§‹åŒ–&lt;code&gt;data&lt;/code&gt;é€‰é¡¹çš„è¿‡ç¨‹æ¥è®²è§£ Vue çš„å“åº”å¼ç³»ç»Ÿã€‚&lt;/p&gt;
&lt;p&gt;ä¸»è¦è®²äº†å“åº”å¼ç³»ç»Ÿä¸­çš„å·¥å‚å‡½æ•°&lt;code&gt;observe&lt;/code&gt;å’Œç›‘å¬å™¨&lt;code&gt;Observer&lt;/code&gt;ä»¥åŠå¦‚ä½•å®šä¹‰å“åº”å¼å±æ€§çš„&lt;code&gt;defineReactive&lt;/code&gt;å‡½æ•°ã€‚å› ä¸ºå“åº”å¼çš„åŸç†æ˜¯ä½¿ç”¨&lt;code&gt;Object.defineProperty&lt;/code&gt;æ¥å®šä¹‰å¯¹è±¡æ•°æ®çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦å¯¹æ•°ç»„ç±»å‹çš„æ•°æ®è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œé‡å†™æ•°ç»„çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•ï¼Œä½¿å¾—æ•°ç»„ä¸­çš„å…ƒç´ ä¹Ÿå’Œå¯¹è±¡é‡Œé¢çš„æ•°æ®ä¸€æ ·ï¼Œå¯ä»¥æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹Setå’ŒDel</title>
    <link href="https://haledeng.com/blog/20190917-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BSet%E5%92%8CDel/"/>
    <id>https://haledeng.com/blog/20190917-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BSet%E5%92%8CDel/</id>
    <published>2019-09-17T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:57.165Z</updated>
    
    <content type="html"><![CDATA[<h2 id="set-å‡½æ•°"><a href="#set-å‡½æ•°" class="headerlink" title="set å‡½æ•°"></a><code>set</code> å‡½æ•°</h2><p>ä¸‹é¢çœ‹ä¸‹<code>set</code>å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡æ—¶åˆ›å»º<code>Vue.prototype.$set</code>æ–¹æ³•ï¼Œç„¶ååœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„é™æ€æ–¹æ³•æ—¶åˆ›å»º<code>Vue.set</code>æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ‰€èµ‹å€¼çš„å‡½æ•°éƒ½æ˜¯<code>set</code>å‡½æ•°ã€‚</p><p>åœ¨ Vue çš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæä¾›äº†è¿™ä¸¤ä¸ª API ä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œç”¨æ¥å‘å“åº”å¼å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªæ–°å±æ€§åŒæ ·æ˜¯å“åº”å¼çš„ï¼Œä¸”è§¦å‘è§†å›¾æ›´æ–°ã€‚å®ƒå¿…é¡»ç”¨äºå“åº”å¼å¯¹è±¡ä¸Šæ·»åŠ æ–°å±æ€§ï¼Œå› ä¸º Vue æ— æ³•æ¢æµ‹æ™®é€šçš„æ–°å¢å±æ€§ã€‚å¦å¤–ï¼Œæ³¨æ„è®¾ç½®çš„å¯¹è±¡ä¸èƒ½æ˜¯ Vue å®ä¾‹æˆ–è€… Vue å®ä¾‹çš„æ ¹æ•°æ®å¯¹è±¡ã€‚</p><a id="more"></a><p>ä¸‹é¢æŸ¥çœ‹<code>set</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">target: Array&lt;any&gt; | Object, key: any, val: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    (isUndef(target) || isPrimitive(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Cannot set reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåˆ¤æ–­<code>taregt</code>çš„ç±»å‹æ˜¯ä¸æ˜¯æœªå®šä¹‰çš„å€¼æˆ–è€…æ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹çš„å€¼ï¼Œå¦‚æœæ»¡è¶³å…¶ä¸­ä¹‹ä¸€çš„è¯ä¼šæŠ¥é”™ï¼Œå¹¶æç¤ºä¸èƒ½è®¾ç½®<code>null</code>ã€<code>undefined</code>æˆ–è€…åŸå§‹ç±»å‹ä¸­çš„å“åº”å¼å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! target æ˜¯æ•°ç»„ä¸” key æœ‰æ•ˆæ—¶</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">  target.length = <span class="built_in">Math</span>.max(target.length, key) <span class="comment">// ! ä¿®æ”¹æ•°ç»„é•¿åº¦ key, å¦åˆ™å¤§äºåŸæ•°ç»„é•¿åº¦æ—¶ splice æ— æ•ˆ</span></span><br><span class="line">  target.splice(key, <span class="number">1</span>, val) <span class="comment">// ! ä½¿ç”¨é‡å†™çš„ splice å¢åŠ æˆ–è€…æ›¿æ¢å…ƒç´ ï¼Œå¹¶è§¦å‘å“åº”</span></span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå®šä¹‰çš„å“åº”å¼å¯¹è±¡æ˜¯æ•°ç»„æ—¶ä¸”å®ƒé‡Œé¢çš„<code>key</code>å€¼æ˜¯æœ‰æ•ˆå€¼æ—¶ï¼Œå…ˆè·å–æ•°ç»„é•¿åº¦å’Œ<code>key</code>çš„ä¸­æœ€å¤§å€¼ï¼ŒæŠŠå®ƒè®¾ç½®ä¸º<code>taregt</code>çš„é•¿åº¦ã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå› ä¸ºå¦‚æœè®¾ç½®çš„<code>key</code>å¤§äºåŸæ¥<code>taregt</code>çš„é•¿åº¦ï¼Œä½¿ç”¨<code>splice</code>æ˜¯æ’å…¥å…ƒç´ æ—¶ï¼Œæ’å…¥åçš„å…ƒç´ åœ¨æ•°ç»„ä¸­çš„ä½ç½®ä¼šä¸æ­£ç¡®ï¼Œå³ç´¢å¼•ä¸æ­£ç¡®ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>] <span class="comment">// length = 3</span></span><br><span class="line"><span class="keyword">const</span> key = <span class="number">5</span></span><br><span class="line">arr.splice(key, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">console</span>.log(arr) <span class="comment">// [ 1, 2, 3, 4 ]</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­ key æ˜¯<code>5</code>ï¼Œå®ƒæ¯”æ•°ç»„<code>arr</code>çš„é•¿åº¦<code>3</code>è¦å¤§ï¼ŒæŠŠæ•°å­—<code>4</code>ä¼ å…¥åˆ°<code>key</code>çš„ä½ç½®åï¼Œå®ƒçš„ä½ç½®æ˜¯é”™è¯¯çš„ã€‚</p><p>å¦‚æœä¿®æ”¹äº†<code>target</code>çš„é•¿åº¦ä¸º<code>key</code>å’ŒåŸæ¥é•¿åº¦çš„æœ€å¤§å€¼åï¼Œæ’å…¥åçš„ä½ç½®æ˜¯ä¸ä¸€æ ·çš„ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line"><span class="keyword">const</span> key = <span class="number">5</span></span><br><span class="line">arr.length = <span class="built_in">Math</span>.max(arr.length, key)</span><br><span class="line">arr.splice(key, <span class="number">1</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">console</span>.log(arr) <span class="comment">// [ 1, 2, 3, &lt;2 empty items&gt;, 4 ]</span></span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! key å·²ç»å­˜åœ¨å¯¹è±¡ target ä¸”ä¸åœ¨å®ƒçš„åŸå‹ä¸­æ—¶</span></span><br><span class="line"><span class="keyword">if</span> (key <span class="keyword">in</span> target &amp;&amp; !(key <span class="keyword">in</span> <span class="built_in">Object</span>.prototype)) &#123;</span><br><span class="line">  target[key] = val <span class="comment">// ! ç›´æ¥ä¿®æ”¹åŸæ¥çš„å€¼ï¼Œä¼šè‡ªåŠ¨è§¦å‘ setter</span></span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¾ç½®çš„<code>key</code>å·²ç»å­˜åœ¨äºå“åº”å¼å¯¹è±¡ä¸­ä½†ä¸åœ¨å®ƒçš„åŸå‹å¯¹è±¡ä¸Šæ—¶ï¼Œç›´æ¥èµ‹å€¼å³å¯ï¼Œä¼šè‡ªåŠ¨è§¦å‘<code>setter</code>ï¼Œæœ€åè¿”å›è®¾ç½®çš„æ–°å€¼ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! è·å–åŸå¯¹è±¡çš„ __ob__ å±æ€§</span></span><br><span class="line"><span class="keyword">const</span> ob = (target: any).__ob__</span><br><span class="line"><span class="comment">// ! ä¸å…è®¸è®¾ç½® Vue å®ä¾‹ å’Œ æ ¹å®ä¾‹æ•°æ®å¯¹è±¡ï¼ˆæ ¹ data ä¸æ˜¯å“åº”å¼çš„ï¼‰çš„å±æ€§</span></span><br><span class="line"><span class="keyword">if</span> (target._isVue || (ob &amp;&amp; ob.vmCount)) &#123;</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Avoid adding reactive properties to a Vue instance or its root $data '</span> +</span><br><span class="line">        <span class="string">'at runtime - declare it upfront in the data option.'</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>ob</code>å­˜å‚¨<code>target</code>çš„<code>__ob__</code>å±æ€§ï¼Œåˆ¤æ–­<code>target</code>æ˜¯å¦æœ‰<code>_isVue</code>å±æ€§æˆ–è€…<code>ob.vmCount</code>çš„å€¼æ˜¯å¦å¤§äºé›¶ã€‚å¦‚æœåŒæ—¶æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ä¸”åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºä¸èƒ½è®¾ç½® Vue å®ä¾‹å¯¹è±¡çš„å±æ€§æˆ–è€…æ ¹ç»„ä»¶çš„<code>data</code>é€‰é¡¹çš„å€¼ï¼Œæœ€åè¿”å›è®¾ç½®çš„å€¼<code>val</code>ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! åŸå¯¹è±¡ä¸æ˜¯å“åº”å¼å¯¹è±¡ï¼Œæ–°å±æ€§ç›´æ¥èµ‹å€¼å¹¶è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">  target[key] = val</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br><span class="line">defineReactive(ob.value, key, val) <span class="comment">// ! æ–°å±æ€§å˜æˆå“åº”å¼</span></span><br><span class="line">ob.dep.notify() <span class="comment">// ! æ‰‹åŠ¨è§¦å‘ä¾èµ–</span></span><br><span class="line"><span class="keyword">return</span> val</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>ob</code>æ˜¯å¦å­˜åœ¨ï¼Œå³åˆ¤æ–­<code>taregt</code>æ˜¯å¦æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯çš„è¯ï¼Œç›´æ¥ç»™å®ƒçš„<code>key</code>èµ‹å€¼ä¸º<code>val</code>ï¼Œå¹¶è¿”å›<code>val</code>ã€‚</p><p>å¦‚æœ<code>taregt</code>æ˜¯ä¸€ä¸ªå“åº”å¼å¯¹è±¡ï¼ŒæŠŠå®ƒæ–°å¢çš„å€¼ä¹Ÿå˜æˆå“åº”å¼æ•°æ®ï¼Œç„¶åæ‰‹åŠ¨è§¦å‘ä¾èµ–ï¼Œå¹¶è¿”å›è®¾ç½®çš„å€¼<code>val</code>ã€‚</p><p><strong>å°ç»“</strong>ï¼Œè™½ç„¶ Vue çš„å®˜æ–¹æ–‡æ¡£ä¸­è¯´æ˜åªèƒ½æ˜¯ä¸ºå“åº”å¼æ•°æ®è®¾ç½®å€¼ï¼Œä½†æ˜¯å®ƒçš„ä»£ç ä¸­ä¹Ÿå¯ä»¥ä¸ºéå“åº”å¼çš„å¯¹è±¡è®¾ç½®å€¼ï¼Œä¸è¿‡æˆ‘ä»¬åœ¨å®é™…å¼€å‘ä¸­æ²¡æœ‰å¿…è¦è¿™æ ·ï¼Œå› ä¸ºå¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªå¯¹è±¡ä¸Šæ“ä½œï¼Œè€Œä¸éœ€è¦é¢å¤–ä½¿ç”¨è¿™ä¸ª APIã€‚</p><h2 id="del"><a href="#del" class="headerlink" title="del"></a><code>del</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>del</code>å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡æ—¶åˆ›å»º<code>Vue.prototype.$delete</code>æ–¹æ³•ï¼Œç„¶ååœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„é™æ€æ–¹æ³•æ—¶åˆ›å»º<code>Vue.delete</code>æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ‰€èµ‹å€¼çš„å‡½æ•°éƒ½æ˜¯<code>del</code>å‡½æ•°ã€‚</p><p>åœ¨ Vue çš„æ–‡æ¡£ä¸­ï¼Œæä¾›äº†è¿™ä¸¤ä¸ª API ä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œç”¨æ¥åˆ é™¤å¯¹è±¡çš„å±æ€§ã€‚å¦‚æœå¯¹è±¡æ˜¯å“åº”å¼å¯¹è±¡ï¼Œç¡®ä¿åˆ é™¤å€¼èƒ½è§¦å‘ä¾èµ–ï¼Œæ›´æ–°è§†å›¾ã€‚å¦‚æœä¸æ˜¯å“åº”å¼å¯¹è±¡ï¼Œç›´æ¥åˆ é™¤å®ƒå³å¯ã€‚</p><p>è¿™ä¸ªæ–¹æ³•æ˜¯ä¸ºäº†é¿å¼€ Vue ä¸èƒ½æ£€æµ‹åˆ°å±æ€§è¢«åˆ é™¤çš„é™åˆ¶ï¼Œä½†æ˜¯ä½ åº”è¯¥å¾ˆå°‘ä¼šä½¿ç”¨å®ƒã€‚</p><p>ä¸‹é¢æŸ¥çœ‹<code>del</code>å‡½æ•°çš„ä»£ç ï¼Œå®ƒçš„ç»“æ„å’Œ<code>set</code>å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œä¸‹é¢ç»“åˆ<code>set</code>æ¥å¯¹æ¯”è®²è§£</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">del</span>(<span class="params">target: Array&lt;any&gt; | Object, key: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    (isUndef(target) || isPrimitive(target))</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Cannot delete reactive property on undefined, null, or primitive value: <span class="subst">$&#123;(target: any)&#125;</span>`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå’Œ<code>set</code>å‡½æ•°ä¸€æ ·ï¼Œåˆ¤æ–­<code>taregt</code>çš„ç±»å‹æ˜¯ä¸æ˜¯æœªå®šä¹‰çš„å€¼æˆ–è€…æ˜¯ä¸€ä¸ªåŸå§‹ç±»å‹çš„å€¼ï¼Œå¦‚æœæ»¡è¶³å…¶ä¸­ä¹‹ä¸€çš„è¯ä¼šæŠ¥é”™ï¼Œå¹¶æç¤ºä¸èƒ½åˆ é™¤<code>null</code>ã€<code>undefined</code>æˆ–è€…åŸå§‹ç±»å‹ä¸­çš„å“åº”å¼å±æ€§ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">  target.splice(key, <span class="number">1</span>) <span class="comment">// ! splice åˆ é™¤å…ƒç´ ï¼Œå¹¶è§¦å‘å“åº”</span></span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>taregt</code>çš„ç±»å‹æ˜¯ä¸æ˜¯æ•°ç»„ä¸”å®ƒçš„ç´¢å¼•æ˜¯å¦æœ‰æ•ˆçš„ï¼Œå¦‚æœéƒ½æ»¡è¶³æ¡ä»¶çš„è¯ï¼Œç›´æ¥è°ƒç”¨<code>splice</code>åˆ é™¤ç´¢å¼•<code>key</code>ä½ç½®çš„å€¼å³å¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ob = (target: any).__ob__</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! ä¸èƒ½åˆ é™¤ Vue å®ä¾‹ å’Œ æ ¹å®ä¾‹æ•°æ®å¯¹è±¡ï¼ˆæ ¹ data ä¸æ˜¯å“åº”å¼çš„ï¼‰çš„å±æ€§</span></span><br><span class="line"><span class="keyword">if</span> (target._isVue || (ob &amp;&amp; ob.vmCount)) &#123;</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Avoid deleting properties on a Vue instance or its root $data '</span> +</span><br><span class="line">        <span class="string">'- just set it to null.'</span></span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ<code>set</code>å‡½æ•°ä¸­é€»è¾‘çš„ä¸€æ ·ï¼Œå£°æ˜å¸¸é‡<code>ob</code>å­˜å‚¨<code>target</code>çš„<code>__ob__</code>å±æ€§ï¼Œåˆ¤æ–­<code>target</code>æ˜¯å¦æœ‰<code>_isVue</code>å±æ€§æˆ–è€…<code>ob.vmCount</code>çš„å€¼æ˜¯å¦å¤§äºé›¶ã€‚å¦‚æœåŒæ—¶æ»¡è¶³å…¶ä¸­çš„ä¸€ä¸ªæ¡ä»¶ä¸”åœ¨å¼€å‘ä¸­ä¼šæŠ¥é”™ï¼Œæç¤ºä¸èƒ½åˆ é™¤ Vue å®ä¾‹å¯¹è±¡çš„å±æ€§æˆ–è€…æ ¹ç»„ä»¶çš„<code>data</code>é€‰é¡¹çš„å€¼ï¼Œæœ€åç›´æ¥è¿”å›ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ²¡æœ‰è¦åˆ é™¤çš„å±æ€§</span></span><br><span class="line"><span class="keyword">if</span> (!hasOwn(target, key)) &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">delete</span> target[key] <span class="comment">// ! åˆ é™¤ç›®æ ‡çš„å­—æ®µ</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>target</code>å¯¹è±¡ä¸Šæ²¡æœ‰è¦åˆ é™¤çš„<code>key</code>å€¼ï¼Œç›´æ¥è¿”å›ã€‚å¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨<code>delete</code>è¿ç®—ç¬¦åˆ é™¤<code>target</code>ä¸­çš„<code>key</code>å­—æ®µæˆ–è€…ç´¢å¼•ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹æœ€åçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ç›®æ ‡ä¸æ˜¯å“åº”å¼ï¼Œä¸å¤„ç†</span></span><br><span class="line"><span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">ob.dep.notify() <span class="comment">// ! æ‰‹åŠ¨è§¦å‘ä¾èµ–</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>ob</code>ä¸å­˜åœ¨ï¼Œå³<code>taregt</code>ä¸æ˜¯å“åº”å¼å¯¹è±¡ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œä¸åšå¤„ç†ã€‚å¦‚æœæ˜¯å“åº”å¼å¯¹è±¡ï¼Œæ‰‹åŠ¨è§¦å‘ä¾èµ–ï¼Œæ›´æ–°è§†å›¾ã€‚</p><p>æ³¨æ„<code>del</code>ä¸éœ€è¦è¿”å›å€¼ï¼Œä¹Ÿä¸éœ€è¦è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼æ¥è¡¨ç¤ºåˆ é™¤å±æ€§æ˜¯å¦æˆåŠŸï¼Œè¿™ä¹Ÿä»ä¾§é¢è¯´æ˜è¿™ä¸ªå‡½æ•°å…³è”çš„<code>Vue.delete</code>å’Œ<code>vm.$delete</code> çš„ API ä½¿ç”¨çš„åœºæ™¯éå¸¸å°‘ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;set-å‡½æ•°&quot;&gt;&lt;a href=&quot;#set-å‡½æ•°&quot; class=&quot;headerlink&quot; title=&quot;set å‡½æ•°&quot;&gt;&lt;/a&gt;&lt;code&gt;set&lt;/code&gt; å‡½æ•°&lt;/h2&gt;&lt;p&gt;ä¸‹é¢çœ‹ä¸‹&lt;code&gt;set&lt;/code&gt;å‡½æ•°ï¼Œæˆ‘ä»¬åœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡æ—¶åˆ›å»º&lt;code&gt;Vue.prototype.$set&lt;/code&gt;æ–¹æ³•ï¼Œç„¶ååœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°çš„é™æ€æ–¹æ³•æ—¶åˆ›å»º&lt;code&gt;Vue.set&lt;/code&gt;æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ‰€èµ‹å€¼çš„å‡½æ•°éƒ½æ˜¯&lt;code&gt;set&lt;/code&gt;å‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Vue çš„å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæä¾›äº†è¿™ä¸¤ä¸ª API ä¾›ç”¨æˆ·ä½¿ç”¨ï¼Œç”¨æ¥å‘å“åº”å¼å¯¹è±¡ä¸­æ·»åŠ ä¸€ä¸ªå±æ€§ï¼Œå¹¶ç¡®ä¿è¿™ä¸ªæ–°å±æ€§åŒæ ·æ˜¯å“åº”å¼çš„ï¼Œä¸”è§¦å‘è§†å›¾æ›´æ–°ã€‚å®ƒå¿…é¡»ç”¨äºå“åº”å¼å¯¹è±¡ä¸Šæ·»åŠ æ–°å±æ€§ï¼Œå› ä¸º Vue æ— æ³•æ¢æµ‹æ™®é€šçš„æ–°å¢å±æ€§ã€‚å¦å¤–ï¼Œæ³¨æ„è®¾ç½®çš„å¯¹è±¡ä¸èƒ½æ˜¯ Vue å®ä¾‹æˆ–è€… Vue å®ä¾‹çš„æ ¹æ•°æ®å¯¹è±¡ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹æ•°ç»„çš„å“åº”æ€§</title>
    <link href="https://haledeng.com/blog/20190915-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%95%B0%E7%BB%84%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F/"/>
    <id>https://haledeng.com/blog/20190915-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E6%95%B0%E7%BB%84%E7%9A%84%E5%93%8D%E5%BA%94%E5%BC%8F/</id>
    <published>2019-09-15T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:52.260Z</updated>
    
    <content type="html"><![CDATA[<p>è®²è§£å®Œå¯¹è±¡çš„å“åº”å¼å®šä¹‰åï¼Œå†çœ‹ä¸‹æ•°ç»„çš„å“åº”å¼å®šä¹‰ï¼Œå›åˆ°<code>Observer</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">  <span class="comment">// ! åˆ¤æ–­å½“å‰ç¯å¢ƒçš„å¯¹è±¡ä¸­æ˜¯å¦æœ‰ __proto__ å±æ€§ ï¼ˆæ˜¯å¦æ”¯æŒä½¿ç”¨ __proto__ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">    protoAugment(value, arrayMethods)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.observeArray(value) <span class="comment">// ! å†æ¬¡ç›‘å¬æ•°ç»„ï¼Œç›‘å¬ä¸€äº›åµŒå¥—çš„æ•°ç»„</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>if</code>ä»£ç å—ä¸­å®šä¹‰äº†æ•°ç»„å“åº”å¼ï¼Œé¦–å…ˆåˆ¤æ–­å®¿ä¸»ç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨<code>__proto__</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯¹è±¡çš„éšå¼åŸå‹å¯¹è±¡ï¼Œåªæœ‰åœ¨ IE 11 ä»¥ä¸Šçš„æµè§ˆå™¨æ‰ä¼šæ”¯æŒã€‚</p><p>å¦‚æœå®¿ä¸»ç¯å¢ƒæ”¯æŒ<code>__proto__</code>ï¼Œè°ƒç”¨<code>protoAugment</code>å‡½æ•°å¹¶ä¼ å…¥æ•°ç»„ç±»å‹çš„<code>value</code>å’Œ<code>arrayMethods</code>è¿™ä¸¤ä¸ªå€¼ä½œä¸ºå‚æ•°ã€‚</p><a id="more"></a><h2 id="arrayMethods"><a href="#arrayMethods" class="headerlink" title="arrayMethods"></a><code>arrayMethods</code></h2><p>å…ˆä¸æ€¥ç€çœ‹<code>protoAugment</code>å‡½æ•°ï¼Œå…ˆçœ‹ä¸‹ç¬¬äºŒä¸ªå‚æ•°<code>arrayMethods</code>æ˜¯ä»€ä¹ˆï¼Œåœ¨<code>core/observer/array.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype <span class="comment">// ! æ•°ç»„åŸå‹</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto) <span class="comment">// ! é€šè¿‡æ•°ç»„åŸå‹åˆ›å»ºçš„å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p><code>arrayMethods</code>æ˜¯æ ¹æ®æ•°ç»„çš„åŸå‹å¯¹è±¡åˆ›å»ºä¼ æ¥çš„å¯¹è±¡ã€‚ä½†æ˜¯è¿˜æ²¡å®Œï¼Ÿç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> methodsToPatch = [</span><br><span class="line">  <span class="string">'push'</span>,</span><br><span class="line">  <span class="string">'pop'</span>,</span><br><span class="line">  <span class="string">'shift'</span>,</span><br><span class="line">  <span class="string">'unshift'</span>,</span><br><span class="line">  <span class="string">'splice'</span>,</span><br><span class="line">  <span class="string">'sort'</span>,</span><br><span class="line">  <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">methodsToPatch.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// cache original method</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method] <span class="comment">// ! åŸç”Ÿæ–¹æ³•</span></span><br><span class="line">  def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args) <span class="comment">// ! åŸç”Ÿæ–¹æ³•è°ƒç”¨ç”Ÿæˆçš„å€¼ï¼Œä¹Ÿæ˜¯è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">    <span class="keyword">let</span> inserted <span class="comment">// ! æ•°ç»„æ–°å¢çš„å€¼, æ•°ç»„ç±»å‹</span></span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">        inserted = args</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>) <span class="comment">// ! è·å–ä¼ å…¥å‚æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä»¥åçš„å€¼æ‰€æœ‰å€¼ï¼Œå³æ–°å¢çš„å€¼</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.observeArray(inserted) <span class="comment">// ! ç›‘å¬æ–°å¢çš„å€¼ï¼Œä½¿å…¶æˆä¸ºå“åº”å¼</span></span><br><span class="line">    <span class="comment">// notify change</span></span><br><span class="line">    ob.dep.notify() <span class="comment">// ! æ‰‹åŠ¨è§¦å‘ä¾èµ–é€šçŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>methodsToPatch</code>æ˜¯ä¸€äº›æ•°ç»„å¸¸ç”¨æ–¹æ³•åï¼ˆå­—ç¬¦ä¸²ç±»å‹ï¼‰ç»„æˆçš„æ•°ç»„ï¼Œé€šè¿‡è¿™äº›æ–¹æ³•å¯ä»¥æ“ä½œæ•°ç»„ä¸­å…ƒç´ çš„å¢åŠ ã€åˆ é™¤æˆ–è€…ç§»ä½ã€‚</p><p>å†çœ‹ä¸‹é¢çš„ä»£ç ï¼Œéå†<code>methodsToPatch</code>ï¼Œç„¶åé‡å†™<code>arrayMethods</code>å¯¹è±¡ä¸­çš„æŸäº›æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å°±æ˜¯åœ¨<code>methodsToPatch</code>é‡Œé¢çš„æ–¹æ³•ã€‚</p><p>å…ˆçœ‹éå†å‡½æ•°ä¸­çš„ç¬¬ä¸€è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> original = arrayProto[method] <span class="comment">// ! åŸç”Ÿæ–¹æ³•</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å¸¸é‡<code>original</code>å­˜å‚¨æ•°ç»„åŸå‹çš„åŸç”Ÿæ–¹æ³•ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥è°ƒç”¨<code>def</code>å‡½æ•°é‡å†™<code>arrayMethods</code>å¯¹è±¡ä¸­çš„æ–¹æ³•ã€‚</p><p>çœ‹ä¸‹<code>def</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>val</code>ï¼Œå®ƒç°åœ¨æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œçœ‹è¿™ä¸ªå‡½æ•°ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args) <span class="comment">// ! è°ƒç”¨åŸç”Ÿæ–¹æ³•ç”Ÿæˆå€¼ï¼Œä¹Ÿæ˜¯è¿”å›å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> result</span><br></pre></td></tr></table></figure><p>ä¼ å…¥å‚æ•°å¹¶ä½¿ç”¨åŸç”Ÿæ–¹æ³•ç”Ÿæˆå€¼ï¼Œç„¶ååœ¨æœ€åè¿”å›è¿™ä¸ªå€¼ï¼Œè¿™æ ·å°±ç›¸å½“äºç»§æ‰¿äº†åŸç”Ÿæ–¹æ³•ã€‚</p><p>ç„¶ååœ¨ä¸­é—´å¤„ç†äº†ä¸€äº›äº‹æƒ…ï¼Œç°åœ¨çœ‹ä¸­é—´çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__ <span class="comment">// ! this æŒ‡å‘æ•°ç»„æœ¬èº«</span></span><br><span class="line"><span class="keyword">let</span> inserted <span class="comment">// ! æ•°ç»„æ–°å¢çš„å€¼, æ•°ç»„ç±»å‹</span></span><br><span class="line"><span class="keyword">switch</span> (method) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">    inserted = args</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">    inserted = args.slice(<span class="number">2</span>) <span class="comment">// ! è·å–ä¼ å…¥å‚æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä»¥åçš„å€¼æ‰€æœ‰å€¼ï¼Œå³æ–°å¢çš„å€¼</span></span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (inserted) ob.observeArray(inserted) <span class="comment">// ! ç›‘å¬æ–°å¢çš„å€¼ï¼Œä½¿å…¶æˆä¸ºå“åº”å¼</span></span><br><span class="line"><span class="comment">// notify change</span></span><br><span class="line">ob.dep.notify() <span class="comment">// ! æ‰‹åŠ¨è§¦å‘ä¾èµ–é€šçŸ¥</span></span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å¸¸é‡<code>ob</code>å­˜å‚¨<code>this.__ob__</code>çš„å€¼ï¼Œ<code>this</code>æŒ‡å‘æ•°ç»„æœ¬èº«ã€‚æˆ‘ä»¬éƒ½çŸ¥é“åœ¨åˆå§‹åŒ–<code>data</code>é€‰é¡¹æ—¶ï¼Œä¼šä½¿ç”¨<code>observe</code>å‡½æ•°ç›‘å¬<code>data</code>é€‰é¡¹ï¼Œç„¶ååœ¨<code>data</code>é‡Œé¢æ·»åŠ ä¸€ä¸ª<code>__ob__</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§å­˜å‚¨äº†<code>Observer</code>å®ä¾‹æœ¬èº«ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå£°æ˜äº†ä¸€ä¸ª<code>inserted</code>å˜é‡ï¼Œè¿™ä¸ªå˜é‡å­˜å‚¨ç€æ•°ç»„æ–°å¢çš„å€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚</p><p>å†ä½¿ç”¨<code>switch</code>å‡½æ•°åŒ¹é…ä¸åŒæ–¹æ³•å¢åŠ çš„å€¼ï¼Œæ¯”å¦‚<code>push</code>å’Œ<code>unshift</code>å¢åŠ çš„å€¼ï¼Œå°±æ˜¯ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå‚æ•°ï¼Œè¿™æ—¶ç›´æ¥èµ‹å€¼ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr = []</span><br><span class="line">arr.push(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line">arr.unshift(<span class="number">5</span>)</span><br><span class="line"><span class="built_in">console</span>.log(arr) <span class="comment">// [ 5, 1, 2 ]</span></span><br><span class="line"></span><br><span class="line">arr.splice(<span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line"><span class="built_in">console</span>.log(arr) <span class="comment">// [ 5, 4, 5, 6, 1, 2 ]</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯<code>splice</code>æ–¹æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•æ–°å¢çš„å€¼æ˜¯ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹çš„ã€‚æ‰€ä»¥ä½¿ç”¨<code>slice</code>æ–¹æ³•ä»ç¬¬ä¸‰ä¸ªå‚æ•°å¼€å§‹æˆªå–å‚æ•°æ•°ç»„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inserted = args.slice(<span class="number">2</span>) <span class="comment">// ! è·å–ä¼ å…¥å‚æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ä»¥åçš„æ‰€æœ‰å€¼ï¼Œå³æ–°å¢çš„å€¼</span></span><br></pre></td></tr></table></figure><p>æ‰€ä»¥<code>inserted</code>è®¾ç½®æˆä¸€ä¸ªæ•°ç»„æ˜¯æ¯”è¾ƒåˆç†çš„ï¼Œå› ä¸ºæ•°ç»„å¢åŠ å…ƒç´ æ—¶ï¼Œæœ‰å¯èƒ½ä¸€ä¸‹å­å¢åŠ å¥½å‡ ä¸ªå…ƒç´ ã€‚</p><p>æ–°å¢å…ƒç´ åï¼Œè¿˜éœ€è¦æŠŠå¢åŠ çš„å…ƒç´ å˜æˆå“åº”å¼æ•°æ®ï¼Œå› ä¸ºå¢åŠ å…ƒç´ çš„æ˜¯æ•°ç»„ï¼Œä¸èƒ½è‡ªåŠ¨ä½¿ç”¨<code>Object.defineProperty</code>å®šä¹‰å…ƒç´ ï¼Œéœ€è¦ä½¿ç”¨<code>observeArray</code>æ–¹æ³•æŠŠå®ƒä»¬å˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inserted) ob.observeArray(inserted) <span class="comment">// ! ç›‘å¬æ–°å¢çš„å€¼ï¼Œä½¿å…¶æˆä¸ºå“åº”å¼</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>ob</code>ä¸­çš„<code>observeArray</code>æŠŠä»–ä»¬å˜æˆå“åº”å¼çš„ã€‚<code>ob</code>æ˜¯<code>Observer</code>çš„å®ä¾‹å¯¹è±¡ï¼Œåœ¨å‰é¢æˆ‘ä»¬çŸ¥é“ç±»<code>Observer</code>æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå‰é¢å·²ç»è®²è§£äº†<code>walk</code>æ–¹æ³•ï¼Œç°åœ¨è®²è§£å¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯åˆšæ‰è°ƒç”¨çš„``observeArray`æ–¹æ³•ï¼Œä¸‹é¢çœ‹è¿™ä¸ªæ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">observeArray(items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">    observe(items[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯éå†ä¼ å…¥çš„æ•°ç»„ï¼Œç„¶åé€šè¿‡<code>observe</code>å‡½æ•°ç›‘å¬æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œä½¿å®ƒä»¬éƒ½æˆä¸ºå“åº”å¼æ•°æ®ã€‚</p><p>å½“ç„¶ï¼Œæœ€åè¿˜éœ€è¦æ‰‹åŠ¨è§¦å‘ä¾èµ–ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob.dep.notify() <span class="comment">// ! æ‰‹åŠ¨é€šçŸ¥ï¼Œè§¦å‘ä¾èµ–</span></span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„</strong>è¿™é‡Œä¸åªæ˜¯æ–°å¢åŠ å€¼éœ€è¦æ‰‹åŠ¨è§¦å‘ä¾èµ–ï¼Œå…¶ä»–çš„æ“ä½œæ¯”å¦‚åˆ é™¤å…ƒç´ ã€ç§»åŠ¨å…ƒç´ ä¹Ÿæ˜¯éœ€è¦æ‰‹åŠ¨è§¦å‘ä¾èµ–çš„ã€‚å› ä¸ºæ•°ç»„ç±»å‹çš„æ•°æ®æ²¡æ³•ä½¿ç”¨<code>Object.defineProperty</code>è¿™ä¸ª API æ¥ç›‘å¬æ•°æ®çš„å˜åŒ–ï¼Œè‡ªåŠ¨è§¦å‘ä¾èµ–ã€‚</p><h2 id="protoAugment"><a href="#protoAugment" class="headerlink" title="protoAugment"></a><code>protoAugment</code></h2><p>ç»§ç»­å›åˆ°ç±»<code>Observer</code>çš„æ„é€ å‡½æ•°ä¸­ï¼Œå¦‚æœå®¿ä¸»ç¯å¢ƒæ”¯æŒ<code>__proto__</code>æ—¶ï¼Œè°ƒç”¨<code>protoAugment</code>æ–¹æ³•å¹¶æŠŠ``value<code>å’Œ</code>arrayMethods`ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">  protoAugment(value, arrayMethods)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">this</span>.observeArray(value) <span class="comment">// ! å†æ¬¡ç›‘å¬æ•°ç»„ï¼Œç›‘å¬ä¸€äº›åµŒå¥—çš„æ•°ç»„</span></span><br></pre></td></tr></table></figure><p>äº†è§£ç¬¬äºŒä¸ªå‚æ•°<code>arrayMethods</code>å¯¹è±¡åï¼Œç°åœ¨å¯ä»¥å‚çœ‹<code>protoAugment</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">protoAugment</span>(<span class="params">target, src: Object</span>) </span>&#123;</span><br><span class="line">  <span class="comment">/* eslint-disable no-proto */</span></span><br><span class="line">  target.__proto__ = src</span><br><span class="line">  <span class="comment">/* eslint-enable no-proto */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•æ¥æ”¶ä¸¤ä¸ªå‚æ•°<code>target</code>å’Œ<code>src</code>ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä¼ å…¥çš„<code>value</code>å’Œ<code>arrayMethods</code>ï¼Œç„¶åç”¨<code>__proto__</code>æŠŠå®ƒä»¬è¿æ¥èµ·æ¥ã€‚</p><p>ä½¿ç”¨<code>protoAugment</code>å‡½æ•°æŠŠ<code>value</code>å’Œ<code>arrayMethods</code>é€šè¿‡åŸå‹è¿æ¥èµ·æ¥ï¼Œè¿™æ ·æ•°ç»„ç±»å‹çš„ç›‘å¬å¯¹è±¡<code>value</code>ä¹Ÿç»§æ‰¿äº†<code>arrayMethods</code>å¯¹è±¡çš„å˜å¼‚æ–¹æ³•ï¼ˆé‡å†™çš„æ–¹æ³•ï¼‰ï¼Œåœ¨æ•°ç»„å¢åŠ å…ƒç´ çš„æ—¶å€™ä¹Ÿå¯ä»¥ä½¿å¢åŠ çš„å…ƒç´ å˜æˆå“åº”å¼æ•°æ®ï¼Œè¿˜èƒ½è§¦å‘<code>value</code>ä¸­ä¾èµ–çš„æ›´æ–°ã€‚</p><h2 id="copyAugment"><a href="#copyAugment" class="headerlink" title="copyAugment"></a><code>copyAugment</code></h2><p>æ¥ä¸‹æ¥çœ‹ä¸‹åœ¨ä¸æ”¯æŒ<code>__proto__</code>çš„å®¿ä¸»ç¯å¢ƒä¸­ï¼Œæ˜¯å¦‚ä½•å¤„ç†æ•°ç»„ç±»å‹çš„æ•°æ®ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copyAugment(value, arrayMethods, arrayKeys)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†<code>copyAugment</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¯”<code>protoAugment</code>å¤šä¼ å…¥äº†ä¸€ä¸ªå‚æ•°ï¼Œç°åœ¨çœ‹ä¸‹å¤šå‡ºæ¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°<code>arrayKeys</code>æ˜¯ä»€ä¹ˆæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayKeys = <span class="built_in">Object</span>.getOwnPropertyNames(arrayMethods)</span><br></pre></td></tr></table></figure><p>åŸæ¥æ˜¯è·å–<code>arrayMethods</code>å¯¹è±¡ä¸­æ‰€æœ‰å±äºè‡ªèº«çš„å±æ€§åï¼Œå³<code>key</code>å€¼ï¼ˆä¸æ˜¯åŸå‹é“¾ä¸Šçš„æ–¹æ³•ï¼‰ã€‚</p><p>å®ƒåº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayMethods = [</span><br><span class="line">  <span class="string">'push'</span>,</span><br><span class="line">  <span class="string">'pop'</span>,</span><br><span class="line">  <span class="string">'shift'</span>,</span><br><span class="line">  <span class="string">'unshift'</span>,</span><br><span class="line">  <span class="string">'splice'</span>,</span><br><span class="line">  <span class="string">'sort'</span>,</span><br><span class="line">  <span class="string">'reverse'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ç°åœ¨çœ‹ä¸‹<code>copyAugment</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copyAugment</span>(<span class="params">target: Object, src: Object, keys: Array&lt;string&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    def(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä¸èƒ½ä½¿ç”¨éšå¼åŸå‹å¯¹è±¡<code>__proto__</code>è¿æ¥<code>target</code>å’Œ<code>src</code>ã€‚</p><p>è¿™é‡Œé‡å®šä¹‰çš„æ–¹æ³•ï¼Œéå†<code>keyskeys</code>ï¼Œåœ¨æ¯æ¬¡å¾ªç¯æ—¶ï¼Œè·å–åˆ°<code>key</code>å€¼ï¼Œå°±æ˜¯é‚£äº›å¸¸ç”¨çš„æ•°ç»„æ–¹æ³•ã€‚ç„¶åä½¿ç”¨<code>def</code>å‡½æ•°é‡å†™<code>target</code>ä¸­çš„è¿™äº›æ–¹æ³•ï¼Œè®©å®ƒä»¬å˜æˆ<code>src</code>å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¼ å…¥çš„<code>arrayMethods</code>å¯¹è±¡çš„å˜å¼‚æ–¹æ³•ã€‚</p><p>è¿™æ ·å°±å’Œä¸Šé¢çš„åŸå‹ç»§æ‰¿è¾¾åˆ°ç›¸åŒçš„ç›®çš„ï¼Œå³æ•°ç»„ç±»å‹çš„æ•°æ®åœ¨ä¿®æ”¹æ•°æ®æ—¶ï¼Œä¹Ÿèƒ½è§¦å‘ä¾èµ–ï¼Œç„¶åæ•°æ®æ›´æ–°ï¼Œå¹¶ä¸”ä¼šæŠŠæ•°ç»„ä¸­æ–°å¢çš„å…ƒç´ å˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>æ¥ä¸‹æ¥çœ‹æœ€åä¸€è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.observeArray(value) <span class="comment">// ! å†æ¬¡ç›‘å¬æ•°ç»„ï¼Œç›‘å¬ä¸€äº›åµŒå¥—çš„æ•°ç»„</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>observeArray</code>æ–¹æ³•ç›‘å¬<code>value</code>å€¼ï¼Œä¸»è¦æ˜¯é˜²æ­¢æ•°ç»„ç±»å‹æ•°æ®é‡Œé¢è¿˜å­˜åœ¨ç€æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯åµŒå¥—æ•°ç»„ï¼ŒæŠŠåµŒå¥—æ•°ç»„é‡Œé¢çš„å…ƒç´ ä¹Ÿå˜æˆå“åº”å¼æ•°æ®ã€‚</p><h2 id="dependArray"><a href="#dependArray" class="headerlink" title="dependArray"></a><code>dependArray</code></h2><p>æŠŠæ•°ç»„ç±»å‹çš„æ•°æ®å˜æˆå“åº”å¼æ•°æ®è¿‡ç¨‹æˆ‘ä»¬å·²ç»äº†è§£äº†ï¼Œç°åœ¨çœ‹ä¸‹æ•°ç»„ç±»å‹çš„æ•°æ®æ˜¯æ€ä¹ˆæ”¶é›†ä¾èµ–çš„ã€‚</p><p>åœ¨<code>defineReactive</code>å‡½æ•°å®šä¹‰<code>getter</code>çš„æ—¶å€™ï¼Œæœ‰ä»¥ä¸‹ä»£ç ï¼Œåœ¨<code>core/observer/index.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">  dep.depend() <span class="comment">// ! æ·»åŠ è¿›è®¢é˜…å™¨ï¼Œä¾èµ–æ”¶é›†</span></span><br><span class="line">  <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">    childOb.dep.depend() <span class="comment">// ! ä¾èµ–æ”¶é›†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      dependArray(value) <span class="comment">// ! æ•°ç»„æ‰‹åŠ¨æ”¶é›†ä¾èµ–</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ä¸‹<code>value</code>çš„å€¼æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œè°ƒç”¨<code>dependArray</code>å‡½æ•°æ”¶é›†ä¾èµ–ã€‚</p><p>å…ˆçœ‹ä¸‹<code>dependArray</code>å‡½æ•°çš„ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dependArray</span>(<span class="params">value: Array&lt;any&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> e, i = <span class="number">0</span>, l = value.length; i &lt; l; i++) &#123;</span><br><span class="line">    e = value[i]</span><br><span class="line">    e &amp;&amp; e.__ob__ &amp;&amp; e.__ob__.dep.depend() <span class="comment">// ! ä¾èµ–æ”¶é›†</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">      dependArray(e) <span class="comment">// ï¼é€’å½’è°ƒç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„é€»è¾‘å¾ˆç®€å•ï¼Œéå†æ•°ç»„çš„å€¼ï¼Œç„¶åè°ƒç”¨å®ƒçš„<code>ob</code>è¿›è¡Œä¾èµ–æ”¶é›†ï¼Œå¦‚æœè¿™ä¸ªå€¼è¿˜æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé€’å½’è°ƒç”¨è¿™ä¸ªå‡½æ•°ã€‚</p><p>å› ä¸ºæ•°ç»„çš„ç»“æ„å’Œå¯¹è±¡ä¸åŒï¼Œ<strong><code>Object.defineProperty</code>è¿™ä¸ªå±æ€§æœ‰å±€é™æ€§ï¼Œå®ƒåªèƒ½å®šä¹‰å¯¹è±¡<code>key</code>çš„å€¼ï¼Œè€Œæ— æ³•å®šä¹‰æ•°ç»„ç´¢å¼•çš„å€¼</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æ— æ³•ç»™æ•°ç»„é‡Œé¢çš„å…ƒç´ æ·»åŠ <code>getter</code>å±æ€§ã€‚å½“è¯»å–æ•°ç»„ä¸­çš„å€¼æ—¶ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘<code>getter</code>å‡½æ•°è‡ªåŠ¨å–æ”¶é›†ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦<strong>æ‰‹åŠ¨æ”¶é›†ä¾èµ–</strong>ã€‚</p><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>é¦–å…ˆè™½ç„¶æˆ‘ä»¬å¯ä»¥ç»™æ•°ç»„ä¸­æ·»åŠ <code>__ob__</code>å±æ€§ï¼Œä¸èƒ½ä½¿ç”¨<code>Object.defineProperty</code>æ¥å®šä¹‰æ•°ç»„ä¸­æ˜¯ç´¢å¼•å€¼ï¼Œå› ä¸º<code>Object.defineProperty</code>çš„<strong>å±€é™æ€§</strong>ï¼Œå®ƒåªæ”¯æŒå¯¹è±¡è€Œä¸æ”¯æŒæ•°ç»„ã€‚Vue 3.0 ä¸­ä½¿ç”¨<code>Proxy</code>å°±ä¸ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´æ•°ç»„é‡Œé¢çš„å…ƒç´ ï¼Œæ²¡æœ‰å±æ€§æè¿°ç¬¦ï¼Œä¹Ÿæ²¡æœ‰<code>getter</code>å’Œ<code>setter</code>ï¼Œå³ä¸èƒ½è‡ªåŠ¨æ”¶é›†ä¾èµ–å’Œè§¦å‘ä¾èµ–ã€‚æ—¢ç„¶ä¸èƒ½è‡ªåŠ¨ï¼Œé‚£å°±æ‰‹åŠ¨å‘—ã€‚</p><p>åœ¨<code>gettter</code>ä¸­ï¼Œä½¿ç”¨<code>dependArray</code>å‡½æ•°æ‰‹åŠ¨æ”¶é›†æ•°ç»„çš„ä¾èµ–ã€‚</p><p>ç„¶åæŠŠæ•°ç»„ç±»å‹çš„å±æ€§é€šè¿‡åŸå‹é“¾è¿æ¥<code>arrayMethods</code>æ¥ç»§æ‰¿<code>arrayMethods</code>é‡å†™çš„ä¸€äº›å˜å¼‚æ–¹æ³•ï¼›æˆ–è€…é€šè¿‡é‡æ–°å®šä¹‰çš„æ–¹æ³•ï¼ŒæŠŠæ•°ç»„ç±»å‹çš„å±æ€§ä¸€äº›æ–¹æ³•æ›¿æ¢æˆ<code>arrayMethods</code>çš„å˜å¼‚æ–¹æ³•ã€‚</p><p>è¿™æ ·æ•°ç»„ä½¿ç”¨è¿™äº›æ–¹æ³•æ—¶ï¼Œå°±ä¼šæ‰§è¡Œå˜å¼‚æ–¹æ³•ä¸­æˆ‘ä»¬è®¾ç½®çš„é€»è¾‘ï¼Œè¿™ç›¸å½“äºå¯¹è±¡ç±»å‹çš„<code>key</code>è§¦å‘<code>setter</code>ä¸€æ ·ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ ä¹Ÿèƒ½è§¦å‘ä¾èµ–ï¼Œæ›´æ–°è§†å›¾ï¼Œç„¶åå¯¹äºæ•°ç»„æ–°å¢çš„å…ƒç´ ï¼Œä¹Ÿä¼šæŠŠå®ƒä»¬å˜æˆå“åº”å¼æ•°æ®ã€‚</p><h2 id="vmCount"><a href="#vmCount" class="headerlink" title="vmCount"></a><code>vmCount</code></h2><p>åˆ°è¿™æ ·å·²ç»å®Œå…¨è®²è§£äº†<code>Observer</code>æ„é€ å‡½æ•°ï¼Œç„¶åæˆ‘ä»¬å†æ¬¡å›åˆ°<code>observer</code>å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è¿˜å‰©ä¸‹æœ€åä¸€ç‚¹ä»£ç ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å¯¹è±¡æ˜¯æ ¹å®ä¾‹æ•°æ®å¯¹è±¡æ—¶ï¼Œ vmCount++</span></span><br><span class="line"><span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">  ob.vmCount++</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ob</span><br></pre></td></tr></table></figure><p>è¿˜è®°å¾—<code>initData</code>åœ¨åˆå§‹åŒ–<code>data</code>é€‰é¡¹æ—¶çš„æœ€åä¸€è¡Œä»£ç å˜›</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// observe data</span></span><br><span class="line">observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>) <span class="comment">// ! æŠŠ data ä¸Šçš„å±æ€§å˜æˆå“åº”å¼çš„</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>observe</code>å‡½æ•°æ—¶ä¼ å…¥äº†ç¬¬äºŒä¸ªå‚æ•°<code>asRootData</code>ï¼Œå®ƒçš„å€¼ä¸º<code>true</code>ï¼Œè¯´æ˜æœ€å¼€å§‹åˆå§‹åŒ–çš„<code>data</code>æ˜¯æ ¹ç»„ä»¶çš„æ•°æ®ã€‚</p><p>ç„¶åæˆ‘ä»¬å‘ç°åœ¨åé¢ç›‘å¬æ•°æ®æ—¶ï¼Œä¸€èˆ¬éƒ½ä¸ä¼šä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ï¼Œå®ƒçš„å€¼å°±æ˜¯é»˜è®¤å€¼<code>undefined</code>ï¼Œè½¬æ¢æˆå¸ƒå°”å€¼å°±æ˜¯<code>false</code>ï¼Œè¯´æ˜ç›‘å¬çš„æ•°æ®ä¸æ˜¯æ ¹ç»„ä»¶æ•°æ®ã€‚</p><p>å›åˆ°ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (asRootData &amp;&amp; ob) &#123;</span><br><span class="line">  ob.vmCount++</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ob</span><br></pre></td></tr></table></figure><p>åªæœ‰åœ¨æ ¹ç»„ä»¶ä¸”ç›‘å¬æ ¹ç»„ä»¶æ•°æ®æ—¶ï¼Œ<code>ob.vmCount</code>çš„å€¼æ˜¯é€’å¢çš„ï¼Œè€Œ<code>ob.vmCount</code>åœ¨ç±»<code>Observer</code>çš„æ„é€ å‡½æ•°ä¸­å£°æ˜çš„åˆå§‹å€¼æ˜¯<code>0</code>ï¼Œæ‰€ä»¥æ ¹ç»„ä»¶çš„æ•°æ®<code>ob.vmCount</code>çš„å€¼æ°¸è¿œæ˜¯å¤§äº<code>0</code>çš„ï¼Œ<code>observe</code>å‡½æ•°æœ€åè¿”å›<code>ob</code>å®ä¾‹ã€‚</p><p>é‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ç†è§£ï¼Œåªè¦æ˜¯æ ¹ç»„ä»¶æ•°æ®ï¼Œé‚£ä¹ˆå®ƒçš„<code>__ob__</code>ä¸­çš„<code>vmCount</code>å°±å¤§äº<code>0</code>ã€‚è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥é€šè¿‡åˆ¤æ–­<code>ob.vmCount</code>çš„å€¼æ˜¯å¦å¤§äº<code>0</code>æ¥ç¡®å®šç»„ä»¶æ˜¯ä¸æ˜¯æ ¹ç»„ä»¶ï¼Œæˆ–è€…ç›‘å¬çš„æ•°æ®æ˜¯ä¸æ˜¯æ ¹ç»„ä»¶æ•°æ®äº†ã€‚</p><p><strong>ä¸ºä»€ä¹ˆè¦ä¸“é—¨åŒºåˆ†æ ¹ç»„ä»¶æ•°æ®å’Œéæ ¹ç»„ä»¶æ•°æ®å‘¢</strong>ï¼Ÿå®ƒä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ</p><p>å› ä¸ºä¸€å¼€å§‹åœ¨åˆå§‹åŒ–æ ¹æ•°æ®ä¹‹å‰ï¼Œæ ¹æ•°æ®<code>data</code>æ˜¯éå“åº”å¼çš„ï¼Œè¿™æ—¶å€™å¦‚æœä½¿ç”¨<code>Vue.set</code>æˆ–è€…<code>vm.$set</code>ä¸º<code>data</code>é€‰é¡¹é‡Œé¢çš„å¯¹è±¡æ·»åŠ å€¼æ˜¯ä¸å¯èƒ½æˆåŠŸçš„ï¼Œå› ä¸º<code>Vue.set</code>æˆ–è€…<code>vm.$set</code>åªèƒ½ä¸ºå“åº”å¼å¯¹è±¡æ·»åŠ å±æ€§ã€‚</p><p>åªæœ‰å½“<code>data</code>æ•°æ®è¢«è§‚å¯Ÿè€…ä¾èµ–æ—¶ï¼Œæ‰èƒ½æ”¶é›†ä¾èµ–åˆ°è®¢é˜…å™¨ä¸­ï¼Œè¿™æ ·ä¹‹åæ‰èƒ½ä½¿ç”¨<code>Vue.set</code>æˆ–è€…<code>vm.$set</code>ä¸º<code>data</code>æ·»åŠ å±æ€§ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è®²è§£å®Œå¯¹è±¡çš„å“åº”å¼å®šä¹‰åï¼Œå†çœ‹ä¸‹æ•°ç»„çš„å“åº”å¼å®šä¹‰ï¼Œå›åˆ°&lt;code&gt;Observer&lt;/code&gt;çš„æ„é€ å‡½æ•°ä¸­ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ã€‚&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;built_in&quot;&gt;Array&lt;/span&gt;.isArray(value)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ! åˆ¤æ–­å½“å‰ç¯å¢ƒçš„å¯¹è±¡ä¸­æ˜¯å¦æœ‰ __proto__ å±æ€§ ï¼ˆæ˜¯å¦æ”¯æŒä½¿ç”¨ __proto__ï¼‰&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (hasProto) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    protoAugment(value, arrayMethods)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    copyAugment(value, arrayMethods, arrayKeys)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.observeArray(value) &lt;span class=&quot;comment&quot;&gt;// ! å†æ¬¡ç›‘å¬æ•°ç»„ï¼Œç›‘å¬ä¸€äº›åµŒå¥—çš„æ•°ç»„&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;&lt;code&gt;if&lt;/code&gt;ä»£ç å—ä¸­å®šä¹‰äº†æ•°ç»„å“åº”å¼ï¼Œé¦–å…ˆåˆ¤æ–­å®¿ä¸»ç¯å¢ƒä¸­æ˜¯å¦å­˜åœ¨&lt;code&gt;__proto__&lt;/code&gt;å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯å¯¹è±¡çš„éšå¼åŸå‹å¯¹è±¡ï¼Œåªæœ‰åœ¨ IE 11 ä»¥ä¸Šçš„æµè§ˆå™¨æ‰ä¼šæ”¯æŒã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœå®¿ä¸»ç¯å¢ƒæ”¯æŒ&lt;code&gt;__proto__&lt;/code&gt;ï¼Œè°ƒç”¨&lt;code&gt;protoAugment&lt;/code&gt;å‡½æ•°å¹¶ä¼ å…¥æ•°ç»„ç±»å‹çš„&lt;code&gt;value&lt;/code&gt;å’Œ&lt;code&gt;arrayMethods&lt;/code&gt;è¿™ä¸¤ä¸ªå€¼ä½œä¸ºå‚æ•°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹å“åº”å¼å®šä¹‰</title>
    <link href="https://haledeng.com/blog/20190912-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AE%9A%E4%B9%89/"/>
    <id>https://haledeng.com/blog/20190912-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%93%8D%E5%BA%94%E5%BC%8F%E5%AE%9A%E4%B9%89/</id>
    <published>2019-09-12T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:46.308Z</updated>
    
    <content type="html"><![CDATA[<h2 id="defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•"><a href="#defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•" class="headerlink" title="defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•"></a><code>defineReactive</code>å®šä¹‰å“åº”å¼çš„æ–¹æ³•</h2><p><code>defineReactive</code>å‡½æ•°ä»åå­—ä¸Šçœ‹åº”è¯¥æ˜¯ä¸€ä¸ªå®šä¹‰å“åº”å¼å±æ€§çš„å‡½æ•°ã€‚</p><p>ä¸‹é¢çœ‹å®ƒçš„ä»£ç ï¼Œåœ¨<code>core/observer/index.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  customSetter?: ?Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®åœ¨å‰é¢è°ƒç”¨<code>initRender</code>å‡½æ•°ä¸­å®šä¹‰<code>vm.$attrs</code>å’Œ<code>vm.$listeners</code>å±æ€§çš„æ—¶å€™å°±å·²ç»ä½¿ç”¨è¿‡<code>defineReactive</code>å‡½æ•°ã€‚</p><p>å…ˆçœ‹è¿™ä¸ªå‡½æ•°çš„å‚æ•°ï¼Œæœ‰äº”ä¸ªå‚æ•°ã€‚å‰é¢ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯å®šä¹‰çš„å¯¹è±¡<code>obj</code>ä»¥åŠå®ƒçš„<code>key</code>å€¼å’Œ<code>val</code>å€¼ï¼Œè¿™äº›å‚æ•°æ˜¯å®šä¹‰å“åº”å¼å±æ€§æ—¶ä¼šç”¨åˆ°çš„å±æ€§ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°<code>obj</code>å’Œç¬¬äºŒä¸ªå‚æ•°<code>key</code>æ˜¯ä¸€å®šè¦ä¼ å…¥çš„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°<code>val</code>å¯ä»¥åœ¨å‡½æ•°ä¸­é€šè¿‡<code>val[key]</code>æ¥è·å–ã€‚</p><a id="more"></a><p>ç¬¬å››ä¸ªå‚æ•°<code>customSetter</code>ï¼Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>setting</code>å‡½æ•°ã€‚åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªç”¨æ¥æé†’æˆ–è€…æŠ¥é”™çš„å‡½æ•°ã€‚</p><p>ç¬¬äº”ä¸ªå‚æ•°<code>shallow</code>æ˜¯ä¸ªå¸ƒå°”å€¼ï¼Œè¡¨ç¤ºæ˜¯å¦å¼€å¯æ·±åº¦ç›‘å¬ï¼Œå½“å®ƒçš„å€¼ä¸º<code>false</code>æ—¶å¼€å¯æ·±åº¦ç›‘å¬ï¼Œè¿™ä¸ªå‚æ•°ä¸€èˆ¬æ˜¯ä¸ä¼šä¼ å…¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„å€¼é»˜è®¤æ˜¯<code>undefined</code>ï¼Œç„¶ååœ¨ä½¿ç”¨å®ƒçš„æ—¶å€™å¯ä»¥å–åï¼Œå³<code>!shallow</code>çš„å€¼ä¸º<code>true</code>ï¼Œè¿™æ ·å°±ä¼šå¼€å¯æ·±åº¦ç›‘å¬ã€‚</p><p>ä¸‹é¢çœ‹å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> dep = <span class="keyword">new</span> Dep() <span class="comment">// ! å®ä¾‹åŒ–ä¸€ä¸ªè®¢é˜…å™¨</span></span><br><span class="line"><span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key) <span class="comment">// ! è·å–å¯¹è±¡çš„ key å±æ€§æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>å…ˆçœ‹ç¬¬ä¸€è¡Œä»£ç ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªè®¢é˜…å™¨å¯¹è±¡<code>dep</code>ï¼Œç”¨æ¥æ”¶é›†è§‚å¯Ÿè€…ä¾èµ–ã€‚ç„¶åå°è¯•è·å–å¯¹è±¡<code>obj</code>ä¸­<code>key</code>çš„å±æ€§æè¿°ç¬¦ã€‚</p><p>ä»€ä¹ˆæ˜¯å±æ€§æè¿°ç¬¦å‘¢ï¼Ÿå°±æ˜¯å¯¹è±¡ä¸­<code>key</code>çš„å±æ€§æè¿°ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚å¦‚ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  a: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, <span class="string">'a'</span>)</span><br><span class="line"><span class="comment">// &#123; value: 1, writable: true, enumerable: true, configurable: true &#125;</span></span><br></pre></td></tr></table></figure><p>ç„¶ååˆ¤æ–­è·å–åˆ°å±æ€§æè¿°ç¬¦ä¸”å®ƒçš„<code>configurable</code>çš„å€¼æ˜¯å¦ä¸º<code>false</code>ï¼Œå³ç¡®è®¤ä¸€ä¸‹è¿™ä¸ª<code>key</code>çš„å±æ€§æ˜¯å¦å¯ä»¥é…ç½®ï¼ˆèƒ½å¦è¢«æ”¹å˜ï¼‰ï¼Œå¦‚æœ<code>configurable</code>çš„å€¼ä¸º<code>false</code>ï¼Œä¹Ÿå°±æ˜¯è¯´<code>key</code>æ˜¯ä¸å¯é…ç½®çš„ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ã€‚</p><p>å†çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cater for pre-defined getter/setters</span></span><br><span class="line"><span class="comment">// ! ç¼“å­˜å¯¹è±¡åŸå…ˆå®šä¹‰çš„ getter/setters</span></span><br><span class="line"><span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line"><span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line"><span class="keyword">if</span> ((!getter || setter) &amp;&amp; <span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">  val = obj[key]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å±æ€§æè¿°ç¬¦æ—¢ç„¶æ˜¯<code>key</code>çš„å±æ€§æè¿°ï¼Œé‚£ä¹ˆå®ƒé‡Œé¢å¯èƒ½ä¼šæœ‰<code>getter</code>å’Œ<code>setter</code>å±æ€§ï¼Œå°è¯•å»è·å–å®ƒä»¬çš„å€¼ã€‚</p><p>ç„¶åæ˜¯ä¸€ä¸ªæ¡ä»¶è¯­å¥ï¼Œåˆ¤æ–­æ˜¯å¦åªèƒ½è·å–<code>setter</code> æˆ–è€…æ²¡æœ‰<code>getter</code>ï¼Œå¹¶ä¸”å‡½æ•°çš„å‚æ•°åªæœ‰ä¸¤ä¸ªï¼Œå³åªä¼ å…¥å‰é¢çš„<code>obj</code>å’Œ<code>key</code>è¿™ä¸¤ä¸ªå‚æ•°ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè·å–<code>val</code>çš„å€¼ã€‚</p><p>ä¸ºä»€ä¹ˆè¿™é‡Œè¦è·å–<code>val</code>çš„å€¼å‘¢ï¼Ÿå› ä¸ºåœ¨<code>walk</code>æ–¹æ³•ä¸­è°ƒç”¨<code>defineReactive</code>æ—¶åªä¼ äº†å‰é¢ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶æ²¡æœ‰ä¼ ç¬¬ä¸‰ä¸ªå‚æ•°<code>val</code>ï¼Œæ‰€ä»¥åº”è¯¥éœ€è¦è·å–<code>val</code>çš„å€¼ï¼Œè¿™ä¹Ÿæ»¡è¶³æ¡ä»¶è¯­å¥çš„ç¬¬äºŒä¸ªæ¡ä»¶ã€‚</p><p>ç„¶åå†çœ‹ç¬¬ä¸€ä¸ªæ¡ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!getter || setter</span><br></pre></td></tr></table></figure><p>éœ€è¦æ»¡è¶³æ²¡æœ‰<code>getter</code>æˆ–è€…æœ‰<code>setter</code>è¿™ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä¸€ä¸ªæ‰è¡Œã€‚è¿™ä¸ªè¦æ€ä¹ˆç†è§£å‘¢ï¼Ÿ</p><p>å…ˆçœ‹ä¸‹æ¡ä»¶è¯­å¥ä¹‹åçš„è¿™è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val) <span class="comment">// ! å½“ val ä¸ä¸º undefined æ·±åº¦ç›‘å¬</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶è¯­å¥ä¸­çš„ä¸¤ä¸ªæ¡ä»¶çš„è¯ï¼Œåœ¨æ·±åº¦ç›‘å¬çš„æ—¶å€™ï¼Œ<code>val</code>çš„å€¼å°±æ˜¯<code>undefined</code>ï¼Œ<code>observe(val)</code>å°±ä¸ä¼šè¢«æœ‰æ•ˆçš„æ‰§è¡Œï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸ä¼šç”Ÿæˆå®ä¾‹å¯¹è±¡<code>childOb</code>ï¼Œä¹Ÿå°±æ˜¯è¿™æ—¶å€™æ·±åº¦ç›‘å¬æ˜¯å¤±è´¥çš„ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼Œå°±è·å–ä¸åˆ°<code>val</code>ï¼Œä¹Ÿå°±ä¸ä¼šå¯¹<code>val</code>æ‰§è¡Œæ·±åº¦ç›‘å¬ã€‚</p><p>çœ‹ä¸‹æ»¡è¶³æ¡ä»¶<code>!getter || setter</code>çš„ä¸‰ç§æƒ…å†µ</p><ol><li>æœ‰<code>getter</code>ä¹Ÿæœ‰<code>setting</code>ï¼ˆå‡çœŸï¼‰ï¼šåœ¨å±æ€§è¢«<code>observe</code>ç›‘å¬åä¼šæ»¡è¶³è¿™ç§æƒ…å†µã€‚</li><li>æ²¡æœ‰<code>getter</code>ä¹Ÿæ²¡æœ‰<code>setting</code>ï¼ˆçœŸå‡ï¼‰ï¼šåœ¨å±æ€§å˜æˆå“åº”å¼æ•°æ®å‰ä¼šæ»¡è¶³è¿™ç§æƒ…å†µã€‚</li><li>æ²¡æœ‰<code>getter</code>æœ‰<code>setting</code>ï¼ˆçœŸçœŸï¼‰ï¼šè¿™ç§æƒ…å†µæ¯”è¾ƒå°‘è§ã€‚</li></ol><p>å†çœ‹ä¸‹ä¸æ»¡æ¡ä»¶çš„æƒ…å†µä¹Ÿå°±æ˜¯ï¼ˆå‡å‡ï¼‰ï¼Œå³æœ‰<code>getting</code>è€Œæ²¡æœ‰<code>setting</code>ï¼Œæˆ‘ä»¬å¯ä»¥ä¸¾ä¸ªä¾‹å­ï¼Œçœ‹ä¸‹é¢ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// const data = &#123;a: &#123; b: 1 &#125;&#125; å¯¹æ¯”ä¸€èˆ¬çš„å­—é¢é‡å£°æ˜å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data = &#123;&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ Object.defineProperty åªå®šä¹‰ getter</span></span><br><span class="line"><span class="built_in">Object</span>.defineProperty(data, <span class="string">'a'</span>, &#123;</span><br><span class="line">  <span class="keyword">get</span>() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">b</span>: <span class="number">1</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data,</span><br><span class="line">  watch: &#123;</span><br><span class="line">    <span class="string">'a.b'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'ç›‘å¬åˆ°a.b'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">window</span>.vm = vm</span><br></pre></td></tr></table></figure><p>åœ¨æ§åˆ¶å°ä¸Šè¾“å…¥<code>vm._data</code>ï¼Œè¾“å‡ºä¸‹é¢ç»“æœ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  a: &#123;</span><br><span class="line">    b: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">  __ob__: &#123;</span><br><span class="line">    value: &#123;<span class="comment">/* */</span>&#125;,</span><br><span class="line">    dep: &#123;<span class="comment">/* */</span>&#125;,</span><br><span class="line">    vmCount: someNumber</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>data</code>é€‰é¡¹é‡Œé¢çš„å¯¹è±¡<code>a</code>ä¸­å¹¶æ²¡æœ‰<code>__ob__</code>è¿™ä¸ªå±æ€§ï¼Œè¯´æ˜æ•°æ®<code>a</code>å¹¶æ²¡æœ‰è¢«æ·±åº¦ç›‘å¬ï¼Œæ­¤æ—¶å¦‚æœä¿®æ”¹å¯¹è±¡<code>a</code>é‡Œé¢çš„<code>b</code>å±æ€§ï¼Œæ˜¯ä¸ä¼šè¢«<code>watch</code>é€‰é¡¹é‡Œé¢çš„ç›‘å¬å‡½æ•°ç›‘å¬åˆ°çš„ã€‚<br>ä½†æ˜¯æˆ‘ä»¬åœ¨å­—é¢é‡å®šä¹‰<code>data</code>é€‰é¡¹çš„æ•°æ®æ—¶ï¼Œå¯¹è±¡<code>a</code>é‡Œé¢æ˜¯æœ‰<code>__ob__</code>å±æ€§çš„ï¼Œå› ä¸ºæ·±åº¦ç›‘å¬æ˜¯é»˜è®¤å¼€å¯çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123; <span class="attr">a</span>: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125; &#125;</span><br></pre></td></tr></table></figure><p><strong>å°ç»“</strong>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹<code>val</code>éƒ½æ˜¯ä¼šå»å°è¯•è·å–å€¼å¹¶ä¸”å¯¹å®ƒæ‰§è¡Œæ·±åº¦ç›‘å¬ã€‚åªæœ‰åœ¨ç‰¹æ®Šåœºæ™¯ä¸‹æ‰ä¸ä¼šå»è·å–å€¼ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆç‰¹ç‰¹æ®Šåœºæ™¯ï¼Œåé¢é‡åˆ°å†è®²ã€‚</p><h3 id="getter"><a href="#getter" class="headerlink" title="getter"></a><code>getter</code></h3><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>defineReactive</code>å‡½æ•°ä¸­æ˜¯æ€ä¹ˆå®šä¹‰<code>getter</code>çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  <span class="keyword">get</span>: function reactiveGetter() &#123;</span><br><span class="line">    <span class="keyword">const</span> value = getter ? getter.call(obj) : val <span class="comment">// ! è·å–å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      dep.depend() <span class="comment">// ! æ·»åŠ è¿›è®¢é˜…å™¨ï¼Œä¾èµ–æ”¶é›†</span></span><br><span class="line">      <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">        childOb.dep.depend()</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">          dependArray(value) <span class="comment">// ! æ•°ç»„æ‰‹åŠ¨æ”¶é›†ä¾èµ–</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value <span class="comment">// ! è¿”å›å€¼</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">set</span>: function reactiveSetter(newVal) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å¸¸é‡<code>value</code>å­˜å‚¨è·å–åˆ°<code>val</code>çš„å€¼ï¼ŒåŒæ—¶ä¹Ÿä½œä¸º<code>getter</code>çš„è¿”å›å€¼ã€‚</p><p>æ€ä¹ˆè·å–<code>val</code>çš„å€¼ï¼Ÿåˆ¤æ–­è¯¥æ•°æ®åŸæ˜¯å¦å·²ç»å®šä¹‰è¿‡<code>getter</code>ï¼Œå¦‚æœå·²ç»å®šä¹‰è¿‡å°±ç›´æ¥è°ƒç”¨åŸå…ˆçš„<code>getter</code>è¿›è¡Œæ±‚å€¼ï¼Œå¦åˆ™è¿”å›ä¸Šé¢è·å–çš„<code>val</code>å€¼ã€‚</p><p>ä¸ºä»€ä¹ˆè¦è°ƒç”¨åŸå…ˆå®šä¹‰çš„<code>getter</code>æ¥è¿”å›å€¼å‘¢ï¼Ÿå› ä¸ºä¸èƒ½å»é‡å¤å®šä¹‰<code>getter</code>ï¼Œè¿™æ ·ä¼šæŠŠä»¥å‰çš„å®šä¹‰çš„<code>getter</code>è¦†ç›–æ‰ã€‚</p><p>ç„¶ååˆ¤æ–­<code>Dep.target</code>æ˜¯å¦æœ‰å€¼ï¼ˆè§‚å¯Ÿè€…ï¼‰ï¼Œå¦‚æœæœ‰å€¼çš„è¯ï¼Œä½¿ç”¨è®¢é˜…å™¨å¯¹è±¡<code>dep</code>æ”¶é›†è§‚å¯Ÿè€…ä¾èµ–ã€‚å¦‚æœæœ‰<code>childOb</code>ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰çš„<code>value</code>åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒæ ·è®©<code>childOb.dep</code>æ”¶é›†è§‚å¯Ÿè€…ä¾èµ–ï¼Œè¿™ä¸ª<code>childOb</code>å°±æ˜¯å¯¹è±¡<code>value</code>é‡Œé¢çš„<code>__ob__</code>å±æ€§ã€‚</p><p><strong>æ³¨æ„</strong>ï¼Œè¿™ä¸¤ä¸ª<code>dep</code>æ”¶é›†åˆ°çš„ä¾èµ–æ˜¯<strong>ä¸€æ ·</strong>çš„ï¼Œ<strong>ä½†æ˜¯å®ƒä»¬è§¦å‘ä¾èµ–çš„æ—¶æœºä¸ä¸€æ ·</strong>ï¼Œæˆ‘ä»¬åœ¨ä¿®æ”¹<code>value</code>çš„å€¼åï¼Œä¼šæ‰§è¡Œå®ƒçš„<code>setter</code>ï¼Œä¼šè§¦å‘<code>obj</code>ä¸­çš„<code>ob</code>çš„ä¾èµ–æ‰§è¡Œã€‚</p><p>ä½†æ˜¯å¦‚æœ<code>value</code>ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹æ—¶ï¼Œå½“ä¸ºè¿™ä¸ªå¯¹è±¡æ·»åŠ æˆ–è€…åˆ é™¤å±æ€§æ—¶ï¼Œè¿™æ—¶æ˜¯ä¸ä¼šè§¦å‘<code>obj</code>çš„<code>ob</code>çš„ä¾èµ–æ‰§è¡Œçš„ã€‚å› ä¸ºæ–°å¢çš„å±æ€§æˆ–è€…åˆ é™¤çš„å±æ€§ä¸­é‡Œé¢å¹¶æ²¡æœ‰<code>setter</code>ï¼Œä½†æ˜¯<code>value</code>ç¡®å®è¢«ä¿®æ”¹äº†ã€‚è¿™æ—¶ä¼šè§¦å‘<code>value</code>é‡Œé¢çš„<code>ob</code>ï¼ˆä¹Ÿå°±æ˜¯<code>childOB</code>ï¼‰ä¸­çš„ä¾èµ–æ‰§è¡Œã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user: &#123;</span><br><span class="line">  name: <span class="string">'hale'</span>,</span><br><span class="line">  info: &#123;</span><br><span class="line">age: <span class="number">18</span>,</span><br><span class="line">    score: <span class="number">99</span>,</span><br><span class="line">    __ob__: &#123;<span class="comment">/* */</span>&#125; <span class="comment">// childOb</span></span><br><span class="line">  &#125;,</span><br><span class="line">  __ob__: &#123;<span class="comment">/* */</span>&#125; <span class="comment">// ob</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬ä¿®æ”¹<code>user</code>æ•°æ®ä¸‹é¢çš„<code>name</code>æ—¶ï¼Œæ¯”å¦‚æŠŠ<code>hale</code>ä¿®æ”¹ä¸º<code>bill</code>ï¼Œè¿™æ—¶ä¼šè§¦å‘<code>ob</code>ä¸­ä¾èµ–çš„æ›´æ–°ã€‚æˆ–è€…ä¿®æ”¹<code>info</code>çš„å€¼ä¸º<code>null</code>æ—¶ï¼Œä¹Ÿä¼šè§¦å‘<code>ob</code>ä¸­ä¾èµ–çš„æ›´æ–°ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä¿®æ”¹<code>info</code>é‡Œé¢çš„å€¼æ—¶ï¼Œæ¯”å¦‚ä¸ºå®ƒæ·»åŠ ä¸€ä¸ªæ–°çš„å±æ€§<code>gender</code>ï¼Œå®ƒçš„å€¼ä¸º<code>man</code>ï¼Œè¿™æ—¶å€™å°±ä¸ä¼šè§¦å‘<code>ob</code>ä¸­ä¾èµ–çš„æ›´æ–°ï¼Œè€Œæ˜¯ä¼šè§¦å‘<code>childOb</code>ä¸­ä¾èµ–çš„æ›´æ–°ã€‚å¦å¤–ï¼Œ<code>ob</code>å’Œ<code>childOB</code>é‡Œé¢çš„ä¾èµ–æ˜¯ä¸€æ ·çš„ã€‚</p><p>æœ‰<code>childOb</code>è¯´æ˜æ˜¯æ·±åº¦ç›‘å¬ï¼Œè¯´æ˜ç›‘å¬å¯¹è±¡<code>obj</code>é‡Œé¢çš„<code>value</code>ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹ã€‚è¿™æ—¶å†åˆ¤æ–­<code>value</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œè°ƒç”¨<code>dependArray</code>æ‰‹åŠ¨æ”¶é›†ä¾èµ–ï¼Œå› ä¸ºæ•°ç»„é‡Œé¢çš„ç´¢å¼•å€¼æ˜¯ä¸ä¼šè‡ªåŠ¨æ”¶é›†ä¾èµ–çš„ã€‚åé¢è®²è§£æ•°ç»„çš„å“åº”å¼æ—¶å†è¯¦ç»†è®²è§£å®ƒæ˜¯å¦‚ä½•æ”¶é›†ä¾èµ–çš„ã€‚</p><p><strong>æ€»ç»“</strong>ï¼Œ<code>getter</code>å‡½æ•°æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¸€ä¸ªæ˜¯è¿”å›æ­£ç¡®çš„å€¼ï¼Œå¦ä¸€ä¸ªå°±æ˜¯æ”¶é›†ä¾èµ–ã€‚</p><h3 id="setter"><a href="#setter" class="headerlink" title="setter"></a><code>setter</code></h3><p>ä¸‹é¢çœ‹ä¸‹<code>setter</code>çš„å®šä¹‰</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>: function reactiveSetter(newVal) &#123;</span><br><span class="line">  <span class="keyword">const</span> value = getter ? getter.call(obj) : val <span class="comment">// ! è·å–å€¼ (æ—§å€¼)</span></span><br><span class="line">  <span class="comment">/* eslint-disable no-self-compare */</span></span><br><span class="line">  <span class="comment">// !                    NaN === NaN false</span></span><br><span class="line">  <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">    customSetter()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line">  <span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">    setter.call(obj, newVal) <span class="comment">// ! æ‰§è¡ŒåŸæ¥çš„ setter, è®¾ç½®æ–°å€¼</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    val = newVal <span class="comment">// ! è®¾ç½®æ–°å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line">  childOb = !shallow &amp;&amp; observe(newVal) <span class="comment">// ! æ·±åº¦ç›‘å¬æ–°å€¼ï¼ˆå¯¹è±¡æˆ–è€…æ•°ç»„ï¼‰</span></span><br><span class="line">  dep.notify() <span class="comment">// ! é€šçŸ¥è§‚å¯Ÿè€…, è§¦å‘ä¾èµ–</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å¸¸é‡<code>value</code>å­˜å‚¨è·å–åˆ°<code>val</code>çš„å€¼ã€‚æ€ä¹ˆè·å–<code>val</code>çš„å€¼ï¼Ÿåˆ¤æ–­å±æ€§åŸå…ˆæ˜¯å¦å·²ç»å®šä¹‰è¿‡<code>getter</code>ï¼Œå¦‚æœå·²ç»å®šä¹‰è¿‡å°±ç›´æ¥è°ƒç”¨åŸå…ˆçš„<code>getter</code>è¿›è¡Œæ±‚å€¼ï¼Œå¦åˆ™è¿”å›ä¸Šé¢è·å–çš„<code>val</code>å€¼ã€‚</p><p><strong>æ³¨æ„è¿™é‡Œè·å–çš„å€¼æ˜¯ä¿®æ”¹å‰çš„å€¼</strong>ï¼Œä¹Ÿå°±æ˜¯æ—§å€¼ã€‚è€Œ<strong>ä¿®æ”¹åçš„å€¼å°±æ˜¯æ–°å€¼</strong>æ˜¯é€šè¿‡å‚æ•°<code>newVal</code>ä¼ è¿›æ¥çš„ã€‚</p><p>ç„¶åæ¯”è¾ƒæ–°å€¼å’Œæ—§å€¼æ˜¯å¦å…¨ç­‰ï¼Œå¦‚æœå…¨ç­‰ï¼Œç›´æ¥è¿”å›ï¼Œä¸éœ€è¦è¿›è¡Œä¸‹é¢çš„æ“ä½œã€‚</p><p>è¿™é‡Œæœ‰ä¸ªåˆ¤æ–­æ¡ä»¶éå¸¸å¤æ€ªï¼Œå³æ–°å€¼çš„æœ¬èº«ä¸ç­‰äºæ–°å¢ï¼Œæ—§å€¼çš„æœ¬èº«ä¸ç­‰äºæ—§å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">newVal !== newVal &amp;&amp; value !== value</span><br></pre></td></tr></table></figure><p>è¯·é—®å¯èƒ½å­˜åœ¨è¿™ç§å¥‡æ€ªçš„ç°è±¡å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚JavaScript ä¸­å°±å­˜åœ¨ä¸€ä¸ªç‰¹æ®Šçš„å€¼<code>NaN</code>ï¼Œå®ƒä¸ç­‰äºå®ƒè‡ªèº«ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ–°å€¼æˆ–è€…æ—§å€¼æ˜¯<code>NaN</code>çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯ç›´æ¥è¿”å›ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-enable no-self-compare */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; customSetter) &#123;</span><br><span class="line">  customSetter()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>customSetter</code>æ˜¯<code>defineReactive</code>å‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°ï¼Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>setter</code>å‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªå‚æ•°æœ‰å€¼çš„è¯ä¸”åœ¨éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œä¼šåœ¨è¿™é‡Œæ‰§è¡Œï¼Œè¿™ä¸ªå‡½æ•°éƒ½æ˜¯ä¸€ä¸ªè­¦å‘Šæˆ–è€…æç¤ºçš„å‡½æ•°ã€‚</p><p>æ¯”å¦‚åœ¨<code>initRender</code>å‡½æ•°åˆå§‹åŒ–å®ä¾‹å¯¹è±¡çš„<code>$attrs</code>å’Œ<code>$listeners</code>å±æ€§æ—¶ä¼ å…¥çš„å‡½æ•°ï¼Œçœ‹å®ƒçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; &#123;</span><br><span class="line">  !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨ä¸æ˜¯æ›´æ–°å­ç»„ä»¶æ—¶ä¿®æ”¹<code>$attrs</code>å±æ€§çš„æ—¶å€™ï¼Œä¼šæç¤º<code>$attrs</code>æ˜¯å¯è¯»çš„ã€‚</p><p>ç»§ç»­çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// #7981: for accessor properties without setter</span></span><br><span class="line"><span class="keyword">if</span> (getter &amp;&amp; !setter) <span class="keyword">return</span></span><br><span class="line"><span class="keyword">if</span> (setter) &#123;</span><br><span class="line">  setter.call(obj, newVal) <span class="comment">// ! æ‰§è¡ŒåŸæ¥çš„ setter, è®¾ç½®æ–°å€¼</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  val = newVal <span class="comment">// ! è®¾ç½®æ–°å€¼</span></span><br><span class="line">&#125;</span><br><span class="line">childOb = !shallow &amp;&amp; observe(newVal) <span class="comment">// ! æ·±åº¦ç›‘å¬æ–°å€¼ï¼ˆå¯¹è±¡æˆ–è€…æ•°ç»„ï¼‰</span></span><br><span class="line">dep.notify() <span class="comment">// ! è§¦å‘ä¾èµ–ï¼Œé€šçŸ¥è§‚å¯Ÿè€…</span></span><br></pre></td></tr></table></figure><p>åˆ¤æ–­åŸæ¥çš„å±æ€§æè¿°ç¬¦ä¸­æ˜¯å¦åªæœ‰<code>getter</code>è€Œæ²¡æœ‰<code>setter</code>ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥è¿”å›ã€‚å› ä¸ºè¿™ä¸ªå±æ€§æ—¢ç„¶åŸæ¥åªè®¾ç½®äº†<code>getter</code>è€Œæ²¡æœ‰è®¾ç½®<code>setter</code>ï¼Œè¿™é‡Œä¹Ÿä¸ç”¨ç”»è›‡æ·»è¶³çš„å»è®¾ç½®<code>setter</code>ã€‚</p><p>åˆ¤æ–­åŸæ¥æ˜¯å¦æœ‰<code>setter</code>ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨åŸæ¥çš„<code>setter</code>å¹¶ä¼ å…¥æ–°å€¼ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œç›´æ¥æŠŠæ–°å€¼èµ‹å€¼ç»™æ—§å€¼ã€‚è¿™é‡Œå’Œ<code>getter</code>ä¸­åŸå› æ˜¯ä¸€æ ·çš„ï¼ŒåŸå…ˆçš„å±æ€§å·²ç»å®šä¹‰è¿‡<code>setter</code>ï¼Œå°±ä¸éœ€è¦å†é‡æ–°å®šä¹‰<code>setter</code>ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨å®ƒã€‚</p><p>ç„¶åæ·±åº¦ç›‘å¬è¿™ä¸ªè®¾ç½®çš„æ–°å€¼ã€‚å› ä¸ºè®¾ç½®çš„æ–°å€¼å¯èƒ½ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å€¼ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œæ·±åº¦ç›‘å¬ã€‚</p><p><code>setter</code>å‡½æ•°åœ¨æœ€åä¼šè§¦å‘ä¾èµ–ï¼Œé€šçŸ¥è§‚å¯Ÿè€…ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dep.notify() <span class="comment">// ! è§¦å‘ä¾èµ–ï¼Œé€šçŸ¥è§‚å¯Ÿè€…</span></span><br></pre></td></tr></table></figure><p><strong>å°ç»“</strong>ï¼Œ<code>setter</code>å‡½æ•°æœ‰ä¸¤ä¸ªä½œç”¨ï¼Œä¸€ä¸ªæ˜¯æ­£ç¡®ä¿®æ”¹å€¼ï¼Œå¦ä¸€ä¸ªå°±æ˜¯è§¦å‘ä¾èµ–ã€‚</p><h3 id="childOb"><a href="#childOb" class="headerlink" title="childOb"></a><code>childOb</code></h3><p>ç»è¿‡<code>Object.defineProperty</code>å®šä¹‰è¿‡çš„æ•°æ®ï¼Œåœ¨ä¿®æ”¹æ•°æ®çš„å€¼æ—¶ï¼Œä¼šè§¦å‘å…¶ä¸­çš„<code>setting</code>çš„æ‰§è¡Œï¼Œè§¦å‘ä¾èµ–çš„æ‰§è¡Œï¼Œæ›´æ–°è§†å›¾ã€‚è¿™é‡Œè§¦å‘çš„ä¾èµ–æ˜¯å’Œè¿™ä¸ªæ•°æ®å¹³çº§çš„<code>__ob__</code>å±æ€§ä¸­<code>dep</code>æ”¶é›†çš„ä¾èµ–ã€‚</p><p>å¦‚æœè¿™ä¸ªæ•°æ®æ˜¯ä¸€ä¸ªå¯¹è±¡ç±»å‹çš„å€¼ï¼Œå½“å®ƒåœ¨æ–°å¢æˆ–è€…åˆ é™¤å±æ€§æ—¶ï¼Œä¹Ÿç›¸å¯¹äºæ”¹å˜äº†å€¼ï¼Œä½†æ˜¯å®ƒæ”¹å˜çš„æ˜¯æ•°æ®é‡Œé¢çš„å€¼ï¼Œä½†æ˜¯ä¹Ÿéœ€è¦å»è§¦å‘ä¾èµ–ï¼Œæ›´æ–°è§†å›¾çš„ã€‚ä¸è¿‡å®é™…ä¸Šå®ƒå¹¶ä¸ä¼šè§¦å‘å’Œå±æ€§å¹³çº§çš„<code>__ob__</code>å±æ€§é‡Œé¢çš„<code>dep</code>æ”¶é›†çš„ä¾èµ–æ‰§è¡Œçš„ã€‚</p><p>è¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨åˆ°<code>childOb</code>ï¼Œä½¿ç”¨å®ƒçš„<code>dep</code>æ”¶é›†çš„ä¾èµ–æ¥è§¦å‘ä¾èµ–ã€‚<code>childOb</code>å°±æ˜¯åœ¨æ•°æ®é‡Œé¢çš„<code>__ob__</code>å±æ€§ã€‚åœ¨æˆ‘ä»¬ä½¿ç”¨<code>Vue.set/Vue.delete</code>æˆ–è€…<code>vm.$set/vm.$delete</code>æ›´æ–°æ•°æ®æ—¶ï¼Œæ‰§è¡Œçš„ä¾èµ–éƒ½æ˜¯<code>childOb</code>ä¸­çš„ä¾èµ–ã€‚</p><p>æ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸ª<code>data</code>é€‰é¡¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  a: &#123; <span class="attr">b</span>: <span class="number">1</span> &#125;,</span><br><span class="line">  c: <span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>data</code>é€‰é¡¹æ˜¯å“åº”å¼çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  a: &#123;</span><br><span class="line">    b: <span class="number">1</span>,</span><br><span class="line">    __ob__: &#123; value, dep, vmCount &#125; <span class="comment">// childOb</span></span><br><span class="line">  &#125;,</span><br><span class="line">  c: <span class="number">2</span>,</span><br><span class="line">  __ob__: &#123; value, dep, vmCount &#125; <span class="comment">// ob</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬ä¿®æ”¹å¯¹è±¡<code>a</code>çš„å€¼ï¼Œå¿…é¡»æŠŠå®ƒå˜æˆ<code>a:1</code>ï¼Œè¿™æ—¶ä¼šè§¦å‘<code>ob1</code>ä¸­<code>dep</code>æ”¶é›†çš„ä¾èµ–ï¼Œå³æ‰§è¡Œ<code>a.__ob__.dep.notify</code>ä»£ç ã€‚ä¿®æ”¹<code>c</code>çš„å€¼ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p><p>ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä¿®æ”¹çš„æ˜¯<code>a</code>é‡Œé¢çš„å€¼ï¼Œæ¯”å¦‚æ–°å¢ä¸€ä¸ªå±æ€§ï¼Œæ¯”å¦‚ç»™å¯¹è±¡<code>a</code>æ–°å€¼å±æ€§<code>bb</code>ï¼Œå®ƒçš„å€¼ä¸º 2ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vue.set(a, <span class="string">'bb'</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><p>æˆ–è€…ç›´æ¥ä¿®æ”¹<code>b</code>çš„å€¼ï¼Œè¿™æ—¶å€™è¿˜æ˜¯ä¼šè§¦å‘å¯¹è±¡<code>a</code>ä¾èµ–æ‰§è¡Œçš„ï¼Œä¸è¿‡ç°åœ¨è§¦å‘çš„ä¸æ˜¯<code>ob1</code>ä¸‹é¢çš„<code>dep</code>æ”¶é›†çš„ä¾èµ–ï¼Œè€Œæ˜¯<code>ob</code>é‡Œé¢çš„<code>dep</code>æ”¶é›†çš„ä¾èµ–ï¼Œå³æ‰§è¡Œ<code>a.b.__ob__.dep.notify()</code>ä»£ç ï¼Œä¹Ÿå°±æ˜¯<code>childOb</code>é‡Œé¢çš„ä»£ç ã€‚</p><p>åœ¨æˆ‘ä»¬ä½¿ç”¨<code>Vue.delete</code>æˆ–è€…<code>vm.$delete</code>ä¿®æ”¹å€¼ä¹Ÿæ˜¯ä¸€æ ·çš„æƒ…å†µã€‚</p><p>è‡³äºå¦‚ä½•æ‰§è¡Œ<code>childOb</code>çš„ä»£ç ï¼Œè§¦å‘ä¾èµ–ï¼Œåœ¨æˆ‘ä»¬å­¦ä¹ åˆ°<code>set</code>å’Œ<code>delete</code>å‡½æ•°æ—¶ä¼šè¯¦ç»†åˆ†æã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•&quot;&gt;&lt;a href=&quot;#defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•&quot; class=&quot;headerlink&quot; title=&quot;defineReactiveå®šä¹‰å“åº”å¼çš„æ–¹æ³•&quot;&gt;&lt;/a&gt;&lt;code&gt;defineReactive&lt;/code&gt;å®šä¹‰å“åº”å¼çš„æ–¹æ³•&lt;/h2&gt;&lt;p&gt;&lt;code&gt;defineReactive&lt;/code&gt;å‡½æ•°ä»åå­—ä¸Šçœ‹åº”è¯¥æ˜¯ä¸€ä¸ªå®šä¹‰å“åº”å¼å±æ€§çš„å‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢çœ‹å®ƒçš„ä»£ç ï¼Œåœ¨&lt;code&gt;core/observer/index.js&lt;/code&gt;æ–‡ä»¶ä¸­&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;defineReactive&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  obj: Object,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  key: string,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  val: any,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  customSetter?: ?Function,&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;  shallow?: boolean&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;å…¶å®åœ¨å‰é¢è°ƒç”¨&lt;code&gt;initRender&lt;/code&gt;å‡½æ•°ä¸­å®šä¹‰&lt;code&gt;vm.$attrs&lt;/code&gt;å’Œ&lt;code&gt;vm.$listeners&lt;/code&gt;å±æ€§çš„æ—¶å€™å°±å·²ç»ä½¿ç”¨è¿‡&lt;code&gt;defineReactive&lt;/code&gt;å‡½æ•°ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆçœ‹è¿™ä¸ªå‡½æ•°çš„å‚æ•°ï¼Œæœ‰äº”ä¸ªå‚æ•°ã€‚å‰é¢ä¸‰ä¸ªå‚æ•°åˆ†åˆ«æ˜¯å®šä¹‰çš„å¯¹è±¡&lt;code&gt;obj&lt;/code&gt;ä»¥åŠå®ƒçš„&lt;code&gt;key&lt;/code&gt;å€¼å’Œ&lt;code&gt;val&lt;/code&gt;å€¼ï¼Œè¿™äº›å‚æ•°æ˜¯å®šä¹‰å“åº”å¼å±æ€§æ—¶ä¼šç”¨åˆ°çš„å±æ€§ã€‚å…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°&lt;code&gt;obj&lt;/code&gt;å’Œç¬¬äºŒä¸ªå‚æ•°&lt;code&gt;key&lt;/code&gt;æ˜¯ä¸€å®šè¦ä¼ å…¥çš„ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°&lt;code&gt;val&lt;/code&gt;å¯ä»¥åœ¨å‡½æ•°ä¸­é€šè¿‡&lt;code&gt;val[key]&lt;/code&gt;æ¥è·å–ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹ç›‘å¬å™¨</title>
    <link href="https://haledeng.com/blog/20190910-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%9B%91%E5%90%AC%E5%99%A8/"/>
    <id>https://haledeng.com/blog/20190910-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%9B%91%E5%90%AC%E5%99%A8/</id>
    <published>2019-09-10T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:41.517Z</updated>
    
    <content type="html"><![CDATA[<p>Vue æœ€æ ¸å¿ƒçš„åœ°æ–¹å°±æ˜¯å®ƒçš„å“åº”å¼ç³»ç»Ÿï¼Œè¿™æ˜¯å®ƒæœ€æ ¸å¿ƒçš„ç²¾åï¼Œä¹Ÿæ˜¯æ˜æ˜¾åŒºåˆ«äºå…¶ä»–çš„æ¡†æ¶åƒ<code>React</code>ã€<code>Angular</code>çš„åœ°æ–¹ã€‚</p><p>åœ¨ä¸Šä¸€ç« åˆå§‹åŒ–å®ä¾‹å±æ€§çš„æ—¶å€™ï¼Œè®²è§£äº†<code>initState</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢è°ƒç”¨äº†ä¸€ç³»åˆ—åˆå§‹åŒ–é€‰é¡¹çš„å‡½æ•°ï¼Œä¸ºå®ä¾‹å¯¹è±¡<code>vm</code>åˆå§‹åŒ–äº†å¾ˆå¤šå±æ€§ï¼Œè¿™äº›å±æ€§å¤§éƒ½æ˜¯å’Œå“åº”å¼ç³»ç»Ÿç›¸å…³çš„ã€‚æœ¬ç« ä¸»è¦å›´ç»•<code>initData</code>å‡½æ•°æ¥è¿›è¡Œï¼Œå› ä¸ºåˆå§‹åŒ–<code>data</code>é€‰é¡¹å‡ ä¹æ¶‰åŠåˆ°äº†å“åº”å¼ç³»ç»Ÿçš„å…¨éƒ¨å†…å®¹ã€‚</p><p>å…ˆçœ‹ä¸‹<code>initData</code>å‡½æ•°åœ¨<code>initState</code>å‡½æ•°ä¸­çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">  initData(vm)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  observe((vm._data = &#123;&#125;), <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>data</code>å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨<code>initData</code>å‡½æ•°åˆå§‹åŒ–<code>data</code>é€‰é¡¹ã€‚</p><p>å¦‚æœæ²¡æœ‰çš„è¯ï¼ŒæŠŠå®ä¾‹å¯¹è±¡çš„ç§æœ‰å±æ€§<code>_data</code>è®¾ç½®ç©ºå¯¹è±¡ï¼Œå¹¶è°ƒç”¨<code>observe</code>å‡½æ•°ç›‘å¬è¿™ä¸ªç©ºå¯¹è±¡ã€‚</p><p>å…¶å®ï¼ŒVue è¿˜å¯¹å¤–æä¾›äº†<code>$data</code> å±æ€§è®©æˆ‘ä»¬è·å–<code>data</code>çš„å€¼ï¼Œè€Œ<code>$data</code>ä»£ç†çš„å°±æ˜¯<code>_data</code>çš„å€¼ã€‚</p><a id="more"></a><h2 id="initData"><a href="#initData" class="headerlink" title="initData"></a><code>initData</code></h2><p>ä¸‹é¢æ¥çœ‹ä¸‹<code>initData</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™æ˜¯åˆå§‹åŒ–<code>data</code>é€‰é¡¹çš„å‡½æ•°ã€‚</p><p>å…ˆçœ‹å‰é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">  data = vm._data = <span class="keyword">typeof</span> data === <span class="string">'function'</span> ? getData(data, vm) : data || &#123;&#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜å˜é‡<code>data</code>å­˜å‚¨<code>vm.$options.data</code>çš„å€¼ï¼Œç„¶ååˆ¤æ–­<code>data</code>çš„æ˜¯ä¸æ˜¯å‡½æ•°ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œè°ƒç”¨<code>getData</code>å‡½æ•°è·å–<code>data</code>çš„å€¼ï¼›å¦‚æœä¸æ˜¯å‡½æ•°ï¼Œåˆ™<code>data</code>åº”è¯¥æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œè¿”å›å®ƒæˆ–è€…ä¸€ä¸ªç©ºå¯¹è±¡ã€‚</p><p>ç°åœ¨çœ‹ä¸‹<code>getData</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params">data: Function, vm: Component</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking data getters</span></span><br><span class="line">  pushTarget()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data.call(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, <span class="string">`data()`</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    popTarget()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†<code>try...catch...finally</code>è¯­å¥æ¥æ‰§è¡Œå‡½æ•°ï¼Œä»¥åŠæ•è·å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œåœ¨<code>try</code>ä»£ç å—ä¸­ä½¿ç”¨<code>call</code>æ–¹æ³•è°ƒç”¨<code>data</code>å‡½æ•°ã€‚è¿™é‡Œä¼ å…¥äº†ä¸¤ä¸ª<code>vm</code>å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤º<code>this</code>æŒ‡å‘å®ä¾‹å¯¹è±¡<code>vm</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºä¼ å…¥å®ä¾‹å¯¹è±¡ä½œä¸ºå‡½æ•°çš„å‚æ•°ã€‚</p><p>å†çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isPlainObject(data)) &#123;</span><br><span class="line">  data = &#123;&#125;</span><br><span class="line">  process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'data functions should return an object:\n'</span> +</span><br><span class="line">        <span class="string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­<code>data</code>æ˜¯ä¸æ˜¯æ™®é€šå¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯ï¼Œä¼šæŠŠ<code>data</code>è®¾ç½®æˆä¸€ä¸ªç©ºå¯¹è±¡ï¼Œç„¶ååœ¨éç”Ÿäº§ç¯å¢ƒä¸­æŠ¥é”™ï¼Œæç¤º<code>data</code>çš„å€¼å¿…é¡»æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data)</span><br><span class="line"><span class="keyword">const</span> props = vm.$options.props</span><br><span class="line"><span class="keyword">const</span> methods = vm.$options.methods</span><br><span class="line"><span class="keyword">let</span> i = keys.length</span><br><span class="line"><span class="keyword">while</span> (i--) &#123;</span><br><span class="line">  <span class="keyword">const</span> key = keys[i]</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (methods &amp;&amp; hasOwn(methods, key)) &#123;</span><br><span class="line">      warn(<span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has already been defined as a data property.`</span>, vm)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`The data property "<span class="subst">$&#123;key&#125;</span>" is already declared as a prop. `</span> +</span><br><span class="line">          <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isReserved(key)) &#123;</span><br><span class="line">    proxy(vm, <span class="string">`_data`</span>, key) <span class="comment">// ! ä»£ç† data ä¸Šçš„å±æ€§ vm.xxx = vm._data.xxx</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–<code>data</code>é€‰é¡¹çš„<code>keys</code>çš„å€¼ï¼Œå†åˆ†åˆ«è·å–<code>props</code>å’Œ<code>methods</code>çš„å€¼ã€‚ç„¶åé€šè¿‡é€’å‡<code>keys</code>å€¼çš„é•¿åº¦æ¥å¾ªç¯<code>keys</code>çš„å€¼ã€‚åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœ<code>methods</code>é€‰é¡¹çš„æ–¹æ³•åä¹Ÿå«æœ‰ç›¸åŒçš„<code>key</code>å€¼ä¼šæŠ¥é”™ï¼Œæç¤º<code>data</code>ä¸­å·²ç»å®šä¹‰è¿‡<code>key</code>çš„å€¼ã€‚å¦‚æœ<code>props</code>é€‰é¡¹ä¸­ä¹Ÿå«æœ‰ç›¸åŒåç§°çš„<code>key</code>æ—¶ä¹Ÿä¼šæŠ¥é”™ï¼Œæç¤º<code>props</code>ä¸­å·²ç»å®šä¹‰è¿‡<code>key</code>çš„å€¼ã€‚</p><p>å†åˆ¤æ–­<code>key</code>æ˜¯ä¸æ˜¯ Vue ä¸­çš„ä¿ç•™å±æ€§ï¼ŒVue ä¸­çš„ä¿ç•™å±æ€§å°±æ˜¯ä»¥<code>$</code>æˆ–è€…<code>_</code>å¼€å¤´çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´<code>data</code>é€‰é¡¹ä¸­çš„æ•°æ®çš„åç§°ä¸èƒ½ä»¥<code>$</code>æˆ–è€…<code>_</code>å¼€å¤´ã€‚å¦‚æœä¸æ˜¯ Vue çš„ä¿ç•™å±æ€§ï¼Œä¼šä½¿ç”¨<code>proxy</code>å‡½æ•°æ¥ä»£ç†<code>data</code>ä¸Šçš„å±æ€§ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>proxy</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sharedPropertyDefinition = &#123;</span><br><span class="line">  enumerable: <span class="literal">true</span>,</span><br><span class="line">  configurable: <span class="literal">true</span>,</span><br><span class="line">  <span class="keyword">get</span>: noop,</span><br><span class="line">  <span class="keyword">set</span>: noop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function proxy(target: Object, sourceKey: string, key: string) &#123;</span><br><span class="line">  sharedPropertyDefinition.get = <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span>(<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä½¿å¾—å®ä¾‹å¯¹è±¡<code>vm</code>å¯ä»¥ä»£ç†<code>data</code>é€‰é¡¹çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œåœ¨æˆ‘ä»¬è®¿é—®<code>this.xxx</code>æ•°æ®æ—¶ï¼Œå…¶å®è®¿é—®çš„æ˜¯<code>this.data.xxx</code>æ•°æ®ã€‚</p><p><code>vm</code>é™¤äº†ä¼šä»£ç†<code>data</code>é€‰é¡¹çš„æ•°æ®ï¼Œè¿˜æœ‰ä»£ç†<code>props</code>ã€<code>methods</code>å’Œ<code>computed</code>ç­‰é€‰é¡¹ä¸­çš„å€¼ï¼Œæ‰€ä»¥è¿™äº›é€‰é¡¹é‡Œé¢çš„å±æ€§ï¼ˆæ–¹æ³•ï¼‰åä¸èƒ½é‡åã€‚é€šè¿‡ä»£ç†é€‰é¡¹ä¸­å±æ€§ï¼Œæˆ‘ä»¬ä¼šæ›´æ–¹ä¾¿çš„ä½¿ç”¨è¿™äº›é€‰é¡¹ä¸Šçš„å±æ€§ï¼ˆæ–¹æ³•ï¼‰ã€‚</p><p>è¿™é‡Œ<strong>æ³¨æ„</strong>ä¸€ä¸‹å‡½æ•°ä¸­çš„è­¦å‘Šä¿¡æ¯ï¼Œåœ¨å±æ€§å‘½åçš„ä¼˜å…ˆç­‰çº§ä¸Šï¼ŒVue è®¤ä¸º<code>props</code>ä¸­çš„å±æ€§ä¼˜å…ˆçº§åº”è¯¥æ¯”<code>data</code>é«˜ï¼Œè€Œ<code>data</code>çš„å±æ€§ä¼˜å…ˆçº§åº”è¯¥æ¯”<code>methods</code>é«˜ã€‚</p><p>å†çœ‹æœ€åä¸€è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// observe data</span></span><br><span class="line">observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>observe</code>å‡½æ•°ç›‘å¬<code>data</code>é€‰é¡¹ï¼ŒæŠŠ<code>data</code>é€‰é¡¹çš„æ•°æ®å˜æˆæˆå“åº”å¼æ•°æ®ã€‚è¿™é‡Œä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°ä¸º<code>true</code>ï¼Œä½œä¸ºæ ¹ç»„ä»¶çš„<code>data</code>é€‰é¡¹ã€‚</p><p>å…¶å®ï¼Œè¿™å¥ä»£ç æ‰æ˜¯å“åº”å¼ç³»ç»Ÿçš„å¼€å§‹ã€‚</p><h2 id="observe"><a href="#observe" class="headerlink" title="observe"></a><code>observe</code></h2><p>ä¸‹é¢æŸ¥çœ‹<code>observe</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™æ˜¯ç”¨äºç›‘å¬æ•°æ®çš„å‡½æ•°ã€‚</p><p>å…ˆçœ‹ä¸‹å‰é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">observe</span>(<span class="params">value: any, asRootData: ?boolean</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ! éè™šæ‹ŸèŠ‚ç‚¹çš„å¯¹è±¡</span></span><br><span class="line">  <span class="keyword">if</span> (!isObject(value) || value <span class="keyword">instanceof</span> VNode) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‡½æ•°çš„å‚æ•°ï¼Œåªæœ‰ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯éœ€è¦ç›‘å¬çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨æ¥åˆ¤æ–­ç›‘å¬çš„å¯¹è±¡æ˜¯å¦æ˜¯æ ¹ç»„ä»¶æ•°æ®ã€‚</p><p>å‡½æ•°ç¬¬ä¸€è¡Œä»£ç åˆ¤æ–­è¯­å¥å®šä¹‰äº†ç›‘å¬æ•°æ®<code>value</code>çš„ç±»å‹ï¼Œåªæœ‰æ˜¯å¯¹è±¡ç±»å‹ä¸”ä¸æ˜¯è™šæ‹ŸèŠ‚ç‚¹æ‰ç¬¦åˆè¦æ±‚ç›‘å¬çš„è¦æ±‚ï¼Œå¦‚æœä¸èƒ½åŒæ—¶æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œç›´æ¥è¿”å›ã€‚</p><p>å†çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ob: Observer | <span class="keyword">void</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! å·²ç»æ˜¯ç›‘å¬å¯¹è±¡äº†ï¼Œè·å– __ob__ï¼Œä¸éœ€è¦é‡å¤ç›‘å¬</span></span><br><span class="line"><span class="keyword">if</span> (hasOwn(value, <span class="string">'__ob__'</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">  ob = value.__ob__</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">  shouldObserve &amp;&amp; <span class="comment">// ! è¿™ä¸ªå±æ€§å¯ä»¥è‡ªç”±çš„æ§åˆ¶å¯¹è±¡æ˜¯å¦ç›‘å¬</span></span><br><span class="line">  !isServerRendering() &amp;&amp;</span><br><span class="line">  (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">  <span class="built_in">Object</span>.isExtensible(value) &amp;&amp; <span class="comment">// ! å¯¹è±¡å¯æ‰©å±•ï¼Œæ²¡æœ‰è¢« freeze</span></span><br><span class="line">  !value._isVue <span class="comment">// ! ä¸æ˜¯ Vue å®ä¾‹</span></span><br><span class="line">) &#123;</span><br><span class="line">  ob = <span class="keyword">new</span> Observer(value) <span class="comment">// ! å®ä¾‹åŒ–ä¸€ä¸ªç›‘å¬å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå£°æ˜å˜é‡<code>ob</code>ï¼Œå®ƒçš„ç±»å‹æ˜¯<code>Observer</code>æˆ–è€…<code>void</code>ã€‚</p><p>ç„¶ååˆ¤æ–­<code>value</code>å¯¹è±¡ä¸­æ˜¯å¦æœ‰<code>__ob__</code>å±æ€§ä¸”<code>__ob__</code>å¿…é¡»æ˜¯<code>Observer</code>ç±»å‹çš„ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œè¯´æ˜<code>value</code>å·²ç»æ˜¯ä¸€ä¸ªç›‘å¬çš„å¯¹è±¡ï¼Œä¸éœ€è¦å†é‡å¤ç›‘å¬ï¼ŒæŠŠ<code>value.__ob__</code>å±æ€§èµ‹å€¼ç»™<code>ob</code>å³å¯ï¼›å¦‚æœ<code>value</code>ä¸æ˜¯ç›‘å¬å¯¹è±¡ï¼Œè¿˜å¿…é¡»è¦ç¬¦åˆä¸‹é¢çš„äº”ä¸ªæ¡ä»¶ï¼Œæ‰èƒ½å»ç›‘å¬<code>value</code>å¯¹è±¡ã€‚</p><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹è¿™äº”ä¸ªæ¡ä»¶ï¼Œå¯¹è±¡<code>value</code>å¿…é¡»å…¨éƒ¨æ»¡è¶³è¿™äº”ä¸ªæ¡ä»¶æ‰èƒ½è¢«ç›‘å¬ã€‚</p><ol><li><strong><code>shouldObserve</code></strong>ï¼šè¿™æ˜¯ä¸€ä¸ªå¼€å…³ï¼Œé»˜è®¤ä¸º<code>true</code>ã€‚åœ¨æŸäº›ç‰¹æ®Šåœºæ™¯æ—¶ï¼Œå®ƒçš„å€¼ä¼šå˜æˆ<code>false</code>ï¼Œè¿™é‡Œå¿…é¡»æ˜¯<code>true</code>ï¼Œå¯ä»¥é€šè¿‡<code>toggleObserving</code>å‡½æ•°æ¥åˆ‡æ¢<code>shouldObserve</code>çš„å€¼ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„æ§åˆ¶å“ªäº›å¯¹è±¡æ˜¯å¦æ‰§è¡Œç›‘å¬ï¼Œè¿™ä¸ªæ¡ä»¶å¾ˆé‡è¦ã€‚</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * In some cases we may want to disable observation inside a component's</span></span><br><span class="line"><span class="comment"> * update computation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> shouldObserve: boolean = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">toggleObserving</span>(<span class="params">value: boolean</span>) </span>&#123;</span><br><span class="line">  shouldObserve = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p><strong><code>!isServerRendering()</code></strong>ï¼šè°ƒç”¨<code>isServerRendering</code>å‡½æ•°å¯ä»¥åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºæœåŠ¡ç«¯æ¸²æŸ“çš„ç¯å¢ƒä¸­ã€‚å¦‚æœå€¼ä¸º<code>true</code>ï¼Œè¯´æ˜å½“å‰å®¿ä¸»ç¯å¢ƒä¸æ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œä¸ç¬¦åˆç›‘å¬æ¡ä»¶ï¼Œå®ƒçš„å€¼å¿…é¡»æ˜¯<code>false</code>æ‰è¡Œã€‚</p></li><li><p><strong><code>(Array.isArray(value) || isPlainObject(value))</code></strong>ï¼šç›‘å¬çš„<code>value</code>å¿…é¡»æ˜¯æ•°ç»„æˆ–è€…æ™®é€šå¯¹è±¡ã€‚</p></li><li><p><strong><code>Object.isExtensible(value)</code></strong>ï¼šç›‘å¬çš„å¯¹è±¡å¿…é¡»æ˜¯ä¸€ä¸ªå¯æ‰©å±•çš„å€¼ã€‚ä½¿ä¸€ä¸ªå¯¹è±¡å˜æˆä¸å¯æ‰©å±•ï¼Œæœ‰ä»¥ä¸‹æ–¹æ³•ï¼š<code>Object.preventExtensions()</code>ã€<code>Object.freeze()</code> ä»¥åŠ <code>Object.seal()</code>ï¼Œç›‘å¬çš„å¯¹è±¡å¿…é¡»æ²¡æœ‰ä½¿ç”¨è¿‡è¿™äº›æ–¹æ³•ã€‚</p></li><li><p><strong><code>!value._isVue</code></strong>ï¼šç›‘å¬çš„å¯¹è±¡ä¸èƒ½æ˜¯ Vue çš„å®ä¾‹å¯¹è±¡ã€‚åœ¨æˆ‘ä»¬åˆå§‹åŒ– Vue çš„å®ä¾‹å¯¹è±¡æ—¶ä¼šæ·»åŠ ä¸€ä¸ª<code>_isVue</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œè¯´æ˜è¯¥å¯¹è±¡æ˜¯ Vue çš„å®ä¾‹å¯¹è±¡ã€‚</p></li></ol><p>åªæœ‰åŒæ—¶æ»¡è¶³äº†ä¸Šé¢çš„äº”ä¸ªæ¡ä»¶ï¼Œæ‰ä¼šè°ƒç”¨<code>new</code>æ–¹æ³•åˆ›å»ºç›‘å¬å™¨å¯¹è±¡ï¼Œåˆ›å»ºçš„æ—¶å€™éœ€è¦æŠŠç›‘å¬çš„å¯¹è±¡<code>value</code>ä¼ å…¥ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡<code>ob</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ob = <span class="keyword">new</span> Observer(value) <span class="comment">// ! å®ä¾‹åŒ–ä¸€ä¸ªç›‘å¬å¯¹è±¡</span></span><br></pre></td></tr></table></figure><h2 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a><code>Observer</code></h2><p>ä¸‹é¢çœ‹ä¸‹<code>Observer</code>ç›‘å¬å™¨çš„ä»£ç ï¼Œè¿™æ˜¯ä¸€ä¸ªç±»ï¼Œç”¨æ¥åˆ›å»ºç›‘å¬å™¨å®ä¾‹å¯¹è±¡ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  value: any</span><br><span class="line">  dep: Dep</span><br><span class="line">  vmCount: number <span class="comment">// number of vms that have this object as root $data</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(value: any) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  walk() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  observeArray() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Observer</code>ç±»æœ‰ä¸‰ä¸ªå±æ€§å’Œä¸¤ä¸ªæ–¹æ³•ï¼Œä¸‰ä¸ªå±æ€§åˆ†åˆ«æ˜¯<code>value</code>ã€<code>dep</code>å’Œ<code>vmCount</code>ï¼Œä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯<code>walk</code>å’Œ<code>observeArray</code>ã€‚</p><p>å…ˆçœ‹ä¸‹ç±»çš„æ„é€ å‡½æ•°ï¼Œçœ‹å‰é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(value: any) &#123;</span><br><span class="line"> <span class="keyword">this</span>.value = value</span><br><span class="line"><span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line"><span class="keyword">this</span>.vmCount = <span class="number">0</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆå§‹åŒ–ä¸‰ä¸ªå±æ€§çš„å€¼ï¼Œå…¶ä¸­<code>value</code>çš„å€¼æ˜¯å¼•ç”¨ä¼ è¿›æ¥çš„å‚æ•°<code>value</code>ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ç›‘å¬çš„å¯¹è±¡ã€‚</p><p><code>dep</code>æ˜¯è®¢é˜…å™¨<code>Dep</code>çš„å®ä¾‹å¯¹è±¡ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ”¶é›†ä¾èµ–ï¼ˆè§‚å¯Ÿè€…ï¼‰çš„ã€‚<code>vmCount</code>æ˜¯ç»„ä»¶æ ‡è¯†ï¼Œæ ¹ç»„ä»¶çš„åˆå§‹å€¼æ˜¯ 0ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>) <span class="comment">// ! è‡ªèº«å®ä¾‹æ·»åŠ åˆ°ç›‘å¬å¯¹è±¡çš„ __ob__ å±æ€§ä¸Š (__ob__ç›‘å¬å¯¹è±¡æ ‡è¯†)</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>def</code>å‡½æ•°å®šä¹‰ç›‘å¬çš„å¯¹è±¡<code>value</code>çš„å±æ€§<code>__ob__</code>ä¸º<code>Observer</code>å®ä¾‹å¯¹è±¡æœ¬èº«ã€‚è¿™é‡Œä½¿ç”¨äº†<strong>å¾ªç¯å¼•ç”¨</strong>ï¼Œç›‘å¬çš„å¯¹è±¡<code>value</code>ä¸­æœ‰å±æ€§<code>__ob__</code>ï¼Œå®ƒçš„å€¼æ˜¯<code>Observer</code>å®ä¾‹å¯¹è±¡ï¼Œè€Œå®ä¾‹å¯¹è±¡ä¸­ä¹Ÿæœ‰<code>value</code>å±æ€§ï¼Œå®ƒçš„å€¼å°±æ˜¯ç›‘å¬çš„å¯¹è±¡<code>value</code>ã€‚è¿™æ ·æˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä»<code>__ob__</code>å±æ€§ä¸­è·å–å®ƒç›‘å¬çš„å¯¹è±¡<code>value</code>çš„å€¼ã€‚</p><p>å®ä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">  a: <span class="number">1</span>,</span><br><span class="line">  <span class="comment">// __ob__ æ˜¯ä¸å¯æšä¸¾çš„å±æ€§</span></span><br><span class="line">  __ob__: &#123;</span><br><span class="line">    value: data, <span class="comment">// value å±æ€§æŒ‡å‘ data æ•°æ®å¯¹è±¡æœ¬èº«ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ªç¯å¼•ç”¨</span></span><br><span class="line">    dep: depå®ä¾‹å¯¹è±¡, <span class="comment">// new Dep()</span></span><br><span class="line">    vmCount: <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸‹<code>def</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">def</span>(<span class="params">obj: Object, key: string, val: any, enumerable?: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    value: val,</span><br><span class="line">    enumerable: !!enumerable,</span><br><span class="line">    writable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>def</code>å‡½æ•°å…¶å®å°±æ˜¯<code>Object.defineProperty</code>çš„ç®€å•å°è£…ï¼Œå®ƒçš„ç¬¬å››ä¸ªå‚æ•°<code>enumerable</code>æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨æ¥è®¾ç½®å®šä¹‰çš„å¯¹è±¡æ˜¯å¦å¯ä»¥æšä¸¾ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! ç›‘å¬æ•°ç»„æ—¶</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">  <span class="comment">// ! åˆ¤æ–­å½“å‰ç¯å¢ƒçš„å¯¹è±¡ä¸­æ˜¯å¦æœ‰ __proto__ å±æ€§ ï¼ˆæ˜¯å¦æ”¯æŒä½¿ç”¨ __proto__ï¼‰</span></span><br><span class="line">  <span class="keyword">if</span> (hasProto) &#123;</span><br><span class="line">    protoAugment(value, arrayMethods)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    copyAugment(value, arrayMethods, arrayKeys)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.observeArray(value) <span class="comment">// ! å†æ¬¡ç›‘å¬æ•°ç»„ï¼Œç›‘å¬ä¸€äº›åµŒå¥—çš„æ•°ç»„</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.walk(value) <span class="comment">// ! ç›‘å¬å¯¹è±¡</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ª<code>if</code>è¯­å¥ï¼Œåˆ¤æ–­ç›‘å¬çš„å¯¹è±¡çš„ç±»å‹ï¼Œå¦‚æœç›‘å¬çš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰§è¡Œ<code>if</code>ä¸­çš„ä»£ç å—ï¼Œå¦åˆ™æ‰§è¡Œ<code>else</code>ä»£ç å—ã€‚</p><p>å…ˆçœ‹<code>else</code>ä»£ç å—ï¼Œä¹Ÿå°±æ˜¯ç›‘å¬çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œè°ƒç”¨ç±»çš„<code>walk</code>æ–¹æ³•ï¼Œå¹¶æŠŠç›‘å¬çš„å¯¹è±¡<code>value</code>ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥ç›‘å¬<strong>å¯¹è±¡ç±»å‹</strong>çš„ç›‘å¬å¯¹è±¡ï¼Œå®ƒä¼šæŠŠç›‘å¬çš„å¯¹è±¡ä¸­çš„å±æ€§å˜æˆå“åº”å¼å±æ€§ã€‚</p><p>ä¸‹é¢æŸ¥çœ‹ç±»çš„<code>walk</code>æ–¹æ³•çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">walk(obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    defineReactive(obj, keys[i])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–ä¼ å…¥çš„å‚æ•°å¯¹è±¡<code>obj</code>çš„<code>keys</code>å€¼ï¼Œè¿™é‡ŒæŒ‡ç›‘å¬çš„å¯¹è±¡<code>value</code>ã€‚</p><p>ç„¶åéå†<code>keys</code>ï¼Œåœ¨æ¯æ¬¡å¾ªç¯æ—¶è°ƒç”¨äº†<code>defineReactive</code>å‡½æ•°ï¼ŒåŒæ—¶æŠŠå¯¹è±¡<code>obj</code>å’Œå®ƒçš„æ¯ä¸€ä¸ª<code>key</code>å€¼ä½œä¸ºå‚æ•°ä¼ å…¥ã€‚</p><p><code>defineReactive</code>å‡½æ•°çš„ä½œç”¨å°±æ˜¯æŠŠå¯¹è±¡<code>obj</code>ä¸­çš„æ¯ä¸€ä¸ª<code>key</code>å€¼éƒ½å˜æˆå“åº”å¼å±æ€§ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Vue æœ€æ ¸å¿ƒçš„åœ°æ–¹å°±æ˜¯å®ƒçš„å“åº”å¼ç³»ç»Ÿï¼Œè¿™æ˜¯å®ƒæœ€æ ¸å¿ƒçš„ç²¾åï¼Œä¹Ÿæ˜¯æ˜æ˜¾åŒºåˆ«äºå…¶ä»–çš„æ¡†æ¶åƒ&lt;code&gt;React&lt;/code&gt;ã€&lt;code&gt;Angular&lt;/code&gt;çš„åœ°æ–¹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç« åˆå§‹åŒ–å®ä¾‹å±æ€§çš„æ—¶å€™ï¼Œè®²è§£äº†&lt;code&gt;initState&lt;/code&gt;å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢è°ƒç”¨äº†ä¸€ç³»åˆ—åˆå§‹åŒ–é€‰é¡¹çš„å‡½æ•°ï¼Œä¸ºå®ä¾‹å¯¹è±¡&lt;code&gt;vm&lt;/code&gt;åˆå§‹åŒ–äº†å¾ˆå¤šå±æ€§ï¼Œè¿™äº›å±æ€§å¤§éƒ½æ˜¯å’Œå“åº”å¼ç³»ç»Ÿç›¸å…³çš„ã€‚æœ¬ç« ä¸»è¦å›´ç»•&lt;code&gt;initData&lt;/code&gt;å‡½æ•°æ¥è¿›è¡Œï¼Œå› ä¸ºåˆå§‹åŒ–&lt;code&gt;data&lt;/code&gt;é€‰é¡¹å‡ ä¹æ¶‰åŠåˆ°äº†å“åº”å¼ç³»ç»Ÿçš„å…¨éƒ¨å†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆçœ‹ä¸‹&lt;code&gt;initData&lt;/code&gt;å‡½æ•°åœ¨&lt;code&gt;initState&lt;/code&gt;å‡½æ•°ä¸­çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (opts.data) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  initData(vm)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  observe((vm._data = &amp;#123;&amp;#125;), &lt;span class=&quot;literal&quot;&gt;true&lt;/span&gt; &lt;span class=&quot;comment&quot;&gt;/* asRootData */&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;åˆ¤æ–­&lt;code&gt;opts&lt;/code&gt;ä¸­æ˜¯å¦æœ‰&lt;code&gt;data&lt;/code&gt;å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œè°ƒç”¨&lt;code&gt;initData&lt;/code&gt;å‡½æ•°åˆå§‹åŒ–&lt;code&gt;data&lt;/code&gt;é€‰é¡¹ã€‚&lt;/p&gt;
&lt;p&gt;å¦‚æœæ²¡æœ‰çš„è¯ï¼ŒæŠŠå®ä¾‹å¯¹è±¡çš„ç§æœ‰å±æ€§&lt;code&gt;_data&lt;/code&gt;è®¾ç½®ç©ºå¯¹è±¡ï¼Œå¹¶è°ƒç”¨&lt;code&gt;observe&lt;/code&gt;å‡½æ•°ç›‘å¬è¿™ä¸ªç©ºå¯¹è±¡ã€‚&lt;/p&gt;
&lt;p&gt;å…¶å®ï¼ŒVue è¿˜å¯¹å¤–æä¾›äº†&lt;code&gt;$data&lt;/code&gt; å±æ€§è®©æˆ‘ä»¬è·å–&lt;code&gt;data&lt;/code&gt;çš„å€¼ï¼Œè€Œ&lt;code&gt;$data&lt;/code&gt;ä»£ç†çš„å°±æ˜¯&lt;code&gt;_data&lt;/code&gt;çš„å€¼ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹å®ä¾‹åŒ–</title>
    <link href="https://haledeng.com/blog/20190906-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%AE%9E%E4%BE%8B%E5%8C%96/"/>
    <id>https://haledeng.com/blog/20190906-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%AE%9E%E4%BE%8B%E5%8C%96/</id>
    <published>2019-09-06T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:35.665Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨å‰é¢æˆ‘ä»¬è®²è§£ Vue çš„å®ä¾‹åŒ–æ—¶ï¼Œå•ç‹¬ç”¨äº†ä¸¤ç« è®²è§£ Vue çš„é€‰é¡¹åˆå¹¶çš„å†…å®¹ï¼Œä¸‹é¢å¼€å§‹çœŸæ­£å­¦ä¹  Vue çš„å®ä¾‹åŒ–ã€‚</p><p>ç»§ç»­çœ‹<code>_init</code>å‡½æ•°ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æ–‡ä»¶<code>core/instance/init.js</code>ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="comment">// ! åˆå§‹åŒ–ä»£ç†</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  initProxy(vm)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  vm._renderProxy = vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‰é¢è®²è§£ä¸­åªæ˜¯æåˆ°åœ¨éç”Ÿäº§ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ä»£ç å®ç°ç»“æœå¿…é¡»ä¸€è‡´ï¼Œæ‰€ä»¥<code>initProxy</code>çš„å‡½æ•°çš„ä½œç”¨åº”è¯¥ä¸ºå®ä¾‹å¯¹è±¡<code>vm</code>æ·»åŠ å±æ€§<code>_renderProxy</code>ä¸º<code>vm</code>ã€‚çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿ</p><a id="more"></a><h2 id="initProxy"><a href="#initProxy" class="headerlink" title="initProxy"></a><code>initProxy</code></h2><p>æŸ¥çœ‹ä¸‹<code>initProxy</code> çš„ä»£ç ï¼Œåœ¨<code>core/instance/proxy.js</code>ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> initProxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  initProxy = <span class="function"><span class="keyword">function</span> <span class="title">initProxy</span>(<span class="params">vm</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hasProxy) &#123;</span><br><span class="line">      <span class="comment">// determine which proxy handler to use</span></span><br><span class="line">      <span class="keyword">const</span> options = vm.$options</span><br><span class="line">      <span class="keyword">const</span> handlers =</span><br><span class="line">        options.render &amp;&amp; options.render._withStripped ? getHandler : hasHandler</span><br><span class="line">      vm._renderProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(vm, handlers) <span class="comment">// ! ä½¿ç”¨ä»£ç†</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      vm._renderProxy = vm <span class="comment">// ! å’Œç”Ÿäº§ç¯å¢ƒä¸€æ ·ç›´æ¥èµ‹å€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¿…é¡»æ˜¯åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå…ˆåˆ¤æ–­å®¿ä¸»ç¯å¢ƒï¼ˆè¿™é‡Œéƒ½æŒ‡æµè§ˆå™¨ï¼‰æ˜¯å¦æ”¯æŒ<code>Proxy</code>è¯­æ³•ï¼Œå¦‚æœä¸æ”¯æŒï¼Œé‚£ä¹ˆå°±å’Œç”Ÿäº§ç¯å¢ƒä¸€æ ·ï¼Œç›´æ¥èµ‹å€¼<code>_renderProxy</code>ä¸º<code>vm</code>ã€‚</p><p>å¦‚æœæ”¯æŒï¼Œé¦–å…ˆå£°æ˜å˜é‡<code>options</code>å­˜å‚¨åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ï¼Œ<strong>ç°åœ¨åˆå§‹åŒ–å®ä¾‹çš„å„ç±»å±æ€§æ–¹æ³•éƒ½å’Œé€‰é¡¹<code>options</code>ç›¸å…³</strong>ã€‚</p><p>ç„¶åå£°æ˜å¸¸é‡<code>handlers</code>å­˜å‚¨ä»£ç†ä½¿ç”¨çš„å¤„ç†å™¨ï¼Œæœ€åä½¿ç”¨<code>new</code>åˆ›å»ºä¸€ä¸ª<code>Proxy</code>å®ä¾‹å¯¹è±¡ï¼Œç”¨<code>_renderProxy</code>å±æ€§æ¥ä»£ç†å®ä¾‹å¯¹è±¡<code>vm</code>ï¼Œå¹¶ä¸”ä¼ å…¥<code>handlers</code>ã€‚</p><p><code>handlers</code>æœ‰ä¸¤ä¸ªå€¼ï¼Œåˆ†åˆ«æ˜¯<code>getHandler</code> å’Œ<code>hasHandler</code>ã€‚éœ€è¦é€šè¿‡æ¡ä»¶åˆ¤æ–­æ¥è·å–ï¼Œè€Œæ¡ä»¶è¯­å¥ä¸­çš„<code>options.render._withStripped</code>åªæœ‰åœ¨æµ‹è¯•ç¯å¢ƒä¸­æ‰ä¼šå‡ºç°ã€‚æ‰€ä»¥<code>handlers</code>ä¸€èˆ¬éƒ½æ˜¯æŒ‡<code>hasHandler</code>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>hasHandler</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hasHandler = &#123;</span><br><span class="line">  has(target, key) &#123;</span><br><span class="line">    <span class="keyword">const</span> has = key <span class="keyword">in</span> target</span><br><span class="line">    <span class="keyword">const</span> isAllowed =</span><br><span class="line">      allowedGlobals(key) ||</span><br><span class="line">      (<span class="keyword">typeof</span> key === <span class="string">'string'</span> &amp;&amp;</span><br><span class="line">        key.charAt(<span class="number">0</span>) === <span class="string">'_'</span> &amp;&amp;</span><br><span class="line">        !(key <span class="keyword">in</span> target.$data))</span><br><span class="line">    <span class="keyword">if</span> (!has &amp;&amp; !isAllowed) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> target.$data) warnReservedPrefix(target, key)</span><br><span class="line">      <span class="keyword">else</span> warnNonPresent(target, key)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> has || !isAllowed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>hasHandler</code>æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸»è¦æ‹¦æˆªäº†ä»£ç†å¯¹è±¡<code>vm</code>çš„<code>has</code>ç›¸å…³å±æ€§ï¼Œæ¯”å¦‚æ‹¦æˆª<code>in</code>æ“ä½œç¬¦ï¼Œè¿˜æœ‰<code>with</code>å‡½æ•°ï¼Œå…ˆçœ‹å…·ä½“çš„ä»£ç é€»è¾‘ã€‚</p><p>é¦–å…ˆï¼Œè·å–å£°æ˜å¸¸é‡<code>has</code>å­˜å‚¨<code>key in target</code>è¿è¡Œçš„ç»“æœï¼Œç„¶åå£°æ˜å˜é‡<code>isAllowed</code>ï¼Œè¿™ä¸ªå˜é‡æ˜¯åˆ¤æ–­å±æ€§<code>key</code>æ˜¯å¦å…è®¸è®¿é—®ã€‚åªæœ‰<code>key</code>æ˜¯å…¨å±€è®¿é—® API æ—¶æˆ–è€…æ˜¯ä»¥<code>_</code>å¼€å¤´ä½†ä¸æ˜¯åœ¨<code>data</code>é€‰é¡¹ä¸­çš„ Vue çš„å±æ€§æ—¶ï¼Œ<code>isAllowed</code>æ‰ä¸º<code>true</code>ã€‚</p><p>å¦‚æœ<code>has</code>å’Œ<code>isAllowed</code>éƒ½ä¸ä¸ºçœŸï¼Œè¿˜éœ€è¦åˆ¤æ–­<code>key</code>æ˜¯å¦æ˜¯<code>data</code>é€‰é¡¹ä¸Šçš„å±æ€§ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä¼šæé†’ä»¥ <code>_</code> æˆ– <code>$</code> å¼€å¤´çš„å±æ€§ <strong>ä¸ä¼š</strong> è¢« Vue çš„å®ä¾‹å¯¹è±¡ä»£ç†ï¼Œå› ä¸ºä½¿ç”¨<code>_</code> æˆ– <code>$</code> å¼€å¤´çš„å±æ€§å¯èƒ½ä¼šå’Œ Vue çš„å†…ç½®å±æ€§æˆ–è€…æ–¹æ³•çš„åç§°å†²çªã€‚å¦‚æœä¸æ˜¯çš„è¯ï¼Œä¼šæé†’åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨äº†<code>key</code>å€¼ï¼Œä½†æ˜¯åœ¨å®ä¾‹å¯¹è±¡ä¸­å¹¶æ²¡æœ‰å®šä¹‰è¿™ä¸ªå€¼ã€‚</p><p>æœ€åè¿”å› <code>has || !isAllowed</code>ï¼Œå³åªæœ‰<code>has</code>ä¸ºå‡ä¸”<code>isAllowed</code>ä¸ºçœŸæ—¶æ‰ä¼šè¾“å‡º<code>false</code>ï¼Œå…¶ä»–æƒ…å†µéƒ½è¾“å…¥<code>true</code>ã€‚</p><p>ä¸¾ä¸€ä¸ª<strong>ä¾‹å­</strong>ï¼Œå‡å¦‚è®¿é—®ä¸€ä¸ªæ²¡æœ‰å®šä¹‰åœ¨å®ä¾‹å¯¹è±¡ä¸Š(æˆ–åŸå‹é“¾ä¸Š)çš„å±æ€§çš„å±æ€§æ—¶ï¼ˆæ»¡è¶³ <code>!has</code>ä¸º <code>true</code>ï¼‰ã€‚</p><p>æ­¤æ—¶å¦‚æœè¿™ä¸ªå±æ€§è¿˜æ˜¯å…¨å±€å±æ€§æ—¶ï¼ˆæ»¡è¶³<code>!isAllowed</code>ä¸º<code>false</code>ï¼‰ï¼Œå°±ä¸ä¼šæŠ¥é”™ï¼Œä¸ä¼šæ‰§è¡Œé‚£ä¸¤ä¸ª<code>warn</code>å‡½æ•°ï¼Œä½†æ˜¯æœ€åä¼šè¾“å‡º<code>false</code>ï¼Œå³<code>key in target</code>çš„å€¼ä¸º<code>false</code>ï¼Œè¯´æ˜å±æ€§ä¸åœ¨<code>taregt</code>ä¸Šã€‚</p><p>ä½†æ˜¯å¦‚æœè¿™ä¸ªå±æ€§ä¸æ˜¯å…¨å±€å±æ€§å°±ä¼šæŠ¥é”™ï¼Œå³æ»¡è¶³äº†<code>!has &amp;&amp; ï¼isAllowed</code>çš„æ¡ä»¶ï¼Œæœ€åè¾“å‡º<code>true</code>ï¼Œå³<code>key in target</code>çš„å€¼ä¸º<code>true</code>ï¼Œè¯´æ˜å±æ€§åœ¨<code>taregt</code>ä¸Šã€‚</p><p>è¯´äº†é‚£ä¹ˆå¤šï¼Œ<strong>ä¸ºä»€ä¹ˆåœ¨éç”Ÿäº§ç¯å¢ƒæ—¶éœ€è¦ä½¿ç”¨ä»£ç†</strong>å‘¢ï¼Ÿè€Œç”Ÿäº§ç¯å¢ƒå°±ä¸éœ€è¦å‘¢ï¼Ÿå®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å—ï¼Ÿ</p><p>å…ˆçœ‹ä¸‹åœ¨å®ä¾‹çš„æ¸²æŸ“å‡½æ•°<code>__render</code>æœ‰è¿™æ ·ä¸€è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æ¸²æŸ“è™šæ‹Ÿ Nodeï¼Œ ä¼ å…¥ vm.$createElement æ–¹æ³•</span></span><br><span class="line">vnode = render.call(vm._renderProxy, vm.$createElement)</span><br></pre></td></tr></table></figure><p>åœ¨æ¸²æŸ“æ—¶æŒ‡å‘äº†æˆ‘ä»¬çš„ä»£ç†<code>_renderProxy</code>ï¼Œå†çœ‹ä¸‹é€‰é¡¹ä¸­çš„æ¸²æŸ“å‡½æ•°<code>vm.$options.render</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vm.$options.render = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// render å‡½æ•°çš„ this æŒ‡å‘å®ä¾‹çš„ _renderProxy</span></span><br><span class="line">  <span class="keyword">with</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> _c(<span class="string">'div'</span>, [_v(_s(a))]) <span class="comment">// åœ¨è¿™é‡Œè®¿é—® aï¼Œç›¸å½“äºè®¿é—® vm._renderProxy.a</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¯ä»¥å‘ç°ï¼Œæ˜¾ç„¶å‡½æ•°ä½¿ç”¨ <code>with</code> è¯­å¥å—æŒ‡å®šäº†å†…éƒ¨ä»£ç çš„æ‰§è¡Œç¯å¢ƒä¸º <code>this</code>ï¼Œç”±äº <code>render</code> å‡½æ•°è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨ <code>call</code> æŒ‡å®šäº†å…¶ <code>this</code> æŒ‡å‘ä¸º <code>vm._renderProxy</code>ï¼Œæ‰€ä»¥ <code>with</code> è¯­å¥å—å†…ä»£ç çš„æ‰§è¡Œç¯å¢ƒå°±æ˜¯ <code>vm._renderProxy</code>ï¼Œæ‰€ä»¥åœ¨ <code>with</code> è¯­å¥å—å†…è®¿é—®<code>a</code>å°±ç›¸å½“äºè®¿é—®<code>vm._renderProxy</code>çš„ <code>a</code> å±æ€§ï¼Œå‰é¢æˆ‘ä»¬æåˆ°è¿‡ <code>with</code> è¯­å¥å—å†…è®¿é—®å˜é‡å°†ä¼šè¢«<code>Proxy</code>çš„<code>has</code>ä»£ç†æ‰€æ‹¦æˆªï¼Œæ‰€ä»¥è‡ªç„¶å°±æ‰§è¡Œäº† <code>has</code> å‡½æ•°å†…çš„ä»£ç ã€‚æœ€ç»ˆé€šè¿‡<code>warnNonPresent</code>æ‰“å°è­¦å‘Šä¿¡æ¯ç»™æˆ‘ä»¬ã€‚</p><p>æ‰€ä»¥ä½¿ç”¨ä»£ç†çš„ä½œç”¨å°±æ˜¯<strong>ä¸ºäº†åœ¨å¼€å‘é˜¶æ®µç»™æˆ‘ä»¬ä¸€ä¸ªå‹å¥½è€Œå‡†ç¡®çš„æç¤º</strong>ã€‚</p><h2 id="Initial-Function"><a href="#Initial-Function" class="headerlink" title="Initial Function"></a>Initial Function</h2><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// expose real self</span></span><br><span class="line">vm._self = vm</span><br><span class="line">initLifecycle(vm) <span class="comment">// ! åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³å±æ€§ å­˜å‚¨æœ¬èº«å®ä¾‹åˆ°çˆ¶èŠ‚ç‚¹ æ–°å¢å±æ€§ $parent $root $children $refs ç­‰</span></span><br><span class="line">initEvents(vm) <span class="comment">// ! åˆå§‹åŒ–äº‹ä»¶ç›¸å…³å±æ€§ æ›´æ–° listeners</span></span><br><span class="line">initRender(vm) <span class="comment">// ! åˆå§‹åŒ–æ¸²æŸ“ç›¸å…³å±æ€§, åˆ›å»ºVNode å¦æ–°å¢å±æ€§ $attrs å’Œ $listeners</span></span><br><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>) <span class="comment">// ! è°ƒç”¨ beforeCreate é’©å­å‡½æ•°</span></span><br><span class="line">initInjections(vm) <span class="comment">// ! åˆå§‹åŒ– injections é€‰é¡¹ï¼Œå¿…é¡»åœ¨åˆå§‹åŒ–çŠ¶æ€ä¹‹å‰</span></span><br><span class="line">initState(vm) <span class="comment">// ! åˆå§‹åŒ–çŠ¶æ€ æŒ‰é¡ºåº props =&gt; methods =&gt; data =&gt; computed  =&gt; watch</span></span><br><span class="line">initProvide(vm) <span class="comment">// ! åˆå§‹åŒ– Provide resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>) <span class="comment">// ! è°ƒç”¨ created é’©å­å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>æŠŠå®ä¾‹å¯¹è±¡èµ‹å€¼åˆ°<code>_self</code>å±æ€§ä¸­ï¼Œè¿™ä¸ªå±æ€§å’Œ<code>_renderProxy</code>å±æ€§æœ‰ç‚¹ç›¸ä¼¼ï¼Œéƒ½æ˜¯èµ‹å€¼ä¸ºå®ä¾‹å¯¹è±¡ã€‚</p><p>ä½†æ˜¯å®ƒä»¬çš„ç”¨é€”å¹¶ä¸ç›¸åŒï¼Œè€Œä¸”<code>_renderProxy</code>çš„å€¼åœ¨æ”¯æŒ<code>proxy</code>çš„å®¿ä¸»ç¯å¢ƒæ—¶æ˜¯ä¸€ä¸ªä»£ç†å¯¹è±¡ã€‚</p><p>ç„¶åè°ƒç”¨ä¸€ç³»åˆ—çš„åˆå§‹åŒ–å‡½æ•°æ¥åˆå§‹åŒ–å®ä¾‹å¯¹è±¡ï¼Œ<strong>æ³¨æ„ï¼šè¿™äº›å‡½æ•°åœ¨è°ƒç”¨æ—¶éƒ½éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡<code>vm</code></strong>ã€‚</p><h3 id="initLifecycle"><a href="#initLifecycle" class="headerlink" title="initLifecycle"></a><code>initLifecycle</code></h3><p>æŸ¥çœ‹<code>initLifecycle</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³çš„å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initLifecycle</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> options = vm.$options</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯å£°æ˜å˜é‡<code>options</code>å­˜å‚¨åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ã€‚</p><p>ç„¶åæ˜¯ä¸‹é¢è¿™æ®µä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// locate first non-abstract parent</span></span><br><span class="line"><span class="keyword">let</span> parent = options.parent</span><br><span class="line"><span class="keyword">if</span> (parent &amp;&amp; !options.abstract) &#123;</span><br><span class="line">  <span class="comment">// ! æŸ¥æ‰¾ç¬¬ä¸€ä¸ªéæŠ½è±¡çš„çˆ¶ç»„ä»¶</span></span><br><span class="line">  <span class="keyword">while</span> (parent.$options.abstract &amp;&amp; parent.$parent) &#123;</span><br><span class="line">    parent = parent.$parent</span><br><span class="line">  &#125;</span><br><span class="line">  parent.$children.push(vm) <span class="comment">// ! æŠŠå®ä¾‹å­˜å‚¨åˆ°çˆ¶ç»„ä»¶é‡Œé¢</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vm.$parent = parent <span class="comment">// ! æ·»åŠ çˆ¶ç»„ä»¶å±æ€§ $parent</span></span><br><span class="line">vm.$root = parent ? parent.$root : vm <span class="comment">// ! æ–°å¢å±æ€§ $root</span></span><br></pre></td></tr></table></figure><p>å£°æ˜å˜é‡<code>parent</code>å­˜å‚¨<code>options</code>çš„çˆ¶ç»„ä»¶<code>parent</code>ã€‚ç„¶åä½¿ç”¨<code>if</code>è¯­å¥é€šè¿‡å¾ªç¯æŸ¥æ‰¾ï¼Œå¾€ç»„ä»¶æ ‘ä¸Šä¸€å±‚å±‚çš„å¯»æ‰¾çˆ¶ç»„ä»¶<code>parent</code>ï¼Œå¦‚æœ<code>parent</code>çš„é€‰é¡¹ä¸­æœ‰<code>abstract</code>å±æ€§ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç»„ä»¶ï¼Œä¸æ»¡è¶³è¦æ±‚ï¼Œç»§ç»­å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°é€‰é¡¹ä¸­æ²¡æœ‰<code>abstract</code>å±æ€§çš„çˆ¶ç»„ä»¶ä¸ºæ­¢ï¼Œç„¶åæŠŠå½“å‰çš„å®ä¾‹å¯¹è±¡å­˜å‚¨åˆ°çˆ¶ç»„ä»¶çš„<code>$children</code>å±æ€§ä¸­ï¼Œå»ºç«‹çˆ¶å­å…³ç³»ã€‚</p><p>ä»€ä¹ˆæ˜¯<strong>æŠ½è±¡ç»„ä»¶</strong>å‘¢ï¼ŸæŠ½è±¡ç»„ä»¶å°±æ˜¯ä¸ä¼šè¢«æ¸²æŸ“æˆçœŸå® DOM çš„ç»„ä»¶ï¼Œæ¯”å¦‚<code>keep-alive</code>ã€<code>translation</code>ç­‰å†…ç½®ç»„ä»¶ï¼Œå®ƒä»¬æ˜¯å…·æœ‰ç‰¹æ®Šä½œç”¨çš„ç»„ä»¶ï¼Œä¸ä¼šè¢«æ¸²æŸ“æˆçœŸå® DOMã€‚</p><p>æŠ½è±¡ç»„ä»¶è¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯<strong>ä¸ä¼šå‡ºç°åœ¨çˆ¶å­å…³ç³»çš„è·¯å¾„ä¸­</strong>ã€‚æ¯”å¦‚ç»„ä»¶<code>compA</code>æœ‰å­ç»„ä»¶<code>compB</code>ï¼Œå­ç»„ä»¶<code>compB</code>åˆæœ‰å­ç»„ä»¶<code>compC</code>ï¼Œä½†æ˜¯ç»„ä»¶<code>compB</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç»„ä»¶ï¼Œé‚£ä¹ˆ<code>compC</code>çš„çˆ¶ç»„ä»¶å°±ä¸æ˜¯<code>compB</code>ï¼Œè€Œæ˜¯<code>compA</code>ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ª<strong>é—®é¢˜</strong>ï¼šå°±æ˜¯<code>options.parent</code>æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Ÿæˆ‘ä»¬åªçŸ¥é“åˆå¹¶åçš„é€‰é¡¹æ˜¯<code>vm.$options</code> ï¼Œé‚£ä¹ˆé€‰é¡¹ä¸­çš„<code>parent</code>å±æ€§æ˜¯ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ä¹‹å‰çš„ç»„ä»¶çš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰è®¾ç½®è¿™ä¸ª<code>parent</code>å±æ€§ã€‚å…¶å®ï¼Œè¿™æ˜¯ Vue è®¾ç½®çš„ï¼Œæ˜¯ Vue <strong>è‡ªåŠ¨ç»™å®ä¾‹å¯¹è±¡æ·»åŠ äº†çˆ¶ç»„ä»¶</strong><code>parent</code>ï¼Œå…·ä½“å¦‚ä½•å®ç°è‡ªåŠ¨æ·»åŠ çˆ¶ç»„ä»¶ï¼Œè¿™é‡Œæš‚æ—¶ä¸è®²è§£ã€‚</p><p>ç„¶åæŠŠçˆ¶ç»„ä»¶èµ‹å€¼ç»™å®ä¾‹å¯¹è±¡çš„<code>$parent</code>å±æ€§ï¼Œå†æ–°å¢ä¸€ä¸ªå±æ€§<code>$root</code>ï¼Œå¦‚æœå­˜åœ¨çˆ¶ç»„ä»¶å°±æŠŠçˆ¶ç»„ä»¶çš„<code>$root</code>èµ‹å€¼ç»™è¿™ä¸ªå±æ€§ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±èµ‹å€¼ä¸ºå®ä¾‹å¯¹è±¡æœ¬èº«ã€‚è¿™ä¸ªå±æ€§æ˜¯ç”¨æ¥å­˜å‚¨æ ¹ç»„ä»¶ã€‚å¦‚æœå®ä¾‹å¯¹è±¡æœ‰çˆ¶ç»„ä»¶å°±å­˜å‚¨çˆ¶ç»„ä»¶çš„æ ¹ç»„ä»¶ï¼Œæ²¡æœ‰çˆ¶ç»„ä»¶è¯´æ˜è¿™ä¸ªå®ä¾‹å¯¹è±¡å°±æ˜¯æ ¹ç»„ä»¶ï¼Œä¿å­˜å®ä¾‹å¯¹è±¡æœ¬èº«å³å¯ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vm.$children = []</span><br><span class="line">vm.$refs = &#123;&#125;</span><br><span class="line"></span><br><span class="line">vm._watcher = <span class="literal">null</span></span><br><span class="line">vm._inactive = <span class="literal">null</span></span><br><span class="line">vm._directInactive = <span class="literal">false</span></span><br><span class="line">vm._isMounted = <span class="literal">false</span></span><br><span class="line">vm._isDestroyed = <span class="literal">false</span></span><br><span class="line">vm._isBeingDestroyed = <span class="literal">false</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œåˆå§‹åŒ–ä¸€äº›å®ä¾‹å±æ€§çš„å€¼ï¼Œå…¶ä¸­æœ‰æˆ‘ä»¬ç†Ÿæ‚‰çš„å­ç»„ä»¶æ•°ç»„<code>$children</code>ï¼Œè¿˜æœ‰å¼•ç”¨å…ƒç´ æˆ–è€…ç»„ä»¶çš„é›†åˆå¯¹è±¡<code>$refs</code>ã€‚</p><p><strong>æ³¨æ„</strong>ï¼ŒVue çš„å®ä¾‹å¯¹è±¡é‡Œ<strong>ä»¥<code>$</code>å¼€å¤´çš„å±æ€§æ˜¯æš´éœ²ç»™ç”¨æˆ·ä½¿ç”¨çš„ï¼Œè€Œä»¥<code>_</code>å¼€å¤´çš„å±æ€§æ˜¯ Vue çš„ç§æœ‰å±æ€§ï¼Œä¸ä¼šæš´éœ²ç»™ç”¨æˆ·</strong>ï¼Œè¿™ä¸¤ç±»å±æ€§éƒ½å±äº Vue çš„å†…ç½®å±æ€§ï¼Œæ‰€ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„å±æ€§ä¸èƒ½ä»¥<code>$</code>æˆ–è€…<code>_</code>å¼€å¤´ï¼Œå¦åˆ™ä¸ä¼šä»£ç†åˆ°å®ä¾‹å¯¹è±¡ä¸­ï¼Œè¿™æ ·ä¸ºäº†é˜²æ­¢å’Œ Vue çš„å†…ç½®å±æ€§åå†²çªã€‚</p><h3 id="initEvents"><a href="#initEvents" class="headerlink" title="initEvents"></a><code>initEvents</code></h3><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>initEvents</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°åˆå§‹åŒ–äº‹ä»¶ç›¸å…³çš„å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initEvents</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._events = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  vm._hasHookEvent = <span class="literal">false</span></span><br><span class="line">  <span class="comment">// init parent attached events</span></span><br><span class="line">  <span class="keyword">const</span> listeners = vm.$options._parentListeners</span><br><span class="line">  <span class="keyword">if</span> (listeners) &#123;</span><br><span class="line">    updateComponentListeners(vm, listeners)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ·»åŠ äº†ä¸¤ä¸ªå®ä¾‹å±æ€§<code>_events</code>å’Œ<code>_hasHookEvent</code>ï¼Œ<code>_events</code>åˆå§‹å€¼ä¸€ä¸ªæ²¡æœ‰åŸå‹å¯¹è±¡çš„ç©ºå¯¹è±¡ï¼Œè€Œ<code>_hasHookEvent</code>åˆå§‹å€¼ä¸º<code>false</code>ã€‚</p><p>ç„¶åæ˜¯å£°æ˜å˜é‡<code>listeners</code>å­˜å‚¨<code>vm.$options._parentListeners</code>ï¼Œå†åˆ¤æ–­è¿™ä¸ª<code>listeners</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œè°ƒç”¨<code>updateComponentListeners</code>å¹¶ä¼ å…¥<code>vm</code>å’Œ<code>listeners</code>æ›´æ–°ç»„ä»¶çš„<code>linsteners</code>ã€‚</p><p>æˆ‘ä»¬ç°åœ¨è¿˜ä¸çŸ¥é“<code>_parentListeners</code>æ˜¯ä»å“ªé‡Œæ¥çš„ï¼Œè¿™é‡Œå…ˆä¸ç®¡ã€‚</p><h3 id="initRender"><a href="#initRender" class="headerlink" title="initRender"></a><code>initRender</code></h3><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>initRender</code> å‡½æ•°çš„ä»£ç ï¼Œè¿™ä¸ªå‡½æ•°åˆå§‹åŒ–æ¸²æŸ“ç›¸å…³çš„å±æ€§ã€‚</p><p>å…ˆçœ‹ä¸‹å‡½æ•°å‰é¢çš„å‡ è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initRender</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._vnode = <span class="literal">null</span> <span class="comment">// the root of the child tree</span></span><br><span class="line">  vm._staticTrees = <span class="literal">null</span> <span class="comment">// v-once cached trees</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆï¼Œæ·»åŠ äº†ä¸¤ä¸ªå®ä¾‹å±æ€§<code>_vnode</code> å’Œ<code>_staticTrees</code> ï¼Œå®ƒä»¬çš„åˆå§‹å€¼éƒ½æ˜¯<code>null</code>ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = vm.$options</span><br><span class="line"><span class="keyword">const</span> parentVnode = (vm.$vnode = options._parentVnode) <span class="comment">// the placeholder node in parent tree</span></span><br><span class="line"><span class="keyword">const</span> renderContext = parentVnode &amp;&amp; parentVnode.context</span><br><span class="line">vm.$slots = resolveSlots(options._renderChildren, renderContext)</span><br><span class="line">vm.$scopedSlots = emptyObject</span><br></pre></td></tr></table></figure><p>è¿˜æ˜¯å£°æ˜å˜é‡<code>options</code>å­˜å‚¨åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ï¼Œç„¶åå†æ¬¡ä¸ºå®ä¾‹å¯¹è±¡æ·»åŠ ä¸‰ä¸ªå®ä¾‹å±æ€§<code>$vnode</code>ã€``$slots<code>å’Œ</code>$scopedSlots<code>ã€‚è¿™é‡Œæš‚æ—¶å…ˆä¸å»ç®¡ä¸Šé¢ä»£ç ä¸­</code>options._parentVnode<code>å’Œ</code>options._renderChildren`æ˜¯æ€ä¹ˆæ¥çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vm._c = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">false</span>) <span class="comment">// ! ç¼–è¯‘å™¨æ¸²æŸ“æ¨¡æ¿çš„æ¸²æŸ“æ–¹æ³•</span></span><br><span class="line">vm.$createElement = <span class="function">(<span class="params">a, b, c, d</span>) =&gt;</span> createElement(vm, a, b, c, d, <span class="literal">true</span>) <span class="comment">// ! ç”¨æˆ·æ‰‹å†™ä»£ç çš„æ¸²æŸ“æ–¹æ³•</span></span><br></pre></td></tr></table></figure><p>æ–°å¢ä¸¤ä¸ªå®ä¾‹æ–¹æ³•<code>_c</code>å’Œ<code>$createElement</code>ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½è°ƒç”¨äº†<code>createElement</code>å‡½æ•°ï¼Œè€Œä¸”è°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°ä¸ªæ•°ä¹Ÿæ˜¯ç›¸åŒï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ä¼ å…¥çš„ç¬¬å…­ä¸ªå‚æ•°<code>alwaysNormalize</code>çš„å€¼ä¸åŒï¼Œ<code>_c</code>ä¼ å…¥çš„æ˜¯<code>false</code>ï¼Œ<code>$createElement</code>ä¼ å…¥çš„<code>true</code>ã€‚è¿™é‡Œå…ˆè¯´æ˜ä¸‹<code>_c</code>æ–¹æ³•æ˜¯ç¼–è¯‘å™¨æ¸²æŸ“æ¨¡æ¿çš„æ¸²æŸ“æ–¹æ³•ï¼Œè€Œ<code>$createElement</code>æ˜¯ç”¨æˆ·æ‰‹å†™ä»£ç æ—¶çš„æ¸²æŸ“æ–¹æ³•ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬æ‰‹å†™<code>render</code>å‡½æ•°çš„æ—¶å€™ï¼Œç¼–å†™ä¸‹é¢ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  render(createElement) &#123;</span><br><span class="line">    <span class="keyword">return</span> createElement(<span class="string">'h1'</span>, <span class="string">'hello'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ¢æˆ<code>$createElement</code>æ¥å†™çš„è¯ï¼Œæ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.$createElement(<span class="string">'h1'</span>, <span class="string">'hello'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹æœ€åå‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> parentData = parentVnode &amp;&amp; parentVnode.data</span><br><span class="line"></span><br><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  defineReactive(</span><br><span class="line">    vm,</span><br><span class="line">    <span class="string">'$attrs'</span>,</span><br><span class="line">    (parentData &amp;&amp; parentData.attrs) || emptyObject,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">  defineReactive(</span><br><span class="line">    vm,</span><br><span class="line">    <span class="string">'$listeners'</span>,</span><br><span class="line">    options._parentListeners || emptyObject,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$listeners is readonly.`</span>, vm)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  defineReactive(</span><br><span class="line">    vm,</span><br><span class="line">    <span class="string">'$attrs'</span>,</span><br><span class="line">    (parentData &amp;&amp; parentData.attrs) || emptyObject,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">  defineReactive(</span><br><span class="line">    vm,</span><br><span class="line">    <span class="string">'$listeners'</span>,</span><br><span class="line">    options._parentListeners || emptyObject,</span><br><span class="line">    <span class="literal">null</span>,</span><br><span class="line">    <span class="literal">true</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç ä¸­æ–°å¢å®ä¾‹å¯¹è±¡å±æ€§<code>$attrs</code>å’Œ<code>$listeners</code>ï¼Œä½¿ç”¨<code>defineReactive</code>å‡½æ•°æ¥å®šä¹‰å±æ€§ï¼Œ<code>defineReactive</code>åœ¨åé¢è®²å“åº”å¼ç³»ç»Ÿæ—¶ä¼šåˆ†æï¼Œå®ƒçš„ä½œç”¨æ˜¯ä½¿å¯¹è±¡çš„<code>key</code>å€¼å˜æˆå“åº”å¼çš„å±æ€§ã€‚</p><p>æ ¹æ® Node ç¯å¢ƒä¸åŒï¼Œåœ¨ä¼ å…¥<code>defineReactive</code>å‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°ä¹Ÿä¸åŒï¼Œè¿™ä¸ªå‚æ•°æ˜¯<code>customSetter</code>ï¼Œæ˜¯ä¸€ä¸ªè‡ªå®šä¹‰<code>setter</code>å‡½æ•°ï¼Œæ˜¯å¯é€‰çš„ã€‚</p><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼ å…¥çš„æ˜¯ä¸‹é¢è¿™ä¸ªå‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">;<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  !isUpdatingChildComponent &amp;&amp; warn(<span class="string">`$attrs is readonly.`</span>, vm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å‚æ•°æ˜¯åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼ å…¥çš„ï¼Œå½“<code>isUpdatingChildComponent</code>ä¸º<code>false</code>æ—¶ï¼Œä¼šæç¤º<code>$attrs</code>å±æ€§æ—¶å¯è¯»çš„ã€‚è¿™ä¸ªå‡½æ•°åœ¨ä½ è®¾ç½®<code>$attrs</code>æˆ–è€…<code>$listeners</code>çš„å€¼çš„æ—¶å€™ä¼šæ‰§è¡Œã€‚</p><p>å…ˆçœ‹ä¸‹<code>isUpdatingChildComponent</code>çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">let</span> isUpdatingChildComponent: boolean = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æ›´æ–°å­ç»„ä»¶æ–¹æ³•</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">updateChildComponent</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  propsData: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  listeners: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  parentVnode: MountedComponentVNode,</span></span></span><br><span class="line"><span class="function"><span class="params">  renderChildren: ?Array&lt;VNode&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    isUpdatingChildComponent = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// update $attrs and $listeners hash</span></span><br><span class="line">  <span class="comment">// these are also reactive so they may trigger child update if the child</span></span><br><span class="line">  <span class="comment">// used them during render</span></span><br><span class="line">  vm.$attrs = parentVnode.data.attrs || emptyObject</span><br><span class="line">  vm.$listeners = listeners || emptyObject</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    isUpdatingChildComponent = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>isUpdatingChildComponent</code>é»˜è®¤å€¼æ˜¯<code>false</code>ï¼Œå½“è°ƒç”¨<code>updateChildComponent</code>å‡½æ•°æ—¶ï¼Œä¼šå…ˆæŠŠå®ƒçš„å€¼è®¾ç½®ä¸º<code>true</code>ï¼Œç„¶åæ‰§è¡Œä¸€æ®µä»£ç åï¼ŒåˆæŠŠå®ƒçš„å€¼è®¾ç½®ä¸º<code>false</code>ã€‚</p><p>æˆ‘ä»¬æ³¨æ„åˆ°ä¸­é—´ä»£ç ä¸­æœ‰å¯¹<code>$attrs</code>å’Œ<code>$listeners</code>å±æ€§è¿›è¡Œèµ‹å€¼çš„æ“ä½œï¼Œå³æ›´æ–°è¿™ä¸¤ä¸ªå±æ€§ï¼Œå› ä¸ºåœ¨è¿™ä¹‹å‰å·²ç»è®¾ç½®<code>isUpdatingChildComponent</code>çš„å€¼ä¸º<code>false</code>ï¼Œæ‰€ä»¥æ›´æ–°å±æ€§æ—¶ä¸ä¼šæç¤ºå®ƒä»¬æ˜¯åªè¯»å±æ€§ã€‚</p><h3 id="callHook"><a href="#callHook" class="headerlink" title="callHook"></a><code>callHook</code></h3><p>æ‰§è¡Œå®Œ<code>initRender</code> å‡½æ•°åï¼Œä¸‹é¢æ‰§è¡Œçš„æ˜¯<code>callHook</code>å‡½æ•°ï¼Œè¿™æ˜¯æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­çš„å‡½æ•°ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>) <span class="comment">// ! è°ƒç”¨ beforeCreate é’©å­å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯æ‰§è¡Œçš„<code>beforeCreate</code>ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ã€‚</p><p>å…ˆçœ‹ä¸‹<code>callHook</code>å‡½æ•°ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">callHook</span>(<span class="params">vm: Component, hook: string</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// #7573 disable dep collection when invoking lifecycle hooks</span></span><br><span class="line">  pushTarget()</span><br><span class="line">  <span class="keyword">const</span> handlers = vm.$options[hook]</span><br><span class="line">  <span class="keyword">const</span> info = <span class="string">`<span class="subst">$&#123;hook&#125;</span> hook`</span></span><br><span class="line">  <span class="keyword">if</span> (handlers) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = handlers.length; i &lt; j; i++) &#123;</span><br><span class="line">      invokeWithErrorHandling(handlers[i], vm, <span class="literal">null</span>, vm, info)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (vm._hasHookEvent) &#123;</span><br><span class="line">    vm.$emit(<span class="string">'hook:'</span> + hook)</span><br><span class="line">  &#125;</span><br><span class="line">  popTarget()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°éœ€è¦ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œå®ä¾‹å¯¹è±¡<code>vm</code>å’Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°çš„åç§°<code>hook</code>ã€‚</p><p>å†çœ‹å‡½æ•°ä½“çš„ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œï¼Œç¬¬ä¸€è¡Œä»£ç æ˜¯<code>pushTarget()</code> ï¼Œæœ€åä¸€è¡Œä»£ç <code>popTarget()</code>ï¼Œçœ‹åå­—åº”è¯¥æ˜¯ç›®æ ‡å…¥æ ˆå’Œå‡ºæ ˆï¼Œè¿™é‡Œå…ˆä¸ç®¡å®ƒä»¬çš„é€»è¾‘ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œå…ˆä»åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ä¸­é€šè¿‡é’©å­åç§°è·å–é’©å­çš„å€¼<code>handlers</code>ã€‚ä»å‰é¢çš„é€‰é¡¹çš„åˆå¹¶ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“<code>handles</code>çš„å€¼åº”è¯¥æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é‡Œé¢çš„å…ƒç´ æ˜¯éƒ½æ˜¯é’©å­å‡½æ•°ã€‚</p><p>å› ä¸ºä¸æ˜¯æ¯ä¸ªç»„ä»¶éƒ½æœ‰ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°çš„ï¼Œæ‰€ä»¥éœ€è¦å…ˆåˆ¤æ–­ä¸‹æ˜¯å¦å­˜åœ¨<code>handlers</code>ã€‚</p><p>å¦‚æœå­˜åœ¨ï¼Œåˆ™éå†è¿™ä¸ªé’©å­å‡½æ•°ç»„æˆçš„æ•°ç»„ï¼Œè°ƒç”¨<code>invokeWithErrorHandling</code>å‡½æ•°æ¥æ‰§è¡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°ã€‚</p><p>çœ‹ä¸‹<code>invokeWithErrorHandling</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/util/error.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invokeWithErrorHandling</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  handler: Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  context: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  args: null | any[],</span></span></span><br><span class="line"><span class="function"><span class="params">  vm: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  info: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    res = args ? handler.apply(context, args) : handler.call(context)</span><br><span class="line">    <span class="keyword">if</span> (res &amp;&amp; !res._isVue &amp;&amp; isPromise(res) &amp;&amp; !res._handled) &#123;</span><br><span class="line">      res.catch(<span class="function"><span class="params">e</span> =&gt;</span> handleError(e, vm, info + <span class="string">` (Promise/async)`</span>))</span><br><span class="line">      <span class="comment">// issue #9511</span></span><br><span class="line">      <span class="comment">// avoid catch triggering multiple times when nested calls</span></span><br><span class="line">      res._handled = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, info)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠé’©å­å‡½æ•°çš„æ‰§è¡Œæ”¾åˆ°å¤„ç†é”™è¯¯ç›¸å…³çš„æ–‡ä»¶ä¸­ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ›´å¥½çš„æç¤ºé”™è¯¯ã€‚</p><p>é¦–å…ˆå£°æ˜å˜é‡<code>res</code>ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼ã€‚ç„¶åå¼€å§‹å°±ä½¿ç”¨äº†<code>try ... catch</code>è¯­å¥æ¥æ‰§è¡Œé’©å­å‡½æ•°ï¼Œä»¥åŠæ•è·å¯èƒ½å‡ºç°çš„é”™è¯¯ï¼Œå¦‚æœå‡ºç°é”™è¯¯è°ƒç”¨<code>handleError</code>å‡½æ•°æ¥å¤„ç†ã€‚</p><p>é‡æ–°å®šä¹‰å˜é‡<code>res</code>ï¼Œç”¨æ¥å­˜å‚¨å‡½æ•°è°ƒç”¨çš„å€¼ï¼Œé€šè¿‡åˆ¤æ–­æ˜¯å¦æœ‰å‚æ•°<code>args</code>ï¼Œç„¶ååœ¨æ‰§è¡Œ<code>handler</code>å‡½æ•°çš„æ—¶å€™æ˜¯å¦ä¼ å…¥å‚æ•°ã€‚å†åˆ¤æ–­å‡½æ•°çš„è¾“å‡ºå€¼<code>res</code>æ˜¯ä¸æ˜¯ä¸€ä¸ª<code>Promise</code>å¯¹è±¡ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œä½¿ç”¨<code>catch</code>æ¥æ•è·<code>Promsie</code>å¯¹è±¡çš„é”™è¯¯ã€‚ä¹‹åå†è®¾ç½®è¿”å›å€¼<code>res</code>çš„å±æ€§<code>_handled</code>ä¸º<code>ture</code>ï¼Œè¡¨ç¤ºå‡½æ•°å·²ç»è¢«è°ƒç”¨è¿‡ã€‚</p><p>å‡½æ•°æœ€åä¸ç®¡æœ‰æ²¡æœ‰å‡ºç°é”™è¯¯éƒ½ä¼šè¿”å›<code>res</code>ã€‚ä¸è¿‡æˆ‘ä»¬åœ¨ä½¿ç”¨ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°æ—¶ï¼Œä¸€èˆ¬å¾ˆå°‘ç”¨åˆ°è¿™ä¸ªè¿”å›å€¼ã€‚</p><p>æ¥ä¸‹æ¥çœ‹å‰©ä¸‹çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (vm._hasHookEvent) &#123;</span><br><span class="line">  vm.$emit(<span class="string">'hook:'</span> + hook)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>vm._hasHookEvent</code>æ˜¯åœ¨<code>initEvent</code>æ—¶å®šä¹‰çš„å±æ€§ï¼Œåˆå§‹å€¼æ˜¯<code>false</code>ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ¤æ–­æ˜¯å¦æœ‰<strong>ç”Ÿå‘½å‘¨æœŸé’©å­çš„äº‹ä»¶ç›‘å¬å™¨</strong>ã€‚å½“ç»„ä»¶æ£€æŸ¥åˆ°æœ‰<strong>ç”Ÿå‘½å‘¨æœŸé’©å­çš„äº‹ä»¶ç›‘å¬å™¨</strong>æ—¶ï¼Œä¼šæŠŠå®ƒçš„å€¼è®¾ä¸º<code>true</code>ã€‚</p><p>åˆ°åº•ä»€ä¹ˆæ˜¯<strong>ç”Ÿå‘½å‘¨æœŸé’©å­çš„äº‹ä»¶ç›‘å¬å™¨</strong>å‘¢ï¼Ÿ</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">child</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">hook:beforeCreate</span>=<span class="string">"handleChildBeforeCreate"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">hook:created</span>=<span class="string">"handleChildCreated"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">hook:mounted</span>=<span class="string">"handleChildMounted"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>@hook:</code> å†åŠ ä¸Š<code>ç”Ÿå‘½å‘¨æœŸçš„åç§°</code>æ¥ç›‘å¬ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚</p><p>å½“å®ä¾‹å¯¹è±¡å‘ç°æœ‰<strong>ç”Ÿå‘½å‘¨æœŸé’©å­çš„äº‹ä»¶ç›‘å¬å™¨</strong>æ—¶ï¼Œä¼šæŠŠ<code>_hasHookEvent</code>è®¾ç½®ä¸º<code>true</code>ï¼Œè¿™æ—¶å°±ä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼Œå®ä¾‹å¯¹è±¡ä¼šæ´¾å‘ä¸€ä¸ªåä¸º<code>hook: ç”Ÿå‘½å‘¨æœŸå‡½æ•°åå­—</code>çš„äº‹ä»¶å‡ºå»ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vm.$emit(<span class="string">'hook:'</span> + hook)</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šå®ä¾‹å¯¹è±¡æ˜¯ä»€ä¹ˆæ—¶å€™è®¾ç½®<code>_hasHookEvent</code>ä¸º<code>true</code>çš„å‘¢ï¼Ÿè¿™æ¶‰åŠåˆ° Vue çš„äº‹ä»¶ç³»ç»Ÿï¼Œæš‚æ—¶å…ˆä¸ç®¡ã€‚</p><h3 id="initState"><a href="#initState" class="headerlink" title="initState"></a><code>initState</code></h3><p>è°ƒç”¨å®Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°åï¼Œæ¥ä¸‹æ¥æ˜¯<code>initInjections</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯åˆå§‹åŒ–<code>injects</code>é€‰é¡¹çš„å‡½æ•°ã€‚è¿™é‡Œå…ˆä¸ç®¡å®ƒï¼Œåé¢å’Œåˆå§‹åŒ–<code>provides</code>çš„å‡½æ•°ä¸€èµ·åˆ†æã€‚</p><p>ç°åœ¨çœ‹ä¸‹ä¸€ä¸ª<code>initState</code> å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/instance/state.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initState</span>(<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._watchers = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">  <span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</span><br><span class="line">  <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</span><br><span class="line">  <span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">    initData(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observe((vm._data = &#123;&#125;), <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</span><br><span class="line">  <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</span><br><span class="line">    initWatch(vm, opts.watch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯åˆå§‹åŒ– Vue çš„æ•°æ®ç›¸å…³çš„å‡½æ•°ã€‚é¦–å…ˆå¢åŠ å®ä¾‹å±æ€§<code>vm._watchers</code>ï¼Œåˆå§‹å€¼ä¸ºç©ºæ•°ç»„ã€‚å£°æ˜å˜é‡<code>opts</code>å­˜å‚¨åˆå¹¶åçš„é€‰é¡¹<code>vm.$options</code>ã€‚</p><p>ç„¶ååˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>props</code>å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯è°ƒç”¨<code>initProps</code>å‡½æ•°åˆå§‹åŒ–<code>props</code>é€‰é¡¹ã€‚å†åˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>methods</code>å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯è°ƒç”¨<code>initMethods</code>å‡½æ•°åˆå§‹åŒ–<code>methods</code>é€‰é¡¹ã€‚å†åœ¨åˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>data</code>å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯è°ƒç”¨<code>initData</code>å‡½æ•°åˆå§‹åŒ–<code>data</code>é€‰é¡¹ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œè°ƒç”¨<code>observe</code>ç›‘å¬ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œå¹¶ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°<code>true</code>ï¼Œè¡¨ç¤ºè§‚æµ‹çš„å¯¹è±¡æ˜¯æ ¹ç»„ä»¶çš„<code>data</code>ã€‚</p><p>æ¥ä¸‹æ¥ç»§ç»­åˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>computed</code>å±æ€§ï¼Œå¦‚æœæœ‰çš„è¯è°ƒç”¨<code>initComputed</code>å‡½æ•°åˆå§‹åŒ–<code>computed</code>é€‰é¡¹ã€‚ç»§ç»­åˆ¤æ–­<code>opts</code>ä¸­æ˜¯å¦æœ‰<code>watch</code>ä¸”å®ƒä¸ç­‰äº Firefox æµè§ˆå™¨çš„<code>watch</code>å€¼ï¼Œå¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶çš„è¯ï¼Œè°ƒç”¨<code>initWatch</code>å‡½æ•°åˆå§‹åŒ–<code>watch</code>é€‰é¡¹ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>initState</code> å‡½æ•°ç»Ÿä¸€åˆå§‹åŒ–äº†<code>props</code>ã€<code>methods</code>ã€<code>data</code>ã€<code>computed</code>å’Œ<code>watch</code>è¿™å‡ ä¸ªæ•°æ®ç›¸å…³çš„é€‰é¡¹ã€‚</p><p><strong>æ³¨æ„è¿™äº›é€‰é¡¹åˆå§‹åŒ–çš„é¡ºåº</strong>ã€‚æ¯”å¦‚<code>props</code>è¦æ¯”<code>data</code>å’Œ<code>computed</code>æ›´æ—©çš„åˆå§‹åŒ–ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨<code>props</code>çš„æ•°æ®æ¥åˆå§‹åŒ–<code>data</code>æˆ–è€…<code>computed</code>é€‰é¡¹çš„æ•°æ®ï¼Œè®¡ç®—å±æ€§<code>computed</code>çš„åˆå§‹åŒ–æ”¾åœ¨<code>data</code>åé¢ä¹Ÿæ˜¯å› ä¸ºå®ƒçš„å€¼å¯ä»¥ä¾èµ–<code>data</code>é€‰é¡¹çš„å€¼ã€‚</p><p>ä¸€ä¸ªå¾ˆé‡è¦çš„<strong>ä½¿ç”¨åœºæ™¯</strong>ï¼ŒVue ä½¿ç”¨å•å‘æµæ•°æ®ï¼Œè§„å®šå­ç»„ä»¶ä¸èƒ½ä¿®æ”¹çˆ¶ç»„ä»¶ä¼ è¿‡çš„<code>props</code>æ•°æ®ï¼Œè¿™æ ·ä¼šé˜²æ­¢ä»å­ç»„ä»¶æ„å¤–æ”¹å˜çˆ¶çº§ç»„ä»¶çš„çŠ¶æ€ï¼Œä»è€Œå¯¼è‡´ä½ çš„åº”ç”¨çš„æ•°æ®æµå‘éš¾ä»¥ç†è§£ã€‚ä½†æ˜¯åœ¨ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¯èƒ½éœ€è¦æ”¹å˜ä¼ è¿‡æ¥çš„<code>props</code>çš„æ•°æ®ï¼Œé‚£æˆ‘ä»¬è¦æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥æŠŠå®ƒè½¬å­˜ä¸º<code>data</code>æˆ–è€…<code>computed</code>é€‰é¡¹çš„æ•°æ®ï¼Œä½œä¸ºè¿™äº›æ•°æ®çš„åˆå§‹å€¼ï¼Œè¿™æ ·å°±ç›¸å½“äºæ”¹å˜äº†<code>props</code>çš„å€¼ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">props: [<span class="string">'initialCounter'</span>, <span class="string">'size'</span>],</span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    counter: <span class="keyword">this</span>.initialCounter</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">computed: &#123;</span><br><span class="line">  normalizedSize: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.size.trim().toLowerCase()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨å‰é¢æˆ‘ä»¬è®²è§£ Vue çš„å®ä¾‹åŒ–æ—¶ï¼Œå•ç‹¬ç”¨äº†ä¸¤ç« è®²è§£ Vue çš„é€‰é¡¹åˆå¹¶çš„å†…å®¹ï¼Œä¸‹é¢å¼€å§‹çœŸæ­£å­¦ä¹  Vue çš„å®ä¾‹åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;ç»§ç»­çœ‹&lt;code&gt;_init&lt;/code&gt;å‡½æ•°ä¸‹é¢çš„ä»£ç ï¼Œåœ¨æ–‡ä»¶&lt;code&gt;core/instance/init.js&lt;/code&gt;ä¸­&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/* istanbul ignore else */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ! åˆå§‹åŒ–ä»£ç†&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (process.env.NODE_ENV !== &lt;span class=&quot;string&quot;&gt;&#39;production&#39;&lt;/span&gt;) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  initProxy(vm)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;span class=&quot;keyword&quot;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  vm._renderProxy = vm&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;åœ¨å‰é¢è®²è§£ä¸­åªæ˜¯æåˆ°åœ¨éç”Ÿäº§ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ä»£ç å®ç°ç»“æœå¿…é¡»ä¸€è‡´ï¼Œæ‰€ä»¥&lt;code&gt;initProxy&lt;/code&gt;çš„å‡½æ•°çš„ä½œç”¨åº”è¯¥ä¸ºå®ä¾‹å¯¹è±¡&lt;code&gt;vm&lt;/code&gt;æ·»åŠ å±æ€§&lt;code&gt;_renderProxy&lt;/code&gt;ä¸º&lt;code&gt;vm&lt;/code&gt;ã€‚çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹é€‰é¡¹åˆå¹¶çš„ç­–ç•¥</title>
    <link href="https://haledeng.com/blog/20190902-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%80%89%E9%A1%B9%E5%90%88%E5%B9%B6%E7%9A%84%E7%AD%96%E7%95%A5/"/>
    <id>https://haledeng.com/blog/20190902-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%80%89%E9%A1%B9%E5%90%88%E5%B9%B6%E7%9A%84%E7%AD%96%E7%95%A5/</id>
    <published>2019-09-02T12:00:00.000Z</published>
    <updated>2020-05-07T08:57:26.879Z</updated>
    
    <content type="html"><![CDATA[<p>ä¸Šä¸€ç« çš„ä»£ç è§„èŒƒåŒ–äº†å„ä¸ªé€‰é¡¹çš„å€¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ¥ä¸‹æ¥æ›´å¥½çš„è¿›è¡Œåˆå¹¶é€‰é¡¹ã€‚</p><p>ä¸‹é¢å¼€å§‹å°±æ˜¯çœŸæ­£è¿›è¡Œé€‰é¡¹åˆå¹¶çš„ä»£ç ã€‚</p><p>å…·ä½“è¦æ€ä¹ˆåˆå¹¶å‘¢ï¼Ÿä¸åŒçš„å­—æ®µçš„åˆå¹¶ç­–ç•¥æ˜¯ä¸€æ ·çš„å—ï¼Ÿ</p><a id="more"></a><h2 id="mergeField"><a href="#mergeField" class="headerlink" title="mergeField"></a><code>mergeField</code></h2><p>ç»§ç»­çœ‹æœ€åå‰©ä¸‹çš„ä»£ç ï¼Œè¿™é‡Œå¼€å§‹è¿›è¡ŒçœŸæ­£çš„é€‰é¡¹åˆå¹¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> options = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> key</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! éå†é»˜è®¤é…ç½®</span></span><br><span class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> parent) &#123;</span><br><span class="line">  mergeField(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! éå†ç”¨æˆ·é…ç½®</span></span><br><span class="line"><span class="keyword">for</span> (key <span class="keyword">in</span> child) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!hasOwn(parent, key)) &#123;</span><br><span class="line">    mergeField(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ! æ ¹æ® key å€¼çš„ä¸åŒï¼Œä½¿ç”¨ä¸åŒçš„åˆå¹¶ç­–ç•¥</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeField</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> strat = strats[key] || defaultStrat</span><br><span class="line">  options[key] = strat(parent[key], child[key], vm, key)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> options</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå£°æ˜ä¸€ä¸ªå˜é‡<code>options</code>ä¸ºç©ºå¯¹è±¡ï¼Œæœ€åå†è¿”å›å®ƒï¼Œè¿™è¯´æ˜é€‰é¡¹åˆå¹¶åçš„å€¼æ˜¯å¯¹è±¡ç±»å‹ã€‚</p><p>ç„¶åéå† Vue çš„é»˜è®¤é€‰é¡¹<code>parent</code>ï¼Œè°ƒç”¨<code>mergeField</code>å‡½æ•°å¹¶ä¼ å…¥<code>key</code>å€¼ã€‚</p><p>å†éå†ç”¨æˆ·é€‰é¡¹<code>child</code>ï¼Œè¿˜æ˜¯ä½¿ç”¨<code>mergeField</code>å‡½æ•°å¹¶ä¼ å…¥<code>key</code>å€¼ï¼Œä½†æ˜¯å’Œä¸Šé¢ä¸åŒçš„æ˜¯è¦æ±‚<code>key</code>å¿…é¡»æ˜¯<code>parent</code>ä¸­æ²¡æœ‰çš„å­—æ®µã€‚</p><p>ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡å‘¢ï¼Ÿçœ‹<code>mergeField</code>å‡½æ•°å°±çŸ¥é“äº†ã€‚</p><p>åœ¨ä½¿ç”¨ç­–ç•¥å‡½æ•°åˆå¹¶æ—¶éƒ½ä¼šæŠŠå€¼ä¼ å…¥ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡å¤è°ƒç”¨ã€‚</p><p><code>mergeField</code>å‡½æ•°æ˜¯åˆå¹¶é€‰é¡¹å­—æ®µçš„æ–¹æ³•ï¼Œé¦–å…ˆæ ¹æ® <code>key</code> çš„å€¼é€‰æ‹©å®ƒçš„ä¸“ç”¨çš„åˆå¹¶ç­–ç•¥ï¼Œå¦‚æœæ²¡æœ‰ä¸“ç”¨çš„åˆå¹¶ç­–ç•¥å°±ä½¿ç”¨é»˜è®¤çš„åˆå¹¶ç­–ç•¥ã€‚</p><p>è¿™é‡Œçš„<code>strats</code>æ˜¯ä¸€ä¸ªåˆå¹¶ç­–ç•¥å‡½æ•°ç»„æˆçš„å¯¹è±¡ï¼Œå¯¹è±¡é‡Œé¢çš„ <code>key</code> å¯¹åº”é€‰é¡¹å­—æ®µä¸­çš„<code>key</code>ï¼Œè€Œå®ƒçš„<code>value</code> å¯¹åº”çš„æ˜¯å­—æ®µçš„åˆå¹¶ç­–ç•¥å‡½æ•°ã€‚å†è°ƒç”¨ç­–ç•¥å‡½æ•°çš„æ—¶å€™ï¼Œéœ€è¦æŠŠ<code>parent</code>å­—æ®µçš„å€¼ã€<code>child</code>é€‰é¡¹å­—æ®µçš„å€¼ä»¥åŠå®ä¾‹å¯¹è±¡<code>vm</code>å’Œ<code>key</code>ä½œä¸ºå‚æ•°ä¸€èµ·ä¼ å…¥ã€‚ç„¶åæŠŠè°ƒç”¨çš„ç»“æœï¼ˆå³åˆå¹¶åçš„é€‰é¡¹ï¼‰èµ‹å€¼ç»™ä¸€å¼€å§‹å£°æ˜çš„<code>options</code>å¯¹è±¡ä¸­ã€‚<code>options</code>å¯¹è±¡ä¸­çš„<code>key</code>ä¹Ÿå¯¹åº”é€‰é¡¹å­—æ®µçš„<code>key</code>ï¼Œå®ƒçš„å€¼å°±æ˜¯åˆå¹¶é€‰é¡¹åçš„å€¼ã€‚</p><p>è¿™å°±æ˜¯åˆå¹¶é€‰é¡¹çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯æ ¹æ®é€‰é¡¹ä¸­ä¸åŒçš„å­—æ®µé€‰æ‹©ä¸åŒçš„åˆå¹¶ç­–ç•¥ã€‚ä¸è¿‡éš¾ç‚¹å¹¶ä¸åœ¨è¿™é‡Œï¼Œè€Œæ˜¯åœ¨åˆå¹¶é€‰é¡¹çš„ç­–ç•¥å‡½æ•°ä¸Šã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸‹å„ä¸ªå­—æ®µçš„åˆå¹¶ç­–ç•¥å‡½æ•°ã€‚</p><h2 id="strats"><a href="#strats" class="headerlink" title="strats"></a><code>strats</code></h2><h3 id="defaultStrat"><a href="#defaultStrat" class="headerlink" title="defaultStrat"></a><code>defaultStrat</code></h3><p>å…ˆçœ‹ä¸‹é»˜è®¤çš„åˆå¹¶ç­–ç•¥<code>defaultStrat</code>å‡½æ•°çš„ä»£ç ã€‚åœ¨<code>mergeField</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å¦‚æœ<code>strats</code>ä¸­æ²¡æœ‰æ‰¾åˆ°<code>key</code>çš„åˆå¹¶ç­–ç•¥ï¼Œå°±ä¼šä½¿ç”¨é»˜è®¤çš„åˆå¹¶ç­–ç•¥å‡½æ•°ã€‚</p><p>ä»£ç åœ¨<code>core/util/options.js</code>æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultStrat = <span class="function"><span class="keyword">function</span>(<span class="params">parentVal: any, childVal: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> childVal === <span class="literal">undefined</span> ? parentVal : childVal</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ƒçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå¦‚æœæ²¡æœ‰ç”¨æˆ·é€‰é¡¹<code>childVal</code>ï¼Œå°±ä½¿ç”¨é»˜è®¤é€‰é¡¹<code>parentVal</code>ï¼Œå¦åˆ™ä½¿ç”¨ç”¨æˆ·é€‰é¡¹<code>childVal</code>ã€‚</p><p>ä½¿ç”¨é»˜è®¤åˆå¹¶ç­–ç•¥çš„å­—æ®µæœ‰<code>el</code>å’Œ<code>propsData</code>è¿™äº›å­—æ®µ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  strats.el = strats.propsData = <span class="function"><span class="keyword">function</span>(<span class="params">parent, child, vm, key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`option "<span class="subst">$&#123;key&#125;</span>" can only be used during instance `</span> +</span><br><span class="line">          <span class="string">'creation with the `new` keyword.'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> defaultStrat(parent, child)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤é€‰é¡¹</span></span><br><span class="line">el: <span class="string">'#app'</span>,</span><br><span class="line">propsData: &#123;</span><br><span class="line">  name: <span class="string">'Hale'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨æˆ·é€‰é¡¹</span></span><br><span class="line">el: <span class="string">'#root'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆå¹¶åé€‰é¡¹</span></span><br><span class="line">el: <span class="string">'#root'</span>,</span><br><span class="line">propsData: &#123;</span><br><span class="line">  name: <span class="string">'Hale'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="data-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"><a href="#data-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="data é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"></a><code>data</code> é€‰é¡¹çš„åˆå¹¶ç­–ç•¥</h3><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>data</code>å­—æ®µçš„åˆå¹¶ç­–ç•¥å‡½æ•°</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">strats.data = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">    <span class="keyword">if</span> (childVal &amp;&amp; <span class="keyword">typeof</span> childVal !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">'The "data" option should be a function '</span> +</span><br><span class="line">            <span class="string">'that returns a per-instance value in component '</span> +</span><br><span class="line">            <span class="string">'definitions.'</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> parentVal</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mergeDataOrFn(parentVal, childVal)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> mergeDataOrFn(parentVal, childVal, vm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°é€»è¾‘åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œæœ‰å®ä¾‹å¯¹è±¡<code>vm</code>å’Œæ²¡æœ‰<code>vm</code>ã€‚</p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>Vue.extend</code>æ–¹æ³•ç”Ÿæˆå­ç±»æ—¶ï¼Œè¿™ä¸ªå­ç±»æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œå½“å®ƒçš„<code>options</code>ä½œä¸ºç”¨æˆ·é€‰é¡¹<code>childVal</code>æ—¶ï¼Œå®ƒæ˜¯æ²¡æœ‰<code>vm</code>çš„ã€‚</p><p>ä¸è¿‡ä¸ç®¡æœ‰æ²¡æœ‰å®ä¾‹å¯¹è±¡ï¼Œå®ƒéƒ½æ˜¯ä½¿ç”¨<code>mergeDataOrFn</code>å‡½æ•°æ¥è¿›è¡Œé€‰é¡¹åˆå¹¶çš„ã€‚</p><p>å¦å¤–ï¼Œå­ç±»ç»„ä»¶çš„<code>data</code>é€‰é¡¹å¦‚æœä¸æ˜¯å‡½æ•°ç±»å‹ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒæ—¶ä¼šæŠ¥é”™ï¼Œç„¶åç›´æ¥è¿”å›<code>parentVal</code>é€‰é¡¹ã€‚</p><h4 id="mergeDataOrFn"><a href="#mergeDataOrFn" class="headerlink" title="mergeDataOrFn"></a><code>mergeDataOrFn</code></h4><p>ä¸‹é¢çœ‹ä¸‹<code>mergeDataOrFn</code>å‡½æ•°çš„ä»£ç ï¼Œè¿™é‡Œçš„é€»è¾‘åŒæ ·åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«ä¸ºæœ‰å®ä¾‹å¯¹è±¡<code>vm</code>å’Œæ²¡æœ‰<code>vm</code>ã€‚</p><p>å…ˆçœ‹ä¸‹æ²¡æœ‰å®ä¾‹å¯¹è±¡<code>vm</code>çš„ä»£ç ï¼Œå³åˆå¹¶å­ç±»çš„é€‰é¡¹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeDataOrFn</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Function</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!vm) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!childVal) &#123;</span><br><span class="line">      <span class="keyword">return</span> parentVal</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!parentVal) &#123;</span><br><span class="line">      <span class="keyword">return</span> childVal</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mergedDataFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> mergeData(</span><br><span class="line">        <span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : childVal,</span><br><span class="line">        <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : parentVal</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯ä¸¤ä¸ª <code>if</code>è¯­å¥ï¼Œå…ˆçœ‹ç¬¬ä¸€ä¸ªã€‚å¦‚æœæ²¡æœ‰å­é€‰é¡¹ <code>childVal</code>ï¼Œå°±è¿”å›çˆ¶é€‰é¡¹<code>parentVal</code>ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨æ‰©å±•æ—¶æ²¡æœ‰è®¾ç½®<code>data</code>é€‰é¡¹çš„å€¼ã€‚åƒä¸‹é¢è¿™ç§æƒ…å†µï¼Œå°±ä¼šé‡‡ç”¨è¿™ç§é€»è¾‘ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Stor = Vue.extend(&#123;&#125;)</span><br></pre></td></tr></table></figure><p>å¯èƒ½æœ‰äººä¼šé—®æ—¢ç„¶å­é€‰é¡¹ <code>childVal</code>ä¸­æ²¡æœ‰è®¾ç½®<code>data</code>é€‰é¡¹ï¼Œçˆ¶é€‰é¡¹<code>parentVal</code>é€šå¸¸ä¹Ÿä¸ä¼šæœ‰<code>data</code>çš„å€¼ï¼Œéƒ½æ²¡æœ‰<code>data</code>è¿™ä¸ªå­—æ®µï¼Œä¹Ÿå°±ä¸å­˜åœ¨å»è°ƒç”¨<code>data</code>çš„ç­–ç•¥å‡½æ•°äº†ã€‚</p><p>ä¸ºä»€ä¹ˆè¿˜è¦è¿”å›<code>parentVal</code>ï¼Œ<code>parentVal</code>å¯èƒ½å­˜åœ¨å—ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå¦‚ä¸‹ç¤ºä¾‹ä»£ç ä¸­ï¼Œåœ¨ä½¿ç”¨äºŒæ¬¡<code>extend</code>æ—¶ï¼Œ<code>Child</code> å­ç±»çš„<code>parentVal</code> æ˜¯å­˜åœ¨çš„ï¼Œå°±æ˜¯åœ¨åˆ›å»º<code>Parent</code>å­ç±»æ—¶ä¼ å…¥çš„<code>data</code>çš„å€¼ã€‚ä½†æ˜¯åœ¨åˆ›å»º<code>Child</code>å­ç±»æ—¶æ²¡æœ‰ä¼ å…¥<code>data</code>çš„å€¼ï¼Œæ‰€ä»¥<code>Child</code>çš„<code>childVal</code>æ˜¯æ²¡æœ‰çš„ã€‚é‚£ä¹ˆå¯¹äº<code>Child</code>çš„å­ç±»çš„åˆ›å»ºçš„å‡½æ•°ï¼Œå­˜åœ¨<code>parentVal</code>è€Œä¸å­˜åœ¨<code>childVal</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Parent = Vue.extend(&#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">test1</span>: <span class="number">1</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> Child = Parent.entend(&#123;&#125;)</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥å†çœ‹ç¬¬äºŒä¸ª<code>if</code>è¯­å¥ã€‚å¦‚æœæ²¡æœ‰<code>parentVal</code>ï¼Œå°±è¿”å›<code>childVal</code>ã€‚å…¶å®è¿™ç§æƒ…å†µåœ¨å®é™…å¼€å‘ä¸­åº”è¯¥æ˜¯<strong>å‡ºç°æœ€å¤š</strong>çš„ã€‚æ‰€ä»¥<code>parentVal</code>å’Œ<code>childVal</code>å¿…å®šæœ‰å…¶ä¸­ä¸€ä¸ªï¼Œå¦åˆ™å°±ä¸ä¼šæ‰§è¡Œ<code>data</code>é€‰é¡¹åˆå¹¶ç­–ç•¥äº†ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹<code>parentVal</code>å’Œ<code>childVal</code>éƒ½å­˜åœ¨çš„æƒ…å†µçš„é€»è¾‘ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mergedDataFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> mergeData(</span><br><span class="line">    <span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : childVal,</span><br><span class="line">    <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(<span class="keyword">this</span>, <span class="keyword">this</span>) : parentVal</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿”å›ä¸€ä¸ªå‡½æ•°<code>mergedDataFn</code>ï¼Œè¿™ä¸ªå‡½æ•°è°ƒç”¨äº†<code>mergeData</code>æ¥å¤„ç†<code>data</code>é€‰é¡¹çš„åˆå¹¶ï¼Œå®ƒéœ€è¦ä¼ å…¥<code>childVal</code> å’Œ<code>parentVal</code> è¿™ä¸¤ä¸ªå‚æ•°ã€‚<strong>æ³¨æ„</strong>å‚æ•°ä¼ å…¥çš„<strong>é¡ºåº</strong>ï¼Œå…ˆå­åçˆ¶ã€‚å¦å¤–ä¼ å…¥çš„ä¸¤ä¸ªå‚æ•°åªèƒ½æ˜¯å¯¹è±¡ç±»å‹ã€‚</p><p>åœ¨ Vue å®ä¾‹ç»„ä»¶ä¸­<code>data</code>çš„å€¼éƒ½æ˜¯å‡½æ•°ç±»å‹çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿”å›æ™®é€šå¯¹è±¡çš„å‡½æ•°ã€‚è¿™æ—¶éœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œè¾“å‡ºå¯¹è±¡ç±»å‹çš„å€¼ã€‚åœ¨ä½¿ç”¨<code>call</code>è°ƒç”¨çš„æ—¶å€™ä¼ å…¥äº†ä¸¤ä¸ª <code>this</code>ã€‚ç¬¬ä¸€ä¸ª<code>this</code>æ˜¯æŒ‡å‘<code>data</code>å‡½æ•°çš„ä½œç”¨åŸŸï¼›è€Œç¬¬äºŒä¸ª<code>this</code>æ˜¯<code>data</code>å‡½æ•°çš„å‚æ•°ï¼ŒæŒ‡å‘ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡ã€‚</p><p>æ¥ä¸‹æ¥çœ‹<code>else</code>ä»£ç å—çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">mergedInstanceDataFn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// instance merge</span></span><br><span class="line">  <span class="keyword">const</span> instanceData =</span><br><span class="line">    <span class="keyword">typeof</span> childVal === <span class="string">'function'</span> ? childVal.call(vm, vm) : childVal</span><br><span class="line">  <span class="keyword">const</span> defaultData =</span><br><span class="line">    <span class="keyword">typeof</span> parentVal === <span class="string">'function'</span> ? parentVal.call(vm, vm) : parentVal</span><br><span class="line">  <span class="keyword">if</span> (instanceData) &#123;</span><br><span class="line">    <span class="keyword">return</span> mergeData(instanceData, defaultData)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defaultData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¡¨ç¤ºå­˜åœ¨å®ä¾‹å¯¹è±¡<code>vm</code>çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢ä»£ç æ˜¯å®ä¾‹å¯¹è±¡åˆå§‹åŒ–æ—¶åˆå¹¶é€‰é¡¹çš„ä»£ç ã€‚</p><p>è¿™æ ·ä¹Ÿè¿”å›ä¸€ä¸ªå«<code>mergedInstanceDataFn</code>å‡½æ•°ã€‚å‡½æ•°ä¸­éœ€è¦å…ˆè·å–ä¸€ä¸ª<code>childVal</code>å’Œ<code>parentVal</code>ç”Ÿæˆçš„å¯¹è±¡ç±»å‹çš„å€¼ã€‚å¦‚æœé€‰é¡¹æ˜¯å‡½æ•°ï¼Œéœ€è¦è°ƒç”¨è¿™ä¸ªå‡½æ•°è·å–å¯¹è±¡ç±»å‹çš„å€¼ï¼Œåœ¨è°ƒç”¨æ—¶ä¼ å…¥çš„å‚æ•°æ˜¯ä¸¤ä¸ª<code>vm</code>ï¼Œå³å®ä¾‹å¯¹è±¡ã€‚ç¬¬ä¸€ä¸ª<code>vm</code>è¡¨ç¤º<code>this</code>çš„æŒ‡å‘æ˜¯å®ä¾‹å¯¹è±¡ï¼Œç¬¬äºŒä¸ª<code>vm</code>æ˜¯<code>data</code>å‡½æ•°çš„å‚æ•°ã€‚</p><p>åœ¨ç»„ä»¶ä¸­ï¼Œ<code>data</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå…¶å®æœ‰å¾ˆå¤šç§å†™æ³•</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">data () &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    testData: <span class="keyword">this</span>.propsData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦å¤–çš„å†™æ³•</span></span><br><span class="line">data(vm) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    testData: vm.propsData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿˜å¯ä»¥ä½¿ç”¨è§£æ„</span></span><br><span class="line">data(&#123; propsData &#125;) &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    testData: propsData</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (instanceData) &#123;</span><br><span class="line">  <span class="keyword">return</span> mergeData(instanceData, defaultData)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> defaultData</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤ç«¯<code>childVal</code>è¾“å‡ºçš„å€¼æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è°ƒç”¨<code>mergeData</code>å‡½æ•°æŠŠå®ƒå’Œ<code>parentVal</code>è¾“å‡ºçš„å€¼è¿›è¡Œåˆå¹¶ï¼Œä¸å­˜åœ¨å°±ç›´æ¥è¿”å›<code>parentVal</code>è¾“å‡ºçš„å€¼ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>mergeData</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeData</span>(<span class="params">to: Object, from: ?Object</span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">from</span>) <span class="keyword">return</span> to</span><br><span class="line">  <span class="keyword">let</span> key, toVal, fromVal</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keys = hasSymbol ? <span class="built_in">Reflect</span>.ownKeys(<span class="keyword">from</span>) : <span class="built_in">Object</span>.keys(<span class="keyword">from</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    key = keys[i]</span><br><span class="line">    <span class="comment">// in case the object is already observed...</span></span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">'__ob__'</span>) <span class="keyword">continue</span></span><br><span class="line">    toVal = to[key]</span><br><span class="line">    fromVal = <span class="keyword">from</span>[key]</span><br><span class="line">    <span class="keyword">if</span> (!hasOwn(to, key)) &#123;</span><br><span class="line">      <span class="keyword">set</span>(to, key, fromVal)</span><br><span class="line">    &#125; else if (</span><br><span class="line">      toVal !== fromVal &amp;&amp;</span><br><span class="line">      isPlainObject(toVal) &amp;&amp;</span><br><span class="line">      isPlainObject(fromVal)</span><br><span class="line">    ) &#123;</span><br><span class="line">      mergeData(toVal, fromVal)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mergeData</code>å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œ<code>to</code>å’Œ<code>from</code>ï¼Œä»å‚æ•°åä¸­å¯ä»¥çœ‹å‡ºæ˜¯æŠŠç¬¬äºŒä¸ªå‚æ•°åˆå¹¶åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ä¸­ã€‚</p><p>ç„¶åå†çœ‹å‡½æ•°çš„è¿”å›å€¼ä¸º<code>to</code>ï¼Œå³è¿”ç¬¬ä¸€ä¸ªå‚æ•°åˆå¹¶çš„å€¼ï¼Œæ‰€ä»¥ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä¸Šé¢è°ƒç”¨å®ƒçš„æ—¶å€™ä¼ å…¥å‚æ•°çš„é¡ºåºæ˜¯å…ˆå­åçˆ¶äº†ï¼Œå³å…ˆä¼ å…¥<code>childVal</code>å†ä¼ å…¥<code>parentVal</code>ï¼Œ<strong>å› ä¸ºæ˜¯ä»¥ç”¨æˆ·é€‰é¡¹<code>childVal</code>ä¸ºä¸»</strong>ã€‚</p><p>çœ‹ä»£ç ç¬¬ä¸€å¥<code>if (!from) return to</code>ï¼Œå¦‚æœæ²¡æœ‰ç¬¬äºŒä¸ªå‚æ•°<code>from</code>ï¼Œç›´æ¥è¿”å›ç¬¬ä¸€ä¸ªå‚æ•°<code>to</code>ã€‚</p><p>ç„¶åè·å–ç¬¬äºŒä¸ªå‚æ•°<code>from</code>çš„ <code>keys</code>ï¼Œåˆ¤æ–­æ˜¯å¦æ”¯æŒ ES6 çš„<code>Promise</code> çš„è¯­æ³•ï¼Œå¦‚æœæ”¯æŒåˆ™ä½¿ç”¨<code>Reflect.ownKeys(from)</code>ï¼Œä¸æ”¯æŒå°±ä½¿ç”¨å¯¹è±¡çš„æ–¹æ³•<code>Object.keys(from)</code>ã€‚</p><p>å®ƒä»¬ä¸¤ä¸ªæœ‰ä»€ä¹ˆ<strong>åŒºåˆ«</strong>å—ï¼Ÿä½¿ç”¨<code>Object.keys</code>åªä¼šè¿”å›å¯æšä¸¾çš„<code>key</code>å€¼ï¼Œè€Œ<code>Reflect.ownKeys</code>ä¼šè¿”å›<strong>æ‰€æœ‰çš„</strong><code>key</code>å€¼ã€‚</p><p>ç„¶åå»éå†<code>keys</code>ï¼Œå¦‚æœ<code>key</code>æ˜¯<code>&#39;__ob__</code> æ—¶ï¼Œè¿™æ˜¯ä¾¦å¬å¯¹è±¡ï¼ˆåé¢è®²å“åº”å¼ç³»ç»Ÿæ—¶å†è®²è§£ï¼‰ï¼Œè·³è¿‡è¿™æ¬¡å¾ªç¯ã€‚</p><p>åœ¨çœ‹ä¸‹<code>to</code>é€‰é¡¹æ˜¯å¦æœ‰<code>key</code>è¿™ä¸ªå€¼ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œä½¿ç”¨<code>set</code>æ–¹æ³•æŠŠå®ƒåŠ å…¥åˆ°<code>to</code>ä¸­ã€‚è¿™é‡Œçš„<code>set</code>å’Œå…¨å±€ API <code>Vue.set</code>æ˜¯åŒä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥æŠŠ<code>data</code>é€‰é¡¹çš„å±æ€§å˜æˆå“åº”å¼ã€‚</p><p>å¦å¤–ï¼Œè¿˜éœ€è¦åˆ¤æ–­ï¼Œåœ¨ç›¸åŒ<code>key</code>æ—¶ï¼Œ<code>to</code>å’Œ<code>from</code>çš„å€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœä¸ç›¸åŒä¸”å®ƒä»¬éƒ½æ˜¯æ™®é€šå¯¹è±¡æ—¶ï¼Œé€’å½’è°ƒç”¨<code>mergeData</code>å‡½æ•°è¿›è¡Œæ·±åº¦åˆå¹¶ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>mergeData</code>åˆå¹¶ç­–ç•¥æ˜¯ä»¥<code>to</code>é€‰é¡¹ä¸ºä¸»ã€‚å¯¹äº<code>from</code>é€‰é¡¹ï¼Œåªæœ‰<code>to</code>é€‰é¡¹ä¸­ä¸å­˜åœ¨çš„<code>key</code>å€¼ï¼Œæ‰ä¼šè¢«æ·»åŠ åˆ°<code>to</code>é€‰é¡¹ä¸­ã€‚å¦‚æœå­˜åœ¨ç›¸åŒçš„<code>key</code>æ—¶ï¼Œå½“å®ƒçš„å€¼æ˜¯åŸå‹ç±»å‹æ—¶ï¼Œé€‰å–<code>to</code>çš„å€¼ï¼Œå³<code>to</code>çš„å€¼è¦†ç›–æ‰<code>from</code>çš„å€¼ï¼›å½“å®ƒçš„å€¼æ˜¯å¯¹è±¡ç±»å‹æ—¶ï¼Œä½¿ç”¨é€’å½’è¿›è¡Œæ·±åº¦åˆå¹¶ã€‚</p><p>å¦å¤–è¿˜æœ‰ä¸€ç‚¹<strong>éå¸¸é‡è¦</strong>ï¼Œé‚£å°±æ˜¯åˆå¹¶åçš„<code>data</code>é€‰é¡¹è¿˜æ˜¯ä¸€ä¸ª<strong>å‡½æ•°</strong>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// from</span></span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    age: <span class="number">20</span>,</span><br><span class="line">    name: <span class="string">'Hale'</span>,</span><br><span class="line">    friends: &#123;</span><br><span class="line">      Beijing: <span class="string">'xiaoming'</span>,</span><br><span class="line">      Shenzhen: <span class="string">'xiaohong'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// to</span></span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">    friends: &#123;</span><br><span class="line">      Beijing: <span class="string">'Jack'</span>,</span><br><span class="line">      Shanghai: <span class="string">'Amy'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after merge</span></span><br><span class="line">data() &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">    name: <span class="string">'Hale'</span>,</span><br><span class="line">    friends: &#123;</span><br><span class="line">      Beijing: <span class="string">'Jack'</span>,</span><br><span class="line">      Shanghai: <span class="string">'Amy'</span>,</span><br><span class="line">      Shenzhen: <span class="string">'xiaohong'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="mergeHook-ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„åˆå¹¶ç­–ç•¥"><a href="#mergeHook-ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="mergeHook ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„åˆå¹¶ç­–ç•¥"></a><code>mergeHook</code> ç”Ÿå‘½å‘¨æœŸå‡½æ•°çš„åˆå¹¶ç­–ç•¥</h3><p>ä¸‹é¢çœ‹ä¸‹ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°çš„åˆå¹¶ç­–ç•¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeHook</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: ?Array&lt;Function&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: ?Function | ?Array&lt;Function&gt;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Array</span>&lt;<span class="title">Function</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = childVal</span><br><span class="line">    ? parentVal</span><br><span class="line">      ? parentVal.concat(childVal)</span><br><span class="line">      : <span class="built_in">Array</span>.isArray(childVal)</span><br><span class="line">      ? childVal</span><br><span class="line">      : [childVal]</span><br><span class="line">    : parentVal</span><br><span class="line">  <span class="keyword">return</span> res ? dedupeHooks(res) : res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆçœ‹å‡½æ•°çš„å‚æ•°ï¼Œ<code>parentVal</code>æ˜¯ä¸€ä¸ªç”±å‡½æ•°ç»„æˆçš„æ•°ç»„ï¼Œè€Œ<code>childVal</code>å¯èƒ½æ˜¯å‡½æ•°æˆ–è€…æ˜¯ç”±å‡½æ•°ç»„æˆçš„æ•°ç»„ï¼Œå®ƒä»¬éƒ½æ˜¯å¯é€‰çš„ã€‚</p><p>å†çœ‹ä»£ç ï¼Œæ²¡æœ‰ä½¿ç”¨<code>if</code>è¯­å¥ï¼Œè€Œæ˜¯ä½¿ç”¨äº†ä¸‰ç»„ä¸‰å…ƒæ“ä½œç¬¦ã€‚</p><p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦æœ‰<code>childVal</code>ï¼Œæ²¡æœ‰çš„è¯å°±è¿”å›<code>parentVal</code>ã€‚</p><p>æœ‰<code>childVal</code>çš„è¯ï¼Œå†åˆ¤æ–­æ˜¯å¦æœ‰<code>parentVal</code>ï¼Œå¦‚æœæœ‰<code>parentVal</code>ï¼Œå°±æŠŠ<code>childVal</code>åˆå¹¶åˆ°<code>parentVal</code>ä¸­ç»„æˆæ–°çš„æ•°ç»„ã€‚å¦‚æœæ²¡æœ‰<code>parentVal</code>ï¼Œåˆ¤æ–­<code>childVal</code>çš„ç±»å‹æ˜¯å¦æ˜¯æ•°ç»„ï¼Œå¦‚æœæ˜¯æ•°ç»„ï¼Œå°±ç›´æ¥è¿”å›å®ƒæœ¬èº«ï¼›å¦‚æœä¸æ˜¯æ•°ç»„ï¼Œå°±æŠŠå®ƒåŒ…è£…æˆæ•°ç»„å¹¶è¿”å›ã€‚æ€»ä¹‹åˆå¹¶åçš„<code>res</code>ä¸€å®šæ˜¯ä¸ªæ•°ç»„ã€‚</p><p>æœ€åè¾“å‡ºç»“æœæ˜¯è¿˜éœ€è¦è°ƒç”¨<code>dedupeHooks</code>å‡½æ•°å»é™¤é‡å¤çš„é’©å­ã€‚å‡½æ•°éå†é‡Œæ•°ç»„é‡Œé¢çš„å‡½æ•°ï¼Œå¦‚æœå¤šä¸ªå‡½æ•°æ¥è‡ªåŒä¸€ä¸ªå¼•ç”¨åœ°å€ï¼Œåˆ™ä¼šæŠŠå…¶å®ƒç›¸åŒå¼•ç”¨çš„å‡½æ•°æ’é™¤æ‰ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dedupeHooks</span>(<span class="params">hooks</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; hooks.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (res.indexOf(hooks[i]) === <span class="number">-1</span>) &#123;</span><br><span class="line">      res.push(hooks[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„åˆå¹¶ç­–ç•¥ä¸­å¯ä»¥å¾—çŸ¥ï¼šåœ¨ç»„ä»¶å®ä¾‹ä¸­ï¼Œåˆ›å»ºçš„é’©å­å¯ä»¥æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå‡½æ•°ç»„æˆçš„æ•°ç»„ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>mergeHook</code> åˆå¹¶ç­–ç•¥æ˜¯æŠŠåŒç±»çš„æ‰€æœ‰çš„é’©å­éƒ½åˆå¹¶æ”¾åˆ°ä¸€ä¸ªæ•°ç»„ä¸­ã€‚</p><p>ä½†æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­å¹¶æ²¡æœ‰è¯´æ˜è¿™ç§æƒ…å†µï¼Œä½†æ˜¯ç»è¿‡å®è·µï¼Œæ˜¯å¯ä»¥è¿™ä¹ˆåšçš„ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ï¼Œè¾“å‡ºæŒ‰ç…§é¡ºåºæŒ‡å‘å‡½æ•°çš„æ‰“å°ç»“æ„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  created: [</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fn1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'created hook fn1'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fn2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'created hook fn2'</span>)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">fn3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'created hook fn3'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­çœ‹ä¸‹é¢ä»£ç ï¼Œä½¿ç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°åˆå¹¶ç­–ç•¥çš„å­—æ®µé‚£è‚¯å®šå°±æ˜¯ç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œæ¯”å¦‚<code>beforeCreate</code>ã€<code>mounted</code>ç­‰ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LIFECYCLE_HOOKS.forEach(<span class="function"><span class="params">hook</span> =&gt;</span> &#123;</span><br><span class="line">  strats[hook] = mergeHook</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> LIFECYCLE_HOOKS = [</span><br><span class="line">  <span class="string">'beforeCreate'</span>,</span><br><span class="line">  <span class="string">'created'</span>,</span><br><span class="line">  <span class="string">'beforeMount'</span>,</span><br><span class="line">  <span class="string">'mounted'</span>,</span><br><span class="line">  <span class="string">'beforeUpdate'</span>,</span><br><span class="line">  <span class="string">'updated'</span>,</span><br><span class="line">  <span class="string">'beforeDestroy'</span>,</span><br><span class="line">  <span class="string">'destroyed'</span>,</span><br><span class="line">  <span class="string">'activated'</span>,</span><br><span class="line">  <span class="string">'deactivated'</span>,</span><br><span class="line">  <span class="string">'errorCaptured'</span>,</span><br><span class="line">  <span class="string">'serverPrefetch'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentVal</span></span><br><span class="line">created: [<span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;&#125;, <span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123;&#125;],</span><br><span class="line"></span><br><span class="line"><span class="comment">// childVal</span></span><br><span class="line">created: <span class="function"><span class="keyword">function</span> <span class="title">f3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'f3'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after merge</span></span><br><span class="line">created: [</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f2</span>(<span class="params"></span>) </span>&#123;&#125;,</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">f3</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'f3'</span>)</span><br><span class="line">&#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="mergeAssets-èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥"><a href="#mergeAssets-èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="mergeAssets èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥"></a><code>mergeAssets</code> èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥</h3><p>åœ¨ Vue çš„å®ä¾‹é€‰é¡¹ä¸­ï¼Œ<code>components</code>ã€<code>directives</code>ã€<code>filters</code>è¢«è®¤ä¸ºæ˜¯èµ„æºã€‚</p><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºè¿™äº›é€‰é¡¹éƒ½æ˜¯å¯ä»¥ä½œä¸ºç¬¬ä¸‰æ–¹åº“æ¥æä¾›çš„ã€‚</p><p>èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥çš„å‡½æ•°æ˜¯<code>mergeAssets</code> ï¼Œä¸‹é¢çœ‹ä¸‹å®ƒçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeAssets</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="built_in">Object</span>.create(parentVal || <span class="literal">null</span>)</span><br><span class="line">  <span class="keyword">if</span> (childVal) &#123;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; assertObjectType(key, childVal, vm)</span><br><span class="line">    <span class="keyword">return</span> extend(res, childVal)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰<code>parentVal</code>åˆ™ä»¥å®ƒä½œä¸ºåŸå‹å¯¹è±¡åˆ›å»ºå¯¹è±¡<code>res</code>ï¼Œæ²¡æœ‰çš„è¯ä»¥<code>null</code>ä¸ºåŸå‹å¯¹è±¡åˆ›å»ºå¯¹è±¡<code>res</code>ã€‚</p><p>ç„¶ååˆ¤æ–­æ˜¯å¦æœ‰<code>childVal</code>ï¼Œå¦‚æœæœ‰çš„è¯ä½¿ç”¨<code>extend</code>æŠŠå®ƒæ‰©å±•åˆ°<code>res</code>ä¸­ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œç›´æ¥è¿”å›<code>res</code>ã€‚</p><p>å¦å¤–ï¼Œæœ‰<code>childVal</code>ä¸”åœ¨éç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œä¼šåˆ¤æ–­<code>childVal</code>çš„å¯¹è±¡ä¸­çš„å€¼æ˜¯ä¸æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯ä¼šæŠ¥é”™ã€‚</p><p><strong>å°ç»“</strong>ï¼Œ<code>mergeAssets</code> åˆå¹¶ç­–ç•¥å…ˆåˆ›å»ºä»¥<code>parentVal</code>ä¸ºåŸå‹åˆ›å»ºå¯¹è±¡<code>res</code>ï¼Œç„¶åå†ä½¿ç”¨<code>extend</code>å‡½æ•°å»æ‰©å±•<code>childVal</code>ï¼Œè¿™æ ·å¦‚æœå­˜åœ¨ç›¸åŒçš„<code>key</code>æ—¶ï¼Œ<code>childVal</code>é€‰é¡¹å°±ä¸ä¼šè¦†ç›–æ‰<code>parentVal</code>é€‰é¡¹çš„å€¼ã€‚å› ä¸º<code>parentVal</code>çš„æ˜¯å€¼ä¿å­˜åœ¨<code>res</code>çš„éšå¼åŸå‹å¯¹è±¡ <code>__proto__</code>å­—æ®µä¸­ã€‚</p><p><code>extend</code>å‡½æ•°ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">to: Object, _from: ?Object</span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> _from) &#123;</span><br><span class="line">    to[key] = _from[key]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> to</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨èµ„æºé€‰é¡¹çš„åˆå¹¶ç­–ç•¥çš„å­—æ®µå½“ç„¶å°±æ˜¯æˆ‘ä»¬ä¸Šé¢æåˆ°çš„èµ„æºé€‰é¡¹<code>components</code>ã€<code>directives</code>ã€<code>filters</code>ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ASSET_TYPES.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  strats[type + <span class="string">'s'</span>] = mergeAssets</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ASSET_TYPES = [<span class="string">'component'</span>, <span class="string">'directive'</span>, <span class="string">'filter'</span>]</span><br></pre></td></tr></table></figure><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentVal</span></span><br><span class="line">components: &#123;</span><br><span class="line">  CompA,</span><br><span class="line">  CompB</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// childVal</span></span><br><span class="line">components: &#123;</span><br><span class="line">  CompC</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after merge</span></span><br><span class="line">components: &#123;</span><br><span class="line">  CompC,</span><br><span class="line">  __proto__: &#123;</span><br><span class="line">  CompA,</span><br><span class="line"> CompB,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="watch-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"><a href="#watch-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="watch é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"></a><code>watch</code> é€‰é¡¹çš„åˆå¹¶ç­–ç•¥</h3><p>ä¸‹é¢æŸ¥çœ‹<code>watch</code>é€‰é¡¹çš„åˆå¹¶ç­–ç•¥çš„ä»£ç ï¼Œä»£ç æ¯”è¾ƒé•¿ï¼Œä¸€æ®µä¸€æ®µåˆ†æ</p><p>é¦–å…ˆçœ‹æœ€å‰é¢çš„ä¸¤è¡Œä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">strats.watch = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="comment">// work around Firefox's Object.prototype.watch...</span></span><br><span class="line">  <span class="keyword">if</span> (parentVal === nativeWatch) parentVal = <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">if</span> (childVal === nativeWatch) childVal = <span class="literal">undefined</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ¤æ–­ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹æ˜¯å¦å…¨ç­‰äº<code>nativeWatch</code>ï¼Œå®ƒæ˜¯ä¸ªä»€ä¹ˆå‘¢ï¼Ÿçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Firefox has a "watch" function on Object.prototype...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> nativeWatch = &#123;&#125;.watch</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ³¨é‡Šå’ŒæŸ¥é˜…èµ„æ–™å¾—çŸ¥ï¼ŒFirefox æµè§ˆå™¨ä¼šç»™æ¯ä¸ªå¯¹è±¡çš„åŸå‹ä¸­æ·»åŠ <code>watch</code>å±æ€§ï¼Œè¿™æ ·å°±å’Œ Vue é‡Œé¢çš„<code>watch</code>å±æ€§åç§°äº§ç”Ÿå†²çªã€‚æ‰€ä»¥éœ€è¦åˆ¤æ–­ä¸€ä¸‹ï¼Œå½“ Vue çš„ <code>watch</code>å±æ€§å’Œ FireFox æµè§ˆå™¨å®šä¹‰çš„<code>watch</code>çš„å€¼ç›¸åŒæ—¶ï¼Œä¼šæŠŠ<code>watch</code>è®¾ç½®ä¸º<code>undefined</code>ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="keyword">if</span> (!childVal) <span class="keyword">return</span> <span class="built_in">Object</span>.create(parentVal || <span class="literal">null</span>)</span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  assertObjectType(key, childVal, vm)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!parentVal) <span class="keyword">return</span> childVal</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸å­˜åœ¨<code>childVal</code>ï¼Œåˆ™è¿”å›ä»¥<code>parentVal</code>æˆ–è€…<code>null</code>ä¸ºåŸå‹åˆ›å»ºçš„å¯¹è±¡ã€‚</p><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿˜ä¼šåˆ¤æ–­ä¸‹<code>childVal</code>çš„å€¼æ˜¯å¦æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯ä¼šæŠ¥é”™ã€‚</p><p>å¦‚æœä¸å­˜åœ¨<code>parentVal</code>ï¼Œåˆ™ç›´æ¥è¿”å›<code>childVal</code>ã€‚</p><p>å¦‚æœ<code>childVal</code>å’Œ<code>parentVal</code>éƒ½å­˜åœ¨ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ret = &#123;&#125;</span><br><span class="line">extend(ret, parentVal)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> childVal) &#123;</span><br><span class="line">  <span class="keyword">let</span> parent = ret[key]</span><br><span class="line">  <span class="keyword">const</span> child = childVal[key]</span><br><span class="line">  <span class="keyword">if</span> (parent &amp;&amp; !<span class="built_in">Array</span>.isArray(parent)) &#123;</span><br><span class="line">    parent = [parent]</span><br><span class="line">  &#125;</span><br><span class="line">  ret[key] = parent</span><br><span class="line">    ? parent.concat(child)</span><br><span class="line">    : <span class="built_in">Array</span>.isArray(child)</span><br><span class="line">    ? child</span><br><span class="line">    : [child]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> ret</span><br></pre></td></tr></table></figure><p>å…ˆä»€ä¹ˆä¸€ä¸ªå˜é‡<code>ret</code>å­˜å‚¨å‡½æ•°çš„è¿”å›å€¼ã€‚ç„¶åæŠŠ<code>parentVal</code>æ‰©å±•åˆ°<code>ret</code>å¯¹è±¡ä¸­ï¼Œè¿™æ ·<code>ret</code>å°±æ‹¥æœ‰<code>parentVal</code>çš„å…¨éƒ¨å±æ€§ã€‚</p><p>ç„¶åéå†<code>childVal</code>å¯¹è±¡ï¼Œå£°æ˜ä¸€ä¸ªå˜é‡<code>parent</code>å­˜å‚¨<code>ret[key]</code>çš„å€¼ï¼Œ<strong>æ³¨æ„</strong>è¿™ä¸ªå€¼å¯èƒ½ä¸å­˜åœ¨ã€‚å£°æ˜å˜é‡<code>child</code>å­˜å‚¨<code>childVal[key]</code>çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯ä¸€å®šå­˜åœ¨çš„ã€‚</p><p>åˆ¤æ–­å¦‚æœ<code>parent</code>å­˜åœ¨ä¸”ä¸æ˜¯æ•°ç»„æ—¶ï¼ŒæŠŠ<code>parent</code>åŒ…è£…æˆä¸€ä¸ªæ•°ç»„ã€‚æœ€åå¼€å§‹ç»™<code>ret</code>èµ‹å€¼ï¼Œå®ƒçš„<code>key</code>å°±æ˜¯æ¯æ¬¡éå†<code>childVal</code>çš„<code>key</code>ã€‚åœ¨æ¯æ¬¡éå†çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå­˜åœ¨<code>parent</code>å°±æŠŠ<code>child</code>åˆå¹¶åˆ°<code>parent</code>ä¸­ç»„æˆæ–°çš„æ•°ç»„ã€‚</p><p>å¦‚æœä¸å­˜åœ¨<code>parent</code>ï¼Œåˆ¤æ–­<code>child</code>æ˜¯ä¸æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œå°±ç›´æ¥è¿”å›å®ƒæœ¬èº«ï¼›å¦‚æœä¸æ˜¯çš„è¯ï¼ŒæŠŠå®ƒåŒ…è£…æˆæ•°ç»„å¹¶è¿”å›ã€‚æœ€åè¿”å›<code>ret</code>è¿™ä¸ªå¯¹è±¡ã€‚</p><p><strong>æ€»ç»“</strong>ï¼Œ<code>watch</code>çš„åˆå¹¶ç­–ç•¥å’Œå…¶ä»–çš„ç­–ç•¥ä¸åŒï¼Œå®ƒä¸ä¼šå»é™¤ç›¸åŒ<code>key</code>çš„å€¼ï¼Œè€Œæ˜¯æŠŠå®ƒä»¬çš„å€¼ç»„åˆåœ¨ä¸€èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœæœ‰å¤šä¸ªç›‘å¬åŒä¸€ä¸ªå€¼çš„å‡½æ•°ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªå€¼å˜åŒ–æ—¶ï¼Œæ‰€æœ‰çš„ç›‘å¬å‡½æ•°éƒ½ä¼šç”Ÿæ•ˆã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentVal</span></span><br><span class="line">watch: &#123;</span><br><span class="line">  test: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'test parentVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// childVal</span></span><br><span class="line">watch: &#123;</span><br><span class="line">  test: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'test childVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after merge</span></span><br><span class="line">watch: &#123;</span><br><span class="line">  test: [</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'test parentVal'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'test childVal'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// test change</span></span><br><span class="line">vm.test = <span class="number">2</span></span><br><span class="line"><span class="comment">// test parentVal</span></span><br><span class="line"><span class="comment">// test childVal</span></span><br></pre></td></tr></table></figure><h3 id="propsã€methodsã€injectã€computedé€‰é¡¹çš„åˆå¹¶ç­–ç•¥"><a href="#propsã€methodsã€injectã€computedé€‰é¡¹çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="propsã€methodsã€injectã€computedé€‰é¡¹çš„åˆå¹¶ç­–ç•¥"></a><code>props</code>ã€<code>methods</code>ã€<code>inject</code>ã€<code>computed</code>é€‰é¡¹çš„åˆå¹¶ç­–ç•¥</h3><p>çœ‹ä¸‹é¢ä¸€æ®µä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">strats.props = strats.methods = strats.inject = strats.computed = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parentVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  childVal: ?Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (childVal &amp;&amp; process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    assertObjectType(key, childVal, vm)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!parentVal) <span class="keyword">return</span> childVal</span><br><span class="line">  <span class="keyword">const</span> ret = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">  extend(ret, parentVal)</span><br><span class="line">  <span class="keyword">if</span> (childVal) extend(ret, childVal)</span><br><span class="line">  <span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯å¯¹<code>props</code>ã€<code>methods</code>ã€<code>inject</code>ã€<code>computed</code>å­—æ®µçš„åˆå¹¶é€‰é¡¹çš„ç­–ç•¥ã€‚</p><p>ä»£ç é€»è¾‘æ¯”è¾ƒç®€å•ã€‚é¦–å…ˆå½“<code>childVal</code>å­˜åœ¨ä¸”åœ¨éç”Ÿäº§ç¯å¢ƒä¸­æ—¶ï¼Œä¼šåˆ¤æ–­<code>childVal</code>çš„å€¼æ˜¯å¦ä¸ºæ™®é€šå¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯ä¼šæŠ¥é”™ã€‚ç„¶ååˆ¤æ–­<code>parentVal</code>æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›<code>childVal</code></p><p>å†å£°æ˜ä¸€ä¸ªæ²¡æœ‰åŸå‹çš„å¯¹è±¡<code>ret</code>ï¼Œä½¿ç”¨<code>parentVal</code>æ‰©å±•å®ƒã€‚</p><p>æœ€ååˆ¤æ–­å¦‚æœæœ‰<code>childVal</code>ï¼Œä¹ŸæŠŠ<code>childVal</code>æ‰©å±•åˆ°<code>ret</code>ä¸­ï¼›å¦‚æœæ²¡æœ‰çš„è¯ï¼Œç›´æ¥è¿”å›<code>ret</code>ã€‚</p><p><strong>å°ç»“</strong>ï¼Œè¿™ä¸ªåˆå¹¶ç­–ç•¥å°±æ˜¯å¾ˆç®€å•çš„æ‰©å±•ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ²¡æœ‰åŸå‹çš„å¯¹è±¡<code>ret</code>ï¼Œå…ˆä½¿ç”¨<code>parentVal</code>æ‰©å±•ç»™å®ƒï¼Œç„¶åå†ä½¿ç”¨<code>childVal</code>æ‰©å±•å®ƒã€‚å¦‚æœé€‰é¡¹ä¸­å­˜åœ¨ç›¸åŒçš„<code>key</code>ï¼Œåé¢çš„å€¼ä¼šè¦†ç›–æ‰å‰é¢çš„å€¼ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// parentVal</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'Hale'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  fn1() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parentVal fn1'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// childVal</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'Amy'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  fn2() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'childVal fn2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after merge</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123;</span><br><span class="line">    type: <span class="built_in">String</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="string">'Amy'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">  fn1() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'parentVal fn1'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">  fn2() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'childVal fn2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="provide-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"><a href="#provide-é€‰é¡¹çš„åˆå¹¶ç­–ç•¥" class="headerlink" title="provide é€‰é¡¹çš„åˆå¹¶ç­–ç•¥"></a><code>provide</code> é€‰é¡¹çš„åˆå¹¶ç­–ç•¥</h3><p>çœ‹ä¸‹<code>provide</code> é€‰é¡¹çš„åˆå¹¶ç­–ç•¥çš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strats.provide &#x3D; mergeDataOrFn</span><br></pre></td></tr></table></figure><p><code>provide</code> é€‰é¡¹æ²¿ç”¨äº†<code>data</code>é€‰é¡¹çš„ä¸€æ ·çš„åˆå¹¶ç­–ç•¥ï¼Œè¿™é‡Œå°±ä¸å¤šèµ˜è¿°äº†ã€‚</p><h3 id="extendså’Œmixinsçš„åˆå¹¶ç­–ç•¥"><a href="#extendså’Œmixinsçš„åˆå¹¶ç­–ç•¥" class="headerlink" title="extendså’Œmixinsçš„åˆå¹¶ç­–ç•¥"></a><code>extends</code>å’Œ<code>mixins</code>çš„åˆå¹¶ç­–ç•¥</h3><p>çœ‹ä¸‹<code>extends</code>å’Œ<code>mixins</code>çš„åˆå¹¶ç­–ç•¥ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">  <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">    parent = mergeOptions(parent, child.extends, vm) <span class="comment">// ! åˆå¹¶ extends</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">      parent = mergeOptions(parent, child.mixins[i], vm) <span class="comment">// ! åˆå¹¶ mixins</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®²è§£å®Œæˆæ‰€æœ‰çš„åˆå¹¶ç­–ç•¥åï¼Œå†çœ‹<code>extends</code>å’Œ<code>mixins</code>çš„åˆå¹¶ç­–ç•¥ï¼Œè¿™é‡Œåœ¨å‰é¢è§„èŒƒåŒ–çš„æ—¶å€™å·²ç»è®²è§£è¿‡äº†ã€‚</p><p>æˆ‘ä»¬éƒ½çŸ¥é“<code>extends</code>å’Œ<code>mixins</code>é€‰é¡¹çš„ä½œç”¨æ˜¯å¤ç”¨ç»„ä»¶ä»£ç ï¼Œé‚£ä¹ˆé€‰é¡¹é‡Œé¢çš„å€¼å°±å¯èƒ½æ˜¯ä¸Šé¢å‡ºç°çš„æ‰€æœ‰é€‰é¡¹å­—æ®µï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨é€’å½’è¿›è¡Œæ·±åº¦åˆå¹¶ï¼Œç„¶åå†æ¬¡æ²¿ç”¨ä¸Šé¢çš„åˆå¹¶ç­–ç•¥ã€‚</p><h2 id="åˆå¹¶ç­–ç•¥æ€»ç»“"><a href="#åˆå¹¶ç­–ç•¥æ€»ç»“" class="headerlink" title="åˆå¹¶ç­–ç•¥æ€»ç»“"></a>åˆå¹¶ç­–ç•¥æ€»ç»“</h2><p>æ‰€æœ‰çš„åˆå¹¶ç­–ç•¥å·²ç»å·²ç»è®²è§£å®Œæ¯•ï¼Œä¸‹é¢è¿›è¡Œæ€»ç»“ã€‚</p><ul><li>å¯¹äº <code>el</code>ã€<code>propsData</code> é€‰é¡¹ä½¿ç”¨é»˜è®¤çš„åˆå¹¶ç­–ç•¥ <code>defaultStrat</code>ã€‚</li><li>å¯¹äº <code>data</code> é€‰é¡¹ï¼Œä½¿ç”¨ <code>mergeDataOrFn</code> å‡½æ•°è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆç»“æœæ˜¯ <code>data</code> é€‰é¡¹å°†å˜æˆä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›<code>mergeData</code>å‡½æ•°å¤„ç†çš„æ•°æ®ï¼Œ<code>mergeData</code>æ˜¯çœŸæ­£åˆå¹¶é€‰é¡¹çš„å‡½æ•°ã€‚</li><li>å¯¹äº <code>ç”Ÿå‘½å‘¨æœŸé’©å­</code> é€‰é¡¹ï¼Œå°†åˆå¹¶æˆæ•°ç»„ï¼Œä½¿å¾—çˆ¶å­é€‰é¡¹ä¸­çš„é’©å­å‡½æ•°éƒ½èƒ½å¤Ÿè¢«æ‰§è¡Œã€‚</li><li>å¯¹äº <code>directives</code>ã€<code>filters</code> å’Œ <code>components</code> èµ„æºé€‰é¡¹ï¼Œçˆ¶å­é€‰é¡¹å°†ä»¥åŸå‹é“¾çš„å½¢å¼è¢«å¤„ç†ï¼Œæ­£æ˜¯å› ä¸ºè¿™æ ·æˆ‘ä»¬æ‰èƒ½å¤Ÿåœ¨ä»»ä½•åœ°æ–¹éƒ½ä½¿ç”¨å†…ç½®ç»„ä»¶ã€æŒ‡ä»¤ç­‰ã€‚</li><li>å¯¹äº <code>watch</code> é€‰é¡¹çš„åˆå¹¶å¤„ç†ï¼Œç±»ä¼¼äºç”Ÿå‘½å‘¨æœŸé’©å­ï¼Œå¦‚æœçˆ¶å­é€‰é¡¹éƒ½æœ‰ç›¸åŒçš„å­—æ®µï¼ŒæŠŠå®ƒä»¬åˆå¹¶ä¸ºæ•°ç»„ï¼Œè¿™æ ·æ‰€æœ‰çš„è§‚å¯Ÿè€…éƒ½å°†è¢«æ‰§è¡Œã€‚</li><li>å¯¹äº <code>props</code>ã€<code>methods</code>ã€<code>inject</code>å’Œ<code>computed</code> é€‰é¡¹ï¼Œçˆ¶é€‰é¡¹å§‹ç»ˆå¯ç”¨ï¼Œä½†æ˜¯å­é€‰é¡¹ä¼šè¦†ç›–åŒåçš„çˆ¶é€‰é¡¹å­—æ®µã€‚</li><li>å¯¹äº <code>provide</code> é€‰é¡¹ï¼Œå…¶åˆå¹¶ç­–ç•¥ä½¿ç”¨ä¸ <code>data</code> é€‰é¡¹ç›¸åŒçš„ <code>mergeDataOrFn</code> å‡½æ•°ã€‚</li><li>æœ€åï¼Œä»¥ä¸Šæ²¡æœ‰æåŠåˆ°çš„é€‰é¡¹éƒ½å°†ä½¿é»˜è®¤é€‰é¡¹ <code>defaultStrat</code>ï¼Œåªè¦å­é€‰é¡¹ä¸æ˜¯ <code>undefined</code>å°±ä½¿ç”¨å­é€‰é¡¹ï¼Œå¦åˆ™ä½¿ç”¨çˆ¶é€‰é¡¹ã€‚</li></ul><h2 id="optionMergeStrategies-è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥"><a href="#optionMergeStrategies-è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥" class="headerlink" title="optionMergeStrategies è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥"></a><code>optionMergeStrategies</code> è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥</h2><p>Vue åœ¨å…¨å±€é…ç½®ä¸­è¿˜æä¾›äº†ä¸€ä¸ªå¯ä»¥è‡ªå®šä¹‰åˆå¹¶ç­–ç•¥çš„é€‰é¡¹<code>optionMergeStrategies</code>ï¼Œè®©ç”¨æˆ·å¯ä»¥ä¸ºä¸€äº›éç³»ç»Ÿé€‰é¡¹å­—æ®µæä¾›è‡ªå®šä¹‰çš„åˆå¹¶ç­–ç•¥ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„åˆå¹¶ç­–ç•¥ã€‚</p><p>æ¯”å¦‚ä¸ºè‡ªå®šä¹‰å­—æ®µ<code>customOption</code>çš„æä¾›è‡ªå®šä¹‰çš„åˆå¹¶ç­–ç•¥``optionMergeStrategies`ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼Œç°åœ¨åœ¨å…¥å£æ–‡ä»¶<code>main.js</code>ä¸­é…ç½®åˆå¹¶ç­–ç•¥</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Vue.config.optionMergeStrategies.customOption = <span class="function"><span class="keyword">function</span>(<span class="params">parent, child, vm</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> parent ? parent + child : child</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨å®ä¾‹ç»„ä»¶ä¸­ä½¿ç”¨è¿™ä¸ªè‡ªå®šä¹‰çš„å­—æ®µ<code>customOption</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  customOption: <span class="number">2</span>,</span><br><span class="line">  extends: &#123;</span><br><span class="line">    customOption: <span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      a: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.$options.customOption) <span class="comment">// 3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="options-åˆå¹¶åé€‰é¡¹çš„ä½¿ç”¨"><a href="#options-åˆå¹¶åé€‰é¡¹çš„ä½¿ç”¨" class="headerlink" title="$options åˆå¹¶åé€‰é¡¹çš„ä½¿ç”¨"></a><code>$options</code> åˆå¹¶åé€‰é¡¹çš„ä½¿ç”¨</h3><p>ä½¿ç”¨<code>mergeOptions</code>åä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯åˆå¹¶åçš„é€‰é¡¹ï¼Œåœ¨å®ä¾‹åŒ–ä¸­ä¼šæŠŠè¿™ä¸ªå¯¹è±¡èµ‹å€¼ç»™å®ä¾‹çš„<code>$options</code>å±æ€§ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vm.$options = mergeOptions(</span><br><span class="line">  resolveConstructorOptions(vm.constructor), <span class="comment">// ! Vue åˆå§‹åŒ–æ—¶çš„é»˜è®¤é€‰é¡¹,æ¯”å¦‚é»˜è®¤çš„æŒ‡ä»¤å’Œç»„ä»¶ç­‰ç­‰</span></span><br><span class="line">  options || &#123;&#125;, <span class="comment">// ! ç”¨æˆ·ä¼ å…¥çš„é…ç½®</span></span><br><span class="line">  vm <span class="comment">// !  Vue å®ä¾‹å¯¹è±¡æœ¬èº«</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p><code>vm.$options</code>è¿™ä¸ªå±æ€§<strong>éå¸¸é‡è¦</strong>ï¼Œåœ¨æ¥ä¸‹æ¥è®¾ç½®å…¶ä»–çš„å®ä¾‹å±æ€§æ—¶<strong>è‡³å…³é‡è¦</strong>ï¼Œå› ä¸ºéƒ½ä¼šç”¨åˆ°å®ƒã€‚</p><p>åœ¨å®ä¾‹ç»„ä»¶ä¸­ä¹Ÿå¯ä»¥è°ƒç”¨è¿™ä¸ªå±æ€§å»æ‹¿åˆ°åˆå¹¶åçš„é€‰é¡¹ï¼ŒåŒ…æ‹¬æˆ‘ä»¬è‡ªå·±è¾“å…¥çš„é€‰é¡¹ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥æ›´å¥½çš„ç¼–å†™ç»„ä»¶ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  name: <span class="string">'Home'</span>,</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      a: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line">    test() &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'test method'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.$options.name) <span class="comment">// 'Home'</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.$options.methods.test) <span class="comment">// function test() &#123; console.log('test method') &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¸Šä¸€ç« çš„ä»£ç è§„èŒƒåŒ–äº†å„ä¸ªé€‰é¡¹çš„å€¼ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ¥ä¸‹æ¥æ›´å¥½çš„è¿›è¡Œåˆå¹¶é€‰é¡¹ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢å¼€å§‹å°±æ˜¯çœŸæ­£è¿›è¡Œé€‰é¡¹åˆå¹¶çš„ä»£ç ã€‚&lt;/p&gt;
&lt;p&gt;å…·ä½“è¦æ€ä¹ˆåˆå¹¶å‘¢ï¼Ÿä¸åŒçš„å­—æ®µçš„åˆå¹¶ç­–ç•¥æ˜¯ä¸€æ ·çš„å—ï¼Ÿ&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹é€‰é¡¹åˆå¹¶çš„è§„èŒƒåŒ–</title>
    <link href="https://haledeng.com/blog/20190830-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%80%89%E9%A1%B9%E5%90%88%E5%B9%B6%E7%9A%84%E8%A7%84%E8%8C%83%E5%8C%96/"/>
    <id>https://haledeng.com/blog/20190830-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E9%80%89%E9%A1%B9%E5%90%88%E5%B9%B6%E7%9A%84%E8%A7%84%E8%8C%83%E5%8C%96/</id>
    <published>2019-08-30T12:00:00.000Z</published>
    <updated>2020-05-07T08:56:14.777Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨ä½¿ç”¨<code>new</code>åˆ›å»º Vue çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œå¿…å®šä¼ å…¥ä¸€ä¸ªå‚æ•°å¯¹è±¡<code>options</code>è¿›å»ï¼Œè¿™ä¸ªå‚æ•°å¯¹è±¡å…¶å®å°±æ˜¯ Vue çš„é€‰é¡¹<code>options</code>ã€‚æ¯”å¦‚åœ¨ Vue é¡¹ç›®çš„å…¥å£æ–‡ä»¶ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">const</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  router,</span><br><span class="line">  store,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><a id="more"></a><p>å¦å¤–ï¼Œåˆ›å»ºæ¯ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œåœ¨<code>script</code>ä¸­ä¹Ÿä¼šå¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- çœç•¥æ¨¡æ¿ä»£ç  --&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  props: &#123;&#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;&#125;,</span><br><span class="line">  methods: &#123;&#125;</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹è±¡ä¹Ÿæ˜¯ç”¨æˆ·è¾“å…¥çš„<code>options</code>ï¼Œé¡¹ç›®å…¥å£æ–‡ä»¶æœ‰<code>options</code>ï¼Œç»„ä»¶ä¹Ÿæœ‰<code>options</code>ï¼Œå†åŠ ä¸Š Vue æœ¬èº«ä¹Ÿè‡ªå¸¦<code>options</code>ï¼Œè¿™ä¹ˆå¤šçš„<code>options</code>çœ‹èµ·æ¥éå¸¸ä¹±ï¼Œæ‰€ä»¥éœ€è¦åˆå¹¶é€‰é¡¹ã€‚</p><p>åœ¨åˆå§‹åŒ–å®ä¾‹çš„æ–¹æ³•<code>_init</code>ä¸­ï¼Œä½¿ç”¨äº†<code>mergeOptions</code>æ–¹æ³•åˆå¹¶é€‰é¡¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</span><br><span class="line">  <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">  <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">  <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">  initInternalComponent(vm, options)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ! åˆå¹¶é…ç½®</span></span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor), <span class="comment">// ! Vue åˆå§‹åŒ–æ—¶çš„é»˜è®¤é€‰é¡¹,æ¯”å¦‚é»˜è®¤çš„æŒ‡ä»¤å’Œç»„ä»¶ç­‰ç­‰</span></span><br><span class="line">    options || &#123;&#125;, <span class="comment">// ! ç”¨æˆ·ä¼ å…¥çš„é…ç½®</span></span><br><span class="line">    vm <span class="comment">// !  Vue å®ä¾‹å¯¹è±¡æœ¬èº«</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>mergeOptions</code>æ–¹æ³•ä¼ å…¥äº†ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯é»˜è®¤é€‰é¡¹ã€ç”¨æˆ·é€‰é¡¹ä»¥åŠå®ä¾‹å¯¹è±¡æœ¬èº«ã€‚</p><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é»˜è®¤é€‰é¡¹ï¼Œé€šè¿‡è°ƒç”¨<code>resolveConstructorOptions</code>å‡½æ•°æ—¶ä¼ å…¥<code>vm.constructor</code>å‚æ•°æ¥è·å–çš„ã€‚</p><h2 id="resolveConstructorOptions"><a href="#resolveConstructorOptions" class="headerlink" title="resolveConstructorOptions"></a><code>resolveConstructorOptions</code></h2><p>å…ˆçœ‹ä¸‹<code>resolveConstructorOptions</code>å‡½æ•°çš„ä»£ç ï¼Œä»å‡½æ•°åå¯ä»¥çœ‹å‡ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨åº”è¯¥æ˜¯è§£ææ„é€ å‡½æ•°çš„é€‰é¡¹çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span>(<span class="params">Ctor: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = Ctor.options</span><br><span class="line">  <span class="keyword">if</span> (Ctor.super) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å‚æ•°æ˜¯<code>vm.constructor</code>ï¼Œå³å®ä¾‹å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>Vue</code>ã€‚</p><p>å…ˆå£°æ˜å˜é‡<code>options</code>å­˜å‚¨æ„é€ å‡½æ•°çš„<code>options</code>ï¼Œç„¶åä¸‹é¢æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­è¨€ï¼Œå¦‚æœå­˜åœ¨<code>Ctor.super</code>å±æ€§ï¼Œå°±ä¼šæ‰§è¡Œåé¢çš„ä»£ç ã€‚è¿™ä¸ª<code>super</code>çš„å±æ€§åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº† Vue çš„å…¨å±€æ–¹æ³•<code>extend</code>åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œå†é€šè¿‡è¿™ä¸ªå­ç±»åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å¯¹è±¡çš„<code>constructor</code>å°±æ˜¯è¿™ä¸ªå­ç±»ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sub = Vue.extend() <span class="comment">// å­ç±»</span></span><br><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> Sub() <span class="comment">// å­ç±»ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>extend</code>åˆ›å»ºçš„å­ç±»ä¼šæœ‰ä¸€ä¸ªç‰¹æ€§çš„å±æ€§<code>super</code>ï¼Œå®ƒçš„å€¼ä¸€èˆ¬å°±æ˜¯ Vue çš„æ„é€ å‡½æ•°ã€‚</p><p>å› ä¸ºè¿™é‡Œæ˜¯ Vue çš„å®ä¾‹åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¼ å…¥çš„å‚æ•°<code>Ctor</code>å°±æ˜¯ Vue çš„æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯å­ç±»ï¼Œä¹Ÿä¸å¯èƒ½æœ‰<code>super</code>å±æ€§ï¼Œæ‰€ä»¥å‡½æ•°çš„<code>if</code>çš„ä»£ç å—æ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚</p><p>åœ¨å®ä¾‹å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å°±å¯ä»¥ç®€åŒ–ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span>(<span class="params">Ctor: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = Ctor.options</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°æœ€åè¿”å›<code>Ctor.options</code>ï¼Œå³<code>Vue</code>çš„é»˜è®¤é€‰é¡¹<code>options</code>ã€‚å®ƒç°åœ¨åº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Vue.options = &#123;</span><br><span class="line">components: &#123;</span><br><span class="line">KeepAlive</span><br><span class="line">Transition,</span><br><span class="line">    TransitionGroup</span><br><span class="line">&#125;,</span><br><span class="line">directives:&#123;</span><br><span class="line">    model,</span><br><span class="line">        show</span><br><span class="line">&#125;,</span><br><span class="line">filters: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">_base: Vue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›é€‰é¡¹éƒ½æ˜¯åœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°å’Œå¹³å°åŒ–åŒ…è£…æ—¶æ·»åŠ åˆ° Vue çš„æ„é€ å‡½æ•°çš„<code>options</code>å±æ€§ä¸­çš„ã€‚</p><p><code>mergeOptions</code>å‡½æ•°ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°<code>options</code>æ˜¯ç”¨æˆ·è¾“å…¥çš„ï¼Œåœ¨ Vue é¡¹ç›®çš„å…¥å£æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨<code>new</code>åˆ›å»º Vue çš„å®ä¾‹å¹¶ä¼ å…¥é€‰é¡¹é…ç½®ï¼Œä¼ å…¥çš„é€‰é¡¹å¯èƒ½æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    a: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mergeOptions</code>å‡½æ•°ä¼ å…¥çš„æœ€åä¸€ä¸ªå‚æ•°<code>vm</code>ï¼Œè¿™æ˜¯å®ä¾‹å¯¹è±¡æœ¬èº«ã€‚</p><h2 id="mergeOptions"><a href="#mergeOptions" class="headerlink" title="mergeOptions"></a><code>mergeOptions</code></h2><h3 id="checkComponents"><a href="#checkComponents" class="headerlink" title="checkComponents"></a><code>checkComponents</code></h3><p>åˆ†æå‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°åï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹<code>mergeOptions</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/util/options.js</code>æ–‡ä»¶ä¸­</p><p>å‡½æ•°ä»£ç æ¯”è¾ƒé•¿ï¼Œå…ˆçœ‹å‰é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  child: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    checkComponents(child)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæŸ¥çœ‹å‡½æ•°çš„å‚æ•°ï¼Œå‚æ•°åˆ†åˆ«æ˜¯<code>parent</code>ã€<code>child</code>å’Œ<code>vm</code>ã€‚åœ¨å®ä¾‹åˆå§‹åŒ–è°ƒç”¨å‡½æ•°çš„ï¼Œ<code>parent</code>å°±æ˜¯é»˜è®¤é€‰é¡¹é…ç½®ï¼Œ<code>child</code>æ˜¯ç”¨æˆ·è¾“å…¥çš„é€‰é¡¹é…ç½®ï¼Œ<code>vm</code>æ˜¯å®ä¾‹å¯¹è±¡ã€‚</p><p>å†çœ‹å‡½æ•°ä½“ä»£ç ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¼šè°ƒç”¨<code>checkComponents</code>å‡½æ•°æ£€æŸ¥ä¸€ä¸‹<code>child</code>é€‰é¡¹ï¼Œè¿™é‡Œä¸»è¦æ ¡éªŒé€‰é¡¹çš„<code>components</code>å±æ€§ä¸­çš„å„ä¸ªç»„ä»¶åã€‚</p><p>æˆ‘ä»¬åœ¨ç»„ä»¶ä¸­å¼•å…¥å¦å¤–ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œéƒ½éœ€è¦æ³¨å†Œå¼•å…¥çš„è¿™ä¸ªç»„ä»¶ï¼Œæ³¨å†Œæ˜¯æŠŠç»„ä»¶æ”¾å…¥åˆ°<code>components</code>é€‰é¡¹ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CompA <span class="keyword">from</span> <span class="string">'../components/CompA'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  components: &#123; CompA &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹<code>checkComponents</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkComponents</span>(<span class="params">options: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> options.components) &#123;</span><br><span class="line">    validateComponentName(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä¸­éå†<code>components</code>é€‰é¡¹ä¸­çš„å…ƒç´ ï¼Œå†ä½¿ç”¨<code>validateComponentName</code>å‡½æ•°æ£€æŸ¥ä¸‹é€‰é¡¹ä¸­çš„<code>name</code>æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚<code>name</code>å°±æ˜¯<code>components</code>å¯¹è±¡ä¸­<code>key</code>çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">validateComponentName</span>(<span class="params">name: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^[a-zA-Z][\\-\\.0-9_<span class="subst">$&#123;unicodeRegExp.source&#125;</span>]*$`</span>).test(name)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Invalid component name: "'</span> +</span><br><span class="line">        name +</span><br><span class="line">        <span class="string">'". Component names '</span> +</span><br><span class="line">        <span class="string">'should conform to valid custom element name in html5 specification.'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBuiltInTag(name) || config.isReservedTag(name)) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Do not use built-in or reserved HTML elements as component '</span> +</span><br><span class="line">        <span class="string">'id: '</span> +</span><br><span class="line">        name</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†ä¸¤ä¸ª<code>if</code>æ¥åˆ¤æ–­<code>name</code>çš„å€¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åŒæ—¶ç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶æ‰ä¸ä¼šæŠ¥é”™ã€‚</p><ol><li><p>æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼<code>new RegExp(<code>^[a-zA-Z][\\-\\.0-9_${unicodeRegExp.source}]*$</code>)</code></p></li><li><p>æ»¡è¶³æ¡ä»¶<code>isBuiltInTag(name) || config.isReservedTag(name)</code></p></li></ol><p>å¯¹äºç¬¬ä¸€æ¡ï¼Œ<code>name</code>çš„å€¼çš„å¼€å¤´å¿…é¡»ç”±å­—ç¬¦ç»„æˆï¼Œåé¢å¯ä»¥æ˜¯<code>-</code>ç¬¦æˆ–è€…<code>.</code>ç¬¦æˆ–è€…æ•°å­—ä»¥åŠç‰¹æ®Šå­—ç¬¦ã€‚</p><p>å¯¹äºç¬¬äºŒæ¡ï¼Œ<code>name</code>çš„å€¼ä¸èƒ½æ˜¯ Vue å†…ç½®çš„ç»„ä»¶åæ¯”å¦‚<code>slot</code>ã€<code>componnet</code>æˆ–è€…æ˜¯ä¿ç•™çš„ HTML æ ‡ç­¾åã€‚</p><p><code>isBuiltInTag</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isBuiltInTag = makeMap(<span class="string">'slot,component'</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p><code>isReservedTag</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isReservedTag = (tag: string): ?<span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> isHTMLTag(tag) || isSVG(tag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="functional-options"><a href="#functional-options" class="headerlink" title="functional options"></a><code>functional options</code></h3><p>ç»§ç»­çœ‹<code>mergeOptions</code>å‡½æ•°ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å½“ child æ˜¯å‡½æ•°æ—¶ï¼ˆVue.extend åˆ›é€ çš„å­ç±»ï¼‰ï¼Œè·å–å…¶é™æ€å±æ€§ options</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">'function'</span>) &#123;</span><br><span class="line">  child = child.options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨æˆ·çš„é€‰é¡¹æ˜¯å‡½æ•°ç±»å‹çš„ï¼Œå°±è·å–å®ƒçš„<code>options</code>å±æ€§ã€‚</p><p>ä»€ä¹ˆæ—¶å€™é€‰é¡¹æ˜¯ä¸€ä¸ªå‡½æ•°å‘¢ï¼Ÿå¦å¤–ï¼Œä»€ä¹ˆå‡½æ•°ä¼šæœ‰å±æ€§<code>options</code>å‘¢ï¼Ÿ</p><p>Vue çš„æ„é€ å‡½æ•°å°±æœ‰è¿™ä¸ª<code>options</code>å±æ€§ï¼Œå¦å¤–é€šè¿‡<code>Vue.extend</code>åˆ›å»ºçš„å­ç±»ä¹Ÿå¯èƒ½ä¼šæœ‰<code>optinons</code>å±æ€§ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å¯¹äº<code>child</code>è¿™ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥ä¸€ä¸ª Vue çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥é€šè¿‡<code>Vue.extend</code>çš„åˆ›å»ºçš„å­ç±»ã€‚</p><h3 id="normalizeFn"><a href="#normalizeFn" class="headerlink" title="normalizeFn"></a><code>normalizeFn</code></h3><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æœ‰äº›ç±»å‹çš„é€‰é¡¹æ¯”è¾ƒçµæ´»å¤šå˜ï¼Œéœ€è¦å…ˆè§„èŒƒåŒ–åï¼Œå†åˆå¹¶</span></span><br><span class="line">normalizeProps(child, vm) <span class="comment">// ! è§„èŒƒåŒ– props ç±»å‹</span></span><br><span class="line">normalizeInject(child, vm) <span class="comment">// ! è§„èŒƒåŒ– inject ç±»å‹</span></span><br><span class="line">normalizeDirectives(child) <span class="comment">// ! è§„èŒƒåŒ– æŒ‡ä»¤</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†ä¸‰ä¸ªå‡½æ•°å»è§„èŒƒåŒ–é€‰é¡¹ï¼Œåˆ†åˆ«è§„èŒƒ<code>props</code>ã€<code>inject</code>å’Œ<code>directive</code>é€‰é¡¹ã€‚</p><p>ä¸ºä»€ä¹ˆè¦å»è§„èŒƒåŒ–è¿™äº›é€‰é¡¹å‘¢ï¼Ÿä»¥<code>props</code>é€‰é¡¹ä¸ºä¾‹ï¼Œå®ƒçš„å€¼éå¸¸çµæ´»ï¼Œå³å¯ä»¥æ˜¯æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ã€‚å¦å¤–ï¼Œå¯¹è±¡é‡Œé¢çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªè¡¨ç¤ºæ•°æ®ç±»å‹çš„å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">props: [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: <span class="built_in">String</span>, <span class="comment">// é»˜è®¤å€¼ä¸ºç±»å‹</span></span><br><span class="line">  age: &#123;</span><br><span class="line">    type: <span class="built_in">Number</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="number">18</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Vue ä¸ºä½¿ç”¨è€…æä¾›è¿™äº›çµæ´»çš„æ¥å£ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯å¥½äº‹ï¼Œä½†å¯¹äº Vue æ¥è¯´å´ä¸æ˜¯ï¼Œå› ä¸ºéœ€è¦æŠŠä¸åŒç±»å‹æˆ–è€…æ ¼å¼çš„æ•°æ®è§„èŒƒæˆç»Ÿä¸€çš„æ•°æ®ç±»å‹å’Œæ ¼å¼ï¼Œè¿™æ ·åé¢æ‰èƒ½æ›´å¥½çš„åˆå¹¶é€‰é¡¹ã€‚</p><p>ä¸‹é¢åˆ†åˆ«æŸ¥çœ‹æ¯ä¸ªè§„èŒƒå‡½æ•°çš„ä»£ç ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯åœ¨<code>core/util/options.js</code>æ–‡ä»¶ä¸­ã€‚</p><h4 id="normalizeProps"><a href="#normalizeProps" class="headerlink" title="normalizeProps"></a><code>normalizeProps</code></h4><p>æŸ¥çœ‹<code>normalizeProps</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeProps</span>(<span class="params">options: Object, vm: ?Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props = options.props</span><br><span class="line">  <span class="keyword">if</span> (!props) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> i, val, name</span><br><span class="line">  <span class="comment">// ! è§„èŒƒæ•°ç»„ç±»å‹çš„ props</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(props)) &#123;</span><br><span class="line">    i = props.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      val = props[i]</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'string'</span>) &#123;</span><br><span class="line">        name = camelize(val)</span><br><span class="line">        res[name] = &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125; <span class="comment">// !ä¸æ¸…é™¤ç±»å‹ç»Ÿä¸€è®¾ç½®ä¸º null</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        warn(<span class="string">'props must be strings when using array syntax.'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ! è§„èŒƒå¯¹è±¡ç±»å‹çš„ props</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPlainObject(props)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">      val = props[key]</span><br><span class="line">      name = camelize(key)</span><br><span class="line">      res[name] = isPlainObject(val) ? val : &#123; <span class="attr">type</span>: val &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Invalid value for option "props": expected an Array or an Object, `</span> +</span><br><span class="line">        <span class="string">`but got <span class="subst">$&#123;toRawType(props)&#125;</span>.`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  options.props = res <span class="comment">// ! æœ€ç»ˆéƒ½è½¬æ¢æˆå¯¹è±¡ç±»å‹çš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>normalizeProps</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>props</code>é€‰é¡¹çš„ï¼Œä»£ç é€»è¾‘å¹¶ä¸éš¾ã€‚å› ä¸ºé€‰é¡¹<code>props</code>çš„å€¼åªèƒ½æœ‰ä¸¤ç§ç±»å‹ï¼Œä½¿ç”¨ <code>if</code>è¯­å¥åˆ†åˆ«åˆ¤æ–­è¿™ä¸¤ç§ç±»å‹å³å¯ï¼Œå¦‚æœå®ƒçš„å€¼éƒ½ä¸æ˜¯è¿™ä¸¤ç§ç±»å‹ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>å…ˆå£°æ˜ä¸€ä¸ªå˜é‡<code>res</code>å­˜å‚¨è§„èŒƒåçš„å€¼ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†è¿›è¡Œè§„èŒƒã€‚</p><p>å½“<code>props</code>çš„å€¼æ˜¯æ•°ç»„ç±»å‹æ—¶ï¼Œéå†æ•°ç»„ï¼Œç„¶åä»¥æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä½œä¸º<code>key</code>ï¼Œ<code>{type: null}</code>ä½œä¸ºå€¼ï¼Œç»„æˆé”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨å‰é¢å£°æ˜çš„å˜é‡<code>res</code>ä¸­ã€‚å¦å¤–è¿˜éœ€è¦åˆ¤æ–­æ•°ç»„é‡Œé¢çš„å…ƒç´ çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå¦åˆ™åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">props: [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„æ•°ç»„ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“<code>props</code>çš„å€¼æ˜¯å¯¹è±¡æ—¶ï¼Œéå†å¯¹è±¡ï¼Œä½¿ç”¨å˜é‡<code>val</code>å­˜å‚¨å¯¹è±¡ä¸­åŸæœ‰çš„å€¼ï¼Œå¦‚æœå€¼æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡æ—¶ï¼Œç›´æ¥èµ‹å€¼ä¸ºåŸæ¥çš„å€¼ï¼›å¦‚æœä¸æ˜¯ï¼Œå°±æŠŠè¿™ä¸ªå€¼è½¬æ¢æˆç±»å‹çš„å€¼<code>{type: val}</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">18</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">18</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨äº†<code>camelize</code>å‡½æ•°æŠŠæ¯ä¸ªè¿å­—ç¬¦<code>-</code>å½¢å¼çš„<code>key</code>è½¬æ¢æˆé©¼å³°çš„å½¢å¼ã€‚</p><p><strong>å°ç»“</strong>ï¼Œä¸ç®¡<code>props</code>é€‰é¡¹çš„å€¼æ˜¯æ•°ç»„ç±»å‹è¿˜æ˜¯å¯¹è±¡ç±»å‹ï¼Œæœ€åéƒ½ä¼šè½¬æ¢æˆå¯¹è±¡ç±»å‹ï¼Œç„¶åå¯¹è±¡é‡Œçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><h4 id="normalizeInject"><a href="#normalizeInject" class="headerlink" title="normalizeInject"></a><code>normalizeInject</code></h4><p>æŸ¥çœ‹<code>normalizeInject</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeInject</span>(<span class="params">options: Object, vm: ?Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inject = options.inject</span><br><span class="line">  <span class="keyword">if</span> (!inject) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> normalized = (options.inject = &#123;&#125;)</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(inject)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; inject.length; i++) &#123;</span><br><span class="line">      normalized[inject[i]] = &#123; <span class="attr">from</span>: inject[i] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPlainObject(inject)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> inject) &#123;</span><br><span class="line">      <span class="keyword">const</span> val = inject[key]</span><br><span class="line">      normalized[key] = isPlainObject(val)</span><br><span class="line">        ? extend(&#123; <span class="attr">from</span>: key &#125;, val)</span><br><span class="line">        : &#123; <span class="attr">from</span>: val &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Invalid value for option "inject": expected an Array or an Object, `</span> +</span><br><span class="line">        <span class="string">`but got <span class="subst">$&#123;toRawType(inject)&#125;</span>.`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">s</span><br></pre></td></tr></table></figure><p><code>normalizeInject</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>inject</code>é€‰é¡¹çš„ï¼Œä»£ç é€»è¾‘ä¹Ÿä¸éš¾ã€‚é€‰é¡¹<code>inject</code>çš„ç”¨æ³•å’Œ<code>props</code>æœ‰ç‚¹ç›¸ä¼¼ï¼Œå®ƒçš„å€¼å¯ä»¥æ˜¯æ•°ç»„ç±»å‹ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ç±»å‹ã€‚å¦‚æœä¸æ˜¯è¿™ä¸¤ç§ç±»å‹ï¼Œåœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>å½“<code>inject</code>çš„å€¼æ˜¯æ•°ç»„ç±»å‹æ—¶ï¼Œéå†æ•°ç»„ï¼Œç„¶åè½¬æ¢æˆé”®å€¼å¯¹çš„å¯¹è±¡ç±»å‹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½æ˜¯åŸæ¥çš„æ•°ç»„å…ƒç´ ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">inject: [<span class="string">'data1'</span>, <span class="string">'data2'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„æ•°ç»„ç±»å‹</span></span><br><span class="line">injecrt: &#123;</span><br><span class="line">  data1: &#123; <span class="attr">from</span>: <span class="string">'data1'</span>&#125;,</span><br><span class="line">data2: &#123; <span class="attr">from</span>: <span class="string">'data2'</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“<code>inject</code>çš„å€¼ä¸ºå¯¹è±¡ç±»å‹æ—¶ï¼Œéå†å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡é‡Œçš„å€¼æ˜¯æ™®é€šå¯¹è±¡æ—¶ï¼Œåœ¨å¯¹è±¡é‡Œé¢è®¾ç½® <code>from</code> çš„å€¼ä¸ºåŸæ¥ <code>key</code> çš„å€¼ï¼Œç„¶åå’ŒåŸæ¥çš„å¯¹è±¡è¿›è¡Œåˆå¹¶ï¼›å¦‚æœå¯¹è±¡é‡Œçš„å€¼æ˜¯å­—ç¬¦ä¸²æ—¶ï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨è®¾ç½®å¯¹è±¡é‡Œé¢çš„<code>from</code>çš„å€¼ä¸ºåŸæ¥çš„å­—ç¬¦ä¸²ç±»å‹çš„å€¼ï¼ŒåŸæ¥å¯¹è±¡çš„ <code>key</code>ä¸ä¼šæ”¹å˜ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  data1, <span class="comment">// ç›¸å½“äº data1: data1</span></span><br><span class="line">  d2: <span class="string">'data2'</span>,</span><br><span class="line">  data3: &#123; <span class="attr">someProperty</span>: <span class="string">'someValue'</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„å¯¹è±¡ç±»å‹</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  data1: &#123; <span class="attr">from</span>: <span class="string">'data1'</span> &#125;,</span><br><span class="line">  d2: &#123; <span class="attr">from</span>: <span class="string">'data2'</span>&#125;,</span><br><span class="line">  data3: &#123; <span class="attr">from</span>: <span class="string">'data3'</span>, <span class="attr">someProperty</span>: <span class="string">'someValue'</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å°ç»“</strong>ï¼Œä¸ç®¡<code>inject</code>é€‰é¡¹çš„å€¼æ˜¯æ•°ç»„ç±»å‹è¿˜æ˜¯å¯¹è±¡ç±»å‹ï¼Œæœ€åéƒ½ä¼šè½¬æ¢æˆå¯¹è±¡ç±»å‹ï¼Œç„¶åå¯¹è±¡é‡Œçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><h4 id="normalizeDirectives"><a href="#normalizeDirectives" class="headerlink" title="normalizeDirectives"></a><code>normalizeDirectives</code></h4><p>æŸ¥çœ‹<code>normalizeDirectives</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeDirectives</span>(<span class="params">options: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dirs = options.directives</span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> dirs) &#123;</span><br><span class="line">      <span class="keyword">const</span> def = dirs[key]</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> def === <span class="string">'function'</span>) &#123;</span><br><span class="line">        dirs[key] = &#123; <span class="attr">bind</span>: def, <span class="attr">update</span>: def &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>normalizeDirectives</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>directives</code>é€‰é¡¹çš„ã€‚<code>directives</code>çš„å€¼åªèƒ½æ˜¯å¯¹è±¡ç±»å‹ï¼Œä½†æ˜¯å¯¹è±¡é‡Œé¢çš„å€¼å¯ä»¥æ˜¯å‡½æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ç±»å‹ã€‚å¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠå®ƒè½¬æ¢æˆå¯¹è±¡ï¼Œå¹¶èµ‹å€¼æˆä¸ºå¯¹è±¡çš„<code>bind</code>å’Œ<code>update</code>å±æ€§ï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¸ç”¨è½¬æ¢ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">directives: &#123;</span><br><span class="line">  test1: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  test2: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒå</span></span><br><span class="line">directives: &#123;</span><br><span class="line">  test1: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  test2: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">    update: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è§„èŒƒåŒ–extends-å’Œmixins"><a href="#è§„èŒƒåŒ–extends-å’Œmixins" class="headerlink" title="è§„èŒƒåŒ–extends å’Œmixins"></a>è§„èŒƒåŒ–<code>extends</code> å’Œ<code>mixins</code></h3><p>ç»§ç»­çœ‹<code>mergeOptions</code>å‡½æ•°åé¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">  <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">    parent = mergeOptions(parent, child.extends, vm) <span class="comment">// ! åˆå¹¶ extends</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">      parent = mergeOptions(parent, child.mixins[i], vm) <span class="comment">// ! åˆå¹¶ mixins</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯å¤„ç†<code>options</code>ä¸­çš„<code>extends</code>é€‰é¡¹å’Œ<code>mixins</code>é€‰é¡¹çš„ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½å’Œç»„ä»¶çš„ä»£ç å¤ç”¨æœ‰å…³ã€‚</p><p>å¯¹äºè¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œéƒ½æ˜¯é€’å½’è°ƒç”¨<code>mergeOptions</code>æ¥å¤„ç†ï¼Œå¹¶ä¸”æŠŠé»˜è®¤çš„<code>parent</code>é€‰é¡¹ ã€ç”¨æˆ·è¾“å…¥çš„<code>extends</code>æˆ–è€…<code>mixins</code>é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„é€‰é¡¹ä½œä¸ºé»˜è®¤é€‰é¡¹<code>parent</code>ã€‚</p><p><code>extends</code>é€‰é¡¹çš„å€¼æ˜¯ä¸ç®¡æ˜¯å¯¹è±¡ç±»å‹è¿˜æ˜¯å‡½æ•°ç±»å‹ï¼Œéƒ½å¯ä»¥ç›´æ¥å’Œ<code>parent</code>é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œå› ä¸ºå‰é¢å·²ç»å¯¹å‡½æ•°ç±»å‹çš„å€¼è¿›è¡Œäº†å¤„ç†ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">extends: &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°ç±»å‹ï¼Œä½¿ç”¨ Vue.extend ç”Ÿæˆå­ç±»</span></span><br><span class="line"><span class="keyword">const</span> Ctor = Vue.extend(&#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">extends: Ctor</span><br></pre></td></tr></table></figure><p>è€Œ<code>mixins</code>é€‰é¡¹çš„å€¼å¿…é¡»æ˜¯æ•°ç»„ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦éå†æ•°ç»„ï¼Œè€Œæ•°ç»„ä¸­çš„å…ƒç´ <code>mixin</code>å¿…é¡»æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§é¡ºåºä¸€ä¸ªä¸ªå’Œ<code>parent</code>è¿›è¡Œåˆå¹¶ã€‚è¿™é‡Œæ³¨æ„ä¸€ä¸‹ä¼˜å…ˆçº§ï¼Œæ•°ç»„ä¸­æ’åºé åçš„<code>mixin</code>ä¸­çš„é…ç½®ä¼šè¦†ç›–å‰é¢çš„<code>mixin</code>çš„é…ç½®ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">userMixin: &#123;</span><br><span class="line">data() &#123;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">playMixin: &#123;</span><br><span class="line">data() &#123;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line"> &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mixins: [userMixin, playMixin]</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œåˆ›å»ºæ¯ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œåœ¨<code>script</code>ä¸­ä¹Ÿä¼šå¯¼å‡ºä¸€ä¸ªå¯¹è±¡ï¼Œä¾‹å¦‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;!-- çœç•¥æ¨¡æ¿ä»£ç  --&gt;</span><br><span class="line">&lt;&#x2F;template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">  props: &#123;&#125;,</span><br><span class="line">  data() &#123;</span><br><span class="line">    return &#123;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;&#125;,</span><br><span class="line">  methods: &#123;&#125;</span><br><span class="line">  &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹è±¡ä¹Ÿæ˜¯ç”¨æˆ·è¾“å…¥çš„<code>options</code>ï¼Œé¡¹ç›®å…¥å£æ–‡ä»¶æœ‰<code>options</code>ï¼Œç»„ä»¶ä¹Ÿæœ‰<code>options</code>ï¼Œå†åŠ ä¸Š Vue æœ¬èº«ä¹Ÿè‡ªå¸¦<code>options</code>ï¼Œè¿™ä¹ˆå¤šçš„<code>options</code>çœ‹èµ·æ¥éå¸¸ä¹±ï¼Œæ‰€ä»¥éœ€è¦åˆå¹¶é€‰é¡¹ã€‚</p><p>åœ¨åˆå§‹åŒ–å®ä¾‹çš„æ–¹æ³•<code>_init</code>ä¸­ï¼Œä½¿ç”¨äº†<code>mergeOptions</code>æ–¹æ³•åˆå¹¶é€‰é¡¹ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</span><br><span class="line">  <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">  <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">  <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">  initInternalComponent(vm, options)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ! åˆå¹¶é…ç½®</span></span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor), <span class="comment">// ! Vue åˆå§‹åŒ–æ—¶çš„é»˜è®¤é€‰é¡¹,æ¯”å¦‚é»˜è®¤çš„æŒ‡ä»¤å’Œç»„ä»¶ç­‰ç­‰</span></span><br><span class="line">    options || &#123;&#125;, <span class="comment">// ! ç”¨æˆ·ä¼ å…¥çš„é…ç½®</span></span><br><span class="line">    vm <span class="comment">// !  Vue å®ä¾‹å¯¹è±¡æœ¬èº«</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>mergeOptions</code>æ–¹æ³•ä¼ å…¥äº†ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯é»˜è®¤é€‰é¡¹ã€ç”¨æˆ·é€‰é¡¹ä»¥åŠå®ä¾‹å¯¹è±¡æœ¬èº«ã€‚</p><p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯é»˜è®¤é€‰é¡¹ï¼Œé€šè¿‡è°ƒç”¨<code>resolveConstructorOptions</code>å‡½æ•°æ—¶ä¼ å…¥<code>vm.constructor</code>å‚æ•°æ¥è·å–çš„ã€‚</p><h2 id="resolveConstructorOptions-1"><a href="#resolveConstructorOptions-1" class="headerlink" title="resolveConstructorOptions"></a><code>resolveConstructorOptions</code></h2><p>å…ˆçœ‹ä¸‹<code>resolveConstructorOptions</code>å‡½æ•°çš„ä»£ç ï¼Œä»å‡½æ•°åå¯ä»¥çœ‹å‡ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨åº”è¯¥æ˜¯è§£ææ„é€ å‡½æ•°çš„é€‰é¡¹çš„ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span>(<span class="params">Ctor: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = Ctor.options</span><br><span class="line">  <span class="keyword">if</span> (Ctor.super) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å‚æ•°æ˜¯<code>vm.constructor</code>ï¼Œå³å®ä¾‹å¯¹è±¡çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯<code>Vue</code>ã€‚</p><p>å…ˆå£°æ˜å˜é‡<code>options</code>å­˜å‚¨æ„é€ å‡½æ•°çš„<code>options</code>ï¼Œç„¶åä¸‹é¢æ˜¯ä¸€ä¸ªæ¡ä»¶è¯­è¨€ï¼Œå¦‚æœå­˜åœ¨<code>Ctor.super</code>å±æ€§ï¼Œå°±ä¼šæ‰§è¡Œåé¢çš„ä»£ç ã€‚è¿™ä¸ª<code>super</code>çš„å±æ€§åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨äº† Vue çš„å…¨å±€æ–¹æ³•<code>extend</code>åˆ›å»ºä¸€ä¸ªå­ç±»ï¼Œå†é€šè¿‡è¿™ä¸ªå­ç±»åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªå®ä¾‹å¯¹è±¡çš„<code>constructor</code>å°±æ˜¯è¿™ä¸ªå­ç±»ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Sub = Vue.extend() <span class="comment">// å­ç±»</span></span><br><span class="line"><span class="keyword">const</span> s = <span class="keyword">new</span> Sub() <span class="comment">// å­ç±»ç”Ÿæˆçš„å®ä¾‹å¯¹è±¡</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>extend</code>åˆ›å»ºçš„å­ç±»ä¼šæœ‰ä¸€ä¸ªç‰¹æ€§çš„å±æ€§<code>super</code>ï¼Œå®ƒçš„å€¼ä¸€èˆ¬å°±æ˜¯ Vue çš„æ„é€ å‡½æ•°ã€‚</p><p>å› ä¸ºè¿™é‡Œæ˜¯ Vue çš„å®ä¾‹åˆå§‹åŒ–çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥ä¼ å…¥çš„å‚æ•°<code>Ctor</code>å°±æ˜¯ Vue çš„æ„é€ å‡½æ•°ï¼Œè€Œä¸æ˜¯å­ç±»ï¼Œä¹Ÿä¸å¯èƒ½æœ‰<code>super</code>å±æ€§ï¼Œæ‰€ä»¥å‡½æ•°çš„<code>if</code>çš„ä»£ç å—æ˜¯ä¸ä¼šæ‰§è¡Œçš„ã€‚</p><p>åœ¨å®ä¾‹å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªå‡½æ•°å°±å¯ä»¥ç®€åŒ–ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveConstructorOptions</span>(<span class="params">Ctor: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> options = Ctor.options</span><br><span class="line">  <span class="keyword">return</span> options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°æœ€åè¿”å›<code>Ctor.options</code>ï¼Œå³<code>Vue</code>çš„é»˜è®¤é€‰é¡¹<code>options</code>ã€‚å®ƒç°åœ¨åº”è¯¥æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Vue.options = &#123;</span><br><span class="line">components: &#123;</span><br><span class="line">KeepAlive</span><br><span class="line">Transition,</span><br><span class="line">    TransitionGroup</span><br><span class="line">&#125;,</span><br><span class="line">directives:&#123;</span><br><span class="line">    model,</span><br><span class="line">        show</span><br><span class="line">&#125;,</span><br><span class="line">filters: <span class="built_in">Object</span>.create(<span class="literal">null</span>),</span><br><span class="line">_base: Vue</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›é€‰é¡¹éƒ½æ˜¯åœ¨æ‰©å±• Vue çš„æ„é€ å‡½æ•°å’Œå¹³å°åŒ–åŒ…è£…æ—¶æ·»åŠ åˆ° Vue çš„æ„é€ å‡½æ•°çš„<code>options</code>å±æ€§ä¸­çš„ã€‚</p><p><code>mergeOptions</code>å‡½æ•°ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°<code>options</code>æ˜¯ç”¨æˆ·è¾“å…¥çš„ï¼Œåœ¨ Vue é¡¹ç›®çš„å…¥å£æ–‡ä»¶ä¸­ï¼Œä½¿ç”¨<code>new</code>åˆ›å»º Vue çš„å®ä¾‹å¹¶ä¼ å…¥é€‰é¡¹é…ç½®ï¼Œä¼ å…¥çš„é€‰é¡¹å¯èƒ½æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  data: &#123;</span><br><span class="line">    a: <span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>mergeOptions</code>å‡½æ•°ä¼ å…¥çš„æœ€åä¸€ä¸ªå‚æ•°<code>vm</code>ï¼Œè¿™æ˜¯å®ä¾‹å¯¹è±¡æœ¬èº«ã€‚</p><h2 id="mergeOptions-1"><a href="#mergeOptions-1" class="headerlink" title="mergeOptions"></a><code>mergeOptions</code></h2><h3 id="checkComponents-1"><a href="#checkComponents-1" class="headerlink" title="checkComponents"></a><code>checkComponents</code></h3><p>åˆ†æå‡½æ•°è°ƒç”¨æ—¶çš„å‚æ•°åï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹<code>mergeOptions</code>å‡½æ•°çš„ä»£ç ï¼Œåœ¨<code>core/util/options.js</code>æ–‡ä»¶ä¸­</p><p>å‡½æ•°ä»£ç æ¯”è¾ƒé•¿ï¼Œå…ˆçœ‹å‰é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mergeOptions</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  parent: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  child: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  vm?: Component</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    checkComponents(child)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæŸ¥çœ‹å‡½æ•°çš„å‚æ•°ï¼Œå‚æ•°åˆ†åˆ«æ˜¯<code>parent</code>ã€<code>child</code>å’Œ<code>vm</code>ã€‚åœ¨å®ä¾‹åˆå§‹åŒ–è°ƒç”¨å‡½æ•°çš„ï¼Œ<code>parent</code>å°±æ˜¯é»˜è®¤é€‰é¡¹é…ç½®ï¼Œ<code>child</code>æ˜¯ç”¨æˆ·è¾“å…¥çš„é€‰é¡¹é…ç½®ï¼Œ<code>vm</code>æ˜¯å®ä¾‹å¯¹è±¡ã€‚</p><p>å†çœ‹å‡½æ•°ä½“ä»£ç ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œä¼šè°ƒç”¨<code>checkComponents</code>å‡½æ•°æ£€æŸ¥ä¸€ä¸‹<code>child</code>é€‰é¡¹ï¼Œè¿™é‡Œä¸»è¦æ ¡éªŒé€‰é¡¹çš„<code>components</code>å±æ€§ä¸­çš„å„ä¸ªç»„ä»¶åã€‚</p><p>æˆ‘ä»¬åœ¨ç»„ä»¶ä¸­å¼•å…¥å¦å¤–ä¸€ä¸ªç»„ä»¶æ—¶ï¼Œéƒ½éœ€è¦æ³¨å†Œå¼•å…¥çš„è¿™ä¸ªç»„ä»¶ï¼Œæ³¨å†Œæ˜¯æŠŠç»„ä»¶æ”¾å…¥åˆ°<code>components</code>é€‰é¡¹ä¸­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CompA <span class="keyword">from</span> <span class="string">'../components/CompA'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  components: &#123; CompA &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹<code>checkComponents</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkComponents</span>(<span class="params">options: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> options.components) &#123;</span><br><span class="line">    validateComponentName(key)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°ä¸­éå†<code>components</code>é€‰é¡¹ä¸­çš„å…ƒç´ ï¼Œå†ä½¿ç”¨<code>validateComponentName</code>å‡½æ•°æ£€æŸ¥ä¸‹é€‰é¡¹ä¸­çš„<code>name</code>æ˜¯å¦ç¬¦åˆè¦æ±‚ã€‚<code>name</code>å°±æ˜¯<code>components</code>å¯¹è±¡ä¸­<code>key</code>çš„å€¼ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">validateComponentName</span>(<span class="params">name: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    !<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^[a-zA-Z][\\-\\.0-9_<span class="subst">$&#123;unicodeRegExp.source&#125;</span>]*$`</span>).test(name)</span><br><span class="line">  ) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Invalid component name: "'</span> +</span><br><span class="line">        name +</span><br><span class="line">        <span class="string">'". Component names '</span> +</span><br><span class="line">        <span class="string">'should conform to valid custom element name in html5 specification.'</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (isBuiltInTag(name) || config.isReservedTag(name)) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">'Do not use built-in or reserved HTML elements as component '</span> +</span><br><span class="line">        <span class="string">'id: '</span> +</span><br><span class="line">        name</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨äº†ä¸¤ä¸ª<code>if</code>æ¥åˆ¤æ–­<code>name</code>çš„å€¼æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œä¹Ÿå°±æ˜¯éœ€è¦åŒæ—¶ç¬¦åˆè¿™ä¸¤ä¸ªæ¡ä»¶æ‰ä¸ä¼šæŠ¥é”™ã€‚</p><ol><li><p>æ»¡è¶³æ­£åˆ™è¡¨è¾¾å¼<code>new RegExp(<code>^[a-zA-Z][\\-\\.0-9_${unicodeRegExp.source}]*$</code>)</code></p></li><li><p>æ»¡è¶³æ¡ä»¶<code>isBuiltInTag(name) || config.isReservedTag(name)</code></p></li></ol><p>å¯¹äºç¬¬ä¸€æ¡ï¼Œ<code>name</code>çš„å€¼çš„å¼€å¤´å¿…é¡»ç”±å­—ç¬¦ç»„æˆï¼Œåé¢å¯ä»¥æ˜¯<code>-</code>ç¬¦æˆ–è€…<code>.</code>ç¬¦æˆ–è€…æ•°å­—ä»¥åŠç‰¹æ®Šå­—ç¬¦ã€‚</p><p>å¯¹äºç¬¬äºŒæ¡ï¼Œ<code>name</code>çš„å€¼ä¸èƒ½æ˜¯ Vue å†…ç½®çš„ç»„ä»¶åæ¯”å¦‚<code>slot</code>ã€<code>componnet</code>æˆ–è€…æ˜¯ä¿ç•™çš„ HTML æ ‡ç­¾åã€‚</p><p><code>isBuiltInTag</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isBuiltInTag = makeMap(<span class="string">'slot,component'</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p><code>isReservedTag</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> isReservedTag = (tag: string): ?<span class="function"><span class="params">boolean</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> isHTMLTag(tag) || isSVG(tag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="functional-options-1"><a href="#functional-options-1" class="headerlink" title="functional options"></a><code>functional options</code></h3><p>ç»§ç»­çœ‹<code>mergeOptions</code>å‡½æ•°ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å½“ child æ˜¯å‡½æ•°æ—¶ï¼ˆVue.extend åˆ›é€ çš„å­ç±»ï¼‰ï¼Œè·å–å…¶é™æ€å±æ€§ options</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> child === <span class="string">'function'</span>) &#123;</span><br><span class="line">  child = child.options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨æˆ·çš„é€‰é¡¹æ˜¯å‡½æ•°ç±»å‹çš„ï¼Œå°±è·å–å®ƒçš„<code>options</code>å±æ€§ã€‚</p><p>ä»€ä¹ˆæ—¶å€™é€‰é¡¹æ˜¯ä¸€ä¸ªå‡½æ•°å‘¢ï¼Ÿå¦å¤–ï¼Œä»€ä¹ˆå‡½æ•°ä¼šæœ‰å±æ€§<code>options</code>å‘¢ï¼Ÿ</p><p>Vue çš„æ„é€ å‡½æ•°å°±æœ‰è¿™ä¸ª<code>options</code>å±æ€§ï¼Œå¦å¤–é€šè¿‡<code>Vue.extend</code>åˆ›å»ºçš„å­ç±»ä¹Ÿå¯èƒ½ä¼šæœ‰<code>optinons</code>å±æ€§ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´å¯¹äº<code>child</code>è¿™ä¸ªå‚æ•°å¯ä»¥ä¼ å…¥ä¸€ä¸ª Vue çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ä¼ å…¥é€šè¿‡<code>Vue.extend</code>çš„åˆ›å»ºçš„å­ç±»ã€‚</p><h3 id="normalizeFn-1"><a href="#normalizeFn-1" class="headerlink" title="normalizeFn"></a><code>normalizeFn</code></h3><p>æ¥ä¸‹æ¥ç»§ç»­çœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! æœ‰äº›ç±»å‹çš„é€‰é¡¹æ¯”è¾ƒçµæ´»å¤šå˜ï¼Œéœ€è¦å…ˆè§„èŒƒåŒ–åï¼Œå†åˆå¹¶</span></span><br><span class="line">normalizeProps(child, vm) <span class="comment">// ! è§„èŒƒåŒ– props ç±»å‹</span></span><br><span class="line">normalizeInject(child, vm) <span class="comment">// ! è§„èŒƒåŒ– inject ç±»å‹</span></span><br><span class="line">normalizeDirectives(child) <span class="comment">// ! è§„èŒƒåŒ– æŒ‡ä»¤</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨äº†ä¸‰ä¸ªå‡½æ•°å»è§„èŒƒåŒ–é€‰é¡¹ï¼Œåˆ†åˆ«è§„èŒƒ<code>props</code>ã€<code>inject</code>å’Œ<code>directive</code>é€‰é¡¹ã€‚</p><p>ä¸ºä»€ä¹ˆè¦å»è§„èŒƒåŒ–è¿™äº›é€‰é¡¹å‘¢ï¼Ÿä»¥<code>props</code>é€‰é¡¹ä¸ºä¾‹ï¼Œå®ƒçš„å€¼éå¸¸çµæ´»ï¼Œå³å¯ä»¥æ˜¯æ•°ç»„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ã€‚å¦å¤–ï¼Œå¯¹è±¡é‡Œé¢çš„å€¼å¯ä»¥æ˜¯ä¸€ä¸ªè¡¨ç¤ºæ•°æ®ç±»å‹çš„å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ™®é€šå¯¹è±¡ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">props: [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: <span class="built_in">String</span>, <span class="comment">// é»˜è®¤å€¼ä¸ºç±»å‹</span></span><br><span class="line">  age: &#123;</span><br><span class="line">    type: <span class="built_in">Number</span>,</span><br><span class="line">    <span class="keyword">default</span>: <span class="number">18</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Vue ä¸ºä½¿ç”¨è€…æä¾›è¿™äº›çµæ´»çš„æ¥å£ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯å¥½äº‹ï¼Œä½†å¯¹äº Vue æ¥è¯´å´ä¸æ˜¯ï¼Œå› ä¸ºéœ€è¦æŠŠä¸åŒç±»å‹æˆ–è€…æ ¼å¼çš„æ•°æ®è§„èŒƒæˆç»Ÿä¸€çš„æ•°æ®ç±»å‹å’Œæ ¼å¼ï¼Œè¿™æ ·åé¢æ‰èƒ½æ›´å¥½çš„åˆå¹¶é€‰é¡¹ã€‚</p><p>ä¸‹é¢åˆ†åˆ«æŸ¥çœ‹æ¯ä¸ªè§„èŒƒå‡½æ•°çš„ä»£ç ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯åœ¨<code>core/util/options.js</code>æ–‡ä»¶ä¸­ã€‚</p><h4 id="normalizeProps-1"><a href="#normalizeProps-1" class="headerlink" title="normalizeProps"></a><code>normalizeProps</code></h4><p>æŸ¥çœ‹<code>normalizeProps</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeProps</span>(<span class="params">options: Object, vm: ?Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props = options.props</span><br><span class="line">  <span class="keyword">if</span> (!props) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> res = &#123;&#125;</span><br><span class="line">  <span class="keyword">let</span> i, val, name</span><br><span class="line">  <span class="comment">// ! è§„èŒƒæ•°ç»„ç±»å‹çš„ props</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(props)) &#123;</span><br><span class="line">    i = props.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      val = props[i]</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">'string'</span>) &#123;</span><br><span class="line">        name = camelize(val)</span><br><span class="line">        res[name] = &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125; <span class="comment">// !ä¸æ¸…é™¤ç±»å‹ç»Ÿä¸€è®¾ç½®ä¸º null</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        warn(<span class="string">'props must be strings when using array syntax.'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ! è§„èŒƒå¯¹è±¡ç±»å‹çš„ props</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPlainObject(props)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">      val = props[key]</span><br><span class="line">      name = camelize(key)</span><br><span class="line">      res[name] = isPlainObject(val) ? val : &#123; <span class="attr">type</span>: val &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Invalid value for option "props": expected an Array or an Object, `</span> +</span><br><span class="line">        <span class="string">`but got <span class="subst">$&#123;toRawType(props)&#125;</span>.`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  options.props = res <span class="comment">// ! æœ€ç»ˆéƒ½è½¬æ¢æˆå¯¹è±¡ç±»å‹çš„å€¼</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>normalizeProps</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>props</code>é€‰é¡¹çš„ï¼Œä»£ç é€»è¾‘å¹¶ä¸éš¾ã€‚å› ä¸ºé€‰é¡¹<code>props</code>çš„å€¼åªèƒ½æœ‰ä¸¤ç§ç±»å‹ï¼Œä½¿ç”¨ <code>if</code>è¯­å¥åˆ†åˆ«åˆ¤æ–­è¿™ä¸¤ç§ç±»å‹å³å¯ï¼Œå¦‚æœå®ƒçš„å€¼éƒ½ä¸æ˜¯è¿™ä¸¤ç§ç±»å‹ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>å…ˆå£°æ˜ä¸€ä¸ªå˜é‡<code>res</code>å­˜å‚¨è§„èŒƒåçš„å€¼ï¼Œå®ƒçš„åˆå§‹å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åå†è¿›è¡Œè§„èŒƒã€‚</p><p>å½“<code>props</code>çš„å€¼æ˜¯æ•°ç»„ç±»å‹æ—¶ï¼Œéå†æ•°ç»„ï¼Œç„¶åä»¥æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ä½œä¸º<code>key</code>ï¼Œ<code>{type: null}</code>ä½œä¸ºå€¼ï¼Œç»„æˆé”®å€¼å¯¹çš„å½¢å¼å­˜å‚¨åœ¨å‰é¢å£°æ˜çš„å˜é‡<code>res</code>ä¸­ã€‚å¦å¤–è¿˜éœ€è¦åˆ¤æ–­æ•°ç»„é‡Œé¢çš„å…ƒç´ çš„å€¼å¿…é¡»æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå¦åˆ™åœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">props: [<span class="string">'name'</span>, <span class="string">'age'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„æ•°ç»„ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="literal">null</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“<code>props</code>çš„å€¼æ˜¯å¯¹è±¡æ—¶ï¼Œéå†å¯¹è±¡ï¼Œä½¿ç”¨å˜é‡<code>val</code>å­˜å‚¨å¯¹è±¡ä¸­åŸæœ‰çš„å€¼ï¼Œå¦‚æœå€¼æ˜¯ä¸€ä¸ªæ™®é€šçš„å¯¹è±¡æ—¶ï¼Œç›´æ¥èµ‹å€¼ä¸ºåŸæ¥çš„å€¼ï¼›å¦‚æœä¸æ˜¯ï¼Œå°±æŠŠè¿™ä¸ªå€¼è½¬æ¢æˆç±»å‹çš„å€¼<code>{type: val}</code>ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">18</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„å¯¹è±¡ç±»å‹</span></span><br><span class="line">props: &#123;</span><br><span class="line">  name: &#123; <span class="attr">type</span>: <span class="built_in">String</span> &#125;,</span><br><span class="line">  age: &#123; <span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">default</span>: <span class="number">18</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨äº†<code>camelize</code>å‡½æ•°æŠŠæ¯ä¸ªè¿å­—ç¬¦<code>-</code>å½¢å¼çš„<code>key</code>è½¬æ¢æˆé©¼å³°çš„å½¢å¼ã€‚</p><p><strong>å°ç»“</strong>ï¼Œä¸ç®¡<code>props</code>é€‰é¡¹çš„å€¼æ˜¯æ•°ç»„ç±»å‹è¿˜æ˜¯å¯¹è±¡ç±»å‹ï¼Œæœ€åéƒ½ä¼šè½¬æ¢æˆå¯¹è±¡ç±»å‹ï¼Œç„¶åå¯¹è±¡é‡Œçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><h4 id="normalizeInject-1"><a href="#normalizeInject-1" class="headerlink" title="normalizeInject"></a><code>normalizeInject</code></h4><p>æŸ¥çœ‹<code>normalizeInject</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeInject</span>(<span class="params">options: Object, vm: ?Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inject = options.inject</span><br><span class="line">  <span class="keyword">if</span> (!inject) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">const</span> normalized = (options.inject = &#123;&#125;)</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(inject)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; inject.length; i++) &#123;</span><br><span class="line">      normalized[inject[i]] = &#123; <span class="attr">from</span>: inject[i] &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isPlainObject(inject)) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> inject) &#123;</span><br><span class="line">      <span class="keyword">const</span> val = inject[key]</span><br><span class="line">      normalized[key] = isPlainObject(val)</span><br><span class="line">        ? extend(&#123; <span class="attr">from</span>: key &#125;, val)</span><br><span class="line">        : &#123; <span class="attr">from</span>: val &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warn(</span><br><span class="line">      <span class="string">`Invalid value for option "inject": expected an Array or an Object, `</span> +</span><br><span class="line">        <span class="string">`but got <span class="subst">$&#123;toRawType(inject)&#125;</span>.`</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">s</span><br></pre></td></tr></table></figure><p><code>normalizeInject</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>inject</code>é€‰é¡¹çš„ï¼Œä»£ç é€»è¾‘ä¹Ÿä¸éš¾ã€‚é€‰é¡¹<code>inject</code>çš„ç”¨æ³•å’Œ<code>props</code>æœ‰ç‚¹ç›¸ä¼¼ï¼Œå®ƒçš„å€¼å¯ä»¥æ˜¯æ•°ç»„ç±»å‹ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ç±»å‹ã€‚å¦‚æœä¸æ˜¯è¿™ä¸¤ç§ç±»å‹ï¼Œåœ¨å¼€å‘ç¯å¢ƒä¸­ä¼šæŠ¥é”™ã€‚</p><p>å½“<code>inject</code>çš„å€¼æ˜¯æ•°ç»„ç±»å‹æ—¶ï¼Œéå†æ•°ç»„ï¼Œç„¶åè½¬æ¢æˆé”®å€¼å¯¹çš„å¯¹è±¡ç±»å‹ï¼Œå…¶ä¸­é”®å’Œå€¼éƒ½æ˜¯åŸæ¥çš„æ•°ç»„å…ƒç´ ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ•°ç»„ç±»å‹</span></span><br><span class="line">inject: [<span class="string">'data1'</span>, <span class="string">'data2'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„æ•°ç»„ç±»å‹</span></span><br><span class="line">injecrt: &#123;</span><br><span class="line">  data1: &#123; <span class="attr">from</span>: <span class="string">'data1'</span>&#125;,</span><br><span class="line">data2: &#123; <span class="attr">from</span>: <span class="string">'data2'</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“<code>inject</code>çš„å€¼ä¸ºå¯¹è±¡ç±»å‹æ—¶ï¼Œéå†å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡é‡Œçš„å€¼æ˜¯æ™®é€šå¯¹è±¡æ—¶ï¼Œåœ¨å¯¹è±¡é‡Œé¢è®¾ç½® <code>from</code> çš„å€¼ä¸ºåŸæ¥ <code>key</code> çš„å€¼ï¼Œç„¶åå’ŒåŸæ¥çš„å¯¹è±¡è¿›è¡Œåˆå¹¶ï¼›å¦‚æœå¯¹è±¡é‡Œçš„å€¼æ˜¯å­—ç¬¦ä¸²æ—¶ï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨è®¾ç½®å¯¹è±¡é‡Œé¢çš„<code>from</code>çš„å€¼ä¸ºåŸæ¥çš„å­—ç¬¦ä¸²ç±»å‹çš„å€¼ï¼ŒåŸæ¥å¯¹è±¡çš„ <code>key</code>ä¸ä¼šæ”¹å˜ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  data1, <span class="comment">// ç›¸å½“äº data1: data1</span></span><br><span class="line">  d2: <span class="string">'data2'</span>,</span><br><span class="line">  data3: &#123; <span class="attr">someProperty</span>: <span class="string">'someValue'</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒåçš„å¯¹è±¡ç±»å‹</span></span><br><span class="line">inject: &#123;</span><br><span class="line">  data1: &#123; <span class="attr">from</span>: <span class="string">'data1'</span> &#125;,</span><br><span class="line">  d2: &#123; <span class="attr">from</span>: <span class="string">'data2'</span>&#125;,</span><br><span class="line">  data3: &#123; <span class="attr">from</span>: <span class="string">'data3'</span>, <span class="attr">someProperty</span>: <span class="string">'someValue'</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å°ç»“</strong>ï¼Œä¸ç®¡<code>inject</code>é€‰é¡¹çš„å€¼æ˜¯æ•°ç»„ç±»å‹è¿˜æ˜¯å¯¹è±¡ç±»å‹ï¼Œæœ€åéƒ½ä¼šè½¬æ¢æˆå¯¹è±¡ç±»å‹ï¼Œç„¶åå¯¹è±¡é‡Œçš„å€¼ä¹Ÿæ˜¯ä¸€ä¸ªå¯¹è±¡ã€‚</p><h4 id="normalizeDirectives-1"><a href="#normalizeDirectives-1" class="headerlink" title="normalizeDirectives"></a><code>normalizeDirectives</code></h4><p>æŸ¥çœ‹<code>normalizeDirectives</code>å‡½æ•°çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">normalizeDirectives</span>(<span class="params">options: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dirs = options.directives</span><br><span class="line">  <span class="keyword">if</span> (dirs) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> dirs) &#123;</span><br><span class="line">      <span class="keyword">const</span> def = dirs[key]</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> def === <span class="string">'function'</span>) &#123;</span><br><span class="line">        dirs[key] = &#123; <span class="attr">bind</span>: def, <span class="attr">update</span>: def &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>normalizeDirectives</code>å‡½æ•°æ˜¯ç”¨æ¥è§„èŒƒ<code>directives</code>é€‰é¡¹çš„ã€‚<code>directives</code>çš„å€¼åªèƒ½æ˜¯å¯¹è±¡ç±»å‹ï¼Œä½†æ˜¯å¯¹è±¡é‡Œé¢çš„å€¼å¯ä»¥æ˜¯å‡½æ•°ç±»å‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡ç±»å‹ã€‚å¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå°±æŠŠå®ƒè½¬æ¢æˆå¯¹è±¡ï¼Œå¹¶èµ‹å€¼æˆä¸ºå¯¹è±¡çš„<code>bind</code>å’Œ<code>update</code>å±æ€§ï¼Œå¦‚æœå®ƒçš„å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ä¸ç”¨è½¬æ¢ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">directives: &#123;</span><br><span class="line">  test1: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  test2: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è§„èŒƒå</span></span><br><span class="line">directives: &#123;</span><br><span class="line">  test1: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'v-test1'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  test2: &#123;</span><br><span class="line">    bind: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;,</span><br><span class="line">    update: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'v-test2'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è§„èŒƒåŒ–extends-å’Œmixins-1"><a href="#è§„èŒƒåŒ–extends-å’Œmixins-1" class="headerlink" title="è§„èŒƒåŒ–extends å’Œmixins"></a>è§„èŒƒåŒ–<code>extends</code> å’Œ<code>mixins</code></h3><p>ç»§ç»­çœ‹<code>mergeOptions</code>å‡½æ•°åé¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!child._base) &#123;</span><br><span class="line">  <span class="keyword">if</span> (child.extends) &#123;</span><br><span class="line">    parent = mergeOptions(parent, child.extends, vm) <span class="comment">// ! åˆå¹¶ extends</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (child.mixins) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = child.mixins.length; i &lt; l; i++) &#123;</span><br><span class="line">      parent = mergeOptions(parent, child.mixins[i], vm) <span class="comment">// ! åˆå¹¶ mixins</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ˜¯å¤„ç†<code>options</code>ä¸­çš„<code>extends</code>é€‰é¡¹å’Œ<code>mixins</code>é€‰é¡¹çš„ï¼Œè¿™ä¸¤ä¸ªé€‰é¡¹éƒ½å’Œç»„ä»¶çš„ä»£ç å¤ç”¨æœ‰å…³ã€‚</p><p>å¯¹äºè¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œéƒ½æ˜¯é€’å½’è°ƒç”¨<code>mergeOptions</code>æ¥å¤„ç†ï¼Œå¹¶ä¸”æŠŠé»˜è®¤çš„<code>parent</code>é€‰é¡¹ ã€ç”¨æˆ·è¾“å…¥çš„<code>extends</code>æˆ–è€…<code>mixins</code>é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„é€‰é¡¹ä½œä¸ºé»˜è®¤é€‰é¡¹<code>parent</code>ã€‚</p><p><code>extends</code>é€‰é¡¹çš„å€¼æ˜¯ä¸ç®¡æ˜¯å¯¹è±¡ç±»å‹è¿˜æ˜¯å‡½æ•°ç±»å‹ï¼Œéƒ½å¯ä»¥ç›´æ¥å’Œ<code>parent</code>é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œå› ä¸ºå‰é¢å·²ç»å¯¹å‡½æ•°ç±»å‹çš„å€¼è¿›è¡Œäº†å¤„ç†ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹è±¡ç±»å‹</span></span><br><span class="line">extends: &#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡½æ•°ç±»å‹ï¼Œä½¿ç”¨ Vue.extend ç”Ÿæˆå­ç±»</span></span><br><span class="line"><span class="keyword">const</span> Ctor = Vue.extend(&#123;</span><br><span class="line">  data() &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  created() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line">extends: Ctor</span><br></pre></td></tr></table></figure><p>è€Œ<code>mixins</code>é€‰é¡¹çš„å€¼å¿…é¡»æ˜¯æ•°ç»„ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦éå†æ•°ç»„ï¼Œè€Œæ•°ç»„ä¸­çš„å…ƒç´ <code>mixin</code>å¿…é¡»æ˜¯å¯¹è±¡ç±»å‹ï¼Œæ‰€ä»¥å¯ä»¥æŒ‰ç…§é¡ºåºä¸€ä¸ªä¸ªå’Œ<code>parent</code>è¿›è¡Œåˆå¹¶ã€‚è¿™é‡Œæ³¨æ„ä¸€ä¸‹ä¼˜å…ˆçº§ï¼Œæ•°ç»„ä¸­æ’åºé åçš„<code>mixin</code>ä¸­çš„é…ç½®ä¼šè¦†ç›–å‰é¢çš„<code>mixin</code>çš„é…ç½®ã€‚</p><p>ç¤ºä¾‹ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">userMixin: &#123;</span><br><span class="line">data() &#123;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#125;,</span><br><span class="line">playMixin: &#123;</span><br><span class="line">data() &#123;</span><br><span class="line">&#x2F;&#x2F; ...</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line"> &#x2F;&#x2F; ...</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mixins: [userMixin, playMixin]</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆ‘ä»¬åœ¨ä½¿ç”¨&lt;code&gt;new&lt;/code&gt;åˆ›å»º Vue çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œå¿…å®šä¼ å…¥ä¸€ä¸ªå‚æ•°å¯¹è±¡&lt;code&gt;options&lt;/code&gt;è¿›å»ï¼Œè¿™ä¸ªå‚æ•°å¯¹è±¡å…¶å®å°±æ˜¯ Vue çš„é€‰é¡¹&lt;code&gt;options&lt;/code&gt;ã€‚æ¯”å¦‚åœ¨ Vue é¡¹ç›®çš„å…¥å£æ–‡ä»¶ä¸­&lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// main.js&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;const&lt;/span&gt; vm = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; Vue(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  el: &lt;span class=&quot;string&quot;&gt;&#39;#app&#39;&lt;/span&gt;,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  router,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  store,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  render: &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;h&lt;/span&gt; =&amp;gt;&lt;/span&gt; h(App)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹åˆå§‹åŒ–å¼€ç¯‡</title>
    <link href="https://haledeng.com/blog/20190828-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%80%E7%AF%87/"/>
    <id>https://haledeng.com/blog/20190828-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%88%9D%E5%A7%8B%E5%8C%96%E5%BC%80%E7%AF%87/</id>
    <published>2019-08-28T12:00:00.000Z</published>
    <updated>2020-05-07T08:56:21.481Z</updated>
    
    <content type="html"><![CDATA[<p>Vue çš„åŸºæœ¬çš„ç»“æ„æˆ‘ä»¬å·²ç»å¼„æ¸…æ¥šäº†ï¼Œä¸‹é¢æ­£å¼å­¦ä¹  Vue çš„å®ä¾‹å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><p>ç°åœ¨æˆ‘ä»¬å›åˆ°å‡ºç”Ÿåœ°æ–‡ä»¶<code>core/instance/index.js</code>ï¼ŒæŸ¥çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; initMixin &#125; <span class="keyword">from</span> <span class="string">'./init'</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initMixin(Vue)</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨<code>new</code>çš„åˆ›å»ºå®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„<code>this._init()</code>æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠé€‰é¡¹å‚æ•°<code>options</code>ä¼ å…¥ï¼Œè¿™å°±æ˜¯ Vue çš„åˆå§‹åŒ–æ–¹æ³•ã€‚</p><a id="more"></a><h2 id="init-åˆå§‹åŒ–æ–¹æ³•"><a href="#init-åˆå§‹åŒ–æ–¹æ³•" class="headerlink" title="_init åˆå§‹åŒ–æ–¹æ³•"></a><code>_init</code> åˆå§‹åŒ–æ–¹æ³•</h2><p>è¿™ä¸ªæ–¹æ³•æ˜¯é€šè¿‡<code>initMixin(Vue)</code>å‡½æ•°æ·»åŠ åˆ° Vue çš„æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡ä¸­çš„ï¼Œç°åœ¨æ‰“å¼€<code>core/instance/init.js</code>æ–‡ä»¶ï¼Œçœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">initMixin</span>(<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ! åˆå§‹åŒ–çš„æ–¹æ³•</span></span><br><span class="line">  Vue.prototype._init = <span class="function"><span class="keyword">function</span>(<span class="params">options?: Object</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line">    <span class="comment">// a uid</span></span><br><span class="line">    vm._uid = uid++ <span class="comment">// ! å”¯ä¸€æ ‡ç¤º</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p><code>_init</code>æ–¹æ³•ä¸­é¦–å…ˆä½¿ç”¨å¸¸é‡<code>vm</code>æ¥ç¼“å­˜<code>this</code>ï¼Œä½†æ˜¯è¿™ä¸ª<code>this</code>åˆ°åº•æŒ‡å‘å“ªé‡Œå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çŸ¥é“åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œæ˜¯ä½¿ç”¨<code>this._init()</code>è°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•çš„ï¼Œè€Œä¸”æ˜¯åœ¨ä½¿ç”¨<code>new</code>åˆ›å»ºå®ä¾‹çš„æ—¶å€™è°ƒç”¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ª<code>this</code>å¾ˆæ˜æ˜¾åº”è¯¥æŒ‡å‘çš„æ˜¯åˆ›å»ºçš„<strong>å®ä¾‹å¯¹è±¡</strong>ã€‚</p><p>ç„¶åå¾€å®ä¾‹å¯¹è±¡ä¸­æ·»åŠ å”¯ä¸€æ ‡è¯†<code>_uid</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œåˆå§‹å€¼æ˜¯<code>0</code>ï¼Œå®ƒçš„å€¼æ˜¯é€’å¢çš„ ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„<code>_uid</code>å€¼éƒ½æ˜¯<strong>ä¸ä¸€æ ·</strong>çš„ã€‚</p><p>ç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> startTag, endTag</span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="comment">// ! æ€§èƒ½è¿½è¸ªç›¸å…³</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">  startTag = <span class="string">`vue-perf-start:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">  endTag = <span class="string">`vue-perf-end:<span class="subst">$&#123;vm._uid&#125;</span>`</span></span><br><span class="line">  mark(startTag) <span class="comment">// ! æ€§èƒ½è¿½è¸ªå‰æ ‡è®°</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* istanbul ignore if */</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; config.performance &amp;&amp; mark) &#123;</span><br><span class="line">  vm._name = formatComponentName(vm, <span class="literal">false</span>)</span><br><span class="line">  mark(endTag) <span class="comment">// ! æ€§èƒ½è¿½è¸ªåæ ‡è®°</span></span><br><span class="line">  measure(<span class="string">`vue <span class="subst">$&#123;vm._name&#125;</span> init`</span>, startTag, endTag)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç çš„çœç•¥äº†ä¸­é—´çš„ä¸»è¦é€»è¾‘ä»£ç ï¼Œåªä¿ç•™äº†ä¸¤å¤„ä»£ç ã€‚è¿™ä¸¤å¤„ä»£ç æ˜¯éç”Ÿäº§ç¯å¢ƒæ—¶ä½¿ç”¨çš„ï¼Œç”¨æ¥æµ‹è¯•ä¸­é—´ä»£ç çš„æ€§èƒ½ã€‚</p><p>æ¥ä¸‹æ¥æŸ¥çœ‹çœç•¥çš„ä¸­é—´éƒ¨åˆ†çš„ä»£ç ï¼Œè¿™æ‰æ˜¯<code>_init</code>ä¸»è¦çš„é€»è¾‘ä»£ç ã€‚</p><p>å…ˆçœ‹ä»£ç çš„å‰é¢éƒ¨åˆ†</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a flag to avoid this being observed</span></span><br><span class="line">vm._isVue = <span class="literal">true</span></span><br><span class="line"><span class="comment">// merge options</span></span><br><span class="line"><span class="keyword">if</span> (options &amp;&amp; options._isComponent) &#123;</span><br><span class="line">  <span class="comment">// optimize internal component instantiation</span></span><br><span class="line">  <span class="comment">// since dynamic options merging is pretty slow, and none of the</span></span><br><span class="line">  <span class="comment">// internal component options needs special treatment.</span></span><br><span class="line">  initInternalComponent(vm, options)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ! åˆå¹¶é…ç½®</span></span><br><span class="line">  vm.$options = mergeOptions(</span><br><span class="line">    resolveConstructorOptions(vm.constructor), <span class="comment">// ! Vue åˆå§‹åŒ–æ—¶çš„é»˜è®¤é…ç½®,æ¯”å¦‚é»˜è®¤çš„æŒ‡ä»¤å’Œç»„ä»¶ç­‰ç­‰</span></span><br><span class="line">    options || &#123;&#125;, <span class="comment">// ! ç”¨æˆ·ä¼ å…¥çš„é…ç½®</span></span><br><span class="line">    vm <span class="comment">// !  Vue å®ä¾‹å¯¹è±¡æœ¬èº«</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå®šä¹‰äº†<code>_isVue</code>å±æ€§ï¼Œè¿™ä¸ªå±æ€§æ˜¯ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œç”¨æ¥æ ‡è¯†å½“å‰çš„å¯¹è±¡æ˜¯ Vue çš„å®ä¾‹å¯¹è±¡ã€‚ç„¶åé€šè¿‡é€‰é¡¹çš„<code>_isComponent</code>å±æ€§åˆ¤æ–­è¿™æ˜¯ä¸æ˜¯ä¸€ä¸ªç»„ä»¶ï¼Œå¦‚æœæ˜¯ç»„ä»¶å°±è°ƒç”¨<code>initInternalComponent</code>å‡½æ•°åˆå§‹åŒ–è¿™ä¸ªç»„ä»¶ã€‚</p><p>åœ¨åˆ›å»ºå®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œæ ¹æœ¬å°±æ²¡æœ‰<code>_isComponent</code>è¿™ä¸ªå±æ€§ï¼Œæ‰€ä»¥ç°åœ¨åº”è¯¥æ‰§è¡Œ<code>else</code>å—ä¸­çš„ä»£ç ï¼Œè°ƒç”¨<code>mergeOptions</code>å‡½æ•°<strong>åˆå¹¶é€‰é¡¹ï¼ˆé…ç½®ï¼‰</strong>ï¼ŒæŠŠ Vue çš„é»˜è®¤é€‰é¡¹å’Œç”¨æˆ·è¾“å…¥çš„é€‰é¡¹è¿›è¡Œåˆå¹¶ï¼Œè¿™é‡Œéœ€è¦æŠŠå®ä¾‹å¯¹è±¡ä¹Ÿä¼ å…¥è¿›å»ã€‚</p><p>å…³äº Vue çš„é»˜è®¤é€‰é¡¹ï¼Œè¿˜è®°å¾—åœ¨ core å¢åŠ é™æ€å±æ€§å’Œæ–¹æ³•æ—¶ï¼Œéå†<code>ASSET_TYPES</code>æ•°ç»„æ—¶åˆå§‹åŒ–äº†<code>Vue.options</code>ä¸­çš„å‡ ä¸ªç©ºå¯¹è±¡å—ï¼Ÿå®ƒä»¬åˆ†åˆ«æ˜¯<code>components</code>ã€<code>directives</code>ã€<code>filters</code>ï¼Œç„¶åæŠŠå†…ç½®ç»„ä»¶<code>&lt;keep-alive /&gt;</code>ç»„ä»¶æ”¾å…¥åˆ°<code>components</code>ä¸­ã€‚</p><p>åé¢åœ¨ Runtime å…¥å£æ–‡ä»¶å¯¹æ„é€ å‡½æ•°è¿›è¡ŒåŒ…è£…æ—¶ï¼Œä¹Ÿè®¾ç½®äº† Web å¹³å°çš„<code>config</code>å±æ€§ï¼Œè¿˜å¢åŠ ä¸¤ä¸ªæŒ‡ä»¤åˆ°<code>directives</code>, å¢åŠ äº†ä¸¤ä¸ªè¿‡æ¸¡åŠ¨ç”»ç»„ä»¶åˆ°<code>components</code>ä¸­ï¼Œå…¶å®è¿™äº›å°±æ˜¯ Vue çš„<strong>é»˜è®¤é€‰é¡¹</strong>ã€‚</p><p>è¿™é‡Œé€šè¿‡<code>resolveConstructorOptions</code>å‡½æ•°æ¥è·å–è¿™äº›é»˜è®¤é€‰é¡¹ã€‚</p><p>ç”¨æˆ·é€‰é¡¹å°±æ˜¯æˆ‘ä»¬åˆ›å»º Vue å®ä¾‹æ—¶è¾“å…¥çš„é€‰é¡¹ï¼Œæ¯”å¦‚åœ¨é¡¹ç›®å…¥å£æ–‡ä»¶æ—¶ä½¿ç”¨<code>new</code>åˆ›å»ºæ ¹ç»„ä»¶æ—¶ä¼ å…¥çš„å¯¹è±¡å°±æ˜¯æ ¹å®ä¾‹çš„é€‰é¡¹é…ç½®ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œæˆ‘ä»¬åœ¨ Vue ç»„ä»¶ä¸­çš„<code>script</code>æ ‡ç­¾å¯¼å‡ºçš„å¯¹è±¡ä¹Ÿæ˜¯å®ä¾‹ç»„ä»¶çš„é€‰é¡¹é…ç½®ã€‚</p><p>ç°åœ¨ Vue2 çš„ API å…¶å®å°±æ˜¯é€‰é¡¹ï¼ˆoptionsï¼‰ APIï¼Œæ‰€ä»¥åˆå¹¶é€‰é¡¹æ˜¯ Vue æºç ä¸­éå¸¸é‡è¦çš„å†…å®¹ï¼Œåé¢ä¼šå•ç‹¬åˆ†æã€‚</p><p>ç»§ç»­æŸ¥çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* istanbul ignore else */</span></span><br><span class="line"><span class="comment">// ! åˆå§‹åŒ–ä»£ç†</span></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">  initProxy(vm)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  vm._renderProxy = vm</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨éç”Ÿäº§ç¯å¢ƒä¸­ä¼šè°ƒç”¨<code>initProxy</code>æ–¹æ³•å¹¶ä¼ å…¥ Vue çš„å®ä¾‹å¯¹è±¡ï¼Œè€Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯ç›´æ¥ç»™å®ä¾‹èµ‹å€¼å±æ€§<code>_renderProxy</code>ä¸º <code>vm</code>ã€‚ç°åœ¨è™½ç„¶ä¸çŸ¥é“<code>initProxy</code>æ–¹æ³•çš„å†…å®¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥åˆ¤æ–­å®ƒçš„åŠŸèƒ½åº”è¯¥ä¹Ÿæ˜¯ä¸ºå®ä¾‹å±æ€§<code>_renderProxy</code>èµ‹å€¼ï¼Œå› ä¸ºç”Ÿäº§ç¯å¢ƒå’Œå¼€å‘ç¯å¢ƒçš„ä»£ç å®ç°çš„ç»“æœåº”è¯¥æ˜¯ä¸€è‡´çš„ã€‚</p><p>ç»§ç»­æŸ¥çœ‹åé¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// expose real self</span></span><br><span class="line">vm._self = vm</span><br><span class="line">initLifecycle(vm) <span class="comment">// ! åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸç›¸å…³é…ç½® å­˜å‚¨æœ¬èº«å®ä¾‹åˆ°çˆ¶èŠ‚ç‚¹ æ–°å¢å±æ€§ $parent $root $children $refs ç­‰</span></span><br><span class="line">initEvents(vm) <span class="comment">// ! åˆå§‹åŒ–äº‹ä»¶ç›¸å…³é…ç½® æ›´æ–° listeners</span></span><br><span class="line">initRender(vm) <span class="comment">// ! åˆå§‹åŒ–æ¸²æŸ“, åˆ›å»ºVNode å¦æ–°å¢å±æ€§ $attrs å’Œ $listeners</span></span><br><span class="line">callHook(vm, <span class="string">'beforeCreate'</span>) <span class="comment">// ! è°ƒç”¨ beforeCreate é’©å­å‡½æ•°</span></span><br><span class="line">initInjections(vm) <span class="comment">// ! åˆå§‹åŒ– Injections resolve injections before data/props</span></span><br><span class="line">initState(vm) <span class="comment">// ! åˆå§‹åŒ–çŠ¶æ€ æŒ‰é¡ºåº props =&gt; methods =&gt; data =&gt; computed  =&gt; watch</span></span><br><span class="line">initProvide(vm) <span class="comment">// ! åˆå§‹åŒ– Provide resolve provide after data/props</span></span><br><span class="line">callHook(vm, <span class="string">'created'</span>) <span class="comment">// ! è°ƒç”¨ created é’©å­å‡½æ•°</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢å‡½æ•°ä¸­çš„å‡½æ•°åå¾ˆå¤šæ˜¯ä»¥<code>init</code>å¼€å¤´çš„ï¼Œå› ä¸ºè¿™äº›å‡½æ•°æ‰æ˜¯çœŸæ­£åˆå§‹åŒ–å®ä¾‹çš„å‡½æ•°ã€‚</p><p>å¤§æ¦‚æŸ¥çœ‹äº†ä¸€ä¸‹è¿™äº›å‡½æ•°ï¼Œå‘ç°å®ƒä»¬ä¹Ÿæ˜¯ä¸ºå®ä¾‹å¯¹è±¡<code>vm</code>æ·»åŠ æˆ–è€…æ›´æ–°å„ç§å±æ€§æˆ–è€…æ–¹æ³•çš„ï¼Œä½†æ˜¯å’Œå‰é¢ä¸ºæ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡æ·»åŠ å±æ€§å’Œæ–¹æ³•æ—¶ä¸åŒã€‚</p><p>è¿™äº›å‡½æ•°éƒ½æœ‰ä¸€ä¸ª<strong>å…±åŒç‚¹</strong>ï¼šé‚£å°±æ˜¯éœ€è¦ä¼ å…¥å®ä¾‹å¯¹è±¡<code>vm</code>ï¼Œå¹¶ä¸”ä¼šç”¨åˆ°<code>vm.$options</code>è¿™ä¸ªå±æ€§ã€‚è¿™ä¸ªå±æ€§æ˜¯åˆå¹¶åçš„é€‰é¡¹ï¼Œå€ŸåŠ©è¿™ä¸ªå±æ€§ä¸ºå®ä¾‹å¯¹è±¡<code>vm</code>å†æ¬¡æ·»åŠ æˆ–è€…æ›´æ–°å±æ€§æˆ–è€…æ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨<code>options</code>è®¾ç½®äº†<code>data: { name: &#39;Hale&#39;}</code>ï¼Œé‚£ä¹ˆåœ¨åˆå§‹åŒ–åä¼šæŠŠè¿™ä¸ªå±æ€§æ”¾å…¥åˆ°å®ä¾‹çš„<code>_data</code>å±æ€§ä¸­ï¼Œå¹¶ä¸”è¿˜ä¼šæŠŠå®ƒå˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>è¿™é‡Œè¿˜æœ‰ä¸¤ä¸ªæ˜¯è°ƒç”¨äº†<code>callHook</code>æ–¹æ³•ï¼Œè¿™æ˜¯å»æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œå®ƒä»¬æ˜¯<code>beforeCreate</code>å’Œ<code>created</code>è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ã€‚åœ¨ <code>options</code> é€‰é¡¹ä¸­ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†è¿™ä¸¤ä¸ªç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•°ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨è¿™é‡Œï¼ŒæŒ‰ç…§ä¸Šé¢å‡½æ•°çš„æ‰§è¡Œé¡ºåºæ¥æ‰§è¡Œã€‚</p><h3 id="å…³äºç»„ä»¶ä¸­è¯·æ±‚æ•°æ®çš„æ—¶æœº"><a href="#å…³äºç»„ä»¶ä¸­è¯·æ±‚æ•°æ®çš„æ—¶æœº" class="headerlink" title="å…³äºç»„ä»¶ä¸­è¯·æ±‚æ•°æ®çš„æ—¶æœº"></a>å…³äºç»„ä»¶ä¸­è¯·æ±‚æ•°æ®çš„æ—¶æœº</h3><p>è¿™é‡Œç®€å•åˆ†æä¸€ä¸‹è¯·æ±‚æ•°æ®çš„æ—¶æœºï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨å®ä¾‹ç»„ä»¶å‘åç«¯è¯·æ±‚æ¥å£æ•°æ®ï¼Œç„¶åä¿å­˜åˆ°<code>data</code>å±æ€§ä¸­ï¼Œè®©ä»–ä»¬å˜æˆå“åº”å¼æ•°æ®ã€‚</p><p>ä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å‘ç°<code>beforeCreate</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°é’©å­æ‰§è¡Œçš„æ—¶æœºï¼Œæ˜¯åœ¨<code>initState</code>ä¹‹å‰æ‰§è¡Œï¼Œè€Œåœ¨è¿™ä¸ªæ—¶å€™ Vue å®ä¾‹ç»„ä»¶ä¸­è¿˜æ²¡æœ‰åˆå§‹åŒ–<code>state</code>ï¼Œæ‰€ä»¥ä¸é€‚åˆåœ¨è¿™ä¸ªé’©å­å‡½æ•°é‡Œé¢å»è¯·æ±‚æ•°æ®å¹¶èµ‹å€¼ç»™<code>data</code>å±æ€§ã€‚</p><p>è€Œ<code>created</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°é’©å­æ˜¯åœ¨æœ€åé¢çš„æ—¶å€™æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯åœ¨å®ä¾‹åˆå§‹åŒ–å®Œæˆä¹‹åæ‰§è¡Œã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å»è¯·æ±‚æ•°æ®çš„ï¼Œå› ä¸ºè¿™æ˜¯<code>state</code>åº”è¯¥åˆå§‹åŒ–å®Œæˆäº†ï¼Œåœ¨è¿™ä¸ªé’©å­å‡½æ•°é‡Œé¢è¯·æ±‚åçš„æ•°æ®èµ‹å€¼ç»™<code>data</code>åä¹Ÿä¼šå˜æˆå“åº”å¼çš„æ•°æ®ã€‚</p><p>å¦å¤–ä¹Ÿè¿˜å¯ä»¥åœ¨<code>mounted</code>ç”Ÿå‘½å‘¨æœŸå‡½æ•°é’©å­ä¸­è¯·æ±‚æ•°æ®ï¼Œè¿™ä¸ªé’©å­åœ¨æŒ‚è½½ç»„ä»¶åæ‰§è¡Œï¼Œä½†æ˜¯å®ƒæ²¡æœ‰åœ¨<code>created</code>é’©å­ä¸­è¯·æ±‚çš„æ—¶æœºé‚£ä¹ˆå¿«ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Vue çš„åŸºæœ¬çš„ç»“æ„æˆ‘ä»¬å·²ç»å¼„æ¸…æ¥šäº†ï¼Œä¸‹é¢æ­£å¼å­¦ä¹  Vue çš„å®ä¾‹å¯¹è±¡åˆå§‹åŒ–è¿‡ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨æˆ‘ä»¬å›åˆ°å‡ºç”Ÿåœ°æ–‡ä»¶&lt;code&gt;core/instance/index.js&lt;/code&gt;ï¼ŒæŸ¥çœ‹ä¸‹é¢çš„ä»£ç &lt;/p&gt;
&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;import&lt;/span&gt; &amp;#123; initMixin &amp;#125; &lt;span class=&quot;keyword&quot;&gt;from&lt;/span&gt; &lt;span class=&quot;string&quot;&gt;&#39;./init&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Vue&lt;/span&gt;(&lt;span class=&quot;params&quot;&gt;options&lt;/span&gt;) &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;if&lt;/span&gt; (process.env.NODE_ENV !== &lt;span class=&quot;string&quot;&gt;&#39;production&#39;&lt;/span&gt; &amp;amp;&amp;amp; !(&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;instanceof&lt;/span&gt; Vue)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    warn(&lt;span class=&quot;string&quot;&gt;&#39;Vue is a constructor and should be called with the `new` keyword&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;._init(options)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;initMixin(Vue)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// ...&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;åœ¨ä½¿ç”¨&lt;code&gt;new&lt;/code&gt;çš„åˆ›å»ºå®ä¾‹å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œæ„é€ å‡½æ•°ä¸­çš„&lt;code&gt;this._init()&lt;/code&gt;æ–¹æ³•ï¼Œå¹¶ä¸”æŠŠé€‰é¡¹å‚æ•°&lt;code&gt;options&lt;/code&gt;ä¼ å…¥ï¼Œè¿™å°±æ˜¯ Vue çš„åˆå§‹åŒ–æ–¹æ³•ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>Vue2æºç å­¦ä¹ ç¬”è®°ä¹‹å¹³å°åŒ–åŒ…è£…</title>
    <link href="https://haledeng.com/blog/20190826-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%B9%B3%E5%8F%B0%E5%8C%96%E5%8C%85%E8%A3%85/"/>
    <id>https://haledeng.com/blog/20190826-Vue2%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E5%B9%B3%E5%8F%B0%E5%8C%96%E5%8C%85%E8%A3%85/</id>
    <published>2019-08-26T12:00:00.000Z</published>
    <updated>2020-05-07T08:56:00.982Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ core æ–‡ä»¶å¤¹ä¸‹é¢çš„ä»£ç æ˜¯ Vue çš„æ ¸å¿ƒä»£ç ï¼Œå®ƒå¹¶ä¸æ¶‰åŠä»»ä½•ä¸å¹³å°ç›¸å…³çš„å†…å®¹ã€‚</p><p>Vue çš„å¹³å°ç›®å‰ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œ åˆ†åˆ«æ˜¯ Web å¹³å°å’Œ Weex å¹³å°ã€‚ Web å¹³å°æ˜¯å’Œæµè§ˆå™¨ç›¸å…³ï¼Œå®ƒé‡Œé¢çš„ä»£ç è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚è€Œ Weex å¹³å°çš„ä»£ç å´æ˜¯å’Œç§»åŠ¨ç«¯ç›¸å…³çš„ï¼Œè¿™é‡Œä¸ä½œä»‹ç»ã€‚</p><p>ä¸‹é¢ä¸»è¦è¿˜æ˜¯å­¦ä¹  Web å¹³å°ç›¸å…³çš„ä»£ç ã€‚å¹³å°åŒ–åŒ…è£…ä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯ Runtime ï¼ˆè¿è¡Œæ—¶ï¼‰ç‰ˆæœ¬å’Œ Runtime + Compiler ï¼ˆå®Œæ•´ï¼‰ç‰ˆæœ¬ã€‚å…¶ä¸­ï¼Œè¿è¡Œæ—¶ç‰ˆæœ¬æ˜¯å®Œæ•´ç‰ˆæœ¬çš„ç»„æˆéƒ¨åˆ†ï¼Œå®Œæ•´ç‰ˆæœ¬è¿˜åŒ…å«äº†ç¼–è¯‘å™¨ã€‚</p><a id="more"></a><h2 id="è¿è¡Œæ—¶ç‰ˆæœ¬"><a href="#è¿è¡Œæ—¶ç‰ˆæœ¬" class="headerlink" title="è¿è¡Œæ—¶ç‰ˆæœ¬"></a>è¿è¡Œæ—¶ç‰ˆæœ¬</h2><p>è¿è¡Œæ—¶çš„ç‰ˆæœ¬æ¯”è¾ƒç®€å•ï¼Œå› ä¸ºæ²¡æœ‰æ¶‰åŠåˆ°ç¼–è¯‘å™¨ï¼Œå®ƒçš„ç¼–è¯‘å…¥å£æ˜¯<code>platforms/webpack/entry-runtime.js</code>ï¼Œä¸‹é¢æŸ¥çœ‹å®ƒçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./runtime/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–‡ä»¶åªæ˜¯å•ç‹¬çš„å¼•ç”¨äº†<code>platforms/web/runtime/index.js</code>æ–‡ä»¶ä¸­çš„<code>Vue</code>ï¼Œç„¶åå†æŠŠå®ƒå¯¼å‡ºã€‚</p><p>ç°åœ¨æ‰“å¼€è¿™ä¸ªå¼•ç”¨çš„æ–‡ä»¶ï¼ŒæŸ¥çœ‹å®ƒçš„ä»£ç ã€‚å…ˆçœ‹å‰é¢çš„éƒ¨åˆ†ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* @flow */</span></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'core/index'</span></span><br><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'core/config'</span></span><br><span class="line"><span class="keyword">import</span> &#123; extend, noop &#125; <span class="keyword">from</span> <span class="string">'shared/util'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mountComponent &#125; <span class="keyword">from</span> <span class="string">'core/instance/lifecycle'</span></span><br><span class="line"><span class="keyword">import</span> &#123; devtools, inBrowser &#125; <span class="keyword">from</span> <span class="string">'core/util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  query,</span><br><span class="line">  mustUseProp,</span><br><span class="line">  isReservedTag,</span><br><span class="line">  isReservedAttr,</span><br><span class="line">  getTagNamespace,</span><br><span class="line">  isUnknownElement</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'web/util/index'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; patch &#125; <span class="keyword">from</span> <span class="string">'./patch'</span></span><br><span class="line"><span class="keyword">import</span> platformDirectives <span class="keyword">from</span> <span class="string">'./directives/index'</span></span><br><span class="line"><span class="keyword">import</span> platformComponents <span class="keyword">from</span> <span class="string">'./components/index'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// install platform specific utils</span></span><br><span class="line"><span class="comment">// ! è®¾ç½® web å¹³å°é…ç½®é€‰é¡¹</span></span><br><span class="line">Vue.config.mustUseProp = mustUseProp</span><br><span class="line">Vue.config.isReservedTag = isReservedTag</span><br><span class="line">Vue.config.isReservedAttr = isReservedAttr</span><br><span class="line">Vue.config.getTagNamespace = getTagNamespace</span><br><span class="line">Vue.config.isUnknownElement = isUnknownElement</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure><p>å…ˆä¸ç®¡å¯¼å…¥çš„æ¨¡å—éƒ¨åˆ†ã€‚çœ‹ä¸Šé¢ä»£ç çš„æœ€åå‡ è¡Œï¼Œè¿™é‡Œå†æ¬¡è®¾ç½®äº† Vue çš„æ„é€ å‡½æ•°çš„<code>config</code>å±æ€§ã€‚</p><p>è¿˜è®°å¾—æˆ‘ä»¬åœ¨æ ¸å¿ƒä»£ç  core ä¸­ä¹Ÿè®¾ç½®<code>config</code>å±æ€§ï¼Œä¸è¿‡é‚£é‡Œçš„è®¾ç½®çš„éƒ½æ˜¯äº›åˆå§‹å€¼æˆ–è€…ç©ºå€¼ã€‚</p><p>ç°åœ¨é…ç½®çš„å€¼ï¼Œéƒ½æ˜¯å’Œ Web å¹³å°ç›¸å…³çš„ã€‚ç»™æ„é€ å‡½æ•°<code>Vue</code>çš„<code>config</code>è®¾ç½®äº†äº”ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>mustUseProp</code>ã€<code>isReservedTag</code>ã€<code>isReservedAttr</code>ã€<code>getTagNamespace</code>å’Œ<code>isUnknownElement</code>ï¼Œå…ˆä¸å»ç®¡è¿™äº›å±æ€§ã€‚</p><p>ç»§ç»­æŸ¥çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ! å®‰è£… web å¹³å°è¿è¡Œæ—¶çš„æŒ‡ä»¤ v-model v-show å’Œç»„ä»¶ &lt;transition/&gt; &lt;transition-group/&gt;</span></span><br><span class="line">extend(Vue.options.directives, platformDirectives)</span><br><span class="line">extend(Vue.options.components, platformComponents)s</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>extend</code>æ–¹æ³•ï¼Œç»™<code>Vue</code>é€‰é¡¹ä¸­çš„<code>directives</code> å’Œ<code>components</code>æ‰©å±•å†…å®¹ã€‚è¿™äº›æ˜¯å’Œå¹³å°ç›¸å…³çš„ç»„ä»¶å’ŒæŒ‡ä»¤ã€‚</p><p>é‚£ä¹ˆåˆ°åº•æ‰©å±•äº†ä»€ä¹ˆå†…å®¹å‘¢ï¼ŸæŸ¥çœ‹<code>runtime/directives/index.js</code>æ–‡ä»¶çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> model <span class="keyword">from</span> <span class="string">'./model'</span></span><br><span class="line"><span class="keyword">import</span> show <span class="keyword">from</span> <span class="string">'./show'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  model,</span><br><span class="line">  show</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™æŒ‡ä»¤é›†<code>directives</code>æ‰©å±•äº†ä¸¤ä¸ªæ–°æŒ‡ä»¤<code>model</code>å’Œ<code>show</code> ï¼Œå³<code>v-model</code>å’Œ <code>v-show</code>ï¼Œè¿™ä¸¤ä¸ªæŒ‡ä»¤åº”è¯¥éƒ½éå¸¸ç†Ÿæ‚‰å§ï¼Œè¿™é‡Œå°±ä¸å¤šä»‹ç»äº†ã€‚</p><p>ç„¶åå†æŸ¥çœ‹<code>runtime/components/index.js</code>æ–‡ä»¶çš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Transition <span class="keyword">from</span> <span class="string">'./transition'</span></span><br><span class="line"><span class="keyword">import</span> TransitionGroup <span class="keyword">from</span> <span class="string">'./transition-group'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  Transition,</span><br><span class="line">  TransitionGroup</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œç»™ç»„ä»¶æ•°ç»„<code>components</code>æ‰©å±•äº†ä¸¤ä¸ªæ–°ç»„ä»¶<code>Transition</code>å’Œ<code>TransitionGroup</code>ï¼Œè¿™ä¸¤ä¸ªç»„ä»¶æ˜¯è®¾ç½®è¿‡æ¸¡åŠ¨ç”»çš„ç»„ä»¶ã€‚</p><p>æ¥ä¸‹æ¥ç»§ç»­çœ‹<code>runtime/index.js</code>ä¸Šçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// install platform patch functionll</span></span><br><span class="line"><span class="comment">// ! å®‰è£… web å¹³å°çš„ __patch__ æ–¹æ³•</span></span><br><span class="line">Vue.prototype.__patch__ = inBrowser ? patch : noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// public mount method</span></span><br><span class="line"><span class="comment">// ! å®‰è£… web å¹³å°çš„æŒ‚è½½æ–¹æ³• $mount ï¼ˆè¿™é‡Œæ˜¯ runtime ç‰ˆæœ¬ï¼‰</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  el = el &amp;&amp; inBrowser ? query(el) : <span class="literal">undefined</span></span><br><span class="line">  <span class="keyword">return</span> mountComponent(<span class="keyword">this</span>, el, hydrating)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»™ Vue æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡ä¸Šæ·»åŠ äº†ä¸¤ä¸ªæ–¹æ³•<code>__patch__</code>å’Œ<code>$mount</code>ã€‚</p><p><code>__patch__</code>æ˜¯æŠŠè™šæ‹Ÿ DOM è½¬æ¢æˆçœŸå® DOM çš„è¡¥ä¸æ–¹æ³•ã€‚è¿™é‡Œè¿˜åˆ¤æ–­äº†æ˜¯å¦æ˜¯æµè§ˆå™¨ç¯å¢ƒï¼Œå¦‚æœä¸æ˜¯åˆ™ä¸º<code>noop</code>ï¼Œ<code>noop</code>æ˜¯ä¸€ä¸ªç©ºå‡½æ•°ã€‚</p><p><code>$mount</code>æ˜¯ç»„ä»¶çš„æŒ‚è½½æ–¹æ³•ï¼Œä¸è¿‡å› ä¸ºè¿™é‡Œçš„æ˜¯ Runtime ç‰ˆæœ¬ï¼Œåœ¨å®Œæ•´ç‰ˆæœ¬ä¸­è¿˜ä¼šå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œæ‰©å±•ï¼Œå¢åŠ ç¼–è¯‘å™¨ç›¸å…³çš„ä»£ç ã€‚</p><p>å†çœ‹æœ€åçš„ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (inBrowser) &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (config.devtools) &#123;<span class="comment">/* ... */</span>&#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Vue</span><br></pre></td></tr></table></figure><p>åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­å®‰è£…<code>vue-devtool</code>çš„å…¨å±€é’©å­ï¼Œç”¨äºåœ¨æµè§ˆå™¨ä¸­è¿›è¡Œå¼€å‘è°ƒè¯•ã€‚</p><p>æœ€åæ˜¯å¯¼å‡º Vue çš„æ„é€ å‡½æ•°<code>Vue</code>ï¼Œè¿™æ ·è¿è¡Œæ—¶ç‰ˆæœ¬çš„ Vue çš„å¹³å°åŒ–åŒ…è£…ï¼ˆæ‰©å±•ï¼‰å°±å®Œæˆäº†ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p><strong>Runtime</strong> ç‰ˆæœ¬çš„å…¥å£æ–‡ä»¶ä¸»è¦ç»™ Vue çš„æ„é€ å‡½æ•°æ·»åŠ äº† Web å¹³å°ä¸“ç”¨çš„å±æ€§å’Œæ–¹æ³•ã€‚</p><ul><li><p>åœ¨<code>Vue.config</code>é…ç½®äº†äº”ä¸ª Web å¹³å°ä¸“ç”¨å±æ€§ï¼Œåˆ†åˆ«æ˜¯ï¼š<code>mustUseProp</code>ã€<code>isReservedTag</code>ã€<code>isReservedAttr</code>ã€<code>getTagNamespace</code>å’Œ<code>isUnknownElement</code>ã€‚</p></li><li><p>åœ¨<code>Vue.options</code>çš„<code>fileters</code> å±æ€§æ·»åŠ ä¸¤ä¸ªæŒ‡ä»¤<code>v-model</code>å’Œ<code>v-show</code>ã€‚</p></li><li><p>åœ¨<code>Vue.options</code>çš„<code>components</code>å±æ€§æ·»åŠ ä¸¤ä¸ªè¿‡æ¸¡åŠ¨ç”»ç»„ä»¶<code>Transition</code>å’Œ<code>TransitionGroup</code>ã€‚</p></li><li><p>åœ¨<code>Vue</code>çš„åŸå‹å¯¹è±¡ä¸Šå¢åŠ ä¸¤ä¸ªæ–¹æ³•<code>__patch__</code> å’Œ <code>$mount</code>ã€‚</p></li><li><p>å®‰è£…<code>vue-devtool</code>çš„å…¨å±€é’©å­</p></li></ul><h2 id="å¸¦ç¼–è¯‘ç‰ˆæœ¬"><a href="#å¸¦ç¼–è¯‘ç‰ˆæœ¬" class="headerlink" title="å¸¦ç¼–è¯‘ç‰ˆæœ¬"></a>å¸¦ç¼–è¯‘ç‰ˆæœ¬</h2><p>ä¸‹é¢å†æŸ¥çœ‹å®Œæ•´ç‰ˆæœ¬ç¼–è¯‘å™¨çš„å…¥å£æ–‡ä»¶<code>platforms/webpack/entry-runtime-with-compiler.js</code>ï¼Œå¯¹æ¯”è¿è¡Œæ—¶ç‰ˆæœ¬çš„å…¥å£æ–‡ä»¶ï¼Œä¸»è¦æ˜¯å¢åŠ äº†ç¼–è¯‘å™¨ç›¸å…³çš„ä»£ç ã€‚</p><p>æ‰“å¼€è¿™ä¸ªæ–‡ä»¶ï¼Œå…ˆçœ‹å‰é¢çš„éƒ¨åˆ†ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config <span class="keyword">from</span> <span class="string">'core/config'</span></span><br><span class="line"><span class="keyword">import</span> &#123; warn, cached &#125; <span class="keyword">from</span> <span class="string">'core/util/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; mark, measure &#125; <span class="keyword">from</span> <span class="string">'core/util/perf'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'./runtime/index'</span> <span class="comment">// ! å¯¼å…¥ runtime ç‰ˆæœ¬çš„ Vue</span></span><br><span class="line"><span class="keyword">import</span> &#123; query &#125; <span class="keyword">from</span> <span class="string">'./util/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123; compileToFunctions &#125; <span class="keyword">from</span> <span class="string">'./compiler/index'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  shouldDecodeNewlines,</span><br><span class="line">  shouldDecodeNewlinesForHref</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'./util/compat'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! é€šè¿‡ id è·å–å…ƒç´ çš„ innerHTML</span></span><br><span class="line"><span class="keyword">const</span> idToTemplate = cached(<span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> el = query(id)</span><br><span class="line">  <span class="keyword">return</span> el &amp;&amp; el.innerHTML</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè¿˜æ˜¯å¼•å…¥æ¨¡å—æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…æ‹¬å¼•å…¥ Runtime ç‰ˆæœ¬çš„ Vue çš„æ„é€ å‡½æ•°<code>Vue</code>ã€‚</p><p>ç„¶åå®šä¹‰ä¸€ä¸ªé€šè¿‡ id è·å–å…ƒç´ çš„ <code>innerHTML</code> çš„æ–¹æ³•<code>idToTemplate</code>ï¼Œåœ¨ä¸‹é¢é‡å†™<code>$mount</code>æ–¹æ³•ä¸­ä¼šç”¨åˆ°ã€‚</p><p>ç»§ç»­å¾€ä¸‹çœ‹ä»£ç </p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mount = Vue.prototype.$mount <span class="comment">// ! ç¼“å­˜ runtime ç‰ˆæœ¬çš„ $mount æ–¹æ³•</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ! é‡å†™ $mount æ–¹æ³• with compiler</span></span><br><span class="line">Vue.prototype.$mount = <span class="function"><span class="keyword">function</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  el?: string | Element,</span></span></span><br><span class="line"><span class="function"><span class="params">  hydrating?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>): <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆç¼“å­˜äº†è¿è¡Œæ—¶ç‰ˆæœ¬çš„<code>$mount</code>æ–¹æ³•ï¼Œç„¶ååˆé‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œä¸»è¦æ˜¯åŠ å…¥äº†ç¼–è¯‘å™¨ç›¸å…³çš„ä»£ç ã€‚</p><p>å…ˆä¸ç®¡é‡å†™çš„<code>$mount</code>æ–¹æ³•ï¼Œç»§ç»­æŸ¥çœ‹æœ€åçš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * Get outerHTML of elements, taking care</span><br><span class="line"> * of SVG elements in IE as well.</span><br><span class="line"> *&#x2F;</span><br><span class="line">function getOuterHTML(el: Element): string &#123;</span><br><span class="line">  if (el.outerHTML) &#123;</span><br><span class="line">    return el.outerHTML</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    const container &#x3D; document.createElement(&#39;div&#39;)</span><br><span class="line">    container.appendChild(el.cloneNode(true))</span><br><span class="line">    return container.innerHTML</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Vue.compile &#x3D; compileToFunctions &#x2F;&#x2F; ! æ–°å¢æ–¹æ³• compile</span><br><span class="line"></span><br><span class="line">export default Vue</span><br></pre></td></tr></table></figure><p>å®šä¹‰äº†ä¸€ä¸ª<code>getOuterHTML</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ä¸Šé¢é‡å†™<code>$mount</code>æ–¹æ³•ä¸­ä¼šç”¨åˆ°ã€‚</p><p>ç„¶åç»™<code>Vue</code>æ–°å¢äº†ä¸€ä¸ªé™æ€æ–¹æ³•<code>compile</code>ï¼Œèµ‹å€¼ä¸º<code>compileToFunctions</code>æ–¹æ³•ï¼Œä»æ–¹æ³•çš„åå­—å¯ä»¥çœ‹å‡ºè¿™åº”è¯¥æ˜¯ä¸€ä¸ªç¼–è¯‘çš„æ–¹æ³•ï¼ŒæŠŠæ¨¡æ¿å­—ç¬¦ä¸²ç¼–è¯‘æˆæ¸²æŸ“å‡½æ•°ã€‚</p><p>ä½†æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•ä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿæ˜¯ä»<code>platforms/web/compiler/index.js</code>æ–‡ä»¶ä¸­å¼•å…¥è¿›æ¥çš„ï¼Œæš‚æ—¶å…ˆä¸ç®¡å®ƒã€‚</p><p>æœ€åè¿˜æ˜¯å¯¼å‡º Vue çš„æ„é€ å‡½æ•°<code>Vue</code>ï¼Œè¿™æ ·åŒ…å«ç¼–è¯‘å™¨çš„ Vue çš„å¹³å°åŒ–åŒ…è£…ï¼ˆæ‰©å±•ï¼‰ä¹Ÿå®Œæˆäº†ã€‚</p><p><strong>æ€»ç»“</strong>ï¼Œè¿™ä¸ªå¸¦ç¼–è¯‘å™¨çš„å…¥å£æ–‡ä»¶ä»£ç ç»“æ„å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯é‡å†™è¿è¡Œæ—¶ç‰ˆæœ¬ä¸­ Vue æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡çš„<code>$mount</code>æ–¹æ³•ï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­æ·»åŠ ç¼–è¯‘ç›¸å…³çš„ä»£ç ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åˆ°äº†è¿™ä¸€æ­¥ï¼ŒVue çš„æ„é€ å‡½æ•°çš„æ‰©å±•å°±å·²ç»åˆæ­¥å®Œæˆã€‚</p><p>ç°åœ¨å†æ¬¡å›é¡¾ä¸‹ Vue çš„æ„é€ å‡½æ•°<code>Vue</code>æœ€åˆçš„æ ·å­</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Vue)) &#123;</span><br><span class="line">    warn(<span class="string">'Vue is a constructor and should be called with the `new` keyword'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ å‡½æ•°éå¸¸ç®€å•ï¼Œå¦‚æœæŠŠè­¦å‘Šçš„ä»£ç å†å»æ‰ï¼Œä»£ç ä¼šæ›´å°‘ï¼Œå†…å®¹å°±åªæœ‰ä¸€è¡Œ</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Vue</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>._init(options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œå°±æ˜¯è¿™ä¹ˆä¸€ä¸ªç®€å•çš„æ„é€ å‡½æ•°ï¼Œåœ¨ç»è¿‡ä¸€ç³»åˆ—çš„æ‰©å±•å’ŒåŒ…è£…åï¼Œå°±æˆä¸ºäº†ä¸€ä¸ªéå¸¸å¤æ‚çš„å‰ç«¯æ¡†æ¶ã€‚</p><p>å®åœ¨æ˜¯æœ‰ç‚¹ä¸å¯æ€è®®ï¼Œè¿™ä¹Ÿè¯´æ˜ Vue çš„ç»“æ„è®¾è®¡éå¸¸æ¸…æ™°æ˜äº†ï¼</p><p>å›é¡¾ä¸‹å®ƒæ˜¯æ€ä¹ˆæ‰©å±•çš„</p><ul><li><code>core/instance/index.js</code>ï¼šæ‰©å±•æ„é€ å‡½æ•°çš„åŸå‹å¯¹è±¡çš„å±æ€§å’Œæ–¹æ³•</li><li><code>core/index.js</code>ï¼šæ‰©å±•æ„é€ å‡½æ•°é™æ€çš„å±æ€§å’Œæ–¹æ³•</li><li><code>platforms/webpack/entry-runtime.js</code>ï¼šæ‰©å±• Web å¹³å°ä¸“ç”¨çš„å±æ€§å’Œæ–¹æ³•</li><li><code>platforms/webpack/entry-runtime-with-compiler.js</code>ï¼šé‡å†™è¿è¡Œæ—¶çš„<code>$mount</code>æ–¹æ³•ï¼Œæ·»åŠ ç¼–è¯‘ç›¸å…³çš„ä»£ç ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><p><a href="http://hcysun.me/vue-design/zh/" target="_blank" rel="noopener">Vue æŠ€æœ¯å†…å¹•</a></p></li><li><p><a href="https://ustbhuangyi.github.io/vue-analysis/" target="_blank" rel="noopener">Vue æŠ€æœ¯æ­ç§˜</a></p></li><li><p><a href="https://cn.vuejs.org/" target="_blank" rel="noopener">Vue æ–‡æ¡£</a></p></li><li><p><a href="https://github.com/haledc/vue/tree/learn-vue" target="_blank" rel="noopener">Vue æºç å­¦ä¹ åˆ†æ”¯</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ core æ–‡ä»¶å¤¹ä¸‹é¢çš„ä»£ç æ˜¯ Vue çš„æ ¸å¿ƒä»£ç ï¼Œå®ƒå¹¶ä¸æ¶‰åŠä»»ä½•ä¸å¹³å°ç›¸å…³çš„å†…å®¹ã€‚&lt;/p&gt;
&lt;p&gt;Vue çš„å¹³å°ç›®å‰ä¸»è¦æœ‰ä¸¤ä¸ªï¼Œ åˆ†åˆ«æ˜¯ Web å¹³å°å’Œ Weex å¹³å°ã€‚ Web å¹³å°æ˜¯å’Œæµè§ˆå™¨ç›¸å…³ï¼Œå®ƒé‡Œé¢çš„ä»£ç è¿è¡Œåœ¨æµè§ˆå™¨ä¸­ã€‚è€Œ Weex å¹³å°çš„ä»£ç å´æ˜¯å’Œç§»åŠ¨ç«¯ç›¸å…³çš„ï¼Œè¿™é‡Œä¸ä½œä»‹ç»ã€‚&lt;/p&gt;
&lt;p&gt;ä¸‹é¢ä¸»è¦è¿˜æ˜¯å­¦ä¹  Web å¹³å°ç›¸å…³çš„ä»£ç ã€‚å¹³å°åŒ–åŒ…è£…ä¹Ÿæœ‰ä¸¤ä¸ªç‰ˆæœ¬ï¼Œåˆ†åˆ«æ˜¯ Runtime ï¼ˆè¿è¡Œæ—¶ï¼‰ç‰ˆæœ¬å’Œ Runtime + Compiler ï¼ˆå®Œæ•´ï¼‰ç‰ˆæœ¬ã€‚å…¶ä¸­ï¼Œè¿è¡Œæ—¶ç‰ˆæœ¬æ˜¯å®Œæ•´ç‰ˆæœ¬çš„ç»„æˆéƒ¨åˆ†ï¼Œå®Œæ•´ç‰ˆæœ¬è¿˜åŒ…å«äº†ç¼–è¯‘å™¨ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="https://haledeng.com/categories/Vue/"/>
    
    
      <category term="Vue" scheme="https://haledeng.com/tags/Vue/"/>
    
      <category term="æºç å­¦ä¹ " scheme="https://haledeng.com/tags/%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
</feed>
